{"version":3,"sources":["../../src/loaders/excel.js"],"names":["unflattenObject","_","eachAsync_","require","module","exports","writeTemplate_","templateFile","columnsMeta","config","keys","Object","Excel","workbook","Workbook","sheet","addWorksheet","addRow","rowPlaceHolders","Array","length","templatedRows","rows","j","i","colKey","metadata","cell","getCell","type","dataValidation","allowBlank","formulae","values","join","alignment","horizontal","currencyFormat","numFmt","border","top","style","xlsx","writeFile","load_","db","mainEntity","dataFile","reverseMapping","payloadFunctor","readFile","data","eachSheet","worksheet","colKeys","eachRow","row","rowNumber","drop","map","key","record","fromPairs","zip","isEmpty","push","errors","rowsResult","Entity","model","processed","create_","$dryRun","error","message","result","meta"],"mappings":"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","sourcesContent":["const { unflattenObject, _, eachAsync_ } = require('@genx/july');\n\nmodule.exports = {\n    writeTemplate_: async (templateFile, columnsMeta, config) => {\n        const keys = Object.keys(columnsMeta);\n\n        const Excel = require('exceljs');\n        let workbook = new Excel.Workbook();\n\n        const sheet = workbook.addWorksheet('Template');\n\n        // add header\n        sheet.addRow(keys);\n        const rowPlaceHolders = new Array(keys.length);\n\n        const templatedRows = config.rows || 50;\n\n        for (let j = 0; j < templatedRows; j++) {\n            // add en empty rows\n            sheet.addRow(rowPlaceHolders);\n\n            for (let i = 1; i <= keys.length; i++) {\n                const colKey = keys[i - 1];\n                const metadata = columnsMeta[colKey];\n                const cell = sheet.getCell(j + 2, i);\n\n                if (metadata) {\n                    if (metadata.type === 'enum') {\n                        cell.dataValidation = {\n                            type: 'list',\n                            allowBlank: true,\n                            formulae: [`\"${metadata.values.join(',')}\"`],\n                        };\n                    } else if (metadata.type === 'currency') {\n                        cell.alignment = { horizontal: 'right' };\n                        if (config.currencyFormat) {\n                            cell.numFmt = config.currencyFormat;\n                        }\n                    }\n                }\n            }\n        }\n\n        sheet.addRow(rowPlaceHolders);\n\n        for (let i = 1; i <= keys.length; i++) {\n            const cell = sheet.getCell(templatedRows + 2, i);\n            cell.border = { top: { style: 'thin' } };\n        }\n\n        await workbook.xlsx.writeFile(templateFile);\n    },\n\n    load_: async (db, mainEntity, dataFile, reverseMapping, payloadFunctor) => {\n        const Excel = require('exceljs');\n        let workbook = new Excel.Workbook();\n        await workbook.xlsx.readFile(dataFile);\n\n        let data = [];\n\n        workbook.eachSheet((worksheet) => {\n            let colKeys;\n\n            worksheet.eachRow(function (row, rowNumber) {\n                if (!colKeys) {\n                    colKeys = _.drop(row.values).map(\n                        (key) => reverseMapping[key]\n                    );\n                } else {\n                    const record = _.fromPairs(\n                        _.zip(colKeys, _.drop(row.values))\n                    );\n\n                    if (!_.isEmpty(record)) {\n                        data.push({\n                            rowNumber,\n                            record: unflattenObject(record),\n                        });\n                    }\n                }\n            });\n        });\n\n        const errors = [];\n        const rowsResult = [];\n\n        const Entity = db.model(mainEntity);\n        const processed = [];\n        await eachAsync_(data, async ({ rowNumber, record }) => {\n            try {\n                record = await payloadFunctor(Entity, record);\n                processed.push({ rowNumber, record });\n                await Entity.create_(record, { $dryRun: true });\n            } catch (error) {\n                errors.push({\n                    rowNumber,\n                    error: error.message,\n                });\n            }\n        });\n\n        if (errors.length > 0) {\n            return { errors };\n        }\n\n        await eachAsync_(processed, async ({ rowNumber, record }) => {\n            try {\n                const result = await Entity.create_(record);\n                rowsResult.push({\n                    rowNumber,\n                    [Entity.meta.key]: result[Entity.meta.key],\n                });\n            } catch (error) {\n                errors.push({\n                    rowNumber,\n                    error: error.message,\n                });\n            }\n        });\n\n        return { result: rowsResult, errors };\n    },\n};\n"],"file":"excel.js"}