{"version":3,"file":"excel.js","names":["unflattenObject","_","eachAsync_","require","module","exports","writeTemplate_","templateFile","columnsMeta","config","keys","Object","Excel","workbook","Workbook","sheet","addWorksheet","addRow","rowPlaceHolders","Array","length","templatedRows","rows","j","i","colKey","metadata","cell","getCell","type","dataValidation","allowBlank","formulae","values","join","alignment","horizontal","format","numFmt","showErrorMessage","Date","border","top","style","xlsx","writeFile","load_","db","mainEntity","dataFile","reverseMapping","payloadFunctor","needConfirm","readFile","data","eachSheet","worksheet","colKeys","eachRow","row","rowNumber","drop","map","key","rowValues","isNonEmpty","find","val","toString","trim","record","fromPairs","zip","isEmpty","_record","push","primaryValue","errors","confirmations","rowsResult","Entity","model","processed","_confirm","forEach","c","create_","$dryRun","error","message","info","result","meta","keyField"],"sources":["../../src/loaders/excel.js"],"sourcesContent":["const { unflattenObject, _, eachAsync_ } = require('@genx/july');\n\nmodule.exports = {\n    writeTemplate_: async (templateFile, columnsMeta, config) => {\n        const keys = Object.keys(columnsMeta);\n\n        const Excel = require('exceljs');\n        let workbook = new Excel.Workbook();\n\n        const sheet = workbook.addWorksheet('Template');\n\n        // add header\n        sheet.addRow(keys);\n        const rowPlaceHolders = new Array(keys.length);\n\n        const templatedRows = config.rows || 50;\n\n        for (let j = 0; j < templatedRows; j++) {\n            // add en empty rows\n            sheet.addRow(rowPlaceHolders);\n\n            for (let i = 1; i <= keys.length; i++) {\n                const colKey = keys[i - 1];\n                const metadata = columnsMeta[colKey];\n                const cell = sheet.getCell(j + 2, i);\n\n                if (metadata) {\n                    if (metadata.type === 'enum') {\n                        cell.dataValidation = {\n                            type: 'list',\n                            allowBlank: true,\n                            formulae: [`\"${metadata.values.join(',')}\"`],\n                        };\n                    } else if (metadata.type === 'currency') {\n                        cell.alignment = { horizontal: 'right' };\n                        if (metadata.format && config[metadata.format]) {\n                            cell.numFmt = config[metadata.format];\n                        }\n                    } else if (metadata.type === 'percentage') {\n                        if (metadata.format && config[metadata.format]) {\n                            cell.numFmt = config[metadata.format];\n                        } else {\n                            cell.numFmt = '0.00%';\n                        }\n                    } else if (metadata.type === 'datetime') {\n                        cell.dataValidation = {\n                            type: 'date',\n                            showErrorMessage: true,\n                            formulae: [new Date()]\n                        };\n\n                        if (metadata.format && config[metadata.format]) {\n                            cell.numFmt = config[metadata.format];\n                        } else {\n                            cell.numFmt = 'yyyy/mm/dd';\n                        }                        \n                    } else if (metadata.type === 'text') {\n                        if (metadata.format && config[metadata.format]) {\n                            cell.numFmt = config[metadata.format];\n                        } else {\n                            cell.numFmt = '@';\n                        }\n                    }\n                }\n            }\n        }\n\n        sheet.addRow(rowPlaceHolders);\n\n        for (let i = 1; i <= keys.length; i++) {\n            const cell = sheet.getCell(templatedRows + 2, i);\n            cell.border = { top: { style: 'thin' } };\n        }\n\n        await workbook.xlsx.writeFile(templateFile);\n    },\n\n    load_: async (\n        db,\n        mainEntity,\n        dataFile,\n        reverseMapping,\n        payloadFunctor,\n        needConfirm\n    ) => {\n        const Excel = require('exceljs');\n        let workbook = new Excel.Workbook();\n        await workbook.xlsx.readFile(dataFile);\n\n        const data = [];\n\n        workbook.eachSheet((worksheet) => {\n            let colKeys;\n\n            worksheet.eachRow(function (row, rowNumber) {\n                if (!colKeys) {\n                    colKeys = _.drop(row.values).map(\n                        (key) => reverseMapping[key]\n                    );\n                } else {\n                    const rowValues = _.drop(row.values);\n                    const isNonEmpty = _.find(\n                        rowValues,\n                        (val) => val != null && val.toString().trim() !== ''\n                    );\n\n                    if (!isNonEmpty) {\n                        return;\n                    }\n\n                    const record = _.fromPairs(_.zip(colKeys, rowValues));\n\n                    if (!_.isEmpty(record)) {\n                        const _record = unflattenObject(record);\n\n                        data.push({\n                            rowNumber,\n                            record: _record,\n                            primaryValue: rowValues[0],\n                        });\n                    }\n                }\n            });\n        });\n\n        const errors = [];\n        const confirmations = [];\n        const rowsResult = [];\n\n        const Entity = db.model(mainEntity);\n        const processed = [];\n        await eachAsync_(data, async ({ rowNumber, record, primaryValue }) => {\n            try {\n                const _confirm = [];\n                record = await payloadFunctor(\n                    Entity,\n                    record,\n                    rowNumber,\n                    _confirm\n                );\n                //console.dir(record, { depth: 10 });\n\n                if (_confirm.length > 0) {\n                    _confirm.forEach((c) =>\n                        confirmations.push({ rowNumber, ...c })\n                    );\n                }\n\n                processed.push({ rowNumber, record, primaryValue });\n                await Entity.create_(record, { $dryRun: true });\n            } catch (error) {\n                errors.push({\n                    rowNumber,\n                    error: error.message,\n                    ...(error.info ? { info: error.info } : null),\n                });\n            }\n        });\n\n        if (errors.length > 0) {\n            return { errors };\n        }\n\n        if (needConfirm && confirmations.length > 0) {\n            return { confirmations };\n        }\n\n        await eachAsync_(\n            processed,\n            async ({ rowNumber, record, primaryValue }) => {\n                try {\n                    const result = await Entity.create_(record);\n                    rowsResult.push({\n                        rowNumber,\n                        [Entity.meta.keyField]: result[Entity.meta.keyField],\n                        primaryValue,\n                    });\n                } catch (error) {\n                    errors.push({\n                        rowNumber,\n                        error: error.message,\n                    });\n                }\n            }\n        );\n\n        return { result: rowsResult, errors };\n    },\n};\n"],"mappings":";;;AAAA,MAAM;EAAEA,eAAe;EAAEC,CAAC;EAAEC;AAAW,CAAC,GAAGC,OAAO,CAAC,YAAY,CAAC;AAEhEC,MAAM,CAACC,OAAO,GAAG;EACbC,cAAc,EAAE,MAAAA,CAAOC,YAAY,EAAEC,WAAW,EAAEC,MAAM,KAAK;IACzD,MAAMC,IAAI,GAAGC,MAAM,CAACD,IAAI,CAACF,WAAW,CAAC;IAErC,MAAMI,KAAK,GAAGT,OAAO,CAAC,SAAS,CAAC;IAChC,IAAIU,QAAQ,GAAG,IAAID,KAAK,CAACE,QAAQ,EAAE;IAEnC,MAAMC,KAAK,GAAGF,QAAQ,CAACG,YAAY,CAAC,UAAU,CAAC;IAG/CD,KAAK,CAACE,MAAM,CAACP,IAAI,CAAC;IAClB,MAAMQ,eAAe,GAAG,IAAIC,KAAK,CAACT,IAAI,CAACU,MAAM,CAAC;IAE9C,MAAMC,aAAa,GAAGZ,MAAM,CAACa,IAAI,IAAI,EAAE;IAEvC,KAAK,IAAIC,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGF,aAAa,EAAEE,CAAC,EAAE,EAAE;MAEpCR,KAAK,CAACE,MAAM,CAACC,eAAe,CAAC;MAE7B,KAAK,IAAIM,CAAC,GAAG,CAAC,EAAEA,CAAC,IAAId,IAAI,CAACU,MAAM,EAAEI,CAAC,EAAE,EAAE;QACnC,MAAMC,MAAM,GAAGf,IAAI,CAACc,CAAC,GAAG,CAAC,CAAC;QAC1B,MAAME,QAAQ,GAAGlB,WAAW,CAACiB,MAAM,CAAC;QACpC,MAAME,IAAI,GAAGZ,KAAK,CAACa,OAAO,CAACL,CAAC,GAAG,CAAC,EAAEC,CAAC,CAAC;QAEpC,IAAIE,QAAQ,EAAE;UACV,IAAIA,QAAQ,CAACG,IAAI,KAAK,MAAM,EAAE;YAC1BF,IAAI,CAACG,cAAc,GAAG;cAClBD,IAAI,EAAE,MAAM;cACZE,UAAU,EAAE,IAAI;cAChBC,QAAQ,EAAE,CAAE,IAAGN,QAAQ,CAACO,MAAM,CAACC,IAAI,CAAC,GAAG,CAAE,GAAE;YAC/C,CAAC;UACL,CAAC,MAAM,IAAIR,QAAQ,CAACG,IAAI,KAAK,UAAU,EAAE;YACrCF,IAAI,CAACQ,SAAS,GAAG;cAAEC,UAAU,EAAE;YAAQ,CAAC;YACxC,IAAIV,QAAQ,CAACW,MAAM,IAAI5B,MAAM,CAACiB,QAAQ,CAACW,MAAM,CAAC,EAAE;cAC5CV,IAAI,CAACW,MAAM,GAAG7B,MAAM,CAACiB,QAAQ,CAACW,MAAM,CAAC;YACzC;UACJ,CAAC,MAAM,IAAIX,QAAQ,CAACG,IAAI,KAAK,YAAY,EAAE;YACvC,IAAIH,QAAQ,CAACW,MAAM,IAAI5B,MAAM,CAACiB,QAAQ,CAACW,MAAM,CAAC,EAAE;cAC5CV,IAAI,CAACW,MAAM,GAAG7B,MAAM,CAACiB,QAAQ,CAACW,MAAM,CAAC;YACzC,CAAC,MAAM;cACHV,IAAI,CAACW,MAAM,GAAG,OAAO;YACzB;UACJ,CAAC,MAAM,IAAIZ,QAAQ,CAACG,IAAI,KAAK,UAAU,EAAE;YACrCF,IAAI,CAACG,cAAc,GAAG;cAClBD,IAAI,EAAE,MAAM;cACZU,gBAAgB,EAAE,IAAI;cACtBP,QAAQ,EAAE,CAAC,IAAIQ,IAAI,EAAE;YACzB,CAAC;YAED,IAAId,QAAQ,CAACW,MAAM,IAAI5B,MAAM,CAACiB,QAAQ,CAACW,MAAM,CAAC,EAAE;cAC5CV,IAAI,CAACW,MAAM,GAAG7B,MAAM,CAACiB,QAAQ,CAACW,MAAM,CAAC;YACzC,CAAC,MAAM;cACHV,IAAI,CAACW,MAAM,GAAG,YAAY;YAC9B;UACJ,CAAC,MAAM,IAAIZ,QAAQ,CAACG,IAAI,KAAK,MAAM,EAAE;YACjC,IAAIH,QAAQ,CAACW,MAAM,IAAI5B,MAAM,CAACiB,QAAQ,CAACW,MAAM,CAAC,EAAE;cAC5CV,IAAI,CAACW,MAAM,GAAG7B,MAAM,CAACiB,QAAQ,CAACW,MAAM,CAAC;YACzC,CAAC,MAAM;cACHV,IAAI,CAACW,MAAM,GAAG,GAAG;YACrB;UACJ;QACJ;MACJ;IACJ;IAEAvB,KAAK,CAACE,MAAM,CAACC,eAAe,CAAC;IAE7B,KAAK,IAAIM,CAAC,GAAG,CAAC,EAAEA,CAAC,IAAId,IAAI,CAACU,MAAM,EAAEI,CAAC,EAAE,EAAE;MACnC,MAAMG,IAAI,GAAGZ,KAAK,CAACa,OAAO,CAACP,aAAa,GAAG,CAAC,EAAEG,CAAC,CAAC;MAChDG,IAAI,CAACc,MAAM,GAAG;QAAEC,GAAG,EAAE;UAAEC,KAAK,EAAE;QAAO;MAAE,CAAC;IAC5C;IAEA,MAAM9B,QAAQ,CAAC+B,IAAI,CAACC,SAAS,CAACtC,YAAY,CAAC;EAC/C,CAAC;EAEDuC,KAAK,EAAE,MAAAA,CACHC,EAAE,EACFC,UAAU,EACVC,QAAQ,EACRC,cAAc,EACdC,cAAc,EACdC,WAAW,KACV;IACD,MAAMxC,KAAK,GAAGT,OAAO,CAAC,SAAS,CAAC;IAChC,IAAIU,QAAQ,GAAG,IAAID,KAAK,CAACE,QAAQ,EAAE;IACnC,MAAMD,QAAQ,CAAC+B,IAAI,CAACS,QAAQ,CAACJ,QAAQ,CAAC;IAEtC,MAAMK,IAAI,GAAG,EAAE;IAEfzC,QAAQ,CAAC0C,SAAS,CAAEC,SAAS,IAAK;MAC9B,IAAIC,OAAO;MAEXD,SAAS,CAACE,OAAO,CAAC,UAAUC,GAAG,EAAEC,SAAS,EAAE;QACxC,IAAI,CAACH,OAAO,EAAE;UACVA,OAAO,GAAGxD,CAAC,CAAC4D,IAAI,CAACF,GAAG,CAAC1B,MAAM,CAAC,CAAC6B,GAAG,CAC3BC,GAAG,IAAKb,cAAc,CAACa,GAAG,CAAC,CAC/B;QACL,CAAC,MAAM;UACH,MAAMC,SAAS,GAAG/D,CAAC,CAAC4D,IAAI,CAACF,GAAG,CAAC1B,MAAM,CAAC;UACpC,MAAMgC,UAAU,GAAGhE,CAAC,CAACiE,IAAI,CACrBF,SAAS,EACRG,GAAG,IAAKA,GAAG,IAAI,IAAI,IAAIA,GAAG,CAACC,QAAQ,EAAE,CAACC,IAAI,EAAE,KAAK,EAAE,CACvD;UAED,IAAI,CAACJ,UAAU,EAAE;YACb;UACJ;UAEA,MAAMK,MAAM,GAAGrE,CAAC,CAACsE,SAAS,CAACtE,CAAC,CAACuE,GAAG,CAACf,OAAO,EAAEO,SAAS,CAAC,CAAC;UAErD,IAAI,CAAC/D,CAAC,CAACwE,OAAO,CAACH,MAAM,CAAC,EAAE;YACpB,MAAMI,OAAO,GAAG1E,eAAe,CAACsE,MAAM,CAAC;YAEvChB,IAAI,CAACqB,IAAI,CAAC;cACNf,SAAS;cACTU,MAAM,EAAEI,OAAO;cACfE,YAAY,EAAEZ,SAAS,CAAC,CAAC;YAC7B,CAAC,CAAC;UACN;QACJ;MACJ,CAAC,CAAC;IACN,CAAC,CAAC;IAEF,MAAMa,MAAM,GAAG,EAAE;IACjB,MAAMC,aAAa,GAAG,EAAE;IACxB,MAAMC,UAAU,GAAG,EAAE;IAErB,MAAMC,MAAM,GAAGjC,EAAE,CAACkC,KAAK,CAACjC,UAAU,CAAC;IACnC,MAAMkC,SAAS,GAAG,EAAE;IACpB,MAAMhF,UAAU,CAACoD,IAAI,EAAE,OAAO;MAAEM,SAAS;MAAEU,MAAM;MAAEM;IAAa,CAAC,KAAK;MAClE,IAAI;QACA,MAAMO,QAAQ,GAAG,EAAE;QACnBb,MAAM,GAAG,MAAMnB,cAAc,CACzB6B,MAAM,EACNV,MAAM,EACNV,SAAS,EACTuB,QAAQ,CACX;QAGD,IAAIA,QAAQ,CAAC/D,MAAM,GAAG,CAAC,EAAE;UACrB+D,QAAQ,CAACC,OAAO,CAAEC,CAAC,IACfP,aAAa,CAACH,IAAI,CAAC;YAAEf,SAAS;YAAE,GAAGyB;UAAE,CAAC,CAAC,CAC1C;QACL;QAEAH,SAAS,CAACP,IAAI,CAAC;UAAEf,SAAS;UAAEU,MAAM;UAAEM;QAAa,CAAC,CAAC;QACnD,MAAMI,MAAM,CAACM,OAAO,CAAChB,MAAM,EAAE;UAAEiB,OAAO,EAAE;QAAK,CAAC,CAAC;MACnD,CAAC,CAAC,OAAOC,KAAK,EAAE;QACZX,MAAM,CAACF,IAAI,CAAC;UACRf,SAAS;UACT4B,KAAK,EAAEA,KAAK,CAACC,OAAO;UACpB,IAAID,KAAK,CAACE,IAAI,GAAG;YAAEA,IAAI,EAAEF,KAAK,CAACE;UAAK,CAAC,GAAG,IAAI;QAChD,CAAC,CAAC;MACN;IACJ,CAAC,CAAC;IAEF,IAAIb,MAAM,CAACzD,MAAM,GAAG,CAAC,EAAE;MACnB,OAAO;QAAEyD;MAAO,CAAC;IACrB;IAEA,IAAIzB,WAAW,IAAI0B,aAAa,CAAC1D,MAAM,GAAG,CAAC,EAAE;MACzC,OAAO;QAAE0D;MAAc,CAAC;IAC5B;IAEA,MAAM5E,UAAU,CACZgF,SAAS,EACT,OAAO;MAAEtB,SAAS;MAAEU,MAAM;MAAEM;IAAa,CAAC,KAAK;MAC3C,IAAI;QACA,MAAMe,MAAM,GAAG,MAAMX,MAAM,CAACM,OAAO,CAAChB,MAAM,CAAC;QAC3CS,UAAU,CAACJ,IAAI,CAAC;UACZf,SAAS;UACT,CAACoB,MAAM,CAACY,IAAI,CAACC,QAAQ,GAAGF,MAAM,CAACX,MAAM,CAACY,IAAI,CAACC,QAAQ,CAAC;UACpDjB;QACJ,CAAC,CAAC;MACN,CAAC,CAAC,OAAOY,KAAK,EAAE;QACZX,MAAM,CAACF,IAAI,CAAC;UACRf,SAAS;UACT4B,KAAK,EAAEA,KAAK,CAACC;QACjB,CAAC,CAAC;MACN;IACJ,CAAC,CACJ;IAED,OAAO;MAAEE,MAAM,EAAEZ,UAAU;MAAEF;IAAO,CAAC;EACzC;AACJ,CAAC"}