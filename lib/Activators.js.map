{"version":3,"file":"Activators.js","names":["_","require","ApplicationError","Generators","module","exports","datetimeAdd","model","context","startTime","duration","plus","isEqual","value1","value2","triggerUpdate","value","condition","defaultAs","generator","name","infoI18nOpts","concat","sep","strs","join","sum","args","reduce","v","multiply","multiplier","multiplicand","populate","assoc","options","parts","split","selectedField","pop","remoteAssoc","localAssoc","shift","interAssoc","length","latest","undefined","assocValue","isNil","meta","assocMeta","associations","list","remoteEntity","populated","useCache","db","entity","cached_","key","connOptions","findOptions","$query","$associations","ensureTransaction_","findOne_","currentAssoc","nextAssoc","Array","isArray","Error"],"sources":["../src/Activators.js"],"sourcesContent":["const { _ } = require('@genx/july');\nconst { ApplicationError } = require('./utils/Errors');\nconst Generators = require('./Generators');\n\nmodule.exports = {\n    datetimeAdd: function (model, context, startTime, duration) {\n        return startTime.plus(duration);\n    },\n\n    isEqual: function (model, context, value1, value2) {\n        return value1 === value2;\n    },\n\n    triggerUpdate: function (model, context, value, condition) {\n        return condition ? value : null;\n    },\n\n    defaultAs: function (model, context, value) {\n        return value;\n    },\n\n    generator: function (model, context, name, ...infoI18nOpts) {\n        return Generators[name](...infoI18nOpts);\n    },\n\n    concat: (model, context, sep = '', ...strs) => strs.join(sep),\n\n    sum: (model, context, ...args) => args.reduce((sum, v) => (sum += v), 0),\n\n    multiply: (model, context, multiplier, multiplicand) =>\n        multiplier * multiplicand,\n\n    populate: async (model, context, assoc, options) => {\n        const parts = assoc.split('.');\n\n        const selectedField = parts.pop();\n        const remoteAssoc = parts.join('.');\n        const localAssoc = parts.shift();\n        let interAssoc;\n\n        if (parts.length > 0) {\n            interAssoc = parts.join('.');\n        }\n\n        if (!(localAssoc in context.latest)) {\n            return undefined;\n        }\n\n        const assocValue = context.latest[localAssoc];\n        if (_.isNil(assocValue)) {\n            throw new ApplicationError(\n                `The value of referenced association \"${localAssoc}\" of entity \"${model.meta.name}\" should not be null.`\n            );\n        }\n\n        const assocMeta = model.meta.associations[localAssoc];\n        if (!assocMeta) {\n            throw new ApplicationError(\n                `\"${localAssoc}\" is not an association field of entity \"${model.meta.name}\".`\n            );\n        }\n\n        if (assocMeta.list) {\n            throw new ApplicationError(\n                `\"${localAssoc}\" entity \"${model.meta.name}\" is a list-style association which is not supported by the built-in populate Activators.`\n            );\n        }\n\n        // local cache in context, shared by other fields if any\n        let remoteEntity = context.populated && context.populated[remoteAssoc];\n        if (!remoteEntity) {\n            if (options && options.useCache) {\n                remoteEntity = (\n                    await model.db\n                        .model(assocMeta.entity)\n                        .cached_(\n                            assocMeta.key,\n                            interAssoc ? [interAssoc] : null,\n                            context.connOptions\n                        )\n                )[assocValue];\n            } else {\n                const findOptions = { $query: { [assocMeta.key]: assocValue } };\n\n                if (interAssoc) {\n                    findOptions.$associations = [interAssoc];\n                }\n\n                await model.ensureTransaction_(context);\n\n                remoteEntity = await model.db\n                    .model(assocMeta.entity)\n                    .findOne_(findOptions, context.connOptions);\n            }\n\n            if (!remoteEntity) {\n                throw new ApplicationError(\n                    `Unable to find the \"${assocMeta.entity}\" with [${assocMeta.key}=${assocValue}]. Entity: ${model.meta.name}`\n                );\n            }\n\n            context.populated || (context.populated = {});\n            context.populated[localAssoc] = remoteEntity;\n\n            let currentAssoc = localAssoc;\n            while (parts.length > 0) {\n                const nextAssoc = parts.shift();\n                remoteEntity = remoteEntity[':' + nextAssoc];\n                if (Array.isArray(remoteEntity)) {\n                    throw new Error('Remote entity should not be an array.');\n                }\n\n                currentAssoc = currentAssoc + '.' + nextAssoc;\n                context.populated[currentAssoc] = remoteEntity;\n            }\n        }\n\n        if (!(selectedField in remoteEntity)) {\n            throw new ApplicationError(\n                `\"${selectedField}\" is not a field of remote association \"${remoteAssoc}\" of entity \"${model.meta.name}\".`\n            );\n        }\n\n        return remoteEntity[selectedField];\n    },\n};\n"],"mappings":"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"}