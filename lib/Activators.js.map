{"version":3,"sources":["../src/Activators.js"],"names":["_","require","ApplicationError","Generators","module","exports","datetimeAdd","model","context","startTime","duration","plus","isEqual","value1","value2","triggerUpdate","value","condition","defaultAs","generator","name","infoI18nOpts","concat","sep","strs","join","sum","args","reduce","v","multiply","multiplier","multiplicand","populate","assoc","options","parts","split","assert","length","selectedField","pop","remoteAssoc","localAssoc","shift","interAssoc","latest","hasOwnProperty","undefined","assocValue","isNil","meta","assocMeta","associations","list","remoteEntity","populated","useCache","db","entity","cached_","key","connOptions","findOptions","$query","$associations","ensureTransaction_","findOne_","currentAssoc","nextAssoc","Array","isArray"],"mappings":";;;;AAAA,MAAM;AAAEA,EAAAA;AAAF,IAAQC,OAAO,CAAC,YAAD,CAArB;;AACA,MAAM;AAAEC,EAAAA;AAAF,IAAuBD,OAAO,CAAC,gBAAD,CAApC;;AACA,MAAME,UAAU,GAAGF,OAAO,CAAC,cAAD,CAA1B;;AAEAG,MAAM,CAACC,OAAP,GAAiB;AACbC,EAAAA,WAAW,EAAE,UAAUC,KAAV,EAAiBC,OAAjB,EAA0BC,SAA1B,EAAqCC,QAArC,EAA+C;AACxD,WAAOD,SAAS,CAACE,IAAV,CAAeD,QAAf,CAAP;AACH,GAHY;AAKbE,EAAAA,OAAO,EAAE,UAAUL,KAAV,EAAiBC,OAAjB,EAA0BK,MAA1B,EAAkCC,MAAlC,EAA0C;AAC/C,WAAOD,MAAM,KAAKC,MAAlB;AACH,GAPY;AASbC,EAAAA,aAAa,EAAE,UAAUR,KAAV,EAAiBC,OAAjB,EAA0BQ,KAA1B,EAAiCC,SAAjC,EAA4C;AACvD,WAAOA,SAAS,GAAGD,KAAH,GAAW,IAA3B;AACH,GAXY;AAabE,EAAAA,SAAS,EAAE,UAAUX,KAAV,EAAiBC,OAAjB,EAA0BQ,KAA1B,EAAiC;AACxC,WAAOA,KAAP;AACH,GAfY;AAiBbG,EAAAA,SAAS,EAAE,UAAUZ,KAAV,EAAiBC,OAAjB,EAA0BY,IAA1B,EAAgC,GAAGC,YAAnC,EAAiD;AACxD,WAAOlB,UAAU,CAACiB,IAAD,CAAV,CAAiB,GAAGC,YAApB,CAAP;AACH,GAnBY;AAqBbC,EAAAA,MAAM,EAAE,CAACf,KAAD,EAAQC,OAAR,EAAiBe,GAAG,GAAG,EAAvB,EAA2B,GAAGC,IAA9B,KAAuCA,IAAI,CAACC,IAAL,CAAUF,GAAV,CArBlC;AAuBbG,EAAAA,GAAG,EAAE,CAACnB,KAAD,EAAQC,OAAR,EAAiB,GAAGmB,IAApB,KAA6BA,IAAI,CAACC,MAAL,CAAY,CAACF,GAAD,EAAMG,CAAN,KAAaH,GAAG,IAAIG,CAAhC,EAAoC,CAApC,CAvBrB;AAyBbC,EAAAA,QAAQ,EAAE,CAACvB,KAAD,EAAQC,OAAR,EAAiBuB,UAAjB,EAA6BC,YAA7B,KACND,UAAU,GAAGC,YA1BJ;AA4BbC,EAAAA,QAAQ,EAAE,OAAO1B,KAAP,EAAcC,OAAd,EAAuB0B,KAAvB,EAA8BC,OAA9B,KAA0C;AAChD,QAAIC,KAAK,GAAGF,KAAK,CAACG,KAAN,CAAY,GAAZ,CAAZ;;AACAC,IAAAA,MAAM,EAAEF,KAAK,CAACG,MAAN,GAAe,CAAf;;AAER,QAAIC,aAAa,GAAGJ,KAAK,CAACK,GAAN,EAApB;AACA,QAAIC,WAAW,GAAGN,KAAK,CAACX,IAAN,CAAW,GAAX,CAAlB;AACA,QAAIkB,UAAU,GAAGP,KAAK,CAACQ,KAAN,EAAjB;AACA,QAAIC,UAAJ;;AAEA,QAAIT,KAAK,CAACG,MAAN,GAAe,CAAnB,EAAsB;AAClBM,MAAAA,UAAU,GAAGT,KAAK,CAACX,IAAN,CAAW,GAAX,CAAb;AACH;;AAED,QAAI,CAACjB,OAAO,CAACsC,MAAR,CAAeC,cAAf,CAA8BJ,UAA9B,CAAL,EAAgD;AAC5C,aAAOK,SAAP;AACH;;AAED,QAAIC,UAAU,GAAGzC,OAAO,CAACsC,MAAR,CAAeH,UAAf,CAAjB;;AACA,QAAI3C,CAAC,CAACkD,KAAF,CAAQD,UAAR,CAAJ,EAAyB;AACrB,YAAM,IAAI/C,gBAAJ,CACD,wCAAuCyC,UAAW,gBAAepC,KAAK,CAAC4C,IAAN,CAAW/B,IAAK,uBADhF,CAAN;AAGH;;AAED,QAAIgC,SAAS,GAAG7C,KAAK,CAAC4C,IAAN,CAAWE,YAAX,CAAwBV,UAAxB,CAAhB;;AACA,QAAI,CAACS,SAAL,EAAgB;AACZ,YAAM,IAAIlD,gBAAJ,CACD,IAAGyC,UAAW,4CAA2CpC,KAAK,CAAC4C,IAAN,CAAW/B,IAAK,IADxE,CAAN;AAGH;;AAED,QAAIgC,SAAS,CAACE,IAAd,EAAoB;AAChB,YAAM,IAAIpD,gBAAJ,CACD,IAAGyC,UAAW,aAAYpC,KAAK,CAAC4C,IAAN,CAAW/B,IAAK,2FADzC,CAAN;AAGH;;AAGD,QAAImC,YAAY,GAAG/C,OAAO,CAACgD,SAAR,IAAqBhD,OAAO,CAACgD,SAAR,CAAkBd,WAAlB,CAAxC;;AACA,QAAI,CAACa,YAAL,EAAmB;AACf,UAAIpB,OAAO,IAAIA,OAAO,CAACsB,QAAvB,EAAiC;AAC7BF,QAAAA,YAAY,GAAG,CACX,MAAMhD,KAAK,CAACmD,EAAN,CACDnD,KADC,CACK6C,SAAS,CAACO,MADf,EAEDC,OAFC,CAGER,SAAS,CAACS,GAHZ,EAIEhB,UAAU,GAAG,CAACA,UAAD,CAAH,GAAkB,IAJ9B,EAKErC,OAAO,CAACsD,WALV,CADK,EAQbb,UARa,CAAf;AASH,OAVD,MAUO;AACH,YAAIc,WAAW,GAAG;AAAEC,UAAAA,MAAM,EAAE;AAAE,aAACZ,SAAS,CAACS,GAAX,GAAiBZ;AAAnB;AAAV,SAAlB;;AAEA,YAAIJ,UAAJ,EAAgB;AACZkB,UAAAA,WAAW,CAACE,aAAZ,GAA4B,CAACpB,UAAD,CAA5B;AACH;;AAED,cAAMtC,KAAK,CAAC2D,kBAAN,CAAyB1D,OAAzB,CAAN;AAEA+C,QAAAA,YAAY,GAAG,MAAMhD,KAAK,CAACmD,EAAN,CAChBnD,KADgB,CACV6C,SAAS,CAACO,MADA,EAEhBQ,QAFgB,CAEPJ,WAFO,EAEMvD,OAAO,CAACsD,WAFd,CAArB;AAGH;;AAED,UAAI,CAACP,YAAL,EAAmB;AACf,cAAM,IAAIrD,gBAAJ,CACD,uBAAsBkD,SAAS,CAACO,MAAO,WAAUP,SAAS,CAACS,GAAI,IAAGZ,UAAW,cAAa1C,KAAK,CAAC4C,IAAN,CAAW/B,IAAK,EADzG,CAAN;AAGH;;AAEDZ,MAAAA,OAAO,CAACgD,SAAR,KAAsBhD,OAAO,CAACgD,SAAR,GAAoB,EAA1C;AACAhD,MAAAA,OAAO,CAACgD,SAAR,CAAkBb,UAAlB,IAAgCY,YAAhC;AAEA,UAAIa,YAAY,GAAGzB,UAAnB;;AACA,aAAOP,KAAK,CAACG,MAAN,GAAe,CAAtB,EAAyB;AACrB,YAAI8B,SAAS,GAAGjC,KAAK,CAACQ,KAAN,EAAhB;AACAW,QAAAA,YAAY,GAAGA,YAAY,CAAC,MAAMc,SAAP,CAA3B;;AACA/B,QAAAA,MAAM,EAAE,CAACgC,KAAK,CAACC,OAAN,CAAchB,YAAd,CAAD;;AAERa,QAAAA,YAAY,GAAGA,YAAY,GAAG,GAAf,GAAqBC,SAApC;AACA7D,QAAAA,OAAO,CAACgD,SAAR,CAAkBY,YAAlB,IAAkCb,YAAlC;AACH;AACJ;;AAED,QAAI,CAACA,YAAY,CAACR,cAAb,CAA4BP,aAA5B,CAAL,EAAiD;AAC7C,YAAM,IAAItC,gBAAJ,CACD,IAAGsC,aAAc,2CAA0CE,WAAY,gBAAenC,KAAK,CAAC4C,IAAN,CAAW/B,IAAK,IADrG,CAAN;AAGH;;AAED,WAAOmC,YAAY,CAACf,aAAD,CAAnB;AACH;AAvHY,CAAjB","sourcesContent":["const { _ } = require('@genx/july');\nconst { ApplicationError } = require('./utils/Errors');\nconst Generators = require('./Generators');\n\nmodule.exports = {\n    datetimeAdd: function (model, context, startTime, duration) {\n        return startTime.plus(duration);\n    },\n\n    isEqual: function (model, context, value1, value2) {\n        return value1 === value2;\n    },\n\n    triggerUpdate: function (model, context, value, condition) {\n        return condition ? value : null;\n    },\n\n    defaultAs: function (model, context, value) {\n        return value;\n    },\n\n    generator: function (model, context, name, ...infoI18nOpts) {\n        return Generators[name](...infoI18nOpts);\n    },\n\n    concat: (model, context, sep = '', ...strs) => strs.join(sep),\n\n    sum: (model, context, ...args) => args.reduce((sum, v) => (sum += v), 0),\n\n    multiply: (model, context, multiplier, multiplicand) =>\n        multiplier * multiplicand,\n\n    populate: async (model, context, assoc, options) => {\n        let parts = assoc.split('.');\n        assert: parts.length > 1;\n\n        let selectedField = parts.pop();\n        let remoteAssoc = parts.join('.');\n        let localAssoc = parts.shift();\n        let interAssoc;\n\n        if (parts.length > 0) {\n            interAssoc = parts.join('.');\n        }\n\n        if (!context.latest.hasOwnProperty(localAssoc)) {\n            return undefined;\n        }\n\n        let assocValue = context.latest[localAssoc];\n        if (_.isNil(assocValue)) {\n            throw new ApplicationError(\n                `The value of referenced association \"${localAssoc}\" of entity \"${model.meta.name}\" should not be null.`\n            );\n        }\n\n        let assocMeta = model.meta.associations[localAssoc];\n        if (!assocMeta) {\n            throw new ApplicationError(\n                `\"${localAssoc}\" is not an association field of entity \"${model.meta.name}\".`\n            );\n        }\n\n        if (assocMeta.list) {\n            throw new ApplicationError(\n                `\"${localAssoc}\" entity \"${model.meta.name}\" is a list-style association which is not supported by the built-in populate Activators.`\n            );\n        }\n\n        //local cache in context, shared by other fields if any\n        let remoteEntity = context.populated && context.populated[remoteAssoc];\n        if (!remoteEntity) {\n            if (options && options.useCache) {\n                remoteEntity = (\n                    await model.db\n                        .model(assocMeta.entity)\n                        .cached_(\n                            assocMeta.key,\n                            interAssoc ? [interAssoc] : null,\n                            context.connOptions\n                        )\n                )[assocValue];\n            } else {\n                let findOptions = { $query: { [assocMeta.key]: assocValue } };\n\n                if (interAssoc) {\n                    findOptions.$associations = [interAssoc];\n                }\n\n                await model.ensureTransaction_(context);\n\n                remoteEntity = await model.db\n                    .model(assocMeta.entity)\n                    .findOne_(findOptions, context.connOptions);\n            }\n\n            if (!remoteEntity) {\n                throw new ApplicationError(\n                    `Unable to find the \"${assocMeta.entity}\" with [${assocMeta.key}=${assocValue}]. Entity: ${model.meta.name}`\n                );\n            }\n\n            context.populated || (context.populated = {});\n            context.populated[localAssoc] = remoteEntity;\n\n            let currentAssoc = localAssoc;\n            while (parts.length > 0) {\n                let nextAssoc = parts.shift();\n                remoteEntity = remoteEntity[':' + nextAssoc];\n                assert: !Array.isArray(remoteEntity);\n\n                currentAssoc = currentAssoc + '.' + nextAssoc;\n                context.populated[currentAssoc] = remoteEntity;\n            }\n        }\n\n        if (!remoteEntity.hasOwnProperty(selectedField)) {\n            throw new ApplicationError(\n                `\"${selectedField}\" is not a field of remote association \"${remoteAssoc}\" of entity \"${model.meta.name}\".`\n            );\n        }\n\n        return remoteEntity[selectedField];\n    },\n};\n"],"file":"Activators.js"}