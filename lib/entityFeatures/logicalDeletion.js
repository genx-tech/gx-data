"use strict";

require("source-map-support/register");

const Rules = require('../enum/Rules');

const {
  mergeCondition
} = require('../utils/lang');

const Generators = require('../Generators');

const {
  _
} = require("@genx/july");

module.exports = {
  [Rules.RULE_BEFORE_FIND]: (feature, entityModel, context) => {
    let findOptions = context.options;

    if (!findOptions.$includeDeleted) {
      findOptions.$query = mergeCondition(findOptions.$query, {
        [feature.field]: {
          $ne: feature.value
        }
      });
    }

    return true;
  },
  [Rules.RULE_BEFORE_DELETE]: async (feature, entityModel, context) => {
    let options = context.options;

    if (!options.$physicalDeletion) {
      let {
        field,
        value,
        timestampField
      } = feature;
      let updateTo = {
        [field]: value
      };

      if (timestampField) {
        updateTo[timestampField] = Generators.default(entityModel.meta.fields[timestampField], context.i18n);
      }

      const updateOpts = {
        $query: options.$query,
        $retrieveUpdated: options.$retrieveDeleted,
        $bypassReadOnly: new Set([field, timestampField]),
        ..._.pick(options, ['$retrieveDeleted', '$retrieveDbResult'])
      };
      context.return = await entityModel._update_(updateTo, updateOpts, context.connOptions, context.forSingleRecord);

      if (options.$retrieveDbResult) {
        context.rawOptions.$result = updateOpts.$result;
      }

      return false;
    }

    return true;
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9lbnRpdHlGZWF0dXJlcy9sb2dpY2FsRGVsZXRpb24uanMiXSwibmFtZXMiOlsiUnVsZXMiLCJyZXF1aXJlIiwibWVyZ2VDb25kaXRpb24iLCJHZW5lcmF0b3JzIiwiXyIsIm1vZHVsZSIsImV4cG9ydHMiLCJSVUxFX0JFRk9SRV9GSU5EIiwiZmVhdHVyZSIsImVudGl0eU1vZGVsIiwiY29udGV4dCIsImZpbmRPcHRpb25zIiwib3B0aW9ucyIsIiRpbmNsdWRlRGVsZXRlZCIsIiRxdWVyeSIsImZpZWxkIiwiJG5lIiwidmFsdWUiLCJSVUxFX0JFRk9SRV9ERUxFVEUiLCIkcGh5c2ljYWxEZWxldGlvbiIsInRpbWVzdGFtcEZpZWxkIiwidXBkYXRlVG8iLCJkZWZhdWx0IiwibWV0YSIsImZpZWxkcyIsImkxOG4iLCJ1cGRhdGVPcHRzIiwiJHJldHJpZXZlVXBkYXRlZCIsIiRyZXRyaWV2ZURlbGV0ZWQiLCIkYnlwYXNzUmVhZE9ubHkiLCJTZXQiLCJwaWNrIiwicmV0dXJuIiwiX3VwZGF0ZV8iLCJjb25uT3B0aW9ucyIsImZvclNpbmdsZVJlY29yZCIsIiRyZXRyaWV2ZURiUmVzdWx0IiwicmF3T3B0aW9ucyIsIiRyZXN1bHQiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTUEsS0FBSyxHQUFHQyxPQUFPLENBQUMsZUFBRCxDQUFyQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBO0FBQUYsSUFBcUJELE9BQU8sQ0FBQyxlQUFELENBQWxDOztBQUNBLE1BQU1FLFVBQVUsR0FBR0YsT0FBTyxDQUFDLGVBQUQsQ0FBMUI7O0FBQ0EsTUFBTTtBQUFFRyxFQUFBQTtBQUFGLElBQVFILE9BQU8sQ0FBQyxZQUFELENBQXJCOztBQU9BSSxNQUFNLENBQUNDLE9BQVAsR0FBaUI7QUFDYixHQUFDTixLQUFLLENBQUNPLGdCQUFQLEdBQTBCLENBQUNDLE9BQUQsRUFBVUMsV0FBVixFQUF1QkMsT0FBdkIsS0FBbUM7QUFDekQsUUFBSUMsV0FBVyxHQUFHRCxPQUFPLENBQUNFLE9BQTFCOztBQUNBLFFBQUksQ0FBQ0QsV0FBVyxDQUFDRSxlQUFqQixFQUFrQztBQUM5QkYsTUFBQUEsV0FBVyxDQUFDRyxNQUFaLEdBQXFCWixjQUFjLENBQUNTLFdBQVcsQ0FBQ0csTUFBYixFQUFxQjtBQUFFLFNBQUNOLE9BQU8sQ0FBQ08sS0FBVCxHQUFpQjtBQUFFQyxVQUFBQSxHQUFHLEVBQUVSLE9BQU8sQ0FBQ1M7QUFBZjtBQUFuQixPQUFyQixDQUFuQztBQUNIOztBQUVELFdBQU8sSUFBUDtBQUNILEdBUlk7QUFTYixHQUFDakIsS0FBSyxDQUFDa0Isa0JBQVAsR0FBNEIsT0FBT1YsT0FBUCxFQUFnQkMsV0FBaEIsRUFBNkJDLE9BQTdCLEtBQXlDO0FBQ2pFLFFBQUlFLE9BQU8sR0FBR0YsT0FBTyxDQUFDRSxPQUF0Qjs7QUFDQSxRQUFJLENBQUNBLE9BQU8sQ0FBQ08saUJBQWIsRUFBZ0M7QUFDNUIsVUFBSTtBQUFFSixRQUFBQSxLQUFGO0FBQVNFLFFBQUFBLEtBQVQ7QUFBZ0JHLFFBQUFBO0FBQWhCLFVBQW1DWixPQUF2QztBQUNBLFVBQUlhLFFBQVEsR0FBRztBQUNYLFNBQUNOLEtBQUQsR0FBU0U7QUFERSxPQUFmOztBQUlBLFVBQUlHLGNBQUosRUFBb0I7QUFDaEJDLFFBQUFBLFFBQVEsQ0FBQ0QsY0FBRCxDQUFSLEdBQTJCakIsVUFBVSxDQUFDbUIsT0FBWCxDQUFtQmIsV0FBVyxDQUFDYyxJQUFaLENBQWlCQyxNQUFqQixDQUF3QkosY0FBeEIsQ0FBbkIsRUFBNERWLE9BQU8sQ0FBQ2UsSUFBcEUsQ0FBM0I7QUFDSDs7QUFFRCxZQUFNQyxVQUFVLEdBQUc7QUFDZlosUUFBQUEsTUFBTSxFQUFFRixPQUFPLENBQUNFLE1BREQ7QUFFZmEsUUFBQUEsZ0JBQWdCLEVBQUVmLE9BQU8sQ0FBQ2dCLGdCQUZYO0FBR2ZDLFFBQUFBLGVBQWUsRUFBRSxJQUFJQyxHQUFKLENBQVEsQ0FBQ2YsS0FBRCxFQUFRSyxjQUFSLENBQVIsQ0FIRjtBQUlmLFdBQUdoQixDQUFDLENBQUMyQixJQUFGLENBQU9uQixPQUFQLEVBQWdCLENBQUUsa0JBQUYsRUFBc0IsbUJBQXRCLENBQWhCO0FBSlksT0FBbkI7QUFPQUYsTUFBQUEsT0FBTyxDQUFDc0IsTUFBUixHQUFpQixNQUFNdkIsV0FBVyxDQUFDd0IsUUFBWixDQUFxQlosUUFBckIsRUFBK0JLLFVBQS9CLEVBQTJDaEIsT0FBTyxDQUFDd0IsV0FBbkQsRUFBZ0V4QixPQUFPLENBQUN5QixlQUF4RSxDQUF2Qjs7QUFFQSxVQUFJdkIsT0FBTyxDQUFDd0IsaUJBQVosRUFBK0I7QUFDM0IxQixRQUFBQSxPQUFPLENBQUMyQixVQUFSLENBQW1CQyxPQUFuQixHQUE2QlosVUFBVSxDQUFDWSxPQUF4QztBQUNIOztBQUVELGFBQU8sS0FBUDtBQUNIOztBQUVELFdBQU8sSUFBUDtBQUNIO0FBdENZLENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IFJ1bGVzID0gcmVxdWlyZSgnLi4vZW51bS9SdWxlcycpO1xuY29uc3QgeyBtZXJnZUNvbmRpdGlvbiB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvbGFuZycpO1xuY29uc3QgR2VuZXJhdG9ycyA9IHJlcXVpcmUoJy4uL0dlbmVyYXRvcnMnKTtcbmNvbnN0IHsgXyB9ID0gcmVxdWlyZShcIkBnZW54L2p1bHlcIik7XG5cbi8qKlxuICogQSBydWxlIHNwZWNpZmllcyB0aGUgZW50aXR5IHdpbGwgbm90IGJlIGRlbGV0ZWQgcGh5c2ljYWxseS5cbiAqIEBtb2R1bGUgRW50aXR5RmVhdHVyZVJ1bnRpbWVfTG9naWNhbERlbGV0aW9uXG4gKi9cblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gICAgW1J1bGVzLlJVTEVfQkVGT1JFX0ZJTkRdOiAoZmVhdHVyZSwgZW50aXR5TW9kZWwsIGNvbnRleHQpID0+IHtcbiAgICAgICAgbGV0IGZpbmRPcHRpb25zID0gY29udGV4dC5vcHRpb25zO1xuICAgICAgICBpZiAoIWZpbmRPcHRpb25zLiRpbmNsdWRlRGVsZXRlZCkge1xuICAgICAgICAgICAgZmluZE9wdGlvbnMuJHF1ZXJ5ID0gbWVyZ2VDb25kaXRpb24oZmluZE9wdGlvbnMuJHF1ZXJ5LCB7IFtmZWF0dXJlLmZpZWxkXTogeyAkbmU6IGZlYXR1cmUudmFsdWUgfSB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH0sXG4gICAgW1J1bGVzLlJVTEVfQkVGT1JFX0RFTEVURV06IGFzeW5jIChmZWF0dXJlLCBlbnRpdHlNb2RlbCwgY29udGV4dCkgPT4ge1xuICAgICAgICBsZXQgb3B0aW9ucyA9IGNvbnRleHQub3B0aW9ucztcbiAgICAgICAgaWYgKCFvcHRpb25zLiRwaHlzaWNhbERlbGV0aW9uKSB7XG4gICAgICAgICAgICBsZXQgeyBmaWVsZCwgdmFsdWUsIHRpbWVzdGFtcEZpZWxkIH0gPSBmZWF0dXJlO1xuICAgICAgICAgICAgbGV0IHVwZGF0ZVRvID0ge1xuICAgICAgICAgICAgICAgIFtmaWVsZF06IHZhbHVlXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBpZiAodGltZXN0YW1wRmllbGQpIHtcbiAgICAgICAgICAgICAgICB1cGRhdGVUb1t0aW1lc3RhbXBGaWVsZF0gPSBHZW5lcmF0b3JzLmRlZmF1bHQoZW50aXR5TW9kZWwubWV0YS5maWVsZHNbdGltZXN0YW1wRmllbGRdLCBjb250ZXh0LmkxOG4pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCB1cGRhdGVPcHRzID0geyBcbiAgICAgICAgICAgICAgICAkcXVlcnk6IG9wdGlvbnMuJHF1ZXJ5LCBcbiAgICAgICAgICAgICAgICAkcmV0cmlldmVVcGRhdGVkOiBvcHRpb25zLiRyZXRyaWV2ZURlbGV0ZWQsICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICRieXBhc3NSZWFkT25seTogbmV3IFNldChbZmllbGQsIHRpbWVzdGFtcEZpZWxkXSksXG4gICAgICAgICAgICAgICAgLi4uXy5waWNrKG9wdGlvbnMsIFsgJyRyZXRyaWV2ZURlbGV0ZWQnLCAnJHJldHJpZXZlRGJSZXN1bHQnIF0pXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnRleHQucmV0dXJuID0gYXdhaXQgZW50aXR5TW9kZWwuX3VwZGF0ZV8odXBkYXRlVG8sIHVwZGF0ZU9wdHMsIGNvbnRleHQuY29ubk9wdGlvbnMsIGNvbnRleHQuZm9yU2luZ2xlUmVjb3JkKTtcblxuICAgICAgICAgICAgaWYgKG9wdGlvbnMuJHJldHJpZXZlRGJSZXN1bHQpIHtcbiAgICAgICAgICAgICAgICBjb250ZXh0LnJhd09wdGlvbnMuJHJlc3VsdCA9IHVwZGF0ZU9wdHMuJHJlc3VsdDsgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbn07Il19