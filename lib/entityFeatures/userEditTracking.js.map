{"version":3,"file":"userEditTracking.js","names":["Rules","require","InvalidArgument","Lang","addCreatedBy_","entityModel","feature","context","options","$migration","latest","fields","createdBy","migrationUser","uid","getValueFromContext","uidSource","meta","name","addUpdatedBy_","$skipFeatures","includes","updatedBy","revision","$inc","module","exports","RULE_BEFORE_VALIDATION","op"],"sources":["../../src/entityFeatures/userEditTracking.js"],"sourcesContent":["const Rules = require('../enum/Rules');\nconst { InvalidArgument } = require('../utils/Errors');\nconst Lang = require('../utils/lang');\n\nfunction addCreatedBy_(entityModel, feature, context) {\n    if (context.options.$migration) {\n        context.latest[feature.fields.createdBy] = feature.migrationUser;\n        return true;\n    }\n\n    const uid = entityModel.getValueFromContext(context, feature.uidSource);\n    if (uid == null) {\n        throw new InvalidArgument(\n            `Context \"${feature.uidSource}\" not found. Entity: ${entityModel.meta.name}`\n        );\n    }\n    context.latest[feature.fields.createdBy] = uid;\n    return true;\n}\n\nfunction addUpdatedBy_(entityModel, feature, context) {\n    if (context.options.$skipFeatures?.includes('userEditTracking')) return true;\n\n    const uid = entityModel.getValueFromContext(context, feature.uidSource);\n    if (uid == null) {\n        throw new InvalidArgument(`Context \"${feature.uidSource}\" not found.`);\n    }\n    context.latest[feature.fields.updatedBy] = uid;\n    context.latest[feature.fields.revision] = Lang.$inc(feature.fields.revision, 1);\n    // revision++\n    return true;\n}\n\n/**\n * A rule specifies the change of state will be tracked automatically.\n * @module EntityFeatureRuntime_ChangeLog\n */\n\nmodule.exports = {\n    [Rules.RULE_BEFORE_VALIDATION]: (feature, entityModel, context) =>\n        context.op === 'create'\n            ? addCreatedBy_(entityModel, feature, context)\n            : addUpdatedBy_(entityModel, feature, context),\n};\n"],"mappings":";;;;AAAA,MAAMA,KAAK,GAAGC,OAAO,CAAC,eAAD,CAArB;;AACA,MAAM;EAAEC;AAAF,IAAsBD,OAAO,CAAC,iBAAD,CAAnC;;AACA,MAAME,IAAI,GAAGF,OAAO,CAAC,eAAD,CAApB;;AAEA,SAASG,aAAT,CAAuBC,WAAvB,EAAoCC,OAApC,EAA6CC,OAA7C,EAAsD;EAClD,IAAIA,OAAO,CAACC,OAAR,CAAgBC,UAApB,EAAgC;IAC5BF,OAAO,CAACG,MAAR,CAAeJ,OAAO,CAACK,MAAR,CAAeC,SAA9B,IAA2CN,OAAO,CAACO,aAAnD;IACA,OAAO,IAAP;EACH;;EAED,MAAMC,GAAG,GAAGT,WAAW,CAACU,mBAAZ,CAAgCR,OAAhC,EAAyCD,OAAO,CAACU,SAAjD,CAAZ;;EACA,IAAIF,GAAG,IAAI,IAAX,EAAiB;IACb,MAAM,IAAIZ,eAAJ,CACD,YAAWI,OAAO,CAACU,SAAU,wBAAuBX,WAAW,CAACY,IAAZ,CAAiBC,IAAK,EADzE,CAAN;EAGH;;EACDX,OAAO,CAACG,MAAR,CAAeJ,OAAO,CAACK,MAAR,CAAeC,SAA9B,IAA2CE,GAA3C;EACA,OAAO,IAAP;AACH;;AAED,SAASK,aAAT,CAAuBd,WAAvB,EAAoCC,OAApC,EAA6CC,OAA7C,EAAsD;EAAA;;EAClD,6BAAIA,OAAO,CAACC,OAAR,CAAgBY,aAApB,aAAI,sBAA+BC,QAA/B,CAAwC,kBAAxC,CAAJ,EAAiE,OAAO,IAAP;EAEjE,MAAMP,GAAG,GAAGT,WAAW,CAACU,mBAAZ,CAAgCR,OAAhC,EAAyCD,OAAO,CAACU,SAAjD,CAAZ;;EACA,IAAIF,GAAG,IAAI,IAAX,EAAiB;IACb,MAAM,IAAIZ,eAAJ,CAAqB,YAAWI,OAAO,CAACU,SAAU,cAAlD,CAAN;EACH;;EACDT,OAAO,CAACG,MAAR,CAAeJ,OAAO,CAACK,MAAR,CAAeW,SAA9B,IAA2CR,GAA3C;EACAP,OAAO,CAACG,MAAR,CAAeJ,OAAO,CAACK,MAAR,CAAeY,QAA9B,IAA0CpB,IAAI,CAACqB,IAAL,CAAUlB,OAAO,CAACK,MAAR,CAAeY,QAAzB,EAAmC,CAAnC,CAA1C;EAEA,OAAO,IAAP;AACH;;AAODE,MAAM,CAACC,OAAP,GAAiB;EACb,CAAC1B,KAAK,CAAC2B,sBAAP,GAAgC,CAACrB,OAAD,EAAUD,WAAV,EAAuBE,OAAvB,KAC5BA,OAAO,CAACqB,EAAR,KAAe,QAAf,GACMxB,aAAa,CAACC,WAAD,EAAcC,OAAd,EAAuBC,OAAvB,CADnB,GAEMY,aAAa,CAACd,WAAD,EAAcC,OAAd,EAAuBC,OAAvB;AAJV,CAAjB"}