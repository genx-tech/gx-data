{"version":3,"file":"changeLog.js","names":["_","require","Rules","DATETIME","ApplicationError","getConnector","entityModel","feature","app","db","connector","log","getService","dataSource","createLogEntry_","context","operation","logEntry","entity","meta","name","which","queryKey","changedAt","typeObject","local","data","latest","existing","withUser","user","getValueFromContext","isNil","changedBy","options","$dryRun","clConnector","insertOne_","storeEntity","connOptions","module","exports","RULE_AFTER_CREATE","RULE_AFTER_UPDATE","RULE_AFTER_DELETE"],"sources":["../../src/entityFeatures/changeLog.js"],"sourcesContent":["const { _ } = require('@genx/july');\nconst Rules = require('../enum/Rules');\nconst { DATETIME } = require('../types');\nconst { ApplicationError } = require('../utils/Errors');\n\nfunction getConnector(entityModel, feature) {\n    const app = entityModel.db.app;\n\n    if (!app) {\n        entityModel.db.connector.log(\n            'warn',\n            `\"changeLog\" feature does not work when used without a service container app.`\n        );\n        return true;\n    }\n\n    return app.getService(feature.dataSource);\n}\n\nasync function createLogEntry_(entityModel, feature, context, operation) {\n    const logEntry = {\n        entity: entityModel.meta.name,\n        operation,\n        which: context.queryKey,\n        changedAt: DATETIME.typeObject.local(),\n    };\n\n    if (operation !== 'delete') {\n        logEntry.data = context.latest;\n    } else {\n        logEntry.data = context.existing;\n    }\n\n    if (feature.withUser) {\n        const user = entityModel.getValueFromContext(context, feature.withUser);\n        if (_.isNil(user)) {\n            throw new ApplicationError(\n                `Cannot get value of [${feature.withUser}] from context. Entity: ${entityModel.meta.name}, operation: ${operation}`\n            );\n        }\n\n        logEntry.changedBy = user;\n    }\n\n    // dry-run mode only checks validaty of data\n    if (context.options.$dryRun) {\n        return;\n    }\n\n    const clConnector = getConnector(entityModel, feature);\n    await clConnector.insertOne_(\n        feature.storeEntity,\n        logEntry,\n        context.connOptions\n    );\n}\n\n/**\n * A rule specifies the change of state will be tracked automatically.\n * @module EntityFeatureRuntime_ChangeLog\n */\n\nmodule.exports = {\n    [Rules.RULE_AFTER_CREATE]: (feature, entityModel, context) =>\n        createLogEntry_(entityModel, feature, context, 'create'),\n    [Rules.RULE_AFTER_UPDATE]: (feature, entityModel, context) =>\n        createLogEntry_(entityModel, feature, context, 'update'),\n    [Rules.RULE_AFTER_DELETE]: (feature, entityModel, context) =>\n        createLogEntry_(entityModel, feature, context, 'delete'),\n};\n"],"mappings":";;;;AAAA,MAAM;EAAEA;AAAF,IAAQC,OAAO,CAAC,YAAD,CAArB;;AACA,MAAMC,KAAK,GAAGD,OAAO,CAAC,eAAD,CAArB;;AACA,MAAM;EAAEE;AAAF,IAAeF,OAAO,CAAC,UAAD,CAA5B;;AACA,MAAM;EAAEG;AAAF,IAAuBH,OAAO,CAAC,iBAAD,CAApC;;AAEA,SAASI,YAAT,CAAsBC,WAAtB,EAAmCC,OAAnC,EAA4C;EACxC,MAAMC,GAAG,GAAGF,WAAW,CAACG,EAAZ,CAAeD,GAA3B;;EAEA,IAAI,CAACA,GAAL,EAAU;IACNF,WAAW,CAACG,EAAZ,CAAeC,SAAf,CAAyBC,GAAzB,CACI,MADJ,EAEK,8EAFL;IAIA,OAAO,IAAP;EACH;;EAED,OAAOH,GAAG,CAACI,UAAJ,CAAeL,OAAO,CAACM,UAAvB,CAAP;AACH;;AAED,eAAeC,eAAf,CAA+BR,WAA/B,EAA4CC,OAA5C,EAAqDQ,OAArD,EAA8DC,SAA9D,EAAyE;EACrE,MAAMC,QAAQ,GAAG;IACbC,MAAM,EAAEZ,WAAW,CAACa,IAAZ,CAAiBC,IADZ;IAEbJ,SAFa;IAGbK,KAAK,EAAEN,OAAO,CAACO,QAHF;IAIbC,SAAS,EAAEpB,QAAQ,CAACqB,UAAT,CAAoBC,KAApB;EAJE,CAAjB;;EAOA,IAAIT,SAAS,KAAK,QAAlB,EAA4B;IACxBC,QAAQ,CAACS,IAAT,GAAgBX,OAAO,CAACY,MAAxB;EACH,CAFD,MAEO;IACHV,QAAQ,CAACS,IAAT,GAAgBX,OAAO,CAACa,QAAxB;EACH;;EAED,IAAIrB,OAAO,CAACsB,QAAZ,EAAsB;IAClB,MAAMC,IAAI,GAAGxB,WAAW,CAACyB,mBAAZ,CAAgChB,OAAhC,EAAyCR,OAAO,CAACsB,QAAjD,CAAb;;IACA,IAAI7B,CAAC,CAACgC,KAAF,CAAQF,IAAR,CAAJ,EAAmB;MACf,MAAM,IAAI1B,gBAAJ,CACD,wBAAuBG,OAAO,CAACsB,QAAS,2BAA0BvB,WAAW,CAACa,IAAZ,CAAiBC,IAAK,gBAAeJ,SAAU,EADhH,CAAN;IAGH;;IAEDC,QAAQ,CAACgB,SAAT,GAAqBH,IAArB;EACH;;EAGD,IAAIf,OAAO,CAACmB,OAAR,CAAgBC,OAApB,EAA6B;IACzB;EACH;;EAED,MAAMC,WAAW,GAAG/B,YAAY,CAACC,WAAD,EAAcC,OAAd,CAAhC;EACA,MAAM6B,WAAW,CAACC,UAAZ,CACF9B,OAAO,CAAC+B,WADN,EAEFrB,QAFE,EAGFF,OAAO,CAACwB,WAHN,CAAN;AAKH;;AAODC,MAAM,CAACC,OAAP,GAAiB;EACb,CAACvC,KAAK,CAACwC,iBAAP,GAA2B,CAACnC,OAAD,EAAUD,WAAV,EAAuBS,OAAvB,KACvBD,eAAe,CAACR,WAAD,EAAcC,OAAd,EAAuBQ,OAAvB,EAAgC,QAAhC,CAFN;EAGb,CAACb,KAAK,CAACyC,iBAAP,GAA2B,CAACpC,OAAD,EAAUD,WAAV,EAAuBS,OAAvB,KACvBD,eAAe,CAACR,WAAD,EAAcC,OAAd,EAAuBQ,OAAvB,EAAgC,QAAhC,CAJN;EAKb,CAACb,KAAK,CAAC0C,iBAAP,GAA2B,CAACrC,OAAD,EAAUD,WAAV,EAAuBS,OAAvB,KACvBD,eAAe,CAACR,WAAD,EAAcC,OAAd,EAAuBQ,OAAvB,EAAgC,QAAhC;AANN,CAAjB"}