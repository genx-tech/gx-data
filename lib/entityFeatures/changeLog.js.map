{"version":3,"file":"changeLog.js","names":["_","require","Rules","DATETIME","ApplicationError","getConnector","entityModel","feature","app","db","connector","log","getService","dataSource","createLogEntry_","context","operation","logEntry","entity","meta","name","which","queryKey","changedAt","typeObject","local","data","latest","existing","withUser","user","getValueFromContext","isNil","changedBy","options","$dryRun","clConnector","insertOne_","storeEntity","connOptions","module","exports","RULE_AFTER_CREATE","RULE_AFTER_UPDATE","RULE_AFTER_DELETE"],"sources":["../../src/entityFeatures/changeLog.js"],"sourcesContent":["const { _ } = require('@genx/july');\nconst Rules = require('../enum/Rules');\nconst { DATETIME } = require('../types');\nconst { ApplicationError } = require('../utils/Errors');\n\nfunction getConnector(entityModel, feature) {\n    const app = entityModel.db.app;\n\n    if (!app) {\n        entityModel.db.connector.log(\n            'warn',\n            `\"changeLog\" feature does not work when used without a service container app.`\n        );\n        return true;\n    }\n\n    return app.getService(feature.dataSource);\n}\n\nasync function createLogEntry_(entityModel, feature, context, operation) {\n    const logEntry = {\n        entity: entityModel.meta.name,\n        operation,\n        which: context.queryKey,\n        changedAt: DATETIME.typeObject.local(),\n    };\n\n    if (operation !== 'delete') {\n        logEntry.data = context.latest;\n    } else {\n        logEntry.data = context.existing;\n    }\n\n    if (feature.withUser) {\n        const user = entityModel.getValueFromContext(context, feature.withUser);\n        if (_.isNil(user)) {\n            throw new ApplicationError(\n                `Cannot get value of [${feature.withUser}] from context. Entity: ${entityModel.meta.name}, operation: ${operation}`\n            );\n        }\n\n        logEntry.changedBy = user;\n    }\n\n    // dry-run mode only checks validaty of data\n    if (context.options.$dryRun) {\n        return;\n    }\n\n    const clConnector = getConnector(entityModel, feature);\n    await clConnector.insertOne_(\n        feature.storeEntity,\n        logEntry,\n        context.connOptions\n    );\n}\n\n/**\n * A rule specifies the change of state will be tracked automatically.\n * @module EntityFeatureRuntime_ChangeLog\n */\n\nmodule.exports = {\n    [Rules.RULE_AFTER_CREATE]: (feature, entityModel, context) =>\n        createLogEntry_(entityModel, feature, context, 'create'),\n    [Rules.RULE_AFTER_UPDATE]: (feature, entityModel, context) =>\n        createLogEntry_(entityModel, feature, context, 'update'),\n    [Rules.RULE_AFTER_DELETE]: (feature, entityModel, context) =>\n        createLogEntry_(entityModel, feature, context, 'delete'),\n};\n"],"mappings":";;;AAAA,MAAM;EAAEA;AAAE,CAAC,GAAGC,OAAO,CAAC,YAAY,CAAC;AACnC,MAAMC,KAAK,GAAGD,OAAO,CAAC,eAAe,CAAC;AACtC,MAAM;EAAEE;AAAS,CAAC,GAAGF,OAAO,CAAC,UAAU,CAAC;AACxC,MAAM;EAAEG;AAAiB,CAAC,GAAGH,OAAO,CAAC,iBAAiB,CAAC;AAEvD,SAASI,YAAYA,CAACC,WAAW,EAAEC,OAAO,EAAE;EACxC,MAAMC,GAAG,GAAGF,WAAW,CAACG,EAAE,CAACD,GAAG;EAE9B,IAAI,CAACA,GAAG,EAAE;IACNF,WAAW,CAACG,EAAE,CAACC,SAAS,CAACC,GAAG,CACxB,MAAM,EACL,8EAA6E,CACjF;IACD,OAAO,IAAI;EACf;EAEA,OAAOH,GAAG,CAACI,UAAU,CAACL,OAAO,CAACM,UAAU,CAAC;AAC7C;AAEA,eAAeC,eAAeA,CAACR,WAAW,EAAEC,OAAO,EAAEQ,OAAO,EAAEC,SAAS,EAAE;EACrE,MAAMC,QAAQ,GAAG;IACbC,MAAM,EAAEZ,WAAW,CAACa,IAAI,CAACC,IAAI;IAC7BJ,SAAS;IACTK,KAAK,EAAEN,OAAO,CAACO,QAAQ;IACvBC,SAAS,EAAEpB,QAAQ,CAACqB,UAAU,CAACC,KAAK;EACxC,CAAC;EAED,IAAIT,SAAS,KAAK,QAAQ,EAAE;IACxBC,QAAQ,CAACS,IAAI,GAAGX,OAAO,CAACY,MAAM;EAClC,CAAC,MAAM;IACHV,QAAQ,CAACS,IAAI,GAAGX,OAAO,CAACa,QAAQ;EACpC;EAEA,IAAIrB,OAAO,CAACsB,QAAQ,EAAE;IAClB,MAAMC,IAAI,GAAGxB,WAAW,CAACyB,mBAAmB,CAAChB,OAAO,EAAER,OAAO,CAACsB,QAAQ,CAAC;IACvE,IAAI7B,CAAC,CAACgC,KAAK,CAACF,IAAI,CAAC,EAAE;MACf,MAAM,IAAI1B,gBAAgB,CACrB,wBAAuBG,OAAO,CAACsB,QAAS,2BAA0BvB,WAAW,CAACa,IAAI,CAACC,IAAK,gBAAeJ,SAAU,EAAC,CACtH;IACL;IAEAC,QAAQ,CAACgB,SAAS,GAAGH,IAAI;EAC7B;EAGA,IAAIf,OAAO,CAACmB,OAAO,CAACC,OAAO,EAAE;IACzB;EACJ;EAEA,MAAMC,WAAW,GAAG/B,YAAY,CAACC,WAAW,EAAEC,OAAO,CAAC;EACtD,MAAM6B,WAAW,CAACC,UAAU,CACxB9B,OAAO,CAAC+B,WAAW,EACnBrB,QAAQ,EACRF,OAAO,CAACwB,WAAW,CACtB;AACL;AAOAC,MAAM,CAACC,OAAO,GAAG;EACb,CAACvC,KAAK,CAACwC,iBAAiB,GAAG,CAACnC,OAAO,EAAED,WAAW,EAAES,OAAO,KACrDD,eAAe,CAACR,WAAW,EAAEC,OAAO,EAAEQ,OAAO,EAAE,QAAQ,CAAC;EAC5D,CAACb,KAAK,CAACyC,iBAAiB,GAAG,CAACpC,OAAO,EAAED,WAAW,EAAES,OAAO,KACrDD,eAAe,CAACR,WAAW,EAAEC,OAAO,EAAEQ,OAAO,EAAE,QAAQ,CAAC;EAC5D,CAACb,KAAK,CAAC0C,iBAAiB,GAAG,CAACrC,OAAO,EAAED,WAAW,EAAES,OAAO,KACrDD,eAAe,CAACR,WAAW,EAAEC,OAAO,EAAEQ,OAAO,EAAE,QAAQ;AAC/D,CAAC"}