{"version":3,"file":"stateTracking.js","names":["Rules","require","Generators","isPlainObject","module","exports","RULE_AFTER_VALIDATION","feature","entityModel","context","forEach","featureItem","field","latest","targetState","oorType","timestampFieldName","stateMapping","Error","meta","name","default","fields","i18n"],"sources":["../../src/entityFeatures/stateTracking.js"],"sourcesContent":["const Rules = require('../enum/Rules');\nconst Generators = require('../Generators');\nconst { isPlainObject } = require('@genx/july');\n\n/**\n * A rule specifies the change of state will be tracked automatically.\n * @module EntityFeatureRuntime_StateTracking\n */\n\nmodule.exports = {\n    [Rules.RULE_AFTER_VALIDATION]: (feature, entityModel, context) => {\n        feature.forEach((featureItem) => {\n            if (featureItem.field in context.latest) {\n                const targetState = context.latest[featureItem.field];\n\n                if (isPlainObject(targetState) && targetState.oorType) {\n                    return;\n                }\n\n                const timestampFieldName = featureItem.stateMapping[targetState];\n                if (!timestampFieldName) {\n                    throw new Error(\n                        `State \"${targetState}\" is not one of the pre-defined states of field \"${featureItem.field}\" of entity \"${entityModel.meta.name}\".`\n                    );\n                }\n\n                if (context.latest[timestampFieldName] == null) {\n                    context.latest[timestampFieldName] = Generators.default(\n                        entityModel.meta.fields[timestampFieldName],\n                        context.i18n\n                    );\n                }\n            }\n        });\n\n        return true;\n    },\n};\n"],"mappings":";;;AAAA,MAAMA,KAAK,GAAGC,OAAO,CAAC,eAAe,CAAC;AACtC,MAAMC,UAAU,GAAGD,OAAO,CAAC,eAAe,CAAC;AAC3C,MAAM;EAAEE;AAAc,CAAC,GAAGF,OAAO,CAAC,YAAY,CAAC;AAO/CG,MAAM,CAACC,OAAO,GAAG;EACb,CAACL,KAAK,CAACM,qBAAqB,GAAG,CAACC,OAAO,EAAEC,WAAW,EAAEC,OAAO,KAAK;IAC9DF,OAAO,CAACG,OAAO,CAAEC,WAAW,IAAK;MAC7B,IAAIA,WAAW,CAACC,KAAK,IAAIH,OAAO,CAACI,MAAM,EAAE;QACrC,MAAMC,WAAW,GAAGL,OAAO,CAACI,MAAM,CAACF,WAAW,CAACC,KAAK,CAAC;QAErD,IAAIT,aAAa,CAACW,WAAW,CAAC,IAAIA,WAAW,CAACC,OAAO,EAAE;UACnD;QACJ;QAEA,MAAMC,kBAAkB,GAAGL,WAAW,CAACM,YAAY,CAACH,WAAW,CAAC;QAChE,IAAI,CAACE,kBAAkB,EAAE;UACrB,MAAM,IAAIE,KAAK,CACV,UAASJ,WAAY,oDAAmDH,WAAW,CAACC,KAAM,gBAAeJ,WAAW,CAACW,IAAI,CAACC,IAAK,IAAG,CACtI;QACL;QAEA,IAAIX,OAAO,CAACI,MAAM,CAACG,kBAAkB,CAAC,IAAI,IAAI,EAAE;UAC5CP,OAAO,CAACI,MAAM,CAACG,kBAAkB,CAAC,GAAGd,UAAU,CAACmB,OAAO,CACnDb,WAAW,CAACW,IAAI,CAACG,MAAM,CAACN,kBAAkB,CAAC,EAC3CP,OAAO,CAACc,IAAI,CACf;QACL;MACJ;IACJ,CAAC,CAAC;IAEF,OAAO,IAAI;EACf;AACJ,CAAC"}