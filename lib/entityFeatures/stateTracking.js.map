{"version":3,"sources":["../../src/entityFeatures/stateTracking.js"],"names":["Rules","require","Generators","isPlainObject","module","exports","RULE_AFTER_VALIDATION","feature","entityModel","context","forEach","featureItem","field","latest","targetState","oorType","timestampFieldName","stateMapping","Error","meta","name","default","fields","i18n"],"mappings":";;;;AAAA,MAAMA,KAAK,GAAGC,OAAO,CAAC,eAAD,CAArB;;AACA,MAAMC,UAAU,GAAGD,OAAO,CAAC,eAAD,CAA1B;;AACA,MAAM;AAAEE,EAAAA;AAAF,IAAoBF,OAAO,CAAC,YAAD,CAAjC;;AAOAG,MAAM,CAACC,OAAP,GAAiB;AACb,GAACL,KAAK,CAACM,qBAAP,GAA+B,CAACC,OAAD,EAAUC,WAAV,EAAuBC,OAAvB,KAAmC;AAC9DF,IAAAA,OAAO,CAACG,OAAR,CAAiBC,WAAD,IAAiB;AAC7B,UAAIA,WAAW,CAACC,KAAZ,IAAqBH,OAAO,CAACI,MAAjC,EAAyC;AACrC,cAAMC,WAAW,GAAGL,OAAO,CAACI,MAAR,CAAeF,WAAW,CAACC,KAA3B,CAApB;;AAEA,YAAIT,aAAa,CAACW,WAAD,CAAb,IAA8BA,WAAW,CAACC,OAA9C,EAAuD;AACnD;AACH;;AAED,cAAMC,kBAAkB,GAAGL,WAAW,CAACM,YAAZ,CAAyBH,WAAzB,CAA3B;;AACA,YAAI,CAACE,kBAAL,EAAyB;AACrB,gBAAM,IAAIE,KAAJ,CACD,UAASJ,WAAY,oDAAmDH,WAAW,CAACC,KAAM,gBAAeJ,WAAW,CAACW,IAAZ,CAAiBC,IAAK,IAD9H,CAAN;AAGH;;AAED,YAAIX,OAAO,CAACI,MAAR,CAAeG,kBAAf,KAAsC,IAA1C,EAAgD;AAC5CP,UAAAA,OAAO,CAACI,MAAR,CAAeG,kBAAf,IAAqCd,UAAU,CAACmB,OAAX,CACjCb,WAAW,CAACW,IAAZ,CAAiBG,MAAjB,CAAwBN,kBAAxB,CADiC,EAEjCP,OAAO,CAACc,IAFyB,CAArC;AAIH;AACJ;AACJ,KAtBD;AAwBA,WAAO,IAAP;AACH;AA3BY,CAAjB","sourcesContent":["const Rules = require('../enum/Rules');\nconst Generators = require('../Generators');\nconst { isPlainObject } = require('@genx/july');\n\n/**\n * A rule specifies the change of state will be tracked automatically.\n * @module EntityFeatureRuntime_StateTracking\n */\n\nmodule.exports = {\n    [Rules.RULE_AFTER_VALIDATION]: (feature, entityModel, context) => {\n        feature.forEach((featureItem) => {\n            if (featureItem.field in context.latest) {\n                const targetState = context.latest[featureItem.field];\n\n                if (isPlainObject(targetState) && targetState.oorType) {\n                    return;\n                }\n\n                const timestampFieldName = featureItem.stateMapping[targetState];\n                if (!timestampFieldName) {\n                    throw new Error(\n                        `State \"${targetState}\" is not one of the pre-defined states of field \"${featureItem.field}\" of entity \"${entityModel.meta.name}\".`\n                    );\n                }\n\n                if (context.latest[timestampFieldName] == null) {\n                    context.latest[timestampFieldName] = Generators.default(\n                        entityModel.meta.fields[timestampFieldName],\n                        context.i18n\n                    );\n                }\n            }\n        });\n\n        return true;\n    },\n};\n"],"file":"stateTracking.js"}