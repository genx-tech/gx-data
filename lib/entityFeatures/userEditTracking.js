"use strict";

require("source-map-support/register");

const Rules = require('../enum/Rules');

const {
  InvalidArgument
} = require('../utils/Errors');

function addCreatedBy_(entityModel, feature, context) {
  if (context.options.$migration) {
    context.latest[feature.fields.createdBy] = feature.migrationUser;
    return true;
  }

  let uid = entityModel.getValueFromContext(context, feature.uidSource);

  if (uid == null) {
    throw new InvalidArgument(`Context "${feature.uidSource}" not found. Entity: ${entityModel.meta.name}`);
  }

  context.latest[feature.fields.createdBy] = uid;
  return true;
}

function addUpdatedBy_(entityModel, feature, context) {
  let uid = entityModel.getValueFromContext(context, feature.uidSource);

  if (uid == null) {
    throw new InvalidArgument(`Context "${feature.uidSource}" not found.`);
  }

  context.latest[feature.fields.updatedBy] = uid;
  return true;
}

module.exports = {
  [Rules.RULE_BEFORE_CREATE]: (feature, entityModel, context) => addCreatedBy_(entityModel, feature, context),
  [Rules.RULE_BEFORE_UPDATE]: (feature, entityModel, context) => addUpdatedBy_(entityModel, feature, context)
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9lbnRpdHlGZWF0dXJlcy91c2VyRWRpdFRyYWNraW5nLmpzIl0sIm5hbWVzIjpbIlJ1bGVzIiwicmVxdWlyZSIsIkludmFsaWRBcmd1bWVudCIsImFkZENyZWF0ZWRCeV8iLCJlbnRpdHlNb2RlbCIsImZlYXR1cmUiLCJjb250ZXh0Iiwib3B0aW9ucyIsIiRtaWdyYXRpb24iLCJsYXRlc3QiLCJmaWVsZHMiLCJjcmVhdGVkQnkiLCJtaWdyYXRpb25Vc2VyIiwidWlkIiwiZ2V0VmFsdWVGcm9tQ29udGV4dCIsInVpZFNvdXJjZSIsIm1ldGEiLCJuYW1lIiwiYWRkVXBkYXRlZEJ5XyIsInVwZGF0ZWRCeSIsIm1vZHVsZSIsImV4cG9ydHMiLCJSVUxFX0JFRk9SRV9DUkVBVEUiLCJSVUxFX0JFRk9SRV9VUERBVEUiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTUEsS0FBSyxHQUFHQyxPQUFPLENBQUMsZUFBRCxDQUFyQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBO0FBQUYsSUFBc0JELE9BQU8sQ0FBQyxpQkFBRCxDQUFuQzs7QUFFQSxTQUFTRSxhQUFULENBQXVCQyxXQUF2QixFQUFvQ0MsT0FBcEMsRUFBNkNDLE9BQTdDLEVBQXNEO0FBQ2xELE1BQUlBLE9BQU8sQ0FBQ0MsT0FBUixDQUFnQkMsVUFBcEIsRUFBZ0M7QUFDNUJGLElBQUFBLE9BQU8sQ0FBQ0csTUFBUixDQUFlSixPQUFPLENBQUNLLE1BQVIsQ0FBZUMsU0FBOUIsSUFBMkNOLE9BQU8sQ0FBQ08sYUFBbkQ7QUFDQSxXQUFPLElBQVA7QUFDSDs7QUFFRCxNQUFJQyxHQUFHLEdBQUdULFdBQVcsQ0FBQ1UsbUJBQVosQ0FBZ0NSLE9BQWhDLEVBQXlDRCxPQUFPLENBQUNVLFNBQWpELENBQVY7O0FBQ0EsTUFBSUYsR0FBRyxJQUFJLElBQVgsRUFBaUI7QUFDYixVQUFNLElBQUlYLGVBQUosQ0FBcUIsWUFBV0csT0FBTyxDQUFDVSxTQUFVLHdCQUF1QlgsV0FBVyxDQUFDWSxJQUFaLENBQWlCQyxJQUFLLEVBQS9GLENBQU47QUFDSDs7QUFDRFgsRUFBQUEsT0FBTyxDQUFDRyxNQUFSLENBQWVKLE9BQU8sQ0FBQ0ssTUFBUixDQUFlQyxTQUE5QixJQUEyQ0UsR0FBM0M7QUFDQSxTQUFPLElBQVA7QUFDSDs7QUFFRCxTQUFTSyxhQUFULENBQXVCZCxXQUF2QixFQUFvQ0MsT0FBcEMsRUFBNkNDLE9BQTdDLEVBQXNEO0FBQ2xELE1BQUlPLEdBQUcsR0FBR1QsV0FBVyxDQUFDVSxtQkFBWixDQUFnQ1IsT0FBaEMsRUFBeUNELE9BQU8sQ0FBQ1UsU0FBakQsQ0FBVjs7QUFDQSxNQUFJRixHQUFHLElBQUksSUFBWCxFQUFpQjtBQUNiLFVBQU0sSUFBSVgsZUFBSixDQUFxQixZQUFXRyxPQUFPLENBQUNVLFNBQVUsY0FBbEQsQ0FBTjtBQUNIOztBQUNEVCxFQUFBQSxPQUFPLENBQUNHLE1BQVIsQ0FBZUosT0FBTyxDQUFDSyxNQUFSLENBQWVTLFNBQTlCLElBQTJDTixHQUEzQztBQUNBLFNBQU8sSUFBUDtBQUNIOztBQU9ETyxNQUFNLENBQUNDLE9BQVAsR0FBaUI7QUFDYixHQUFDckIsS0FBSyxDQUFDc0Isa0JBQVAsR0FBNEIsQ0FBQ2pCLE9BQUQsRUFBVUQsV0FBVixFQUF1QkUsT0FBdkIsS0FBbUNILGFBQWEsQ0FBQ0MsV0FBRCxFQUFjQyxPQUFkLEVBQXVCQyxPQUF2QixDQUQvRDtBQUViLEdBQUNOLEtBQUssQ0FBQ3VCLGtCQUFQLEdBQTRCLENBQUNsQixPQUFELEVBQVVELFdBQVYsRUFBdUJFLE9BQXZCLEtBQW1DWSxhQUFhLENBQUNkLFdBQUQsRUFBY0MsT0FBZCxFQUF1QkMsT0FBdkI7QUFGL0QsQ0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgUnVsZXMgPSByZXF1aXJlKCcuLi9lbnVtL1J1bGVzJyk7XG5jb25zdCB7IEludmFsaWRBcmd1bWVudCB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvRXJyb3JzJyk7XG5cbmZ1bmN0aW9uIGFkZENyZWF0ZWRCeV8oZW50aXR5TW9kZWwsIGZlYXR1cmUsIGNvbnRleHQpIHtcbiAgICBpZiAoY29udGV4dC5vcHRpb25zLiRtaWdyYXRpb24pIHtcbiAgICAgICAgY29udGV4dC5sYXRlc3RbZmVhdHVyZS5maWVsZHMuY3JlYXRlZEJ5XSA9IGZlYXR1cmUubWlncmF0aW9uVXNlcjtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgbGV0IHVpZCA9IGVudGl0eU1vZGVsLmdldFZhbHVlRnJvbUNvbnRleHQoY29udGV4dCwgZmVhdHVyZS51aWRTb3VyY2UpO1xuICAgIGlmICh1aWQgPT0gbnVsbCkge1xuICAgICAgICB0aHJvdyBuZXcgSW52YWxpZEFyZ3VtZW50KGBDb250ZXh0IFwiJHtmZWF0dXJlLnVpZFNvdXJjZX1cIiBub3QgZm91bmQuIEVudGl0eTogJHtlbnRpdHlNb2RlbC5tZXRhLm5hbWV9YClcbiAgICB9XG4gICAgY29udGV4dC5sYXRlc3RbZmVhdHVyZS5maWVsZHMuY3JlYXRlZEJ5XSA9IHVpZDtcbiAgICByZXR1cm4gdHJ1ZTtcbn1cblxuZnVuY3Rpb24gYWRkVXBkYXRlZEJ5XyhlbnRpdHlNb2RlbCwgZmVhdHVyZSwgY29udGV4dCkge1xuICAgIGxldCB1aWQgPSBlbnRpdHlNb2RlbC5nZXRWYWx1ZUZyb21Db250ZXh0KGNvbnRleHQsIGZlYXR1cmUudWlkU291cmNlKTtcbiAgICBpZiAodWlkID09IG51bGwpIHtcbiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRBcmd1bWVudChgQ29udGV4dCBcIiR7ZmVhdHVyZS51aWRTb3VyY2V9XCIgbm90IGZvdW5kLmApXG4gICAgfVxuICAgIGNvbnRleHQubGF0ZXN0W2ZlYXR1cmUuZmllbGRzLnVwZGF0ZWRCeV0gPSB1aWQ7ICAgIFxuICAgIHJldHVybiB0cnVlO1xufVxuXG4vKipcbiAqIEEgcnVsZSBzcGVjaWZpZXMgdGhlIGNoYW5nZSBvZiBzdGF0ZSB3aWxsIGJlIHRyYWNrZWQgYXV0b21hdGljYWxseS5cbiAqIEBtb2R1bGUgRW50aXR5RmVhdHVyZVJ1bnRpbWVfQ2hhbmdlTG9nXG4gKi9cblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gICAgW1J1bGVzLlJVTEVfQkVGT1JFX0NSRUFURV06IChmZWF0dXJlLCBlbnRpdHlNb2RlbCwgY29udGV4dCkgPT4gYWRkQ3JlYXRlZEJ5XyhlbnRpdHlNb2RlbCwgZmVhdHVyZSwgY29udGV4dCksXG4gICAgW1J1bGVzLlJVTEVfQkVGT1JFX1VQREFURV06IChmZWF0dXJlLCBlbnRpdHlNb2RlbCwgY29udGV4dCkgPT4gYWRkVXBkYXRlZEJ5XyhlbnRpdHlNb2RlbCwgZmVhdHVyZSwgY29udGV4dClcbn07Il19