{"version":3,"file":"index.js","names":["path","require","_","fs","basePath","resolve","__dirname","features","readdirSync","featureRules","forEach","file","f","join","statSync","isFile","endsWith","featureName","basename","feature","forOwn","action","ruleName","key","Error","module","exports","applyRules_","entityModel","context","meta","featureInfo","options","$features","customFeatureInfo","asExpected"],"sources":["../../src/entityFeatures/index.js"],"sourcesContent":["const path = require('path');\nconst { _ } = require('@genx/july');\nconst { fs } = require('@genx/sys');\n\nconst basePath = path.resolve(__dirname);\nconst features = fs.readdirSync(basePath);\n\nconst featureRules = {};\n\nfeatures.forEach((file) => {\n    const f = path.join(basePath, file);\n    if (fs.statSync(f).isFile() && _.endsWith(file, '.js')) {\n        const featureName = path.basename(file, '.js');\n        if (featureName === 'index') return;\n\n        const feature = require(f);\n\n        _.forOwn(feature, (action, ruleName) => {\n            const key = featureName + '.' + ruleName;\n\n            if (key in featureRules) {\n                throw new Error(`Duplicate feature rule: ${key}`);\n            }\n            featureRules[key] = action;\n        });\n    }\n});\n\nmodule.exports = {\n    applyRules_: async (ruleName, entityModel, context) => {\n        for (const featureName in entityModel.meta.features) {\n            const key = featureName + '.' + ruleName;\n            const action = featureRules[key];\n\n            if (action) {\n                let featureInfo = entityModel.meta.features[featureName];\n\n                if (\n                    context.options.$features &&\n                    featureName in context.options.$features\n                ) {\n                    const customFeatureInfo =\n                        context.options.$features[featureName];\n                    if (!customFeatureInfo) {\n                        continue;\n                    }\n\n                    featureInfo = { ...featureInfo, ...customFeatureInfo };\n                }\n\n                const asExpected = await action(\n                    featureInfo,\n                    entityModel,\n                    context\n                );\n                if (!asExpected) return false;\n            }\n        }\n\n        return true;\n    },\n};\n"],"mappings":";;;;AAAA,MAAMA,IAAI,GAAGC,OAAO,CAAC,MAAD,CAApB;;AACA,MAAM;EAAEC;AAAF,IAAQD,OAAO,CAAC,YAAD,CAArB;;AACA,MAAM;EAAEE;AAAF,IAASF,OAAO,CAAC,WAAD,CAAtB;;AAEA,MAAMG,QAAQ,GAAGJ,IAAI,CAACK,OAAL,CAAaC,SAAb,CAAjB;AACA,MAAMC,QAAQ,GAAGJ,EAAE,CAACK,WAAH,CAAeJ,QAAf,CAAjB;AAEA,MAAMK,YAAY,GAAG,EAArB;AAEAF,QAAQ,CAACG,OAAT,CAAkBC,IAAD,IAAU;EACvB,MAAMC,CAAC,GAAGZ,IAAI,CAACa,IAAL,CAAUT,QAAV,EAAoBO,IAApB,CAAV;;EACA,IAAIR,EAAE,CAACW,QAAH,CAAYF,CAAZ,EAAeG,MAAf,MAA2Bb,CAAC,CAACc,QAAF,CAAWL,IAAX,EAAiB,KAAjB,CAA/B,EAAwD;IACpD,MAAMM,WAAW,GAAGjB,IAAI,CAACkB,QAAL,CAAcP,IAAd,EAAoB,KAApB,CAApB;IACA,IAAIM,WAAW,KAAK,OAApB,EAA6B;;IAE7B,MAAME,OAAO,GAAGlB,OAAO,CAACW,CAAD,CAAvB;;IAEAV,CAAC,CAACkB,MAAF,CAASD,OAAT,EAAkB,CAACE,MAAD,EAASC,QAAT,KAAsB;MACpC,MAAMC,GAAG,GAAGN,WAAW,GAAG,GAAd,GAAoBK,QAAhC;;MAEA,IAAIC,GAAG,IAAId,YAAX,EAAyB;QACrB,MAAM,IAAIe,KAAJ,CAAW,2BAA0BD,GAAI,EAAzC,CAAN;MACH;;MACDd,YAAY,CAACc,GAAD,CAAZ,GAAoBF,MAApB;IACH,CAPD;EAQH;AACJ,CAjBD;AAmBAI,MAAM,CAACC,OAAP,GAAiB;EACbC,WAAW,EAAE,OAAOL,QAAP,EAAiBM,WAAjB,EAA8BC,OAA9B,KAA0C;IACnD,KAAK,MAAMZ,WAAX,IAA0BW,WAAW,CAACE,IAAZ,CAAiBvB,QAA3C,EAAqD;MACjD,MAAMgB,GAAG,GAAGN,WAAW,GAAG,GAAd,GAAoBK,QAAhC;MACA,MAAMD,MAAM,GAAGZ,YAAY,CAACc,GAAD,CAA3B;;MAEA,IAAIF,MAAJ,EAAY;QACR,IAAIU,WAAW,GAAGH,WAAW,CAACE,IAAZ,CAAiBvB,QAAjB,CAA0BU,WAA1B,CAAlB;;QAEA,IACIY,OAAO,CAACG,OAAR,CAAgBC,SAAhB,IACAhB,WAAW,IAAIY,OAAO,CAACG,OAAR,CAAgBC,SAFnC,EAGE;UACE,MAAMC,iBAAiB,GACnBL,OAAO,CAACG,OAAR,CAAgBC,SAAhB,CAA0BhB,WAA1B,CADJ;;UAEA,IAAI,CAACiB,iBAAL,EAAwB;YACpB;UACH;;UAEDH,WAAW,GAAG,EAAE,GAAGA,WAAL;YAAkB,GAAGG;UAArB,CAAd;QACH;;QAED,MAAMC,UAAU,GAAG,MAAMd,MAAM,CAC3BU,WAD2B,EAE3BH,WAF2B,EAG3BC,OAH2B,CAA/B;QAKA,IAAI,CAACM,UAAL,EAAiB,OAAO,KAAP;MACpB;IACJ;;IAED,OAAO,IAAP;EACH;AAhCY,CAAjB"}