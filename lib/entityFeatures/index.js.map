{"version":3,"sources":["../../src/entityFeatures/index.js"],"names":["path","require","_","fs","basePath","resolve","__dirname","features","readdirSync","featureRules","forEach","file","f","join","statSync","isFile","endsWith","featureName","basename","feature","forOwn","action","ruleName","key","Error","module","exports","applyRules_","entityModel","context","meta","featureInfo","options","$features","customFeatureInfo","asExpected"],"mappings":";;;;AAAA,MAAMA,IAAI,GAAGC,OAAO,CAAC,MAAD,CAApB;;AACA,MAAM;AAAEC,EAAAA;AAAF,IAAQD,OAAO,CAAC,YAAD,CAArB;;AACA,MAAM;AAAEE,EAAAA;AAAF,IAASF,OAAO,CAAC,WAAD,CAAtB;;AAEA,MAAMG,QAAQ,GAAGJ,IAAI,CAACK,OAAL,CAAaC,SAAb,CAAjB;AACA,MAAMC,QAAQ,GAAGJ,EAAE,CAACK,WAAH,CAAeJ,QAAf,CAAjB;AAEA,MAAMK,YAAY,GAAG,EAArB;AAEAF,QAAQ,CAACG,OAAT,CAAkBC,IAAD,IAAU;AACvB,QAAMC,CAAC,GAAGZ,IAAI,CAACa,IAAL,CAAUT,QAAV,EAAoBO,IAApB,CAAV;;AACA,MAAIR,EAAE,CAACW,QAAH,CAAYF,CAAZ,EAAeG,MAAf,MAA2Bb,CAAC,CAACc,QAAF,CAAWL,IAAX,EAAiB,KAAjB,CAA/B,EAAwD;AACpD,UAAMM,WAAW,GAAGjB,IAAI,CAACkB,QAAL,CAAcP,IAAd,EAAoB,KAApB,CAApB;AACA,QAAIM,WAAW,KAAK,OAApB,EAA6B;;AAE7B,UAAME,OAAO,GAAGlB,OAAO,CAACW,CAAD,CAAvB;;AAEAV,IAAAA,CAAC,CAACkB,MAAF,CAASD,OAAT,EAAkB,CAACE,MAAD,EAASC,QAAT,KAAsB;AACpC,YAAMC,GAAG,GAAGN,WAAW,GAAG,GAAd,GAAoBK,QAAhC;;AAEA,UAAIC,GAAG,IAAId,YAAX,EAAyB;AACrB,cAAM,IAAIe,KAAJ,CAAW,2BAA0BD,GAAI,EAAzC,CAAN;AACH;;AACDd,MAAAA,YAAY,CAACc,GAAD,CAAZ,GAAoBF,MAApB;AACH,KAPD;AAQH;AACJ,CAjBD;AAmBAI,MAAM,CAACC,OAAP,GAAiB;AACbC,EAAAA,WAAW,EAAE,OAAOL,QAAP,EAAiBM,WAAjB,EAA8BC,OAA9B,KAA0C;AACnD,SAAK,MAAMZ,WAAX,IAA0BW,WAAW,CAACE,IAAZ,CAAiBvB,QAA3C,EAAqD;AACjD,YAAMgB,GAAG,GAAGN,WAAW,GAAG,GAAd,GAAoBK,QAAhC;AACA,YAAMD,MAAM,GAAGZ,YAAY,CAACc,GAAD,CAA3B;;AAEA,UAAIF,MAAJ,EAAY;AACR,YAAIU,WAAW,GAAGH,WAAW,CAACE,IAAZ,CAAiBvB,QAAjB,CAA0BU,WAA1B,CAAlB;;AAEA,YACIY,OAAO,CAACG,OAAR,CAAgBC,SAAhB,IACAhB,WAAW,IAAIY,OAAO,CAACG,OAAR,CAAgBC,SAFnC,EAGE;AACE,gBAAMC,iBAAiB,GACnBL,OAAO,CAACG,OAAR,CAAgBC,SAAhB,CAA0BhB,WAA1B,CADJ;;AAEA,cAAI,CAACiB,iBAAL,EAAwB;AACpB;AACH;;AAEDH,UAAAA,WAAW,GAAG,EAAE,GAAGA,WAAL;AAAkB,eAAGG;AAArB,WAAd;AACH;;AAED,cAAMC,UAAU,GAAG,MAAMd,MAAM,CAC3BU,WAD2B,EAE3BH,WAF2B,EAG3BC,OAH2B,CAA/B;AAKA,YAAI,CAACM,UAAL,EAAiB,OAAO,KAAP;AACpB;AACJ;;AAED,WAAO,IAAP;AACH;AAhCY,CAAjB","sourcesContent":["const path = require('path');\nconst { _ } = require('@genx/july');\nconst { fs } = require('@genx/sys');\n\nconst basePath = path.resolve(__dirname);\nconst features = fs.readdirSync(basePath);\n\nconst featureRules = {};\n\nfeatures.forEach((file) => {\n    const f = path.join(basePath, file);\n    if (fs.statSync(f).isFile() && _.endsWith(file, '.js')) {\n        const featureName = path.basename(file, '.js');\n        if (featureName === 'index') return;\n\n        const feature = require(f);\n\n        _.forOwn(feature, (action, ruleName) => {\n            const key = featureName + '.' + ruleName;\n\n            if (key in featureRules) {\n                throw new Error(`Duplicate feature rule: ${key}`);\n            }\n            featureRules[key] = action;\n        });\n    }\n});\n\nmodule.exports = {\n    applyRules_: async (ruleName, entityModel, context) => {\n        for (const featureName in entityModel.meta.features) {\n            const key = featureName + '.' + ruleName;\n            const action = featureRules[key];\n\n            if (action) {\n                let featureInfo = entityModel.meta.features[featureName];\n\n                if (\n                    context.options.$features &&\n                    featureName in context.options.$features\n                ) {\n                    const customFeatureInfo =\n                        context.options.$features[featureName];\n                    if (!customFeatureInfo) {\n                        continue;\n                    }\n\n                    featureInfo = { ...featureInfo, ...customFeatureInfo };\n                }\n\n                const asExpected = await action(\n                    featureInfo,\n                    entityModel,\n                    context\n                );\n                if (!asExpected) return false;\n            }\n        }\n\n        return true;\n    },\n};\n"],"file":"index.js"}