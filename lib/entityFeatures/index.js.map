{"version":3,"sources":["../../src/entityFeatures/index.js"],"names":["path","require","_","fs","basePath","resolve","__dirname","features","readdirSync","featureRules","forEach","file","f","join","statSync","isFile","endsWith","featureName","basename","feature","forOwn","action","ruleName","key","assert","module","exports","applyRules_","entityModel","context","meta","featureInfo","options","$features","hasOwnProperty","customFeatureInfo","asExpected"],"mappings":";;;;AAAA,MAAMA,IAAI,GAAGC,OAAO,CAAC,MAAD,CAApB;;AACA,MAAM;AAAEC,EAAAA;AAAF,IAAQD,OAAO,CAAC,YAAD,CAArB;;AACA,MAAM;AAAEE,EAAAA;AAAF,IAASF,OAAO,CAAC,WAAD,CAAtB;;AAEA,MAAMG,QAAQ,GAAGJ,IAAI,CAACK,OAAL,CAAaC,SAAb,CAAjB;AACA,MAAMC,QAAQ,GAAGJ,EAAE,CAACK,WAAH,CAAeJ,QAAf,CAAjB;AAEA,MAAMK,YAAY,GAAG,EAArB;AAEAF,QAAQ,CAACG,OAAT,CAAkBC,IAAD,IAAU;AACvB,MAAIC,CAAC,GAAGZ,IAAI,CAACa,IAAL,CAAUT,QAAV,EAAoBO,IAApB,CAAR;;AACA,MAAIR,EAAE,CAACW,QAAH,CAAYF,CAAZ,EAAeG,MAAf,MAA2Bb,CAAC,CAACc,QAAF,CAAWL,IAAX,EAAiB,KAAjB,CAA/B,EAAwD;AACpD,QAAIM,WAAW,GAAGjB,IAAI,CAACkB,QAAL,CAAcP,IAAd,EAAoB,KAApB,CAAlB;AACA,QAAIM,WAAW,KAAK,OAApB,EAA6B;;AAE7B,QAAIE,OAAO,GAAGlB,OAAO,CAACW,CAAD,CAArB;;AAEAV,IAAAA,CAAC,CAACkB,MAAF,CAASD,OAAT,EAAkB,CAACE,MAAD,EAASC,QAAT,KAAsB;AACpC,UAAIC,GAAG,GAAGN,WAAW,GAAG,GAAd,GAAoBK,QAA9B;;AAEAE,MAAAA,MAAM,EAAE,EAAED,GAAG,IAAId,YAAT,GAAwBc,GAAxB;;AACRd,MAAAA,YAAY,CAACc,GAAD,CAAZ,GAAoBF,MAApB;AACH,KALD;AAMH;AACJ,CAfD;AAiBAI,MAAM,CAACC,OAAP,GAAiB;AACbC,EAAAA,WAAW,EAAE,OAAOL,QAAP,EAAiBM,WAAjB,EAA8BC,OAA9B,KAA0C;AACnD,SAAK,IAAIZ,WAAT,IAAwBW,WAAW,CAACE,IAAZ,CAAiBvB,QAAzC,EAAmD;AAC/C,UAAIgB,GAAG,GAAGN,WAAW,GAAG,GAAd,GAAoBK,QAA9B;AACA,UAAID,MAAM,GAAGZ,YAAY,CAACc,GAAD,CAAzB;;AAEA,UAAIF,MAAJ,EAAY;AACR,YAAIU,WAAW,GAAGH,WAAW,CAACE,IAAZ,CAAiBvB,QAAjB,CAA0BU,WAA1B,CAAlB;;AAEA,YACIY,OAAO,CAACG,OAAR,CAAgBC,SAAhB,IACAJ,OAAO,CAACG,OAAR,CAAgBC,SAAhB,CAA0BC,cAA1B,CAAyCjB,WAAzC,CAFJ,EAGE;AACE,cAAIkB,iBAAiB,GACjBN,OAAO,CAACG,OAAR,CAAgBC,SAAhB,CAA0BhB,WAA1B,CADJ;;AAEA,cAAI,CAACkB,iBAAL,EAAwB;AACpB;AACH;;AAEDJ,UAAAA,WAAW,GAAG,EAAE,GAAGA,WAAL;AAAkB,eAAGI;AAArB,WAAd;AACH;;AAED,YAAIC,UAAU,GAAG,MAAMf,MAAM,CACzBU,WADyB,EAEzBH,WAFyB,EAGzBC,OAHyB,CAA7B;AAKA,YAAI,CAACO,UAAL,EAAiB,OAAO,KAAP;AACpB;AACJ;;AAED,WAAO,IAAP;AACH;AAhCY,CAAjB","sourcesContent":["const path = require('path');\nconst { _ } = require('@genx/july');\nconst { fs } = require('@genx/sys');\n\nconst basePath = path.resolve(__dirname);\nconst features = fs.readdirSync(basePath);\n\nconst featureRules = {};\n\nfeatures.forEach((file) => {\n    let f = path.join(basePath, file);\n    if (fs.statSync(f).isFile() && _.endsWith(file, '.js')) {\n        let featureName = path.basename(file, '.js');\n        if (featureName === 'index') return;\n\n        let feature = require(f);\n\n        _.forOwn(feature, (action, ruleName) => {\n            let key = featureName + '.' + ruleName;\n\n            assert: !(key in featureRules), key;\n            featureRules[key] = action;\n        });\n    }\n});\n\nmodule.exports = {\n    applyRules_: async (ruleName, entityModel, context) => {\n        for (let featureName in entityModel.meta.features) {\n            let key = featureName + '.' + ruleName;\n            let action = featureRules[key];\n\n            if (action) {\n                let featureInfo = entityModel.meta.features[featureName];\n\n                if (\n                    context.options.$features &&\n                    context.options.$features.hasOwnProperty(featureName)\n                ) {\n                    let customFeatureInfo =\n                        context.options.$features[featureName];\n                    if (!customFeatureInfo) {\n                        continue;\n                    }\n\n                    featureInfo = { ...featureInfo, ...customFeatureInfo };\n                }\n\n                let asExpected = await action(\n                    featureInfo,\n                    entityModel,\n                    context\n                );\n                if (!asExpected) return false;\n            }\n        }\n\n        return true;\n    },\n};\n"],"file":"index.js"}