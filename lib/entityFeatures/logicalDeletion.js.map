{"version":3,"sources":["../../src/entityFeatures/logicalDeletion.js"],"names":["Rules","require","mergeCondition","Generators","_","module","exports","RULE_BEFORE_FIND","feature","entityModel","context","findOptions","options","$includeDeleted","$query","field","$ne","value","RULE_BEFORE_DELETE","$physicalDeletion","timestampField","updateTo","default","meta","fields","i18n","updateOpts","$retrieveUpdated","$retrieveDeleted","$bypassReadOnly","Set","pick","return","_update_","connOptions","forSingleRecord","$retrieveDbResult","rawOptions","$result"],"mappings":";;;;AAAA,MAAMA,KAAK,GAAGC,OAAO,CAAC,eAAD,CAArB;;AACA,MAAM;AAAEC,EAAAA;AAAF,IAAqBD,OAAO,CAAC,eAAD,CAAlC;;AACA,MAAME,UAAU,GAAGF,OAAO,CAAC,eAAD,CAA1B;;AACA,MAAM;AAAEG,EAAAA;AAAF,IAAQH,OAAO,CAAC,YAAD,CAArB;;AAOAI,MAAM,CAACC,OAAP,GAAiB;AACb,GAACN,KAAK,CAACO,gBAAP,GAA0B,CAACC,OAAD,EAAUC,WAAV,EAAuBC,OAAvB,KAAmC;AACzD,QAAIC,WAAW,GAAGD,OAAO,CAACE,OAA1B;;AACA,QAAI,CAACD,WAAW,CAACE,eAAjB,EAAkC;AAC9BF,MAAAA,WAAW,CAACG,MAAZ,GAAqBZ,cAAc,CAACS,WAAW,CAACG,MAAb,EAAqB;AACpD,SAACN,OAAO,CAACO,KAAT,GAAiB;AAAEC,UAAAA,GAAG,EAAER,OAAO,CAACS;AAAf;AADmC,OAArB,CAAnC;AAGH;;AAED,WAAO,IAAP;AACH,GAVY;AAWb,GAACjB,KAAK,CAACkB,kBAAP,GAA4B,OAAOV,OAAP,EAAgBC,WAAhB,EAA6BC,OAA7B,KAAyC;AACjE,QAAIE,OAAO,GAAGF,OAAO,CAACE,OAAtB;;AACA,QAAI,CAACA,OAAO,CAACO,iBAAb,EAAgC;AAC5B,UAAI;AAAEJ,QAAAA,KAAF;AAASE,QAAAA,KAAT;AAAgBG,QAAAA;AAAhB,UAAmCZ,OAAvC;AACA,UAAIa,QAAQ,GAAG;AACX,SAACN,KAAD,GAASE;AADE,OAAf;;AAIA,UAAIG,cAAJ,EAAoB;AAChBC,QAAAA,QAAQ,CAACD,cAAD,CAAR,GAA2BjB,UAAU,CAACmB,OAAX,CACvBb,WAAW,CAACc,IAAZ,CAAiBC,MAAjB,CAAwBJ,cAAxB,CADuB,EAEvBV,OAAO,CAACe,IAFe,CAA3B;AAIH;;AAED,YAAMC,UAAU,GAAG;AACfZ,QAAAA,MAAM,EAAEF,OAAO,CAACE,MADD;AAEfa,QAAAA,gBAAgB,EAAEf,OAAO,CAACgB,gBAFX;AAGfC,QAAAA,eAAe,EAAE,IAAIC,GAAJ,CAAQ,CAACf,KAAD,EAAQK,cAAR,CAAR,CAHF;AAIf,WAAGhB,CAAC,CAAC2B,IAAF,CAAOnB,OAAP,EAAgB,CAAC,kBAAD,EAAqB,mBAArB,CAAhB;AAJY,OAAnB;AAOAF,MAAAA,OAAO,CAACsB,MAAR,GAAiB,MAAMvB,WAAW,CAACwB,QAAZ,CACnBZ,QADmB,EAEnBK,UAFmB,EAGnBhB,OAAO,CAACwB,WAHW,EAInBxB,OAAO,CAACyB,eAJW,CAAvB;;AAOA,UAAIvB,OAAO,CAACwB,iBAAZ,EAA+B;AAC3B1B,QAAAA,OAAO,CAAC2B,UAAR,CAAmBC,OAAnB,GAA6BZ,UAAU,CAACY,OAAxC;AACH;;AAED,aAAO,KAAP;AACH;;AAED,WAAO,IAAP;AACH;AAhDY,CAAjB","sourcesContent":["const Rules = require('../enum/Rules');\nconst { mergeCondition } = require('../utils/lang');\nconst Generators = require('../Generators');\nconst { _ } = require('@genx/july');\n\n/**\n * A rule specifies the entity will not be deleted physically.\n * @module EntityFeatureRuntime_LogicalDeletion\n */\n\nmodule.exports = {\n    [Rules.RULE_BEFORE_FIND]: (feature, entityModel, context) => {\n        let findOptions = context.options;\n        if (!findOptions.$includeDeleted) {\n            findOptions.$query = mergeCondition(findOptions.$query, {\n                [feature.field]: { $ne: feature.value },\n            });\n        }\n\n        return true;\n    },\n    [Rules.RULE_BEFORE_DELETE]: async (feature, entityModel, context) => {\n        let options = context.options;\n        if (!options.$physicalDeletion) {\n            let { field, value, timestampField } = feature;\n            let updateTo = {\n                [field]: value,\n            };\n\n            if (timestampField) {\n                updateTo[timestampField] = Generators.default(\n                    entityModel.meta.fields[timestampField],\n                    context.i18n\n                );\n            }\n\n            const updateOpts = {\n                $query: options.$query,\n                $retrieveUpdated: options.$retrieveDeleted,\n                $bypassReadOnly: new Set([field, timestampField]),\n                ..._.pick(options, ['$retrieveDeleted', '$retrieveDbResult']),\n            };\n\n            context.return = await entityModel._update_(\n                updateTo,\n                updateOpts,\n                context.connOptions,\n                context.forSingleRecord\n            );\n\n            if (options.$retrieveDbResult) {\n                context.rawOptions.$result = updateOpts.$result;\n            }\n\n            return false;\n        }\n\n        return true;\n    },\n};\n"],"file":"logicalDeletion.js"}