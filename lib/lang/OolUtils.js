"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const pluralize = require('pluralize');

class Clonable {
  constructor() {
    this.linked = false;
  }

  clone() {
    if (!this.linked) {
      throw new Error('An element becomes clonable only after being linked.');
    }
  }

}

const deepClone = value => _.cloneDeepWith(value, el => el instanceof Clonable ? el.clone() : undefined);

const deepCloneField = (src, dest, field) => {
  if (field in src) dest[field] = deepClone(src[field]);
};

const isDotSeparateName = name => name.indexOf('.') > 0;

const extractDotSeparateName = name => name.split('.');

const extractReferenceBaseName = name => extractDotSeparateName(name).pop();

const prefixNaming = (prefix, name) => {
  let leftParts = _.kebabCase(prefix).split('-');

  let rightParts = _.kebabCase(extractReferenceBaseName(name)).split('-');

  let reservedLeft, reservedRight;

  if (leftParts.length > rightParts.length) {
    reservedLeft = leftParts.splice(0, leftParts.length - rightParts.length);
    reservedRight = [];
  } else {
    reservedLeft = [];
    reservedRight = rightParts.splice(leftParts.length, rightParts.length - leftParts.length);
  }

  const combine = () => _.camelCase(reservedLeft.concat(leftParts).concat(reservedRight).join('-'));

  if (_.isEqual(leftParts, rightParts)) {
    return combine();
  }

  while (leftParts.length > 0) {
    reservedLeft.push(leftParts.shift());
    reservedRight.unshift(rightParts.pop());

    if (_.isEqual(leftParts, rightParts)) {
      break;
    }
  }

  return combine();
};

const getReferenceNameIfItIs = obj => {
  if (_.isPlainObject(obj) && obj.oolType === 'ObjectReference') {
    return extractDotSeparateName(obj.name)[0];
  }

  return undefined;
};

exports.parseReferenceInDocument = (schema, doc, ref) => {
  let parts = ref.split('.');
  let parent;
  let l = parts.length;
  let entityNode, entity, field;

  for (let i = 0; i < l; i++) {
    let p = parts[i];

    if (!entityNode) {
      if (doc.entity === p) {
        entityNode = doc;
        continue;
      }

      throw new Error(`Reference by path "${ref}" not found in given document.`);
    }

    if (entityNode && p[0] === '$') {
      entity = schema.entities[entityNode.entity];
      let attr = entity.getEntityAttribute(p);

      if (attr instanceof Field) {
        field = attr;

        if (i !== l - 1) {
          throw new Error(`Reference by path "${ref}" not found in given document.`);
        }

        return {
          entityNode,
          entity,
          field
        };
      } else {
        parent = attr;
      }

      continue;
    }

    if (parent) {
      parent = parent[p];
    } else {
      if (i === l - 1) {
        entity = schema.entities[entityNode.entity];
        field = entity.getEntityAttribute(p);
        return {
          entityNode,
          entity,
          field
        };
      }

      entityNode = entityNode.subDocuments && entityNode.subDocuments[p];

      if (!entityNode) {
        throw new Error(`Reference by path "${ref}" not found in given document.`);
      }
    }
  }

  if (!field) {
    if (typeof parent !== 'string') {
      throw new Error(`Reference by path "${ref}" not found in given document.`);
    }

    if (!entity) {
      throw new Error(`Reference by path "${ref}" not found in given document.`);
    }

    field = entity.getEntityAttribute(parent);

    if (!(field instanceof Field)) {
      throw new Error(`Reference by path "${ref}" not found in given document.`);
    }
  }

  return {
    entityNode,
    entity,
    field
  };
};

exports.pluralize = name => {
  let parts = _.kebabCase(name).split('-');

  let last = pluralize(parts.pop().toLowerCase());
  parts.push(last);
  return _.camelCase(parts.join('-'));
};

exports.deepClone = deepClone;
exports.deepCloneField = deepCloneField;
exports.isDotSeparateName = isDotSeparateName;
exports.extractDotSeparateName = extractDotSeparateName;
exports.extractReferenceBaseName = extractReferenceBaseName;
exports.getReferenceNameIfItIs = getReferenceNameIfItIs;

exports.schemaNaming = name => _.camelCase(name);

exports.entityNaming = name => _.camelCase(name);

exports.fieldNaming = name => _.camelCase(name);

exports.prefixNaming = prefixNaming;

exports.generateDisplayName = name => _.startCase(name);

exports.formatFields = field => Array.isArray(field) ? field.join(', ') : field;

exports.Clonable = Clonable;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5nL09vbFV0aWxzLmpzIl0sIm5hbWVzIjpbIl8iLCJyZXF1aXJlIiwicGx1cmFsaXplIiwiQ2xvbmFibGUiLCJsaW5rZWQiLCJjbG9uZSIsImRlZXBDbG9uZSIsInZhbHVlIiwiY2xvbmVEZWVwV2l0aCIsImVsIiwidW5kZWZpbmVkIiwiZGVlcENsb25lRmllbGQiLCJzcmMiLCJkZXN0IiwiZmllbGQiLCJpc0RvdFNlcGFyYXRlTmFtZSIsIm5hbWUiLCJpbmRleE9mIiwiZXh0cmFjdERvdFNlcGFyYXRlTmFtZSIsInNwbGl0IiwiZXh0cmFjdFJlZmVyZW5jZUJhc2VOYW1lIiwicG9wIiwicHJlZml4TmFtaW5nIiwicHJlZml4IiwibGVmdFBhcnRzIiwia2ViYWJDYXNlIiwicmlnaHRQYXJ0cyIsInJlc2VydmVkTGVmdCIsInJlc2VydmVkUmlnaHQiLCJsZW5ndGgiLCJzcGxpY2UiLCJjb21iaW5lIiwiY2FtZWxDYXNlIiwiY29uY2F0Iiwiam9pbiIsImlzRXF1YWwiLCJwdXNoIiwic2hpZnQiLCJ1bnNoaWZ0IiwiZ2V0UmVmZXJlbmNlTmFtZUlmSXRJcyIsIm9iaiIsImlzUGxhaW5PYmplY3QiLCJvb2xUeXBlIiwiZXhwb3J0cyIsInBhcnNlUmVmZXJlbmNlSW5Eb2N1bWVudCIsInNjaGVtYSIsImRvYyIsInJlZiIsInBhcnRzIiwicGFyZW50IiwibCIsImVudGl0eU5vZGUiLCJlbnRpdHkiLCJpIiwicCIsIkVycm9yIiwiZW50aXRpZXMiLCJhdHRyIiwiZ2V0RW50aXR5QXR0cmlidXRlIiwiRmllbGQiLCJzdWJEb2N1bWVudHMiLCJsYXN0IiwidG9Mb3dlckNhc2UiLCJzY2hlbWFOYW1pbmciLCJlbnRpdHlOYW1pbmciLCJmaWVsZE5hbWluZyIsImdlbmVyYXRlRGlzcGxheU5hbWUiLCJzdGFydENhc2UiLCJmb3JtYXRGaWVsZHMiLCJBcnJheSIsImlzQXJyYXkiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTTtBQUFFQSxF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Q0E0QixPQUFPLENBQUN6QixzQkFBUixHQUFpQ0Esc0JBQWpDO0FBQ0F5QixPQUFPLENBQUN2Qix3QkFBUixHQUFtQ0Esd0JBQW5DO0FBQ0F1QixPQUFPLENBQUNKLHNCQUFSLEdBQWlDQSxzQkFBakM7O0FBQ0FJLE9BQU8sQ0FBQ29CLFlBQVIsR0FBdUIvQyxJQUFJLElBQUloQixDQUFDLENBQUNnQyxTQUFGLENBQVloQixJQUFaLENBQS9COztBQUNBMkIsT0FBTyxDQUFDcUIsWUFBUixHQUF1QmhELElBQUksSUFBSWhCLENBQUMsQ0FBQ2dDLFNBQUYsQ0FBWWhCLElBQVosQ0FBL0I7O0FBQ0EyQixPQUFPLENBQUNzQixXQUFSLEdBQXNCakQsSUFBSSxJQUFJaEIsQ0FBQyxDQUFDZ0MsU0FBRixDQUFZaEIsSUFBWixDQUE5Qjs7QUFDQTJCLE9BQU8sQ0FBQ3JCLFlBQVIsR0FBdUJBLFlBQXZCOztBQUNBcUIsT0FBTyxDQUFDdUIsbUJBQVIsR0FBOEJsRCxJQUFJLElBQUloQixDQUFDLENBQUNtRSxTQUFGLENBQVluRCxJQUFaLENBQXRDOztBQUNBMkIsT0FBTyxDQUFDeUIsWUFBUixHQUF1QnRELEtBQUssSUFBSXVELEtBQUssQ0FBQ0MsT0FBTixDQUFjeEQsS0FBZCxJQUF1QkEsS0FBSyxDQUFDb0IsSUFBTixDQUFXLElBQVgsQ0FBdkIsR0FBMENwQixLQUExRTs7QUFDQTZCLE9BQU8sQ0FBQ3hDLFFBQVIsR0FBbUJBLFFBQW5CIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IHsgXyB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHBsdXJhbGl6ZSA9IHJlcXVpcmUoJ3BsdXJhbGl6ZScpO1xuXG5jbGFzcyBDbG9uYWJsZSB7XG4gICAgbGlua2VkID0gZmFsc2U7XG5cbiAgICBjbG9uZSgpIHsgICAgICBcbiAgICAgICAgYXNzZXJ0OiB0aGlzLmxpbmtlZCwgJ0FuIGVsZW1lbnQgYmVjb21lcyBjbG9uYWJsZSBvbmx5IGFmdGVyIGJlaW5nIGxpbmtlZC4nO1xuICAgIH1cbn1cblxuY29uc3QgZGVlcENsb25lID0gKHZhbHVlKSA9PiBfLmNsb25lRGVlcFdpdGgodmFsdWUsIGVsID0+IChlbCBpbnN0YW5jZW9mIENsb25hYmxlKSA/IGVsLmNsb25lKCkgOiB1bmRlZmluZWQpO1xuXG5jb25zdCBkZWVwQ2xvbmVGaWVsZCA9IChzcmMsIGRlc3QsIGZpZWxkKSA9PiB7XG4gICAgaWYgKGZpZWxkIGluIHNyYykgZGVzdFtmaWVsZF0gPSBkZWVwQ2xvbmUoc3JjW2ZpZWxkXSk7XG59O1xuXG5jb25zdCBpc0RvdFNlcGFyYXRlTmFtZSA9IChuYW1lKSA9PiAobmFtZS5pbmRleE9mKCcuJykgPiAwKTtcblxuY29uc3QgZXh0cmFjdERvdFNlcGFyYXRlTmFtZSA9IChuYW1lKSA9PiBuYW1lLnNwbGl0KCcuJyk7XG5cbmNvbnN0IGV4dHJhY3RSZWZlcmVuY2VCYXNlTmFtZSA9IChuYW1lKSA9PiBleHRyYWN0RG90U2VwYXJhdGVOYW1lKG5hbWUpLnBvcCgpO1xuXG5jb25zdCBwcmVmaXhOYW1pbmcgPSAocHJlZml4LCBuYW1lKSA9PiB7XG4gICAgbGV0IGxlZnRQYXJ0cyA9IF8ua2ViYWJDYXNlKHByZWZpeCkuc3BsaXQoJy0nKTtcbiAgICBsZXQgcmlnaHRQYXJ0cyA9IF8ua2ViYWJDYXNlKGV4dHJhY3RSZWZlcmVuY2VCYXNlTmFtZShuYW1lKSkuc3BsaXQoJy0nKTtcbiAgICBcbiAgICBsZXQgcmVzZXJ2ZWRMZWZ0LCByZXNlcnZlZFJpZ2h0O1xuXG4gICAgaWYgKGxlZnRQYXJ0cy5sZW5ndGggPiByaWdodFBhcnRzLmxlbmd0aCkge1xuICAgICAgICByZXNlcnZlZExlZnQgPSBsZWZ0UGFydHMuc3BsaWNlKDAsIGxlZnRQYXJ0cy5sZW5ndGggLSByaWdodFBhcnRzLmxlbmd0aCk7XG4gICAgICAgIHJlc2VydmVkUmlnaHQgPSBbXTtcbiAgICB9IGVsc2Uge1xuICAgICAgICByZXNlcnZlZExlZnQgPSBbXTtcbiAgICAgICAgcmVzZXJ2ZWRSaWdodCA9IHJpZ2h0UGFydHMuc3BsaWNlKGxlZnRQYXJ0cy5sZW5ndGgsIHJpZ2h0UGFydHMubGVuZ3RoIC0gbGVmdFBhcnRzLmxlbmd0aCk7XG4gICAgfVxuXG4gICAgY29uc3QgY29tYmluZSA9ICgpID0+IF8uY2FtZWxDYXNlKHJlc2VydmVkTGVmdC5jb25jYXQobGVmdFBhcnRzKS5jb25jYXQocmVzZXJ2ZWRSaWdodCkuam9pbignLScpKTtcblxuICAgIGlmIChfLmlzRXF1YWwobGVmdFBhcnRzLCByaWdodFBhcnRzKSkge1xuICAgICAgICByZXR1cm4gY29tYmluZSgpO1xuICAgIH1cbiAgICBcbiAgICB3aGlsZSAobGVmdFBhcnRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgcmVzZXJ2ZWRMZWZ0LnB1c2gobGVmdFBhcnRzLnNoaWZ0KCkpO1xuICAgICAgICByZXNlcnZlZFJpZ2h0LnVuc2hpZnQocmlnaHRQYXJ0cy5wb3AoKSk7XG4gICAgICAgIGlmIChfLmlzRXF1YWwobGVmdFBhcnRzLCByaWdodFBhcnRzKSkge1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9IFxuXG4gICAgcmV0dXJuIGNvbWJpbmUoKTtcbn07XG5cbmNvbnN0IGdldFJlZmVyZW5jZU5hbWVJZkl0SXMgPSAob2JqKSA9PiB7XG4gICAgaWYgKF8uaXNQbGFpbk9iamVjdChvYmopICYmIG9iai5vb2xUeXBlID09PSAnT2JqZWN0UmVmZXJlbmNlJykge1xuICAgICAgICByZXR1cm4gZXh0cmFjdERvdFNlcGFyYXRlTmFtZShvYmoubmFtZSlbMF07XG4gICAgfVxuXG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbn07XG5cbmV4cG9ydHMucGFyc2VSZWZlcmVuY2VJbkRvY3VtZW50ID0gKHNjaGVtYSwgZG9jLCByZWYpID0+IHsgICAgXG4gICAgbGV0IHBhcnRzID0gcmVmLnNwbGl0KCcuJyk7XG4gICAgbGV0IHBhcmVudDtcbiAgICBsZXQgbCA9IHBhcnRzLmxlbmd0aDtcbiAgICBsZXQgZW50aXR5Tm9kZSwgZW50aXR5LCBmaWVsZDtcbiAgICBcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGw7IGkrKykge1xuICAgICAgICBsZXQgcCA9IHBhcnRzW2ldO1xuICAgICAgICBcbiAgICAgICAgaWYgKCFlbnRpdHlOb2RlKSB7XG4gICAgICAgICAgICBpZiAoZG9jLmVudGl0eSA9PT0gcCkge1xuICAgICAgICAgICAgICAgIGVudGl0eU5vZGUgPSBkb2M7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgUmVmZXJlbmNlIGJ5IHBhdGggXCIke3JlZn1cIiBub3QgZm91bmQgaW4gZ2l2ZW4gZG9jdW1lbnQuYCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZW50aXR5Tm9kZSAmJiBwWzBdID09PSAnJCcpIHtcbiAgICAgICAgICAgIGVudGl0eSA9IHNjaGVtYS5lbnRpdGllc1tlbnRpdHlOb2RlLmVudGl0eV07XG4gICAgICAgICAgICBsZXQgYXR0ciA9IGVudGl0eS5nZXRFbnRpdHlBdHRyaWJ1dGUocCk7XG5cbiAgICAgICAgICAgIGlmIChhdHRyIGluc3RhbmNlb2YgRmllbGQpIHtcbiAgICAgICAgICAgICAgICBmaWVsZCA9IGF0dHI7XG4gICAgICAgICAgICAgICAgaWYgKGkgIT09IGwtMSkge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFJlZmVyZW5jZSBieSBwYXRoIFwiJHtyZWZ9XCIgbm90IGZvdW5kIGluIGdpdmVuIGRvY3VtZW50LmApO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIGVudGl0eU5vZGUsXG4gICAgICAgICAgICAgICAgICAgIGVudGl0eSxcbiAgICAgICAgICAgICAgICAgICAgZmllbGRcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBwYXJlbnQgPSBhdHRyO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgaWYgKHBhcmVudCkge1xuICAgICAgICAgICAgcGFyZW50ID0gcGFyZW50W3BdO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKGkgPT09IGwtMSkge1xuICAgICAgICAgICAgICAgIC8vbGFzdCBwYXJ0XG4gICAgICAgICAgICAgICAgZW50aXR5ID0gc2NoZW1hLmVudGl0aWVzW2VudGl0eU5vZGUuZW50aXR5XTtcbiAgICAgICAgICAgICAgICBmaWVsZCA9IGVudGl0eS5nZXRFbnRpdHlBdHRyaWJ1dGUocCk7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICBlbnRpdHlOb2RlLFxuICAgICAgICAgICAgICAgICAgICBlbnRpdHksXG4gICAgICAgICAgICAgICAgICAgIGZpZWxkXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZW50aXR5Tm9kZSA9IGVudGl0eU5vZGUuc3ViRG9jdW1lbnRzICYmIGVudGl0eU5vZGUuc3ViRG9jdW1lbnRzW3BdO1xuICAgICAgICAgICAgaWYgKCFlbnRpdHlOb2RlKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBSZWZlcmVuY2UgYnkgcGF0aCBcIiR7cmVmfVwiIG5vdCBmb3VuZCBpbiBnaXZlbiBkb2N1bWVudC5gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIGlmICghZmllbGQpIHtcbiAgICAgICAgaWYgKHR5cGVvZiBwYXJlbnQgIT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFJlZmVyZW5jZSBieSBwYXRoIFwiJHtyZWZ9XCIgbm90IGZvdW5kIGluIGdpdmVuIGRvY3VtZW50LmApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFlbnRpdHkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgUmVmZXJlbmNlIGJ5IHBhdGggXCIke3JlZn1cIiBub3QgZm91bmQgaW4gZ2l2ZW4gZG9jdW1lbnQuYCk7XG4gICAgICAgIH1cblxuICAgICAgICBmaWVsZCA9IGVudGl0eS5nZXRFbnRpdHlBdHRyaWJ1dGUocGFyZW50KTtcbiAgICAgICAgaWYgKCEoZmllbGQgaW5zdGFuY2VvZiBGaWVsZCkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgUmVmZXJlbmNlIGJ5IHBhdGggXCIke3JlZn1cIiBub3QgZm91bmQgaW4gZ2l2ZW4gZG9jdW1lbnQuYCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgcmV0dXJuIHtcbiAgICAgICAgZW50aXR5Tm9kZSxcbiAgICAgICAgZW50aXR5LFxuICAgICAgICBmaWVsZFxuICAgIH07XG59O1xuXG5leHBvcnRzLnBsdXJhbGl6ZSA9IChuYW1lKSA9PiB7XG4gICAgbGV0IHBhcnRzID0gXy5rZWJhYkNhc2UobmFtZSkuc3BsaXQoJy0nKTtcbiAgICBsZXQgbGFzdCA9IHBsdXJhbGl6ZShwYXJ0cy5wb3AoKS50b0xvd2VyQ2FzZSgpKTtcbiAgICBwYXJ0cy5wdXNoKGxhc3QpO1xuICAgIHJldHVybiBfLmNhbWVsQ2FzZShwYXJ0cy5qb2luKCctJykpO1xufTtcblxuZXhwb3J0cy5kZWVwQ2xvbmUgPSBkZWVwQ2xvbmU7XG5leHBvcnRzLmRlZXBDbG9uZUZpZWxkID0gZGVlcENsb25lRmllbGQ7XG5leHBvcnRzLmlzRG90U2VwYXJhdGVOYW1lID0gaXNEb3RTZXBhcmF0ZU5hbWU7XG5leHBvcnRzLmV4dHJhY3REb3RTZXBhcmF0ZU5hbWUgPSBleHRyYWN0RG90U2VwYXJhdGVOYW1lO1xuZXhwb3J0cy5leHRyYWN0UmVmZXJlbmNlQmFzZU5hbWUgPSBleHRyYWN0UmVmZXJlbmNlQmFzZU5hbWU7XG5leHBvcnRzLmdldFJlZmVyZW5jZU5hbWVJZkl0SXMgPSBnZXRSZWZlcmVuY2VOYW1lSWZJdElzO1xuZXhwb3J0cy5zY2hlbWFOYW1pbmcgPSBuYW1lID0+IF8uY2FtZWxDYXNlKG5hbWUpO1xuZXhwb3J0cy5lbnRpdHlOYW1pbmcgPSBuYW1lID0+IF8uY2FtZWxDYXNlKG5hbWUpO1xuZXhwb3J0cy5maWVsZE5hbWluZyA9IG5hbWUgPT4gXy5jYW1lbENhc2UobmFtZSk7XG5leHBvcnRzLnByZWZpeE5hbWluZyA9IHByZWZpeE5hbWluZztcbmV4cG9ydHMuZ2VuZXJhdGVEaXNwbGF5TmFtZSA9IG5hbWUgPT4gXy5zdGFydENhc2UobmFtZSk7XG5leHBvcnRzLmZvcm1hdEZpZWxkcyA9IGZpZWxkID0+IEFycmF5LmlzQXJyYXkoZmllbGQpID8gZmllbGQuam9pbignLCAnKSA6IGZpZWxkO1xuZXhwb3J0cy5DbG9uYWJsZSA9IENsb25hYmxlOyJdfQ==