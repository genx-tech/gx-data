"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const {
  deepCloneField,
  Clonable,
  isDotSeparateName
} = require('./OolUtils');

class Dataset extends Clonable {
  constructor(linker, name, oolModule, info) {
    this.linker = linker;
    this.name = _.camelCase(name);
    this.oolModule = oolModule;
    this.info = info;
  }

  link() {
    if (!!this.linked) {
      throw new Error("Function  precondition failed: !this.linked");
    }

    if (this.info.entity) {
      let entity = this.linker.getReferencedEntity(this.oolModule, this.info.entity);
      this.mainEntity = entity.name;
    } else {
      let dataset = this.linker.loadDataset(this.oolModule, this.info.dataset);

      if (!dataset.linked) {
        throw new Error("Assertion failed: dataset.linked");
      }

      this.mainEntity = dataset.mainEntity;
      this.joinWith = _.cloneDeep(dataset.joinWith);
    }

    if (!_.isEmpty(this.info.joinWith)) {
      if (!this.joinWith) {
        this.joinWith = _.cloneDeep(this.info.joinWith);
      } else {
        this.joinWith = this.joinWith.concat(this.info.joinWith);
      }
    }

    this.linked = true;
    return this;
  }

  buildHierarchy(inSchema) {
    return this._flattenDataset(inSchema, this);
  }

  _flattenDataset(inSchema, dataset) {
    let hierarchy = {};
    let leftEntity = inSchema.entities[dataset.mainEntity];

    if (dataset.joinWith) {
      dataset.joinWith.forEach(joining => {
        let leftField, rightEntity, rightField;

        if (isDotSeparateName(joining.on.left)) {
          let lastPos = joining.on.left.lastIndexOf('.');
          let fieldRef = joining.on.left.substr(lastPos + 1);
          let entityRef = joining.on.left.substr(0, lastPos);

          if (entityRef === leftEntity.name) {
            leftField = leftEntity.getEntityAttribute(fieldRef);
          } else {
            throw new Error(`Unsupported syntax of left side joining field "${joining.on.left}".`);
          }
        } else {
          leftField = leftEntity.getEntityAttribute(joining.on.left);
        }

        if (joining.dataset) {
          let rightHierarchy = inSchema.getDocumentHierachy(this.oolModule, joining.dataset);

          if (isDotSeparateName(joining.on.right)) {
            let parts = joining.on.right.split('.');

            if (parts.length > 2) {
              throw new Error('Joining a document should only referencing to a field of its main entity.');
            }

            let [entityRef, fieldRef] = parts;

            if (entityRef !== rightHierarchy.entity) {
              throw new Error(`Referenced field "${joining.on.right}" not found while linking to document "${joining.dataset}".`);
            }

            if (!!hierarchy[leftField.name]) {
              throw new Error('Duplicate joinings on the same field of the left side entity.');
            }

            rightEntity = inSchema.entities[entityRef];
            rightField = rightEntity.getEntityAttribute(fieldRef);
            hierarchy[leftField.name] = Object.assign({}, rightHierarchy, {
              linkWithField: rightField.name
            });
            return;
          }

          rightEntity = inSchema.entities[joining.dataset.mainEntity];
        } else {
          rightEntity = inSchema.entities[joining.entity];

          if (isDotSeparateName(joining.on.right)) {
            throw new Error(`Referenced field "${joining.on.right}" not found while linking to entity "${joining.entity}".`);
          }
        }

        rightField = rightEntity.getEntityAttribute(joining.on.right);

        if (!!hierarchy[leftField.name]) {
          throw new Error('Duplicate joinings on the same field of the left side entity.');
        }

        hierarchy[leftField.name] = {
          oolType: 'DocumentHierarchyNode',
          entity: rightEntity.name,
          linkWithField: rightField.name
        };
      });
    }

    return {
      oolType: 'DocumentHierarchyNode',
      entity: leftEntity.name,
      subDocuments: hierarchy
    };
  }

  clone() {
    super.clone();
    let dataset = new Dataset(this.linker, this.name, this.oolModule, this.info);
    dataset.mainEntity = this.mainEntity;
    deepCloneField(this, dataset, 'joinWith');
    dataset.linked = true;
    return dataset;
  }

  toJSON() {
    return {
      name: this.name,
      mainEntity: this.mainEntity.toJSON(),
      joinWith: this.joinWith
    };
  }

}

module.exports = Dataset;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5nL0RhdGFzZXQuanMiXSwibmFtZXMiOlsiXyIsInJlcXVpcmUiLCJkZWVwQ2xvbmVGaWVsZCIsIkNsb25hYmxlIiwiaXNEb3RTZXBhcmF0ZU5hbWUiLCJEYXRhc2V0IiwiY29uc3RydWN0b3IiLCJsaW5rZXIiLCJuYW1lIiwib29sTW9kdWxlIiwiaW5mbyIsImNhbWVsQ2FzZSIsImxpbmsiLCJsaW5rZWQiLCJlbnRpdHkiLCJnZXRSZWZlcmVuY2VkRW50aXR5IiwibWFpbkVudGl0eSIsImRhdGFzZXQiLCJsb2FkRGF0YXNldCIsImpvaW5XaXRoIiwiY2xvbmVEZWVwIiwiaXNFbXB0eSIsImNvbmNhdCIsImJ1aWxkSGllcmFyY2h5IiwiaW5TY2hlbWEiLCJfZmxhdHRlbkRhdGFzZXQiLCJoaWVyYXJjaHkiLCJsZWZ0RW50aXR5IiwiZW50aXRpZXMiLCJmb3JFYWNoIiwiam9pbmluZyIsImxlZnRGaWVsZCIsInJpZ2h0RW50aXR5IiwicmlnaHRGaWVsZCIsIm9uIiwibGVmdCIsImxhc3RQb3MiLCJsYXN0SW5kZXhPZiIsImZpZWxkUmVmIiwic3Vic3RyIiwiZW50aXR5UmVmIiwiZ2V0RW50aXR5QXR0cmlidXRlIiwiRXJyb3IiLCJyaWdodEhpZXJhcmNoeSIsImdldERvY3VtZW50SGllcmFjaHkiLCJyaWdodCIsInBhcnRzIiwic3BsaXQiLCJsZW5ndGgiLCJPYmplY3QiLCJhc3NpZ24iLCJsaW5rV2l0aEZpZWxkIiwib29sVHlwZSIsInN1YkRvY3VtZW50cyIsImNsb25lIiwidG9KU09OIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNO0FBQUVBLEVBQUFBO0FBQUYsSUFBUUMsT0FBTyxDQUFDLFVBQUQsQ0FBckI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQSxjQUFGO0FBQWtCQyxFQUFBQSxRQUFsQjtBQUE0QkMsRUFBQUE7QUFBNUIsSUFBa0RILE9BQU8sQ0FBQyxZQUFELENBQS9EOztBQU1B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TSxFQUFFa0IsV0FBVyxDQUFDeEIsSUFGSTtBQUd4QjJDLFVBQUFBLGFBQWEsRUFBRWxCLFVBQVUsQ0FBQ3pCO0FBSEYsU0FBNUI7QUFLSCxPQW5FRDtBQW9FSDs7QUFFRCxXQUFPO0FBQ0g0QyxNQUFBQSxPQUFPLEVBQUUsdUJBRE47QUFFSHRDLE1BQUFBLE1BQU0sRUFBRWEsVUFBVSxDQUFDbkIsSUFGaEI7QUFHSDZDLE1BQUFBLFlBQVksRUFBRTNCO0FBSFgsS0FBUDtBQUtIOztBQU1ENEIsRUFBQUEsS0FBSyxHQUFHO0FBQ0osVUFBTUEsS0FBTjtBQUVBLFFBQUlyQyxPQUFPLEdBQUcsSUFBSVosT0FBSixDQUFZLEtBQUtFLE1BQWpCLEVBQXlCLEtBQUtDLElBQTlCLEVBQW9DLEtBQUtDLFNBQXpDLEVBQW9ELEtBQUtDLElBQXpELENBQWQ7QUFFQU8sSUFBQUEsT0FBTyxDQUFDRCxVQUFSLEdBQXFCLEtBQUtBLFVBQTFCO0FBQ0FkLElBQUFBLGNBQWMsQ0FBQyxJQUFELEVBQU9lLE9BQVAsRUFBZ0IsVUFBaEIsQ0FBZDtBQUVBQSxJQUFBQSxPQUFPLENBQUNKLE1BQVIsR0FBaUIsSUFBakI7QUFFQSxXQUFPSSxPQUFQO0FBQ0g7O0FBT0RzQyxFQUFBQSxNQUFNLEdBQUc7QUFDTCxXQUFPO0FBQ0gvQyxNQUFBQSxJQUFJLEVBQUUsS0FBS0EsSUFEUjtBQUVIUSxNQUFBQSxVQUFVLEVBQUUsS0FBS0EsVUFBTCxDQUFnQnVDLE1BQWhCLEVBRlQ7QUFHSHBDLE1BQUFBLFFBQVEsRUFBRSxLQUFLQTtBQUhaLEtBQVA7QUFLSDs7QUFsTDBCOztBQXFML0JxQyxNQUFNLENBQUNDLE9BQVAsR0FBaUJwRCxPQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCB7IF8gfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IGRlZXBDbG9uZUZpZWxkLCBDbG9uYWJsZSwgaXNEb3RTZXBhcmF0ZU5hbWUgfSA9IHJlcXVpcmUoJy4vT29sVXRpbHMnKTtcblxuLyoqXG4gKiBPb2xvbmcgZGF0YXNldCBjbGFzcy5cbiAqIEBjbGFzcyBPb2xvbmdEYXRhc2V0XG4gKi9cbmNsYXNzIERhdGFzZXQgZXh0ZW5kcyBDbG9uYWJsZSB7XG4gICAgLyoqICAgICBcbiAgICAgKiBAcGFyYW0ge09vbG9uZ0xpbmtlcn0gbGlua2VyXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBEYXRhc2V0IG5hbWVcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gb29sTW9kdWxlIC0gU291cmNlIG9vbCBtb2R1bGVcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gaW5mbyAtIERhdGFzZXQgaW5mb1xuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKGxpbmtlciwgbmFtZSwgb29sTW9kdWxlLCBpbmZvKSB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBMaW5rZXIgdG8gcHJvY2VzcyB0aGlzIGRvY3VtZW50XG4gICAgICAgICAqIEBtZW1iZXIge09vbG9uZ0xpbmtlcn1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMubGlua2VyID0gbGlua2VyO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBOYW1lIG9mIHRoaXMgZG9jdW1lbnRcbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5uYW1lID0gXy5jYW1lbENhc2UobmFtZSk7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIE93bmVyIG9vbG9uZyBtb2R1bGVcbiAgICAgICAgICogQG1lbWJlciB7b2JqZWN0fVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5vb2xNb2R1bGUgPSBvb2xNb2R1bGU7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFJhdyBtZXRhZGF0YVxuICAgICAgICAgKiBAbWVtYmVyIHtPYmplY3R9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmluZm8gPSBpbmZvO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN0YXJ0IGxpbmtpbmcgdGhpcyBkYXRhc2V0XG4gICAgICogQHJldHVybnMge09vbG9uZ0RhdGFzZXR9XG4gICAgICovXG4gICAgbGluaygpIHtcbiAgICAgICAgcHJlOiAhdGhpcy5saW5rZWQ7XG5cbiAgICAgICAgaWYgKHRoaXMuaW5mby5lbnRpdHkpIHtcbiAgICAgICAgICAgIGxldCBlbnRpdHkgPSB0aGlzLmxpbmtlci5nZXRSZWZlcmVuY2VkRW50aXR5KHRoaXMub29sTW9kdWxlLCB0aGlzLmluZm8uZW50aXR5KTtcbiAgICAgICAgICAgIHRoaXMubWFpbkVudGl0eSA9IGVudGl0eS5uYW1lO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbGV0IGRhdGFzZXQgPSB0aGlzLmxpbmtlci5sb2FkRGF0YXNldCh0aGlzLm9vbE1vZHVsZSwgdGhpcy5pbmZvLmRhdGFzZXQpO1xuICAgICAgICAgICAgYXNzZXJ0OiBkYXRhc2V0LmxpbmtlZDtcblxuICAgICAgICAgICAgdGhpcy5tYWluRW50aXR5ID0gZGF0YXNldC5tYWluRW50aXR5O1xuICAgICAgICAgICAgdGhpcy5qb2luV2l0aCA9IF8uY2xvbmVEZWVwKGRhdGFzZXQuam9pbldpdGgpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBpZiAoIV8uaXNFbXB0eSh0aGlzLmluZm8uam9pbldpdGgpKSB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuam9pbldpdGgpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmpvaW5XaXRoID0gXy5jbG9uZURlZXAodGhpcy5pbmZvLmpvaW5XaXRoKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5qb2luV2l0aCA9IHRoaXMuam9pbldpdGguY29uY2F0KHRoaXMuaW5mby5qb2luV2l0aCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmxpbmtlZCA9IHRydWU7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgYnVpbGRIaWVyYXJjaHkoaW5TY2hlbWEpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2ZsYXR0ZW5EYXRhc2V0KGluU2NoZW1hLCB0aGlzKTtcbiAgICB9XG5cbiAgICBfZmxhdHRlbkRhdGFzZXQoaW5TY2hlbWEsIGRhdGFzZXQpIHtcbiAgICAgICAgbGV0IGhpZXJhcmNoeSA9IHt9O1xuICAgICAgICBsZXQgbGVmdEVudGl0eSA9IGluU2NoZW1hLmVudGl0aWVzW2RhdGFzZXQubWFpbkVudGl0eV07XG5cbiAgICAgICAgaWYgKGRhdGFzZXQuam9pbldpdGgpIHtcbiAgICAgICAgICAgIGRhdGFzZXQuam9pbldpdGguZm9yRWFjaChqb2luaW5nID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgbGVmdEZpZWxkLCByaWdodEVudGl0eSwgcmlnaHRGaWVsZDtcblxuICAgICAgICAgICAgICAgIGlmIChpc0RvdFNlcGFyYXRlTmFtZShqb2luaW5nLm9uLmxlZnQpKSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBsYXN0UG9zID0gam9pbmluZy5vbi5sZWZ0Lmxhc3RJbmRleE9mKCcuJyk7XG4gICAgICAgICAgICAgICAgICAgIGxldCBmaWVsZFJlZiA9IGpvaW5pbmcub24ubGVmdC5zdWJzdHIobGFzdFBvcysxKTtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGVudGl0eVJlZiA9IGpvaW5pbmcub24ubGVmdC5zdWJzdHIoMCwgbGFzdFBvcyk7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGVudGl0eVJlZiA9PT0gbGVmdEVudGl0eS5uYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZWZ0RmllbGQgPSBsZWZ0RW50aXR5LmdldEVudGl0eUF0dHJpYnV0ZShmaWVsZFJlZik7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuc3VwcG9ydGVkIHN5bnRheCBvZiBsZWZ0IHNpZGUgam9pbmluZyBmaWVsZCBcIiR7am9pbmluZy5vbi5sZWZ0fVwiLmApO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAvL2ZpZWxkIG9mIGxlZnRFbnRpdHlcbiAgICAgICAgICAgICAgICAgICAgbGVmdEZpZWxkID0gbGVmdEVudGl0eS5nZXRFbnRpdHlBdHRyaWJ1dGUoam9pbmluZy5vbi5sZWZ0KTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoam9pbmluZy5kYXRhc2V0KSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCByaWdodEhpZXJhcmNoeSA9IGluU2NoZW1hLmdldERvY3VtZW50SGllcmFjaHkodGhpcy5vb2xNb2R1bGUsIGpvaW5pbmcuZGF0YXNldCk7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGlzRG90U2VwYXJhdGVOYW1lKGpvaW5pbmcub24ucmlnaHQpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgcGFydHMgPSBqb2luaW5nLm9uLnJpZ2h0LnNwbGl0KCcuJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFydHMubGVuZ3RoID4gMikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSm9pbmluZyBhIGRvY3VtZW50IHNob3VsZCBvbmx5IHJlZmVyZW5jaW5nIHRvIGEgZmllbGQgb2YgaXRzIG1haW4gZW50aXR5LicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgWyBlbnRpdHlSZWYsIGZpZWxkUmVmIF0gPSBwYXJ0cztcblxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVudGl0eVJlZiAhPT0gcmlnaHRIaWVyYXJjaHkuZW50aXR5KSB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFJlZmVyZW5jZWQgZmllbGQgXCIke2pvaW5pbmcub24ucmlnaHR9XCIgbm90IGZvdW5kIHdoaWxlIGxpbmtpbmcgdG8gZG9jdW1lbnQgXCIke2pvaW5pbmcuZGF0YXNldH1cIi5gKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXJ0OiAhaGllcmFyY2h5W2xlZnRGaWVsZC5uYW1lXSwgJ0R1cGxpY2F0ZSBqb2luaW5ncyBvbiB0aGUgc2FtZSBmaWVsZCBvZiB0aGUgbGVmdCBzaWRlIGVudGl0eS4nO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICByaWdodEVudGl0eSA9IGluU2NoZW1hLmVudGl0aWVzW2VudGl0eVJlZl07XG4gICAgICAgICAgICAgICAgICAgICAgICByaWdodEZpZWxkID0gcmlnaHRFbnRpdHkuZ2V0RW50aXR5QXR0cmlidXRlKGZpZWxkUmVmKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgaGllcmFyY2h5W2xlZnRGaWVsZC5uYW1lXSA9IE9iamVjdC5hc3NpZ24oe30sIHJpZ2h0SGllcmFyY2h5LCB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua1dpdGhGaWVsZDogcmlnaHRGaWVsZC5uYW1lXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgLy9qb2luaW5nLm9uLnJpZ2h0IGlzIGZpZWxkIG5hbWUgb2YgdGhlIG1haW4gZW50aXR5XG4gICAgICAgICAgICAgICAgICAgIHJpZ2h0RW50aXR5ID0gaW5TY2hlbWEuZW50aXRpZXNbam9pbmluZy5kYXRhc2V0Lm1haW5FbnRpdHldO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJpZ2h0RW50aXR5ID0gaW5TY2hlbWEuZW50aXRpZXNbam9pbmluZy5lbnRpdHldO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChpc0RvdFNlcGFyYXRlTmFtZShqb2luaW5nLm9uLnJpZ2h0KSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBSZWZlcmVuY2VkIGZpZWxkIFwiJHtqb2luaW5nLm9uLnJpZ2h0fVwiIG5vdCBmb3VuZCB3aGlsZSBsaW5raW5nIHRvIGVudGl0eSBcIiR7am9pbmluZy5lbnRpdHl9XCIuYCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAvL2ZpZWxkIG9mIHJpZ2h0RW50aXR5XG4gICAgICAgICAgICAgICAgcmlnaHRGaWVsZCA9IHJpZ2h0RW50aXR5LmdldEVudGl0eUF0dHJpYnV0ZShqb2luaW5nLm9uLnJpZ2h0KTtcblxuICAgICAgICAgICAgICAgIGFzc2VydDogIWhpZXJhcmNoeVtsZWZ0RmllbGQubmFtZV0sICdEdXBsaWNhdGUgam9pbmluZ3Mgb24gdGhlIHNhbWUgZmllbGQgb2YgdGhlIGxlZnQgc2lkZSBlbnRpdHkuJztcblxuICAgICAgICAgICAgICAgIGhpZXJhcmNoeVtsZWZ0RmllbGQubmFtZV0gPSB7XG4gICAgICAgICAgICAgICAgICAgIG9vbFR5cGU6ICdEb2N1bWVudEhpZXJhcmNoeU5vZGUnLFxuICAgICAgICAgICAgICAgICAgICBlbnRpdHk6IHJpZ2h0RW50aXR5Lm5hbWUsXG4gICAgICAgICAgICAgICAgICAgIGxpbmtXaXRoRmllbGQ6IHJpZ2h0RmllbGQubmFtZVxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBvb2xUeXBlOiAnRG9jdW1lbnRIaWVyYXJjaHlOb2RlJyxcbiAgICAgICAgICAgIGVudGl0eTogbGVmdEVudGl0eS5uYW1lLFxuICAgICAgICAgICAgc3ViRG9jdW1lbnRzOiBoaWVyYXJjaHlcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDbG9uZSB0aGUgZG9jdW1lbnRcbiAgICAgKiBAcmV0dXJucyB7T29sb25nRGF0YXNldH1cbiAgICAgKi9cbiAgICBjbG9uZSgpIHtcbiAgICAgICAgc3VwZXIuY2xvbmUoKTtcblxuICAgICAgICBsZXQgZGF0YXNldCA9IG5ldyBEYXRhc2V0KHRoaXMubGlua2VyLCB0aGlzLm5hbWUsIHRoaXMub29sTW9kdWxlLCB0aGlzLmluZm8pO1xuXG4gICAgICAgIGRhdGFzZXQubWFpbkVudGl0eSA9IHRoaXMubWFpbkVudGl0eTtcbiAgICAgICAgZGVlcENsb25lRmllbGQodGhpcywgZGF0YXNldCwgJ2pvaW5XaXRoJyk7XG5cbiAgICAgICAgZGF0YXNldC5saW5rZWQgPSB0cnVlO1xuXG4gICAgICAgIHJldHVybiBkYXRhc2V0O1xuICAgIH1cblxuXG4gICAgLyoqXG4gICAgICogVHJhbnNsYXRlIHRoZSBkb2N1bWVudCBpbnRvIGEgcGxhaW4gSlNPTiBvYmplY3RcbiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fVxuICAgICAqL1xuICAgIHRvSlNPTigpIHtcbiAgICAgICAgcmV0dXJuIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIG5hbWU6IHRoaXMubmFtZSxcbiAgICAgICAgICAgIG1haW5FbnRpdHk6IHRoaXMubWFpbkVudGl0eS50b0pTT04oKSxcbiAgICAgICAgICAgIGpvaW5XaXRoOiB0aGlzLmpvaW5XaXRoXG4gICAgICAgIH07XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IERhdGFzZXQ7Il19