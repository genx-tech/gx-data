"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  fs,
  glob
} = require('rk-utils');

const Oolong = require('./grammar/oolong');

const OolongParser = Oolong.parser;

const OolTypes = require('./OolTypes');

const Types = require('../runtime/types');

const Entity = require('./Entity');

const Schema = require('./Schema');

const View = require('./View');

const Dataset = require('./Dataset');

const ELEMENT_CLASS_MAP = {
  [OolTypes.Element.ENTITY]: Entity,
  [OolTypes.Element.VIEW]: View,
  [OolTypes.Element.DATASET]: Dataset
};
const OOLONG_SOURCE_EXT = '.ool';
const BUILTINS_PATH = path.resolve(__dirname, 'builtins');

class Linker {
  static getOolongFiles(sourceDir, useJsonSource, recursive) {
    let pattern = '*' + OOLONG_SOURCE_EXT;

    if (useJsonSource) {
      pattern += '.json';
    }

    if (recursive) {
      pattern = '**/' + pattern;
    }

    return glob.sync(path.join(sourceDir, pattern), {
      nodir: true
    });
  }

  constructor(context) {
    this.logger = context.logger;
    this.sourcePath = context.dslSourcePath;
    this.useJsonSource = context.useJsonSource || false;
    this.saveIntermediate = context.saveIntermediate || false;
    this.schemaDeployment = context.schemaDeployment;
    this.schemas = {};
    this._oolModules = {};
    this._elementsCache = {};
    this._mapOfReferenceToModuleId = new Map();
  }

  log(level, message, data) {
    if (!this.logger) return;

    if (data) {
      this.logger.log(level, message, data);
    } else {
      this.logger.log(level, message);
    }
  }

  isModuleLoaded(moduleId) {
    return moduleId in this._oolModules;
  }

  getModuleById(moduleId) {
    return this._oolModules[moduleId];
  }

  link(entryFileName) {
    let entryModule = this.loadModule(entryFileName);

    if (!entryModule) {
      throw new Error(`Cannot resolve file "${entryFileName}".`);
    }

    if (_.isEmpty(entryModule.schema)) {
      throw new Error('No schema defined in entry file.');
    }

    _.forOwn(entryModule.schema, (schemaInfo, schemaName) => {
      let deploymentSettings = this.schemaDeployment[schemaName];

      if (!deploymentSettings) {
        throw new Error(`"deploymentSettings" of schema [${schemaName}] not found.`);
      }

      let schema = new Schema(this, schemaName, entryModule, schemaInfo, deploymentSettings);
      schema.link();

      if (this.schemas.hasOwnProperty(schemaName)) {
        throw new Error(`Duplicate schema: "${schemaName}".`);
      }

      this.schemas[schemaName] = schema;

      if (this.saveIntermediate) {
        let jsFile = path.resolve(this.sourcePath, entryFileName + '-linked.json');
        fs.writeFileSync(jsFile, JSON.stringify(schema.toJSON(), null, 4));
      }
    });
  }

  loadModule(modulePath) {
    modulePath = path.resolve(this.sourcePath, modulePath);
    let id = this.getModuleIdByPath(modulePath);

    if (this.isModuleLoaded(id)) {
      return this.getModuleById(id);
    }

    if (!fs.existsSync(modulePath)) {
      return undefined;
    }

    let ool = this._compile(modulePath);

    return this._oolModules[id] = ool;
  }

  trackBackType(oolModule, info) {
    if (Types.Builtin.has(info.type)) {
      return info;
    }

    let baseInfo = this.loadElement(oolModule, OolTypes.Element.TYPE, info.type, true);

    if (!Types.Builtin.has(baseInfo.type)) {
      let uniqueId = this.getElementUniqueId(oolModule, OolTypes.Element.TYPE, value.name);
      let ownerModule = this.getModuleById(this._mapOfReferenceToModuleId.get(uniqueId));
      let rootTypeInfo = this.trackBackType(ownerModule, baseInfo);
      ownerModule.type[baseInfo.type] = rootTypeInfo;
      baseInfo = rootTypeInfo;
    }

    let derivedInfo = { ..._.cloneDeep(_.omit(baseInfo, ['modifiers'])),
      ..._.omit(info, ['type', 'modifiers'])
    };

    if (baseInfo.modifiers || info.modifiers) {
      derivedInfo.modifiers = [...(baseInfo.modifiers || []), ...(info.modifiers || [])];
    }

    if (!derivedInfo.subClass) {
      derivedInfo.subClass = [];
    }

    derivedInfo.subClass.push(info.type);
    return derivedInfo;
  }

  translateOolValue(oolModule, value) {
    if (_.isPlainObject(value)) {
      if (value.oolType === OolTypes.Lang.CONST_REF) {
        let refedValue = this.loadElement(oolModule, OolTypes.Element.CONST, value.name, true);
        let uniqueId = this.getElementUniqueId(oolModule, OolTypes.Element.CONST, value.name);
        let ownerModule = this.getModuleById(this._mapOfReferenceToModuleId.get(uniqueId));
        return this.translateOolValue(ownerModule, refedValue);
      } else if (value.oolType) {
        throw new Error(`todo: translateOolValue with type: ${value.oolType}`);
      }

      return _.mapValues(value, v => this.translateOolValue(oolModule, v));
    }

    if (Array.isArray(value)) {
      return value.map(v => this.translateOolValue(oolModule, v));
    }

    return value;
  }

  getModuleIdByPath(modulePath) {
    let isBuiltinEntity = _.startsWith(modulePath, BUILTINS_PATH);

    return isBuiltinEntity ? path.relative(BUILTINS_PATH, modulePath) : './' + path.relative(this.sourcePath, modulePath);
  }

  getElementUniqueId(refererModule, elementType, elementName) {
    return elementType + ':' + elementName + '<-' + refererModule.id;
  }

  loadEntity(refererModule, elementName, throwOnMissing = true) {
    let entity = this.loadElement(refererModule, OolTypes.Element.ENTITY, elementName, throwOnMissing);

    if (entity && _.isEmpty(entity.fields)) {
      throw new Error(`Entity "${elementName}" has no any fields defined.`);
    }

    return entity;
  }

  loadType(refererModule, elementName, throwOnMissing = true) {
    return this.loadElement(refererModule, OolTypes.Element.TYPE, elementName, throwOnMissing);
  }

  loadDataset(refererModule, elementName, throwOnMissing = true) {
    return this.loadElement(refererModule, OolTypes.Element.DATASET, elementName, throwOnMissing);
  }

  loadView(refererModule, elementName, throwOnMissing = true) {
    return this.loadElement(refererModule, OolTypes.Element.VIEW, elementName, throwOnMissing);
  }

  loadElement(refererModule, elementType, elementName, throwOnMissing) {
    let uniqueId = this.getElementUniqueId(refererModule, elementType, elementName);

    if (uniqueId in this._elementsCache) {
      return this._elementsCache[uniqueId];
    }

    let targetModule;

    if (elementType in refererModule && elementName in refererModule[elementType]) {
      targetModule = refererModule;
    } else {
      let index = _.findLastIndex(refererModule.namespace, modulePath => {
        targetModule = this.loadModule(modulePath);
        return targetModule && targetModule[elementType] && elementName in targetModule[elementType];
      });

      if (index === -1) {
        if (throwOnMissing) {
          throw new Error(`${elementType} "${elementName}" not found in imported namespaces. Referer: ${refererModule.id}`);
        }

        return undefined;
      }
    }

    let elementSelfId = elementType + ':' + elementName + '@' + targetModule.id;

    if (elementSelfId in this._elementsCache) {
      return this._elementsCache[uniqueId] = this._elementsCache[elementSelfId];
    }

    if (!!this._mapOfReferenceToModuleId.has(uniqueId)) {
      throw new Error(`${elementType} "${elementName}" in "${targetModule.id}" conflicts with ${elementType} in "${this._mapOfReferenceToModuleId.get(uniqueId)}"!`);
    }

    this._mapOfReferenceToModuleId.set(uniqueId, targetModule.id);

    let elementInfo = Object.freeze(targetModule[elementType][elementName]);
    let element;

    if (elementType in ELEMENT_CLASS_MAP) {
      let ElementClass = ELEMENT_CLASS_MAP[elementType];
      element = new ElementClass(this, elementName, targetModule, elementInfo);
      element.link();
    } else {
      element = elementInfo;
    }

    this._elementsCache[elementSelfId] = element;
    this._elementsCache[uniqueId] = element;
    return element;
  }

  _compile(oolFile) {
    let jsFile;

    if (oolFile.endsWith('.json')) {
      jsFile = oolFile;
      oolFile = oolFile.substr(0, oolFile.length - 5);
    } else {
      jsFile = oolFile + '.json';
    }

    let ool, searchExt;

    if (this.useJsonSource) {
      if (!fs.existsSync(jsFile)) {
        throw new Error(`"useJsonSource" enabeld but json file "${jsFile}" not found.`);
      }

      ool = fs.readJsonSync(jsFile);
      searchExt = OOLONG_SOURCE_EXT + '.json';
    } else {
      try {
        ool = OolongParser.parse(fs.readFileSync(oolFile, 'utf8'));
      } catch (error) {
        throw new Error(`Failed to compile "${oolFile}".\n${error.message || error}`);
      }

      if (!ool) {
        throw new Error('Unknown error occurred while compiling.');
      }

      searchExt = OOLONG_SOURCE_EXT;
    }

    let baseName = path.basename(oolFile, OOLONG_SOURCE_EXT);
    let namespace = [];
    let currentPath = path.dirname(oolFile);

    function expandNs(namespaces, ns, recursive) {
      let stats = fs.statSync(ns);

      if (stats.isFile() && ns.endsWith(searchExt)) {
        namespaces.push(ns);
        return;
      }

      if (stats.isDirectory() && recursive) {
        let files = fs.readdirSync(ns);
        files.forEach(f => expandNs(namespaces, path.join(ns, f), true));
      }
    }

    if (ool.namespace) {
      ool.namespace.forEach(ns => {
        let p;

        if (ns.startsWith('<oolong>/')) {
          ns = path.join(BUILTINS_PATH, ns.substr(9));
        } else if (ns.startsWith('<source>/')) {
          ns = path.join(this.sourcePath, ns.substr(9));
        }

        if (ns.endsWith('/*')) {
          p = path.resolve(currentPath, ns.substr(0, ns.length - 2));
          let files = fs.readdirSync(p);
          files.forEach(f => expandNs(namespace, path.join(p, f), false));
        } else if (ns.endsWith('/**')) {
          p = path.resolve(currentPath, ns.substr(0, ns.length - 3));
          let files = fs.readdirSync(p);
          files.forEach(f => expandNs(namespace, path.join(p, f), true));
        } else {
          namespace.push(path.resolve(currentPath, _.endsWith(ns, OOLONG_SOURCE_EXT) ? ns : ns + OOLONG_SOURCE_EXT));
        }
      });
    }

    ool.namespace = namespace;
    ool.id = this.getModuleIdByPath(oolFile);
    ool.name = baseName;

    if (!this.useJsonSource && this.saveIntermediate) {
      fs.writeFileSync(jsFile, JSON.stringify(ool, null, 4));
    }

    return ool;
  }

}

module.exports = Linker;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5nL0xpbmtlci5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJmcyIsImdsb2IiLCJPb2xvbmciLCJPb2xvbmdQYXJzZXIiLCJwYXJzZXIiLCJPb2xUeXBlcyIsIlR5cGVzIiwiRW50aXR5IiwiU2NoZW1hIiwiVmlldyIsIkRhdGFzZXQiLCJFTEVNRU5UX0NMQVNTX01BUCIsIkVsZW1lbnQiLCJFTlRJVFkiLCJWSUVXIiwiREFUQVNFVCIsIk9PTE9OR19TT1VSQ0VfRVhUIiwiQlVJTFRJTlNfUEFUSCIsInJlc29sdmUiLCJfX2Rpcm5hbWUiLCJMaW5rZXIiLCJnZXRPb2xvbmdGaWxlcyIsInNvdXJjZURpciIsInVzZUpzb25Tb3VyY2UiLCJyZWN1cnNpdmUiLCJwYXR0ZXJuIiwic3luYyIsImpvaW4iLCJub2RpciIsImNvbnN0cnVjdG9yIiwiY29udGV4dCIsImxvZ2dlciIsInNvdXJjZVBhdGgiLCJkc2xTb3VyY2VQYXRoIiwic2F2ZUludGVybWVkaWF0ZSIsInNjaGVtYURlcGxveW1lbnQiLCJzY2hlbWFzIiwiX29vbE1vZHVsZXMiLCJfZWxlbWVudHNDYWNoZSIsIl9tYXBPZlJlZmVyZW5jZVRvTW9kdWxlSWQiLCJNYXAiLCJsb2ciLCJsZXZlbCIsIm1lc3NhZ2UiLCJkYXRhIiwiaXNNb2R1bGVMb2FkZWQiLCJtb2R1bGVJZCIsImdldE1vZHVsZUJ5SWQiLCJsaW5rIiwiZW50cnlGaWxlTmFtZSIsImVudHJ5TW9kdWxlIiwibG9hZE1vZHVsZSIsIkVycm9yIiwiaXNFbXB0eSIsInNjaGVtYSIsImZvck93biIsInNjaGVtYUluZm8iLCJzY2hlbWFOYW1lIiwiZGVwbG95bWVudFNldHRpbmdzIiwiaGFzT3duUHJvcGVydHkiLCJqc0ZpbGUiLCJ3cml0ZUZpbGVTeW5jIiwiSlNPTiIsInN0cmluZ2lmeSIsInRvSlNPTiIsIm1vZHVsZVBhdGgiLCJpZCIsImdldE1vZHVsZUlkQnlQYXRoIiwiZXhpc3RzU3luYyIsInVuZGVmaW5lZCIsIm9vbCIsIl9jb21waWxlIiwidHJhY2tCYWNrVHlwZSIsIm9vbE1vZHVsZSIsImluZm8iLCJCdWlsdGluIiwiaGFzIiwidHlwZSIsImJhc2VJbmZvIiwibG9hZEVsZW1lbnQiLCJUWVBFIiwidW5pcXVlSWQiLCJnZXRFbGVtZW50VW5pcXVlSWQiLCJ2YWx1ZSIsIm5hbWUiLCJvd25lck1vZHVsZSIsImdldCIsInJvb3RUeXBlSW5mbyIsImRlcml2ZWRJbmZvIiwiY2xvbmVEZWVwIiwib21pdCIsIm1vZGlmaWVycyIsInN1YkNsYXNzIiwicHVzaCIsInRyYW5zbGF0ZU9vbFZhbHVlIiwiaXNQbGFpbk9iamVjdCIsIm9vbFR5cGUiLCJMYW5nIiwiQ09OU1RfUkVGIiwicmVmZWRWYWx1ZSIsIkNPTlNUIiwibWFwVmFsdWVzIiwidiIsIkFycmF5IiwiaXNBcnJheSIsIm1hcCIsImlzQnVpbHRpbkVudGl0eSIsInN0YXJ0c1dpdGgiLCJyZWxhdGl2ZSIsInJlZmVyZXJNb2R1bGUiLCJlbGVtZW50VHlwZSIsImVsZW1lbnROYW1lIiwibG9hZEVudGl0eSIsInRocm93T25NaXNzaW5nIiwiZW50aXR5IiwiZmllbGRzIiwibG9hZFR5cGUiLCJsb2FkRGF0YXNldCIsImxvYWRWaWV3IiwidGFyZ2V0TW9kdWxlIiwiaW5kZXgiLCJmaW5kTGFzdEluZGV4IiwibmFtZXNwYWNlIiwiZWxlbWVudFNlbGZJZCIsInNldCIsImVsZW1lbnRJbmZvIiwiT2JqZWN0IiwiZnJlZXplIiwiZWxlbWVudCIsIkVsZW1lbnRDbGFzcyIsIm9vbEZpbGUiLCJlbmRzV2l0aCIsInN1YnN0ciIsImxlbmd0aCIsInNlYXJjaEV4dCIsInJlYWRKc29uU3luYyIsInBhcnNlIiwicmVhZEZpbGVTeW5jIiwiZXJyb3IiLCJiYXNlTmFtZSIsImJhc2VuYW1lIiwiY3VycmVudFBhdGgiLCJkaXJuYW1lIiwiZXhwYW5kTnMiLCJuYW1lc3BhY2VzIiwibnMiLCJzdGF0cyIsInN0YXRTeW5jIiwiaXNGaWxlIiwiaXNEaXJlY3Rvcnki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RUFBRSxHQUFHakksaUJBQXhFLENBQWY7QUFDSDtBQUNKLE9BcEJEO0FBcUJIOztBQUVEc0QsSUFBQUEsR0FBRyxDQUFDb0QsU0FBSixHQUFnQkEsU0FBaEI7QUFFQXBELElBQUFBLEdBQUcsQ0FBQ0osRUFBSixHQUFTLEtBQUtDLGlCQUFMLENBQXVCK0QsT0FBdkIsQ0FBVDtBQUNBNUQsSUFBQUEsR0FBRyxDQUFDYyxJQUFKLEdBQVd1RCxRQUFYOztBQUVBLFFBQUksQ0FBQyxLQUFLcEgsYUFBTixJQUF1QixLQUFLVyxnQkFBaEMsRUFBa0Q7QUFDOUNsQyxNQUFBQSxFQUFFLENBQUM2RCxhQUFILENBQWlCRCxNQUFqQixFQUF5QkUsSUFBSSxDQUFDQyxTQUFMLENBQWVPLEdBQWYsRUFBb0IsSUFBcEIsRUFBMEIsQ0FBMUIsQ0FBekI7QUFDSDs7QUFFRCxXQUFPQSxHQUFQO0FBQ0g7O0FBaGNROztBQW1jYnFGLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnhJLE1BQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCB7IF8sIGZzLCBnbG9iIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuXG5jb25zdCBPb2xvbmcgPSByZXF1aXJlKCcuL2dyYW1tYXIvb29sb25nJyk7XG5jb25zdCBPb2xvbmdQYXJzZXIgPSBPb2xvbmcucGFyc2VyO1xuY29uc3QgT29sVHlwZXMgPSByZXF1aXJlKCcuL09vbFR5cGVzJyk7XG5jb25zdCBUeXBlcyA9IHJlcXVpcmUoJy4uL3J1bnRpbWUvdHlwZXMnKTtcblxuY29uc3QgRW50aXR5ID0gcmVxdWlyZSgnLi9FbnRpdHknKTtcbmNvbnN0IFNjaGVtYSA9IHJlcXVpcmUoJy4vU2NoZW1hJyk7XG5jb25zdCBWaWV3ID0gcmVxdWlyZSgnLi9WaWV3Jyk7XG5jb25zdCBEYXRhc2V0ID0gcmVxdWlyZSgnLi9EYXRhc2V0Jyk7XG5cbmNvbnN0IEVMRU1FTlRfQ0xBU1NfTUFQID0ge1xuICAgIFtPb2xUeXBlcy5FbGVtZW50LkVOVElUWV06IEVudGl0eSxcbiAgICBbT29sVHlwZXMuRWxlbWVudC5WSUVXXTogVmlldyxcbiAgICBbT29sVHlwZXMuRWxlbWVudC5EQVRBU0VUXTogRGF0YXNldCxcbn07XG5cbmNvbnN0IE9PTE9OR19TT1VSQ0VfRVhUID0gJy5vb2wnO1xuY29uc3QgQlVJTFRJTlNfUEFUSCA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICdidWlsdGlucycpO1xuXG4vKipcbiAqIExpbmtlciBvZiBvb2xvbmcgRFNMXG4gKiBAY2xhc3MgT29sb25nTGlua2VyXG4gKi9cbmNsYXNzIExpbmtlciB7XG4gICAgc3RhdGljIGdldE9vbG9uZ0ZpbGVzKHNvdXJjZURpciwgdXNlSnNvblNvdXJjZSwgcmVjdXJzaXZlKSB7XG4gICAgICAgIGxldCBwYXR0ZXJuID0gJyonICsgT09MT05HX1NPVVJDRV9FWFQ7XG5cbiAgICAgICAgaWYgKHVzZUpzb25Tb3VyY2UpIHtcbiAgICAgICAgICAgIHBhdHRlcm4gKz0gJy5qc29uJztcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChyZWN1cnNpdmUpIHtcbiAgICAgICAgICAgIHBhdHRlcm4gPSAnKiovJyArIHBhdHRlcm47XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZ2xvYi5zeW5jKHBhdGguam9pbihzb3VyY2VEaXIsIHBhdHRlcm4pLCB7bm9kaXI6IHRydWV9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gY29udGV4dFxuICAgICAqIEBwcm9wZXJ0eSB7TG9nZ2VyfSBjb250ZXh0LmxvZ2dlciAtIExvZ2dlciBvYmplY3RcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gY29udGV4dC5kc2xTb3VyY2VQYXRoIC0gT29sb25nIHNvdXJjZSBmaWxlcyBwYXRoICAgICBcbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtjb250ZXh0LnVzZUpzb25Tb3VyY2U9ZmFsc2VdIC0gVXNlIC5qc29uIGludGVybWVkaWF0ZSBzb3VyY2UgZmlsZSBpbnN0ZWFkIG9mIC5vb2xcbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtjb250ZXh0LnNhdmVJbnRlcm1lZGlhdGU9ZmFsc2VdIC0gU2F2ZSBpbnRlcm1lZGlhdGUgc291cmNlIGZpbGUgd2hpbGUgbGlua2luZ1xuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKGNvbnRleHQpIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIExvZ2dlclxuICAgICAgICAgKiBAbWVtYmVyIHtMb2dnZXJ9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmxvZ2dlciA9IGNvbnRleHQubG9nZ2VyO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBPb2xvbmcgc291cmNlIGZpbGVzIHBhdGhcbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5zb3VyY2VQYXRoID0gY29udGV4dC5kc2xTb3VyY2VQYXRoO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBVc2UganNvbiBvciBvbHNcbiAgICAgICAgICogQG1lbWJlciB7Ym9vbH1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMudXNlSnNvblNvdXJjZSA9IGNvbnRleHQudXNlSnNvblNvdXJjZSB8fCBmYWxzZTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogU2F2ZSBpbnRlcm1lZGlhdGUgZmlsZXNcbiAgICAgICAgICogQG1lbWJlciB7Ym9vbH1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuc2F2ZUludGVybWVkaWF0ZSA9IGNvbnRleHQuc2F2ZUludGVybWVkaWF0ZSB8fCBmYWxzZTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogU2NoZW1hIGRlcGxveW1lbnQgc2V0dGluZ3NcbiAgICAgICAgICogQG1lbWJlciB7b2JqZWN0fVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5zY2hlbWFEZXBsb3ltZW50ID0gY29udGV4dC5zY2hlbWFEZXBsb3ltZW50O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBMaW5rZWQgc2NoZW1hc1xuICAgICAgICAgKiBAbWVtYmVyIHtvYmplY3QuPHN0cmluZywgU2NoZW1hPn1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuc2NoZW1hcyA9IHt9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBQYXJzZWQgb29sb25nIGZpbGVzLCBwYXRoID0+IG1vZHVsZVxuICAgICAgICAgKiBAbWVtYmVyIHtvYmplY3R9XG4gICAgICAgICAqIEBwcml2YXRlXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLl9vb2xNb2R1bGVzID0ge307XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEVsZW1lbnQgY2FjaGUsIG1hcCBvZiA8cmVmZXJlbmNlSWQsIGVsZW1lbnQ+IGFuZCA8c2VsZklkLCBlbGVtZW50PlxuICAgICAgICAgKiBAbWVtYmVyIHtvYmplY3R9IFxuICAgICAgICAgKiBAcHJpdmF0ZVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5fZWxlbWVudHNDYWNoZSA9IHt9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBNYXAgb2YgPHJlZmVyZW5jZUlkLCBtb2R1bGVJZD5cbiAgICAgICAgICogQG1lbWJlciB7b2JqZWN0fVxuICAgICAgICAgKiBAcHJpdmF0ZVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5fbWFwT2ZSZWZlcmVuY2VUb01vZHVsZUlkID0gbmV3IE1hcCgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFdyaXRlIGxvZ1xuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBsZXZlbFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtZXNzYWdlXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFtkYXRhXVxuICAgICAqL1xuICAgIGxvZyhsZXZlbCwgbWVzc2FnZSwgZGF0YSkge1xuICAgICAgICBpZiAoIXRoaXMubG9nZ2VyKSByZXR1cm47XG5cbiAgICAgICAgaWYgKGRhdGEpIHtcbiAgICAgICAgICAgIHRoaXMubG9nZ2VyLmxvZyhsZXZlbCwgbWVzc2FnZSwgZGF0YSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmxvZ2dlci5sb2cobGV2ZWwsIG1lc3NhZ2UpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2sgd2hldGhlciBhIG1vZHVsZSBpcyBsb2FkZWRcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kdWxlSWRcbiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn1cbiAgICAgKi9cbiAgICBpc01vZHVsZUxvYWRlZChtb2R1bGVJZCkge1xuICAgICAgICByZXR1cm4gbW9kdWxlSWQgaW4gdGhpcy5fb29sTW9kdWxlcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgYSBsb2FkZWQgb29sb25lIG1vZHVsZVxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2R1bGVJZFxuICAgICAqIEByZXR1cm5zIHtvYmplY3R9XG4gICAgICovXG4gICAgZ2V0TW9kdWxlQnlJZChtb2R1bGVJZCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fb29sTW9kdWxlc1ttb2R1bGVJZF07XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3RhcnQgbGlua2luZyBvb2xvbmcgZmlsZXNcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZW50cnlGaWxlTmFtZVxuICAgICAqL1xuICAgIGxpbmsoZW50cnlGaWxlTmFtZSkge1xuICAgICAgICAvL2NvbXBpbGUgZW50cnkgZmlsZSAgICAgICAgXG4gICAgICAgIGxldCBlbnRyeU1vZHVsZSA9IHRoaXMubG9hZE1vZHVsZShlbnRyeUZpbGVOYW1lKTtcblxuICAgICAgICBpZiAoIWVudHJ5TW9kdWxlKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCByZXNvbHZlIGZpbGUgXCIke2VudHJ5RmlsZU5hbWV9XCIuYCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoXy5pc0VtcHR5KGVudHJ5TW9kdWxlLnNjaGVtYSkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gc2NoZW1hIGRlZmluZWQgaW4gZW50cnkgZmlsZS4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIF8uZm9yT3duKGVudHJ5TW9kdWxlLnNjaGVtYSwgKHNjaGVtYUluZm8sIHNjaGVtYU5hbWUpID0+IHtcbiAgICAgICAgICAgIGxldCBkZXBsb3ltZW50U2V0dGluZ3MgPSB0aGlzLnNjaGVtYURlcGxveW1lbnRbc2NoZW1hTmFtZV07XG4gICAgICAgICAgICBhc3NlcnQ6IGRlcGxveW1lbnRTZXR0aW5ncywgYFwiZGVwbG95bWVudFNldHRpbmdzXCIgb2Ygc2NoZW1hIFske3NjaGVtYU5hbWV9XSBub3QgZm91bmQuYDtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgbGV0IHNjaGVtYSA9IG5ldyBTY2hlbWEodGhpcywgc2NoZW1hTmFtZSwgZW50cnlNb2R1bGUsIHNjaGVtYUluZm8sIGRlcGxveW1lbnRTZXR0aW5ncyk7XG4gICAgICAgICAgICBzY2hlbWEubGluaygpO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5zY2hlbWFzLmhhc093blByb3BlcnR5KHNjaGVtYU5hbWUpKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBEdXBsaWNhdGUgc2NoZW1hOiBcIiR7c2NoZW1hTmFtZX1cIi5gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuc2NoZW1hc1tzY2hlbWFOYW1lXSA9IHNjaGVtYTtcblxuICAgICAgICAgICAgaWYgKHRoaXMuc2F2ZUludGVybWVkaWF0ZSkge1xuICAgICAgICAgICAgICAgIGxldCBqc0ZpbGUgPSBwYXRoLnJlc29sdmUodGhpcy5zb3VyY2VQYXRoLCBlbnRyeUZpbGVOYW1lICsgJy1saW5rZWQuanNvbicpO1xuICAgICAgICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMoanNGaWxlLCBKU09OLnN0cmluZ2lmeShzY2hlbWEudG9KU09OKCksIG51bGwsIDQpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7ICAgICAgICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBMb2FkIGEgb29sb25nIG1vZHVsZSwgcmV0dXJuIHVuZGVmaW5lZCBpZiBub3QgZXhpc3RcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kdWxlUGF0aFxuICAgICAqIEByZXR1cm5zIHsqfVxuICAgICAqL1xuICAgIGxvYWRNb2R1bGUobW9kdWxlUGF0aCkgeyAgICAgICAgXG4gICAgICAgIG1vZHVsZVBhdGggPSBwYXRoLnJlc29sdmUodGhpcy5zb3VyY2VQYXRoLCBtb2R1bGVQYXRoKTtcblxuICAgICAgICBsZXQgaWQgPSB0aGlzLmdldE1vZHVsZUlkQnlQYXRoKG1vZHVsZVBhdGgpO1xuXG4gICAgICAgIGlmICh0aGlzLmlzTW9kdWxlTG9hZGVkKGlkKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0TW9kdWxlQnlJZChpZCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWZzLmV4aXN0c1N5bmMobW9kdWxlUGF0aCkpIHtcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgb29sID0gdGhpcy5fY29tcGlsZShtb2R1bGVQYXRoKTtcblxuICAgICAgICByZXR1cm4gKHRoaXMuX29vbE1vZHVsZXNbaWRdID0gb29sKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUcmFjayBiYWNrIHRoZSB0eXBlIGRlcml2ZWQgY2hhaW4uXG4gICAgICogQHBhcmFtIHtvYmplY3R9IG9vbE1vZHVsZVxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBpbmZvXG4gICAgICogQHJldHVybnMge29iamVjdH1cbiAgICAgKi9cbiAgICB0cmFja0JhY2tUeXBlKG9vbE1vZHVsZSwgaW5mbykge1xuICAgICAgICBpZiAoVHlwZXMuQnVpbHRpbi5oYXMoaW5mby50eXBlKSkge1xuICAgICAgICAgICAgcmV0dXJuIGluZm87XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgYmFzZUluZm8gPSB0aGlzLmxvYWRFbGVtZW50KG9vbE1vZHVsZSwgT29sVHlwZXMuRWxlbWVudC5UWVBFLCBpbmZvLnR5cGUsIHRydWUpO1xuXG4gICAgICAgIGlmICghVHlwZXMuQnVpbHRpbi5oYXMoYmFzZUluZm8udHlwZSkpIHtcbiAgICAgICAgICAgIC8vdGhlIGJhc2UgdHlwZSBpcyBub3QgYSBidWlsdGluIHR5cGVcbiAgICAgICAgICAgIGxldCB1bmlxdWVJZCA9IHRoaXMuZ2V0RWxlbWVudFVuaXF1ZUlkKG9vbE1vZHVsZSwgT29sVHlwZXMuRWxlbWVudC5UWVBFLCB2YWx1ZS5uYW1lKTtcbiAgICAgICAgICAgIGxldCBvd25lck1vZHVsZSA9IHRoaXMuZ2V0TW9kdWxlQnlJZCh0aGlzLl9tYXBPZlJlZmVyZW5jZVRvTW9kdWxlSWQuZ2V0KHVuaXF1ZUlkKSk7XG4gICAgICAgICAgICBsZXQgcm9vdFR5cGVJbmZvID0gdGhpcy50cmFja0JhY2tUeXBlKG93bmVyTW9kdWxlLCBiYXNlSW5mbyk7XG4gICAgICAgICAgICBvd25lck1vZHVsZS50eXBlW2Jhc2VJbmZvLnR5cGVdID0gcm9vdFR5cGVJbmZvO1xuICAgICAgICAgICAgYmFzZUluZm8gPSByb290VHlwZUluZm87XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgZGVyaXZlZEluZm8gPSB7IC4uLl8uY2xvbmVEZWVwKF8ub21pdChiYXNlSW5mbywgWydtb2RpZmllcnMnXSkpLCAuLi5fLm9taXQoaW5mbywgWyd0eXBlJywgJ21vZGlmaWVycyddKX07XG4gICAgICAgIGlmIChiYXNlSW5mby5tb2RpZmllcnMgfHwgaW5mby5tb2RpZmllcnMpIHtcbiAgICAgICAgICAgIGRlcml2ZWRJbmZvLm1vZGlmaWVycyA9IFsgLi4uKGJhc2VJbmZvLm1vZGlmaWVycyB8fCBbXSksIC4uLihpbmZvLm1vZGlmaWVycyB8fCBbXSkgXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghZGVyaXZlZEluZm8uc3ViQ2xhc3MpIHtcbiAgICAgICAgICAgIGRlcml2ZWRJbmZvLnN1YkNsYXNzID0gW107XG4gICAgICAgIH1cbiAgICAgICAgZGVyaXZlZEluZm8uc3ViQ2xhc3MucHVzaChpbmZvLnR5cGUpO1xuICAgICAgICByZXR1cm4gZGVyaXZlZEluZm87XG4gICAgfSAgICBcbiAgICBcbiAgICAvKipcbiAgICAgKiBUcmFuc2xhdGUgYW4gdmFsdWUgYnkgaW5mZXJyaW5nIGFsbCB0aGUgcmVmZXJlbmNlcy5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gb29sTW9kdWxlIFxuICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgXG4gICAgICogQHJldHVybnMgeyp9IC0gVHJhbnNsYXRlZCB2YWx1ZS5cbiAgICAgKi9cbiAgICB0cmFuc2xhdGVPb2xWYWx1ZShvb2xNb2R1bGUsIHZhbHVlKSB7XG4gICAgICAgIGlmIChfLmlzUGxhaW5PYmplY3QodmFsdWUpKSB7XG4gICAgICAgICAgICBpZiAodmFsdWUub29sVHlwZSA9PT0gT29sVHlwZXMuTGFuZy5DT05TVF9SRUYpIHsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgbGV0IHJlZmVkVmFsdWUgPSB0aGlzLmxvYWRFbGVtZW50KG9vbE1vZHVsZSwgT29sVHlwZXMuRWxlbWVudC5DT05TVCwgdmFsdWUubmFtZSwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgbGV0IHVuaXF1ZUlkID0gdGhpcy5nZXRFbGVtZW50VW5pcXVlSWQob29sTW9kdWxlLCBPb2xUeXBlcy5FbGVtZW50LkNPTlNULCB2YWx1ZS5uYW1lKTtcbiAgICAgICAgICAgICAgICBsZXQgb3duZXJNb2R1bGUgPSB0aGlzLmdldE1vZHVsZUJ5SWQodGhpcy5fbWFwT2ZSZWZlcmVuY2VUb01vZHVsZUlkLmdldCh1bmlxdWVJZCkpO1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnRyYW5zbGF0ZU9vbFZhbHVlKG93bmVyTW9kdWxlLCByZWZlZFZhbHVlKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodmFsdWUub29sVHlwZSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgdG9kbzogdHJhbnNsYXRlT29sVmFsdWUgd2l0aCB0eXBlOiAke3ZhbHVlLm9vbFR5cGV9YClcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIF8ubWFwVmFsdWVzKHZhbHVlLCB2ID0+IHRoaXMudHJhbnNsYXRlT29sVmFsdWUob29sTW9kdWxlLCB2KSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZS5tYXAodiA9PiB0aGlzLnRyYW5zbGF0ZU9vbFZhbHVlKG9vbE1vZHVsZSwgdikpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCB0aGUgdW5pcXVlIG1vZHVsZSBpZCBieSBzb3VyY2UgZmlsZSBwYXRoLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2R1bGVQYXRoIC0gVGhlIHBhdGggb2YgYW4gb29sb25nIHNvdXJjZSBmaWxlLlxuICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IC0gVGhlIG1vZHVsZSBpZC5cbiAgICAgKi9cbiAgICBnZXRNb2R1bGVJZEJ5UGF0aChtb2R1bGVQYXRoKSB7ICAgICAgICBcbiAgICAgICAgbGV0IGlzQnVpbHRpbkVudGl0eSA9IF8uc3RhcnRzV2l0aChtb2R1bGVQYXRoLCBCVUlMVElOU19QQVRIKTsgICAgICBcbiAgICAgICAgcmV0dXJuIGlzQnVpbHRpbkVudGl0eSA/IFxuICAgICAgICAgICAgcGF0aC5yZWxhdGl2ZShCVUlMVElOU19QQVRILCBtb2R1bGVQYXRoKSA6IFxuICAgICAgICAgICAgJy4vJyArIHBhdGgucmVsYXRpdmUodGhpcy5zb3VyY2VQYXRoLCBtb2R1bGVQYXRoKTsgIFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCB0aGUgdW5pcXVlIG5hbWUgb2YgYW4gZWxlbWVudC5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gcmVmZXJlck1vZHVsZSBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZWxlbWVudFR5cGUgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGVsZW1lbnROYW1lIFxuICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IC0gVGhlIHVuaXF1ZSBuYW1lIG9mIGFuIGVsZW1lbnQuXG4gICAgICovXG4gICAgZ2V0RWxlbWVudFVuaXF1ZUlkKHJlZmVyZXJNb2R1bGUsIGVsZW1lbnRUeXBlLCBlbGVtZW50TmFtZSkge1xuICAgICAgICByZXR1cm4gZWxlbWVudFR5cGUgKyAnOicgKyBlbGVtZW50TmFtZSArICc8LScgKyByZWZlcmVyTW9kdWxlLmlkO1xuICAgIH1cblxuICAgIGxvYWRFbnRpdHkocmVmZXJlck1vZHVsZSwgZWxlbWVudE5hbWUsIHRocm93T25NaXNzaW5nID0gdHJ1ZSkge1xuICAgICAgICBsZXQgZW50aXR5ID0gdGhpcy5sb2FkRWxlbWVudChyZWZlcmVyTW9kdWxlLCBPb2xUeXBlcy5FbGVtZW50LkVOVElUWSwgZWxlbWVudE5hbWUsIHRocm93T25NaXNzaW5nKTtcblxuICAgICAgICBpZiAoZW50aXR5ICYmIF8uaXNFbXB0eShlbnRpdHkuZmllbGRzKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBFbnRpdHkgXCIke2VsZW1lbnROYW1lfVwiIGhhcyBubyBhbnkgZmllbGRzIGRlZmluZWQuYCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZW50aXR5O1xuICAgIH1cblxuICAgIGxvYWRUeXBlKHJlZmVyZXJNb2R1bGUsIGVsZW1lbnROYW1lLCB0aHJvd09uTWlzc2luZyA9IHRydWUpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubG9hZEVsZW1lbnQocmVmZXJlck1vZHVsZSwgT29sVHlwZXMuRWxlbWVudC5UWVBFLCBlbGVtZW50TmFtZSwgdGhyb3dPbk1pc3NpbmcpO1xuICAgIH1cblxuICAgIGxvYWREYXRhc2V0KHJlZmVyZXJNb2R1bGUsIGVsZW1lbnROYW1lLCB0aHJvd09uTWlzc2luZyA9IHRydWUpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubG9hZEVsZW1lbnQocmVmZXJlck1vZHVsZSwgT29sVHlwZXMuRWxlbWVudC5EQVRBU0VULCBlbGVtZW50TmFtZSwgdGhyb3dPbk1pc3NpbmcpO1xuICAgIH1cblxuICAgIGxvYWRWaWV3KHJlZmVyZXJNb2R1bGUsIGVsZW1lbnROYW1lLCB0aHJvd09uTWlzc2luZyA9IHRydWUpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubG9hZEVsZW1lbnQocmVmZXJlck1vZHVsZSwgT29sVHlwZXMuRWxlbWVudC5WSUVXLCBlbGVtZW50TmFtZSwgdGhyb3dPbk1pc3NpbmcpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIExvYWQgYW4gZWxlbWVudCBiYXNlZCBvbiB0aGUgbmFtZXNwYWNlIGNoYWluLlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSByZWZlcmVyTW9kdWxlIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBlbGVtZW50VHlwZSBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZWxlbWVudE5hbWUgXG4gICAgICovXG4gICAgbG9hZEVsZW1lbnQocmVmZXJlck1vZHVsZSwgZWxlbWVudFR5cGUsIGVsZW1lbnROYW1lLCB0aHJvd09uTWlzc2luZykge1xuICAgICAgICAvLyB0aGUgZWxlbWVudCBpZCB3aXRoIHR5cGUsIHNob3VsZCBiZSB1bmlxdWUgYW1vbmcgdGhlIHdob2xlIHNjaGVtYVxuICAgICAgICBsZXQgdW5pcXVlSWQgPSB0aGlzLmdldEVsZW1lbnRVbmlxdWVJZChyZWZlcmVyTW9kdWxlLCBlbGVtZW50VHlwZSwgZWxlbWVudE5hbWUpO1xuXG4gICAgICAgIC8vIHRoZSBlbGVtZW50IGlkICsgcmVmZXJlclxuICAgICAgICBpZiAodW5pcXVlSWQgaW4gdGhpcy5fZWxlbWVudHNDYWNoZSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2VsZW1lbnRzQ2FjaGVbdW5pcXVlSWRdO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHRhcmdldE1vZHVsZTsgICAgICAgIFxuXG4gICAgICAgIGlmIChlbGVtZW50VHlwZSBpbiByZWZlcmVyTW9kdWxlICYmIGVsZW1lbnROYW1lIGluIHJlZmVyZXJNb2R1bGVbZWxlbWVudFR5cGVdKSB7XG4gICAgICAgICAgICAvLyBzZWUgaWYgaXQgZXhpc3RzIGluIHRoZSBzYW1lIG1vZHVsZSAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgdGFyZ2V0TW9kdWxlID0gcmVmZXJlck1vZHVsZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIHNlYXJjaCByZXZlcnNlbHkgYnkgdGhlIG5hbWVzcGFjZXNcbiAgICAgICAgICAgIC8vdGhpcy5sb2coJ3ZlcmJvc2UnLCBgU2VhcmNoaW5nICR7ZWxlbWVudFR5cGV9IFwiJHtlbGVtZW50TmFtZX1cIiBmcm9tIFwiJHtyZWZlcmVyTW9kdWxlLmlkfVwiIC4uLmApO1xuXG4gICAgICAgICAgICBsZXQgaW5kZXggPSBfLmZpbmRMYXN0SW5kZXgocmVmZXJlck1vZHVsZS5uYW1lc3BhY2UsIG1vZHVsZVBhdGggPT4ge1xuICAgICAgICAgICAgICAgIC8vdGhpcy5sb2coJ2RlYnVnJywgYExvb2tpbmcgZm9yICR7ZWxlbWVudFR5cGV9IFwiJHtlbGVtZW50TmFtZX1cIiBpbiBcIiR7bW9kdWxlUGF0aH1cIiAuLi5gKTtcblxuICAgICAgICAgICAgICAgIHRhcmdldE1vZHVsZSA9IHRoaXMubG9hZE1vZHVsZShtb2R1bGVQYXRoKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiB0YXJnZXRNb2R1bGUgJiYgdGFyZ2V0TW9kdWxlW2VsZW1lbnRUeXBlXSAmJiAoZWxlbWVudE5hbWUgaW4gdGFyZ2V0TW9kdWxlW2VsZW1lbnRUeXBlXSk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaWYgKGluZGV4ID09PSAtMSkgeyAgIFxuICAgICAgICAgICAgICAgIGlmICh0aHJvd09uTWlzc2luZykgeyAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAke2VsZW1lbnRUeXBlfSBcIiR7ZWxlbWVudE5hbWV9XCIgbm90IGZvdW5kIGluIGltcG9ydGVkIG5hbWVzcGFjZXMuIFJlZmVyZXI6ICR7cmVmZXJlck1vZHVsZS5pZH1gKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGVsZW1lbnRTZWxmSWQgPSBlbGVtZW50VHlwZSArICc6JyArIGVsZW1lbnROYW1lICsgJ0AnICsgdGFyZ2V0TW9kdWxlLmlkO1xuICAgICAgICBpZiAoZWxlbWVudFNlbGZJZCBpbiB0aGlzLl9lbGVtZW50c0NhY2hlKSB7XG4gICAgICAgICAgICAvLyBhbHJlYWR5IGluaXRpYWxpemVkICAgICAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gKHRoaXMuX2VsZW1lbnRzQ2FjaGVbdW5pcXVlSWRdID0gdGhpcy5fZWxlbWVudHNDYWNoZVtlbGVtZW50U2VsZklkXSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBhc3NlcnQgbmFtaW5nIHZhbGlkYXR5XG4gICAgICAgIGFzc2VydDogIXRoaXMuX21hcE9mUmVmZXJlbmNlVG9Nb2R1bGVJZC5oYXModW5pcXVlSWQpLCBgJHtlbGVtZW50VHlwZX0gXCIke2VsZW1lbnROYW1lfVwiIGluIFwiJHt0YXJnZXRNb2R1bGUuaWR9XCIgY29uZmxpY3RzIHdpdGggJHtlbGVtZW50VHlwZX0gaW4gXCIke3RoaXMuX21hcE9mUmVmZXJlbmNlVG9Nb2R1bGVJZC5nZXQodW5pcXVlSWQpfVwiIWA7XG4gICAgICAgIFxuICAgICAgICB0aGlzLl9tYXBPZlJlZmVyZW5jZVRvTW9kdWxlSWQuc2V0KHVuaXF1ZUlkLCB0YXJnZXRNb2R1bGUuaWQpO1xuXG4gICAgICAgIC8vIHJldHJpZXZlIHRoZSBjb21waWxlZCBpbmZvXG4gICAgICAgIGxldCBlbGVtZW50SW5mbyA9IE9iamVjdC5mcmVlemUodGFyZ2V0TW9kdWxlW2VsZW1lbnRUeXBlXVtlbGVtZW50TmFtZV0pO1xuICAgICAgICBsZXQgZWxlbWVudDtcblxuICAgICAgICBpZiAoZWxlbWVudFR5cGUgaW4gRUxFTUVOVF9DTEFTU19NQVApIHtcbiAgICAgICAgICAgIC8vIGVsZW1lbnQgbmVlZCBsaW5raW5nXG4gICAgICAgICAgICBsZXQgRWxlbWVudENsYXNzID0gRUxFTUVOVF9DTEFTU19NQVBbZWxlbWVudFR5cGVdO1xuICAgICAgICAgICAgZWxlbWVudCA9IG5ldyBFbGVtZW50Q2xhc3ModGhpcywgZWxlbWVudE5hbWUsIHRhcmdldE1vZHVsZSwgZWxlbWVudEluZm8pOyAgIFxuICAgICAgICAgICAgZWxlbWVudC5saW5rKCk7ICAgICAgICAgXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBlbGVtZW50ID0gZWxlbWVudEluZm87XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl9lbGVtZW50c0NhY2hlW2VsZW1lbnRTZWxmSWRdID0gZWxlbWVudDtcbiAgICAgICAgdGhpcy5fZWxlbWVudHNDYWNoZVt1bmlxdWVJZF0gPSBlbGVtZW50O1xuICAgICAgICBcbiAgICAgICAgcmV0dXJuIGVsZW1lbnQ7XG4gICAgfVxuXG4gICAgX2NvbXBpbGUob29sRmlsZSkge1xuICAgICAgICBsZXQganNGaWxlO1xuICAgICAgICBcbiAgICAgICAgaWYgKG9vbEZpbGUuZW5kc1dpdGgoJy5qc29uJykpIHtcbiAgICAgICAgICAgIGpzRmlsZSA9IG9vbEZpbGU7XG4gICAgICAgICAgICBvb2xGaWxlID0gb29sRmlsZS5zdWJzdHIoMCwgb29sRmlsZS5sZW5ndGggLSA1KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGpzRmlsZSA9IG9vbEZpbGUgKyAnLmpzb24nO1xuICAgICAgICB9ICAgICAgICAgICAgICAgIFxuICAgICAgICBcbiAgICAgICAgbGV0IG9vbCwgc2VhcmNoRXh0O1xuXG4gICAgICAgIGlmICh0aGlzLnVzZUpzb25Tb3VyY2UpIHtcbiAgICAgICAgICAgIGlmICghZnMuZXhpc3RzU3luYyhqc0ZpbGUpKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBcInVzZUpzb25Tb3VyY2VcIiBlbmFiZWxkIGJ1dCBqc29uIGZpbGUgXCIke2pzRmlsZX1cIiBub3QgZm91bmQuYCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIG9vbCA9IGZzLnJlYWRKc29uU3luYyhqc0ZpbGUpO1xuICAgICAgICAgICAgc2VhcmNoRXh0ID0gT09MT05HX1NPVVJDRV9FWFQgKyAnLmpzb24nO1xuICAgICAgICB9IGVsc2Uge1xuXG4gICAgICAgICAgICAvL3RoaXMubG9nKCdkZWJ1ZycsICdDb21waWxpbmcgJyArIG9vbEZpbGUgKyAnIC4uLicpOyAgICAgICAgXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgb29sID0gT29sb25nUGFyc2VyLnBhcnNlKGZzLnJlYWRGaWxlU3luYyhvb2xGaWxlLCAndXRmOCcpKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gY29tcGlsZSBcIiR7IG9vbEZpbGUgfVwiLlxcbiR7IGVycm9yLm1lc3NhZ2UgfHwgZXJyb3IgfWApXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghb29sKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIGVycm9yIG9jY3VycmVkIHdoaWxlIGNvbXBpbGluZy4nKTtcbiAgICAgICAgICAgIH0gICAgICAgXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHNlYXJjaEV4dCA9IE9PTE9OR19TT1VSQ0VfRVhUO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGJhc2VOYW1lID0gcGF0aC5iYXNlbmFtZShvb2xGaWxlLCBPT0xPTkdfU09VUkNFX0VYVCk7XG5cbiAgICAgICAgbGV0IG5hbWVzcGFjZSA9IFtdO1xuXG4gICAgICAgIGxldCBjdXJyZW50UGF0aCA9IHBhdGguZGlybmFtZShvb2xGaWxlKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogXG4gICAgICAgICAqIEBwYXJhbSB7Kn0gbmFtZXNwYWNlcyAtIFNlYXJjaGluZyBwYXRoXG4gICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBucyAtIEltcG9ydCBsaW5lXG4gICAgICAgICAqIEBwYXJhbSB7Kn0gcmVjdXJzaXZlIFxuICAgICAgICAgKi9cbiAgICAgICAgZnVuY3Rpb24gZXhwYW5kTnMobmFtZXNwYWNlcywgbnMsIHJlY3Vyc2l2ZSkge1xuICAgICAgICAgICAgbGV0IHN0YXRzID0gZnMuc3RhdFN5bmMobnMpO1xuXG4gICAgICAgICAgICAvL2ltcG9ydCAnL3BhdGgvdXNlci5vb2wnXG4gICAgICAgICAgICBpZiAoc3RhdHMuaXNGaWxlKCkgJiYgbnMuZW5kc1dpdGgoc2VhcmNoRXh0KSkge1xuICAgICAgICAgICAgICAgIG5hbWVzcGFjZXMucHVzaChucyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoc3RhdHMuaXNEaXJlY3RvcnkoKSAmJiByZWN1cnNpdmUpIHtcbiAgICAgICAgICAgICAgICAvL3Jlc3Vyc2l2ZSBleHBhbmQgc3ViLWRpcmVjdG9yeVxuICAgICAgICAgICAgICAgIGxldCBmaWxlcyA9IGZzLnJlYWRkaXJTeW5jKG5zKTtcbiAgICAgICAgICAgICAgICBmaWxlcy5mb3JFYWNoKGYgPT4gZXhwYW5kTnMobmFtZXNwYWNlcywgcGF0aC5qb2luKG5zLCBmKSwgdHJ1ZSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG9vbC5uYW1lc3BhY2UpIHtcbiAgICAgICAgICAgIG9vbC5uYW1lc3BhY2UuZm9yRWFjaChucyA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IHA7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKG5zLnN0YXJ0c1dpdGgoJzxvb2xvbmc+LycpKSB7XG4gICAgICAgICAgICAgICAgICAgIG5zID0gcGF0aC5qb2luKEJVSUxUSU5TX1BBVEgsIG5zLnN1YnN0cig5KSk7ICAgXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChucy5zdGFydHNXaXRoKCc8c291cmNlPi8nKSkge1xuICAgICAgICAgICAgICAgICAgICBucyA9IHBhdGguam9pbih0aGlzLnNvdXJjZVBhdGgsIG5zLnN1YnN0cig5KSk7ICAgXG4gICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgIFxuXG4gICAgICAgICAgICAgICAgaWYgKG5zLmVuZHNXaXRoKCcvKicpKSB7XG4gICAgICAgICAgICAgICAgICAgIHAgPSBwYXRoLnJlc29sdmUoY3VycmVudFBhdGgsIG5zLnN1YnN0cigwLCBucy5sZW5ndGggLSAyKSk7XG4gICAgICAgICAgICAgICAgICAgIGxldCBmaWxlcyA9IGZzLnJlYWRkaXJTeW5jKHApO1xuICAgICAgICAgICAgICAgICAgICBmaWxlcy5mb3JFYWNoKGYgPT4gZXhwYW5kTnMobmFtZXNwYWNlLCBwYXRoLmpvaW4ocCwgZiksIGZhbHNlKSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChucy5lbmRzV2l0aCgnLyoqJykpIHtcbiAgICAgICAgICAgICAgICAgICAgcCA9IHBhdGgucmVzb2x2ZShjdXJyZW50UGF0aCwgbnMuc3Vic3RyKDAsIG5zLmxlbmd0aCAtIDMpKTtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGZpbGVzID0gZnMucmVhZGRpclN5bmMocCk7XG4gICAgICAgICAgICAgICAgICAgIGZpbGVzLmZvckVhY2goZiA9PiBleHBhbmROcyhuYW1lc3BhY2UsIHBhdGguam9pbihwLCBmKSwgdHJ1ZSkpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIG5hbWVzcGFjZS5wdXNoKHBhdGgucmVzb2x2ZShjdXJyZW50UGF0aCwgXy5lbmRzV2l0aChucywgT09MT05HX1NPVVJDRV9FWFQpID8gbnMgOiBucyArIE9PTE9OR19TT1VSQ0VfRVhUKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBvb2wubmFtZXNwYWNlID0gbmFtZXNwYWNlO1xuXG4gICAgICAgIG9vbC5pZCA9IHRoaXMuZ2V0TW9kdWxlSWRCeVBhdGgob29sRmlsZSk7ICAgICAgICBcbiAgICAgICAgb29sLm5hbWUgPSBiYXNlTmFtZTsgICAgICAgXG4gICAgICAgIFxuICAgICAgICBpZiAoIXRoaXMudXNlSnNvblNvdXJjZSAmJiB0aGlzLnNhdmVJbnRlcm1lZGlhdGUpIHsgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhqc0ZpbGUsIEpTT04uc3RyaW5naWZ5KG9vbCwgbnVsbCwgNCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG9vbDtcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gTGlua2VyOyJdfQ==