"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const {
  generateDisplayName,
  deepCloneField,
  Clonable,
  schemaNaming
} = require('./OolUtils');

class Schema extends Clonable {
  constructor(linker, name, oolModule, info, deploymentSettings) {
    super();
    this.entities = {};
    this.datasets = {};
    this.views = {};
    this.linker = linker;
    this.name = schemaNaming(name);
    this.oolModule = oolModule;
    this.info = info;
    this.deploymentSettings = deploymentSettings;
  }

  link() {
    if (!!this.linked) {
      throw new Error("Function  precondition failed: !this.linked");
    }

    this.linker.log('debug', 'Linking schema [' + this.name + '] ...');

    if (this.info.comment) {
      this.comment = this.info.comment;
    }

    this.displayName = generateDisplayName(this.name);
    this.info.entities || (this.info.entities = []);
    this.info.entities.forEach(entityEntry => {
      let entity = this.linker.loadEntity(this.oolModule, entityEntry.entity);

      if (!entity.linked) {
        throw new Error("Assertion failed: entity.linked");
      }

      this.addEntity(entity);
    });

    if (!_.isEmpty(this.info.views)) {
      this.info.views.forEach(viewName => {
        this.linker.loadView(this.oolModule, viewName);

        if (!view.linked) {
          throw new Error("Assertion failed: view.linked");
        }

        this.addView(view);
      });
    }

    this.linked = true;
    return this;
  }

  hasEntity(entityName) {
    return entityName in this.entities;
  }

  addEntity(entity) {
    if (!!this.hasEntity(entity.name)) {
      throw new Error(`Entity name [${entity.name}] conflicts in schema [${this.name}].`);
    }

    this.entities[entity.name] = entity;
    return this;
  }

  hasView(viewName) {
    return viewName in this.views;
  }

  addView(view) {
    if (!!this.hasView(view.name)) {
      throw new Error(`View name [${view.name}] conflicts in schema [${this.name}].`);
    }

    this.views[view.name] = view;
    return this;
  }

  getDocumentHierachy(fromModule, datasetName) {
    if (datasetName in this.datasets) {
      return this.datasets[datasetName];
    }

    let dataset = this.linker.loadDataset(fromModule, datasetName);
    return this.datasets[datasetName] = dataset.buildHierarchy(this);
  }

  getReferencedEntity(refererModule, entityName) {
    let entity = this.linker.loadEntity(refererModule, entityName);

    if (!this.hasEntity(entity.name)) {
      throw new Error(`Entity "${entity.name}" not exists in schema "${this.name}".`);
    }

    return entity;
  }

  ensureGetEntity(refererModule, entityName, newlyAdded) {
    if (this.hasEntity(entityName)) return this.entities[entityName];
    let entity = this.linker.loadEntity(refererModule, entityName, false);

    if (entity) {
      this.addEntity(entity);

      if (newlyAdded) {
        newlyAdded.push(entity.name);
        this.linker.log('debug', `New entity "${entity.name}" added by association.`);
      }
    }

    return entity;
  }

  clone() {
    super.clone();
    let schema = new Schema(this.linker, this.name, this.oolModule, this.info, this.deploymentSettings);
    deepCloneField(this, schema, 'displayName');
    deepCloneField(this, schema, 'comment');
    deepCloneField(this, schema, 'entities');
    deepCloneField(this, schema, 'datasets');
    deepCloneField(this, schema, 'views');
    schema.linked = true;
    return schema;
  }

  toJSON() {
    return {
      name: this.name,
      displayName: this.displayName,
      comment: this.comment,
      entities: _.mapValues(this.entities, entity => entity.toJSON()),
      datasets: _.mapValues(this.datasets, dataset => dataset.toJSON()),
      views: _.mapValues(this.views, view => view.toJSON())
    };
  }

}

module.exports = Schema;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5nL1NjaGVtYS5qcyJdLCJuYW1lcyI6WyJfIiwicmVxdWlyZSIsImdlbmVyYXRlRGlzcGxheU5hbWUiLCJkZWVwQ2xvbmVGaWVsZCIsIkNsb25hYmxlIiwic2NoZW1hTmFtaW5nIiwiU2NoZW1hIiwiY29uc3RydWN0b3IiLCJsaW5rZXIiLCJuYW1lIiwib29sTW9kdWxlIiwiaW5mbyIsImRlcGxveW1lbnRTZXR0aW5ncyIsImVudGl0aWVzIiwiZGF0YXNldHMiLCJ2aWV3cyIsImxpbmsiLCJsaW5rZWQiLCJsb2ciLCJjb21tZW50IiwiZGlzcGxheU5hbWUiLCJmb3JFYWNoIiwiZW50aXR5RW50cnkiLCJlbnRpdHkiLCJsb2FkRW50aXR5IiwiYWRkRW50aXR5IiwiaXNFbXB0eSIsInZpZXdOYW1lIiwibG9hZFZpZXciLCJ2aWV3IiwiYWRkVmlldyIsImhhc0VudGl0eSIsImVudGl0eU5hbWUiLCJoYXNWaWV3IiwiZ2V0RG9jdW1lbnRIaWVyYWNoeSIsImZyb21Nb2R1bGUiLCJkYXRhc2V0TmFtZSIsImRhdGFzZXQiLCJsb2FkRGF0YXNldCIsImJ1aWxkSGllcmFyY2h5IiwiZ2V0UmVmZXJlbmNlZEVudGl0eSIsInJlZmVyZXJNb2R1bGUiLCJFcnJvciIsImVuc3VyZUdldEVudGl0eSIsIm5ld2x5QWRkZWQiLCJwdXNoIiwiY2xvbmUiLCJzY2hlbWEiLCJ0b0pTT04iLCJtYXBWYWx1ZXMiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU07QUFBRUEsRUFBQUE7QUFBRixJQUFRQyxPQUFPLENBQUMsVUFBRCxDQUFyQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBLG1CQUFGO0FBQXVCQyxFQUFBQSxjQUF2QjtBQUF1Q0MsRUFBQUEsUUFBdkM7QUFBaURDLEVBQUFBO0FBQWpELElBQWtFSixPQUFPLENBQUMsWUFBRCxDQUEvRTs7QUFNQSxNQUFNSyxNQUFOLFNBQXFCRixRQUFyQixDQUE4QjtBQXlCMUJH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QUFJQSxNQUFNLENBQUN5QixNQUFQLEVBQXJDLENBSlA7QUFLSGxDLE1BQUFBLFFBQVEsRUFBRWQsQ0FBQyxDQUFDaUQsU0FBRixDQUFZLEtBQUtuQyxRQUFqQixFQUEyQnVCLE9BQU8sSUFBSUEsT0FBTyxDQUFDVyxNQUFSLEVBQXRDLENBTFA7QUFNSGpDLE1BQUFBLEtBQUssRUFBRWYsQ0FBQyxDQUFDaUQsU0FBRixDQUFZLEtBQUtsQyxLQUFqQixFQUF3QmMsSUFBSSxJQUFJQSxJQUFJLENBQUNtQixNQUFMLEVBQWhDO0FBTkosS0FBUDtBQVFIOztBQTFPeUI7O0FBNk85QkUsTUFBTSxDQUFDQyxPQUFQLEdBQWlCN0MsTUFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgeyBfIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyBnZW5lcmF0ZURpc3BsYXlOYW1lLCBkZWVwQ2xvbmVGaWVsZCwgQ2xvbmFibGUsIHNjaGVtYU5hbWluZyB9ID0gcmVxdWlyZSgnLi9Pb2xVdGlscycpO1xuXG4vKipcbiAqIE9vbG9uZyBzY2hlbWEgY2xhc3MuXG4gKiBAY2xhc3MgT29sb25nU2NoZW1hXG4gKi9cbmNsYXNzIFNjaGVtYSBleHRlbmRzIENsb25hYmxlIHtcbiAgICAvKipcbiAgICAgKiBFbnRpdGllcyBpbiB0aGlzIHNjaGVtYSwgbWFwIG9mIDxlbnRpdHlOYW1lLCBlbnRpdHlPYmplY3Q+XG4gICAgICogQG1lbWJlciB7b2JqZWN0LjxzdHJpbmcsIE9vbG9uZ0VudGl0eT59XG4gICAgICovXG4gICAgZW50aXRpZXMgPSB7fTtcblxuICAgIC8qKlxuICAgICAqIERhdGFzZXRzLCBkYXRhc2V0ID0gZW50aXR5ICsgcmVsYXRpb25zICsgcHJvamVjdGlvblxuICAgICAqIEBtZW1iZXIge29iamVjdH1cbiAgICAgKi9cbiAgICBkYXRhc2V0cyA9IHt9O1xuXG4gICAgLyoqXG4gICAgICogVmlld3MsIHZpZXcgPSBkYXRhc2V0ICsgZmlsdGVycyBcbiAgICAgKiBAbWVtYmVyIHtvYmplY3R9XG4gICAgICovXG4gICAgdmlld3MgPSB7fTsgICAgXG5cbiAgICAvKiogICAgIFxuICAgICAqIEBwYXJhbSB7T29sb25nTGlua2VyfSBsaW5rZXJcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZVxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvb2xNb2R1bGVcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gaW5mb1xuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKGxpbmtlciwgbmFtZSwgb29sTW9kdWxlLCBpbmZvLCBkZXBsb3ltZW50U2V0dGluZ3MpIHtcbiAgICAgICAgc3VwZXIoKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogTGlua2VyIHRvIHByb2Nlc3MgdGhpcyBzY2hlbWFcbiAgICAgICAgICogQG1lbWJlciB7T29sb25nTGlua2VyfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5saW5rZXIgPSBsaW5rZXI7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIE5hbWUgb2YgdGhpcyBlbnRpdHlcbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5uYW1lID0gc2NoZW1hTmFtaW5nKG5hbWUpO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBPd25lciBvb2xvbmcgbW9kdWxlXG4gICAgICAgICAqIEBtZW1iZXIge29iamVjdH1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMub29sTW9kdWxlID0gb29sTW9kdWxlO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBSYXcgbWV0YWRhdGFcbiAgICAgICAgICogQG1lbWJlciB7b2JqZWN0fVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5pbmZvID0gaW5mbzsgICAgICAgIFxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBEZXBsb3ltZW50IHNldHRpbmdzXG4gICAgICAgICAqIEBtZW1iZXIge29iamVjdH1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuZGVwbG95bWVudFNldHRpbmdzID0gZGVwbG95bWVudFNldHRpbmdzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN0YXJ0IGxpbmtpbmcgdGhpcyBzY2hlbWFcbiAgICAgKiBAcmV0dXJucyB7U2NoZW1hfVxuICAgICAqL1xuICAgIGxpbmsoKSB7XG4gICAgICAgIHByZTogIXRoaXMubGlua2VkO1xuXG4gICAgICAgIHRoaXMubGlua2VyLmxvZygnZGVidWcnLCAnTGlua2luZyBzY2hlbWEgWycgKyB0aGlzLm5hbWUgKyAnXSAuLi4nKTtcblxuICAgICAgICBpZiAodGhpcy5pbmZvLmNvbW1lbnQpIHtcbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAgICAgICAgICovXG4gICAgICAgICAgICB0aGlzLmNvbW1lbnQgPSB0aGlzLmluZm8uY29tbWVudDtcbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmRpc3BsYXlOYW1lID0gZ2VuZXJhdGVEaXNwbGF5TmFtZSh0aGlzLm5hbWUpO1xuXG4gICAgICAgIC8vMXN0IHJvdW5kLCBnZXQgZGlyZWN0IG91dHB1dCBlbnRpdGllc1xuICAgICAgICB0aGlzLmluZm8uZW50aXRpZXMgfHwgKHRoaXMuaW5mby5lbnRpdGllcyA9IFtdKTtcblxuICAgICAgICB0aGlzLmluZm8uZW50aXRpZXMuZm9yRWFjaChlbnRpdHlFbnRyeSA9PiB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBsZXQgZW50aXR5ID0gdGhpcy5saW5rZXIubG9hZEVudGl0eSh0aGlzLm9vbE1vZHVsZSwgZW50aXR5RW50cnkuZW50aXR5KTtcbiAgICAgICAgICAgIGFzc2VydDogZW50aXR5LmxpbmtlZDtcblxuICAgICAgICAgICAgdGhpcy5hZGRFbnRpdHkoZW50aXR5KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKCFfLmlzRW1wdHkodGhpcy5pbmZvLnZpZXdzKSkge1xuICAgICAgICAgICAgdGhpcy5pbmZvLnZpZXdzLmZvckVhY2godmlld05hbWUgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMubGlua2VyLmxvYWRWaWV3KHRoaXMub29sTW9kdWxlLCB2aWV3TmFtZSk7XG4gICAgICAgICAgICAgICAgYXNzZXJ0OiB2aWV3LmxpbmtlZDtcblxuICAgICAgICAgICAgICAgIHRoaXMuYWRkVmlldyh2aWV3KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5saW5rZWQgPSB0cnVlO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrIHdoZXRoZXIgYSBlbnRpdHkgd2l0aCBnaXZlbiBuYW1lIGlzIGluIHRoZSBzY2hlbWFcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZW50aXR5TmFtZVxuICAgICAqIEByZXR1cm5zIHtib29sZWFufVxuICAgICAqL1xuICAgIGhhc0VudGl0eShlbnRpdHlOYW1lKSB7XG4gICAgICAgIHJldHVybiAoZW50aXR5TmFtZSBpbiB0aGlzLmVudGl0aWVzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgYW4gZW50aXR5IGludG8gdGhlIHNjaGVtYVxuICAgICAqIEBwYXJhbSB7T29sb25nRW50aXR5fSBlbnRpdHlcbiAgICAgKiBAcmV0dXJucyB7T29sb25nU2NoZW1hfVxuICAgICAqL1xuICAgIGFkZEVudGl0eShlbnRpdHkpIHtcbiAgICAgICAgcHJlOiAhdGhpcy5oYXNFbnRpdHkoZW50aXR5Lm5hbWUpLCBgRW50aXR5IG5hbWUgWyR7ZW50aXR5Lm5hbWV9XSBjb25mbGljdHMgaW4gc2NoZW1hIFske3RoaXMubmFtZX1dLmA7XG5cbiAgICAgICAgdGhpcy5lbnRpdGllc1tlbnRpdHkubmFtZV0gPSBlbnRpdHk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2sgd2hldGhlciBhIHZpZXcgd2l0aCBnaXZlbiBuYW1lIGlzIGluIHRoZSBzY2hlbWFcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdmlld05hbWVcbiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn1cbiAgICAgKi9cbiAgICBoYXNWaWV3KHZpZXdOYW1lKSB7XG4gICAgICAgIHJldHVybiAodmlld05hbWUgaW4gdGhpcy52aWV3cyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkIGEgdmlldyBpbnRvIHRoZSBzY2hlbWFcbiAgICAgKiBAcGFyYW0ge09vbG9uZ1ZpZXd9IHZpZXcgXG4gICAgICogQHJldHVybnMge09vbG9uZ1NjaGVtYX1cbiAgICAgKi9cbiAgICBhZGRWaWV3KHZpZXcpIHtcbiAgICAgICAgcHJlOiAhdGhpcy5oYXNWaWV3KHZpZXcubmFtZSksIGBWaWV3IG5hbWUgWyR7dmlldy5uYW1lfV0gY29uZmxpY3RzIGluIHNjaGVtYSBbJHt0aGlzLm5hbWV9XS5gO1xuXG4gICAgICAgIHRoaXMudmlld3Nbdmlldy5uYW1lXSA9IHZpZXc7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGEgZG9jdW1lbnQgaGllcmFyY2h5XG4gICAgICogQHBhcmFtIHtvYmplY3R9IGZyb21Nb2R1bGVcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YXNldE5hbWVcbiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fVxuICAgICAqL1xuICAgIGdldERvY3VtZW50SGllcmFjaHkoZnJvbU1vZHVsZSwgZGF0YXNldE5hbWUpIHtcbiAgICAgICAgaWYgKGRhdGFzZXROYW1lIGluIHRoaXMuZGF0YXNldHMpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmRhdGFzZXRzW2RhdGFzZXROYW1lXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBkYXRhc2V0ID0gdGhpcy5saW5rZXIubG9hZERhdGFzZXQoZnJvbU1vZHVsZSwgZGF0YXNldE5hbWUpO1xuICAgICAgICByZXR1cm4gKHRoaXMuZGF0YXNldHNbZGF0YXNldE5hbWVdID0gZGF0YXNldC5idWlsZEhpZXJhcmNoeSh0aGlzKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IHRoZSByZWZlcmVuY2VkIGVudGl0eSwgYWRkIGl0IGludG8gc2NoZW1hIGlmIG5vdCBpbiBzY2hlbWFcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gcmVmZXJlck1vZHVsZVxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBlbnRpdHlOYW1lXG4gICAgICogQHJldHVybnMge09vbG9uZ0VudGl0eX1cbiAgICAgKi9cbiAgICBnZXRSZWZlcmVuY2VkRW50aXR5KHJlZmVyZXJNb2R1bGUsIGVudGl0eU5hbWUpIHtcbiAgICAgICAgbGV0IGVudGl0eSA9IHRoaXMubGlua2VyLmxvYWRFbnRpdHkocmVmZXJlck1vZHVsZSwgZW50aXR5TmFtZSk7XG5cbiAgICAgICAgaWYgKCF0aGlzLmhhc0VudGl0eShlbnRpdHkubmFtZSkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRW50aXR5IFwiJHtlbnRpdHkubmFtZX1cIiBub3QgZXhpc3RzIGluIHNjaGVtYSBcIiR7dGhpcy5uYW1lfVwiLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGVudGl0eTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBcbiAgICAgKiBAcGFyYW0geyp9IHJlZmVyZXJNb2R1bGUgXG4gICAgICogQHBhcmFtIHsqfSBlbnRpdHlOYW1lIFxuICAgICAqL1xuICAgIGVuc3VyZUdldEVudGl0eShyZWZlcmVyTW9kdWxlLCBlbnRpdHlOYW1lLCBuZXdseUFkZGVkKSB7XG4gICAgICAgIGlmICh0aGlzLmhhc0VudGl0eShlbnRpdHlOYW1lKSkgcmV0dXJuIHRoaXMuZW50aXRpZXNbZW50aXR5TmFtZV07XG5cbiAgICAgICAgbGV0IGVudGl0eSA9IHRoaXMubGlua2VyLmxvYWRFbnRpdHkocmVmZXJlck1vZHVsZSwgZW50aXR5TmFtZSwgZmFsc2UpO1xuXG4gICAgICAgIGlmIChlbnRpdHkpIHtcbiAgICAgICAgICAgIHRoaXMuYWRkRW50aXR5KGVudGl0eSk7ICAgXG5cbiAgICAgICAgICAgIGlmIChuZXdseUFkZGVkKSB7XG4gICAgICAgICAgICAgICAgbmV3bHlBZGRlZC5wdXNoKGVudGl0eS5uYW1lKTtcbiAgICAgICAgICAgICAgICB0aGlzLmxpbmtlci5sb2coJ2RlYnVnJywgYE5ldyBlbnRpdHkgXCIke2VudGl0eS5uYW1lfVwiIGFkZGVkIGJ5IGFzc29jaWF0aW9uLmApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGVudGl0eTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDbG9uZSB0aGUgc2NoZW1hXG4gICAgICogQHJldHVybnMge1NjaGVtYX1cbiAgICAgKi9cbiAgICBjbG9uZSgpIHtcbiAgICAgICAgc3VwZXIuY2xvbmUoKTtcbiAgICAgICAgXG4gICAgICAgIGxldCBzY2hlbWEgPSBuZXcgU2NoZW1hKHRoaXMubGlua2VyLCB0aGlzLm5hbWUsIHRoaXMub29sTW9kdWxlLCB0aGlzLmluZm8sIHRoaXMuZGVwbG95bWVudFNldHRpbmdzKTtcbiAgICAgICAgXG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIHNjaGVtYSwgJ2Rpc3BsYXlOYW1lJyk7XG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIHNjaGVtYSwgJ2NvbW1lbnQnKTsgICAgICAgIFxuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCBzY2hlbWEsICdlbnRpdGllcycpOyAgICAgICAgXG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIHNjaGVtYSwgJ2RhdGFzZXRzJyk7XG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIHNjaGVtYSwgJ3ZpZXdzJyk7ICAgICAgICBcblxuICAgICAgICBzY2hlbWEubGlua2VkID0gdHJ1ZTtcblxuICAgICAgICByZXR1cm4gc2NoZW1hO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRyYW5zbGF0ZSB0aGUgc2NoZW1hIGludG8gYSBwbGFpbiBKU09OIG9iamVjdFxuICAgICAqIEByZXR1cm5zIHtvYmplY3R9XG4gICAgICovXG4gICAgdG9KU09OKCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgbmFtZTogdGhpcy5uYW1lLFxuICAgICAgICAgICAgZGlzcGxheU5hbWU6IHRoaXMuZGlzcGxheU5hbWUsXG4gICAgICAgICAgICBjb21tZW50OiB0aGlzLmNvbW1lbnQsICAgICAgICBcbiAgICAgICAgICAgIGVudGl0aWVzOiBfLm1hcFZhbHVlcyh0aGlzLmVudGl0aWVzLCBlbnRpdHkgPT4gZW50aXR5LnRvSlNPTigpKSwgICAgICAgICAgICBcbiAgICAgICAgICAgIGRhdGFzZXRzOiBfLm1hcFZhbHVlcyh0aGlzLmRhdGFzZXRzLCBkYXRhc2V0ID0+IGRhdGFzZXQudG9KU09OKCkpLCBcbiAgICAgICAgICAgIHZpZXdzOiBfLm1hcFZhbHVlcyh0aGlzLnZpZXdzLCB2aWV3ID0+IHZpZXcudG9KU09OKCkpIFxuICAgICAgICB9O1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBTY2hlbWE7Il19