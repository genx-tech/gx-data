"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const {
  pascalCase
} = Util;
const FEATURE_NAME = 'stateTracking';
const FIELD_NAME_SUFFIX = 'Timestamp';

function timestampFieldNaming(field, state) {
  return field + pascalCase(state) + FIELD_NAME_SUFFIX;
}

function feature(entity, args = []) {
  let [options] = args;

  if (!options) {
    throw new Error('Missing field options!');
  }

  if (typeof options === 'string') {
    options = {
      field: options
    };
  }

  if (!options.field) {
    throw new Error('Missing field name in options!');
  }

  let stateSetTimestamp = {
    type: 'datetime',
    readOnly: true,
    optional: true,
    auto: true
  };

  if (!options.reversible) {
    stateSetTimestamp.writeOnce = true;
  }

  entity.on('afterAddingFields', () => {
    if (!entity.hasField(options.field)) {
      throw new Error('Field "' + options.field + '" does not exist!');
    }

    let fieldInfo = entity.fields[options.field];

    if (fieldInfo.type !== 'enum') {
      throw new Error('Only enum field can be used with stateTracking feature!');
    }

    let stateMapping = {};
    fieldInfo.values.forEach(state => {
      let fieldName = timestampFieldNaming(options.field, state);
      entity.addField(fieldName, stateSetTimestamp);
      stateMapping[state] = fieldName;
    });
    entity.addFeature(FEATURE_NAME, {
      field: options.field,
      stateMapping
    }, true);
  });
}

module.exports = feature;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9sYW5nL2VudGl0eUZlYXR1cmVzL3N0YXRlVHJhY2tpbmcuanMiXSwibmFtZXMiOlsiVXRpbCIsInJlcXVpcmUiLCJwYXNjYWxDYXNlIiwiRkVBVFVSRV9OQU1FIiwiRklFTERfTkFNRV9TVUZGSVgiLCJ0aW1lc3RhbXBGaWVsZE5hbWluZyIsImZpZWxkIiwic3RhdGUiLCJmZWF0dXJlIiwiZW50aXR5IiwiYXJncyIsIm9wdGlvbnMiLCJFcnJvciIsInN0YXRlU2V0VGltZXN0YW1wIiwidHlwZSIsInJlYWRPbmx5Iiwib3B0aW9uYWwiLCJhdXRvIiwicmV2ZXJzaWJsZSIsIndyaXRlT25jZSIsIm9uIiwiaGFzRmllbGQiLCJmaWVsZEluZm8iLCJmaWVsZHMiLCJzdGF0ZU1hcHBpbmciLCJ2YWx1ZXMiLCJmb3JFYWNoIiwiZmllbGROYW1lIiwiYWRkRmllbGQiLCJhZGRGZWF0dXJlIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxVQUFELENBQXBCOztBQUNBLE1BQU07QUFBRUMsRUFBQUE7QUFBRixJQUFpQkYsSUFBdkI7QUFFQSxNQUFNRyxZQUFZLEdBQUcsZUFBckI7QUFFQSxNQUFNQyxpQkFBaUIsR0FBRyxXQUExQjs7QUFFQSxTQUFTQyxvQkFBVCxDQUE4QkMsS0FBOUIsRUFBcUNDLEtBQXJDLEVBQTRDO0FBQ3hDLFNBQU9ELEtBQUssR0FBR0osVUFBVSxDQUFDSyxLQUFELENBQWxCLEdBQTRCSCxpQkFBbkM7QUFDSDs7QUFjRCxTQUFTSSxPQUFULENBQWlCQyxNQUFqQixFQUF5QkMsSUFBSSxHQUFHLEVBQWhDLEVBQW9DO0FBQ2hDLE1BQUksQ0FBRUMsT0FBRixJQUFjRCxJQUFsQjs7QUFFQSxNQUFJLENBQUNDLE9BQUwsRUFBYztBQUNWLFVBQU0sSUFBSUMsS0FBSixDQUFVLHdCQUFWLENBQU47QUFDSDs7QUFFRCxNQUFJLE9BQU9ELE9BQVAsS0FBbUIsUUFBdkIsRUFBaUM7QUFDN0JBLElBQUFBLE9BQU8sR0FBRztBQUFFTCxNQUFBQSxLQUFLLEVBQUVLO0FBQVQsS0FBVjtBQUNIOztBQUVELE1BQUksQ0FBQ0EsT0FBTyxDQUFDTCxLQUFiLEVBQW9CO0FBQ2hCLFVBQU0sSUFBSU0sS0FBSixDQUFVLGdDQUFWLENBQU47QUFDSDs7QUFFRCxNQUFJQyxpQkFBaUIsR0FBRztBQUNwQkMsSUFBQUEsSUFBSSxFQUFFLFVBRGM7QUFFcEJDLElBQUFBLFFBQVEsRUFBRSxJQUZVO0FBR3BCQyxJQUFBQSxRQUFRLEVBQUUsSUFIVTtBQUlwQkMsSUFBQUEsSUFBSSxFQUFFO0FBSmMsR0FBeEI7O0FBT0EsTUFBSSxDQUFDTixPQUFPLENBQUNPLFVBQWIsRUFBeUI7QUFDckJMLElBQUFBLGlCQUFpQixDQUFDTSxTQUFsQixHQUE4QixJQUE5QjtBQUNIOztBQUVEVixFQUFBQSxNQUFNLENBQUNXLEVBQVAsQ0FBVSxtQkFBVixFQUErQixNQUFNO0FBQ2pDLFFBQUksQ0FBQ1gsTUFBTSxDQUFDWSxRQUFQLENBQWdCVixPQUFPLENBQUNMLEtBQXhCLENBQUwsRUFBcUM7QUFDakMsWUFBTSxJQUFJTSxLQUFKLENBQVUsWUFBWUQsT0FBTyxDQUFDTCxLQUFwQixHQUE0QixtQkFBdEMsQ0FBTjtBQUNIOztBQUVELFFBQUlnQixTQUFTLEdBQUdiLE1BQU0sQ0FBQ2MsTUFBUCxDQUFjWixPQUFPLENBQUNMLEtBQXRCLENBQWhCOztBQUVBLFFBQUlnQixTQUFTLENBQUNSLElBQVYsS0FBbUIsTUFBdkIsRUFBK0I7QUFDM0IsWUFBTSxJQUFJRixLQUFKLENBQVUseURBQVYsQ0FBTjtBQUNIOztBQUVELFFBQUlZLFlBQVksR0FBRyxFQUFuQjtBQUVBRixJQUFBQSxTQUFTLENBQUNHLE1BQVYsQ0FBaUJDLE9BQWpCLENBQXlCbkIsS0FBSyxJQUFJO0FBQzlCLFVBQUlvQixTQUFTLEdBQUd0QixvQkFBb0IsQ0FBQ00sT0FBTyxDQUFDTCxLQUFULEVBQWdCQyxLQUFoQixDQUFwQztBQUVBRSxNQUFBQSxNQUFNLENBQUNtQixRQUFQLENBQWdCRCxTQUFoQixFQUEyQmQsaUJBQTNCO0FBQ0FXLE1BQUFBLFlBQVksQ0FBQ2pCLEtBQUQsQ0FBWixHQUFzQm9CLFNBQXRCO0FBQ0gsS0FMRDtBQU9BbEIsSUFBQUEsTUFBTSxDQUFDb0IsVUFBUCxDQUFrQjFCLFlBQWxCLEVBQWdDO0FBQzVCRyxNQUFBQSxLQUFLLEVBQUVLLE9BQU8sQ0FBQ0wsS0FEYTtBQUU1QmtCLE1BQUFBO0FBRjRCLEtBQWhDLEVBR0csSUFISDtBQUlILEdBeEJEO0FBeUJIOztBQUVETSxNQUFNLENBQUNDLE9BQVAsR0FBaUJ2QixPQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBVdGlsID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgcGFzY2FsQ2FzZSB9ID0gVXRpbDtcblxuY29uc3QgRkVBVFVSRV9OQU1FID0gJ3N0YXRlVHJhY2tpbmcnO1xuXG5jb25zdCBGSUVMRF9OQU1FX1NVRkZJWCA9ICdUaW1lc3RhbXAnO1xuXG5mdW5jdGlvbiB0aW1lc3RhbXBGaWVsZE5hbWluZyhmaWVsZCwgc3RhdGUpIHtcbiAgICByZXR1cm4gZmllbGQgKyBwYXNjYWxDYXNlKHN0YXRlKSArIEZJRUxEX05BTUVfU1VGRklYO1xufVxuXG4vKipcbiAqIEEgcnVsZSBzcGVjaWZpZXMgdGhlIGNoYW5nZSBvZiBzdGF0ZSB3aWxsIGJlIHRyYWNrZWQgYXV0b21hdGljYWxseS5cbiAqIEBtb2R1bGUgRW50aXR5RmVhdHVyZV9TdGF0ZVRyYWNraW5nXG4gKi9cblxuLyoqXG4gKiBJbml0aWFsaXplIHRoZSBmZWF0dXJlXG4gKiBAcGFyYW0ge09vbG9uZ0VudGl0eX0gZW50aXR5IC0gRW50aXR5IHRvIGFwcGx5IHRoaXMgZmVhdHVyZVxuICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgLSBUcmFja2luZyBmaWVsZCBvcHRpb25zXG4gKiBAcHJvcGVydHkge3N0cmluZ30gb3B0aW9ucy5maWVsZCAtIFN0YXRlIGZpZWxkIHRvIHRyYWNrXG4gKiBAcHJvcGVydHkge2Jvb2x9IFtvcHRpb25zLnJldmVyc2libGU9ZmFsc2VdIC0gU3BlY2lmeSB3aGV0aGVyIHRoZSBmaWVsZCBjYW4gYmUgc2V0IHRvIGEgcHJldmlvdXMgc3RhdGUgYWdhaW5cbiAqL1xuZnVuY3Rpb24gZmVhdHVyZShlbnRpdHksIGFyZ3MgPSBbXSkge1xuICAgIGxldCBbIG9wdGlvbnMgXSA9IGFyZ3M7XG4gICAgXG4gICAgaWYgKCFvcHRpb25zKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignTWlzc2luZyBmaWVsZCBvcHRpb25zIScpO1xuICAgIH1cblxuICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgb3B0aW9ucyA9IHsgZmllbGQ6IG9wdGlvbnMgfTtcbiAgICB9XG5cbiAgICBpZiAoIW9wdGlvbnMuZmllbGQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdNaXNzaW5nIGZpZWxkIG5hbWUgaW4gb3B0aW9ucyEnKTtcbiAgICB9XG5cbiAgICBsZXQgc3RhdGVTZXRUaW1lc3RhbXAgPSB7XG4gICAgICAgIHR5cGU6ICdkYXRldGltZScsXG4gICAgICAgIHJlYWRPbmx5OiB0cnVlLFxuICAgICAgICBvcHRpb25hbDogdHJ1ZSxcbiAgICAgICAgYXV0bzogdHJ1ZVxuICAgIH07XG5cbiAgICBpZiAoIW9wdGlvbnMucmV2ZXJzaWJsZSkge1xuICAgICAgICBzdGF0ZVNldFRpbWVzdGFtcC53cml0ZU9uY2UgPSB0cnVlO1xuICAgIH1cblxuICAgIGVudGl0eS5vbignYWZ0ZXJBZGRpbmdGaWVsZHMnLCAoKSA9PiB7XG4gICAgICAgIGlmICghZW50aXR5Lmhhc0ZpZWxkKG9wdGlvbnMuZmllbGQpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZpZWxkIFwiJyArIG9wdGlvbnMuZmllbGQgKyAnXCIgZG9lcyBub3QgZXhpc3QhJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgZmllbGRJbmZvID0gZW50aXR5LmZpZWxkc1tvcHRpb25zLmZpZWxkXTtcblxuICAgICAgICBpZiAoZmllbGRJbmZvLnR5cGUgIT09ICdlbnVtJykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdPbmx5IGVudW0gZmllbGQgY2FuIGJlIHVzZWQgd2l0aCBzdGF0ZVRyYWNraW5nIGZlYXR1cmUhJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgc3RhdGVNYXBwaW5nID0ge307XG5cbiAgICAgICAgZmllbGRJbmZvLnZhbHVlcy5mb3JFYWNoKHN0YXRlID0+IHtcbiAgICAgICAgICAgIGxldCBmaWVsZE5hbWUgPSB0aW1lc3RhbXBGaWVsZE5hbWluZyhvcHRpb25zLmZpZWxkLCBzdGF0ZSk7XG5cbiAgICAgICAgICAgIGVudGl0eS5hZGRGaWVsZChmaWVsZE5hbWUsIHN0YXRlU2V0VGltZXN0YW1wKTtcbiAgICAgICAgICAgIHN0YXRlTWFwcGluZ1tzdGF0ZV0gPSBmaWVsZE5hbWU7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGVudGl0eS5hZGRGZWF0dXJlKEZFQVRVUkVfTkFNRSwge1xuICAgICAgICAgICAgZmllbGQ6IG9wdGlvbnMuZmllbGQsXG4gICAgICAgICAgICBzdGF0ZU1hcHBpbmdcbiAgICAgICAgfSwgdHJ1ZSk7XG4gICAgfSk7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gZmVhdHVyZTsiXX0=