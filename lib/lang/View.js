"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const {
  generateDisplayName,
  deepCloneField,
  Clonable
} = require('./OolUtils');

const Dataset = require('./Dataset');

class View extends Clonable {
  constructor(linker, name, oolModule, info) {
    this.linker = linker;
    this.name = name;
    this.oolModule = oolModule;
    this.info = info;
  }

  link() {
    if (!!this.linked) {
      throw new Error("Function  precondition failed: !this.linked");
    }

    if (this.info.dataset) {
      this.dataset = this.linker.loadDoc(this.oolModule, this.info.dataset);
    } else {
      if (!this.info.entity) {
        throw new Error('Invalid view syntax!');
      }

      let mainEntity = this.linker.getReferencedEntity(this.oolModule, this.info.entity);
      this.dataset = new Dataset(this.linker, mainEntity.name, this.oolModule, {
        mainEntity: mainEntity.name
      });
      this.dataset.link();
    }

    if (this.info.isList) {
      this.isList = true;
    }

    if (!_.isEmpty(this.info.accept)) {
      this.params = this.info.accept.concat();
    }

    if (!_.isEmpty(this.info.selectBy)) {
      this.selectBy = this.info.selectBy.concat();
    }

    if (!_.isEmpty(this.info.groupBy)) {
      this.groupBy = this.info.groupBy.concat();
    }

    if (!_.isEmpty(this.info.orderBy)) {
      this.orderBy = this.info.orderBy.concat();
    }

    if (this.info.skip) {
      this.skip = _.isPlainObject(this.info.skip) ? Object.assign({}, this.info.skip) : this.info.skip;
    }

    if (this.info.limit) {
      this.limit = _.isPlainObject(this.info.limit) ? Object.assign({}, this.info.limit) : this.info.limit;
    }

    this.linked = true;
    return this;
  }

  inferTypeInfo(inSchema) {
    if (!_.isEmpty(this.params)) {
      let inferredParams = [];
      this.params.forEach(param => {
        if (OolUtils.isMemberAccess(param.type)) {
          let [entityName, fieldName] = param.type.split('.');

          if (!inSchema.hasEntity(entityName)) {
            throw new Error(`Parameter "${param.name}" references to an entity "${entityName}" which is not belong to the schema.`);
          }

          let entity = inSchema.entities[entityName];
          let field = entity.getEntityAttribute(fieldName);
          inferredParams.push(Object.assign(_.omit(_.toPlainObject(field), ['isReference', 'optional', 'displayName']), {
            name: param.name
          }));
        } else {
          inferredParams.push(this.linker.trackBackType(this.oolModule, param));
        }
      });
      this.params = inferredParams;
    }
  }

  getDocumentHierarchy(inSchema) {
    return inSchema.getDocumentHierachy(this.oolModule, this.dataset.name);
  }

  clone() {
    super.clone();
    let view = new View(this.linker, this.name, this.oolModule, this.info);
    deepCloneField(this, view, 'dataset');
    deepCloneField(this, view, 'params');
    deepCloneField(this, view, 'selectBy');
    deepCloneField(this, view, 'groupBy');
    deepCloneField(this, view, 'orderBy');
    deepCloneField(this, view, 'skip');
    deepCloneField(this, view, 'limit');
    view.isList = this.isList;
    view.linked = true;
    return view;
  }

  toJSON() {
    return {
      name: this.name,
      dataset: this.dataset.toJSON(),
      isList: this.isList,
      params: this.params,
      selectBy: this.selectBy,
      groupBy: this.groupBy,
      orderBy: this.orderBy,
      skip: this.skip,
      limit: this.limit
    };
  }

}

module.exports = View;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5nL1ZpZXcuanMiXSwibmFtZXMiOlsiXyIsInJlcXVpcmUiLCJnZW5lcmF0ZURpc3BsYXlOYW1lIiwiZGVlcENsb25lRmllbGQiLCJDbG9uYWJsZSIsIkRhdGFzZXQiLCJWaWV3IiwiY29uc3RydWN0b3IiLCJsaW5rZXIiLCJuYW1lIiwib29sTW9kdWxlIiwiaW5mbyIsImxpbmsiLCJsaW5rZWQiLCJkYXRhc2V0IiwibG9hZERvYyIsImVudGl0eSIsIm1haW5FbnRpdHkiLCJnZXRSZWZlcmVuY2VkRW50aXR5IiwiaXNMaXN0IiwiaXNFbXB0eSIsImFjY2VwdCIsInBhcmFtcyIsImNvbmNhdCIsInNlbGVjdEJ5IiwiZ3JvdXBCeSIsIm9yZGVyQnkiLCJza2lwIiwiaXNQbGFpbk9iamVjdCIsIk9iamVjdCIsImFzc2lnbiIsImxpbWl0IiwiaW5mZXJUeXBlSW5mbyIsImluU2NoZW1hIiwiaW5mZXJyZWRQYXJhbXMiLCJmb3JFYWNoIiwicGFyYW0iLCJPb2xVdGlscyIsImlzTWVtYmVyQWNjZXNzIiwidHlwZSIsImVudGl0eU5hbWUiLCJmaWVsZE5hbWUiLCJzcGxpdCIsImhhc0VudGl0eSIsIkVycm9yIiwiZW50aXRpZXMiLCJmaWVsZCIsImdldEVudGl0eUF0dHJpYnV0ZSIsInB1c2giLCJvbWl0IiwidG9QbGFpbk9iamVjdCIsInRyYWNrQmFja1R5cGUiLCJnZXREb2N1bWVudEhpZXJhcmNoeSIsImdldERvY3VtZW50SGllcmFjaHkiLCJjbG9uZSIsInZpZXciLCJ0b0pTT04iLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU07QUFBRUEsRUFBQUE7QUFBRixJQUFRQyxPQUFPLENBQUMsVUFBRCxDQUFyQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBLG1CQUFGO0FBQXVCQyxFQUFBQSxjQUF2QjtBQUF1Q0MsRUFBQUE7QUFBdkMsSUFBb0RILE9BQU8sQ0FBQyxZQUFELENBQWpFOztBQUVBLE1BQU1J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LElBQUFBLElBQUksQ0FBQzFDLE1BQUwsR0FBYyxJQUFkO0FBRUEsV0FBTzBDLElBQVA7QUFDSDs7QUFNREMsRUFBQUEsTUFBTSxHQUFHO0FBQ0wsV0FBTztBQUNIL0MsTUFBQUEsSUFBSSxFQUFFLEtBQUtBLElBRFI7QUFFSEssTUFBQUEsT0FBTyxFQUFFLEtBQUtBLE9BQUwsQ0FBYTBDLE1BQWIsRUFGTjtBQUdIckMsTUFBQUEsTUFBTSxFQUFFLEtBQUtBLE1BSFY7QUFJSEcsTUFBQUEsTUFBTSxFQUFFLEtBQUtBLE1BSlY7QUFLSEUsTUFBQUEsUUFBUSxFQUFFLEtBQUtBLFFBTFo7QUFNSEMsTUFBQUEsT0FBTyxFQUFFLEtBQUtBLE9BTlg7QUFPSEMsTUFBQUEsT0FBTyxFQUFFLEtBQUtBLE9BUFg7QUFRSEMsTUFBQUEsSUFBSSxFQUFFLEtBQUtBLElBUlI7QUFTSEksTUFBQUEsS0FBSyxFQUFFLEtBQUtBO0FBVFQsS0FBUDtBQVdIOztBQTVKdUI7O0FBK0o1QjBCLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnBELElBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IHsgXyB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgZ2VuZXJhdGVEaXNwbGF5TmFtZSwgZGVlcENsb25lRmllbGQsIENsb25hYmxlIH0gPSByZXF1aXJlKCcuL09vbFV0aWxzJyk7XG5cbmNvbnN0IERhdGFzZXQgPSByZXF1aXJlKCcuL0RhdGFzZXQnKTtcblxuLyoqXG4gKiBPb2xvbmcgdmlldyBjbGFzcy5cbiAqIEBjbGFzcyBPb2xvbmdWaWV3XG4gKi9cbmNsYXNzIFZpZXcgZXh0ZW5kcyBDbG9uYWJsZSB7XG5cbiAgICBpc0xpc3QgPSBmYWxzZTtcblxuICAgIC8qKiAgICAgICAgICBcbiAgICAgKiBAcGFyYW0ge09vbG9uZ0xpbmtlcn0gbGlua2VyXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBWaWV3IG5hbWVcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gb29sTW9kdWxlIC0gU291cmNlIG9vbCBtb2R1bGVcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gaW5mbyAtIFZpZXcgaW5mb1xuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKGxpbmtlciwgbmFtZSwgb29sTW9kdWxlLCBpbmZvKSB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBMaW5rZXIgdG8gcHJvY2VzcyB0aGlzIHZpZXdcbiAgICAgICAgICogQG1lbWJlciB7T29sb25nTGlua2VyfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5saW5rZXIgPSBsaW5rZXI7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIE5hbWUgb2YgdGhpcyB2aWV3XG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMubmFtZSA9IG5hbWU7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIE93bmVyIG9vbG9uZyBtb2R1bGVcbiAgICAgICAgICogQG1lbWJlciB7b2JqZWN0fVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5vb2xNb2R1bGUgPSBvb2xNb2R1bGU7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFJhdyBtZXRhZGF0YVxuICAgICAgICAgKiBAbWVtYmVyIHtPYmplY3R9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmluZm8gPSBpbmZvOyAgICAgICAgXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3RhcnQgbGlua2luZyB0aGlzIHZpZXdcbiAgICAgKiBAcmV0dXJucyB7T29sb25nVmlld31cbiAgICAgKi9cbiAgICBsaW5rKCkge1xuICAgICAgICBwcmU6ICF0aGlzLmxpbmtlZDtcblxuICAgICAgICBpZiAodGhpcy5pbmZvLmRhdGFzZXQpIHtcbiAgICAgICAgICAgIHRoaXMuZGF0YXNldCA9IHRoaXMubGlua2VyLmxvYWREb2ModGhpcy5vb2xNb2R1bGUsIHRoaXMuaW5mby5kYXRhc2V0KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGFzc2VydDogdGhpcy5pbmZvLmVudGl0eSwgJ0ludmFsaWQgdmlldyBzeW50YXghJztcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgbGV0IG1haW5FbnRpdHkgPSB0aGlzLmxpbmtlci5nZXRSZWZlcmVuY2VkRW50aXR5KHRoaXMub29sTW9kdWxlLCB0aGlzLmluZm8uZW50aXR5KTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgdGhpcy5kYXRhc2V0ID0gbmV3IERhdGFzZXQodGhpcy5saW5rZXIsIG1haW5FbnRpdHkubmFtZSwgdGhpcy5vb2xNb2R1bGUsIHsgbWFpbkVudGl0eTogbWFpbkVudGl0eS5uYW1lIH0pO1xuICAgICAgICAgICAgdGhpcy5kYXRhc2V0LmxpbmsoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLmluZm8uaXNMaXN0KSB7XG4gICAgICAgICAgICB0aGlzLmlzTGlzdCA9IHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIV8uaXNFbXB0eSh0aGlzLmluZm8uYWNjZXB0KSkge1xuICAgICAgICAgICAgdGhpcy5wYXJhbXMgPSB0aGlzLmluZm8uYWNjZXB0LmNvbmNhdCgpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFfLmlzRW1wdHkodGhpcy5pbmZvLnNlbGVjdEJ5KSkge1xuICAgICAgICAgICAgdGhpcy5zZWxlY3RCeSA9IHRoaXMuaW5mby5zZWxlY3RCeS5jb25jYXQoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghXy5pc0VtcHR5KHRoaXMuaW5mby5ncm91cEJ5KSkge1xuICAgICAgICAgICAgdGhpcy5ncm91cEJ5ID0gdGhpcy5pbmZvLmdyb3VwQnkuY29uY2F0KCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIV8uaXNFbXB0eSh0aGlzLmluZm8ub3JkZXJCeSkpIHtcbiAgICAgICAgICAgIHRoaXMub3JkZXJCeSA9IHRoaXMuaW5mby5vcmRlckJ5LmNvbmNhdCgpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuaW5mby5za2lwKSB7XG4gICAgICAgICAgICB0aGlzLnNraXAgPSBfLmlzUGxhaW5PYmplY3QodGhpcy5pbmZvLnNraXApID8gT2JqZWN0LmFzc2lnbih7fSwgdGhpcy5pbmZvLnNraXApIDogdGhpcy5pbmZvLnNraXA7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5pbmZvLmxpbWl0KSB7XG4gICAgICAgICAgICB0aGlzLmxpbWl0ID0gXy5pc1BsYWluT2JqZWN0KHRoaXMuaW5mby5saW1pdCkgPyBPYmplY3QuYXNzaWduKHt9LCB0aGlzLmluZm8ubGltaXQpIDogdGhpcy5pbmZvLmxpbWl0O1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5saW5rZWQgPSB0cnVlO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGluZmVyVHlwZUluZm8oaW5TY2hlbWEpIHtcbiAgICAgICAgaWYgKCFfLmlzRW1wdHkodGhpcy5wYXJhbXMpKSB7XG4gICAgICAgICAgICBsZXQgaW5mZXJyZWRQYXJhbXMgPSBbXTtcblxuICAgICAgICAgICAgdGhpcy5wYXJhbXMuZm9yRWFjaChwYXJhbSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKE9vbFV0aWxzLmlzTWVtYmVyQWNjZXNzKHBhcmFtLnR5cGUpKSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBbIGVudGl0eU5hbWUsIGZpZWxkTmFtZSBdID0gcGFyYW0udHlwZS5zcGxpdCgnLicpO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmICghaW5TY2hlbWEuaGFzRW50aXR5KGVudGl0eU5hbWUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFBhcmFtZXRlciBcIiR7cGFyYW0ubmFtZX1cIiByZWZlcmVuY2VzIHRvIGFuIGVudGl0eSBcIiR7ZW50aXR5TmFtZX1cIiB3aGljaCBpcyBub3QgYmVsb25nIHRvIHRoZSBzY2hlbWEuYCk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBsZXQgZW50aXR5ID0gaW5TY2hlbWEuZW50aXRpZXNbZW50aXR5TmFtZV07XG4gICAgICAgICAgICAgICAgICAgIC8vY29uc29sZS5kaXIoZW50aXR5LnRvSlNPTigpLCB7ZGVwdGg6IDgsIGNvbG9yczogdHJ1ZX0pO1xuXG4gICAgICAgICAgICAgICAgICAgIGxldCBmaWVsZCA9IGVudGl0eS5nZXRFbnRpdHlBdHRyaWJ1dGUoZmllbGROYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgaW5mZXJyZWRQYXJhbXMucHVzaChPYmplY3QuYXNzaWduKF8ub21pdChfLnRvUGxhaW5PYmplY3QoZmllbGQpLCBbJ2lzUmVmZXJlbmNlJywgJ29wdGlvbmFsJywgJ2Rpc3BsYXlOYW1lJ10pLCB7bmFtZTogcGFyYW0ubmFtZX0pKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpbmZlcnJlZFBhcmFtcy5wdXNoKHRoaXMubGlua2VyLnRyYWNrQmFja1R5cGUodGhpcy5vb2xNb2R1bGUsIHBhcmFtKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHRoaXMucGFyYW1zID0gaW5mZXJyZWRQYXJhbXM7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBnZXREb2N1bWVudEhpZXJhcmNoeShpblNjaGVtYSkge1xuICAgICAgICByZXR1cm4gaW5TY2hlbWEuZ2V0RG9jdW1lbnRIaWVyYWNoeSh0aGlzLm9vbE1vZHVsZSwgdGhpcy5kYXRhc2V0Lm5hbWUpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENsb25lIHRoZSB2aWV3ICAgICBcbiAgICAgKiBAcmV0dXJucyB7T29sb25nVmlld31cbiAgICAgKi9cbiAgICBjbG9uZSgpIHtcbiAgICAgICAgc3VwZXIuY2xvbmUoKTtcbiAgICAgICAgXG4gICAgICAgIGxldCB2aWV3ID0gbmV3IFZpZXcodGhpcy5saW5rZXIsIHRoaXMubmFtZSwgdGhpcy5vb2xNb2R1bGUsIHRoaXMuaW5mbyk7XG5cbiAgICAgICAgZGVlcENsb25lRmllbGQodGhpcywgdmlldywgJ2RhdGFzZXQnKTtcbiAgICAgICAgZGVlcENsb25lRmllbGQodGhpcywgdmlldywgJ3BhcmFtcycpO1xuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCB2aWV3LCAnc2VsZWN0QnknKTtcbiAgICAgICAgZGVlcENsb25lRmllbGQodGhpcywgdmlldywgJ2dyb3VwQnknKTtcbiAgICAgICAgZGVlcENsb25lRmllbGQodGhpcywgdmlldywgJ29yZGVyQnknKTtcbiAgICAgICAgZGVlcENsb25lRmllbGQodGhpcywgdmlldywgJ3NraXAnKTtcbiAgICAgICAgZGVlcENsb25lRmllbGQodGhpcywgdmlldywgJ2xpbWl0Jyk7XG5cbiAgICAgICAgdmlldy5pc0xpc3QgPSB0aGlzLmlzTGlzdDtcbiAgICAgICAgdmlldy5saW5rZWQgPSB0cnVlO1xuXG4gICAgICAgIHJldHVybiB2aWV3O1xuICAgIH1cbiAgICBcbiAgICAvKipcbiAgICAgKiBUcmFuc2xhdGUgdGhlIHZpZXcgaW50byBhIHBsYWluIEpTT04gb2JqZWN0XG4gICAgICogQHJldHVybnMge29iamVjdH1cbiAgICAgKi9cbiAgICB0b0pTT04oKSB7XG4gICAgICAgIHJldHVybiB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBuYW1lOiB0aGlzLm5hbWUsXG4gICAgICAgICAgICBkYXRhc2V0OiB0aGlzLmRhdGFzZXQudG9KU09OKCksXG4gICAgICAgICAgICBpc0xpc3Q6IHRoaXMuaXNMaXN0LFxuICAgICAgICAgICAgcGFyYW1zOiB0aGlzLnBhcmFtcyxcbiAgICAgICAgICAgIHNlbGVjdEJ5OiB0aGlzLnNlbGVjdEJ5LFxuICAgICAgICAgICAgZ3JvdXBCeTogdGhpcy5ncm91cEJ5LFxuICAgICAgICAgICAgb3JkZXJCeTogdGhpcy5vcmRlckJ5LFxuICAgICAgICAgICAgc2tpcDogdGhpcy5za2lwLFxuICAgICAgICAgICAgbGltaXQ6IHRoaXMubGltaXRcbiAgICAgICAgfTtcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gVmlldzsiXX0=