"use strict";

require("source-map-support/register");

const {
  _
} = require('@genx/july');

const {
  tryRequire
} = require('@genx/sys');

const {
  isNothing
} = require('./utils/lang');

const {
  ValidationError
} = require('./utils/Errors');

const validator = require('validator');

const Types = require('./types');

module.exports = _.pick(validator, ['equals', 'contains', 'matches', 'isEmail', 'isURL', 'isMACAddress', 'isIP', 'isFQDN', 'isBoolean', 'isAlpha', 'isAlphanumeric', 'isNumeric', 'isPort', 'isLowercase', 'isUppercase', 'isAscii', 'isFullWidth', 'isHalfWidth', 'isVariableWidth', 'isMultibyte', 'isSurrogatePair', 'isInt', 'isFloat', 'isDecimal', 'isHexadecimal', 'isDivisibleBy', 'isHexColor', 'isISRC', 'isMD5', 'isHash', 'isJSON', 'isEmpty', 'isLength', 'isByteLength', 'isUUID', 'isMongoId', 'isAfter', 'isBefore', 'isIn', 'isCreditCard', 'isISIN', 'isISBN', 'isISSN', 'isMobilePhone', 'isPostalCode', 'isCurrency', 'isISO8601', 'isISO31661Alpha2', 'isBase64', 'isDataURI', 'isMimeType', 'isLatLong']);
const RE_PHONE = /^((\+|00)\d+)?(\(\d+\))?((\ |-)?\d+)*$/;

module.exports.isPhone = function (value) {
  return RE_PHONE.test(value);
};

module.exports.min = function (value, minValue) {
  return value >= minValue;
};

module.exports.max = function (value, maxValue) {
  return value <= maxValue;
};

module.exports.gt = function (value, minValue) {
  return value > minValue;
};

module.exports.lt = function (value, maxValue) {
  return value < maxValue;
};

module.exports.maxLength = function (value, maxLength) {
  return value.length <= maxLength;
};

module.exports.notNull = function (value) {
  return !isNothing(value);
};

module.exports.notNullIf = function (value, condition) {
  return !condition || !isNothing(value);
};

function validate(obj, condition) {
  const {
    Query
  } = tryRequire('mingo', __dirname);
  let query = new Query(condition);
  return query.test(obj);
}

module.exports.validate = validate;
module.exports.validateAny = Types.sanitize;
const NIL = Symbol('nil');

function validateObjectMember(raw, fieldName, fieldInfo, i18n, prefix) {
  if (fieldName in raw) {
    let value = raw[fieldName];

    if (isNothing(value)) {
      var _fieldInfo$default;

      if (!fieldInfo.optional && isNothing(fieldInfo.default)) {
        throw new ValidationError(`Value of property "${prefix ? prefix + '.' : ''}${fieldName}${fieldInfo.comment ? ' - ' + fieldInfo.comment : ''}" cannot be null`);
      }

      return (_fieldInfo$default = fieldInfo.default) !== null && _fieldInfo$default !== void 0 ? _fieldInfo$default : null;
    }

    if (fieldInfo.type) {
      return Types.sanitize(value, fieldInfo, i18n, (prefix ? prefix + '.' : '') + fieldName);
    }

    return value;
  }

  if (!fieldInfo.optional) {
    throw new ValidationError(`Missing required property "${prefix ? prefix + '.' : ''}${fieldName}${fieldInfo.comment ? ' - ' + fieldInfo.comment : ''}"`);
  }

  if ('default' in fieldInfo) {
    return fieldInfo.default;
  }

  return NIL;
}

function validateObjectBySchema(raw, schema, i18n, prefix) {
  let latest = {};

  if (typeof raw !== 'object') {
    throw new ValidationError('The value is not an object.', {
      raw,
      prefix
    });
  }

  _.forOwn(schema, (fieldInfo, fieldName) => {
    if (Array.isArray(fieldInfo)) {
      if (!fieldInfo.find(fieldInfoOption => {
        let validated;
        let hasError = false;

        try {
          validated = validateObjectMember(raw, fieldName, { ...fieldInfoOption,
            skipTypeCast: true
          }, i18n, prefix);
        } catch (error) {
          hasError = true;
          validated = NIL;
        }

        if (validated !== NIL) {
          latest[fieldName] = validated;
        }

        return !hasError;
      })) {
        throw new ValidationError(`Invalid "${fieldName}" value.`, {
          raw,
          prefix
        });
      }
    } else {
      const validated = validateObjectMember(raw, fieldName, fieldInfo, i18n, prefix);

      if (validated !== NIL) {
        latest[fieldName] = validated;
      }
    }
  });

  return latest;
}

module.exports.validateObjectBySchema = validateObjectBySchema;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9WYWxpZGF0b3JzLmpzIl0sIm5hbWVzIjpbIl8iLCJyZXF1aXJlIiwidHJ5UmVxdWlyZSIsImlzTm90aGluZyIsIlZhbGlkYXRpb25FcnJvciIsInZhbGlkYXRvciIsIlR5cGVzIiwibW9kdWxlIiwiZXhwb3J0cyIsInBpY2siLCJSRV9QSE9ORSIsImlzUGhvbmUiLCJ2YWx1ZSIsInRlc3QiLCJtaW4iLCJtaW5WYWx1ZSIsIm1heCIsIm1heFZhbHVlIiwiZ3QiLCJsdCIsIm1heExlbmd0aCIsImxlbmd0aCIsIm5vdE51bGwiLCJub3ROdWxsSWYiLCJjb25kaXRpb24iLCJ2YWxpZGF0ZSIsIm9iaiIsIlF1ZXJ5IiwiX19kaXJuYW1lIiwicXVlcnkiLCJ2YWxpZGF0ZUFueSIsInNhbml0aXplIiwiTklMIiwiU3ltYm9sIiwidmFsaWRhdGVPYmplY3RNZW1iZXIiLCJyYXciLCJmaWVsZE5hbWUiLCJmaWVsZEluZm8iLCJpMThuIiwicHJlZml4Iiwib3B0aW9uYWwiLCJkZWZhdWx0IiwiY29tbWVudCIsInR5cGUiLCJ2YWxpZGF0ZU9iamVjdEJ5U2NoZW1hIiwic2NoZW1hIiwibGF0ZXN0IiwiZm9yT3duIiwiQXJyYXkiLCJpc0FycmF5IiwiZmluZCIsImZpZWxkSW5mb09wdGlvbiIsInZhbGlkYXRlZCIsImhhc0Vycm9yIiwic2tpcFR5cGVDYXN0IiwiZXJyb3IiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTTtBQUFFQSxFQUFBQTtBQUFGLElBQVFDLE9BQU8sQ0FBQyxZQUFELENBQXJCOztBQUNBLE1BQU07QUFBRUMsRUFBQUE7QUFBRixJQUFpQkQsT0FBTyxDQUFDLFdBQUQsQ0FBOUI7O0FBQ0EsTUFBTTtBQUFFRSxFQUFBQTtBQUFGLElBQWdCRixPQUFPLENBQUMsY0FBRCxDQUE3Qjs7QUFDQSxNQUFNO0FBQUVHLEVBQUFBO0FBQUYsSUFBc0JILE9BQU8sQ0FBQyxnQkFBRCxDQUFuQzs7QUFDQSxNQUFNSSxTQUFTLEdBQUdKLE9BQU8sQ0FBQyxXQUFELENBQXpCOztBQUNBLE1BQU1LLEtBQUssR0FBR0wsT0FBTyxDQUFDLFNBQUQsQ0FBckI7O0FBRUFNLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQlIsQ0FBQyxDQUFDUyxJQUFGLENBQU9KLFNBQVAsRUFBa0IsQ0FDL0IsUUFEK0IsRUFFL0IsVUFGK0IsRUFHL0IsU0FIK0IsRUFJL0IsU0FKK0IsRUFLL0IsT0FMK0IsRUFNL0IsY0FOK0IsRUFPL0IsTUFQK0IsRUFRL0IsUUFSK0IsRUFTL0IsV0FUK0IsRUFVL0IsU0FWK0IsRUFXL0IsZ0JBWCtCLEVBWS9CLFdBWitCLEVBYS9CLFFBYitCLEVBYy9CLGFBZCtCLEVBZS9CLGFBZitCLEVBZ0IvQixTQWhCK0IsRUFpQi9CLGFBakIrQixFQWtCL0IsYUFsQitCLEVBbUIvQixpQkFuQitCLEVBb0IvQixhQXBCK0IsRUFxQi9CLGlCQXJCK0IsRUFzQi9CLE9BdEIrQixFQXVCL0IsU0F2QitCLEVBd0IvQixXQXhCK0IsRUF5Qi9CLGVBekIrQixFQTBCL0IsZUExQitCLEVBMkIvQixZQTNCK0IsRUE0Qi9CLFFBNUIrQixFQTZCL0IsT0E3QitCLEVBOEIvQixRQTlCK0IsRUErQi9CLFFBL0IrQixFQWdDL0IsU0FoQytCLEVBaUMvQixVQWpDK0IsRUFrQy9CLGNBbEMrQixFQW1DL0IsUUFuQytCLEVBb0MvQixXQXBDK0IsRUFxQy9CLFNBckMrQixFQXNDL0IsVUF0QytCLEVBdUMvQixNQXZDK0IsRUF3Qy9CLGNBeEMrQixFQXlDL0IsUUF6QytCLEVBMEMvQixRQTFDK0IsRUEyQy9CLFFBM0MrQixFQTRDL0IsZUE1QytCLEVBNkMvQixjQTdDK0IsRUE4Qy9CLFlBOUMrQixFQStDL0IsV0EvQytCLEVBZ0QvQixrQkFoRCtCLEVBaUQvQixVQWpEK0IsRUFrRC9CLFdBbEQrQixFQW1EL0IsWUFuRCtCLEVBb0QvQixXQXBEK0IsQ0FBbEIsQ0FBakI7QUF1REEsTUFBTUssUUFBUSxHQUFHLHdDQUFqQjs7QUFFQUgsTUFBTSxDQUFDQyxPQUFQLENBQWVHLE9BQWYsR0FBeUIsVUFBVUMsS0FBVixFQUFpQjtBQUN0QyxTQUFPRixRQUFRLENBQUNHLElBQVQsQ0FBY0QsS0FBZCxDQUFQO0FBQ0gsQ0FGRDs7QUFJQUwsTUFBTSxDQUFDQyxPQUFQLENBQWVNLEdBQWYsR0FBcUIsVUFBVUYsS0FBVixFQUFpQkcsUUFBakIsRUFBMkI7QUFDNUMsU0FBT0gsS0FBSyxJQUFJRyxRQUFoQjtBQUNILENBRkQ7O0FBSUFSLE1BQU0sQ0FBQ0MsT0FBUCxDQUFlUSxHQUFmLEdBQXFCLFVBQVVKLEtBQVYsRUFBaUJLLFFBQWpCLEVBQTJCO0FBQzVDLFNBQU9MLEtBQUssSUFBSUssUUFBaEI7QUFDSCxDQUZEOztBQUlBVixNQUFNLENBQUNDLE9BQVAsQ0FBZVUsRUFBZixHQUFvQixVQUFVTixLQUFWLEVBQWlCRyxRQUFqQixFQUEyQjtBQUMzQyxTQUFPSCxLQUFLLEdBQUdHLFFBQWY7QUFDSCxDQUZEOztBQUlBUixNQUFNLENBQUNDLE9BQVAsQ0FBZVcsRUFBZixHQUFvQixVQUFVUCxLQUFWLEVBQWlCSyxRQUFqQixFQUEyQjtBQUMzQyxTQUFPTCxLQUFLLEdBQUdLLFFBQWY7QUFDSCxDQUZEOztBQUlBVixNQUFNLENBQUNDLE9BQVAsQ0FBZVksU0FBZixHQUEyQixVQUFVUixLQUFWLEVBQWlCUSxTQUFqQixFQUE0QjtBQUNuRCxTQUFPUixLQUFLLENBQUNTLE1BQU4sSUFBZ0JELFNBQXZCO0FBQ0gsQ0FGRDs7QUFJQWIsTUFBTSxDQUFDQyxPQUFQLENBQWVjLE9BQWYsR0FBeUIsVUFBVVYsS0FBVixFQUFpQjtBQUN0QyxTQUFPLENBQUNULFNBQVMsQ0FBQ1MsS0FBRCxDQUFqQjtBQUNILENBRkQ7O0FBSUFMLE1BQU0sQ0FBQ0MsT0FBUCxDQUFlZSxTQUFmLEdBQTJCLFVBQVVYLEtBQVYsRUFBaUJZLFNBQWpCLEVBQTRCO0FBQ25ELFNBQU8sQ0FBQ0EsU0FBRCxJQUFjLENBQUNyQixTQUFTLENBQUNTLEtBQUQsQ0FBL0I7QUFDSCxDQUZEOztBQVVBLFNBQVNhLFFBQVQsQ0FBa0JDLEdBQWxCLEVBQXVCRixTQUF2QixFQUFrQztBQUM5QixRQUFNO0FBQUVHLElBQUFBO0FBQUYsTUFBWXpCLFVBQVUsQ0FBQyxPQUFELEVBQVUwQixTQUFWLENBQTVCO0FBQ0EsTUFBSUMsS0FBSyxHQUFHLElBQUlGLEtBQUosQ0FBVUgsU0FBVixDQUFaO0FBR0EsU0FBT0ssS0FBSyxDQUFDaEIsSUFBTixDQUFXYSxHQUFYLENBQVA7QUFDSDs7QUFFRG5CLE1BQU0sQ0FBQ0MsT0FBUCxDQUFlaUIsUUFBZixHQUEwQkEsUUFBMUI7QUFFQWxCLE1BQU0sQ0FBQ0MsT0FBUCxDQUFlc0IsV0FBZixHQUE2QnhCLEtBQUssQ0FBQ3lCLFFBQW5DO0FBRUEsTUFBTUMsR0FBRyxHQUFHQyxNQUFNLENBQUMsS0FBRCxDQUFsQjs7QUFFQSxTQUFTQyxvQkFBVCxDQUE4QkMsR0FBOUIsRUFBbUNDLFNBQW5DLEVBQThDQyxTQUE5QyxFQUF5REMsSUFBekQsRUFBK0RDLE1BQS9ELEVBQXVFO0FBQ25FLE1BQUlILFNBQVMsSUFBSUQsR0FBakIsRUFBc0I7QUFDbEIsUUFBSXZCLEtBQUssR0FBR3VCLEdBQUcsQ0FBQ0MsU0FBRCxDQUFmOztBQUdBLFFBQUlqQyxTQUFTLENBQUNTLEtBQUQsQ0FBYixFQUFzQjtBQUFBOztBQUNsQixVQUFJLENBQUN5QixTQUFTLENBQUNHLFFBQVgsSUFBdUJyQyxTQUFTLENBQUNrQyxTQUFTLENBQUNJLE9BQVgsQ0FBcEMsRUFBeUQ7QUFDckQsY0FBTSxJQUFJckMsZUFBSixDQUFxQixzQkFBcUJtQyxNQUFNLEdBQUdBLE1BQU0sR0FBRyxHQUFaLEdBQWtCLEVBQUcsR0FBRUgsU0FBVSxHQUFFQyxTQUFTLENBQUNLLE9BQVYsR0FBb0IsUUFBUUwsU0FBUyxDQUFDSyxPQUF0QyxHQUFnRCxFQUFHLGtCQUF0SSxDQUFOO0FBQ0g7O0FBRUQsbUNBQU9MLFNBQVMsQ0FBQ0ksT0FBakIsbUVBQTRCLElBQTVCO0FBQ0g7O0FBRUQsUUFBSUosU0FBUyxDQUFDTSxJQUFkLEVBQW9CO0FBQ2hCLGFBQU9yQyxLQUFLLENBQUN5QixRQUFOLENBQWVuQixLQUFmLEVBQXNCeUIsU0FBdEIsRUFBaUNDLElBQWpDLEVBQXVDLENBQUNDLE1BQU0sR0FBR0EsTUFBTSxHQUFHLEdBQVosR0FBa0IsRUFBekIsSUFBK0JILFNBQXRFLENBQVA7QUFDSDs7QUFFRCxXQUFPeEIsS0FBUDtBQUNIOztBQUVELE1BQUksQ0FBQ3lCLFNBQVMsQ0FBQ0csUUFBZixFQUF5QjtBQUNyQixVQUFNLElBQUlwQyxlQUFKLENBQXFCLDhCQUE2Qm1DLE1BQU0sR0FBR0EsTUFBTSxHQUFHLEdBQVosR0FBa0IsRUFBRyxHQUFFSCxTQUFVLEdBQUVDLFNBQVMsQ0FBQ0ssT0FBVixHQUFvQixRQUFRTCxTQUFTLENBQUNLLE9BQXRDLEdBQWdELEVBQUcsR0FBOUksQ0FBTjtBQUNIOztBQUVELE1BQUksYUFBYUwsU0FBakIsRUFBNEI7QUFDeEIsV0FBT0EsU0FBUyxDQUFDSSxPQUFqQjtBQUNIOztBQUVELFNBQU9ULEdBQVA7QUFDSDs7QUFFRCxTQUFTWSxzQkFBVCxDQUFnQ1QsR0FBaEMsRUFBcUNVLE1BQXJDLEVBQTZDUCxJQUE3QyxFQUFtREMsTUFBbkQsRUFBMkQ7QUFDdkQsTUFBSU8sTUFBTSxHQUFHLEVBQWI7O0FBRUEsTUFBSSxPQUFPWCxHQUFQLEtBQWUsUUFBbkIsRUFBNkI7QUFDekIsVUFBTSxJQUFJL0IsZUFBSixDQUFvQiw2QkFBcEIsRUFBbUQ7QUFDckQrQixNQUFBQSxHQURxRDtBQUVyREksTUFBQUE7QUFGcUQsS0FBbkQsQ0FBTjtBQUlIOztBQUVEdkMsRUFBQUEsQ0FBQyxDQUFDK0MsTUFBRixDQUFTRixNQUFULEVBQWlCLENBQUNSLFNBQUQsRUFBWUQsU0FBWixLQUEwQjtBQUN2QyxRQUFJWSxLQUFLLENBQUNDLE9BQU4sQ0FBY1osU0FBZCxDQUFKLEVBQThCO0FBQzFCLFVBQUksQ0FBQ0EsU0FBUyxDQUFDYSxJQUFWLENBQWVDLGVBQWUsSUFBSTtBQUNuQyxZQUFJQyxTQUFKO0FBQ0EsWUFBSUMsUUFBUSxHQUFHLEtBQWY7O0FBRUEsWUFBSTtBQUNBRCxVQUFBQSxTQUFTLEdBQUdsQixvQkFBb0IsQ0FBQ0MsR0FBRCxFQUFNQyxTQUFOLEVBQWlCLEVBQUUsR0FBR2UsZUFBTDtBQUFzQkcsWUFBQUEsWUFBWSxFQUFFO0FBQXBDLFdBQWpCLEVBQTZEaEIsSUFBN0QsRUFBbUVDLE1BQW5FLENBQWhDO0FBQ0gsU0FGRCxDQUVFLE9BQU9nQixLQUFQLEVBQWM7QUFDWkYsVUFBQUEsUUFBUSxHQUFHLElBQVg7QUFDQUQsVUFBQUEsU0FBUyxHQUFHcEIsR0FBWjtBQUNIOztBQUVELFlBQUlvQixTQUFTLEtBQUtwQixHQUFsQixFQUF1QjtBQUNuQmMsVUFBQUEsTUFBTSxDQUFDVixTQUFELENBQU4sR0FBb0JnQixTQUFwQjtBQUNIOztBQUVELGVBQU8sQ0FBQ0MsUUFBUjtBQUNILE9BaEJJLENBQUwsRUFnQkk7QUFDQSxjQUFNLElBQUlqRCxlQUFKLENBQXFCLFlBQVdnQyxTQUFVLFVBQTFDLEVBQXFEO0FBQ3ZERCxVQUFBQSxHQUR1RDtBQUV2REksVUFBQUE7QUFGdUQsU0FBckQsQ0FBTjtBQUlIO0FBRUosS0F4QkQsTUF3Qk87QUFDSCxZQUFNYSxTQUFTLEdBQUdsQixvQkFBb0IsQ0FBQ0MsR0FBRCxFQUFNQyxTQUFOLEVBQWlCQyxTQUFqQixFQUE0QkMsSUFBNUIsRUFBa0NDLE1BQWxDLENBQXRDOztBQUNBLFVBQUlhLFNBQVMsS0FBS3BCLEdBQWxCLEVBQXVCO0FBQ25CYyxRQUFBQSxNQUFNLENBQUNWLFNBQUQsQ0FBTixHQUFvQmdCLFNBQXBCO0FBQ0g7QUFDSjtBQUNKLEdBL0JEOztBQWlDQSxTQUFPTixNQUFQO0FBQ0g7O0FBRUR2QyxNQUFNLENBQUNDLE9BQVAsQ0FBZW9DLHNCQUFmLEdBQXdDQSxzQkFBeEMiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgeyBfIH0gPSByZXF1aXJlKCdAZ2VueC9qdWx5Jyk7XG5jb25zdCB7IHRyeVJlcXVpcmUgfSA9IHJlcXVpcmUoJ0BnZW54L3N5cycpO1xuY29uc3QgeyBpc05vdGhpbmcgfSA9IHJlcXVpcmUoJy4vdXRpbHMvbGFuZycpO1xuY29uc3QgeyBWYWxpZGF0aW9uRXJyb3IgfSA9IHJlcXVpcmUoJy4vdXRpbHMvRXJyb3JzJyk7XG5jb25zdCB2YWxpZGF0b3IgPSByZXF1aXJlKCd2YWxpZGF0b3InKTtcbmNvbnN0IFR5cGVzID0gcmVxdWlyZSgnLi90eXBlcycpO1xuXG5tb2R1bGUuZXhwb3J0cyA9IF8ucGljayh2YWxpZGF0b3IsIFsgXG4gICAgJ2VxdWFscycsXG4gICAgJ2NvbnRhaW5zJyxcbiAgICAnbWF0Y2hlcycsXG4gICAgJ2lzRW1haWwnLFxuICAgICdpc1VSTCcsXG4gICAgJ2lzTUFDQWRkcmVzcycsXG4gICAgJ2lzSVAnLFxuICAgICdpc0ZRRE4nLFxuICAgICdpc0Jvb2xlYW4nLFxuICAgICdpc0FscGhhJyxcbiAgICAnaXNBbHBoYW51bWVyaWMnLFxuICAgICdpc051bWVyaWMnLFxuICAgICdpc1BvcnQnLFxuICAgICdpc0xvd2VyY2FzZScsXG4gICAgJ2lzVXBwZXJjYXNlJyxcbiAgICAnaXNBc2NpaScsXG4gICAgJ2lzRnVsbFdpZHRoJyxcbiAgICAnaXNIYWxmV2lkdGgnLFxuICAgICdpc1ZhcmlhYmxlV2lkdGgnLFxuICAgICdpc011bHRpYnl0ZScsXG4gICAgJ2lzU3Vycm9nYXRlUGFpcicsXG4gICAgJ2lzSW50JyxcbiAgICAnaXNGbG9hdCcsXG4gICAgJ2lzRGVjaW1hbCcsXG4gICAgJ2lzSGV4YWRlY2ltYWwnLFxuICAgICdpc0RpdmlzaWJsZUJ5JyxcbiAgICAnaXNIZXhDb2xvcicsXG4gICAgJ2lzSVNSQycsXG4gICAgJ2lzTUQ1JyxcbiAgICAnaXNIYXNoJyxcbiAgICAnaXNKU09OJyxcbiAgICAnaXNFbXB0eScsXG4gICAgJ2lzTGVuZ3RoJyxcbiAgICAnaXNCeXRlTGVuZ3RoJyxcbiAgICAnaXNVVUlEJyxcbiAgICAnaXNNb25nb0lkJyxcbiAgICAnaXNBZnRlcicsXG4gICAgJ2lzQmVmb3JlJyxcbiAgICAnaXNJbicsXG4gICAgJ2lzQ3JlZGl0Q2FyZCcsXG4gICAgJ2lzSVNJTicsXG4gICAgJ2lzSVNCTicsXG4gICAgJ2lzSVNTTicsXG4gICAgJ2lzTW9iaWxlUGhvbmUnLFxuICAgICdpc1Bvc3RhbENvZGUnLFxuICAgICdpc0N1cnJlbmN5JyxcbiAgICAnaXNJU084NjAxJyxcbiAgICAnaXNJU08zMTY2MUFscGhhMicsXG4gICAgJ2lzQmFzZTY0JyxcbiAgICAnaXNEYXRhVVJJJyxcbiAgICAnaXNNaW1lVHlwZScsXG4gICAgJ2lzTGF0TG9uZydcbl0pO1xuXG5jb25zdCBSRV9QSE9ORSA9IC9eKChcXCt8MDApXFxkKyk/KFxcKFxcZCtcXCkpPygoXFwgfC0pP1xcZCspKiQvO1xuXG5tb2R1bGUuZXhwb3J0cy5pc1Bob25lID0gZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgcmV0dXJuIFJFX1BIT05FLnRlc3QodmFsdWUpO1xufVxuXG5tb2R1bGUuZXhwb3J0cy5taW4gPSBmdW5jdGlvbiAodmFsdWUsIG1pblZhbHVlKSB7XG4gICAgcmV0dXJuIHZhbHVlID49IG1pblZhbHVlO1xufTtcblxubW9kdWxlLmV4cG9ydHMubWF4ID0gZnVuY3Rpb24gKHZhbHVlLCBtYXhWYWx1ZSkge1xuICAgIHJldHVybiB2YWx1ZSA8PSBtYXhWYWx1ZTtcbn07XG5cbm1vZHVsZS5leHBvcnRzLmd0ID0gZnVuY3Rpb24gKHZhbHVlLCBtaW5WYWx1ZSkge1xuICAgIHJldHVybiB2YWx1ZSA+IG1pblZhbHVlO1xufTtcblxubW9kdWxlLmV4cG9ydHMubHQgPSBmdW5jdGlvbiAodmFsdWUsIG1heFZhbHVlKSB7XG4gICAgcmV0dXJuIHZhbHVlIDwgbWF4VmFsdWU7XG59O1xuXG5tb2R1bGUuZXhwb3J0cy5tYXhMZW5ndGggPSBmdW5jdGlvbiAodmFsdWUsIG1heExlbmd0aCkge1xuICAgIHJldHVybiB2YWx1ZS5sZW5ndGggPD0gbWF4TGVuZ3RoO1xufTtcblxubW9kdWxlLmV4cG9ydHMubm90TnVsbCA9IGZ1bmN0aW9uICh2YWx1ZSkge1xuICAgIHJldHVybiAhaXNOb3RoaW5nKHZhbHVlKTtcbn07XG5cbm1vZHVsZS5leHBvcnRzLm5vdE51bGxJZiA9IGZ1bmN0aW9uICh2YWx1ZSwgY29uZGl0aW9uKSB7XG4gICAgcmV0dXJuICFjb25kaXRpb24gfHwgIWlzTm90aGluZyh2YWx1ZSk7XG59O1xuXG4vKipcbiAqIFZhbGlkYXRlIGFuIG9iaiB3aXRoIGNvbmRpdGlvbiBsaWtlIG1vbmdvLXN0eWxlIHF1ZXJ5XG4gKiBAcGFyYW0geyp9IG9iaiBcbiAqIEBwYXJhbSB7YXJyYXl8b2JqZWN0fSBjb25kaXRpb24gXG4gKiBAcmV0dXJucyB7Ym9vbGVhbn1cbiAqL1xuZnVuY3Rpb24gdmFsaWRhdGUob2JqLCBjb25kaXRpb24pIHsgICAgXG4gICAgY29uc3QgeyBRdWVyeSB9ID0gdHJ5UmVxdWlyZSgnbWluZ28nLCBfX2Rpcm5hbWUpO1xuICAgIGxldCBxdWVyeSA9IG5ldyBRdWVyeShjb25kaXRpb24pO1xuICAgIFxuICAgIC8vIHRlc3QgaWYgYW4gb2JqZWN0IG1hdGNoZXMgcXVlcnlcbiAgICByZXR1cm4gcXVlcnkudGVzdChvYmopO1xufVxuXG5tb2R1bGUuZXhwb3J0cy52YWxpZGF0ZSA9IHZhbGlkYXRlO1xuXG5tb2R1bGUuZXhwb3J0cy52YWxpZGF0ZUFueSA9IFR5cGVzLnNhbml0aXplO1xuXG5jb25zdCBOSUwgPSBTeW1ib2woJ25pbCcpO1xuXG5mdW5jdGlvbiB2YWxpZGF0ZU9iamVjdE1lbWJlcihyYXcsIGZpZWxkTmFtZSwgZmllbGRJbmZvLCBpMThuLCBwcmVmaXgpIHtcbiAgICBpZiAoZmllbGROYW1lIGluIHJhdykge1xuICAgICAgICBsZXQgdmFsdWUgPSByYXdbZmllbGROYW1lXTtcbiAgICAgICAgXG4gICAgICAgIC8vc2FuaXRpemUgZmlyc3RcbiAgICAgICAgaWYgKGlzTm90aGluZyh2YWx1ZSkpIHtcbiAgICAgICAgICAgIGlmICghZmllbGRJbmZvLm9wdGlvbmFsICYmIGlzTm90aGluZyhmaWVsZEluZm8uZGVmYXVsdCkpIHsgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKGBWYWx1ZSBvZiBwcm9wZXJ0eSBcIiR7cHJlZml4ID8gcHJlZml4ICsgJy4nIDogJyd9JHtmaWVsZE5hbWV9JHtmaWVsZEluZm8uY29tbWVudCA/ICcgLSAnICsgZmllbGRJbmZvLmNvbW1lbnQgOiAnJ31cIiBjYW5ub3QgYmUgbnVsbGApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gZmllbGRJbmZvLmRlZmF1bHQgPz8gbnVsbDtcbiAgICAgICAgfSBcbiAgICAgICAgXG4gICAgICAgIGlmIChmaWVsZEluZm8udHlwZSkge1xuICAgICAgICAgICAgcmV0dXJuIFR5cGVzLnNhbml0aXplKHZhbHVlLCBmaWVsZEluZm8sIGkxOG4sIChwcmVmaXggPyBwcmVmaXggKyAnLicgOiAnJykgKyBmaWVsZE5hbWUpO1xuICAgICAgICB9IFxuXG4gICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9ICAgICAgIFxuXG4gICAgaWYgKCFmaWVsZEluZm8ub3B0aW9uYWwpIHtcbiAgICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcihgTWlzc2luZyByZXF1aXJlZCBwcm9wZXJ0eSBcIiR7cHJlZml4ID8gcHJlZml4ICsgJy4nIDogJyd9JHtmaWVsZE5hbWV9JHtmaWVsZEluZm8uY29tbWVudCA/ICcgLSAnICsgZmllbGRJbmZvLmNvbW1lbnQgOiAnJ31cImApO1xuICAgIH0gICAgICAgIFxuXG4gICAgaWYgKCdkZWZhdWx0JyBpbiBmaWVsZEluZm8pIHtcbiAgICAgICAgcmV0dXJuIGZpZWxkSW5mby5kZWZhdWx0O1xuICAgIH1cblxuICAgIHJldHVybiBOSUw7XG59XG5cbmZ1bmN0aW9uIHZhbGlkYXRlT2JqZWN0QnlTY2hlbWEocmF3LCBzY2hlbWEsIGkxOG4sIHByZWZpeCkgeyAgIFxuICAgIGxldCBsYXRlc3QgPSB7fTsgICAgXG5cbiAgICBpZiAodHlwZW9mIHJhdyAhPT0gJ29iamVjdCcpIHtcbiAgICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcignVGhlIHZhbHVlIGlzIG5vdCBhbiBvYmplY3QuJywge1xuICAgICAgICAgICAgcmF3LFxuICAgICAgICAgICAgcHJlZml4XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIF8uZm9yT3duKHNjaGVtYSwgKGZpZWxkSW5mbywgZmllbGROYW1lKSA9PiB7ICBcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZmllbGRJbmZvKSkge1xuICAgICAgICAgICAgaWYgKCFmaWVsZEluZm8uZmluZChmaWVsZEluZm9PcHRpb24gPT4ge1xuICAgICAgICAgICAgICAgIGxldCB2YWxpZGF0ZWQ7XG4gICAgICAgICAgICAgICAgbGV0IGhhc0Vycm9yID0gZmFsc2U7XG5cbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICB2YWxpZGF0ZWQgPSB2YWxpZGF0ZU9iamVjdE1lbWJlcihyYXcsIGZpZWxkTmFtZSwgeyAuLi5maWVsZEluZm9PcHRpb24sIHNraXBUeXBlQ2FzdDogdHJ1ZSB9LCBpMThuLCBwcmVmaXgpO1xuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaGFzRXJyb3IgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB2YWxpZGF0ZWQgPSBOSUw7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKHZhbGlkYXRlZCAhPT0gTklMKSB7XG4gICAgICAgICAgICAgICAgICAgIGxhdGVzdFtmaWVsZE5hbWVdID0gdmFsaWRhdGVkOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfSAgXG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgcmV0dXJuICFoYXNFcnJvcjtcbiAgICAgICAgICAgIH0pKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcihgSW52YWxpZCBcIiR7ZmllbGROYW1lfVwiIHZhbHVlLmAsIHtcbiAgICAgICAgICAgICAgICAgICAgcmF3LFxuICAgICAgICAgICAgICAgICAgICBwcmVmaXhcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gICBcblxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgdmFsaWRhdGVkID0gdmFsaWRhdGVPYmplY3RNZW1iZXIocmF3LCBmaWVsZE5hbWUsIGZpZWxkSW5mbywgaTE4biwgcHJlZml4KTtcbiAgICAgICAgICAgIGlmICh2YWxpZGF0ZWQgIT09IE5JTCkge1xuICAgICAgICAgICAgICAgIGxhdGVzdFtmaWVsZE5hbWVdID0gdmFsaWRhdGVkO1xuICAgICAgICAgICAgfSAgICAgIFxuICAgICAgICB9ICAgICAgICAgICBcbiAgICB9KTtcblxuICAgIHJldHVybiBsYXRlc3Q7XG59XG5cbm1vZHVsZS5leHBvcnRzLnZhbGlkYXRlT2JqZWN0QnlTY2hlbWEgPSB2YWxpZGF0ZU9iamVjdEJ5U2NoZW1hOyJdfQ==