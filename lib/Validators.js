"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const {
  _
} = Util;

const {
  isNothing
} = require('./utils/lang');

const {
  tryRequire
} = require('./utils/lib');

const {
  ValidationError
} = require('./utils/Errors');

const validator = require('validator');

const Types = require('./types');

module.exports = _.pick(validator, ['equals', 'contains', 'matches', 'isEmail', 'isURL', 'isMACAddress', 'isIP', 'isFQDN', 'isBoolean', 'isAlpha', 'isAlphanumeric', 'isNumeric', 'isPort', 'isLowercase', 'isUppercase', 'isAscii', 'isFullWidth', 'isHalfWidth', 'isVariableWidth', 'isMultibyte', 'isSurrogatePair', 'isInt', 'isFloat', 'isDecimal', 'isHexadecimal', 'isDivisibleBy', 'isHexColor', 'isISRC', 'isMD5', 'isHash', 'isJSON', 'isEmpty', 'isLength', 'isByteLength', 'isUUID', 'isMongoId', 'isAfter', 'isBefore', 'isIn', 'isCreditCard', 'isISIN', 'isISBN', 'isISSN', 'isMobilePhone', 'isPostalCode', 'isCurrency', 'isISO8601', 'isISO31661Alpha2', 'isBase64', 'isDataURI', 'isMimeType', 'isLatLong']);
const RE_PHONE = /^((\+|00)\d+)?(\(\d+\))?((\ |-)?\d+)*$/;

module.exports.isPhone = function (value) {
  return RE_PHONE.test(value);
};

module.exports.min = function (value, minValue) {
  return value >= minValue;
};

module.exports.max = function (value, maxValue) {
  return value <= maxValue;
};

module.exports.gt = function (value, minValue) {
  return value > minValue;
};

module.exports.lt = function (value, maxValue) {
  return value < maxValue;
};

module.exports.maxLength = function (value, maxLength) {
  return value.length <= maxLength;
};

module.exports.notNull = function (value) {
  return !isNothing(value);
};

module.exports.notNullIf = function (value, condition) {
  return !condition || !isNothing(value);
};

function validate(obj, condition) {
  const {
    Query
  } = tryRequire('mingo');
  let query = new Query(condition);
  return query.test(obj);
}

module.exports.validate = validate;
module.exports.validateAny = Types.sanitize;

function validateObjectBySchema(raw, schema, i18n, prefix) {
  let latest = {};

  _.forOwn(schema, (fieldInfo, fieldName) => {
    if (fieldName in raw) {
      let value = raw[fieldName];

      if (isNothing(value)) {
        var _fieldInfo$default;

        if (!fieldInfo.optional && isNothing(fieldInfo.default)) {
          throw new ValidationError(`Value of property "${prefix ? prefix + '.' : ''}${fieldName}${fieldInfo.comment ? ' - ' + fieldInfo.comment : ''}" cannot be null`);
        }

        latest[fieldName] = (_fieldInfo$default = fieldInfo.default) !== null && _fieldInfo$default !== void 0 ? _fieldInfo$default : null;
      } else {
        if (fieldInfo.type) {
          latest[fieldName] = Types.sanitize(value, fieldInfo, i18n, (prefix ? prefix + '.' : '') + fieldName);
        } else {
          latest[fieldName] = value;
        }
      }

      return;
    }

    if (!fieldInfo.optional) {
      throw new ValidationError(`Missing required property "${prefix ? prefix + '.' : ''}${fieldName}${fieldInfo.comment ? ' - ' + fieldInfo.comment : ''}"`);
    }

    if ('default' in fieldInfo) {
      latest[fieldName] = fieldInfo.default;
    }
  });

  return latest;
}

module.exports.validateObjectBySchema = validateObjectBySchema;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9WYWxpZGF0b3JzLmpzIl0sIm5hbWVzIjpbIlV0aWwiLCJyZXF1aXJlIiwiXyIsImlzTm90aGluZyIsInRyeVJlcXVpcmUiLCJWYWxpZGF0aW9uRXJyb3IiLCJ2YWxpZGF0b3IiLCJUeXBlcyIsIm1vZHVsZSIsImV4cG9ydHMiLCJwaWNrIiwiUkVfUEhPTkUiLCJpc1Bob25lIiwidmFsdWUiLCJ0ZXN0IiwibWluIiwibWluVmFsdWUiLCJtYXgiLCJtYXhWYWx1ZSIsImd0IiwibHQiLCJtYXhMZW5ndGgiLCJsZW5ndGgiLCJub3ROdWxsIiwibm90TnVsbElmIiwiY29uZGl0aW9uIiwidmFsaWRhdGUiLCJvYmoiLCJRdWVyeSIsInF1ZXJ5IiwidmFsaWRhdGVBbnkiLCJzYW5pdGl6ZSIsInZhbGlkYXRlT2JqZWN0QnlTY2hlbWEiLCJyYXciLCJzY2hlbWEiLCJpMThuIiwicHJlZml4IiwibGF0ZXN0IiwiZm9yT3duIiwiZmllbGRJbmZvIiwiZmllbGROYW1lIiwib3B0aW9uYWwiLCJkZWZhdWx0IiwiY29tbWVudCIsInR5cGUiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsVUFBRCxDQUFwQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBO0FBQUYsSUFBUUYsSUFBZDs7QUFDQSxNQUFNO0FBQUVHLEVBQUFBO0FBQUYsSUFBZ0JGLE9BQU8sQ0FBQyxjQUFELENBQTdCOztBQUNBLE1BQU07QUFBRUcsRUFBQUE7QUFBRixJQUFpQkgsT0FBTyxDQUFDLGFBQUQsQ0FBOUI7O0FBQ0EsTUFBTTtBQUFFSSxFQUFBQTtBQUFGLElBQXNCSixPQUFPLENBQUMsZ0JBQUQsQ0FBbkM7O0FBQ0EsTUFBTUssU0FBUyxHQUFHTCxPQUFPLENBQUMsV0FBRCxDQUF6Qjs7QUFDQSxNQUFNTSxLQUFLLEdBQUdOLE9BQU8sQ0FBQyxTQUFELENBQXJCOztBQUVBTyxNQUFNLENBQUNDLE9BQVAsR0FBaUJQLENBQUMsQ0FBQ1EsSUFB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QUssQ0FBQ3dCLFFBQU4sQ0FBZWxCLEtBQWYsRUFBc0IwQixTQUF0QixFQUFpQ0osSUFBakMsRUFBdUMsQ0FBQ0MsTUFBTSxHQUFHQSxNQUFNLEdBQUcsR0FBWixHQUFrQixFQUF6QixJQUErQkksU0FBdEUsQ0FBcEI7QUFDSCxTQUZELE1BRU87QUFDSEgsVUFBQUEsTUFBTSxDQUFDRyxTQUFELENBQU4sR0FBb0IzQixLQUFwQjtBQUNIO0FBQ0o7O0FBRUQ7QUFDSDs7QUFFRCxRQUFJLENBQUMwQixTQUFTLENBQUNFLFFBQWYsRUFBeUI7QUFDckIsWUFBTSxJQUFJcEMsZUFBSixDQUFxQiw4QkFBNkIrQixNQUFNLEdBQUdBLE1BQU0sR0FBRyxHQUFaLEdBQWtCLEVBQUcsR0FBRUksU0FBVSxHQUFFRCxTQUFTLENBQUNJLE9BQVYsR0FBb0IsUUFBUUosU0FBUyxDQUFDSSxPQUF0QyxHQUFnRCxFQUFHLEdBQTlJLENBQU47QUFDSDs7QUFFRCxRQUFJLGFBQWFKLFNBQWpCLEVBQTRCO0FBQ3hCRixNQUFBQSxNQUFNLENBQUNHLFNBQUQsQ0FBTixHQUFvQkQsU0FBUyxDQUFDRyxPQUE5QjtBQUNIO0FBQ0osR0E3QkQ7O0FBK0JBLFNBQU9MLE1BQVA7QUFDSDs7QUFFRDdCLE1BQU0sQ0FBQ0MsT0FBUCxDQUFldUIsc0JBQWYsR0FBd0NBLHNCQUF4QyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBVdGlsID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgXyB9ID0gVXRpbDtcbmNvbnN0IHsgaXNOb3RoaW5nIH0gPSByZXF1aXJlKCcuL3V0aWxzL2xhbmcnKTtcbmNvbnN0IHsgdHJ5UmVxdWlyZSB9ID0gcmVxdWlyZSgnLi91dGlscy9saWInKTtcbmNvbnN0IHsgVmFsaWRhdGlvbkVycm9yIH0gPSByZXF1aXJlKCcuL3V0aWxzL0Vycm9ycycpO1xuY29uc3QgdmFsaWRhdG9yID0gcmVxdWlyZSgndmFsaWRhdG9yJyk7XG5jb25zdCBUeXBlcyA9IHJlcXVpcmUoJy4vdHlwZXMnKTtcblxubW9kdWxlLmV4cG9ydHMgPSBfLnBpY2sodmFsaWRhdG9yLCBbIFxuICAgICdlcXVhbHMnLFxuICAgICdjb250YWlucycsXG4gICAgJ21hdGNoZXMnLFxuICAgICdpc0VtYWlsJyxcbiAgICAnaXNVUkwnLFxuICAgICdpc01BQ0FkZHJlc3MnLFxuICAgICdpc0lQJyxcbiAgICAnaXNGUUROJyxcbiAgICAnaXNCb29sZWFuJyxcbiAgICAnaXNBbHBoYScsXG4gICAgJ2lzQWxwaGFudW1lcmljJyxcbiAgICAnaXNOdW1lcmljJyxcbiAgICAnaXNQb3J0JyxcbiAgICAnaXNMb3dlcmNhc2UnLFxuICAgICdpc1VwcGVyY2FzZScsXG4gICAgJ2lzQXNjaWknLFxuICAgICdpc0Z1bGxXaWR0aCcsXG4gICAgJ2lzSGFsZldpZHRoJyxcbiAgICAnaXNWYXJpYWJsZVdpZHRoJyxcbiAgICAnaXNNdWx0aWJ5dGUnLFxuICAgICdpc1N1cnJvZ2F0ZVBhaXInLFxuICAgICdpc0ludCcsXG4gICAgJ2lzRmxvYXQnLFxuICAgICdpc0RlY2ltYWwnLFxuICAgICdpc0hleGFkZWNpbWFsJyxcbiAgICAnaXNEaXZpc2libGVCeScsXG4gICAgJ2lzSGV4Q29sb3InLFxuICAgICdpc0lTUkMnLFxuICAgICdpc01ENScsXG4gICAgJ2lzSGFzaCcsXG4gICAgJ2lzSlNPTicsXG4gICAgJ2lzRW1wdHknLFxuICAgICdpc0xlbmd0aCcsXG4gICAgJ2lzQnl0ZUxlbmd0aCcsXG4gICAgJ2lzVVVJRCcsXG4gICAgJ2lzTW9uZ29JZCcsXG4gICAgJ2lzQWZ0ZXInLFxuICAgICdpc0JlZm9yZScsXG4gICAgJ2lzSW4nLFxuICAgICdpc0NyZWRpdENhcmQnLFxuICAgICdpc0lTSU4nLFxuICAgICdpc0lTQk4nLFxuICAgICdpc0lTU04nLFxuICAgICdpc01vYmlsZVBob25lJyxcbiAgICAnaXNQb3N0YWxDb2RlJyxcbiAgICAnaXNDdXJyZW5jeScsXG4gICAgJ2lzSVNPODYwMScsXG4gICAgJ2lzSVNPMzE2NjFBbHBoYTInLFxuICAgICdpc0Jhc2U2NCcsXG4gICAgJ2lzRGF0YVVSSScsXG4gICAgJ2lzTWltZVR5cGUnLFxuICAgICdpc0xhdExvbmcnXG5dKTtcblxuY29uc3QgUkVfUEhPTkUgPSAvXigoXFwrfDAwKVxcZCspPyhcXChcXGQrXFwpKT8oKFxcIHwtKT9cXGQrKSokLztcblxubW9kdWxlLmV4cG9ydHMuaXNQaG9uZSA9IGZ1bmN0aW9uICh2YWx1ZSkge1xuICAgIHJldHVybiBSRV9QSE9ORS50ZXN0KHZhbHVlKTtcbn1cblxubW9kdWxlLmV4cG9ydHMubWluID0gZnVuY3Rpb24gKHZhbHVlLCBtaW5WYWx1ZSkge1xuICAgIHJldHVybiB2YWx1ZSA+PSBtaW5WYWx1ZTtcbn07XG5cbm1vZHVsZS5leHBvcnRzLm1heCA9IGZ1bmN0aW9uICh2YWx1ZSwgbWF4VmFsdWUpIHtcbiAgICByZXR1cm4gdmFsdWUgPD0gbWF4VmFsdWU7XG59O1xuXG5tb2R1bGUuZXhwb3J0cy5ndCA9IGZ1bmN0aW9uICh2YWx1ZSwgbWluVmFsdWUpIHtcbiAgICByZXR1cm4gdmFsdWUgPiBtaW5WYWx1ZTtcbn07XG5cbm1vZHVsZS5leHBvcnRzLmx0ID0gZnVuY3Rpb24gKHZhbHVlLCBtYXhWYWx1ZSkge1xuICAgIHJldHVybiB2YWx1ZSA8IG1heFZhbHVlO1xufTtcblxubW9kdWxlLmV4cG9ydHMubWF4TGVuZ3RoID0gZnVuY3Rpb24gKHZhbHVlLCBtYXhMZW5ndGgpIHtcbiAgICByZXR1cm4gdmFsdWUubGVuZ3RoIDw9IG1heExlbmd0aDtcbn07XG5cbm1vZHVsZS5leHBvcnRzLm5vdE51bGwgPSBmdW5jdGlvbiAodmFsdWUpIHtcbiAgICByZXR1cm4gIWlzTm90aGluZyh2YWx1ZSk7XG59O1xuXG5tb2R1bGUuZXhwb3J0cy5ub3ROdWxsSWYgPSBmdW5jdGlvbiAodmFsdWUsIGNvbmRpdGlvbikge1xuICAgIHJldHVybiAhY29uZGl0aW9uIHx8ICFpc05vdGhpbmcodmFsdWUpO1xufTtcblxuLyoqXG4gKiBWYWxpZGF0ZSBhbiBvYmogd2l0aCBjb25kaXRpb24gbGlrZSBtb25nby1zdHlsZSBxdWVyeVxuICogQHBhcmFtIHsqfSBvYmogXG4gKiBAcGFyYW0ge2FycmF5fG9iamVjdH0gY29uZGl0aW9uIFxuICogQHJldHVybnMge2Jvb2xlYW59XG4gKi9cbmZ1bmN0aW9uIHZhbGlkYXRlKG9iaiwgY29uZGl0aW9uKSB7ICAgIFxuICAgIGNvbnN0IHsgUXVlcnkgfSA9IHRyeVJlcXVpcmUoJ21pbmdvJyk7XG4gICAgbGV0IHF1ZXJ5ID0gbmV3IFF1ZXJ5KGNvbmRpdGlvbik7XG4gICAgXG4gICAgLy8gdGVzdCBpZiBhbiBvYmplY3QgbWF0Y2hlcyBxdWVyeVxuICAgIHJldHVybiBxdWVyeS50ZXN0KG9iaik7XG59XG5cbm1vZHVsZS5leHBvcnRzLnZhbGlkYXRlID0gdmFsaWRhdGU7XG5cbm1vZHVsZS5leHBvcnRzLnZhbGlkYXRlQW55ID0gVHlwZXMuc2FuaXRpemU7XG5cbmZ1bmN0aW9uIHZhbGlkYXRlT2JqZWN0QnlTY2hlbWEocmF3LCBzY2hlbWEsIGkxOG4sIHByZWZpeCkgeyAgIFxuICAgIGxldCBsYXRlc3QgPSB7fTsgICAgXG5cbiAgICBfLmZvck93bihzY2hlbWEsIChmaWVsZEluZm8sIGZpZWxkTmFtZSkgPT4ge1xuICAgICAgICBpZiAoZmllbGROYW1lIGluIHJhdykge1xuICAgICAgICAgICAgbGV0IHZhbHVlID0gcmF3W2ZpZWxkTmFtZV07XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vc2FuaXRpemUgZmlyc3RcbiAgICAgICAgICAgIGlmIChpc05vdGhpbmcodmFsdWUpKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFmaWVsZEluZm8ub3B0aW9uYWwgJiYgaXNOb3RoaW5nKGZpZWxkSW5mby5kZWZhdWx0KSkge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKGBWYWx1ZSBvZiBwcm9wZXJ0eSBcIiR7cHJlZml4ID8gcHJlZml4ICsgJy4nIDogJyd9JHtmaWVsZE5hbWV9JHtmaWVsZEluZm8uY29tbWVudCA/ICcgLSAnICsgZmllbGRJbmZvLmNvbW1lbnQgOiAnJ31cIiBjYW5ub3QgYmUgbnVsbGApO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGxhdGVzdFtmaWVsZE5hbWVdID0gZmllbGRJbmZvLmRlZmF1bHQgPz8gbnVsbDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKGZpZWxkSW5mby50eXBlKSB7XG4gICAgICAgICAgICAgICAgICAgIGxhdGVzdFtmaWVsZE5hbWVdID0gVHlwZXMuc2FuaXRpemUodmFsdWUsIGZpZWxkSW5mbywgaTE4biwgKHByZWZpeCA/IHByZWZpeCArICcuJyA6ICcnKSArIGZpZWxkTmFtZSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBsYXRlc3RbZmllbGROYW1lXSA9IHZhbHVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9ICAgICAgIFxuXG4gICAgICAgIGlmICghZmllbGRJbmZvLm9wdGlvbmFsKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKGBNaXNzaW5nIHJlcXVpcmVkIHByb3BlcnR5IFwiJHtwcmVmaXggPyBwcmVmaXggKyAnLicgOiAnJ30ke2ZpZWxkTmFtZX0ke2ZpZWxkSW5mby5jb21tZW50ID8gJyAtICcgKyBmaWVsZEluZm8uY29tbWVudCA6ICcnfVwiYCk7XG4gICAgICAgIH0gICAgICAgIFxuXG4gICAgICAgIGlmICgnZGVmYXVsdCcgaW4gZmllbGRJbmZvKSB7XG4gICAgICAgICAgICBsYXRlc3RbZmllbGROYW1lXSA9IGZpZWxkSW5mby5kZWZhdWx0XG4gICAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiBsYXRlc3Q7XG59XG5cbm1vZHVsZS5leHBvcnRzLnZhbGlkYXRlT2JqZWN0QnlTY2hlbWEgPSB2YWxpZGF0ZU9iamVjdEJ5U2NoZW1hOyJdfQ==