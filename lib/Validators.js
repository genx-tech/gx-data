"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const {
  _
} = Util;

const {
  isNothing
} = require('./utils/lang');

const {
  tryRequire
} = require('./utils/lib');

const {
  ValidationError
} = require('./utils/Errors');

const validator = require('validator');

const Types = require('./types');

module.exports = _.pick(validator, ['equals', 'contains', 'matches', 'isEmail', 'isURL', 'isMACAddress', 'isIP', 'isFQDN', 'isBoolean', 'isAlpha', 'isAlphanumeric', 'isNumeric', 'isPort', 'isLowercase', 'isUppercase', 'isAscii', 'isFullWidth', 'isHalfWidth', 'isVariableWidth', 'isMultibyte', 'isSurrogatePair', 'isInt', 'isFloat', 'isDecimal', 'isHexadecimal', 'isDivisibleBy', 'isHexColor', 'isISRC', 'isMD5', 'isHash', 'isJSON', 'isEmpty', 'isLength', 'isByteLength', 'isUUID', 'isMongoId', 'isAfter', 'isBefore', 'isIn', 'isCreditCard', 'isISIN', 'isISBN', 'isISSN', 'isMobilePhone', 'isPostalCode', 'isCurrency', 'isISO8601', 'isISO31661Alpha2', 'isBase64', 'isDataURI', 'isMimeType', 'isLatLong']);
const RE_PHONE = /^((\+|00)\d+)?(\(\d+\))?((\ |-)?\d+)*$/;

module.exports.isPhone = function (value) {
  return RE_PHONE.test(value);
};

module.exports.min = function (value, minValue) {
  return value >= minValue;
};

module.exports.max = function (value, maxValue) {
  return value <= maxValue;
};

module.exports.gt = function (value, minValue) {
  return value > minValue;
};

module.exports.lt = function (value, maxValue) {
  return value < maxValue;
};

module.exports.maxLength = function (value, maxLength) {
  return value.length <= maxLength;
};

module.exports.notNull = function (value) {
  return !isNothing(value);
};

module.exports.notNullIf = function (value, condition) {
  return !condition || !isNothing(value);
};

function validate(obj, condition) {
  const {
    Query
  } = tryRequire('mingo');
  let query = new Query(condition);
  return query.test(obj);
}

module.exports.validate = validate;
module.exports.validateAny = Types.sanitize;
const NIL = Symbol('nil');

function validateObjectMember(raw, fieldName, fieldInfo, i18n, prefix) {
  if (fieldName in raw) {
    let value = raw[fieldName];

    if (isNothing(value)) {
      var _fieldInfo$default;

      if (!fieldInfo.optional && isNothing(fieldInfo.default)) {
        throw new ValidationError(`Value of property "${prefix ? prefix + '.' : ''}${fieldName}${fieldInfo.comment ? ' - ' + fieldInfo.comment : ''}" cannot be null`);
      }

      return (_fieldInfo$default = fieldInfo.default) !== null && _fieldInfo$default !== void 0 ? _fieldInfo$default : null;
    }

    if (fieldInfo.type) {
      return Types.sanitize(value, fieldInfo, i18n, (prefix ? prefix + '.' : '') + fieldName);
    }

    return value;
  }

  if (!fieldInfo.optional) {
    throw new ValidationError(`Missing required property "${prefix ? prefix + '.' : ''}${fieldName}${fieldInfo.comment ? ' - ' + fieldInfo.comment : ''}"`);
  }

  if ('default' in fieldInfo) {
    return fieldInfo.default;
  }

  return NIL;
}

function validateObjectBySchema(raw, schema, i18n, prefix) {
  let latest = {};

  if (typeof raw !== 'object') {
    throw new ValidationError('The value is not an object.', {
      raw,
      prefix
    });
  }

  _.forOwn(schema, (fieldInfo, fieldName) => {
    if (Array.isArray(fieldInfo)) {
      if (!fieldInfo.find(fieldInfoOption => {
        let validated;
        let hasError = false;

        try {
          validated = validateObjectMember(raw, fieldName, { ...fieldInfoOption,
            skipTypeCast: true
          }, i18n, prefix);
        } catch (error) {
          hasError = true;
          validated = NIL;
        }

        if (validated !== NIL) {
          latest[fieldName] = validated;
        }

        return !hasError;
      })) {
        throw new ValidationError(`Invalid "${fieldName}" value.`, {
          raw,
          prefix
        });
      }
    } else {
      const validated = validateObjectMember(raw, fieldName, fieldInfo, i18n, prefix);

      if (validated !== NIL) {
        latest[fieldName] = validated;
      }
    }
  });

  return latest;
}

module.exports.validateObjectBySchema = validateObjectBySchema;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9WYWxpZGF0b3JzLmpzIl0sIm5hbWVzIjpbIlV0aWwiLCJyZXF1aXJlIiwiXyIsImlzTm90aGluZyIsInRyeVJlcXVpcmUiLCJWYWxpZGF0aW9uRXJyb3IiLCJ2YWxpZGF0b3IiLCJUeXBlcyIsIm1vZHVsZSIsImV4cG9ydHMiLCJwaWNrIiwiUkVfUEhPTkUiLCJpc1Bob25lIiwidmFsdWUiLCJ0ZXN0IiwibWluIiwibWluVmFsdWUiLCJtYXgiLCJtYXhWYWx1ZSIsImd0IiwibHQiLCJtYXhMZW5ndGgiLCJsZW5ndGgiLCJub3ROdWxsIiwibm90TnVsbElmIiwiY29uZGl0aW9uIiwidmFsaWRhdGUiLCJvYmoiLCJRdWVyeSIsInF1ZXJ5IiwidmFsaWRhdGVBbnkiLCJzYW5pdGl6ZSIsIk5JTCIsIlN5bWJvbCIsInZhbGlkYXRlT2JqZWN0TWVtYmVyIiwicmF3IiwiZmllbGROYW1lIiwiZmllbGRJbmZvIiwiaTE4biIsInByZWZpeCIsIm9wdGlvbmFsIiwiZGVmYXVsdCIsImNvbW1lbnQiLCJ0eXBlIiwidmFsaWRhdGVPYmplY3RCeVNjaGVtYSIsInNjaGVtYSIsImxhdGVzdCIsImZvck93biIsIkFycmF5IiwiaXNBcnJheSIsImZpbmQiLCJmaWVsZEluZm9PcHRpb24iLCJ2YWxpZGF0ZWQiLCJoYXNFcnJvciIsInNraXBUeXBlQ2FzdCIsImVycm9yIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLFVBQUQsQ0FBcEI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQTtBQUFGLElBQVFGLElBQWQ7O0FBQ0EsTUFBTTtBQUFFRyxFQUFBQTtBQUFGLElBQWdCRixPQUFPLENBQUMsY0FBRCxDQUE3Qjs7QUFDQSxNQUFNO0FBQUVHLEVBQUFBO0FBQUYsSUFBaUJILE9BQU8sQ0FBQyxhQUFELENBQTlCOztBQUNBLE1BQU07QUFBRUksRUFBQUE7QUFBRixJQUFzQkosT0FBTyxDQUFDLGdCQUFELENBQW5DOztBQUNB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QUcsS0FBZjs7QUFFQSxZQUFJO0FBQ0FELFVBQUFBLFNBQVMsR0FBR2xCLG9CQUFvQixDQUFDQyxHQUFELEVBQU1DLFNBQU4sRUFBaUIsRUFBRSxHQUFHZSxlQUFMO0FBQXNCRyxZQUFBQSxZQUFZLEVBQUU7QUFBcEMsV0FBakIsRUFBNkRoQixJQUE3RCxFQUFtRUMsTUFBbkUsQ0FBaEM7QUFDSCxTQUZELENBRUUsT0FBT2dCLEtBQVAsRUFBYztBQUNaRixVQUFBQSxRQUFRLEdBQUcsSUFBWDtBQUNBRCxVQUFBQSxTQUFTLEdBQUdwQixHQUFaO0FBQ0g7O0FBRUQsWUFBSW9CLFNBQVMsS0FBS3BCLEdBQWxCLEVBQXVCO0FBQ25CYyxVQUFBQSxNQUFNLENBQUNWLFNBQUQsQ0FBTixHQUFvQmdCLFNBQXBCO0FBQ0g7O0FBRUQsZUFBTyxDQUFDQyxRQUFSO0FBQ0gsT0FoQkksQ0FBTCxFQWdCSTtBQUNBLGNBQU0sSUFBSWhELGVBQUosQ0FBcUIsWUFBVytCLFNBQVUsVUFBMUMsRUFBcUQ7QUFDdkRELFVBQUFBLEdBRHVEO0FBRXZESSxVQUFBQTtBQUZ1RCxTQUFyRCxDQUFOO0FBSUg7QUFFSixLQXhCRCxNQXdCTztBQUNILFlBQU1hLFNBQVMsR0FBR2xCLG9CQUFvQixDQUFDQyxHQUFELEVBQU1DLFNBQU4sRUFBaUJDLFNBQWpCLEVBQTRCQyxJQUE1QixFQUFrQ0MsTUFBbEMsQ0FBdEM7O0FBQ0EsVUFBSWEsU0FBUyxLQUFLcEIsR0FBbEIsRUFBdUI7QUFDbkJjLFFBQUFBLE1BQU0sQ0FBQ1YsU0FBRCxDQUFOLEdBQW9CZ0IsU0FBcEI7QUFDSDtBQUNKO0FBQ0osR0EvQkQ7O0FBaUNBLFNBQU9OLE1BQVA7QUFDSDs7QUFFRHRDLE1BQU0sQ0FBQ0MsT0FBUCxDQUFlbUMsc0JBQWYsR0FBd0NBLHNCQUF4QyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBVdGlsID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgXyB9ID0gVXRpbDtcbmNvbnN0IHsgaXNOb3RoaW5nIH0gPSByZXF1aXJlKCcuL3V0aWxzL2xhbmcnKTtcbmNvbnN0IHsgdHJ5UmVxdWlyZSB9ID0gcmVxdWlyZSgnLi91dGlscy9saWInKTtcbmNvbnN0IHsgVmFsaWRhdGlvbkVycm9yIH0gPSByZXF1aXJlKCcuL3V0aWxzL0Vycm9ycycpO1xuY29uc3QgdmFsaWRhdG9yID0gcmVxdWlyZSgndmFsaWRhdG9yJyk7XG5jb25zdCBUeXBlcyA9IHJlcXVpcmUoJy4vdHlwZXMnKTtcblxubW9kdWxlLmV4cG9ydHMgPSBfLnBpY2sodmFsaWRhdG9yLCBbIFxuICAgICdlcXVhbHMnLFxuICAgICdjb250YWlucycsXG4gICAgJ21hdGNoZXMnLFxuICAgICdpc0VtYWlsJyxcbiAgICAnaXNVUkwnLFxuICAgICdpc01BQ0FkZHJlc3MnLFxuICAgICdpc0lQJyxcbiAgICAnaXNGUUROJyxcbiAgICAnaXNCb29sZWFuJyxcbiAgICAnaXNBbHBoYScsXG4gICAgJ2lzQWxwaGFudW1lcmljJyxcbiAgICAnaXNOdW1lcmljJyxcbiAgICAnaXNQb3J0JyxcbiAgICAnaXNMb3dlcmNhc2UnLFxuICAgICdpc1VwcGVyY2FzZScsXG4gICAgJ2lzQXNjaWknLFxuICAgICdpc0Z1bGxXaWR0aCcsXG4gICAgJ2lzSGFsZldpZHRoJyxcbiAgICAnaXNWYXJpYWJsZVdpZHRoJyxcbiAgICAnaXNNdWx0aWJ5dGUnLFxuICAgICdpc1N1cnJvZ2F0ZVBhaXInLFxuICAgICdpc0ludCcsXG4gICAgJ2lzRmxvYXQnLFxuICAgICdpc0RlY2ltYWwnLFxuICAgICdpc0hleGFkZWNpbWFsJyxcbiAgICAnaXNEaXZpc2libGVCeScsXG4gICAgJ2lzSGV4Q29sb3InLFxuICAgICdpc0lTUkMnLFxuICAgICdpc01ENScsXG4gICAgJ2lzSGFzaCcsXG4gICAgJ2lzSlNPTicsXG4gICAgJ2lzRW1wdHknLFxuICAgICdpc0xlbmd0aCcsXG4gICAgJ2lzQnl0ZUxlbmd0aCcsXG4gICAgJ2lzVVVJRCcsXG4gICAgJ2lzTW9uZ29JZCcsXG4gICAgJ2lzQWZ0ZXInLFxuICAgICdpc0JlZm9yZScsXG4gICAgJ2lzSW4nLFxuICAgICdpc0NyZWRpdENhcmQnLFxuICAgICdpc0lTSU4nLFxuICAgICdpc0lTQk4nLFxuICAgICdpc0lTU04nLFxuICAgICdpc01vYmlsZVBob25lJyxcbiAgICAnaXNQb3N0YWxDb2RlJyxcbiAgICAnaXNDdXJyZW5jeScsXG4gICAgJ2lzSVNPODYwMScsXG4gICAgJ2lzSVNPMzE2NjFBbHBoYTInLFxuICAgICdpc0Jhc2U2NCcsXG4gICAgJ2lzRGF0YVVSSScsXG4gICAgJ2lzTWltZVR5cGUnLFxuICAgICdpc0xhdExvbmcnXG5dKTtcblxuY29uc3QgUkVfUEhPTkUgPSAvXigoXFwrfDAwKVxcZCspPyhcXChcXGQrXFwpKT8oKFxcIHwtKT9cXGQrKSokLztcblxubW9kdWxlLmV4cG9ydHMuaXNQaG9uZSA9IGZ1bmN0aW9uICh2YWx1ZSkge1xuICAgIHJldHVybiBSRV9QSE9ORS50ZXN0KHZhbHVlKTtcbn1cblxubW9kdWxlLmV4cG9ydHMubWluID0gZnVuY3Rpb24gKHZhbHVlLCBtaW5WYWx1ZSkge1xuICAgIHJldHVybiB2YWx1ZSA+PSBtaW5WYWx1ZTtcbn07XG5cbm1vZHVsZS5leHBvcnRzLm1heCA9IGZ1bmN0aW9uICh2YWx1ZSwgbWF4VmFsdWUpIHtcbiAgICByZXR1cm4gdmFsdWUgPD0gbWF4VmFsdWU7XG59O1xuXG5tb2R1bGUuZXhwb3J0cy5ndCA9IGZ1bmN0aW9uICh2YWx1ZSwgbWluVmFsdWUpIHtcbiAgICByZXR1cm4gdmFsdWUgPiBtaW5WYWx1ZTtcbn07XG5cbm1vZHVsZS5leHBvcnRzLmx0ID0gZnVuY3Rpb24gKHZhbHVlLCBtYXhWYWx1ZSkge1xuICAgIHJldHVybiB2YWx1ZSA8IG1heFZhbHVlO1xufTtcblxubW9kdWxlLmV4cG9ydHMubWF4TGVuZ3RoID0gZnVuY3Rpb24gKHZhbHVlLCBtYXhMZW5ndGgpIHtcbiAgICByZXR1cm4gdmFsdWUubGVuZ3RoIDw9IG1heExlbmd0aDtcbn07XG5cbm1vZHVsZS5leHBvcnRzLm5vdE51bGwgPSBmdW5jdGlvbiAodmFsdWUpIHtcbiAgICByZXR1cm4gIWlzTm90aGluZyh2YWx1ZSk7XG59O1xuXG5tb2R1bGUuZXhwb3J0cy5ub3ROdWxsSWYgPSBmdW5jdGlvbiAodmFsdWUsIGNvbmRpdGlvbikge1xuICAgIHJldHVybiAhY29uZGl0aW9uIHx8ICFpc05vdGhpbmcodmFsdWUpO1xufTtcblxuLyoqXG4gKiBWYWxpZGF0ZSBhbiBvYmogd2l0aCBjb25kaXRpb24gbGlrZSBtb25nby1zdHlsZSBxdWVyeVxuICogQHBhcmFtIHsqfSBvYmogXG4gKiBAcGFyYW0ge2FycmF5fG9iamVjdH0gY29uZGl0aW9uIFxuICogQHJldHVybnMge2Jvb2xlYW59XG4gKi9cbmZ1bmN0aW9uIHZhbGlkYXRlKG9iaiwgY29uZGl0aW9uKSB7ICAgIFxuICAgIGNvbnN0IHsgUXVlcnkgfSA9IHRyeVJlcXVpcmUoJ21pbmdvJyk7XG4gICAgbGV0IHF1ZXJ5ID0gbmV3IFF1ZXJ5KGNvbmRpdGlvbik7XG4gICAgXG4gICAgLy8gdGVzdCBpZiBhbiBvYmplY3QgbWF0Y2hlcyBxdWVyeVxuICAgIHJldHVybiBxdWVyeS50ZXN0KG9iaik7XG59XG5cbm1vZHVsZS5leHBvcnRzLnZhbGlkYXRlID0gdmFsaWRhdGU7XG5cbm1vZHVsZS5leHBvcnRzLnZhbGlkYXRlQW55ID0gVHlwZXMuc2FuaXRpemU7XG5cbmNvbnN0IE5JTCA9IFN5bWJvbCgnbmlsJyk7XG5cbmZ1bmN0aW9uIHZhbGlkYXRlT2JqZWN0TWVtYmVyKHJhdywgZmllbGROYW1lLCBmaWVsZEluZm8sIGkxOG4sIHByZWZpeCkge1xuICAgIGlmIChmaWVsZE5hbWUgaW4gcmF3KSB7XG4gICAgICAgIGxldCB2YWx1ZSA9IHJhd1tmaWVsZE5hbWVdO1xuICAgICAgICBcbiAgICAgICAgLy9zYW5pdGl6ZSBmaXJzdFxuICAgICAgICBpZiAoaXNOb3RoaW5nKHZhbHVlKSkge1xuICAgICAgICAgICAgaWYgKCFmaWVsZEluZm8ub3B0aW9uYWwgJiYgaXNOb3RoaW5nKGZpZWxkSW5mby5kZWZhdWx0KSkgeyAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoYFZhbHVlIG9mIHByb3BlcnR5IFwiJHtwcmVmaXggPyBwcmVmaXggKyAnLicgOiAnJ30ke2ZpZWxkTmFtZX0ke2ZpZWxkSW5mby5jb21tZW50ID8gJyAtICcgKyBmaWVsZEluZm8uY29tbWVudCA6ICcnfVwiIGNhbm5vdCBiZSBudWxsYCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBmaWVsZEluZm8uZGVmYXVsdCA/PyBudWxsO1xuICAgICAgICB9IFxuICAgICAgICBcbiAgICAgICAgaWYgKGZpZWxkSW5mby50eXBlKSB7XG4gICAgICAgICAgICByZXR1cm4gVHlwZXMuc2FuaXRpemUodmFsdWUsIGZpZWxkSW5mbywgaTE4biwgKHByZWZpeCA/IHByZWZpeCArICcuJyA6ICcnKSArIGZpZWxkTmFtZSk7XG4gICAgICAgIH0gXG5cbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH0gICAgICAgXG5cbiAgICBpZiAoIWZpZWxkSW5mby5vcHRpb25hbCkge1xuICAgICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKGBNaXNzaW5nIHJlcXVpcmVkIHByb3BlcnR5IFwiJHtwcmVmaXggPyBwcmVmaXggKyAnLicgOiAnJ30ke2ZpZWxkTmFtZX0ke2ZpZWxkSW5mby5jb21tZW50ID8gJyAtICcgKyBmaWVsZEluZm8uY29tbWVudCA6ICcnfVwiYCk7XG4gICAgfSAgICAgICAgXG5cbiAgICBpZiAoJ2RlZmF1bHQnIGluIGZpZWxkSW5mbykge1xuICAgICAgICByZXR1cm4gZmllbGRJbmZvLmRlZmF1bHQ7XG4gICAgfVxuXG4gICAgcmV0dXJuIE5JTDtcbn1cblxuZnVuY3Rpb24gdmFsaWRhdGVPYmplY3RCeVNjaGVtYShyYXcsIHNjaGVtYSwgaTE4biwgcHJlZml4KSB7ICAgXG4gICAgbGV0IGxhdGVzdCA9IHt9OyAgICBcblxuICAgIGlmICh0eXBlb2YgcmF3ICE9PSAnb2JqZWN0Jykge1xuICAgICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKCdUaGUgdmFsdWUgaXMgbm90IGFuIG9iamVjdC4nLCB7XG4gICAgICAgICAgICByYXcsXG4gICAgICAgICAgICBwcmVmaXhcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgXy5mb3JPd24oc2NoZW1hLCAoZmllbGRJbmZvLCBmaWVsZE5hbWUpID0+IHsgIFxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShmaWVsZEluZm8pKSB7XG4gICAgICAgICAgICBpZiAoIWZpZWxkSW5mby5maW5kKGZpZWxkSW5mb09wdGlvbiA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IHZhbGlkYXRlZDtcbiAgICAgICAgICAgICAgICBsZXQgaGFzRXJyb3IgPSBmYWxzZTtcblxuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIHZhbGlkYXRlZCA9IHZhbGlkYXRlT2JqZWN0TWVtYmVyKHJhdywgZmllbGROYW1lLCB7IC4uLmZpZWxkSW5mb09wdGlvbiwgc2tpcFR5cGVDYXN0OiB0cnVlIH0sIGkxOG4sIHByZWZpeCk7XG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBoYXNFcnJvciA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIHZhbGlkYXRlZCA9IE5JTDtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAodmFsaWRhdGVkICE9PSBOSUwpIHtcbiAgICAgICAgICAgICAgICAgICAgbGF0ZXN0W2ZpZWxkTmFtZV0gPSB2YWxpZGF0ZWQ7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9ICBcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICByZXR1cm4gIWhhc0Vycm9yO1xuICAgICAgICAgICAgfSkpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKGBJbnZhbGlkIFwiJHtmaWVsZE5hbWV9XCIgdmFsdWUuYCwge1xuICAgICAgICAgICAgICAgICAgICByYXcsXG4gICAgICAgICAgICAgICAgICAgIHByZWZpeFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSAgIFxuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCB2YWxpZGF0ZWQgPSB2YWxpZGF0ZU9iamVjdE1lbWJlcihyYXcsIGZpZWxkTmFtZSwgZmllbGRJbmZvLCBpMThuLCBwcmVmaXgpO1xuICAgICAgICAgICAgaWYgKHZhbGlkYXRlZCAhPT0gTklMKSB7XG4gICAgICAgICAgICAgICAgbGF0ZXN0W2ZpZWxkTmFtZV0gPSB2YWxpZGF0ZWQ7XG4gICAgICAgICAgICB9ICAgICAgXG4gICAgICAgIH0gICAgICAgICAgIFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGxhdGVzdDtcbn1cblxubW9kdWxlLmV4cG9ydHMudmFsaWRhdGVPYmplY3RCeVNjaGVtYSA9IHZhbGlkYXRlT2JqZWN0QnlTY2hlbWE7Il19