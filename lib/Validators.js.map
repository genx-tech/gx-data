{"version":3,"file":"Validators.js","names":["_","require","isNothing","ValidationError","validator","Types","module","exports","pick","RE_PHONE","isPhone","value","test","min","minValue","max","maxValue","gt","lt","maxLength","length","notNull","notNullIf","condition","NIL","Symbol","validateObjectMember","raw","fieldName","fieldInfo","i18n","prefix","optional","default","comment","type","sanitize","res","field","convertor","validateObjectBySchema","schema","latest","forOwn","Array","isArray","find","fieldInfoOption","validated","hasError","skipTypeCast","error"],"sources":["../src/Validators.js"],"sourcesContent":["const { _ } = require('@genx/july');\nconst { isNothing } = require('./utils/lang');\nconst { ValidationError } = require('./utils/Errors');\nconst validator = require('validator');\nconst Types = require('./types');\n\nmodule.exports = _.pick(validator, [\n    'equals',\n    'contains',\n    'matches',\n    'isEmail',\n    'isURL',\n    'isMACAddress',\n    'isIP',\n    'isFQDN',\n    'isBoolean',\n    'isAlpha',\n    'isAlphanumeric',\n    'isNumeric',\n    'isPort',\n    'isLowercase',\n    'isUppercase',\n    'isAscii',\n    'isFullWidth',\n    'isHalfWidth',\n    'isVariableWidth',\n    'isMultibyte',\n    'isSurrogatePair',\n    'isInt',\n    'isFloat',\n    'isDecimal',\n    'isHexadecimal',\n    'isDivisibleBy',\n    'isHexColor',\n    'isISRC',\n    'isMD5',\n    'isHash',\n    'isJSON',\n    'isEmpty',\n    'isLength',\n    'isByteLength',\n    'isUUID',\n    'isMongoId',\n    'isAfter',\n    'isBefore',\n    'isIn',\n    'isCreditCard',\n    'isISIN',\n    'isISBN',\n    'isISSN',\n    'isMobilePhone',\n    'isPostalCode',\n    'isCurrency',\n    'isISO8601',\n    'isISO31661Alpha2',\n    'isBase64',\n    'isDataURI',\n    'isMimeType',\n    'isLatLong',\n]);\n\nconst RE_PHONE = /^((\\+|00)\\d+)?(\\(\\d+\\))?(( |-)?\\d+)*$/;\n\nmodule.exports.isPhone = function (value) {\n    return RE_PHONE.test(value);\n};\n\nmodule.exports.min = function (value, minValue) {\n    return value >= minValue;\n};\n\nmodule.exports.max = function (value, maxValue) {\n    return value <= maxValue;\n};\n\nmodule.exports.gt = function (value, minValue) {\n    return value > minValue;\n};\n\nmodule.exports.lt = function (value, maxValue) {\n    return value < maxValue;\n};\n\nmodule.exports.maxLength = function (value, maxLength) {\n    return value.length <= maxLength;\n};\n\nmodule.exports.notNull = function (value) {\n    return !isNothing(value);\n};\n\nmodule.exports.notNullIf = function (value, condition) {\n    return !condition || !isNothing(value);\n};\n\nconst NIL = Symbol('nil');\n\nfunction validateObjectMember(raw, fieldName, fieldInfo, i18n, prefix) {\n    if (fieldName in raw) {\n        let value = raw[fieldName];\n\n        // sanitize first\n        if (isNothing(value)) {\n            if (!fieldInfo.optional && isNothing(fieldInfo.default)) {\n                throw new ValidationError(\n                    `Value of property \"${prefix ? prefix + '.' : ''\n                    }${fieldName}${fieldInfo.comment ? ' - ' + fieldInfo.comment : ''\n                    }\" cannot be null`\n                );\n            }\n\n            return fieldInfo.default ?? null;\n        }\n        if (fieldInfo.type) {\n            return Types.sanitize(\n                value,\n                fieldInfo,\n                i18n,\n                (prefix ? prefix + '.' : '') + fieldName\n            );\n        } else {\n            if (fieldInfo.validator && typeof fieldInfo.validator === 'function') {\n                const res = fieldInfo.validator(value);\n                if (res === false) {\n                    throw new ValidationError(`Invalid \"${fieldName}\" value`, {\n                        value: value,\n                        field: fieldInfo,\n                    });\n                }\n            }\n\n            if (fieldInfo.convertor && typeof fieldInfo.convertor === 'function') {\n                value = fieldInfo.convertor(value);\n            }\n        }\n\n        return value;\n    }\n\n    if (!fieldInfo.optional) {\n        throw new ValidationError(\n            `Missing required property \"${prefix ? prefix + '.' : ''\n            }${fieldName}${fieldInfo.comment ? ' - ' + fieldInfo.comment : ''}\"`\n        );\n    }\n\n    if ('default' in fieldInfo) {\n        return fieldInfo.default;\n    }\n\n    return NIL;\n}\n\nfunction validateObjectBySchema(raw, schema, i18n, prefix) {\n    const latest = {};\n\n    if (typeof raw !== 'object') {\n        throw new ValidationError('The value is not an object.', {\n            raw,\n            prefix,\n        });\n    }\n\n    if (typeof schema === 'function') {\n        // use deferred activation of schema to avoid circullar reference\n        schema = schema();\n    }\n\n    _.forOwn(schema, (fieldInfo, fieldName) => {\n        if (Array.isArray(fieldInfo)) {\n            if (\n                !fieldInfo.find((fieldInfoOption) => {\n                    let validated;\n                    let hasError = false;\n\n                    try {\n                        validated = validateObjectMember(\n                            raw,\n                            fieldName,\n                            { ...fieldInfoOption, skipTypeCast: true },\n                            i18n,\n                            prefix\n                        );\n                    } catch (error) {\n                        hasError = true;\n                        validated = NIL;\n                    }\n\n                    if (validated !== NIL) {\n                        latest[fieldName] = validated;\n                    }\n\n                    return !hasError;\n                })\n            ) {\n                throw new ValidationError(`Invalid \"${fieldName}\" value.`, {\n                    raw,\n                    prefix,\n                });\n            }\n        } else {\n            const validated = validateObjectMember(\n                raw,\n                fieldName,\n                fieldInfo,\n                i18n,\n                prefix\n            );\n            if (validated !== NIL) {\n                latest[fieldName] = validated;\n            }\n        }\n    });\n\n    return latest;\n}\n\nmodule.exports.validateObjectBySchema = validateObjectBySchema;\n"],"mappings":"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"}