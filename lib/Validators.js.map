{"version":3,"file":"Validators.js","names":["_","require","isNothing","ValidationError","validator","Types","module","exports","pick","RE_PHONE","isPhone","value","test","min","minValue","max","maxValue","gt","lt","maxLength","length","notNull","notNullIf","condition","NIL","Symbol","validateObjectMember","raw","fieldName","fieldInfo","i18n","prefix","optional","default","comment","type","sanitize","res","field","convertor","validateObjectBySchema","schema","latest","forOwn","Array","isArray","find","fieldInfoOption","validated","hasError","skipTypeCast","error"],"sources":["../src/Validators.js"],"sourcesContent":["const { _ } = require('@genx/july');\nconst { isNothing } = require('./utils/lang');\nconst { ValidationError } = require('./utils/Errors');\nconst validator = require('validator');\nconst Types = require('./types');\n\nmodule.exports = _.pick(validator, [\n    'equals',\n    'contains',\n    'matches',\n    'isEmail',\n    'isURL',\n    'isMACAddress',\n    'isIP',\n    'isFQDN',\n    'isBoolean',\n    'isAlpha',\n    'isAlphanumeric',\n    'isNumeric',\n    'isPort',\n    'isLowercase',\n    'isUppercase',\n    'isAscii',\n    'isFullWidth',\n    'isHalfWidth',\n    'isVariableWidth',\n    'isMultibyte',\n    'isSurrogatePair',\n    'isInt',\n    'isFloat',\n    'isDecimal',\n    'isHexadecimal',\n    'isDivisibleBy',\n    'isHexColor',\n    'isISRC',\n    'isMD5',\n    'isHash',\n    'isJSON',\n    'isEmpty',\n    'isLength',\n    'isByteLength',\n    'isUUID',\n    'isMongoId',\n    'isAfter',\n    'isBefore',\n    'isIn',\n    'isCreditCard',\n    'isISIN',\n    'isISBN',\n    'isISSN',\n    'isMobilePhone',\n    'isPostalCode',\n    'isCurrency',\n    'isISO8601',\n    'isISO31661Alpha2',\n    'isBase64',\n    'isDataURI',\n    'isMimeType',\n    'isLatLong',\n]);\n\nconst RE_PHONE = /^((\\+|00)\\d+)?(\\(\\d+\\))?(( |-)?\\d+)*$/;\n\nmodule.exports.isPhone = function (value) {\n    return RE_PHONE.test(value);\n};\n\nmodule.exports.min = function (value, minValue) {\n    return value >= minValue;\n};\n\nmodule.exports.max = function (value, maxValue) {\n    return value <= maxValue;\n};\n\nmodule.exports.gt = function (value, minValue) {\n    return value > minValue;\n};\n\nmodule.exports.lt = function (value, maxValue) {\n    return value < maxValue;\n};\n\nmodule.exports.maxLength = function (value, maxLength) {\n    return value.length <= maxLength;\n};\n\nmodule.exports.notNull = function (value) {\n    return !isNothing(value);\n};\n\nmodule.exports.notNullIf = function (value, condition) {\n    return !condition || !isNothing(value);\n};\n\nconst NIL = Symbol('nil');\n\nfunction validateObjectMember(raw, fieldName, fieldInfo, i18n, prefix) {\n    if (fieldName in raw) {\n        let value = raw[fieldName];\n\n        // sanitize first\n        if (isNothing(value)) {\n            if (!fieldInfo.optional && isNothing(fieldInfo.default)) {\n                throw new ValidationError(\n                    `Value of property \"${prefix ? prefix + '.' : ''\n                    }${fieldName}${fieldInfo.comment ? ' - ' + fieldInfo.comment : ''\n                    }\" cannot be null`\n                );\n            }\n\n            return fieldInfo.default ?? null;\n        }\n        if (fieldInfo.type) {\n            return Types.sanitize(\n                value,\n                fieldInfo,\n                i18n,\n                (prefix ? prefix + '.' : '') + fieldName\n            );\n        } else {\n            if (fieldInfo.validator && typeof fieldInfo.validator === 'function') {\n                const res = fieldInfo.validator(value);\n                if (res === false) {\n                    throw new ValidationError(`Invalid \"${fieldName}\" value`, {\n                        value: value,\n                        field: fieldInfo,\n                    });\n                }\n            }\n\n            if (fieldInfo.convertor && typeof fieldInfo.convertor === 'function') {\n                value = fieldInfo.convertor(value);\n            }\n        }\n\n        return value;\n    }\n\n    if (!fieldInfo.optional) {\n        throw new ValidationError(\n            `Missing required property \"${prefix ? prefix + '.' : ''\n            }${fieldName}${fieldInfo.comment ? ' - ' + fieldInfo.comment : ''}\"`\n        );\n    }\n\n    if ('default' in fieldInfo) {\n        return fieldInfo.default;\n    }\n\n    return NIL;\n}\n\nfunction validateObjectBySchema(raw, schema, i18n, prefix) {\n    const latest = {};\n\n    if (typeof raw !== 'object') {\n        throw new ValidationError('The value is not an object.', {\n            raw,\n            prefix,\n        });\n    }\n\n    if (typeof schema === 'function') {\n        // use deferred activation of schema to avoid circullar reference\n        schema = schema();\n    }\n\n    _.forOwn(schema, (fieldInfo, fieldName) => {\n        if (Array.isArray(fieldInfo)) {\n            if (\n                !fieldInfo.find((fieldInfoOption) => {\n                    let validated;\n                    let hasError = false;\n\n                    try {\n                        validated = validateObjectMember(\n                            raw,\n                            fieldName,\n                            { ...fieldInfoOption, skipTypeCast: true },\n                            i18n,\n                            prefix\n                        );\n                    } catch (error) {\n                        hasError = true;\n                        validated = NIL;\n                    }\n\n                    if (validated !== NIL) {\n                        latest[fieldName] = validated;\n                    }\n\n                    return !hasError;\n                })\n            ) {\n                throw new ValidationError(`Invalid \"${fieldName}\" value.`, {\n                    raw,\n                    prefix,\n                });\n            }\n        } else {\n            const validated = validateObjectMember(\n                raw,\n                fieldName,\n                fieldInfo,\n                i18n,\n                prefix\n            );\n            if (validated !== NIL) {\n                latest[fieldName] = validated;\n            }\n        }\n    });\n\n    return latest;\n}\n\nmodule.exports.validateObjectBySchema = validateObjectBySchema;\n"],"mappings":"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"}