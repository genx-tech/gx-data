"use strict";

require("source-map-support/register");

const {
  _,
  pascalCase,
  sleep_
} = require("rk-utils");

const {
  DatabaseError
} = require("./utils/Errors");

const retryFailed = error => [false, error];

const retryOK = result => [true, result];

const directReturn = a => a;

class DbModel {
  constructor(app, connector, i18n) {
    this.app = app;
    this.connector = connector;
    this.i18n = i18n;
    this._modelCache = {};
  }

  get driver() {
    return this.connector.driver;
  }

  model(entityName) {
    if (this._modelCache[entityName]) return this._modelCache[entityName];
    let modelClassName = pascalCase(entityName);
    if (this._modelCache[modelClassName]) return this._modelCache[modelClassName];
    let entityCustomClassFactory = this.loadCustomModel(modelClassName);
    let entityClassFactory = this.loadModel(modelClassName);

    let BaseEntityModel = require(`./drivers/${this.driver}/EntityModel`);

    if (entityCustomClassFactory) {
      BaseEntityModel = entityCustomClassFactory(BaseEntityModel);
    }

    const modelClass = entityClassFactory(BaseEntityModel);
    modelClass.db = this;
    this._modelCache[entityName] = modelClass;

    if (modelClassName !== entityName) {
      this._modelCache[modelClassName] = modelClass;
    }

    return modelClass;
  }

  entitiesOfType(baseEntityName) {
    return _.filter(this.entities, entityName => {
      let Model = this.model(entityName);
      return Model.baseClasses && Model.baseClasses.indexOf(baseEntityName) > -1;
    });
  }

  async retry_(transactionName, transaction, connOptions, maxRetry, interval) {
    if (connOptions && connOptions.connection) {
      return transaction(directReturn, directReturn);
    }

    let i = 0;
    if (maxRetry == null) maxRetry = 3;

    while (i++ < maxRetry) {
      const [finished, result] = await transaction(retryOK, retryFailed);

      if (finished) {
        return result;
      }

      if (i === maxRetry) {
        throw new DatabaseError(`Unable to complete expected transaction after retried ${maxRetry} times.`, result);
      }

      this.app.logException("warn", result, `Unable to complete "${transactionName}" and will try ${maxRetry - i} more times after ${interval || 0} ms.`);

      if (interval != null) {
        await sleep_(interval);
      }
    }
  }

  async safeRetry_(transactionName, transaction, connOptions, maxRetry, interval) {
    return this.retry_(transactionName, (ok, failed) => this.doTransaction_(async connOpts => ok((await transaction(connOpts))), failed, connOptions), connOptions, maxRetry, interval);
  }

  async close_() {
    delete this._modelCache;
    delete this.connector;
    delete this.app;
  }

}

module.exports = DbModel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9EYk1vZGVsLmpzIl0sIm5hbWVzIjpbIl8iLCJwYXNjYWxDYXNlIiwic2xlZXBfIiwicmVxdWlyZSIsIkRhdGFiYXNlRXJyb3IiLCJyZXRyeUZhaWxlZCIsImVycm9yIiwicmV0cnlPSyIsInJlc3VsdCIsImRpcmVjdFJldHVybiIsImEiLCJEYk1vZGVsIiwiY29uc3RydWN0b3IiLCJhcHAiLCJjb25uZWN0b3IiLCJpMThuIiwiX21vZGVsQ2FjaGUiLCJkcml2ZXIiLCJtb2RlbCIsImVudGl0eU5hbWUiLCJtb2RlbENsYXNzTmFtZSIsImVudGl0eUN1c3RvbUNsYXNzRmFjdG9yeSIsImxvYWRDdXN0b21Nb2RlbCIsImVudGl0eUNsYXNzRmFjdG9yeSIsImxvYWRNb2RlbCIsIkJhc2VFbnRpdHlNb2RlbCIsIm1vZGVsQ2xhc3MiLCJkYiIsImVudGl0aWVzT2ZUeXBlIiwiYmFzZUVudGl0eU5hbWUiLCJmaWx0ZXIiLCJlbnRpdGllcyIsIk1vZGVsIiwiYmFzZUNsYXNzZXMiLCJpbmRleE9mIiwicmV0cnlfIiwidHJhbnNhY3Rpb25OYW1lIiwidHJhbnNhY3Rpb24iLCJjb25uT3B0aW9ucyIsIm1heFJldHJ5IiwiaW50ZXJ2YWwiLCJjb25uZWN0aW9uIiwiaSIsImZpbmlzaGVkIiwibG9nRXhjZXB0aW9uIiwic2FmZVJldHJ5XyIsIm9rIiwiZmFpbGVkIiwiZG9UcmFuc2FjdGlvbl8iLCJjb25uT3B0cyIsImNsb3NlXyIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxNQUFNO0FBQUVBLEVBQUFBLENBQUY7QUFBS0MsRUFBQUEsVUFBTDtBQUFpQkMsRUFBQUE7QUFBakIsSUFBNEJDLE9BQU8sQ0FBQyxVQUFELENBQXpDOztBQUNBLE1BQU07QUFBRUMsRUFBQUE7QUFBRixJQUFvQkQsT0FBTyxDQUFDLGdCQUFELENBQWpDOztBQUVBLE1BQU1FLFdBQVcsR0FBSUMsS0FBRCxJQUFXLENBQUMsS0FBRCxFQUFRQSxLQUFSLENB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LGNBQU0sSUFBSW5DLGFBQUosQ0FDRCx5REFBd0RtQyxRQUFTLFNBRGhFLEVBRUYvQixNQUZFLENBQU47QUFJSDs7QUFFRCxXQUFLSyxHQUFMLENBQVMrQixZQUFULENBQ0ksTUFESixFQUVJcEMsTUFGSixFQUdLLHVCQUFzQjRCLGVBQWdCLGtCQUFpQkcsUUFBUSxHQUFHRyxDQUFFLHFCQUNqRUYsUUFBUSxJQUFJLENBQ2YsTUFMTDs7QUFRQSxVQUFJQSxRQUFRLElBQUksSUFBaEIsRUFBc0I7QUFDbEIsY0FBTXRDLE1BQU0sQ0FBQ3NDLFFBQUQsQ0FBWjtBQUNIO0FBQ0o7QUFDSjs7QUFFRCxRQUFNSyxVQUFOLENBQWlCVCxlQUFqQixFQUFrQ0MsV0FBbEMsRUFBK0NDLFdBQS9DLEVBQTREQyxRQUE1RCxFQUFzRUMsUUFBdEUsRUFBZ0Y7QUFDNUUsV0FBTyxLQUFLTCxNQUFMLENBQ0hDLGVBREcsRUFFSCxDQUFDVSxFQUFELEVBQUtDLE1BQUwsS0FBZ0IsS0FBS0MsY0FBTCxDQUFvQixNQUFPQyxRQUFQLElBQW9CSCxFQUFFLEVBQUMsTUFBTVQsV0FBVyxDQUFDWSxRQUFELENBQWxCLEVBQTFDLEVBQXlFRixNQUF6RSxFQUFpRlQsV0FBakYsQ0FGYixFQUdIQSxXQUhHLEVBSUhDLFFBSkcsRUFLSEMsUUFMRyxDQUFQO0FBT0g7O0FBRUQsUUFBTVUsTUFBTixHQUFlO0FBQ1gsV0FBTyxLQUFLbEMsV0FBWjtBQUNBLFdBQU8sS0FBS0YsU0FBWjtBQUNBLFdBQU8sS0FBS0QsR0FBWjtBQUNIOztBQS9GUzs7QUFrR2RzQyxNQUFNLENBQUNDLE9BQVAsR0FBaUJ6QyxPQUFqQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHsgXywgcGFzY2FsQ2FzZSwgc2xlZXBfIH0gPSByZXF1aXJlKFwicmstdXRpbHNcIik7XG5jb25zdCB7IERhdGFiYXNlRXJyb3IgfSA9IHJlcXVpcmUoXCIuL3V0aWxzL0Vycm9yc1wiKTtcblxuY29uc3QgcmV0cnlGYWlsZWQgPSAoZXJyb3IpID0+IFtmYWxzZSwgZXJyb3JdO1xuY29uc3QgcmV0cnlPSyA9IChyZXN1bHQpID0+IFt0cnVlLCByZXN1bHRdO1xuXG5jb25zdCBkaXJlY3RSZXR1cm4gPSAoYSkgPT4gYTtcblxuY2xhc3MgRGJNb2RlbCB7XG4gICAgY29uc3RydWN0b3IoYXBwLCBjb25uZWN0b3IsIGkxOG4pIHtcbiAgICAgICAgdGhpcy5hcHAgPSBhcHA7XG4gICAgICAgIHRoaXMuY29ubmVjdG9yID0gY29ubmVjdG9yO1xuICAgICAgICB0aGlzLmkxOG4gPSBpMThuO1xuXG4gICAgICAgIHRoaXMuX21vZGVsQ2FjaGUgPSB7fTtcbiAgICB9XG5cbiAgICBnZXQgZHJpdmVyKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5jb25uZWN0b3IuZHJpdmVyO1xuICAgIH1cblxuICAgIG1vZGVsKGVudGl0eU5hbWUpIHtcbiAgICAgICAgaWYgKHRoaXMuX21vZGVsQ2FjaGVbZW50aXR5TmFtZV0pIHJldHVybiB0aGlzLl9tb2RlbENhY2hlW2VudGl0eU5hbWVdO1xuXG4gICAgICAgIGxldCBtb2RlbENsYXNzTmFtZSA9IHBhc2NhbENhc2UoZW50aXR5TmFtZSk7XG4gICAgICAgIGlmICh0aGlzLl9tb2RlbENhY2hlW21vZGVsQ2xhc3NOYW1lXSkgcmV0dXJuIHRoaXMuX21vZGVsQ2FjaGVbbW9kZWxDbGFzc05hbWVdO1xuXG4gICAgICAgIGxldCBlbnRpdHlDdXN0b21DbGFzc0ZhY3RvcnkgPSB0aGlzLmxvYWRDdXN0b21Nb2RlbChtb2RlbENsYXNzTmFtZSk7XG4gICAgICAgIGxldCBlbnRpdHlDbGFzc0ZhY3RvcnkgPSB0aGlzLmxvYWRNb2RlbChtb2RlbENsYXNzTmFtZSk7XG5cbiAgICAgICAgbGV0IEJhc2VFbnRpdHlNb2RlbCA9IHJlcXVpcmUoYC4vZHJpdmVycy8ke3RoaXMuZHJpdmVyfS9FbnRpdHlNb2RlbGApO1xuICAgICAgICBpZiAoZW50aXR5Q3VzdG9tQ2xhc3NGYWN0b3J5KSB7XG4gICAgICAgICAgICBCYXNlRW50aXR5TW9kZWwgPSBlbnRpdHlDdXN0b21DbGFzc0ZhY3RvcnkoQmFzZUVudGl0eU1vZGVsKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IG1vZGVsQ2xhc3MgPSBlbnRpdHlDbGFzc0ZhY3RvcnkoQmFzZUVudGl0eU1vZGVsKTtcbiAgICAgICAgbW9kZWxDbGFzcy5kYiA9IHRoaXM7XG5cbiAgICAgICAgdGhpcy5fbW9kZWxDYWNoZVtlbnRpdHlOYW1lXSA9IG1vZGVsQ2xhc3M7XG4gICAgICAgIGlmIChtb2RlbENsYXNzTmFtZSAhPT0gZW50aXR5TmFtZSkge1xuICAgICAgICAgICAgdGhpcy5fbW9kZWxDYWNoZVttb2RlbENsYXNzTmFtZV0gPSBtb2RlbENsYXNzO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG1vZGVsQ2xhc3M7XG4gICAgfVxuXG4gICAgZW50aXRpZXNPZlR5cGUoYmFzZUVudGl0eU5hbWUpIHtcbiAgICAgICAgcmV0dXJuIF8uZmlsdGVyKHRoaXMuZW50aXRpZXMsIChlbnRpdHlOYW1lKSA9PiB7XG4gICAgICAgICAgICBsZXQgTW9kZWwgPSB0aGlzLm1vZGVsKGVudGl0eU5hbWUpO1xuICAgICAgICAgICAgcmV0dXJuIE1vZGVsLmJhc2VDbGFzc2VzICYmIE1vZGVsLmJhc2VDbGFzc2VzLmluZGV4T2YoYmFzZUVudGl0eU5hbWUpID4gLTE7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGFzeW5jIHJldHJ5Xyh0cmFuc2FjdGlvbk5hbWUsIHRyYW5zYWN0aW9uLCBjb25uT3B0aW9ucywgbWF4UmV0cnksIGludGVydmFsKSB7XG4gICAgICAgIGlmIChjb25uT3B0aW9ucyAmJiBjb25uT3B0aW9ucy5jb25uZWN0aW9uKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJhbnNhY3Rpb24oZGlyZWN0UmV0dXJuLCBkaXJlY3RSZXR1cm4pO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGkgPSAwO1xuICAgICAgICBpZiAobWF4UmV0cnkgPT0gbnVsbCkgbWF4UmV0cnkgPSAzO1xuXG4gICAgICAgIHdoaWxlIChpKysgPCBtYXhSZXRyeSkge1xuICAgICAgICAgICAgY29uc3QgW2ZpbmlzaGVkLCByZXN1bHRdID0gYXdhaXQgdHJhbnNhY3Rpb24ocmV0cnlPSywgcmV0cnlGYWlsZWQpO1xuXG4gICAgICAgICAgICBpZiAoZmluaXNoZWQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoaSA9PT0gbWF4UmV0cnkpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRGF0YWJhc2VFcnJvcihcbiAgICAgICAgICAgICAgICAgICAgYFVuYWJsZSB0byBjb21wbGV0ZSBleHBlY3RlZCB0cmFuc2FjdGlvbiBhZnRlciByZXRyaWVkICR7bWF4UmV0cnl9IHRpbWVzLmAsXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdFxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuYXBwLmxvZ0V4Y2VwdGlvbihcbiAgICAgICAgICAgICAgICBcIndhcm5cIixcbiAgICAgICAgICAgICAgICByZXN1bHQsXG4gICAgICAgICAgICAgICAgYFVuYWJsZSB0byBjb21wbGV0ZSBcIiR7dHJhbnNhY3Rpb25OYW1lfVwiIGFuZCB3aWxsIHRyeSAke21heFJldHJ5IC0gaX0gbW9yZSB0aW1lcyBhZnRlciAke1xuICAgICAgICAgICAgICAgICAgICBpbnRlcnZhbCB8fCAwXG4gICAgICAgICAgICAgICAgfSBtcy5gXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICBpZiAoaW50ZXJ2YWwgIT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIGF3YWl0IHNsZWVwXyhpbnRlcnZhbCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBzYWZlUmV0cnlfKHRyYW5zYWN0aW9uTmFtZSwgdHJhbnNhY3Rpb24sIGNvbm5PcHRpb25zLCBtYXhSZXRyeSwgaW50ZXJ2YWwpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucmV0cnlfKFxuICAgICAgICAgICAgdHJhbnNhY3Rpb25OYW1lLFxuICAgICAgICAgICAgKG9rLCBmYWlsZWQpID0+IHRoaXMuZG9UcmFuc2FjdGlvbl8oYXN5bmMgKGNvbm5PcHRzKSA9PiBvayhhd2FpdCB0cmFuc2FjdGlvbihjb25uT3B0cykpLCBmYWlsZWQsIGNvbm5PcHRpb25zKSxcbiAgICAgICAgICAgIGNvbm5PcHRpb25zLFxuICAgICAgICAgICAgbWF4UmV0cnksXG4gICAgICAgICAgICBpbnRlcnZhbFxuICAgICAgICApO1xuICAgIH1cblxuICAgIGFzeW5jIGNsb3NlXygpIHtcbiAgICAgICAgZGVsZXRlIHRoaXMuX21vZGVsQ2FjaGU7XG4gICAgICAgIGRlbGV0ZSB0aGlzLmNvbm5lY3RvcjtcbiAgICAgICAgZGVsZXRlIHRoaXMuYXBwO1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBEYk1vZGVsO1xuIl19