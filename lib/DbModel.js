"use strict";

require("source-map-support/register");

const {
  _,
  naming,
  sleep_
} = require("@genx/july");

const retryFailed = error => [false, error];

const retryOK = result => [true, result];

const directReturn = a => a;

class DbModel {
  constructor(app, connector, i18n) {
    this.app = app;
    this.connector = connector;
    this.i18n = i18n;
    this._modelCache = {};
  }

  get driver() {
    return this.connector.driver;
  }

  model(entityName) {
    if (this._modelCache[entityName]) return this._modelCache[entityName];
    let modelClassName = naming.pascalCase(entityName);
    if (this._modelCache[modelClassName]) return this._modelCache[modelClassName];
    let entityCustomClassFactory = this.loadCustomModel(modelClassName);
    let entityClassFactory = this.loadModel(modelClassName);

    let BaseEntityModel = require(`./drivers/${this.driver}/EntityModel`);

    if (entityCustomClassFactory) {
      BaseEntityModel = entityCustomClassFactory(BaseEntityModel);
    }

    const modelClass = entityClassFactory(BaseEntityModel);
    modelClass.db = this;

    if (modelClass.__init) {
      modelClass.__init();
    }

    this._modelCache[entityName] = modelClass;

    if (modelClassName !== entityName) {
      this._modelCache[modelClassName] = modelClass;
    }

    return modelClass;
  }

  entitiesOfType(baseEntityName) {
    return _.filter(this.entities, entityName => {
      let Model = this.model(entityName);
      return Model.baseClasses && Model.baseClasses.indexOf(baseEntityName) > -1;
    });
  }

  async retry_(transactionName, action_, connOptions, maxRetry, interval, onRetry_) {
    if (connOptions && connOptions.connection) {
      return action_(directReturn, directReturn);
    }

    let i = 0;
    if (maxRetry == null) maxRetry = 2;

    while (i++ < maxRetry) {
      const [finished, result] = await action_(retryOK, retryFailed);

      if (finished) {
        return result;
      }

      if (i === maxRetry) {
        throw result;
      }

      this.app.logException("warn", result, `Unable to complete "${transactionName}" and will try ${maxRetry - i} more times after ${interval || 0} ms.`);

      if (interval != null) {
        await sleep_(interval);
      }

      if (onRetry_) {
        await onRetry_();
      }
    }
  }

  async safeRetry_(transactionName, action_, connOptions, maxRetry, interval, onRetry_) {
    return this.retry_(transactionName, (ok, failed) => this.doTransaction_(async connOpts => ok((await action_(connOpts))), failed, connOptions), connOptions, maxRetry, interval, onRetry_);
  }

  async close_() {
    delete this._modelCache;
    delete this.connector;
    delete this.app;
  }

}

module.exports = DbModel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9EYk1vZGVsLmpzIl0sIm5hbWVzIjpbIl8iLCJuYW1pbmciLCJzbGVlcF8iLCJyZXF1aXJlIiwicmV0cnlGYWlsZWQiLCJlcnJvciIsInJldHJ5T0siLCJyZXN1bHQiLCJkaXJlY3RSZXR1cm4iLCJhIiwiRGJNb2RlbCIsImNvbnN0cnVjdG9yIiwiYXBwIiwiY29ubmVjdG9yIiwiaTE4biIsIl9tb2RlbENhY2hlIiwiZHJpdmVyIiwibW9kZWwiLCJlbnRpdHlOYW1lIiwibW9kZWxDbGFzc05hbWUiLCJwYXNjYWxDYXNlIiwiZW50aXR5Q3VzdG9tQ2xhc3NGYWN0b3J5IiwibG9hZEN1c3RvbU1vZGVsIiwiZW50aXR5Q2xhc3NGYWN0b3J5IiwibG9hZE1vZGVsIiwiQmFzZUVudGl0eU1vZGVsIiwibW9kZWxDbGFzcyIsImRiIiwiX19pbml0IiwiZW50aXRpZXNPZlR5cGUiLCJiYXNlRW50aXR5TmFtZSIsImZpbHRlciIsImVudGl0aWVzIiwiTW9kZWwiLCJiYXNlQ2xhc3NlcyIsImluZGV4T2YiLCJyZXRyeV8iLCJ0cmFuc2FjdGlvbk5hbWUiLCJhY3Rpb25fIiwiY29ubk9wdGlvbnMiLCJtYXhSZXRyeSIsImludGVydmFsIiwib25SZXRyeV8iLCJjb25uZWN0aW9uIiwiaSIsImZpbmlzaGVkIiwibG9nRXhjZXB0aW9uIiwic2FmZVJldHJ5XyIsIm9rIiwiZmFpbGVkIiwiZG9UcmFuc2FjdGlvbl8iLCJjb25uT3B0cyIsImNsb3NlXyIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxNQUFNO0FBQUVBLEVBQUFBLENBQUY7QUFBS0MsRUFBQUEsTUFBTDtBQUFhQyxFQUFBQTtBQUFiLElBQXdCQyxPQUFPLENBQUMsWUFBRCxDQUFyQzs7QUFFQSxNQUFNQyxXQUFXLEdBQUlDLEtBQUQsSUFBVyxDQUFDLEtBQUQsRUFBUUEsS0FBUixDQUEvQjs7QUFDQSxNQUFNQyxPQUFPLEdBQUlDLE1BQUQsSUFBWSxDQUFDLElBQUQsRUFB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QUFDSDs7QUFFRCxVQUFJcUMsQ0FBQyxLQUFLSixRQUFWLEVBQW9CO0FBQ2hCLGNBQU1qQyxNQUFOO0FBQ0g7O0FBRUQsV0FBS0ssR0FBTCxDQUFTa0MsWUFBVCxDQUNJLE1BREosRUFFSXZDLE1BRkosRUFHSyx1QkFBc0I4QixlQUFnQixrQkFBaUJHLFFBQVEsR0FBR0ksQ0FBRSxxQkFDakVILFFBQVEsSUFBSSxDQUNmLE1BTEw7O0FBUUEsVUFBSUEsUUFBUSxJQUFJLElBQWhCLEVBQXNCO0FBQ2xCLGNBQU12QyxNQUFNLENBQUN1QyxRQUFELENBQVo7QUFDSDs7QUFFRCxVQUFJQyxRQUFKLEVBQWM7QUFDVixjQUFNQSxRQUFRLEVBQWQ7QUFDSDtBQUNKO0FBQ0o7O0FBV0QsUUFBTUssVUFBTixDQUFpQlYsZUFBakIsRUFBa0NDLE9BQWxDLEVBQTJDQyxXQUEzQyxFQUF3REMsUUFBeEQsRUFBa0VDLFFBQWxFLEVBQTRFQyxRQUE1RSxFQUFzRjtBQUNsRixXQUFPLEtBQUtOLE1BQUwsQ0FDSEMsZUFERyxFQUVILENBQUNXLEVBQUQsRUFBS0MsTUFBTCxLQUFnQixLQUFLQyxjQUFMLENBQW9CLE1BQU9DLFFBQVAsSUFBb0JILEVBQUUsRUFBQyxNQUFNVixPQUFPLENBQUNhLFFBQUQsQ0FBZCxFQUExQyxFQUFxRUYsTUFBckUsRUFBNkVWLFdBQTdFLENBRmIsRUFHSEEsV0FIRyxFQUlIQyxRQUpHLEVBS0hDLFFBTEcsRUFNSEMsUUFORyxDQUFQO0FBUUg7O0FBRUQsUUFBTVUsTUFBTixHQUFlO0FBQ1gsV0FBTyxLQUFLckMsV0FBWjtBQUNBLFdBQU8sS0FBS0YsU0FBWjtBQUNBLFdBQU8sS0FBS0QsR0FBWjtBQUNIOztBQTVIUzs7QUErSGR5QyxNQUFNLENBQUNDLE9BQVAsR0FBaUI1QyxPQUFqQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHsgXywgbmFtaW5nLCBzbGVlcF8gfSA9IHJlcXVpcmUoXCJAZ2VueC9qdWx5XCIpO1xuXG5jb25zdCByZXRyeUZhaWxlZCA9IChlcnJvcikgPT4gW2ZhbHNlLCBlcnJvcl07XG5jb25zdCByZXRyeU9LID0gKHJlc3VsdCkgPT4gW3RydWUsIHJlc3VsdF07XG5cbmNvbnN0IGRpcmVjdFJldHVybiA9IChhKSA9PiBhO1xuXG5jbGFzcyBEYk1vZGVsIHtcbiAgICBjb25zdHJ1Y3RvcihhcHAsIGNvbm5lY3RvciwgaTE4bikge1xuICAgICAgICB0aGlzLmFwcCA9IGFwcDtcbiAgICAgICAgdGhpcy5jb25uZWN0b3IgPSBjb25uZWN0b3I7XG4gICAgICAgIHRoaXMuaTE4biA9IGkxOG47XG5cbiAgICAgICAgdGhpcy5fbW9kZWxDYWNoZSA9IHt9O1xuICAgIH1cblxuICAgIGdldCBkcml2ZXIoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmNvbm5lY3Rvci5kcml2ZXI7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGVudGl0eSBtb2RlbCBjbGFzcyBieSBlbnRpdHkgbmFtZS5cbiAgICAgKiBAcGFyYW0geyp9IGVudGl0eU5hbWUgXG4gICAgICovXG4gICAgbW9kZWwoZW50aXR5TmFtZSkge1xuICAgICAgICBpZiAodGhpcy5fbW9kZWxDYWNoZVtlbnRpdHlOYW1lXSkgcmV0dXJuIHRoaXMuX21vZGVsQ2FjaGVbZW50aXR5TmFtZV07XG5cbiAgICAgICAgbGV0IG1vZGVsQ2xhc3NOYW1lID0gbmFtaW5nLnBhc2NhbENhc2UoZW50aXR5TmFtZSk7XG4gICAgICAgIGlmICh0aGlzLl9tb2RlbENhY2hlW21vZGVsQ2xhc3NOYW1lXSkgcmV0dXJuIHRoaXMuX21vZGVsQ2FjaGVbbW9kZWxDbGFzc05hbWVdO1xuXG4gICAgICAgIGxldCBlbnRpdHlDdXN0b21DbGFzc0ZhY3RvcnkgPSB0aGlzLmxvYWRDdXN0b21Nb2RlbChtb2RlbENsYXNzTmFtZSk7XG4gICAgICAgIGxldCBlbnRpdHlDbGFzc0ZhY3RvcnkgPSB0aGlzLmxvYWRNb2RlbChtb2RlbENsYXNzTmFtZSk7XG5cbiAgICAgICAgbGV0IEJhc2VFbnRpdHlNb2RlbCA9IHJlcXVpcmUoYC4vZHJpdmVycy8ke3RoaXMuZHJpdmVyfS9FbnRpdHlNb2RlbGApO1xuICAgICAgICBpZiAoZW50aXR5Q3VzdG9tQ2xhc3NGYWN0b3J5KSB7XG4gICAgICAgICAgICBCYXNlRW50aXR5TW9kZWwgPSBlbnRpdHlDdXN0b21DbGFzc0ZhY3RvcnkoQmFzZUVudGl0eU1vZGVsKTsgICAgICAgICAgICBcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IG1vZGVsQ2xhc3MgPSBlbnRpdHlDbGFzc0ZhY3RvcnkoQmFzZUVudGl0eU1vZGVsKTtcbiAgICAgICAgbW9kZWxDbGFzcy5kYiA9IHRoaXM7XG5cbiAgICAgICAgaWYgKG1vZGVsQ2xhc3MuX19pbml0KSB7XG4gICAgICAgICAgICBtb2RlbENsYXNzLl9faW5pdCgpO1xuICAgICAgICB9XG4gXG4gICAgICAgIHRoaXMuX21vZGVsQ2FjaGVbZW50aXR5TmFtZV0gPSBtb2RlbENsYXNzO1xuICAgICAgICBpZiAobW9kZWxDbGFzc05hbWUgIT09IGVudGl0eU5hbWUpIHtcbiAgICAgICAgICAgIHRoaXMuX21vZGVsQ2FjaGVbbW9kZWxDbGFzc05hbWVdID0gbW9kZWxDbGFzcztcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBtb2RlbENsYXNzO1xuICAgIH1cblxuICAgIGVudGl0aWVzT2ZUeXBlKGJhc2VFbnRpdHlOYW1lKSB7XG4gICAgICAgIHJldHVybiBfLmZpbHRlcih0aGlzLmVudGl0aWVzLCAoZW50aXR5TmFtZSkgPT4ge1xuICAgICAgICAgICAgbGV0IE1vZGVsID0gdGhpcy5tb2RlbChlbnRpdHlOYW1lKTtcbiAgICAgICAgICAgIHJldHVybiBNb2RlbC5iYXNlQ2xhc3NlcyAmJiBNb2RlbC5iYXNlQ2xhc3Nlcy5pbmRleE9mKGJhc2VFbnRpdHlOYW1lKSA+IC0xO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSdW4gYW4gYWN0aW9uIGFuZCBhdXRvbWF0aWNhbGx5IHJldHJ5IHdoZW4gZmFpbGVkLiBcbiAgICAgKiBAcGFyYW0geyp9IHRyYW5zYWN0aW9uTmFtZSBcbiAgICAgKiBAcGFyYW0geyp9IGFjdGlvbl8gXG4gICAgICogQHBhcmFtIHsqfSBjb25uT3B0aW9ucyBcbiAgICAgKiBAcGFyYW0geyp9IG1heFJldHJ5IFxuICAgICAqIEBwYXJhbSB7Kn0gaW50ZXJ2YWwgXG4gICAgICogQHBhcmFtIHsqfSBvblJldHJ5XyBcbiAgICAgKi9cbiAgICBhc3luYyByZXRyeV8odHJhbnNhY3Rpb25OYW1lLCBhY3Rpb25fLCBjb25uT3B0aW9ucywgbWF4UmV0cnksIGludGVydmFsLCBvblJldHJ5Xykge1xuICAgICAgICAvL3JldHJ5IHdpbGwgYmUgaWdub3JlZCwgaWYgdGhlIHRyYW5zYWN0aW9uIGlzIGEgcGFydCBvZiBhbm90aGVyIHRyYW5zYWN0aW9uXG4gICAgICAgIGlmIChjb25uT3B0aW9ucyAmJiBjb25uT3B0aW9ucy5jb25uZWN0aW9uKSB7XG4gICAgICAgICAgICByZXR1cm4gYWN0aW9uXyhkaXJlY3RSZXR1cm4sIGRpcmVjdFJldHVybik7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgaSA9IDA7XG4gICAgICAgIGlmIChtYXhSZXRyeSA9PSBudWxsKSBtYXhSZXRyeSA9IDI7XG5cbiAgICAgICAgd2hpbGUgKGkrKyA8IG1heFJldHJ5KSB7XG4gICAgICAgICAgICBjb25zdCBbZmluaXNoZWQsIHJlc3VsdF0gPSBhd2FpdCBhY3Rpb25fKHJldHJ5T0ssIHJldHJ5RmFpbGVkKTtcblxuICAgICAgICAgICAgaWYgKGZpbmlzaGVkKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGkgPT09IG1heFJldHJ5KSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgcmVzdWx0O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLmFwcC5sb2dFeGNlcHRpb24oXG4gICAgICAgICAgICAgICAgXCJ3YXJuXCIsXG4gICAgICAgICAgICAgICAgcmVzdWx0LFxuICAgICAgICAgICAgICAgIGBVbmFibGUgdG8gY29tcGxldGUgXCIke3RyYW5zYWN0aW9uTmFtZX1cIiBhbmQgd2lsbCB0cnkgJHttYXhSZXRyeSAtIGl9IG1vcmUgdGltZXMgYWZ0ZXIgJHtcbiAgICAgICAgICAgICAgICAgICAgaW50ZXJ2YWwgfHwgMFxuICAgICAgICAgICAgICAgIH0gbXMuYFxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgaWYgKGludGVydmFsICE9IG51bGwpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCBzbGVlcF8oaW50ZXJ2YWwpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAob25SZXRyeV8pIHtcbiAgICAgICAgICAgICAgICBhd2FpdCBvblJldHJ5XygpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUnVuIGFuIGFjdGlvbiBhcyB0cmFuc2FjdGlvbiBhbmQgYXV0b21hdGljYWxseSByZXRyeSB3aGVuIGZhaWxlZC4gXG4gICAgICogQHBhcmFtIHsqfSB0cmFuc2FjdGlvbk5hbWUgXG4gICAgICogQHBhcmFtIHsqfSBhY3Rpb25fIFxuICAgICAqIEBwYXJhbSB7Kn0gY29ubk9wdGlvbnMgXG4gICAgICogQHBhcmFtIHsqfSBtYXhSZXRyeSBcbiAgICAgKiBAcGFyYW0geyp9IGludGVydmFsIFxuICAgICAqIEBwYXJhbSB7Kn0gb25SZXRyeV8gXG4gICAgICovXG4gICAgYXN5bmMgc2FmZVJldHJ5Xyh0cmFuc2FjdGlvbk5hbWUsIGFjdGlvbl8sIGNvbm5PcHRpb25zLCBtYXhSZXRyeSwgaW50ZXJ2YWwsIG9uUmV0cnlfKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnJldHJ5XyhcbiAgICAgICAgICAgIHRyYW5zYWN0aW9uTmFtZSxcbiAgICAgICAgICAgIChvaywgZmFpbGVkKSA9PiB0aGlzLmRvVHJhbnNhY3Rpb25fKGFzeW5jIChjb25uT3B0cykgPT4gb2soYXdhaXQgYWN0aW9uXyhjb25uT3B0cykpLCBmYWlsZWQsIGNvbm5PcHRpb25zKSxcbiAgICAgICAgICAgIGNvbm5PcHRpb25zLFxuICAgICAgICAgICAgbWF4UmV0cnksXG4gICAgICAgICAgICBpbnRlcnZhbCxcbiAgICAgICAgICAgIG9uUmV0cnlfXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgYXN5bmMgY2xvc2VfKCkge1xuICAgICAgICBkZWxldGUgdGhpcy5fbW9kZWxDYWNoZTtcbiAgICAgICAgZGVsZXRlIHRoaXMuY29ubmVjdG9yO1xuICAgICAgICBkZWxldGUgdGhpcy5hcHA7XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IERiTW9kZWw7XG4iXX0=