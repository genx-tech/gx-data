"use strict";

require("source-map-support/register");

const {
  _,
  pascalCase,
  sleep_
} = require("rk-utils");

const {
  DatabaseError
} = require("./utils/Errors");

const retryFailed = error => [false, error];

const retryOK = result => [true, result];

const directReturn = a => a;

class DbModel {
  constructor(app, connector, i18n) {
    this.app = app;
    this.connector = connector;
    this.i18n = i18n;
    this._modelCache = {};
  }

  get driver() {
    return this.connector.driver;
  }

  model(entityName) {
    if (this._modelCache[entityName]) return this._modelCache[entityName];
    let modelClassName = pascalCase(entityName);
    if (this._modelCache[modelClassName]) return this._modelCache[modelClassName];
    let entityCustomClassFactory = this.loadCustomModel(modelClassName);
    let entityClassFactory = this.loadModel(modelClassName);

    let BaseEntityModel = require(`./drivers/${this.driver}/EntityModel`);

    if (entityCustomClassFactory) {
      BaseEntityModel = entityCustomClassFactory(BaseEntityModel);
    }

    const modelClass = entityClassFactory(BaseEntityModel);
    modelClass.db = this;
    this._modelCache[entityName] = modelClass;

    if (modelClassName !== entityName) {
      this._modelCache[modelClassName] = modelClass;
    }

    return modelClass;
  }

  entitiesOfType(baseEntityName) {
    return _.filter(this.entities, entityName => {
      let Model = this.model(entityName);
      return Model.baseClasses && Model.baseClasses.indexOf(baseEntityName) > -1;
    });
  }

  async retry_(transactionName, transaction, connOptions, maxRetry, interval) {
    if (connOptions && connOptions.connection) {
      return transaction(directReturn, directReturn);
    }

    let i = 0;
    if (maxRetry == null) maxRetry = 3;

    while (i++ < maxRetry) {
      const [finished, result] = await transaction(retryOK, retryFailed);

      if (finished) {
        return result;
      }

      if (i === maxRetry) {
        throw result;
      }

      this.app.logException("warn", result, `Unable to complete "${transactionName}" and will try ${maxRetry - i} more times after ${interval || 0} ms.`);

      if (interval != null) {
        await sleep_(interval);
      }
    }
  }

  async safeRetry_(transactionName, transaction, connOptions, maxRetry, interval) {
    return this.retry_(transactionName, (ok, failed) => this.doTransaction_(async connOpts => ok((await transaction(connOpts))), failed, connOptions), connOptions, maxRetry, interval);
  }

  async close_() {
    delete this._modelCache;
    delete this.connector;
    delete this.app;
  }

}

module.exports = DbModel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9EYk1vZGVsLmpzIl0sIm5hbWVzIjpbIl8iLCJwYXNjYWxDYXNlIiwic2xlZXBfIiwicmVxdWlyZSIsIkRhdGFiYXNlRXJyb3IiLCJyZXRyeUZhaWxlZCIsImVycm9yIiwicmV0cnlPSyIsInJlc3VsdCIsImRpcmVjdFJldHVybiIsImEiLCJEYk1vZGVsIiwiY29uc3RydWN0b3IiLCJhcHAiLCJjb25uZWN0b3IiLCJpMThuIiwiX21vZGVsQ2FjaGUiLCJkcml2ZXIiLCJtb2RlbCIsImVudGl0eU5hbWUiLCJtb2RlbENsYXNzTmFtZSIsImVudGl0eUN1c3RvbUNsYXNzRmFjdG9yeSIsImxvYWRDdXN0b21Nb2RlbCIsImVudGl0eUNsYXNzRmFjdG9yeSIsImxvYWRNb2RlbCIsIkJhc2VFbnRpdHlNb2RlbCIsIm1vZGVsQ2xhc3MiLCJkYiIsImVudGl0aWVzT2ZUeXBlIiwiYmFzZUVudGl0eU5hbWUiLCJmaWx0ZXIiLCJlbnRpdGllcyIsIk1vZGVsIiwiYmFzZUNsYXNzZXMiLCJpbmRleE9mIiwicmV0cnlfIiwidHJhbnNhY3Rpb25OYW1lIiwidHJhbnNhY3Rpb24iLCJjb25uT3B0aW9ucyIsIm1heFJldHJ5IiwiaW50ZXJ2YWwiLCJjb25uZWN0aW9uIiwiaSIsImZpbmlzaGVkIiwibG9nRXhjZXB0aW9uIiwic2FmZVJldHJ5XyIsIm9rIiwiZmFpbGVkIiwiZG9UcmFuc2FjdGlvbl8iLCJjb25uT3B0cyIsImNsb3NlXyIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxNQUFNO0FBQUVBLEVBQUFBLENBQUY7QUFBS0MsRUFBQUEsVUFBTDtBQUFpQkMsRUFBQUE7QUFBakIsSUFBNEJDLE9BQU8sQ0FBQyxVQUFELENBQXpDOztBQUNBLE1BQU07QUFBRUMsRUFBQUE7QUFBRixJQUFvQkQsT0FBTyxDQUFDLGdCQUFELENBQWpDOztBQUVBLE1BQU1FLFdBQVcsR0FBSUMsS0FBRCxJQUFXLENBQUMsS0FBRCxFQUFRQSxLQUFSLENB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LGNBQU0vQixNQUFOO0FBQ0g7O0FBRUQsV0FBS0ssR0FBTCxDQUFTK0IsWUFBVCxDQUNJLE1BREosRUFFSXBDLE1BRkosRUFHSyx1QkFBc0I0QixlQUFnQixrQkFBaUJHLFFBQVEsR0FBR0csQ0FBRSxxQkFDakVGLFFBQVEsSUFBSSxDQUNmLE1BTEw7O0FBUUEsVUFBSUEsUUFBUSxJQUFJLElBQWhCLEVBQXNCO0FBQ2xCLGNBQU10QyxNQUFNLENBQUNzQyxRQUFELENBQVo7QUFDSDtBQUNKO0FBQ0o7O0FBRUQsUUFBTUssVUFBTixDQUFpQlQsZUFBakIsRUFBa0NDLFdBQWxDLEVBQStDQyxXQUEvQyxFQUE0REMsUUFBNUQsRUFBc0VDLFFBQXRFLEVBQWdGO0FBQzVFLFdBQU8sS0FBS0wsTUFBTCxDQUNIQyxlQURHLEVBRUgsQ0FBQ1UsRUFBRCxFQUFLQyxNQUFMLEtBQWdCLEtBQUtDLGNBQUwsQ0FBb0IsTUFBT0MsUUFBUCxJQUFvQkgsRUFBRSxFQUFDLE1BQU1ULFdBQVcsQ0FBQ1ksUUFBRCxDQUFsQixFQUExQyxFQUF5RUYsTUFBekUsRUFBaUZULFdBQWpGLENBRmIsRUFHSEEsV0FIRyxFQUlIQyxRQUpHLEVBS0hDLFFBTEcsQ0FBUDtBQU9IOztBQUVELFFBQU1VLE1BQU4sR0FBZTtBQUNYLFdBQU8sS0FBS2xDLFdBQVo7QUFDQSxXQUFPLEtBQUtGLFNBQVo7QUFDQSxXQUFPLEtBQUtELEdBQVo7QUFDSDs7QUE1RlM7O0FBK0Zkc0MsTUFBTSxDQUFDQyxPQUFQLEdBQWlCekMsT0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCB7IF8sIHBhc2NhbENhc2UsIHNsZWVwXyB9ID0gcmVxdWlyZShcInJrLXV0aWxzXCIpO1xuY29uc3QgeyBEYXRhYmFzZUVycm9yIH0gPSByZXF1aXJlKFwiLi91dGlscy9FcnJvcnNcIik7XG5cbmNvbnN0IHJldHJ5RmFpbGVkID0gKGVycm9yKSA9PiBbZmFsc2UsIGVycm9yXTtcbmNvbnN0IHJldHJ5T0sgPSAocmVzdWx0KSA9PiBbdHJ1ZSwgcmVzdWx0XTtcblxuY29uc3QgZGlyZWN0UmV0dXJuID0gKGEpID0+IGE7XG5cbmNsYXNzIERiTW9kZWwge1xuICAgIGNvbnN0cnVjdG9yKGFwcCwgY29ubmVjdG9yLCBpMThuKSB7XG4gICAgICAgIHRoaXMuYXBwID0gYXBwO1xuICAgICAgICB0aGlzLmNvbm5lY3RvciA9IGNvbm5lY3RvcjtcbiAgICAgICAgdGhpcy5pMThuID0gaTE4bjtcblxuICAgICAgICB0aGlzLl9tb2RlbENhY2hlID0ge307XG4gICAgfVxuXG4gICAgZ2V0IGRyaXZlcigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY29ubmVjdG9yLmRyaXZlcjtcbiAgICB9XG5cbiAgICBtb2RlbChlbnRpdHlOYW1lKSB7XG4gICAgICAgIGlmICh0aGlzLl9tb2RlbENhY2hlW2VudGl0eU5hbWVdKSByZXR1cm4gdGhpcy5fbW9kZWxDYWNoZVtlbnRpdHlOYW1lXTtcblxuICAgICAgICBsZXQgbW9kZWxDbGFzc05hbWUgPSBwYXNjYWxDYXNlKGVudGl0eU5hbWUpO1xuICAgICAgICBpZiAodGhpcy5fbW9kZWxDYWNoZVttb2RlbENsYXNzTmFtZV0pIHJldHVybiB0aGlzLl9tb2RlbENhY2hlW21vZGVsQ2xhc3NOYW1lXTtcblxuICAgICAgICBsZXQgZW50aXR5Q3VzdG9tQ2xhc3NGYWN0b3J5ID0gdGhpcy5sb2FkQ3VzdG9tTW9kZWwobW9kZWxDbGFzc05hbWUpO1xuICAgICAgICBsZXQgZW50aXR5Q2xhc3NGYWN0b3J5ID0gdGhpcy5sb2FkTW9kZWwobW9kZWxDbGFzc05hbWUpO1xuXG4gICAgICAgIGxldCBCYXNlRW50aXR5TW9kZWwgPSByZXF1aXJlKGAuL2RyaXZlcnMvJHt0aGlzLmRyaXZlcn0vRW50aXR5TW9kZWxgKTtcbiAgICAgICAgaWYgKGVudGl0eUN1c3RvbUNsYXNzRmFjdG9yeSkge1xuICAgICAgICAgICAgQmFzZUVudGl0eU1vZGVsID0gZW50aXR5Q3VzdG9tQ2xhc3NGYWN0b3J5KEJhc2VFbnRpdHlNb2RlbCk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBtb2RlbENsYXNzID0gZW50aXR5Q2xhc3NGYWN0b3J5KEJhc2VFbnRpdHlNb2RlbCk7XG4gICAgICAgIG1vZGVsQ2xhc3MuZGIgPSB0aGlzO1xuXG4gICAgICAgIHRoaXMuX21vZGVsQ2FjaGVbZW50aXR5TmFtZV0gPSBtb2RlbENsYXNzO1xuICAgICAgICBpZiAobW9kZWxDbGFzc05hbWUgIT09IGVudGl0eU5hbWUpIHtcbiAgICAgICAgICAgIHRoaXMuX21vZGVsQ2FjaGVbbW9kZWxDbGFzc05hbWVdID0gbW9kZWxDbGFzcztcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBtb2RlbENsYXNzO1xuICAgIH1cblxuICAgIGVudGl0aWVzT2ZUeXBlKGJhc2VFbnRpdHlOYW1lKSB7XG4gICAgICAgIHJldHVybiBfLmZpbHRlcih0aGlzLmVudGl0aWVzLCAoZW50aXR5TmFtZSkgPT4ge1xuICAgICAgICAgICAgbGV0IE1vZGVsID0gdGhpcy5tb2RlbChlbnRpdHlOYW1lKTtcbiAgICAgICAgICAgIHJldHVybiBNb2RlbC5iYXNlQ2xhc3NlcyAmJiBNb2RlbC5iYXNlQ2xhc3Nlcy5pbmRleE9mKGJhc2VFbnRpdHlOYW1lKSA+IC0xO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBhc3luYyByZXRyeV8odHJhbnNhY3Rpb25OYW1lLCB0cmFuc2FjdGlvbiwgY29ubk9wdGlvbnMsIG1heFJldHJ5LCBpbnRlcnZhbCkge1xuICAgICAgICBpZiAoY29ubk9wdGlvbnMgJiYgY29ubk9wdGlvbnMuY29ubmVjdGlvbikge1xuICAgICAgICAgICAgcmV0dXJuIHRyYW5zYWN0aW9uKGRpcmVjdFJldHVybiwgZGlyZWN0UmV0dXJuKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBpID0gMDtcbiAgICAgICAgaWYgKG1heFJldHJ5ID09IG51bGwpIG1heFJldHJ5ID0gMztcblxuICAgICAgICB3aGlsZSAoaSsrIDwgbWF4UmV0cnkpIHtcbiAgICAgICAgICAgIGNvbnN0IFtmaW5pc2hlZCwgcmVzdWx0XSA9IGF3YWl0IHRyYW5zYWN0aW9uKHJldHJ5T0ssIHJldHJ5RmFpbGVkKTtcblxuICAgICAgICAgICAgaWYgKGZpbmlzaGVkKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGkgPT09IG1heFJldHJ5KSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgcmVzdWx0O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLmFwcC5sb2dFeGNlcHRpb24oXG4gICAgICAgICAgICAgICAgXCJ3YXJuXCIsXG4gICAgICAgICAgICAgICAgcmVzdWx0LFxuICAgICAgICAgICAgICAgIGBVbmFibGUgdG8gY29tcGxldGUgXCIke3RyYW5zYWN0aW9uTmFtZX1cIiBhbmQgd2lsbCB0cnkgJHttYXhSZXRyeSAtIGl9IG1vcmUgdGltZXMgYWZ0ZXIgJHtcbiAgICAgICAgICAgICAgICAgICAgaW50ZXJ2YWwgfHwgMFxuICAgICAgICAgICAgICAgIH0gbXMuYFxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgaWYgKGludGVydmFsICE9IG51bGwpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCBzbGVlcF8oaW50ZXJ2YWwpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgc2FmZVJldHJ5Xyh0cmFuc2FjdGlvbk5hbWUsIHRyYW5zYWN0aW9uLCBjb25uT3B0aW9ucywgbWF4UmV0cnksIGludGVydmFsKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnJldHJ5XyhcbiAgICAgICAgICAgIHRyYW5zYWN0aW9uTmFtZSxcbiAgICAgICAgICAgIChvaywgZmFpbGVkKSA9PiB0aGlzLmRvVHJhbnNhY3Rpb25fKGFzeW5jIChjb25uT3B0cykgPT4gb2soYXdhaXQgdHJhbnNhY3Rpb24oY29ubk9wdHMpKSwgZmFpbGVkLCBjb25uT3B0aW9ucyksXG4gICAgICAgICAgICBjb25uT3B0aW9ucyxcbiAgICAgICAgICAgIG1heFJldHJ5LFxuICAgICAgICAgICAgaW50ZXJ2YWxcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBhc3luYyBjbG9zZV8oKSB7XG4gICAgICAgIGRlbGV0ZSB0aGlzLl9tb2RlbENhY2hlO1xuICAgICAgICBkZWxldGUgdGhpcy5jb25uZWN0b3I7XG4gICAgICAgIGRlbGV0ZSB0aGlzLmFwcDtcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gRGJNb2RlbDtcbiJdfQ==