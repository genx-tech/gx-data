"use strict";

require("source-map-support/register");

const {
  _,
  pascalCase
} = require('rk-utils');

class DbModel {
  constructor(app, connector, i18n) {
    this.app = app;
    this.connector = connector;
    this.i18n = i18n;
    this._modelCache = {};
  }

  get driver() {
    return this.connector.driver;
  }

  model(entityName) {
    if (this._modelCache[entityName]) return this._modelCache[entityName];
    let modelClassName = pascalCase(entityName);
    if (this._modelCache[modelClassName]) return this._modelCache[modelClassName];
    let entitySpecMixin = this.loadModel(modelClassName);

    const BaseEntityModel = require(`./drivers/${this.driver}/EntityModel`);

    const modelClass = entitySpecMixin(this, BaseEntityModel);
    this._modelCache[entityName] = modelClass;

    if (modelClassName !== entityName) {
      this._modelCache[modelClassName] = modelClass;
    }

    return modelClass;
  }

  entitiesOfType(baseEntityName) {
    return _.filter(this.entities, entityName => {
      let Model = this.model(entityName);
      return Model.baseClasses && Model.baseClasses.indexOf(baseEntityName) > -1;
    });
  }

  async close_() {
    delete this._modelCache;
    delete this.connector;
    delete this.app;
  }

}

module.exports = DbModel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9EYk1vZGVsLmpzIl0sIm5hbWVzIjpbIl8iLCJwYXNjYWxDYXNlIiwicmVxdWlyZSIsIkRiTW9kZWwiLCJjb25zdHJ1Y3RvciIsImFwcCIsImNvbm5lY3RvciIsImkxOG4iLCJfbW9kZWxDYWNoZSIsImRyaXZlciIsIm1vZGVsIiwiZW50aXR5TmFtZSIsIm1vZGVsQ2xhc3NOYW1lIiwiZW50aXR5U3BlY01peGluIiwibG9hZE1vZGVsIiwiQmFzZUVudGl0eU1vZGVsIiwibW9kZWxDbGFzcyIsImVudGl0aWVzT2ZUeXBlIiwiYmFzZUVudGl0eU5hbWUiLCJmaWx0ZXIiLCJlbnRpdGllcyIsIk1vZGVsIiwiYmFzZUNsYXNzZXMiLCJpbmRleE9mIiwiY2xvc2VfIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU07QUFBRUEsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQTtBQUFMLElBQW9CQyxPQUFPLENBQUMsVUFBRCxDQUFqQzs7QUFFQSxNQUFNQyxPQUFOLENBQWM7QUFDVkMsRUFBQUEsV0FBVyxDQUFDQyxHQUFELEVBQU1DLFNBQU4sRUFBaUJDLElBQWpCLEVBQXVCO0FBQzlCLFNBQUtGLEdBQUwsR0FBV0EsR0FBWDtBQUNBLFNBQUtDLFNBQUwsR0FBaUJBLFNBQWpCO0FBQ0EsU0FBS0MsSUFBTCxHQUFZQSxJQUFaO0FBRUEsU0FBS0MsV0FBTCxHQUFtQixFQUFuQjtBQUNIOztBQUVELE1BQUlDLE1BQUosR0FBYTtBQUNULFdBQU8sS0FBS0gsU0FBTCxDQUFlRyxNQUF0QjtBQUNIOztBQUVEQyxFQUFBQSxLQUFLLENBQUNDLFVBQUQsRUFBYTtBQUNkLFFBQUksS0FBS0gsV0FBTCxDQUFpQkcsVUFBakIsQ0FBSixFQUFrQyxPQUFPLEtBQUtILFdBQUwsQ0FBaUJHLFVBQWpCLENBQVA7QUFFbEMsUUFBSUMsY0FBYyxHQUFHWCxVQUFVLENBQUNVLFVBQUQsQ0FBL0I7QUFDQSxRQUFJLEtBQUtILFdBQUwsQ0FBaUJJLGNBQWpCLENBQUosRUFBc0MsT0FBTyxLQUFLSixXQUFMLENBQWlCSSxjQUFqQixDQUFQO0FBRXRDLFFBQUlDLGVBQWUsR0FBRyxLQUFLQyxTQUFMLENBQWVGLGNBQWYsQ0FBdEI7O0FBQ0EsVUFBTUcsZUFBZSxHQUFHYixPQUFPLENBQUUsYUFBWSxLQUFLTyxNQUFPLGNBQTFCLENBQS9COztBQUNBLFVBQU1PLFVBQVUsR0FBR0gsZUFBZSxDQUFDLElBQUQsRUFBT0UsZUFBUCxDQUFsQztBQUVBLFNBQUtQLFdBQUwsQ0FBaUJHLFVBQWpCLElBQStCSyxVQUEvQjs7QUFDQSxRQUFJSixjQUFjLEtBQUtELFVBQXZCLEVBQW1DO0FBQy9CLFdBQUtILFdBQUwsQ0FBaUJJLGNBQWpCLElBQW1DSSxVQUFuQztBQUNIOztBQUVELFdBQU9BLFVBQVA7QUFDSDs7QUFFREMsRUFBQUEsY0FBYyxDQUFDQyxjQUFELEVBQWlCO0FBQzNCLFdBQU9sQixDQUFDLENBQUNtQixNQUFGLENBQVMsS0FBS0MsUUFBZCxFQUF3QlQsVUFBVSxJQUFJO0FBQ3pDLFVBQUlVLEtBQUssR0FBRyxLQUFLWCxLQUFMLENBQVdDLFVBQVgsQ0FBWjtBQUNBLGFBQU9VLEtBQUssQ0FBQ0MsV0FBTixJQUFxQkQsS0FBSyxDQUFDQyxXQUFOLENBQWtCQyxPQUFsQixDQUEwQkwsY0FBMUIsSUFBNEMsQ0FBQyxDQUF6RTtBQUNILEtBSE0sQ0FBUDtBQUlIOztBQUVELFFBQU1NLE1BQU4sR0FBZTtBQUNYLFdBQU8sS0FBS2hCLFdBQVo7QUFDQSxXQUFPLEtBQUtGLFNBQVo7QUFDQSxXQUFPLEtBQUtELEdBQVo7QUFDSDs7QUExQ1M7O0FBNkNkb0IsTUFBTSxDQUFDQyxPQUFQLEdBQWlCdkIsT0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCB7IF8sIHBhc2NhbENhc2UgfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5cbmNsYXNzIERiTW9kZWwge1xuICAgIGNvbnN0cnVjdG9yKGFwcCwgY29ubmVjdG9yLCBpMThuKSB7ICAgICBcbiAgICAgICAgdGhpcy5hcHAgPSBhcHA7XG4gICAgICAgIHRoaXMuY29ubmVjdG9yID0gY29ubmVjdG9yO1xuICAgICAgICB0aGlzLmkxOG4gPSBpMThuO1xuXG4gICAgICAgIHRoaXMuX21vZGVsQ2FjaGUgPSB7fTtcbiAgICB9XG5cbiAgICBnZXQgZHJpdmVyKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5jb25uZWN0b3IuZHJpdmVyO1xuICAgIH1cblxuICAgIG1vZGVsKGVudGl0eU5hbWUpIHsgICAgICAgIFxuICAgICAgICBpZiAodGhpcy5fbW9kZWxDYWNoZVtlbnRpdHlOYW1lXSkgcmV0dXJuIHRoaXMuX21vZGVsQ2FjaGVbZW50aXR5TmFtZV07XG5cbiAgICAgICAgbGV0IG1vZGVsQ2xhc3NOYW1lID0gcGFzY2FsQ2FzZShlbnRpdHlOYW1lKTtcbiAgICAgICAgaWYgKHRoaXMuX21vZGVsQ2FjaGVbbW9kZWxDbGFzc05hbWVdKSByZXR1cm4gdGhpcy5fbW9kZWxDYWNoZVttb2RlbENsYXNzTmFtZV07XG5cbiAgICAgICAgbGV0IGVudGl0eVNwZWNNaXhpbiA9IHRoaXMubG9hZE1vZGVsKG1vZGVsQ2xhc3NOYW1lKTtcbiAgICAgICAgY29uc3QgQmFzZUVudGl0eU1vZGVsID0gcmVxdWlyZShgLi9kcml2ZXJzLyR7dGhpcy5kcml2ZXJ9L0VudGl0eU1vZGVsYCk7IFxuICAgICAgICBjb25zdCBtb2RlbENsYXNzID0gZW50aXR5U3BlY01peGluKHRoaXMsIEJhc2VFbnRpdHlNb2RlbCk7XG5cbiAgICAgICAgdGhpcy5fbW9kZWxDYWNoZVtlbnRpdHlOYW1lXSA9IG1vZGVsQ2xhc3M7XG4gICAgICAgIGlmIChtb2RlbENsYXNzTmFtZSAhPT0gZW50aXR5TmFtZSkge1xuICAgICAgICAgICAgdGhpcy5fbW9kZWxDYWNoZVttb2RlbENsYXNzTmFtZV0gPSBtb2RlbENsYXNzO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gbW9kZWxDbGFzcztcbiAgICB9XG5cbiAgICBlbnRpdGllc09mVHlwZShiYXNlRW50aXR5TmFtZSkge1xuICAgICAgICByZXR1cm4gXy5maWx0ZXIodGhpcy5lbnRpdGllcywgZW50aXR5TmFtZSA9PiB7XG4gICAgICAgICAgICBsZXQgTW9kZWwgPSB0aGlzLm1vZGVsKGVudGl0eU5hbWUpO1xuICAgICAgICAgICAgcmV0dXJuIE1vZGVsLmJhc2VDbGFzc2VzICYmIE1vZGVsLmJhc2VDbGFzc2VzLmluZGV4T2YoYmFzZUVudGl0eU5hbWUpID4gLTE7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGFzeW5jIGNsb3NlXygpIHtcbiAgICAgICAgZGVsZXRlIHRoaXMuX21vZGVsQ2FjaGU7XG4gICAgICAgIGRlbGV0ZSB0aGlzLmNvbm5lY3RvcjtcbiAgICAgICAgZGVsZXRlIHRoaXMuYXBwO1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBEYk1vZGVsOyJdfQ==