"use strict";

require("source-map-support/register");

const {
  _,
  pascalCase,
  sleep_
} = require("rk-utils");

const {
  DatabaseError
} = require("./utils/Errors");

const retryFailed = error => [false, error];

const retryOK = result => [true, result];

const directReturn = a => a;

class DbModel {
  constructor(app, connector, i18n) {
    this.app = app;
    this.connector = connector;
    this.i18n = i18n;
    this._modelCache = {};
  }

  get driver() {
    return this.connector.driver;
  }

  model(entityName) {
    if (this._modelCache[entityName]) return this._modelCache[entityName];
    let modelClassName = pascalCase(entityName);
    if (this._modelCache[modelClassName]) return this._modelCache[modelClassName];
    let entityCustomClassFactory = this.loadCustomModel(modelClassName);
    let entityClassFactory = this.loadModel(modelClassName);

    let BaseEntityModel = require(`./drivers/${this.driver}/EntityModel`);

    if (entityCustomClassFactory) {
      BaseEntityModel = entityCustomClassFactory(BaseEntityModel);
    }

    const modelClass = entityClassFactory(BaseEntityModel);
    modelClass.db = this;

    if (modelClass._init) {
      modelClass._init();
    }

    this._modelCache[entityName] = modelClass;

    if (modelClassName !== entityName) {
      this._modelCache[modelClassName] = modelClass;
    }

    return modelClass;
  }

  entitiesOfType(baseEntityName) {
    return _.filter(this.entities, entityName => {
      let Model = this.model(entityName);
      return Model.baseClasses && Model.baseClasses.indexOf(baseEntityName) > -1;
    });
  }

  async retry_(transactionName, transaction, connOptions, maxRetry, interval) {
    if (connOptions && connOptions.connection) {
      return transaction(directReturn, directReturn);
    }

    let i = 0;
    if (maxRetry == null) maxRetry = 3;

    while (i++ < maxRetry) {
      const [finished, result] = await transaction(retryOK, retryFailed);

      if (finished) {
        return result;
      }

      if (i === maxRetry) {
        throw result;
      }

      this.app.logException("warn", result, `Unable to complete "${transactionName}" and will try ${maxRetry - i} more times after ${interval || 0} ms.`);

      if (interval != null) {
        await sleep_(interval);
      }
    }
  }

  async safeRetry_(transactionName, transaction, connOptions, maxRetry, interval) {
    return this.retry_(transactionName, (ok, failed) => this.doTransaction_(async connOpts => ok((await transaction(connOpts))), failed, connOptions), connOptions, maxRetry, interval);
  }

  async close_() {
    delete this._modelCache;
    delete this.connector;
    delete this.app;
  }

}

module.exports = DbModel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9EYk1vZGVsLmpzIl0sIm5hbWVzIjpbIl8iLCJwYXNjYWxDYXNlIiwic2xlZXBfIiwicmVxdWlyZSIsIkRhdGFiYXNlRXJyb3IiLCJyZXRyeUZhaWxlZCIsImVycm9yIiwicmV0cnlPSyIsInJlc3VsdCIsImRpcmVjdFJldHVybiIsImEiLCJEYk1vZGVsIiwiY29uc3RydWN0b3IiLCJhcHAiLCJjb25uZWN0b3IiLCJpMThuIiwiX21vZGVsQ2FjaGUiLCJkcml2ZXIiLCJtb2RlbCIsImVudGl0eU5hbWUiLCJtb2RlbENsYXNzTmFtZSIsImVudGl0eUN1c3RvbUNsYXNzRmFjdG9yeSIsImxvYWRDdXN0b21Nb2RlbCIsImVudGl0eUNsYXNzRmFjdG9yeSIsImxvYWRNb2RlbCIsIkJhc2VFbnRpdHlNb2RlbCIsIm1vZGVsQ2xhc3MiLCJkYiIsIl9pbml0IiwiZW50aXRpZXNPZlR5cGUiLCJiYXNlRW50aXR5TmFtZSIsImZpbHRlciIsImVudGl0aWVzIiwiTW9kZWwiLCJiYXNlQ2xhc3NlcyIsImluZGV4T2YiLCJyZXRyeV8iLCJ0cmFuc2FjdGlvbk5hbWUiLCJ0cmFuc2FjdGlvbiIsImNvbm5PcHRpb25zIiwibWF4UmV0cnkiLCJpbnRlcnZhbCIsImNvbm5lY3Rpb24iLCJpIiwiZmluaXNoZWQiLCJsb2dFeGNlcHRpb24iLCJzYWZlUmV0cnlfIiwib2siLCJmYWlsZWQiLCJkb1RyYW5zYWN0aW9uXyIsImNvbm5PcHRzIiwiY2xvc2VfIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU07QUFBRUEsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQSxVQUFMO0FBQWlCQyxFQUFBQTtBQUFqQixJQUE0QkMsT0FBTyxDQUFDLFVBQUQsQ0FBekM7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQTtBQUFGLElBQW9CRCxPQUFPLENBQUMsZ0JBQUQsQ0FBakM7O0FBRUEsTUFBTUUsV0FBVyxHQUFJQyxLQUFELElBQVcsQ0FBQyxLQUFELEVBQVFB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QUl1QyxRQUFKLEVBQWM7QUFDVixlQUFPcEMsTUFBUDtBQUNIOztBQUVELFVBQUltQyxDQUFDLEtBQUtILFFBQVYsRUFBb0I7QUFDaEIsY0FBTWhDLE1BQU47QUFDSDs7QUFFRCxXQUFLSyxHQUFMLENBQVNnQyxZQUFULENBQ0ksTUFESixFQUVJckMsTUFGSixFQUdLLHVCQUFzQjZCLGVBQWdCLGtCQUFpQkcsUUFBUSxHQUFHRyxDQUFFLHFCQUNqRUYsUUFBUSxJQUFJLENBQ2YsTUFMTDs7QUFRQSxVQUFJQSxRQUFRLElBQUksSUFBaEIsRUFBc0I7QUFDbEIsY0FBTXZDLE1BQU0sQ0FBQ3VDLFFBQUQsQ0FBWjtBQUNIO0FBQ0o7QUFDSjs7QUFFRCxRQUFNSyxVQUFOLENBQWlCVCxlQUFqQixFQUFrQ0MsV0FBbEMsRUFBK0NDLFdBQS9DLEVBQTREQyxRQUE1RCxFQUFzRUMsUUFBdEUsRUFBZ0Y7QUFDNUUsV0FBTyxLQUFLTCxNQUFMLENBQ0hDLGVBREcsRUFFSCxDQUFDVSxFQUFELEVBQUtDLE1BQUwsS0FBZ0IsS0FBS0MsY0FBTCxDQUFvQixNQUFPQyxRQUFQLElBQW9CSCxFQUFFLEVBQUMsTUFBTVQsV0FBVyxDQUFDWSxRQUFELENBQWxCLEVBQTFDLEVBQXlFRixNQUF6RSxFQUFpRlQsV0FBakYsQ0FGYixFQUdIQSxXQUhHLEVBSUhDLFFBSkcsRUFLSEMsUUFMRyxDQUFQO0FBT0g7O0FBRUQsUUFBTVUsTUFBTixHQUFlO0FBQ1gsV0FBTyxLQUFLbkMsV0FBWjtBQUNBLFdBQU8sS0FBS0YsU0FBWjtBQUNBLFdBQU8sS0FBS0QsR0FBWjtBQUNIOztBQWhHUzs7QUFtR2R1QyxNQUFNLENBQUNDLE9BQVAsR0FBaUIxQyxPQUFqQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHsgXywgcGFzY2FsQ2FzZSwgc2xlZXBfIH0gPSByZXF1aXJlKFwicmstdXRpbHNcIik7XG5jb25zdCB7IERhdGFiYXNlRXJyb3IgfSA9IHJlcXVpcmUoXCIuL3V0aWxzL0Vycm9yc1wiKTtcblxuY29uc3QgcmV0cnlGYWlsZWQgPSAoZXJyb3IpID0+IFtmYWxzZSwgZXJyb3JdO1xuY29uc3QgcmV0cnlPSyA9IChyZXN1bHQpID0+IFt0cnVlLCByZXN1bHRdO1xuXG5jb25zdCBkaXJlY3RSZXR1cm4gPSAoYSkgPT4gYTtcblxuY2xhc3MgRGJNb2RlbCB7XG4gICAgY29uc3RydWN0b3IoYXBwLCBjb25uZWN0b3IsIGkxOG4pIHtcbiAgICAgICAgdGhpcy5hcHAgPSBhcHA7XG4gICAgICAgIHRoaXMuY29ubmVjdG9yID0gY29ubmVjdG9yO1xuICAgICAgICB0aGlzLmkxOG4gPSBpMThuO1xuXG4gICAgICAgIHRoaXMuX21vZGVsQ2FjaGUgPSB7fTtcbiAgICB9XG5cbiAgICBnZXQgZHJpdmVyKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5jb25uZWN0b3IuZHJpdmVyO1xuICAgIH1cblxuICAgIG1vZGVsKGVudGl0eU5hbWUpIHtcbiAgICAgICAgaWYgKHRoaXMuX21vZGVsQ2FjaGVbZW50aXR5TmFtZV0pIHJldHVybiB0aGlzLl9tb2RlbENhY2hlW2VudGl0eU5hbWVdO1xuXG4gICAgICAgIGxldCBtb2RlbENsYXNzTmFtZSA9IHBhc2NhbENhc2UoZW50aXR5TmFtZSk7XG4gICAgICAgIGlmICh0aGlzLl9tb2RlbENhY2hlW21vZGVsQ2xhc3NOYW1lXSkgcmV0dXJuIHRoaXMuX21vZGVsQ2FjaGVbbW9kZWxDbGFzc05hbWVdO1xuXG4gICAgICAgIGxldCBlbnRpdHlDdXN0b21DbGFzc0ZhY3RvcnkgPSB0aGlzLmxvYWRDdXN0b21Nb2RlbChtb2RlbENsYXNzTmFtZSk7XG4gICAgICAgIGxldCBlbnRpdHlDbGFzc0ZhY3RvcnkgPSB0aGlzLmxvYWRNb2RlbChtb2RlbENsYXNzTmFtZSk7XG5cbiAgICAgICAgbGV0IEJhc2VFbnRpdHlNb2RlbCA9IHJlcXVpcmUoYC4vZHJpdmVycy8ke3RoaXMuZHJpdmVyfS9FbnRpdHlNb2RlbGApO1xuICAgICAgICBpZiAoZW50aXR5Q3VzdG9tQ2xhc3NGYWN0b3J5KSB7XG4gICAgICAgICAgICBCYXNlRW50aXR5TW9kZWwgPSBlbnRpdHlDdXN0b21DbGFzc0ZhY3RvcnkoQmFzZUVudGl0eU1vZGVsKTsgICAgICAgICAgICBcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IG1vZGVsQ2xhc3MgPSBlbnRpdHlDbGFzc0ZhY3RvcnkoQmFzZUVudGl0eU1vZGVsKTtcbiAgICAgICAgbW9kZWxDbGFzcy5kYiA9IHRoaXM7XG5cbiAgICAgICAgaWYgKG1vZGVsQ2xhc3MuX2luaXQpIHtcbiAgICAgICAgICAgIG1vZGVsQ2xhc3MuX2luaXQoKTtcbiAgICAgICAgfVxuIFxuICAgICAgICB0aGlzLl9tb2RlbENhY2hlW2VudGl0eU5hbWVdID0gbW9kZWxDbGFzcztcbiAgICAgICAgaWYgKG1vZGVsQ2xhc3NOYW1lICE9PSBlbnRpdHlOYW1lKSB7XG4gICAgICAgICAgICB0aGlzLl9tb2RlbENhY2hlW21vZGVsQ2xhc3NOYW1lXSA9IG1vZGVsQ2xhc3M7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbW9kZWxDbGFzcztcbiAgICB9XG5cbiAgICBlbnRpdGllc09mVHlwZShiYXNlRW50aXR5TmFtZSkge1xuICAgICAgICByZXR1cm4gXy5maWx0ZXIodGhpcy5lbnRpdGllcywgKGVudGl0eU5hbWUpID0+IHtcbiAgICAgICAgICAgIGxldCBNb2RlbCA9IHRoaXMubW9kZWwoZW50aXR5TmFtZSk7XG4gICAgICAgICAgICByZXR1cm4gTW9kZWwuYmFzZUNsYXNzZXMgJiYgTW9kZWwuYmFzZUNsYXNzZXMuaW5kZXhPZihiYXNlRW50aXR5TmFtZSkgPiAtMTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgYXN5bmMgcmV0cnlfKHRyYW5zYWN0aW9uTmFtZSwgdHJhbnNhY3Rpb24sIGNvbm5PcHRpb25zLCBtYXhSZXRyeSwgaW50ZXJ2YWwpIHtcbiAgICAgICAgaWYgKGNvbm5PcHRpb25zICYmIGNvbm5PcHRpb25zLmNvbm5lY3Rpb24pIHtcbiAgICAgICAgICAgIHJldHVybiB0cmFuc2FjdGlvbihkaXJlY3RSZXR1cm4sIGRpcmVjdFJldHVybik7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgaSA9IDA7XG4gICAgICAgIGlmIChtYXhSZXRyeSA9PSBudWxsKSBtYXhSZXRyeSA9IDM7XG5cbiAgICAgICAgd2hpbGUgKGkrKyA8IG1heFJldHJ5KSB7XG4gICAgICAgICAgICBjb25zdCBbZmluaXNoZWQsIHJlc3VsdF0gPSBhd2FpdCB0cmFuc2FjdGlvbihyZXRyeU9LLCByZXRyeUZhaWxlZCk7XG5cbiAgICAgICAgICAgIGlmIChmaW5pc2hlZCkge1xuICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChpID09PSBtYXhSZXRyeSkge1xuICAgICAgICAgICAgICAgIHRocm93IHJlc3VsdDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5hcHAubG9nRXhjZXB0aW9uKFxuICAgICAgICAgICAgICAgIFwid2FyblwiLFxuICAgICAgICAgICAgICAgIHJlc3VsdCxcbiAgICAgICAgICAgICAgICBgVW5hYmxlIHRvIGNvbXBsZXRlIFwiJHt0cmFuc2FjdGlvbk5hbWV9XCIgYW5kIHdpbGwgdHJ5ICR7bWF4UmV0cnkgLSBpfSBtb3JlIHRpbWVzIGFmdGVyICR7XG4gICAgICAgICAgICAgICAgICAgIGludGVydmFsIHx8IDBcbiAgICAgICAgICAgICAgICB9IG1zLmBcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIGlmIChpbnRlcnZhbCAhPSBudWxsKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgc2xlZXBfKGludGVydmFsKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIHNhZmVSZXRyeV8odHJhbnNhY3Rpb25OYW1lLCB0cmFuc2FjdGlvbiwgY29ubk9wdGlvbnMsIG1heFJldHJ5LCBpbnRlcnZhbCkge1xuICAgICAgICByZXR1cm4gdGhpcy5yZXRyeV8oXG4gICAgICAgICAgICB0cmFuc2FjdGlvbk5hbWUsXG4gICAgICAgICAgICAob2ssIGZhaWxlZCkgPT4gdGhpcy5kb1RyYW5zYWN0aW9uXyhhc3luYyAoY29ubk9wdHMpID0+IG9rKGF3YWl0IHRyYW5zYWN0aW9uKGNvbm5PcHRzKSksIGZhaWxlZCwgY29ubk9wdGlvbnMpLFxuICAgICAgICAgICAgY29ubk9wdGlvbnMsXG4gICAgICAgICAgICBtYXhSZXRyeSxcbiAgICAgICAgICAgIGludGVydmFsXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgYXN5bmMgY2xvc2VfKCkge1xuICAgICAgICBkZWxldGUgdGhpcy5fbW9kZWxDYWNoZTtcbiAgICAgICAgZGVsZXRlIHRoaXMuY29ubmVjdG9yO1xuICAgICAgICBkZWxldGUgdGhpcy5hcHA7XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IERiTW9kZWw7XG4iXX0=