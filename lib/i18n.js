"use strict";

require("source-map-support/register");

const path = require('path');

const util = require('util');

const Util = require('./util.js');

const Promise = Util.Promise;

const Convertors = require('./Convertors');

class I18n {
  constructor(config) {
    config || (config = {});
    this.supportedLocales = config.supportedLocales ? config.supportedLocales.map(l => I18n.normalizeLocale(l)) : ['en_AU', 'en_US', 'zh_CN'];
    this.reverseUpdate = util.isNullOrUndefined(config.reverseUpdate) ? false : Convertors.toBoolean(config.reverseUpdate);
    this.updateWithMeta = util.isNullOrUndefined(config.updateWithMeta) ? false : Convertors.toBoolean(config.updateWithMeta);
    this.timezone = config.timezone;
    this.pendingUpdates = {};
  }

  isLocaleSupported(locale) {
    let n = locale && I18n.normalizeLocale(locale);
    return this.supportedLocales.some(l => n === l);
  }

  async setupAsync(locale) {
    if (!this.isLocaleSupported(locale)) return Promise.reject('unsupported_locale');
    this.dictionary = {};
    this.locale = I18n.normalizeLocale(locale || this.supportedLocales[0]);
    this.momentLocale = I18n.localeToDash(this.locale).toLowerCase();
    this.momentTimezone = Util.timezone;
    return this;
  }

  getText(token, values, defaultText) {
    if (Util._.isString(values)) {
      defaultText = values;
      values = null;
    }

    var phrase = Util.getValueByPath(this.dictionary, token);

    if (util.isNullOrUndefined(phrase)) {
      phrase = defaultText;

      if (phrase) {
        if (this.reverseUpdate) this.addToDictionary(token, phrase);
      } else {
        phrase = token;
      }
    } else if (util.isObject(phrase)) {
      phrase = phrase['text'];
    }

    return Util._.isEmpty(values) ? phrase : Util.template(phrase, values);
  }

  addToDictionary(token, text, saveImmediate) {
    if (this.updateWithMeta) {
      text = {
        text: text,
        comment: 'Added at ' + this.datetime().format()
      };
    }

    Util.setValueByPath(this.dictionary, token, text);
    this.pendingUpdates[token] = text;

    if (saveImmediate) {
      this.save();
    }
  }

  save() {
    this.pendingUpdates = {};
  }

  datetime(value, timezone) {
    timezone || (timezone = this.timezone);
    var r = this.momentTimezone(value).locale(this.momentLocale);
    return timezone ? r.tz(timezone) : r;
  }

  flush() {
    if (this.reverseUpdate) {
      this.save();
    }
  }

  get dashForm() {
    return I18n.localeToDash(this.locale);
  }

  static normalizeLocale(locale) {
    var l = locale.replace('-', '_').split('_', 2);
    var l2 = l[0].toLowerCase();

    if (l.length > 1) {
      l2 += '_' + l[1].toUpperCase();
    }

    return l2;
  }

  static localeToDash(locale) {
    return locale.replace('_', '-');
  }

  static extractLanguageCode(locale) {
    var pos = locale.lastIndexOf('_');
    if (pos == -1) return locale;
    return locale.substr(0, pos);
  }

  static extractCountryCode(locale) {
    var pos = locale.lastIndexOf('_');
    if (pos == -1) return '';
    return locale.substr(pos + 1);
  }

}

class FileI18n extends I18n {
  constructor(config) {
    super(config);
    config || (config = {});
    this.directory = config.directory || './locale';
  }

  async setupAsync(locale) {
    const self = this;

    function loadDir(dict, dir, finish) {
      Util.fs.readdir(dir, function (err, files) {
        if (err) return finish(err);
        Util.async.each(files, function (file, cb) {
          let langFilePath = path.join(dir, file);
          let stats = Util.fs.statSync(langFilePath);

          if (stats.isDirectory()) {
            dict[file] = {};
            return loadDir(dict[file], langFilePath, cb);
          }

          let extName = path.extname(file);
          if (extName.toLowerCase() !== '.json') return cb();
          Util.fs.readJson(langFilePath, function (err, content) {
            if (err) return cb(err);
            let basename = path.basename(file, extName);
            dict[basename] = content;
            cb();
          });
        }, finish);
      });
    }

    return super.setupAsync(locale).then(() => {
      let langPath = path.resolve(self.directory, 'lang');
      return new Promise((resolve, reject) => {
        let p = path.join(langPath, self.locale);

        if (!Util.fs.existsSync(p)) {
          let lang = I18n.extractLanguageCode(self.locale);
          p = path.join(langPath, lang);

          if (!Util.fs.existsSync(p)) {
            return resolve(self);
          }
        }

        loadDir(self.dictionary, p, err => {
          if (err) return reject(err);
          resolve(self);
        });
      });
    });
  }

  save() {
    var fileSet = new Set();

    Util._.forOwn(this.pendingUpdates, (v, k) => {
      let keyword = path.extname(k);
      let p = path.basename(k, keyword);
      fileSet.add(p);
    });

    var langPath = path.resolve(this.directory, 'lang');
    var bp = path.join(langPath, this.locale);

    for (let p of fileSet) {
      let content = Util.getValueByPath(this.dictionary, p);
      let f = Util.replaceAll(p, '.', path.delimiter) + '.json';
      Util.fs.outputJsonSync(path.join(bp, f), content);
    }

    fileSet.clear();
    super.save();
  }

}

I18n.File = FileI18n;
module.exports = I18n;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pMThuLmpzIl0sIm5hbWVzIjpbInBhdGgiLCJyZXF1aXJlIiwidXRpbCIsIlV0aWwiLCJQcm9taXNlIiwiQ29udmVydG9ycyIsIkkxOG4iLCJjb25zdHJ1Y3RvciIsImNvbmZpZyIsInN1cHBvcnRlZExvY2FsZXMiLCJtYXAiLCJsIiwibm9ybWFsaXplTG9jYWxlIiwicmV2ZXJzZVVwZGF0ZSIsImlzTnVsbE9yVW5kZWZpbmVkIiwidG9Cb29sZWFuIiwidXBkYXRlV2l0aE1ldGEiLCJ0aW1lem9uZSIsInBlbmRpbmdVcGRhdGVzIiwiaXNMb2NhbGVTdXBwb3J0ZWQiLCJsb2NhbGUiLCJuIiwic29tZSIsInNldHVwQXN5bmMiLCJyZWplY3QiLCJkaWN0aW9uYXJ5IiwibW9tZW50TG9jYWxlIiwibG9jYWxlVG9EYXNoIiwidG9Mb3dlckNhc2UiLCJtb21lbnRUaW1lem9uZSIsImdldFRleHQiLCJ0b2tlbiIsInZhbHVlcyIsImRlZmF1bHRUZXh0IiwiXyIsImlzU3RyaW5nIiwicGhyYXNlIiwiZ2V0VmFsdWVCeVBhdGgiLCJhZGRUb0RpY3Rpb25hcnkiLCJpc09iamVjdCIsImlzRW1wdHkiLCJ0ZW1wbGF0ZSIsInRleHQiLCJzYXZlSW1tZWRpYXRlIiwiY29tbWVudCIsImRhdGV0aW1lIiwiZm9ybWF0Iiwic2V0VmFsdWVCeVBhdGgiLCJzYXZlIiwidmFsdWUiLCJyIiwidHoiLCJmbHVzaCIsImRhc2hGb3JtIiwicmVwbGFjZSIsInNwbGl0IiwibDIiLCJsZW5ndGgiLCJ0b1VwcGVyQ2FzZSIsImV4dHJhY3RMYW5ndWFnZUNvZGUiLCJwb3MiLCJsYXN0SW5kZXhPZiIsInN1YnN0ciIsImV4dHJhY3RDb3VudHJ5Q29kZSIsIkZpbGVJMThuIiwiZGlyZWN0b3J5Iiwic2VsZiIsImxvYWREaXIiLCJkaWN0IiwiZGlyIiwiZmluaXNoIiwiZnMiLCJyZWFkZGlyIiwiZXJyIiwiZmlsZXMiLCJhc3luYyIsImVhY2giLCJmaWxlIiwiY2IiLCJsYW5nRmlsZVBhdGgiLCJqb2luIiwic3RhdHMiLCJzdGF0U3luYyIsImlzRGlyZWN0b3J5IiwiZXh0TmFtZSIsImV4dG5hbWUiLCJyZWFkSnNvbiIsImNvbnRlbnQiLCJiYXNlbmFtZSIsInRoZW4iLCJsYW5nUGF0aCIsInJlc29sdmUiLCJwIiwiZXhpc3RzU3luYyIsImxhbmciLCJmaWxlU2V0IiwiU2V0IiwiZm9yT3duIiwidiIsImsiLCJrZXl3b3JkIiwiYWRkIiwiYnAiLCJmIiwicmVwbGFjZUFsbCIsImRlbGltaXRlciIsIm91dHB1dEpzb25TeW5jIiwiY2xlYXIiLCJGaWxlIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU1DLElBQUksR0FBR0QsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTUUsSUFBSSxHQUFHRixPQUFPLENBQUMsV0FBRCxDQUFwQjs7QUFDQSxNQUFNRyxPQUFPLEdBQUdELElBQUksQ0FBQ0MsT0FBckI7O0FBQ0EsTUFBTUMsVUFBVSxHQUFHSixPQUFPLENBQUMsY0FBRCxDQUExQjs7QUFFQSxNQUFNSyxJQUFOLENBQVc7QUFVUEMsRUFBQUEsV0FBVyxDQUFDQyxNQUFELEVBQVM7QUFDaEJBLElBQUFBLE1BQU0sS0FBS0EsTUFBTSxHQUFHLEVBQWQsQ0FBTjtBQUVBLFNBQUtDLGdCQUFMLEdBQXdCRCxNQUFNLENBQUNDLGdCQUFQLEdBQTBCRCxNQUFNLENBQUNDLGdCQUFQLENBQXdCQyxHQUF4QixDQUE0QkMsQ0FBQyxJQUFJTCxJQUFJLENBQUNNLGVBQUwsQ0FBcUJELENBQXJCLENBQWpDLENBQTFCLEdBQXNGLENBQUUsT0FBRixFQUFXLE9BQVgsRUFBb0IsT0FBcEIsQ0FBOUc7QUFDQSxTQUFLRSxhQUFMLEdBQXFCWCxJQUFJLENBQUNZLGlCQUFMLENBQXVCTixNQUFNLENBQUNLLGFBQTlCLElBQStDLEtBQS9DLEdBQXdEUixVQUFVLENBQUNVLFNBQVgs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bnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCB1dGlsID0gcmVxdWlyZSgndXRpbCcpO1xuY29uc3QgVXRpbCA9IHJlcXVpcmUoJy4vdXRpbC5qcycpO1xuY29uc3QgUHJvbWlzZSA9IFV0aWwuUHJvbWlzZTtcbmNvbnN0IENvbnZlcnRvcnMgPSByZXF1aXJlKCcuL0NvbnZlcnRvcnMnKTtcblxuY2xhc3MgSTE4biB7XG4gICAgLyoqXG4gICAgICogQW4gYXBwIG1vZHVsZSBvYmplY3QuXG4gICAgICogQGNvbnN0cnVjdHMgSTE4blxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbY29uZmlnXSAtIFRoZSBpMThuIGNvbmZpZ3VyYXRpb24uXG4gICAgICogQHByb3BlcnR5IHthcnJheX0gW2NvbmZpZy5zdXBwb3J0ZWRMb2NhbGVzXSAtIFRoZSBkZWZhdWx0IGxvY2FsZVxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbH0gW2NvbmZpZy5yZXZlcnNlVXBkYXRlPWZhbHNlXSAtIFJldmVyc2UgdXBkYXRlIHdoZW5cbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtjb25maWcudXBkYXRlV2l0aE1ldGE9ZmFsc2VdIC1cbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW2NvbmZpZy50aW1lem9uZV0gLSBUaW1lem9uZVxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKGNvbmZpZykge1xuICAgICAgICBjb25maWcgfHwgKGNvbmZpZyA9IHt9KTtcblxuICAgICAgICB0aGlzLnN1cHBvcnRlZExvY2FsZXMgPSBjb25maWcuc3VwcG9ydGVkTG9jYWxlcyA/IGNvbmZpZy5zdXBwb3J0ZWRMb2NhbGVzLm1hcChsID0+IEkxOG4ubm9ybWFsaXplTG9jYWxlKGwpKSA6IFsgJ2VuX0FVJywgJ2VuX1VTJywgJ3poX0NOJyBdO1xuICAgICAgICB0aGlzLnJldmVyc2VVcGRhdGUgPSB1dGlsLmlzTnVsbE9yVW5kZWZpbmVkKGNvbmZpZy5yZXZlcnNlVXBkYXRlKSA/IGZhbHNlIDogIENvbnZlcnRvcnMudG9Cb29sZWFuKGNvbmZpZy5yZXZlcnNlVXBkYXRlKTtcbiAgICAgICAgdGhpcy51cGRhdGVXaXRoTWV0YSA9IHV0aWwuaXNOdWxsT3JVbmRlZmluZWQoY29uZmlnLnVwZGF0ZVdpdGhNZXRhKSA/IGZhbHNlIDogQ29udmVydG9ycy50b0Jvb2xlYW4oY29uZmlnLnVwZGF0ZVdpdGhNZXRhKTtcbiAgICAgICAgdGhpcy50aW1lem9uZSA9IGNvbmZpZy50aW1lem9uZTtcbiAgICAgICAgdGhpcy5wZW5kaW5nVXBkYXRlcyA9IHt9O1xuICAgIH1cblxuICAgIGlzTG9jYWxlU3VwcG9ydGVkKGxvY2FsZSkge1xuICAgICAgICBsZXQgbiA9IGxvY2FsZSAmJiBJMThuLm5vcm1hbGl6ZUxvY2FsZShsb2NhbGUpO1xuICAgICAgICByZXR1cm4gdGhpcy5zdXBwb3J0ZWRMb2NhbGVzLnNvbWUobCA9PiBuID09PSBsKTtcbiAgICB9XG5cbiAgICBhc3luYyBzZXR1cEFzeW5jKGxvY2FsZSkge1xuICAgICAgICBpZiAoIXRoaXMuaXNMb2NhbGVTdXBwb3J0ZWQobG9jYWxlKSkgcmV0dXJuIFByb21pc2UucmVqZWN0KCd1bnN1cHBvcnRlZF9sb2NhbGUnKTtcblxuICAgICAgICB0aGlzLmRpY3Rpb25hcnkgPSB7fTtcblxuICAgICAgICB0aGlzLmxvY2FsZSA9IEkxOG4ubm9ybWFsaXplTG9jYWxlKGxvY2FsZSB8fCB0aGlzLnN1cHBvcnRlZExvY2FsZXNbMF0pO1xuICAgICAgICB0aGlzLm1vbWVudExvY2FsZSA9IEkxOG4ubG9jYWxlVG9EYXNoKHRoaXMubG9jYWxlKS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICB0aGlzLm1vbWVudFRpbWV6b25lID0gVXRpbC50aW1lem9uZTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBnZXRUZXh0KHRva2VuLCB2YWx1ZXMsIGRlZmF1bHRUZXh0KSB7XG4gICAgICAgIGlmIChVdGlsLl8uaXNTdHJpbmcodmFsdWVzKSkge1xuICAgICAgICAgICAgZGVmYXVsdFRleHQgPSB2YWx1ZXM7XG4gICAgICAgICAgICB2YWx1ZXMgPSBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgdmFyIHBocmFzZSA9IFV0aWwuZ2V0VmFsdWVCeVBhdGgodGhpcy5kaWN0aW9uYXJ5LCB0b2tlbik7XG5cbiAgICAgICAgaWYgKHV0aWwuaXNOdWxsT3JVbmRlZmluZWQocGhyYXNlKSkge1xuICAgICAgICAgICAgcGhyYXNlID0gZGVmYXVsdFRleHQ7XG5cbiAgICAgICAgICAgIGlmIChwaHJhc2UpIHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5yZXZlcnNlVXBkYXRlKSB0aGlzLmFkZFRvRGljdGlvbmFyeSh0b2tlbiwgcGhyYXNlKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcGhyYXNlID0gdG9rZW47XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAodXRpbC5pc09iamVjdChwaHJhc2UpKSB7XG4gICAgICAgICAgICBwaHJhc2UgPSBwaHJhc2VbJ3RleHQnXTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBVdGlsLl8uaXNFbXB0eSh2YWx1ZXMpID8gcGhyYXNlIDogVXRpbC50ZW1wbGF0ZShwaHJhc2UsIHZhbHVlcyk7XG4gICAgfVxuXG4gICAgYWRkVG9EaWN0aW9uYXJ5KHRva2VuLCB0ZXh0LCBzYXZlSW1tZWRpYXRlKSB7XG4gICAgICAgIGlmICh0aGlzLnVwZGF0ZVdpdGhNZXRhKSB7XG4gICAgICAgICAgICB0ZXh0ID0geyB0ZXh0OiB0ZXh0LCBjb21tZW50OiAnQWRkZWQgYXQgJyArIHRoaXMuZGF0ZXRpbWUoKS5mb3JtYXQoKSB9XG4gICAgICAgIH1cblxuICAgICAgICBVdGlsLnNldFZhbHVlQnlQYXRoKHRoaXMuZGljdGlvbmFyeSwgdG9rZW4sIHRleHQpO1xuXG4gICAgICAgIHRoaXMucGVuZGluZ1VwZGF0ZXNbdG9rZW5dID0gdGV4dDtcblxuICAgICAgICBpZiAoc2F2ZUltbWVkaWF0ZSkge1xuICAgICAgICAgICAgdGhpcy5zYXZlKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzYXZlKCkge1xuICAgICAgICB0aGlzLnBlbmRpbmdVcGRhdGVzID0ge307XG4gICAgfVxuXG4gICAgZGF0ZXRpbWUodmFsdWUsIHRpbWV6b25lKSB7XG4gICAgICAgIHRpbWV6b25lIHx8ICh0aW1lem9uZSA9IHRoaXMudGltZXpvbmUpO1xuXG4gICAgICAgIHZhciByID0gdGhpcy5tb21lbnRUaW1lem9uZSh2YWx1ZSkubG9jYWxlKHRoaXMubW9tZW50TG9jYWxlKTtcblxuICAgICAgICByZXR1cm4gdGltZXpvbmUgPyByLnR6KHRpbWV6b25lKSA6IHI7XG4gICAgfVxuXG4gICAgZmx1c2goKSB7XG4gICAgICAgIGlmICh0aGlzLnJldmVyc2VVcGRhdGUpIHsgdGhpcy5zYXZlKCk7IH1cbiAgICB9XG5cbiAgICBnZXQgZGFzaEZvcm0oKSB7XG4gICAgICAgIHJldHVybiBJMThuLmxvY2FsZVRvRGFzaCh0aGlzLmxvY2FsZSk7XG4gICAgfVxuXG4gICAgc3RhdGljIG5vcm1hbGl6ZUxvY2FsZShsb2NhbGUpIHtcbiAgICAgICAgdmFyIGwgPSBsb2NhbGUucmVwbGFjZSgnLScsICdfJykuc3BsaXQoJ18nLCAyKTtcbiAgICAgICAgdmFyIGwyID0gbFswXS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICBpZiAobC5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICBsMiArPSAnXycgKyBsWzFdLnRvVXBwZXJDYXNlKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGwyO1xuICAgIH1cblxuICAgIHN0YXRpYyBsb2NhbGVUb0Rhc2gobG9jYWxlKSB7XG4gICAgICAgIHJldHVybiBsb2NhbGUucmVwbGFjZSgnXycsICctJyk7XG4gICAgfVxuXG4gICAgc3RhdGljIGV4dHJhY3RMYW5ndWFnZUNvZGUobG9jYWxlKSB7XG4gICAgICAgIHZhciBwb3MgPSBsb2NhbGUubGFzdEluZGV4T2YoJ18nKTtcbiAgICAgICAgaWYgKHBvcyA9PSAtMSkgcmV0dXJuIGxvY2FsZTtcblxuICAgICAgICByZXR1cm4gbG9jYWxlLnN1YnN0cigwLCBwb3MpO1xuICAgIH1cblxuICAgIHN0YXRpYyBleHRyYWN0Q291bnRyeUNvZGUobG9jYWxlKSB7XG4gICAgICAgIHZhciBwb3MgPSBsb2NhbGUubGFzdEluZGV4T2YoJ18nKTtcbiAgICAgICAgaWYgKHBvcyA9PSAtMSkgcmV0dXJuICcnO1xuXG4gICAgICAgIHJldHVybiBsb2NhbGUuc3Vic3RyKHBvcyArIDEpO1xuICAgIH0gICAgXG59XG5cbmNsYXNzIEZpbGVJMThuIGV4dGVuZHMgSTE4biB7XG5cbiAgICBjb25zdHJ1Y3Rvcihjb25maWcpIHtcbiAgICAgICAgc3VwZXIoY29uZmlnKTtcblxuICAgICAgICBjb25maWcgfHwgKGNvbmZpZyA9IHt9KTtcblxuICAgICAgICB0aGlzLmRpcmVjdG9yeSA9IGNvbmZpZy5kaXJlY3RvcnkgfHwgJy4vbG9jYWxlJztcbiAgICB9XG5cbiAgICBhc3luYyBzZXR1cEFzeW5jKGxvY2FsZSkge1xuICAgICAgICBjb25zdCBzZWxmID0gdGhpcztcblxuICAgICAgICBmdW5jdGlvbiBsb2FkRGlyKGRpY3QsIGRpciwgZmluaXNoKSB7XG4gICAgICAgICAgICBVdGlsLmZzLnJlYWRkaXIoZGlyLCBmdW5jdGlvbiAoZXJyLCBmaWxlcykge1xuICAgICAgICAgICAgICAgIGlmIChlcnIpIHJldHVybiBmaW5pc2goZXJyKTtcblxuICAgICAgICAgICAgICAgIFV0aWwuYXN5bmMuZWFjaChmaWxlcywgZnVuY3Rpb24gKGZpbGUsIGNiKSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBsYW5nRmlsZVBhdGggPSBwYXRoLmpvaW4oZGlyLCBmaWxlKTtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHN0YXRzID0gVXRpbC5mcy5zdGF0U3luYyhsYW5nRmlsZVBhdGgpO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGF0cy5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkaWN0W2ZpbGVdID0ge307XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbG9hZERpcihkaWN0W2ZpbGVdLCBsYW5nRmlsZVBhdGgsIGNiKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGxldCBleHROYW1lID0gcGF0aC5leHRuYW1lKGZpbGUpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXh0TmFtZS50b0xvd2VyQ2FzZSgpICE9PSAnLmpzb24nKSByZXR1cm4gY2IoKTtcblxuICAgICAgICAgICAgICAgICAgICBVdGlsLmZzLnJlYWRKc29uKGxhbmdGaWxlUGF0aCwgZnVuY3Rpb24gKGVyciwgY29udGVudCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycikgcmV0dXJuIGNiKGVycik7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBiYXNlbmFtZSA9IHBhdGguYmFzZW5hbWUoZmlsZSwgZXh0TmFtZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBkaWN0W2Jhc2VuYW1lXSA9IGNvbnRlbnQ7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGNiKCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgfSwgZmluaXNoKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHN1cGVyLnNldHVwQXN5bmMobG9jYWxlKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIGxldCBsYW5nUGF0aCA9IHBhdGgucmVzb2x2ZShzZWxmLmRpcmVjdG9yeSwgJ2xhbmcnKTtcblxuICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgcCA9IHBhdGguam9pbihsYW5nUGF0aCwgc2VsZi5sb2NhbGUpO1xuXG4gICAgICAgICAgICAgICAgaWYgKCFVdGlsLmZzLmV4aXN0c1N5bmMocCkpIHtcbiAgICAgICAgICAgICAgICAgICAgLy90cnkgb25seSBsYW5ndWFnZSBjb2RlXG4gICAgICAgICAgICAgICAgICAgIGxldCBsYW5nID0gSTE4bi5leHRyYWN0TGFuZ3VhZ2VDb2RlKHNlbGYubG9jYWxlKTtcbiAgICAgICAgICAgICAgICAgICAgcCA9IHBhdGguam9pbihsYW5nUGF0aCwgbGFuZyk7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKCFVdGlsLmZzLmV4aXN0c1N5bmMocCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNvbHZlKHNlbGYpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgbG9hZERpcihzZWxmLmRpY3Rpb25hcnksIHAsIChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycikgcmV0dXJuIHJlamVjdChlcnIpO1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHNlbGYpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHNhdmUoKSB7XG4gICAgICAgIHZhciBmaWxlU2V0ID0gbmV3IFNldCgpO1xuXG4gICAgICAgIFV0aWwuXy5mb3JPd24odGhpcy5wZW5kaW5nVXBkYXRlcywgKHYsIGspID0+IHtcbiAgICAgICAgICAgIGxldCBrZXl3b3JkID0gcGF0aC5leHRuYW1lKGspO1xuICAgICAgICAgICAgbGV0IHAgPSBwYXRoLmJhc2VuYW1lKGssIGtleXdvcmQpO1xuICAgICAgICAgICAgZmlsZVNldC5hZGQocCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHZhciBsYW5nUGF0aCA9IHBhdGgucmVzb2x2ZSh0aGlzLmRpcmVjdG9yeSwgJ2xhbmcnKTtcbiAgICAgICAgdmFyIGJwID0gcGF0aC5qb2luKGxhbmdQYXRoLCB0aGlzLmxvY2FsZSk7XG5cbiAgICAgICAgZm9yIChsZXQgcCBvZiBmaWxlU2V0KSB7XG4gICAgICAgICAgICBsZXQgY29udGVudCA9IFV0aWwuZ2V0VmFsdWVCeVBhdGgodGhpcy5kaWN0aW9uYXJ5LCBwKTtcbiAgICAgICAgICAgIGxldCBmID0gVXRpbC5yZXBsYWNlQWxsKHAsICcuJywgcGF0aC5kZWxpbWl0ZXIpICsgJy5qc29uJztcblxuICAgICAgICAgICAgVXRpbC5mcy5vdXRwdXRKc29uU3luYyhwYXRoLmpvaW4oYnAsIGYpLCBjb250ZW50KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGZpbGVTZXQuY2xlYXIoKTtcblxuICAgICAgICBzdXBlci5zYXZlKCk7XG4gICAgfVxufVxuXG5JMThuLkZpbGUgPSBGaWxlSTE4bjtcblxubW9kdWxlLmV4cG9ydHMgPSBJMThuOyJdfQ==