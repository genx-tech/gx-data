"use strict";

require("source-map-support/register");

const path = require('path');

const util = require('util');

const Util = require('./util.js');

const Promise = Util.Promise;

const Convertors = require('./Convertors');

class I18n {
  constructor(config) {
    config || (config = {});
    this.supportedLocales = config.supportedLocales ? config.supportedLocales.map(l => I18n.normalizeLocale(l)) : ['en_AU', 'en_US', 'zh_CN'];
    this.reverseUpdate = util.isNullOrUndefined(config.reverseUpdate) ? false : Convertors.toBoolean(config.reverseUpdate);
    this.updateWithMeta = util.isNullOrUndefined(config.updateWithMeta) ? false : Convertors.toBoolean(config.updateWithMeta);
    this.timezone = config.timezone;
    this.pendingUpdates = {};
  }

  isLocaleSupported(locale) {
    let n = locale && I18n.normalizeLocale(locale);
    return this.supportedLocales.some(l => n === l);
  }

  async setupAsync(locale) {
    if (!this.isLocaleSupported(locale)) return Promise.reject('unsupported_locale');
    this.dictionary = {};
    this.locale = I18n.normalizeLocale(locale || this.supportedLocales[0]);
    this.momentLocale = I18n.localeToDash(this.locale).toLowerCase();
    this.momentTimezone = Util.timezone;
    return this;
  }

  getText(token, values, defaultText) {
    if (Util._.isString(values)) {
      defaultText = values;
      values = null;
    }

    var phrase = Util.getValueByPath(this.dictionary, token);

    if (util.isNullOrUndefined(phrase)) {
      phrase = defaultText;

      if (phrase) {
        if (this.reverseUpdate) this.addToDictionary(token, phrase);
      } else {
        phrase = token;
      }
    } else if (util.isObject(phrase)) {
      phrase = phrase['text'];
    }

    return Util._.isEmpty(values) ? phrase : Util.template(phrase, values);
  }

  addToDictionary(token, text, saveImmediate) {
    if (this.updateWithMeta) {
      text = {
        text: text,
        comment: 'Added at ' + this.datetime().format()
      };
    }

    Util.setValueByPath(this.dictionary, token, text);
    this.pendingUpdates[token] = text;

    if (saveImmediate) {
      this.save();
    }
  }

  save() {
    this.pendingUpdates = {};
  }

  datetime(value, timezone) {
    timezone || (timezone = this.timezone);
    var r = this.momentTimezone(value).locale(this.momentLocale);
    return timezone ? r.tz(timezone) : r;
  }

  flush() {
    if (this.reverseUpdate) {
      this.save();
    }
  }

  get dashForm() {
    return I18n.localeToDash(this.locale);
  }

  static normalizeLocale(locale) {
    var l = locale.replace('-', '_').split('_', 2);
    var l2 = l[0].toLowerCase();

    if (l.length > 1) {
      l2 += '_' + l[1].toUpperCase();
    }

    return l2;
  }

  static localeToDash(locale) {
    return locale.replace('_', '-');
  }

  static extractLanguageCode(locale) {
    var pos = locale.lastIndexOf('_');
    if (pos == -1) return locale;
    return locale.substr(0, pos);
  }

  static extractCountryCode(locale) {
    var pos = locale.lastIndexOf('_');
    if (pos == -1) return '';
    return locale.substr(pos + 1);
  }

}

class FileI18n extends I18n {
  constructor(config) {
    super(config);
    config || (config = {});
    this.directory = config.directory || './locale';
  }

  async setupAsync(locale) {
    const self = this;

    function loadDir(dict, dir, finish) {
      Util.fs.readdir(dir, function (err, files) {
        if (err) return finish(err);
        Util.async.each(files, function (file, cb) {
          let langFilePath = path.join(dir, file);
          let stats = Util.fs.statSync(langFilePath);

          if (stats.isDirectory()) {
            dict[file] = {};
            return loadDir(dict[file], langFilePath, cb);
          }

          let extName = path.extname(file);
          if (extName.toLowerCase() !== '.json') return cb();
          Util.fs.readJson(langFilePath, function (err, content) {
            if (err) return cb(err);
            let basename = path.basename(file, extName);
            dict[basename] = content;
            cb();
          });
        }, finish);
      });
    }

    return super.setupAsync(locale).then(() => {
      let langPath = path.resolve(self.directory, 'lang');
      return new Promise((resolve, reject) => {
        let p = path.join(langPath, self.locale);

        if (!Util.fs.existsSync(p)) {
          let lang = I18n.extractLanguageCode(self.locale);
          p = path.join(langPath, lang);

          if (!Util.fs.existsSync(p)) {
            return resolve(self);
          }
        }

        loadDir(self.dictionary, p, err => {
          if (err) return reject(err);
          resolve(self);
        });
      });
    });
  }

  save() {
    var fileSet = new Set();

    Util._.forOwn(this.pendingUpdates, (v, k) => {
      let keyword = path.extname(k);
      let p = path.basename(k, keyword);
      fileSet.add(p);
    });

    var langPath = path.resolve(this.directory, 'lang');
    var bp = path.join(langPath, this.locale);

    for (let p of fileSet) {
      let content = Util.getValueByPath(this.dictionary, p);
      let f = Util.replaceAll(p, '.', path.delimiter) + '.json';
      Util.fs.outputJsonSync(path.join(bp, f), content);
    }

    fileSet.clear();
    super.save();
  }

}

I18n.File = FileI18n;
module.exports = I18n;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pMThuLmpzIl0sIm5hbWVzIjpbInBhdGgiLCJyZXF1aXJlIiwidXRpbCIsIlV0aWwiLCJQcm9taXNlIiwiQ29udmVydG9ycyIsIkkxOG4iLCJjb25zdHJ1Y3RvciIsImNvbmZpZyIsInN1cHBvcnRlZExvY2FsZXMiLCJtYXAiLCJsIiwibm9ybWFsaXplTG9jYWxlIiwicmV2ZXJzZVVwZGF0ZSIsImlzTnVsbE9yVW5kZWZpbmVkIiwidG9Cb29sZWFuIiwidXBkYXRlV2l0aE1ldGEiLCJ0aW1lem9uZSIsInBlbmRpbmdVcGRhdGVzIiwiaXNMb2NhbGVTdXBwb3J0ZWQiLCJsb2NhbGUiLCJuIiwic29tZSIsInNldHVwQXN5bmMiLCJyZWplY3QiLCJkaWN0aW9uYXJ5IiwibW9tZW50TG9jYWxlIiwibG9jYWxlVG9EYXNoIiwidG9Mb3dlckNhc2UiLCJtb21lbnRUaW1lem9uZSIsImdldFRleHQiLCJ0b2tlbiIsInZhbHVlcyIsImRlZmF1bHRUZXh0IiwiXyIsImlzU3RyaW5nIiwicGhyYXNlIiwiZ2V0VmFsdWVCeVBhdGgiLCJhZGRUb0RpY3Rpb25hcnkiLCJpc09iamVjdCIsImlzRW1wdHkiLCJ0ZW1wbGF0ZSIsInRleHQiLCJzYXZlSW1tZWRpYXRlIiwiY29tbWVudCIsImRhdGV0aW1lIiwiZm9ybWF0Iiwic2V0VmFsdWVCeVBhdGgiLCJzYXZlIiwidmFsdWUiLCJyIiwidHoiLCJmbHVzaCIsImRhc2hGb3JtIiwicmVwbGFjZSIsInNwbGl0IiwibDIiLCJsZW5ndGgiLCJ0b1VwcGVyQ2FzZSIsImV4dHJhY3RMYW5ndWFnZUNvZGUiLCJwb3MiLCJsYXN0SW5kZXhPZiIsInN1YnN0ciIsImV4dHJhY3RDb3VudHJ5Q29kZSIsIkZpbGVJMThuIiwiZGlyZWN0b3J5Iiwic2VsZiIsImxvYWREaXIiLCJkaWN0IiwiZGlyIiwiZmluaXNoIiwiZnMiLCJyZWFkZGlyIiwiZXJyIiwiZmlsZXMiLCJhc3luYyIsImVhY2giLCJmaWxlIiwiY2IiLCJsYW5nRmlsZVBhdGgiLCJqb2luIiwic3RhdHMiLCJzdGF0U3luYyIsImlzRGlyZWN0b3J5IiwiZXh0TmFtZSIsImV4dG5hbWUiLCJyZWFkSnNvbiIsImNvbnRlbnQiLCJiYXNlbmFtZSIsInRoZW4iLCJsYW5nUGF0aCIsInJlc29sdmUiLCJwIiwiZXhpc3RzU3luYyIsImxhbmciLCJmaWxlU2V0IiwiU2V0IiwiZm9yT3duIiwidiIsImsiLCJrZXl3b3JkIiwiYWRkIiwiYnAiLCJmIiwicmVwbGFjZUFsbCIsImRlbGltaXRlciIsIm91dHB1dEpzb25TeW5jIiwiY2xlYXIiLCJGaWxlIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU1DLElBQUksR0FBR0QsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTUUsSUFBSSxHQUFHRixPQUFPLENBQUMsV0FBRCxDQUFwQjs7QUFDQSxNQUFNRyxPQUFPLEdBQUdELElBQUksQ0FBQ0MsT0FBckI7O0FBQ0EsTUFBTUMsVUFBVSxHQUFHSixPQUFPLENBQUMsY0FBRCxDQUExQjs7QUFFQSxNQUFNSyxJQUFOLENBQVc7QUFVUEMsRUFBQUEsV0FBVyxDQUFDQyxNQUFELEVBQVM7QUFDaEJBLElBQUFBLE1BQU0sS0FBS0EsTUFBTSxHQUFHLEVBQWQsQ0FBTjtBQUVBLFNBQUtDLGdCQUFMLEdBQXdCRCxNQUFNLENBQUNDLGdCQUFQLEdBQTBCRCxNQUFNLENBQUNDLGdCQUFQLENBQXdCQyxHQUF4QixDQUE0QkMsQ0FBQyxJQUFJTCxJQUFJLENBQUNNLGVBQUwsQ0FBcUJELENBQXJCLENBQWpDLENBQTFCLEdBQXNGLENBQUUsT0FBRixFQUFXLE9BQVgsRUFBb0IsT0FBcEIsQ0FBOUc7QUFDQSxTQUFLRSxhQUFMLEdBQXFCWCxJQUFJLENBQUNZLGlCQUFMLENBQXVCTixNQUFNLENBQUNLLGFBQTlCLElBQStDLEtBQS9DLEdBQXdEUixVQUFVLENBQUNVLFNBQVgs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dXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgdXRpbCA9IHJlcXVpcmUoJ3V0aWwnKTtcbmNvbnN0IFV0aWwgPSByZXF1aXJlKCcuL3V0aWwuanMnKTtcbmNvbnN0IFByb21pc2UgPSBVdGlsLlByb21pc2U7XG5jb25zdCBDb252ZXJ0b3JzID0gcmVxdWlyZSgnLi9Db252ZXJ0b3JzJyk7XG5cbmNsYXNzIEkxOG4ge1xuICAgIC8qKlxuICAgICAqIEFuIGFwcCBtb2R1bGUgb2JqZWN0LlxuICAgICAqIEBjb25zdHJ1Y3RzIEkxOG5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gW2NvbmZpZ10gLSBUaGUgaTE4biBjb25maWd1cmF0aW9uLlxuICAgICAqIEBwcm9wZXJ0eSB7YXJyYXl9IFtjb25maWcuc3VwcG9ydGVkTG9jYWxlc10gLSBUaGUgZGVmYXVsdCBsb2NhbGVcbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtjb25maWcucmV2ZXJzZVVwZGF0ZT1mYWxzZV0gLSBSZXZlcnNlIHVwZGF0ZSB3aGVuXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbY29uZmlnLnVwZGF0ZVdpdGhNZXRhPWZhbHNlXSAtXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtjb25maWcudGltZXpvbmVdIC0gVGltZXpvbmVcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3Rvcihjb25maWcpIHtcbiAgICAgICAgY29uZmlnIHx8IChjb25maWcgPSB7fSk7XG5cbiAgICAgICAgdGhpcy5zdXBwb3J0ZWRMb2NhbGVzID0gY29uZmlnLnN1cHBvcnRlZExvY2FsZXMgPyBjb25maWcuc3VwcG9ydGVkTG9jYWxlcy5tYXAobCA9PiBJMThuLm5vcm1hbGl6ZUxvY2FsZShsKSkgOiBbICdlbl9BVScsICdlbl9VUycsICd6aF9DTicgXTtcbiAgICAgICAgdGhpcy5yZXZlcnNlVXBkYXRlID0gdXRpbC5pc051bGxPclVuZGVmaW5lZChjb25maWcucmV2ZXJzZVVwZGF0ZSkgPyBmYWxzZSA6ICBDb252ZXJ0b3JzLnRvQm9vbGVhbihjb25maWcucmV2ZXJzZVVwZGF0ZSk7XG4gICAgICAgIHRoaXMudXBkYXRlV2l0aE1ldGEgPSB1dGlsLmlzTnVsbE9yVW5kZWZpbmVkKGNvbmZpZy51cGRhdGVXaXRoTWV0YSkgPyBmYWxzZSA6IENvbnZlcnRvcnMudG9Cb29sZWFuKGNvbmZpZy51cGRhdGVXaXRoTWV0YSk7XG4gICAgICAgIHRoaXMudGltZXpvbmUgPSBjb25maWcudGltZXpvbmU7XG4gICAgICAgIHRoaXMucGVuZGluZ1VwZGF0ZXMgPSB7fTtcbiAgICB9XG5cbiAgICBpc0xvY2FsZVN1cHBvcnRlZChsb2NhbGUpIHtcbiAgICAgICAgbGV0IG4gPSBsb2NhbGUgJiYgSTE4bi5ub3JtYWxpemVMb2NhbGUobG9jYWxlKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3VwcG9ydGVkTG9jYWxlcy5zb21lKGwgPT4gbiA9PT0gbCk7XG4gICAgfVxuXG4gICAgYXN5bmMgc2V0dXBBc3luYyhsb2NhbGUpIHtcbiAgICAgICAgaWYgKCF0aGlzLmlzTG9jYWxlU3VwcG9ydGVkKGxvY2FsZSkpIHJldHVybiBQcm9taXNlLnJlamVjdCgndW5zdXBwb3J0ZWRfbG9jYWxlJyk7XG5cbiAgICAgICAgdGhpcy5kaWN0aW9uYXJ5ID0ge307XG5cbiAgICAgICAgdGhpcy5sb2NhbGUgPSBJMThuLm5vcm1hbGl6ZUxvY2FsZShsb2NhbGUgfHwgdGhpcy5zdXBwb3J0ZWRMb2NhbGVzWzBdKTtcbiAgICAgICAgdGhpcy5tb21lbnRMb2NhbGUgPSBJMThuLmxvY2FsZVRvRGFzaCh0aGlzLmxvY2FsZSkudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgdGhpcy5tb21lbnRUaW1lem9uZSA9IFV0aWwudGltZXpvbmU7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgZ2V0VGV4dCh0b2tlbiwgdmFsdWVzLCBkZWZhdWx0VGV4dCkge1xuICAgICAgICBpZiAoVXRpbC5fLmlzU3RyaW5nKHZhbHVlcykpIHtcbiAgICAgICAgICAgIGRlZmF1bHRUZXh0ID0gdmFsdWVzO1xuICAgICAgICAgICAgdmFsdWVzID0gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIHZhciBwaHJhc2UgPSBVdGlsLmdldFZhbHVlQnlQYXRoKHRoaXMuZGljdGlvbmFyeSwgdG9rZW4pO1xuXG4gICAgICAgIGlmICh1dGlsLmlzTnVsbE9yVW5kZWZpbmVkKHBocmFzZSkpIHtcbiAgICAgICAgICAgIHBocmFzZSA9IGRlZmF1bHRUZXh0O1xuXG4gICAgICAgICAgICBpZiAocGhyYXNlKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMucmV2ZXJzZVVwZGF0ZSkgdGhpcy5hZGRUb0RpY3Rpb25hcnkodG9rZW4sIHBocmFzZSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHBocmFzZSA9IHRva2VuO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKHV0aWwuaXNPYmplY3QocGhyYXNlKSkge1xuICAgICAgICAgICAgcGhyYXNlID0gcGhyYXNlWyd0ZXh0J107XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gVXRpbC5fLmlzRW1wdHkodmFsdWVzKSA/IHBocmFzZSA6IFV0aWwudGVtcGxhdGUocGhyYXNlLCB2YWx1ZXMpO1xuICAgIH1cblxuICAgIGFkZFRvRGljdGlvbmFyeSh0b2tlbiwgdGV4dCwgc2F2ZUltbWVkaWF0ZSkge1xuICAgICAgICBpZiAodGhpcy51cGRhdGVXaXRoTWV0YSkge1xuICAgICAgICAgICAgdGV4dCA9IHsgdGV4dDogdGV4dCwgY29tbWVudDogJ0FkZGVkIGF0ICcgKyB0aGlzLmRhdGV0aW1lKCkuZm9ybWF0KCkgfVxuICAgICAgICB9XG5cbiAgICAgICAgVXRpbC5zZXRWYWx1ZUJ5UGF0aCh0aGlzLmRpY3Rpb25hcnksIHRva2VuLCB0ZXh0KTtcblxuICAgICAgICB0aGlzLnBlbmRpbmdVcGRhdGVzW3Rva2VuXSA9IHRleHQ7XG5cbiAgICAgICAgaWYgKHNhdmVJbW1lZGlhdGUpIHtcbiAgICAgICAgICAgIHRoaXMuc2F2ZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgc2F2ZSgpIHtcbiAgICAgICAgdGhpcy5wZW5kaW5nVXBkYXRlcyA9IHt9O1xuICAgIH1cblxuICAgIGRhdGV0aW1lKHZhbHVlLCB0aW1lem9uZSkge1xuICAgICAgICB0aW1lem9uZSB8fCAodGltZXpvbmUgPSB0aGlzLnRpbWV6b25lKTtcblxuICAgICAgICB2YXIgciA9IHRoaXMubW9tZW50VGltZXpvbmUodmFsdWUpLmxvY2FsZSh0aGlzLm1vbWVudExvY2FsZSk7XG5cbiAgICAgICAgcmV0dXJuIHRpbWV6b25lID8gci50eih0aW1lem9uZSkgOiByO1xuICAgIH1cblxuICAgIGZsdXNoKCkge1xuICAgICAgICBpZiAodGhpcy5yZXZlcnNlVXBkYXRlKSB7IHRoaXMuc2F2ZSgpOyB9XG4gICAgfVxuXG4gICAgZ2V0IGRhc2hGb3JtKCkge1xuICAgICAgICByZXR1cm4gSTE4bi5sb2NhbGVUb0Rhc2godGhpcy5sb2NhbGUpO1xuICAgIH1cblxuICAgIHN0YXRpYyBub3JtYWxpemVMb2NhbGUobG9jYWxlKSB7XG4gICAgICAgIHZhciBsID0gbG9jYWxlLnJlcGxhY2UoJy0nLCAnXycpLnNwbGl0KCdfJywgMik7XG4gICAgICAgIHZhciBsMiA9IGxbMF0udG9Mb3dlckNhc2UoKTtcbiAgICAgICAgaWYgKGwubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgbDIgKz0gJ18nICsgbFsxXS50b1VwcGVyQ2FzZSgpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBsMjtcbiAgICB9XG5cbiAgICBzdGF0aWMgbG9jYWxlVG9EYXNoKGxvY2FsZSkge1xuICAgICAgICByZXR1cm4gbG9jYWxlLnJlcGxhY2UoJ18nLCAnLScpO1xuICAgIH1cblxuICAgIHN0YXRpYyBleHRyYWN0TGFuZ3VhZ2VDb2RlKGxvY2FsZSkge1xuICAgICAgICB2YXIgcG9zID0gbG9jYWxlLmxhc3RJbmRleE9mKCdfJyk7XG4gICAgICAgIGlmIChwb3MgPT0gLTEpIHJldHVybiBsb2NhbGU7XG5cbiAgICAgICAgcmV0dXJuIGxvY2FsZS5zdWJzdHIoMCwgcG9zKTtcbiAgICB9XG5cbiAgICBzdGF0aWMgZXh0cmFjdENvdW50cnlDb2RlKGxvY2FsZSkge1xuICAgICAgICB2YXIgcG9zID0gbG9jYWxlLmxhc3RJbmRleE9mKCdfJyk7XG4gICAgICAgIGlmIChwb3MgPT0gLTEpIHJldHVybiAnJztcblxuICAgICAgICByZXR1cm4gbG9jYWxlLnN1YnN0cihwb3MgKyAxKTtcbiAgICB9ICAgIFxufVxuXG5jbGFzcyBGaWxlSTE4biBleHRlbmRzIEkxOG4ge1xuXG4gICAgY29uc3RydWN0b3IoY29uZmlnKSB7XG4gICAgICAgIHN1cGVyKGNvbmZpZyk7XG5cbiAgICAgICAgY29uZmlnIHx8IChjb25maWcgPSB7fSk7XG5cbiAgICAgICAgdGhpcy5kaXJlY3RvcnkgPSBjb25maWcuZGlyZWN0b3J5IHx8ICcuL2xvY2FsZSc7XG4gICAgfVxuXG4gICAgYXN5bmMgc2V0dXBBc3luYyhsb2NhbGUpIHtcbiAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XG5cbiAgICAgICAgZnVuY3Rpb24gbG9hZERpcihkaWN0LCBkaXIsIGZpbmlzaCkge1xuICAgICAgICAgICAgVXRpbC5mcy5yZWFkZGlyKGRpciwgZnVuY3Rpb24gKGVyciwgZmlsZXMpIHtcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSByZXR1cm4gZmluaXNoKGVycik7XG5cbiAgICAgICAgICAgICAgICBVdGlsLmFzeW5jLmVhY2goZmlsZXMsIGZ1bmN0aW9uIChmaWxlLCBjYikge1xuICAgICAgICAgICAgICAgICAgICBsZXQgbGFuZ0ZpbGVQYXRoID0gcGF0aC5qb2luKGRpciwgZmlsZSk7XG4gICAgICAgICAgICAgICAgICAgIGxldCBzdGF0cyA9IFV0aWwuZnMuc3RhdFN5bmMobGFuZ0ZpbGVQYXRoKTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdHMuaXNEaXJlY3RvcnkoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZGljdFtmaWxlXSA9IHt9O1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxvYWREaXIoZGljdFtmaWxlXSwgbGFuZ0ZpbGVQYXRoLCBjYik7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBsZXQgZXh0TmFtZSA9IHBhdGguZXh0bmFtZShmaWxlKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV4dE5hbWUudG9Mb3dlckNhc2UoKSAhPT0gJy5qc29uJykgcmV0dXJuIGNiKCk7XG5cbiAgICAgICAgICAgICAgICAgICAgVXRpbC5mcy5yZWFkSnNvbihsYW5nRmlsZVBhdGgsIGZ1bmN0aW9uIChlcnIsIGNvbnRlbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHJldHVybiBjYihlcnIpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgYmFzZW5hbWUgPSBwYXRoLmJhc2VuYW1lKGZpbGUsIGV4dE5hbWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZGljdFtiYXNlbmFtZV0gPSBjb250ZW50O1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBjYigpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIH0sIGZpbmlzaCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBzdXBlci5zZXR1cEFzeW5jKGxvY2FsZSkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICBsZXQgbGFuZ1BhdGggPSBwYXRoLnJlc29sdmUoc2VsZi5kaXJlY3RvcnksICdsYW5nJyk7XG5cbiAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IHAgPSBwYXRoLmpvaW4obGFuZ1BhdGgsIHNlbGYubG9jYWxlKTtcblxuICAgICAgICAgICAgICAgIGlmICghVXRpbC5mcy5leGlzdHNTeW5jKHApKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vdHJ5IG9ubHkgbGFuZ3VhZ2UgY29kZVxuICAgICAgICAgICAgICAgICAgICBsZXQgbGFuZyA9IEkxOG4uZXh0cmFjdExhbmd1YWdlQ29kZShzZWxmLmxvY2FsZSk7XG4gICAgICAgICAgICAgICAgICAgIHAgPSBwYXRoLmpvaW4obGFuZ1BhdGgsIGxhbmcpO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmICghVXRpbC5mcy5leGlzdHNTeW5jKHApKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZShzZWxmKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGxvYWREaXIoc2VsZi5kaWN0aW9uYXJ5LCBwLCAoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHJldHVybiByZWplY3QoZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShzZWxmKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBzYXZlKCkge1xuICAgICAgICB2YXIgZmlsZVNldCA9IG5ldyBTZXQoKTtcblxuICAgICAgICBVdGlsLl8uZm9yT3duKHRoaXMucGVuZGluZ1VwZGF0ZXMsICh2LCBrKSA9PiB7XG4gICAgICAgICAgICBsZXQga2V5d29yZCA9IHBhdGguZXh0bmFtZShrKTtcbiAgICAgICAgICAgIGxldCBwID0gcGF0aC5iYXNlbmFtZShrLCBrZXl3b3JkKTtcbiAgICAgICAgICAgIGZpbGVTZXQuYWRkKHApO1xuICAgICAgICB9KTtcblxuICAgICAgICB2YXIgbGFuZ1BhdGggPSBwYXRoLnJlc29sdmUodGhpcy5kaXJlY3RvcnksICdsYW5nJyk7XG4gICAgICAgIHZhciBicCA9IHBhdGguam9pbihsYW5nUGF0aCwgdGhpcy5sb2NhbGUpO1xuXG4gICAgICAgIGZvciAobGV0IHAgb2YgZmlsZVNldCkge1xuICAgICAgICAgICAgbGV0IGNvbnRlbnQgPSBVdGlsLmdldFZhbHVlQnlQYXRoKHRoaXMuZGljdGlvbmFyeSwgcCk7XG4gICAgICAgICAgICBsZXQgZiA9IFV0aWwucmVwbGFjZUFsbChwLCAnLicsIHBhdGguZGVsaW1pdGVyKSArICcuanNvbic7XG5cbiAgICAgICAgICAgIFV0aWwuZnMub3V0cHV0SnNvblN5bmMocGF0aC5qb2luKGJwLCBmKSwgY29udGVudCk7XG4gICAgICAgIH1cblxuICAgICAgICBmaWxlU2V0LmNsZWFyKCk7XG5cbiAgICAgICAgc3VwZXIuc2F2ZSgpO1xuICAgIH1cbn1cblxuSTE4bi5GaWxlID0gRmlsZUkxOG47XG5cbm1vZHVsZS5leHBvcnRzID0gSTE4bjsiXX0=