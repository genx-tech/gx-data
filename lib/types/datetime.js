"use strict";

require("source-map-support/register");

const _ = require('rk-utils')._;

const {
  DateTime
} = require('luxon');

const any = require('./any');

const {
  ValidationError
} = require('../utils/Errors');

module.exports = {
  name: 'datetime',
  typeObject: DateTime,
  alias: ['date', 'time', 'timestamp'],
  sanitize: (value, info, i18n) => {
    let opts = {
      zone: (i18n === null || i18n === void 0 ? void 0 : i18n.timezone) || 'local'
    };
    let raw = value;

    if (value instanceof Date) {
      value = DateTime.fromJSDate(value, opts);
    } else {
      let type = typeof value;

      if (type === 'string' && !info.dontParse) {
        if (info.inputFormat) {
          value = DateTime.fromFormat(value, info.inputFormat, opts);
        } else {
          value = DateTime.fromISO(value, opts);
        }
      } else if (type === 'number') {
        value = DateTime.fromMillis(value, opts);
      } else if (type !== 'object' || value.constructor.name !== 'DateTime') {
        throw new ValidationError('Invalid datetime object.', {
          value: raw,
          field: info
        });
      }
    }

    if (!value.isValid) {
      throw new ValidationError('Invalid datetime object.', {
        value: raw,
        field: info
      });
    }

    return value;
  },
  defaultValue: 0,
  generate: (info, i18n) => i18n ? i18n.now() : DateTime.local(),
  serialize: value => {
    if (value && value.toISO) {
      return value.toISO({
        includeOffset: false
      });
    }

    return value;
  },
  qualifiers: any.qualifiers.concat(['timezone', 'dateOnly', 'timeOnly', 'inputFormat', 'dontParse'])
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90eXBlcy9kYXRldGltZS5qcyJdLCJuYW1lcyI6WyJfIiwicmVxdWlyZSIsIkRhdGVUaW1lIiwiYW55IiwiVmFsaWRhdGlvbkVycm9yIiwibW9kdWxlIiwiZXhwb3J0cyIsIm5hbWUiLCJ0eXBlT2JqZWN0IiwiYWxpYXMiLCJzYW5pdGl6ZSIsInZhbHVlIiwiaW5mbyIsImkxOG4iLCJvcHRzIiwiem9uZSIsInRpbWV6b25lIiwicmF3IiwiRGF0ZSIsImZyb21KU0RhdGUiLCJ0eXBlIiwiZG9udFBhcnNlIiwiaW5wdXRGb3JtYXQiLCJmcm9tRm9ybWF0IiwiZnJvbUlTTyIsImZyb21NaWxsaXMiLCJjb25zdHJ1Y3RvciIsImZpZWxkIiwiaXNWYWxpZCIsImRlZmF1bHRWYWx1ZSIsImdlbmVyYXRlIiwibm93IiwibG9jYWwiLCJzZXJpYWxpemUiLCJ0b0lTTyIsImluY2x1ZGVPZmZzZXQiLCJxdWFsaWZpZXJzIiwiY29uY2F0Il0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU1BLENBQUMsR0FBR0MsT0FBTyxDQUFDLFVBQUQsQ0FBUCxDQUFvQkQsQ0FBOUI7O0FBQ0EsTUFBTTtBQUFFRSxFQUFBQTtBQUFGLElBQWVELE9BQU8sQ0FBQyxPQUFELENBQTVCOztBQUNBLE1BQU1FLEdBQUcsR0FBR0YsT0FBTyxDQUFDLE9BQUQsQ0FBbkI7O0FBQ0EsTUFBTTtBQUFFRyxFQUFBQTtBQUFGLElBQXNCSCxPQUFPLENBQUMsaUJBQUQsQ0FBbkM7O0FBRUFJLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjtBQUNiQyxFQUFBQSxJQUFJLEVBQUUsVUFETztBQUdiQyxFQUFBQSxVQUFVLEVBQUVOLFFBSEM7QUFLYk8sRUFBQUEsS0FBSyxFQUFFLENBQUUsTUFBRixFQUFVLE1BQVYsRUFBa0IsV0FBbEIsQ0FMTTtBQU9iQyxFQUFBQSxRQUFRLEVBQUUsQ0FBQ0MsS0FBRCxFQUFRQyxJQUFSLEVBQWNDLElBQWQsS0FBdUI7QUFDN0IsUUFBSUMsSUFBSSxHQUFHO0FBQUVDLE1BQUFBLElBQUksRUFBRSxDQUFBRixJQUFJLFNBQUosSUFBQUEsSUFBSSxXQUFKLFlBQUFBLElBQUksQ0FBRUcsUUFBTixLQUFrQjtBQUExQixLQUFYO0FBRUEsUUFBSUMsR0FBRyxHQUFHTixLQUFWOztBQUVBLFFBQUlBLEtBQUssWUFBWU8sSUFBckIsRUFBMkI7QUFDdkJQLE1BQUFBLEtBQUssR0FBR1QsUUFBUSxDQUFDaUIsVUFBVCxDQUFvQlIsS0FBcEIsRUFBMkJHLElBQTNCLENBQVI7QUFDSCxLQUZELE1BRU87QUFDSCxVQUFJTSxJQUFJLEdBQUcsT0FBT1QsS0FBbEI7O0FBRUEsVUFBSVMsSUFBSSxLQUFLLFFBQVQsSUFBcUIsQ0FBQ1IsSUFBSSxDQUFDUyxTQUEvQixFQUEwQztBQUN0QyxZQUFJVCxJQUFJLENBQUNVLFdBQVQsRUFBc0I7QUFDbEJYLFVBQUFBLEtBQUssR0FBR1QsUUFBUSxDQUFDcUIsVUFBVCxDQUFvQlosS0FBcEIsRUFBMkJDLElBQUksQ0FBQ1UsV0FBaEMsRUFBNkNSLElBQTdDLENBQVI7QUFDSCxTQUZELE1BRU87QUFDSEgsVUFBQUEsS0FBSyxHQUFHVCxRQUFRLENBQUNzQixPQUFULENBQWlCYixLQUFqQixFQUF3QkcsSUFBeEIsQ0FBUjtBQUNIO0FBQ0osT0FORCxNQU1PLElBQUlNLElBQUksS0FBSyxRQUFiLEVBQXVCO0FBQzFCVCxRQUFBQSxLQUFLLEdBQUdULFFBQVEsQ0FBQ3VCLFVBQVQsQ0FBb0JkLEtBQXBCLEVBQTJCRyxJQUEzQixDQUFSO0FBQ0gsT0FGTSxNQUVBLElBQUlNLElBQUksS0FBSyxRQUFULElBQXFCVCxLQUFLLENBQUNlLFdBQU4sQ0FBa0JuQixJQUFsQixLQUEyQixVQUFwRCxFQUFnRTtBQUNuRSxjQUFNLElBQUlILGVBQUosQ0FBb0IsMEJBQXBCLEVBQWdEO0FBQUVPLFVBQUFBLEtBQUssRUFBRU0sR0FBVDtBQUFjVSxVQUFBQSxLQUFLLEVBQUVmO0FBQXJCLFNBQWhELENBQU47QUFDSDtBQUNKOztBQUVELFFBQUksQ0FBQ0QsS0FBSyxDQUFDaUIsT0FBWCxFQUFvQjtBQUNoQixZQUFNLElBQUl4QixlQUFKLENBQW9CLDBCQUFwQixFQUFnRDtBQUFFTyxRQUFBQSxLQUFLLEVBQUVNLEdBQVQ7QUFBY1UsUUFBQUEsS0FBSyxFQUFFZjtBQUFyQixPQUFoRCxDQUFOO0FBQ0g7O0FBRUQsV0FBT0QsS0FBUDtBQUNILEdBbkNZO0FBcUNia0IsRUFBQUEsWUFBWSxFQUFFLENBckNEO0FBdUNiQyxFQUFBQSxRQUFRLEVBQUUsQ0FBQ2xCLElBQUQsRUFBT0MsSUFBUCxLQUFnQkEsSUFBSSxHQUFHQSxJQUFJLENBQUNrQixHQUFMLEVBQUgsR0FBZ0I3QixRQUFRLENBQUM4QixLQUFULEVBdkNqQztBQXlDYkMsRUFBQUEsU0FBUyxFQUFFdEIsS0FBSyxJQUFJO0FBQ2hCLFFBQUlBLEtBQUssSUFBSUEsS0FBSyxDQUFDdUIsS0FBbkIsRUFBMEI7QUFDdEIsYUFBT3ZCLEtBQUssQ0FBQ3VCLEtBQU4sQ0FBWTtBQUFFQyxRQUFBQSxhQUFhLEVBQUU7QUFBakIsT0FBWixDQUFQO0FBQ0g7O0FBRUQsV0FBT3hCLEtBQVA7QUFDSCxHQS9DWTtBQWlEYnlCLEVBQUFBLFVBQVUsRUFBRWpDLEdBQUcsQ0FBQ2lDLFVBQUosQ0FBZUMsTUFBZixDQUFzQixDQUM5QixVQUQ4QixFQUU5QixVQUY4QixFQUc5QixVQUg4QixFQUk5QixhQUo4QixFQUs5QixXQUw4QixDQUF0QjtBQWpEQyxDQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBfID0gcmVxdWlyZSgncmstdXRpbHMnKS5fO1xuY29uc3QgeyBEYXRlVGltZSB9ID0gcmVxdWlyZSgnbHV4b24nKTtcbmNvbnN0IGFueSA9IHJlcXVpcmUoJy4vYW55Jyk7XG5jb25zdCB7IFZhbGlkYXRpb25FcnJvciB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvRXJyb3JzJyk7XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICAgIG5hbWU6ICdkYXRldGltZScsXG5cbiAgICB0eXBlT2JqZWN0OiBEYXRlVGltZSxcblxuICAgIGFsaWFzOiBbICdkYXRlJywgJ3RpbWUnLCAndGltZXN0YW1wJyBdLFxuXG4gICAgc2FuaXRpemU6ICh2YWx1ZSwgaW5mbywgaTE4bikgPT4geyAgICAgICAgICAgXG4gICAgICAgIGxldCBvcHRzID0geyB6b25lOiBpMThuPy50aW1lem9uZSB8fCAnbG9jYWwnIH07XG5cbiAgICAgICAgbGV0IHJhdyA9IHZhbHVlO1xuXG4gICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIERhdGUpIHtcbiAgICAgICAgICAgIHZhbHVlID0gRGF0ZVRpbWUuZnJvbUpTRGF0ZSh2YWx1ZSwgb3B0cyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsZXQgdHlwZSA9IHR5cGVvZiB2YWx1ZTtcbiAgICAgICAgXG4gICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3N0cmluZycgJiYgIWluZm8uZG9udFBhcnNlKSB7XG4gICAgICAgICAgICAgICAgaWYgKGluZm8uaW5wdXRGb3JtYXQpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBEYXRlVGltZS5mcm9tRm9ybWF0KHZhbHVlLCBpbmZvLmlucHV0Rm9ybWF0LCBvcHRzKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IERhdGVUaW1lLmZyb21JU08odmFsdWUsIG9wdHMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ251bWJlcicpIHtcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IERhdGVUaW1lLmZyb21NaWxsaXModmFsdWUsIG9wdHMpO1xuICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlICE9PSAnb2JqZWN0JyB8fCB2YWx1ZS5jb25zdHJ1Y3Rvci5uYW1lICE9PSAnRGF0ZVRpbWUnKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcignSW52YWxpZCBkYXRldGltZSBvYmplY3QuJywgeyB2YWx1ZTogcmF3LCBmaWVsZDogaW5mbyB9KTtcbiAgICAgICAgICAgIH0gICAgICAgICAgICAgXG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGlmICghdmFsdWUuaXNWYWxpZCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcignSW52YWxpZCBkYXRldGltZSBvYmplY3QuJywgeyB2YWx1ZTogcmF3LCBmaWVsZDogaW5mbyB9KTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH0sXG5cbiAgICBkZWZhdWx0VmFsdWU6IDAsXG5cbiAgICBnZW5lcmF0ZTogKGluZm8sIGkxOG4pID0+IGkxOG4gPyBpMThuLm5vdygpIDogRGF0ZVRpbWUubG9jYWwoKSxcblxuICAgIHNlcmlhbGl6ZTogdmFsdWUgPT4ge1xuICAgICAgICBpZiAodmFsdWUgJiYgdmFsdWUudG9JU08pIHtcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZS50b0lTTyh7IGluY2x1ZGVPZmZzZXQ6IGZhbHNlIH0pOyBcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9LFxuXG4gICAgcXVhbGlmaWVyczogYW55LnF1YWxpZmllcnMuY29uY2F0KFtcbiAgICAgICAgJ3RpbWV6b25lJyxcbiAgICAgICAgJ2RhdGVPbmx5JyxcbiAgICAgICAgJ3RpbWVPbmx5JyxcbiAgICAgICAgJ2lucHV0Rm9ybWF0JyxcbiAgICAgICAgJ2RvbnRQYXJzZSdcbiAgICBdKVxufTsiXX0=