"use strict";

require("source-map-support/register");

const _ = require('rk-utils')._;

const {
  DateTime
} = require('luxon');

const any = require('./any');

const {
  ValidationError
} = require('../utils/Errors');

module.exports = {
  name: 'datetime',
  typeObject: DateTime,
  alias: ['date', 'time', 'timestamp'],
  sanitize: (value, info, i18n) => {
    if (value == null) return null;
    let opts = {
      zone: (i18n === null || i18n === void 0 ? void 0 : i18n.timezone) || 'local'
    };
    let raw = value;

    if (value instanceof Date) {
      value = DateTime.fromJSDate(value, opts);
    } else {
      let type = typeof value;

      if (type === 'string' && !info.dontParse) {
        if (info.inputFormat) {
          value = DateTime.fromFormat(value, info.inputFormat, opts);
        } else {
          value = DateTime.fromISO(value, opts);
        }
      } else if (type === 'number') {
        value = DateTime.fromMillis(value, opts);
      } else if (type !== 'object' || value.constructor.name !== 'DateTime') {
        throw new ValidationError('Invalid datetime object.', {
          value: raw,
          field: info
        });
      }
    }

    if (!value.isValid) {
      throw new ValidationError('Invalid datetime object.', {
        value: raw,
        field: info
      });
    }

    return value;
  },
  defaultValue: 0,
  generate: (info, i18n) => i18n ? i18n.now() : DateTime.local(),
  serialize: value => {
    if (value && value.toISO) {
      return value.toISO({
        includeOffset: false
      });
    }

    return value;
  },
  qualifiers: any.qualifiers.concat(['timezone', 'dateOnly', 'timeOnly', 'inputFormat', 'dontParse'])
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90eXBlcy9kYXRldGltZS5qcyJdLCJuYW1lcyI6WyJfIiwicmVxdWlyZSIsIkRhdGVUaW1lIiwiYW55IiwiVmFsaWRhdGlvbkVycm9yIiwibW9kdWxlIiwiZXhwb3J0cyIsIm5hbWUiLCJ0eXBlT2JqZWN0IiwiYWxpYXMiLCJzYW5pdGl6ZSIsInZhbHVlIiwiaW5mbyIsImkxOG4iLCJvcHRzIiwiem9uZSIsInRpbWV6b25lIiwicmF3IiwiRGF0ZSIsImZyb21KU0RhdGUiLCJ0eXBlIiwiZG9udFBhcnNlIiwiaW5wdXRGb3JtYXQiLCJmcm9tRm9ybWF0IiwiZnJvbUlTTyIsImZyb21NaWxsaXMiLCJjb25zdHJ1Y3RvciIsImZpZWxkIiwiaXNWYWxpZCIsImRlZmF1bHRWYWx1ZSIsImdlbmVyYXRlIiwibm93IiwibG9jYWwiLCJzZXJpYWxpemUiLCJ0b0lTTyIsImluY2x1ZGVPZmZzZXQiLCJxdWFsaWZpZXJzIiwiY29uY2F0Il0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU1BLENBQUMsR0FBR0MsT0FBTyxDQUFDLFVBQUQsQ0FBUCxDQUFvQkQsQ0FBOUI7O0FBQ0EsTUFBTTtBQUFFRSxFQUFBQTtBQUFGLElBQWVELE9BQU8sQ0FBQyxPQUFELENBQTVCOztBQUNBLE1BQU1FLEdBQUcsR0FBR0YsT0FBTyxDQUFDLE9BQUQsQ0FBbkI7O0FBQ0EsTUFBTTtBQUFFRyxFQUFBQTtBQUFGLElBQXNCSCxPQUFPLENBQUMsaUJBQUQsQ0FBbkM7O0FBRUFJLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjtBQUNiQyxFQUFBQSxJQUFJLEVBQUUsVUFETztBQUdiQyxFQUFBQSxVQUFVLEVBQUVOLFFBSEM7QUFLYk8sRUFBQUEsS0FBSyxFQUFFLENBQUUsTUFBRixFQUFVLE1BQVYsRUFBa0IsV0FBbEIsQ0FMTTtBQU9iQyxFQUFBQSxRQUFRLEVBQUUsQ0FBQ0MsS0FBRCxFQUFRQyxJQUFSLEVBQWNDLElBQWQsS0FBdUI7QUFDN0IsUUFBSUYsS0FBSyxJQUFJLElBQWIsRUFBbUIsT0FBTyxJQUFQO0FBRW5CLFFBQUlHLElBQUksR0FBRztBQUFFQyxNQUFBQSxJQUFJLEVBQUUsQ0FBQUYsSUFBSSxTQUFKLElBQUFBLElBQUksV0FBSixZQUFBQSxJQUFJLENBQUVHLFFBQU4sS0FBa0I7QUFBMUIsS0FBWDtBQUVBLFFBQUlDLEdBQUcsR0FBR04sS0FBVjs7QUFFQSxRQUFJQSxLQUFLLFlBQVlPLElBQXJCLEVBQTJCO0FBQ3ZCUCxNQUFBQSxLQUFLLEdBQUdULFFBQVEsQ0FBQ2lCLFVBQVQsQ0FBb0JSLEtBQXBCLEVBQTJCRyxJQUEzQixDQUFSO0FBQ0gsS0FGRCxNQUVPO0FBQ0gsVUFBSU0sSUFBSSxHQUFHLE9BQU9ULEtBQWxCOztBQUVBLFVBQUlTLElBQUksS0FBSyxRQUFULElBQXFCLENBQUNSLElBQUksQ0FBQ1MsU0FBL0IsRUFBMEM7QUFDdEMsWUFBSVQsSUFBSSxDQUFDVSxXQUFULEVBQXNCO0FBQ2xCWCxVQUFBQSxLQUFLLEdBQUdULFFBQVEsQ0FBQ3FCLFVBQVQsQ0FBb0JaLEtBQXBCLEVBQTJCQyxJQUFJLENBQUNVLFdBQWhDLEVBQTZDUixJQUE3QyxDQUFSO0FBQ0gsU0FGRCxNQUVPO0FBQ0hILFVBQUFBLEtBQUssR0FBR1QsUUFBUSxDQUFDc0IsT0FBVCxDQUFpQmIsS0FBakIsRUFBd0JHLElBQXhCLENBQVI7QUFDSDtBQUNKLE9BTkQsTUFNTyxJQUFJTSxJQUFJLEtBQUssUUFBYixFQUF1QjtBQUMxQlQsUUFBQUEsS0FBSyxHQUFHVCxRQUFRLENBQUN1QixVQUFULENBQW9CZCxLQUFwQixFQUEyQkcsSUFBM0IsQ0FBUjtBQUNILE9BRk0sTUFFQSxJQUFJTSxJQUFJLEtBQUssUUFBVCxJQUFxQlQsS0FBSyxDQUFDZSxXQUFOLENBQWtCbkIsSUFBbEIsS0FBMkIsVUFBcEQsRUFBZ0U7QUFDbkUsY0FBTSxJQUFJSCxlQUFKLENBQW9CLDBCQUFwQixFQUFnRDtBQUFFTyxVQUFBQSxLQUFLLEVBQUVNLEdBQVQ7QUFBY1UsVUFBQUEsS0FBSyxFQUFFZjtBQUFyQixTQUFoRCxDQUFOO0FBQ0g7QUFDSjs7QUFFRCxRQUFJLENBQUNELEtBQUssQ0FBQ2lCLE9BQVgsRUFBb0I7QUFDaEIsWUFBTSxJQUFJeEIsZUFBSixDQUFvQiwwQkFBcEIsRUFBZ0Q7QUFBRU8sUUFBQUEsS0FBSyxFQUFFTSxHQUFUO0FBQWNVLFFBQUFBLEtBQUssRUFBRWY7QUFBckIsT0FBaEQsQ0FBTjtBQUNIOztBQUVELFdBQU9ELEtBQVA7QUFDSCxHQXJDWTtBQXVDYmtCLEVBQUFBLFlBQVksRUFBRSxDQXZDRDtBQXlDYkMsRUFBQUEsUUFBUSxFQUFFLENBQUNsQixJQUFELEVBQU9DLElBQVAsS0FBZ0JBLElBQUksR0FBR0EsSUFBSSxDQUFDa0IsR0FBTCxFQUFILEdBQWdCN0IsUUFBUSxDQUFDOEIsS0FBVCxFQXpDakM7QUEyQ2JDLEVBQUFBLFNBQVMsRUFBRXRCLEtBQUssSUFBSTtBQUNoQixRQUFJQSxLQUFLLElBQUlBLEtBQUssQ0FBQ3VCLEtBQW5CLEVBQTBCO0FBQ3RCLGFBQU92QixLQUFLLENBQUN1QixLQUFOLENBQVk7QUFBRUMsUUFBQUEsYUFBYSxFQUFFO0FBQWpCLE9BQVosQ0FBUDtBQUNIOztBQUVELFdBQU94QixLQUFQO0FBQ0gsR0FqRFk7QUFtRGJ5QixFQUFBQSxVQUFVLEVBQUVqQyxHQUFHLENBQUNpQyxVQUFKLENBQWVDLE1BQWYsQ0FBc0IsQ0FDOUIsVUFEOEIsRUFFOUIsVUFGOEIsRUFHOUIsVUFIOEIsRUFJOUIsYUFKOEIsRUFLOUIsV0FMOEIsQ0FBdEI7QUFuREMsQ0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgXyA9IHJlcXVpcmUoJ3JrLXV0aWxzJykuXztcbmNvbnN0IHsgRGF0ZVRpbWUgfSA9IHJlcXVpcmUoJ2x1eG9uJyk7XG5jb25zdCBhbnkgPSByZXF1aXJlKCcuL2FueScpO1xuY29uc3QgeyBWYWxpZGF0aW9uRXJyb3IgfSA9IHJlcXVpcmUoJy4uL3V0aWxzL0Vycm9ycycpO1xuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgICBuYW1lOiAnZGF0ZXRpbWUnLFxuXG4gICAgdHlwZU9iamVjdDogRGF0ZVRpbWUsXG5cbiAgICBhbGlhczogWyAnZGF0ZScsICd0aW1lJywgJ3RpbWVzdGFtcCcgXSxcblxuICAgIHNhbml0aXplOiAodmFsdWUsIGluZm8sIGkxOG4pID0+IHsgICBcbiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHJldHVybiBudWxsO1xuICAgICAgICBcbiAgICAgICAgbGV0IG9wdHMgPSB7IHpvbmU6IGkxOG4/LnRpbWV6b25lIHx8ICdsb2NhbCcgfTtcblxuICAgICAgICBsZXQgcmF3ID0gdmFsdWU7XG5cbiAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgRGF0ZSkge1xuICAgICAgICAgICAgdmFsdWUgPSBEYXRlVGltZS5mcm9tSlNEYXRlKHZhbHVlLCBvcHRzKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxldCB0eXBlID0gdHlwZW9mIHZhbHVlO1xuICAgICAgICBcbiAgICAgICAgICAgIGlmICh0eXBlID09PSAnc3RyaW5nJyAmJiAhaW5mby5kb250UGFyc2UpIHtcbiAgICAgICAgICAgICAgICBpZiAoaW5mby5pbnB1dEZvcm1hdCkge1xuICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IERhdGVUaW1lLmZyb21Gb3JtYXQodmFsdWUsIGluZm8uaW5wdXRGb3JtYXQsIG9wdHMpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHZhbHVlID0gRGF0ZVRpbWUuZnJvbUlTTyh2YWx1ZSwgb3B0cyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnbnVtYmVyJykge1xuICAgICAgICAgICAgICAgIHZhbHVlID0gRGF0ZVRpbWUuZnJvbU1pbGxpcyh2YWx1ZSwgb3B0cyk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgIT09ICdvYmplY3QnIHx8IHZhbHVlLmNvbnN0cnVjdG9yLm5hbWUgIT09ICdEYXRlVGltZScpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKCdJbnZhbGlkIGRhdGV0aW1lIG9iamVjdC4nLCB7IHZhbHVlOiByYXcsIGZpZWxkOiBpbmZvIH0pO1xuICAgICAgICAgICAgfSAgICAgICAgICAgICBcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgaWYgKCF2YWx1ZS5pc1ZhbGlkKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKCdJbnZhbGlkIGRhdGV0aW1lIG9iamVjdC4nLCB7IHZhbHVlOiByYXcsIGZpZWxkOiBpbmZvIH0pO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gdmFsdWU7XG4gICAgfSxcblxuICAgIGRlZmF1bHRWYWx1ZTogMCxcblxuICAgIGdlbmVyYXRlOiAoaW5mbywgaTE4bikgPT4gaTE4biA/IGkxOG4ubm93KCkgOiBEYXRlVGltZS5sb2NhbCgpLFxuXG4gICAgc2VyaWFsaXplOiB2YWx1ZSA9PiB7XG4gICAgICAgIGlmICh2YWx1ZSAmJiB2YWx1ZS50b0lTTykge1xuICAgICAgICAgICAgcmV0dXJuIHZhbHVlLnRvSVNPKHsgaW5jbHVkZU9mZnNldDogZmFsc2UgfSk7IFxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH0sXG5cbiAgICBxdWFsaWZpZXJzOiBhbnkucXVhbGlmaWVycy5jb25jYXQoW1xuICAgICAgICAndGltZXpvbmUnLFxuICAgICAgICAnZGF0ZU9ubHknLFxuICAgICAgICAndGltZU9ubHknLFxuICAgICAgICAnaW5wdXRGb3JtYXQnLFxuICAgICAgICAnZG9udFBhcnNlJ1xuICAgIF0pXG59OyJdfQ==