"use strict";

require("source-map-support/register");

const _ = require('rk-utils')._;

const {
  DateTime
} = require('luxon');

const any = require('./any');

const {
  ValidationError
} = require('../utils/Errors');

module.exports = {
  name: 'datetime',
  typeObject: DateTime,
  alias: ['date', 'time', 'timestamp'],
  sanitize: (value, info, i18n) => {
    if (value == null) return null;
    let opts = {
      zone: (i18n === null || i18n === void 0 ? void 0 : i18n.timezone) || 'local'
    };
    let raw = value;

    if (value instanceof Date) {
      value = DateTime.fromJSDate(value, opts);
    } else {
      let type = typeof value;

      if (type === 'string' && !info.dontParse) {
        if (info.inputFormat) {
          value = DateTime.fromFormat(value, info.inputFormat, opts);
        } else {
          value = DateTime.fromISO(value, opts);
        }
      } else if (type === 'number') {
        value = DateTime.fromMillis(value, opts);
      } else if (type !== 'object' || !value.isLuxonDateTime) {
        throw new ValidationError('Invalid datetime object.', {
          value: raw,
          field: info
        });
      }
    }

    if (!value.isValid) {
      throw new ValidationError('Invalid datetime object.', {
        value: raw,
        field: info
      });
    }

    return value;
  },
  defaultValue: 0,
  generate: (info, i18n) => i18n ? i18n.now() : DateTime.local(),
  serialize: value => {
    if (value && value.toISO) {
      return value.toISO({
        includeOffset: false
      });
    }

    return value;
  },
  qualifiers: any.qualifiers.concat(['timezone', 'dateOnly', 'timeOnly', 'inputFormat', 'dontParse'])
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90eXBlcy9kYXRldGltZS5qcyJdLCJuYW1lcyI6WyJfIiwicmVxdWlyZSIsIkRhdGVUaW1lIiwiYW55IiwiVmFsaWRhdGlvbkVycm9yIiwibW9kdWxlIiwiZXhwb3J0cyIsIm5hbWUiLCJ0eXBlT2JqZWN0IiwiYWxpYXMiLCJzYW5pdGl6ZSIsInZhbHVlIiwiaW5mbyIsImkxOG4iLCJvcHRzIiwiem9uZSIsInRpbWV6b25lIiwicmF3IiwiRGF0ZSIsImZyb21KU0RhdGUiLCJ0eXBlIiwiZG9udFBhcnNlIiwiaW5wdXRGb3JtYXQiLCJmcm9tRm9ybWF0IiwiZnJvbUlTTyIsImZyb21NaWxsaXMiLCJpc0x1eG9uRGF0ZVRpbWUiLCJmaWVsZCIsImlzVmFsaWQiLCJkZWZhdWx0VmFsdWUiLCJnZW5lcmF0ZSIsIm5vdyIsImxvY2FsIiwic2VyaWFsaXplIiwidG9JU08iLCJpbmNsdWRlT2Zmc2V0IiwicXVhbGlmaWVycyIsImNvbmNhdCJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNQSxDQUFDLEdBQUdDLE9BQU8sQ0FBQyxVQUFELENBQVAsQ0FBb0JELENBQTlCOztBQUNBLE1BQU07QUFBRUUsRUFBQUE7QUFBRixJQUFlRCxPQUFPLENBQUMsT0FBRCxDQUE1Qjs7QUFDQSxNQUFNRSxHQUFHLEdBQUdGLE9BQU8sQ0FBQyxPQUFELENBQW5COztBQUNBLE1BQU07QUFBRUcsRUFBQUE7QUFBRixJQUFzQkgsT0FBTyxDQUFDLGlCQUFELENBQW5DOztBQUVBSSxNQUFNLENBQUNDLE9BQVAsR0FBaUI7QUFDYkMsRUFBQUEsSUFBSSxFQUFFLFVBRE87QUFHYkMsRUFBQUEsVUFBVSxFQUFFTixRQUhDO0FBS2JPLEVBQUFBLEtBQUssRUFBRSxDQUFFLE1BQUYsRUFBVSxNQUFWLEVBQWtCLFdBQWxCLENBTE07QUFPYkMsRUFBQUEsUUFBUSxFQUFFLENBQUNDLEtBQUQsRUFBUUMsSUFBUixFQUFjQyxJQUFkLEtBQXVCO0FBQzdCLFFBQUlGLEtBQUssSUFBSSxJQUFiLEVBQW1CLE9BQU8sSUFBUDtBQUVuQixRQUFJRyxJQUFJLEdBQUc7QUFBRUMsTUFBQUEsSUFBSSxFQUFFLENBQUFGLElBQUksU0FBSixJQUFBQSxJQUFJLFdBQUosWUFBQUEsSUFBSSxDQUFFRyxRQUFOLEtBQWtCO0FBQTFCLEtBQVg7QUFFQSxRQUFJQyxHQUFHLEdBQUdOLEtBQVY7O0FBRUEsUUFBSUEsS0FBSyxZQUFZTyxJQUFyQixFQUEyQjtBQUN2QlAsTUFBQUEsS0FBSyxHQUFHVCxRQUFRLENBQUNpQixVQUFULENBQW9CUixLQUFwQixFQUEyQkcsSUFBM0IsQ0FBUjtBQUNILEtBRkQsTUFFTztBQUNILFVBQUlNLElBQUksR0FBRyxPQUFPVCxLQUFsQjs7QUFFQSxVQUFJUyxJQUFJLEtBQUssUUFBVCxJQUFxQixDQUFDUixJQUFJLENBQUNTLFNBQS9CLEVBQTBDO0FBQ3RDLFlBQUlULElBQUksQ0FBQ1UsV0FBVCxFQUFzQjtBQUNsQlgsVUFBQUEsS0FBSyxHQUFHVCxRQUFRLENBQUNxQixVQUFULENBQW9CWixLQUFwQixFQUEyQkMsSUFBSSxDQUFDVSxXQUFoQyxFQUE2Q1IsSUFBN0MsQ0FBUjtBQUNILFNBRkQsTUFFTztBQUNISCxVQUFBQSxLQUFLLEdBQUdULFFBQVEsQ0FBQ3NCLE9BQVQsQ0FBaUJiLEtBQWpCLEVBQXdCRyxJQUF4QixDQUFSO0FBQ0g7QUFDSixPQU5ELE1BTU8sSUFBSU0sSUFBSSxLQUFLLFFBQWIsRUFBdUI7QUFDMUJULFFBQUFBLEtBQUssR0FBR1QsUUFBUSxDQUFDdUIsVUFBVCxDQUFvQmQsS0FBcEIsRUFBMkJHLElBQTNCLENBQVI7QUFDSCxPQUZNLE1BRUEsSUFBSU0sSUFBSSxLQUFLLFFBQVQsSUFBcUIsQ0FBQ1QsS0FBSyxDQUFDZSxlQUFoQyxFQUFpRDtBQUNwRCxjQUFNLElBQUl0QixlQUFKLENBQW9CLDBCQUFwQixFQUFnRDtBQUFFTyxVQUFBQSxLQUFLLEVBQUVNLEdBQVQ7QUFBY1UsVUFBQUEsS0FBSyxFQUFFZjtBQUFyQixTQUFoRCxDQUFOO0FBQ0g7QUFDSjs7QUFFRCxRQUFJLENBQUNELEtBQUssQ0FBQ2lCLE9BQVgsRUFBb0I7QUFDaEIsWUFBTSxJQUFJeEIsZUFBSixDQUFvQiwwQkFBcEIsRUFBZ0Q7QUFBRU8sUUFBQUEsS0FBSyxFQUFFTSxHQUFUO0FBQWNVLFFBQUFBLEtBQUssRUFBRWY7QUFBckIsT0FBaEQsQ0FBTjtBQUNIOztBQUVELFdBQU9ELEtBQVA7QUFDSCxHQXJDWTtBQXVDYmtCLEVBQUFBLFlBQVksRUFBRSxDQXZDRDtBQXlDYkMsRUFBQUEsUUFBUSxFQUFFLENBQUNsQixJQUFELEVBQU9DLElBQVAsS0FBZ0JBLElBQUksR0FBR0EsSUFBSSxDQUFDa0IsR0FBTCxFQUFILEdBQWdCN0IsUUFBUSxDQUFDOEIsS0FBVCxFQXpDakM7QUEyQ2JDLEVBQUFBLFNBQVMsRUFBRXRCLEtBQUssSUFBSTtBQUNoQixRQUFJQSxLQUFLLElBQUlBLEtBQUssQ0FBQ3VCLEtBQW5CLEVBQTBCO0FBQ3RCLGFBQU92QixLQUFLLENBQUN1QixLQUFOLENBQVk7QUFBRUMsUUFBQUEsYUFBYSxFQUFFO0FBQWpCLE9BQVosQ0FBUDtBQUNIOztBQUVELFdBQU94QixLQUFQO0FBQ0gsR0FqRFk7QUFtRGJ5QixFQUFBQSxVQUFVLEVBQUVqQyxHQUFHLENBQUNpQyxVQUFKLENBQWVDLE1BQWYsQ0FBc0IsQ0FDOUIsVUFEOEIsRUFFOUIsVUFGOEIsRUFHOUIsVUFIOEIsRUFJOUIsYUFKOEIsRUFLOUIsV0FMOEIsQ0FBdEI7QUFuREMsQ0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgXyA9IHJlcXVpcmUoJ3JrLXV0aWxzJykuXztcbmNvbnN0IHsgRGF0ZVRpbWUgfSA9IHJlcXVpcmUoJ2x1eG9uJyk7XG5jb25zdCBhbnkgPSByZXF1aXJlKCcuL2FueScpO1xuY29uc3QgeyBWYWxpZGF0aW9uRXJyb3IgfSA9IHJlcXVpcmUoJy4uL3V0aWxzL0Vycm9ycycpO1xuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgICBuYW1lOiAnZGF0ZXRpbWUnLFxuXG4gICAgdHlwZU9iamVjdDogRGF0ZVRpbWUsXG5cbiAgICBhbGlhczogWyAnZGF0ZScsICd0aW1lJywgJ3RpbWVzdGFtcCcgXSxcblxuICAgIHNhbml0aXplOiAodmFsdWUsIGluZm8sIGkxOG4pID0+IHsgICBcbiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHJldHVybiBudWxsO1xuICAgICAgICBcbiAgICAgICAgbGV0IG9wdHMgPSB7IHpvbmU6IGkxOG4/LnRpbWV6b25lIHx8ICdsb2NhbCcgfTtcblxuICAgICAgICBsZXQgcmF3ID0gdmFsdWU7XG5cbiAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgRGF0ZSkge1xuICAgICAgICAgICAgdmFsdWUgPSBEYXRlVGltZS5mcm9tSlNEYXRlKHZhbHVlLCBvcHRzKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxldCB0eXBlID0gdHlwZW9mIHZhbHVlO1xuICAgICAgICBcbiAgICAgICAgICAgIGlmICh0eXBlID09PSAnc3RyaW5nJyAmJiAhaW5mby5kb250UGFyc2UpIHtcbiAgICAgICAgICAgICAgICBpZiAoaW5mby5pbnB1dEZvcm1hdCkge1xuICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IERhdGVUaW1lLmZyb21Gb3JtYXQodmFsdWUsIGluZm8uaW5wdXRGb3JtYXQsIG9wdHMpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHZhbHVlID0gRGF0ZVRpbWUuZnJvbUlTTyh2YWx1ZSwgb3B0cyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnbnVtYmVyJykge1xuICAgICAgICAgICAgICAgIHZhbHVlID0gRGF0ZVRpbWUuZnJvbU1pbGxpcyh2YWx1ZSwgb3B0cyk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgIT09ICdvYmplY3QnIHx8ICF2YWx1ZS5pc0x1eG9uRGF0ZVRpbWUpIHsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcignSW52YWxpZCBkYXRldGltZSBvYmplY3QuJywgeyB2YWx1ZTogcmF3LCBmaWVsZDogaW5mbyB9KTtcbiAgICAgICAgICAgIH0gICAgICAgICAgICAgXG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGlmICghdmFsdWUuaXNWYWxpZCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcignSW52YWxpZCBkYXRldGltZSBvYmplY3QuJywgeyB2YWx1ZTogcmF3LCBmaWVsZDogaW5mbyB9KTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH0sXG5cbiAgICBkZWZhdWx0VmFsdWU6IDAsXG5cbiAgICBnZW5lcmF0ZTogKGluZm8sIGkxOG4pID0+IGkxOG4gPyBpMThuLm5vdygpIDogRGF0ZVRpbWUubG9jYWwoKSxcblxuICAgIHNlcmlhbGl6ZTogdmFsdWUgPT4ge1xuICAgICAgICBpZiAodmFsdWUgJiYgdmFsdWUudG9JU08pIHtcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZS50b0lTTyh7IGluY2x1ZGVPZmZzZXQ6IGZhbHNlIH0pOyBcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9LFxuXG4gICAgcXVhbGlmaWVyczogYW55LnF1YWxpZmllcnMuY29uY2F0KFtcbiAgICAgICAgJ3RpbWV6b25lJyxcbiAgICAgICAgJ2RhdGVPbmx5JyxcbiAgICAgICAgJ3RpbWVPbmx5JyxcbiAgICAgICAgJ2lucHV0Rm9ybWF0JyxcbiAgICAgICAgJ2RvbnRQYXJzZSdcbiAgICBdKVxufTsiXX0=