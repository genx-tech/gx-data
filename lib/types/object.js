"use strict";

require("source-map-support/register");

const _ = require('rk-utils')._;

const {
  isNothing
} = require('../utils/lang');

const {
  ValidationError
} = require('../utils/Errors');

const any = require('./any');

const jsonStarter = new Set('"', '[', '{');
module.exports = {
  name: 'object',
  alias: ['json'],
  sanitize: (value, info, i18n, prefix) => {
    let raw = value;
    let type = typeof value;

    if (type === 'string') {
      if (value.length === 0) {
        value = '';
      } else if (jsonStarter.has(value[0])) {
        value = JSON.parse(value);
      }
    } else if (type === 'boolean' || type === 'number') {} else if (type !== 'object') {
      throw new ValidationError('Invalid object value', {
        value: raw,
        feild: info
      });
    } else {
      value = _.toPlainObject(value);
    }

    if (info.schema) {
      const Validators = require('../Validators');

      return Validators.validateObjectBySchema(value, info.schema, i18n, prefix);
    }

    return value;
  },
  defaultValue: {},
  generate: (info, i18n) => ({}),
  serialize: value => isNothing(value) ? null : JSON.stringify(value),
  qualifiers: any.qualifiers.concat(['schema'])
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90eXBlcy9vYmplY3QuanMiXSwibmFtZXMiOlsiXyIsInJlcXVpcmUiLCJpc05vdGhpbmciLCJWYWxpZGF0aW9uRXJyb3IiLCJhbnkiLCJqc29uU3RhcnRlciIsIlNldCIsIm1vZHVsZSIsImV4cG9ydHMiLCJuYW1lIiwiYWxpYXMiLCJzYW5pdGl6ZSIsInZhbHVlIiwiaW5mbyIsImkxOG4iLCJwcmVmaXgiLCJyYXciLCJ0eXBlIiwibGVuZ3RoIiwiaGFzIiwiSlNPTiIsInBhcnNlIiwiZmVpbGQiLCJ0b1BsYWluT2JqZWN0Iiwic2NoZW1hIiwiVmFsaWRhdG9ycyIsInZhbGlkYXRlT2JqZWN0QnlTY2hlbWEiLCJkZWZhdWx0VmFsdWUiLCJnZW5lcmF0ZSIsInNlcmlhbGl6ZSIsInN0cmluZ2lmeSIsInF1YWxpZmllcnMiLCJjb25jYXQiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTUEsQ0FBQyxHQUFHQyxPQUFPLENBQUMsVUFBRCxDQUFQLENBQW9CRCxDQUE5Qjs7QUFDQSxNQUFNO0FBQUVFLEVBQUFBO0FBQUYsSUFBZ0JELE9BQU8sQ0FBQyxlQUFELENBQTdCOztBQUNBLE1BQU07QUFBRUUsRUFBQUE7QUFBRixJQUFzQkYsT0FBTyxDQUFDLGlCQUFELENBQW5DOztBQUNBLE1BQU1HLEdBQUcsR0FBR0gsT0FBTyxDQUFDLE9BQUQsQ0FBbkI7O0FBRUEsTUFBTUksV0FBVyxHQUFHLElBQUlDLEdBQUosQ0FBUSxHQUFSLEVBQWEsR0FBYixFQUFrQixHQUFsQixDQUFwQjtBQUVBQyxNQUFNLENBQUNDLE9BQVAsR0FBaUI7QUFDYkMsRUFBQUEsSUFBSSxFQUFFLFFBRE87QUFHYkMsRUFBQUEsS0FBSyxFQUFFLENBQUUsTUFBRixDQUhNO0FBS2JDLEVBQUFBLFFBQVEsRUFBRSxDQUFDQyxLQUFELEVBQVFDLElBQVIsRUFBY0MsSUFBZCxFQUFvQkMsTUFBcEIsS0FBK0I7QUFDckMsUUFBSUMsR0FBRyxHQUFHSixLQUFWO0FBQ0EsUUFBSUssSUFBSSxHQUFHLE9BQU9MLEtBQWxCOztBQUVBLFFBQUlLLElBQUksS0FBSyxRQUFiLEVBQXVCO0FBQ25CLFVBQUlMLEtBQUssQ0FBQ00sTUFBTixLQUFpQixDQUFyQixFQUF3QjtBQUNwQk4sUUFBQUEsS0FBSyxHQUFHLEVBQVI7QUFDSCxPQUZELE1BRU8sSUFBSVAsV0FBVyxDQUFDYyxHQUFaLENBQWdCUCxLQUFLLENBQUMsQ0FBRCxDQUFyQixDQUFKLEVBQStCO0FBQ2xDQSxRQUFBQSxLQUFLLEdBQUdRLElBQUksQ0FBQ0MsS0FBTCxDQUFXVCxLQUFYLENBQVI7QUFDSDtBQUNKLEtBTkQsTUFNTyxJQUFJSyxJQUFJLEtBQUssU0FBVCxJQUFzQkEsSUFBSSxLQUFLLFFBQW5DLEVBQTZDLENBRW5ELENBRk0sTUFFQSxJQUFJQSxJQUFJLEtBQUssUUFBYixFQUF1QjtBQUMxQixZQUFNLElBQUlkLGVBQUosQ0FBb0Isc0JBQXBCLEVBQTRDO0FBQUVTLFFBQUFBLEtBQUssRUFBRUksR0FBVDtBQUFjTSxRQUFBQSxLQUFLLEVBQUVUO0FBQXJCLE9BQTVDLENBQU47QUFDSCxLQUZNLE1BRUE7QUFDSEQsTUFBQUEsS0FBSyxHQUFHWixDQUFDLENBQUN1QixhQUFGLENBQWdCWCxLQUFoQixDQUFSO0FBQ0g7O0FBRUQsUUFBSUMsSUFBSSxDQUFDVyxNQUFULEVBQWlCO0FBQ2IsWUFBTUMsVUFBVSxHQUFHeEIsT0FBTyxDQUFDLGVBQUQsQ0FBMUI7O0FBQ0EsYUFBT3dCLFVBQVUsQ0FBQ0Msc0JBQVgsQ0FBa0NkLEtBQWxDLEVBQXlDQyxJQUFJLENBQUNXLE1BQTlDLEVBQXNEVixJQUF0RCxFQUE0REMsTUFBNUQsQ0FBUDtBQUNIOztBQUVELFdBQU9ILEtBQVA7QUFDSCxHQTdCWTtBQStCYmUsRUFBQUEsWUFBWSxFQUFFLEVBL0JEO0FBaUNiQyxFQUFBQSxRQUFRLEVBQUUsQ0FBQ2YsSUFBRCxFQUFPQyxJQUFQLE1BQWlCLEVBQWpCLENBakNHO0FBbUNiZSxFQUFBQSxTQUFTLEVBQUdqQixLQUFELElBQVdWLFNBQVMsQ0FBQ1UsS0FBRCxDQUFULEdBQW1CLElBQW5CLEdBQTBCUSxJQUFJLENBQUNVLFNBQUwsQ0FBZWxCLEtBQWYsQ0FuQ25DO0FBcUNibUIsRUFBQUEsVUFBVSxFQUFFM0IsR0FBRyxDQUFDMkIsVUFBSixDQUFlQyxNQUFmLENBQXNCLENBQzlCLFFBRDhCLENBQXRCO0FBckNDLENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IF8gPSByZXF1aXJlKCdyay11dGlscycpLl87XG5jb25zdCB7IGlzTm90aGluZyB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvbGFuZycpO1xuY29uc3QgeyBWYWxpZGF0aW9uRXJyb3IgfSA9IHJlcXVpcmUoJy4uL3V0aWxzL0Vycm9ycycpO1xuY29uc3QgYW55ID0gcmVxdWlyZSgnLi9hbnknKTtcblxuY29uc3QganNvblN0YXJ0ZXIgPSBuZXcgU2V0KCdcIicsICdbJywgJ3snKTtcblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gICAgbmFtZTogJ29iamVjdCcsXG5cbiAgICBhbGlhczogWyAnanNvbicgXSxcblxuICAgIHNhbml0aXplOiAodmFsdWUsIGluZm8sIGkxOG4sIHByZWZpeCkgPT4ge1xuICAgICAgICBsZXQgcmF3ID0gdmFsdWU7XG4gICAgICAgIGxldCB0eXBlID0gdHlwZW9mIHZhbHVlO1xuXG4gICAgICAgIGlmICh0eXBlID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgaWYgKHZhbHVlLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIHZhbHVlID0gJyc7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGpzb25TdGFydGVyLmhhcyh2YWx1ZVswXSkpIHtcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IEpTT04ucGFyc2UodmFsdWUpO1xuICAgICAgICAgICAgfSBcbiAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnYm9vbGVhbicgfHwgdHlwZSA9PT0gJ251bWJlcicpIHtcbiAgICAgICAgICAgIC8vc2tpcFxuICAgICAgICB9IGVsc2UgaWYgKHR5cGUgIT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKCdJbnZhbGlkIG9iamVjdCB2YWx1ZScsIHsgdmFsdWU6IHJhdywgZmVpbGQ6IGluZm8gfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB2YWx1ZSA9IF8udG9QbGFpbk9iamVjdCh2YWx1ZSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoaW5mby5zY2hlbWEpIHtcbiAgICAgICAgICAgIGNvbnN0IFZhbGlkYXRvcnMgPSByZXF1aXJlKCcuLi9WYWxpZGF0b3JzJyk7XG4gICAgICAgICAgICByZXR1cm4gVmFsaWRhdG9ycy52YWxpZGF0ZU9iamVjdEJ5U2NoZW1hKHZhbHVlLCBpbmZvLnNjaGVtYSwgaTE4biwgcHJlZml4KTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH0sXG5cbiAgICBkZWZhdWx0VmFsdWU6IHt9LFxuXG4gICAgZ2VuZXJhdGU6IChpbmZvLCBpMThuKSA9PiAoe30pLFxuXG4gICAgc2VyaWFsaXplOiAodmFsdWUpID0+IGlzTm90aGluZyh2YWx1ZSkgPyBudWxsIDogSlNPTi5zdHJpbmdpZnkodmFsdWUpLFxuXG4gICAgcXVhbGlmaWVyczogYW55LnF1YWxpZmllcnMuY29uY2F0KFtcbiAgICAgICAgJ3NjaGVtYSdcbiAgICBdKVxufTsiXX0=