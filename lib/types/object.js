"use strict";

require("source-map-support/register");

const {
  _
} = require('@genx/july');

const {
  isNothing
} = require('../utils/lang');

const {
  ValidationError
} = require('../utils/Errors');

const any = require('./any');

const jsonStarter = new Set('"', '[', '{');
const jsonEnding = {
  '"': '"',
  '[': ']',
  '{': '}'
};
module.exports = {
  name: 'object',
  alias: ['json'],
  sanitize: (value, info, i18n, prefix) => {
    if (value == null) return null;
    let raw = value;
    let type = typeof value;

    switch (type) {
      case 'string':
        if (!info.dontParse && value.length > 0 && jsonStarter.has(value[0]) && jsonEnding[value[0]] === value[value.length - 1]) {
          value = JSON.parse(value);
        }

        break;

      case 'boolean':
      case 'number':
      case 'bigint':
        break;

      case 'object':
        if (!Array.isArray(value)) {
          value = _.toPlainObject(value);
        }

        break;

      default:
        throw new ValidationError('Invalid object value', {
          value: raw,
          feild: info
        });
    }

    if (info.schema) {
      const Validators = require('../Validators');

      return Validators.validateObjectBySchema(value, info.schema, i18n, prefix);
    }

    return value;
  },
  defaultValue: {},
  generate: (info, i18n) => ({}),
  serialize: value => isNothing(value) ? null : JSON.stringify(value),
  qualifiers: any.qualifiers.concat(['schema'])
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90eXBlcy9vYmplY3QuanMiXSwibmFtZXMiOlsiXyIsInJlcXVpcmUiLCJpc05vdGhpbmciLCJWYWxpZGF0aW9uRXJyb3IiLCJhbnkiLCJqc29uU3RhcnRlciIsIlNldCIsImpzb25FbmRpbmciLCJtb2R1bGUiLCJleHBvcnRzIiwibmFtZSIsImFsaWFzIiwic2FuaXRpemUiLCJ2YWx1ZSIsImluZm8iLCJpMThuIiwicHJlZml4IiwicmF3IiwidHlwZSIsImRvbnRQYXJzZSIsImxlbmd0aCIsImhhcyIsIkpTT04iLCJwYXJzZSIsIkFycmF5IiwiaXNBcnJheSIsInRvUGxhaW5PYmplY3QiLCJmZWlsZCIsInNjaGVtYSIsIlZhbGlkYXRvcnMiLCJ2YWxpZGF0ZU9iamVjdEJ5U2NoZW1hIiwiZGVmYXVsdFZhbHVlIiwiZ2VuZXJhdGUiLCJzZXJpYWxpemUiLCJzdHJpbmdpZnkiLCJxdWFsaWZpZXJzIiwiY29uY2F0Il0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU07QUFBRUEsRUFBQUE7QUFBRixJQUFRQyxPQUFPLENBQUMsWUFBRCxDQUFyQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBO0FBQUYsSUFBZ0JELE9BQU8sQ0FBQyxlQUFELENBQTdCOztBQUNBLE1BQU07QUFBRUUsRUFBQUE7QUFBRixJQUFzQkYsT0FBTyxDQUFDLGlCQUFELENBQW5DOztBQUNBLE1BQU1HLEdBQUcsR0FBR0gsT0FBTyxDQUFDLE9BQUQsQ0FBbkI7O0FBRUEsTUFBTUksV0FBVyxHQUFHLElBQUlDLEdBQUosQ0FBUSxHQUFSLEVBQWEsR0FBYixFQUFrQixHQUFsQixDQUFwQjtBQUNBLE1BQU1DLFVBQVUsR0FBRztBQUNmLE9BQUssR0FEVTtBQUVmLE9BQUssR0FGVTtBQUdmLE9BQUs7QUFIVSxDQUFuQjtBQVNBQyxNQUFNLENBQUNDLE9BQVAsR0FBaUI7QUFDYkMsRUFBQUEsSUFBSSxFQUFFLFFBRE87QUFHYkMsRUFBQUEsS0FBSyxFQUFFLENBQUUsTUFBRixDQUhNO0FBS2JDLEVBQUFBLFFBQVEsRUFBRSxDQUFDQyxLQUFELEVBQVFDLElBQVIsRUFBY0MsSUFBZCxFQUFvQkMsTUFBcEIsS0FBK0I7QUFDckMsUUFBSUgsS0FBSyxJQUFJLElBQWIsRUFBbUIsT0FBTyxJQUFQO0FBRW5CLFFBQUlJLEdBQUcsR0FBR0osS0FBVjtBQUNBLFFBQUlLLElBQUksR0FBRyxPQUFPTCxLQUFsQjs7QUFFQSxZQUFRSyxJQUFSO0FBQ0ksV0FBSyxRQUFMO0FBQ0ksWUFBSSxDQUFDSixJQUFJLENBQUNLLFNBQU4sSUFBbUJOLEtBQUssQ0FBQ08sTUFBTixHQUFlLENBQWxDLElBQXVDZixXQUFXLENBQUNnQixHQUFaLENBQWdCUixLQUFLLENBQUMsQ0FBRCxDQUFyQixDQUF2QyxJQUFvRU4sVUFBVSxDQUFDTSxLQUFLLENBQUMsQ0FBRCxDQUFOLENBQVYsS0FBeUJBLEtBQUssQ0FBQ0EsS0FBSyxDQUFDTyxNQUFOLEdBQWEsQ0FBZCxDQUF0RyxFQUF3SDtBQUNwSFAsVUFBQUEsS0FBSyxHQUFHUyxJQUFJLENBQUNDLEtBQUwsQ0FBV1YsS0FBWCxDQUFSO0FBQ0g7O0FBQ0Q7O0FBRUosV0FBSyxTQUFMO0FBQ0EsV0FBSyxRQUFMO0FBQ0EsV0FBSyxRQUFMO0FBRUk7O0FBRUosV0FBSyxRQUFMO0FBQ0ksWUFBSSxDQUFDVyxLQUFLLENBQUNDLE9BQU4sQ0FBY1osS0FBZCxDQUFMLEVBQTJCO0FBQ3ZCQSxVQUFBQSxLQUFLLEdBQUdiLENBQUMsQ0FBQzBCLGFBQUYsQ0FBZ0JiLEtBQWhCLENBQVI7QUFDSDs7QUFDRDs7QUFFSjtBQUNJLGNBQU0sSUFBSVYsZUFBSixDQUFvQixzQkFBcEIsRUFBNEM7QUFBRVUsVUFBQUEsS0FBSyxFQUFFSSxHQUFUO0FBQWNVLFVBQUFBLEtBQUssRUFBRWI7QUFBckIsU0FBNUMsQ0FBTjtBQXBCUjs7QUF1QkEsUUFBSUEsSUFBSSxDQUFDYyxNQUFULEVBQWlCO0FBQ2IsWUFBTUMsVUFBVSxHQUFHNUIsT0FBTyxDQUFDLGVBQUQsQ0FBMUI7O0FBQ0EsYUFBTzRCLFVBQVUsQ0FBQ0Msc0JBQVgsQ0FBa0NqQixLQUFsQyxFQUF5Q0MsSUFBSSxDQUFDYyxNQUE5QyxFQUFzRGIsSUFBdEQsRUFBNERDLE1BQTVELENBQVA7QUFDSDs7QUFFRCxXQUFPSCxLQUFQO0FBQ0gsR0F4Q1k7QUEwQ2JrQixFQUFBQSxZQUFZLEVBQUUsRUExQ0Q7QUE0Q2JDLEVBQUFBLFFBQVEsRUFBRSxDQUFDbEIsSUFBRCxFQUFPQyxJQUFQLE1BQWlCLEVBQWpCLENBNUNHO0FBOENia0IsRUFBQUEsU0FBUyxFQUFHcEIsS0FBRCxJQUFXWCxTQUFTLENBQUNXLEtBQUQsQ0FBVCxHQUFtQixJQUFuQixHQUEwQlMsSUFBSSxDQUFDWSxTQUFMLENBQWVyQixLQUFmLENBOUNuQztBQWdEYnNCLEVBQUFBLFVBQVUsRUFBRS9CLEdBQUcsQ0FBQytCLFVBQUosQ0FBZUMsTUFBZixDQUFzQixDQUM5QixRQUQ4QixDQUF0QjtBQWhEQyxDQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCB7IF8gfSA9IHJlcXVpcmUoJ0BnZW54L2p1bHknKTtcbmNvbnN0IHsgaXNOb3RoaW5nIH0gPSByZXF1aXJlKCcuLi91dGlscy9sYW5nJyk7XG5jb25zdCB7IFZhbGlkYXRpb25FcnJvciB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvRXJyb3JzJyk7XG5jb25zdCBhbnkgPSByZXF1aXJlKCcuL2FueScpO1xuXG5jb25zdCBqc29uU3RhcnRlciA9IG5ldyBTZXQoJ1wiJywgJ1snLCAneycpO1xuY29uc3QganNvbkVuZGluZyA9IHtcbiAgICAnXCInOiAnXCInLCBcbiAgICAnWyc6ICddJywgXG4gICAgJ3snOiAnfSdcbn07XG5cbi8vIGluZm8uZG9udFBhcnNlXG4vLyBpbmZvLnNjaGVtYVxuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgICBuYW1lOiAnb2JqZWN0JyxcblxuICAgIGFsaWFzOiBbICdqc29uJyBdLFxuXG4gICAgc2FuaXRpemU6ICh2YWx1ZSwgaW5mbywgaTE4biwgcHJlZml4KSA9PiB7XG4gICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSByZXR1cm4gbnVsbDtcblxuICAgICAgICBsZXQgcmF3ID0gdmFsdWU7XG4gICAgICAgIGxldCB0eXBlID0gdHlwZW9mIHZhbHVlO1xuXG4gICAgICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgICAgICAgY2FzZSAnc3RyaW5nJzpcbiAgICAgICAgICAgICAgICBpZiAoIWluZm8uZG9udFBhcnNlICYmIHZhbHVlLmxlbmd0aCA+IDAgJiYganNvblN0YXJ0ZXIuaGFzKHZhbHVlWzBdKSAmJiBqc29uRW5kaW5nW3ZhbHVlWzBdXSA9PT0gdmFsdWVbdmFsdWUubGVuZ3RoLTFdKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhbHVlID0gSlNPTi5wYXJzZSh2YWx1ZSk7XG4gICAgICAgICAgICAgICAgfSBcbiAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgY2FzZSAnYm9vbGVhbic6XG4gICAgICAgICAgICBjYXNlICdudW1iZXInOiAgICAgICAgICAgIFxuICAgICAgICAgICAgY2FzZSAnYmlnaW50JzpcbiAgICAgICAgICAgICAgICAvL3NraXAsIGtlZXAgb3JpZ2luYWwgdmFsdWVcbiAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgY2FzZSAnb2JqZWN0JzpcbiAgICAgICAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkodmFsdWUpKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhbHVlID0gXy50b1BsYWluT2JqZWN0KHZhbHVlKTtcbiAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoJ0ludmFsaWQgb2JqZWN0IHZhbHVlJywgeyB2YWx1ZTogcmF3LCBmZWlsZDogaW5mbyB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChpbmZvLnNjaGVtYSkge1xuICAgICAgICAgICAgY29uc3QgVmFsaWRhdG9ycyA9IHJlcXVpcmUoJy4uL1ZhbGlkYXRvcnMnKTtcbiAgICAgICAgICAgIHJldHVybiBWYWxpZGF0b3JzLnZhbGlkYXRlT2JqZWN0QnlTY2hlbWEodmFsdWUsIGluZm8uc2NoZW1hLCBpMThuLCBwcmVmaXgpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gdmFsdWU7XG4gICAgfSxcblxuICAgIGRlZmF1bHRWYWx1ZToge30sXG5cbiAgICBnZW5lcmF0ZTogKGluZm8sIGkxOG4pID0+ICh7fSksXG5cbiAgICBzZXJpYWxpemU6ICh2YWx1ZSkgPT4gaXNOb3RoaW5nKHZhbHVlKSA/IG51bGwgOiBKU09OLnN0cmluZ2lmeSh2YWx1ZSksXG5cbiAgICBxdWFsaWZpZXJzOiBhbnkucXVhbGlmaWVycy5jb25jYXQoW1xuICAgICAgICAnc2NoZW1hJ1xuICAgIF0pXG59OyJdfQ==