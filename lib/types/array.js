"use strict";

require("source-map-support/register");

const {
  _,
  quote
} = require('rk-utils');

const {
  isNothing
} = require('../utils/lang');

const any = require('./any');

const {
  ValidationError
} = require('../utils/Errors');

function sanitize(value, info, i18n, prefix) {
  let raw = value;

  if (typeof value === 'string') {
    if (info.csv) {
      return value;
    } else {
      let trimmed = value.trim();

      if (trimmed.startsWith('[') && trimmed.endsWith(']')) {
        value = sanitize(JSON.parse(trimmed), info, i18n, prefix);
      }
    }
  }

  if (Array.isArray(value)) {
    if (info.elementSchema) {
      const Validators = require('../Validators');

      return value.map((a, i) => Validators.validateAny(a, info.elementSchema, i18n, prefix + `[${i}]`));
    }

    return value;
  }

  throw new ValidationError('Invalid array value', {
    value: raw,
    field: info
  });
}

module.exports = {
  name: 'array',
  alias: ['list'],
  sanitize: sanitize,
  defaultValue: [],
  generate: (info, i18n) => [],
  serialize: value => isNothing(value) ? null : JSON.stringify(value),
  qualifiers: any.qualifiers.concat(['csv', 'of', 'elementSchema']),
  toCsv: (data, separator = ',') => data.map(elem => {
    elem = elem.toString();
    return elem.indexOf(separator) != -1 ? quote(elem, '"') : elem;
  }).join(separator)
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90eXBlcy9hcnJheS5qcyJdLCJuYW1lcyI6WyJfIiwicXVvdGUiLCJyZXF1aXJlIiwiaXNOb3RoaW5nIiwiYW55IiwiVmFsaWRhdGlvbkVycm9yIiwic2FuaXRpemUiLCJ2YWx1ZSIsImluZm8iLCJpMThuIiwicHJlZml4IiwicmF3IiwiY3N2IiwidHJpbW1lZCIsInRyaW0iLCJzdGFydHNXaXRoIiwiZW5kc1dpdGgiLCJKU09OIiwicGFyc2UiLCJBcnJheSIsImlzQXJyYXkiLCJlbGVtZW50U2NoZW1hIiwiVmFsaWRhdG9ycyIsIm1hcCIsImEiLCJpIiwidmFsaWRhdGVBbnkiLCJmaWVsZCIsIm1vZHVsZSIsImV4cG9ydHMiLCJuYW1lIiwiYWxpYXMiLCJkZWZhdWx0VmFsdWUiLCJnZW5lcmF0ZSIsInNlcmlhbGl6ZSIsInN0cmluZ2lmeSIsInF1YWxpZmllcnMiLCJjb25jYXQiLCJ0b0NzdiIsImRhdGEiLCJzZXBhcmF0b3IiLCJlbGVtIiwidG9TdHJpbmciLCJpbmRleE9mIiwiam9pbiJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNO0FBQUVBLEVBQUFBLENBQUY7QUFBS0MsRUFBQUE7QUFBTCxJQUFlQyxPQUFPLENBQUMsVUFBRCxDQUE1Qjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBO0FBQUYsSUFBZ0JELE9BQU8sQ0FBQyxlQUFELENBQTdCOztBQUNBLE1BQU1FLEdBQUcsR0FBR0YsT0FBTyxDQUFDLE9BQUQsQ0FBbkI7O0FBQ0EsTUFBTTtBQUFFRyxFQUFBQTtBQUFGLElBQXNCSCxPQUFPLENBQUMsaUJBQUQsQ0FBbkM7O0FBRUEsU0FBU0ksUUFBVCxDQUFrQkMsS0FBbEIsRUFBeUJDLElBQXpCLEVBQStCQyxJQUEvQixFQUFxQ0MsTUFBckMsRUFBNkM7QUFDekMsTUFBSUMsR0FBRyxHQUFHSixLQUFWOztBQUVBLE1BQUksT0FBT0EsS0FBUCxLQUFpQixRQUFyQixFQUErQjtBQUMzQixRQUFJQyxJQUFJLENBQUNJLEdBQVQsRUFBYztBQUNWLGFBQU9MLEtBQVA7QUFDSCxLQUZELE1BRU87QUFDSCxVQUFJTSxPQUFPLEdBQUdOLEtBQUssQ0FBQ08sSUFBTixFQUFkOztBQUNBLFVBQUlELE9BQU8sQ0FBQ0UsVUFBUixDQUFtQixHQUFuQixLQUEyQkYsT0FBTyxDQUFDRyxRQUFSLENBQWlCLEdBQWpCLENBQS9CLEVBQXNEO0FBQ2xEVCxRQUFBQSxLQUFLLEdBQUdELFFBQVEsQ0FBQ1csSUFBSSxDQUFDQyxLQUFMLENBQVdMLE9BQVgsQ0FBRCxFQUFzQkwsSUFBdEIsRUFBNEJDLElBQTVCLEVBQWtDQyxNQUFsQyxDQUFoQjtBQUNIO0FBQ0o7QUFDSjs7QUFFRCxNQUFJUyxLQUFLLENBQUNDLE9BQU4sQ0FBY2IsS0FBZCxDQUFKLEVBQTBCO0FBQ3RCLFFBQUlDLElBQUksQ0FBQ2EsYUFBVCxFQUF3QjtBQUNwQixZQUFNQyxVQUFVLEdBQUdwQixPQUFPLENBQUMsZUFBRCxDQUExQjs7QUFDQSxhQUFPSyxLQUFLLENBQUNnQixHQUFOLENBQVUsQ0FBQ0MsQ0FBRCxFQUFJQyxDQUFKLEtBQVVILFVBQVUsQ0FBQ0ksV0FBWCxDQUF1QkYsQ0FBdkIsRUFBMEJoQixJQUFJLENBQUNhLGFBQS9CLEVBQThDWixJQUE5QyxFQUFvREMsTUFBTSxHQUFJLElBQUdlLENBQUUsR0FBbkUsQ0FBcEIsQ0FBUDtBQUNIOztBQUVELFdBQU9sQixLQUFQO0FBQ0g7O0FBRUQsUUFBTSxJQUFJRixlQUFKLENBQW9CLHFCQUFwQixFQUEyQztBQUFFRSxJQUFBQSxLQUFLLEVBQUVJLEdBQVQ7QUFBY2dCLElBQUFBLEtBQUssRUFBRW5CO0FBQXJCLEdBQTNDLENBQU47QUFDSDs7QUFFRG9CLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjtBQUNiQyxFQUFBQSxJQUFJLEVBQUUsT0FETztBQUdiQyxFQUFBQSxLQUFLLEVBQUUsQ0FBRSxNQUFGLENBSE07QUFLYnpCLEVBQUFBLFFBQVEsRUFBRUEsUUFMRztBQU9iMEIsRUFBQUEsWUFBWSxFQUFFLEVBUEQ7QUFTYkMsRUFBQUEsUUFBUSxFQUFFLENBQUN6QixJQUFELEVBQU9DLElBQVAsS0FBaUIsRUFUZDtBQVlieUIsRUFBQUEsU0FBUyxFQUFHM0IsS0FBRCxJQUFXSixTQUFTLENBQUNJLEtBQUQsQ0FBVCxHQUFtQixJQUFuQixHQUEyQlUsSUFBSSxDQUFDa0IsU0FBTCxDQUFlNUIsS0FBZixDQVpwQztBQWNiNkIsRUFBQUEsVUFBVSxFQUFFaEMsR0FBRyxDQUFDZ0MsVUFBSixDQUFlQyxNQUFmLENBQXNCLENBQzlCLEtBRDhCLEVBRTlCLElBRjhCLEVBRzlCLGVBSDhCLENBQXRCLENBZEM7QUFvQmJDLEVBQUFBLEtBQUssRUFBRSxDQUFDQyxJQUFELEVBQU9DLFNBQVMsR0FBRyxHQUFuQixLQUEyQkQsSUFBSSxDQUFDaEIsR0FBTCxDQUM5QmtCLElBQUksSUFBSTtBQUFFQSxJQUFBQSxJQUFJLEdBQUdBLElBQUksQ0FBQ0MsUUFBTCxFQUFQO0FBQXdCLFdBQU9ELElBQUksQ0FBQ0UsT0FBTCxDQUFhSCxTQUFiLEtBQTJCLENBQUMsQ0FBNUIsR0FBZ0N2QyxLQUFLLENBQUN3QyxJQUFELEVBQU8sR0FBUCxDQUFyQyxHQUFtREEsSUFBMUQ7QUFBaUUsR0FEckUsRUFFNUJHLElBRjRCLENBRXZCSixTQUZ1QjtBQXBCckIsQ0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgeyBfLCBxdW90ZSB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgaXNOb3RoaW5nIH0gPSByZXF1aXJlKCcuLi91dGlscy9sYW5nJyk7XG5jb25zdCBhbnkgPSByZXF1aXJlKCcuL2FueScpO1xuY29uc3QgeyBWYWxpZGF0aW9uRXJyb3IgfSA9IHJlcXVpcmUoJy4uL3V0aWxzL0Vycm9ycycpO1xuXG5mdW5jdGlvbiBzYW5pdGl6ZSh2YWx1ZSwgaW5mbywgaTE4biwgcHJlZml4KSB7XG4gICAgbGV0IHJhdyA9IHZhbHVlO1xuXG4gICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgaWYgKGluZm8uY3N2KSB7XG4gICAgICAgICAgICByZXR1cm4gdmFsdWU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsZXQgdHJpbW1lZCA9IHZhbHVlLnRyaW0oKTtcbiAgICAgICAgICAgIGlmICh0cmltbWVkLnN0YXJ0c1dpdGgoJ1snKSAmJiB0cmltbWVkLmVuZHNXaXRoKCddJykpIHtcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IHNhbml0aXplKEpTT04ucGFyc2UodHJpbW1lZCksIGluZm8sIGkxOG4sIHByZWZpeCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgICAgaWYgKGluZm8uZWxlbWVudFNjaGVtYSkge1xuICAgICAgICAgICAgY29uc3QgVmFsaWRhdG9ycyA9IHJlcXVpcmUoJy4uL1ZhbGlkYXRvcnMnKTtcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZS5tYXAoKGEsIGkpID0+IFZhbGlkYXRvcnMudmFsaWRhdGVBbnkoYSwgaW5mby5lbGVtZW50U2NoZW1hLCBpMThuLCBwcmVmaXggKyBgWyR7aX1dYCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH0gICAgXG5cbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKCdJbnZhbGlkIGFycmF5IHZhbHVlJywgeyB2YWx1ZTogcmF3LCBmaWVsZDogaW5mbyB9KTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gICAgbmFtZTogJ2FycmF5JyxcblxuICAgIGFsaWFzOiBbICdsaXN0JyBdLFxuXG4gICAgc2FuaXRpemU6IHNhbml0aXplLFxuXG4gICAgZGVmYXVsdFZhbHVlOiBbXSxcblxuICAgIGdlbmVyYXRlOiAoaW5mbywgaTE4bikgPT4gKFtdKSxcblxuICAgIC8vd2hlbiBpdCdzIGNzdiwgc2hvdWxkIGNhbGwgdG9Dc3YgaW4gZHJpdmVyIHNwZWNpZmljIEVudGl0eU1vZGVsXG4gICAgc2VyaWFsaXplOiAodmFsdWUpID0+IGlzTm90aGluZyh2YWx1ZSkgPyBudWxsIDogIEpTT04uc3RyaW5naWZ5KHZhbHVlKSxcblxuICAgIHF1YWxpZmllcnM6IGFueS5xdWFsaWZpZXJzLmNvbmNhdChbXG4gICAgICAgICdjc3YnLFxuICAgICAgICAnb2YnLFxuICAgICAgICAnZWxlbWVudFNjaGVtYSdcbiAgICBdKSxcblxuICAgIHRvQ3N2OiAoZGF0YSwgc2VwYXJhdG9yID0gJywnKSA9PiBkYXRhLm1hcChcbiAgICAgICAgZWxlbSA9PiB7IGVsZW0gPSBlbGVtLnRvU3RyaW5nKCk7IHJldHVybiBlbGVtLmluZGV4T2Yoc2VwYXJhdG9yKSAhPSAtMSA/IHF1b3RlKGVsZW0sICdcIicpIDogZWxlbTsgfVxuICAgICAgICApLmpvaW4oc2VwYXJhdG9yKVxufTsiXX0=