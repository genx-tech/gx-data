"use strict";

require("source-map-support/register");

const {
  URL
} = require('url');

const {
  _
} = require('@genx/july');

const {
  SupportedDrivers
} = require('./utils/lang');

class Connector {
  static createConnector(driver, connectionString, options) {
    if (SupportedDrivers.indexOf(driver) === -1) {
      throw new Error(`Unsupported connector driver: "${driver}"!`);
    }

    if (!connectionString) {
      throw new Error(`Missing required connection string`);
    }

    let ConnectorClass = require(`./drivers/${driver}/Connector`);

    return new ConnectorClass(connectionString, options);
  }

  constructor(driver, connectionString, options) {
    this.driver = driver;
    this.connectionString = connectionString;
    this.options = options || {};
    this.relational = false;
    this._mapOfConnectionToId = new WeakMap();
  }

  makeNewConnectionString(components) {
    let url = new URL(this.connectionString);

    if (components.hasOwnProperty('username')) {
      url.username = components['username'];
    }

    if (components.hasOwnProperty('password')) {
      url.password = components['password'];
    }

    if (components.hasOwnProperty('database')) {
      url.pathname = '/' + components['database'];
    }

    if (components.hasOwnProperty('options')) {
      let options = components.options;

      _.forOwn(options, (value, key) => {
        url.searchParams.set(key, typeof value === 'boolean' ? value ? 1 : 0 : value);
      });
    }

    return url.href;
  }

  getConnectionStringWithoutCredential() {
    let url = new URL(this.connectionString);
    url.username = '';
    url.password = '';
    return url.href;
  }

  get database() {
    if (!this._database) {
      this._database = new URL(this.connectionString).pathname.substr(1);
    }

    return this._database;
  }

  get driverLib() {
    return this.constructor.driverLib;
  }

  log(...args) {
    if (this.options.logger) {
      this.options.logger.log(...args);
    }
  }

}

module.exports = Connector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Db25uZWN0b3IuanMiXSwibmFtZXMiOlsiVVJMIiwicmVxdWlyZSIsIl8iLCJTdXBwb3J0ZWREcml2ZXJzIiwiQ29ubmVjdG9yIiwiY3JlYXRlQ29ubmVjdG9yIiwiZHJpdmVyIiwiY29ubmVjdGlvblN0cmluZyIsIm9wdGlvbnMiLCJpbmRleE9mIiwiRXJyb3IiLCJDb25uZWN0b3JDbGFzcyIsImNvbnN0cnVjdG9yIiwicmVsYXRpb25hbCIsIl9tYXBPZkNvbm5lY3Rpb25Ub0lkIiwiV2Vha01hcCIsIm1ha2VOZXdDb25uZWN0aW9uU3RyaW5nIiwiY29tcG9uZW50cyIsInVybCIsImhhc093blByb3BlcnR5IiwidXNlcm5hbWUiLCJwYXNzd29yZCIsInBhdGhuYW1lIiwiZm9yT3duIiwidmFsdWUiLCJrZXkiLCJzZWFyY2hQYXJhbXMiLCJzZXQiLCJocmVmIiwiZ2V0Q29ubmVjdGlvblN0cmluZ1dpdGhvdXRDcmVkZW50aWFsIiwiZGF0YWJhc2UiLCJfZGF0YWJhc2UiLCJzdWJzdHIiLCJkcml2ZXJMaWIiLCJsb2ciLCJhcmdzIiwibG9nZ2VyIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNO0FBQUVBLEVBQUFBO0FBQUYsSUFBVUMsT0FBTyxDQUFDLEtBQUQsQ0FBdkI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQTtBQUFGLElBQVFELE9BQU8sQ0FBQyxZQUFELENBQXJCOztBQUNBLE1BQU07QUFBRUUsRUFBQUE7QUFBRixJQUF1QkYsT0FBTyxDQUFDLGNBQUQsQ0FBcEM7O0FBTUEsTUFBTUcsU0FBTixDQUFnQjtBQU9aLFNBQU9DLGVBQVAsQ0FBdUJDLE1BQXZCLEVBQStCQyxnQkFBL0IsRUFBaURDLE9BQWpELEVBQTBEO0FBQ3RELFFBQUlMLGdCQUFnQixDQUFDTSxPQUFqQixDQUF5QkgsTUFBekIsTUFBcUMsQ0FBQyxDQUExQyxFQUE2QztBQUN6QyxZQUFNLElBQUlJLEtBQUosQ0FBVyxrQ0FBaUNK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Q0g7QUFDSjs7QUF0SVc7O0FBeUpoQkUsTUFBTSxDQUFDQyxPQUFQLEdBQWlCbEMsU0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgeyBVUkwgfSA9IHJlcXVpcmUoJ3VybCcpO1xuY29uc3QgeyBfIH0gPSByZXF1aXJlKCdAZ2VueC9qdWx5Jyk7XG5jb25zdCB7IFN1cHBvcnRlZERyaXZlcnMgfSA9IHJlcXVpcmUoJy4vdXRpbHMvbGFuZycpO1xuXG4vKipcbiAqIEEgZGF0YWJhc2Ugc3RvcmFnZSBjb25uZWN0b3Igb2JqZWN0LlxuICogQGNsYXNzXG4gKi9cbmNsYXNzIENvbm5lY3RvciB7XG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgY29ubmVjdG9yLlxuICAgICAqIEBwYXJhbSB7Kn0gZHJpdmVyIFxuICAgICAqIEBwYXJhbSB7Kn0gY29ubmVjdGlvblN0cmluZyBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgc3RhdGljIGNyZWF0ZUNvbm5lY3Rvcihkcml2ZXIsIGNvbm5lY3Rpb25TdHJpbmcsIG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKFN1cHBvcnRlZERyaXZlcnMuaW5kZXhPZihkcml2ZXIpID09PSAtMSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbnN1cHBvcnRlZCBjb25uZWN0b3IgZHJpdmVyOiBcIiR7ZHJpdmVyfVwiIWApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFjb25uZWN0aW9uU3RyaW5nKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE1pc3NpbmcgcmVxdWlyZWQgY29ubmVjdGlvbiBzdHJpbmdgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBDb25uZWN0b3JDbGFzcyA9IHJlcXVpcmUoYC4vZHJpdmVycy8ke2RyaXZlcn0vQ29ubmVjdG9yYCk7XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gbmV3IENvbm5lY3RvckNsYXNzKGNvbm5lY3Rpb25TdHJpbmcsIG9wdGlvbnMpO1xuICAgIH1cblxuICAgIC8qKiAgICAgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGRyaXZlciAtIERhdGEgc3RvcmFnZSB0eXBlXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGNvbm5lY3Rpb25TdHJpbmcgLSBUaGUgY29ubmVjdGlvbiBzdHJpbmdcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gW29wdGlvbnNdIC0gQ29ubmVjdG9yIG9wdGlvbnNcbiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IFtvcHRpb25zLmxvZ2dlcl0gLSBMb2dnZXIgaW5zdGFuY2UgXG4gICAgICovXG4gICAgY29uc3RydWN0b3IoZHJpdmVyLCBjb25uZWN0aW9uU3RyaW5nLCBvcHRpb25zKSB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBUaGUgZGF0YWJhc2Ugc3RvcmFnZSB0eXBlLCBlLmcuIG15c3FsLCBtb25nb2RiXG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuZHJpdmVyID0gZHJpdmVyO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBUaGUgZGVmYXVsdCBVUkwgc3R5bGUgY29ubmVjdGlvbiBzdHJpbmcsIGUuZy4gbXlzcWw6Ly91c2VybmFtZTpwYXNzd29yZEBob3N0OnBvcnQvZGJuYW1lXG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuY29ubmVjdGlvblN0cmluZyA9IGNvbm5lY3Rpb25TdHJpbmc7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIENvbm5lY3RvciBvcHRpb25zXG4gICAgICAgICAqIEBtZW1iZXIge29iamVjdH1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge307ICAgICAgXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIElzIHRoZSBkYXRhYmFzZSBhIHJlbGF0aW9uYWwgZGF0YWJhc2VcbiAgICAgICAgICogQG1lbWJlciB7Ym9vbGVhbn1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMucmVsYXRpb25hbCA9IGZhbHNlO1xuICAgICAgICBcbiAgICAgICAgLyoqXG4gICAgICAgICAqIE1hcCBvZiBjb25uZWN0aW9uIG9iamVjdCB0byB1bmlxdWUgaWQsIGZvciB0cmFjaW5nIHB1cnBvc2VcbiAgICAgICAgICogQHByaXZhdGVcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuX21hcE9mQ29ubmVjdGlvblRvSWQgPSBuZXcgV2Vha01hcCgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIE1ha2UgYSBuZXcgY29ubmVjdGlvbiBjb21wb25lbnRzIGZyb20gY3VycmVudCBjb25uZWN0aW9uIHN0cmluZyBhbmQgZ2l2ZW4gY29tcG9uZW50cy5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gY29tcG9uZW50cyBcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW2NvbXBvbmVudHMudXNlcm5hbWVdXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtjb21wb25lbnRzLnBhc3N3b3JkXVxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbY29tcG9uZW50cy5kYXRhYmFzZV1cbiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gW2NvbXBvbmVudHMub3B0aW9uc11cbiAgICAgKi9cbiAgICBtYWtlTmV3Q29ubmVjdGlvblN0cmluZyhjb21wb25lbnRzKSB7XG4gICAgICAgIGxldCB1cmwgPSBuZXcgVVJMKHRoaXMuY29ubmVjdGlvblN0cmluZyk7XG5cbiAgICAgICAgaWYgKGNvbXBvbmVudHMuaGFzT3duUHJvcGVydHkoJ3VzZXJuYW1lJykpIHtcbiAgICAgICAgICAgIHVybC51c2VybmFtZSA9IGNvbXBvbmVudHNbJ3VzZXJuYW1lJ107XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY29tcG9uZW50cy5oYXNPd25Qcm9wZXJ0eSgncGFzc3dvcmQnKSkge1xuICAgICAgICAgICAgdXJsLnBhc3N3b3JkID0gY29tcG9uZW50c1sncGFzc3dvcmQnXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjb21wb25lbnRzLmhhc093blByb3BlcnR5KCdkYXRhYmFzZScpKSB7XG4gICAgICAgICAgICB1cmwucGF0aG5hbWUgPSAnLycgKyBjb21wb25lbnRzWydkYXRhYmFzZSddO1xuICAgICAgICB9ICAgICAgICBcblxuICAgICAgICBpZiAoY29tcG9uZW50cy5oYXNPd25Qcm9wZXJ0eSgnb3B0aW9ucycpKSB7XG4gICAgICAgICAgICBsZXQgb3B0aW9ucyA9IGNvbXBvbmVudHMub3B0aW9ucztcblxuICAgICAgICAgICAgXy5mb3JPd24ob3B0aW9ucywgKHZhbHVlLCBrZXkpID0+IHtcbiAgICAgICAgICAgICAgICB1cmwuc2VhcmNoUGFyYW1zLnNldChrZXksIHR5cGVvZiB2YWx1ZSA9PT0gJ2Jvb2xlYW4nID8gKHZhbHVlID8gMSA6IDApIDogdmFsdWUpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdXJsLmhyZWY7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IHRoZSBjb25uZWN0aW9uIHdpdGhvdXQgY3JlZGVudGlhbCBpbmZvcm1hdGlvbiwgdXN1YWxseSB1c2VkIGZvciBkaXNwbGF5aW5nLlxuICAgICAqIEByZXR1cm5zIHtzdHJpbmd9XG4gICAgICovXG4gICAgZ2V0Q29ubmVjdGlvblN0cmluZ1dpdGhvdXRDcmVkZW50aWFsKCkge1xuICAgICAgICBsZXQgdXJsID0gbmV3IFVSTCh0aGlzLmNvbm5lY3Rpb25TdHJpbmcpO1xuICAgICAgICBcbiAgICAgICAgdXJsLnVzZXJuYW1lID0gJyc7XG4gICAgICAgIHVybC5wYXNzd29yZCA9ICcnO1xuXG4gICAgICAgIHJldHVybiB1cmwuaHJlZjtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBEYXRhYmFzZSBuYW1lLlxuICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgKi9cbiAgICBnZXQgZGF0YWJhc2UoKSB7XG4gICAgICAgIGlmICghdGhpcy5fZGF0YWJhc2UpIHtcbiAgICAgICAgICAgIHRoaXMuX2RhdGFiYXNlID0gKG5ldyBVUkwodGhpcy5jb25uZWN0aW9uU3RyaW5nKSkucGF0aG5hbWUuc3Vic3RyKDEpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuX2RhdGFiYXNlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENsaWVudCBsaWJyYXJ5LlxuICAgICAqIEBtZW1iZXIge29iamVjdH1cbiAgICAgKi9cbiAgICBnZXQgZHJpdmVyTGliKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3Rvci5kcml2ZXJMaWI7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogV3JpdGUgbG9nLlxuICAgICAqIEBwYXJhbSAgey4uLmFueX0gYXJncyBcbiAgICAgKi9cbiAgICBsb2coLi4uYXJncykge1xuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ2dlcikge1xuICAgICAgICAgICAgdGhpcy5vcHRpb25zLmxvZ2dlci5sb2coLi4uYXJncyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBMb2cgcXVlcnkuXG4gICAgICovXG5cbiAgICAvKlxuICAgIGFzeW5jIGNvbm5lY3RfKCkge31cblxuICAgIGFzeW5jIGRpc2Nvbm5lY3RfKCkge31cblxuICAgIGFzeW5jIHBpbmdfKCkge31cblxuICAgIGFzeW5jIGV4ZWN1dGVfKCkge31cblxuICAgIGFzeW5jIGVuZF8oKSB7fVxuICAgICovXG59XG5cbm1vZHVsZS5leHBvcnRzID0gQ29ubmVjdG9yOyJdfQ==