"use strict";

require("source-map-support/register");

const {
  URL
} = require('url');

const {
  _
} = require('rk-utils');

const {
  SupportedDrivers
} = require('./utils/lang');

class Connector {
  static createConnector(driver, connectionString, options) {
    if (SupportedDrivers.indexOf(driver) === -1) {
      throw new Error(`Unsupported connector driver: "${driver}"!`);
    }

    if (!connectionString) {
      throw new Error(`Missing required connection string`);
    }

    let ConnectorClass = require(`./drivers/${driver}/Connector`);

    return new ConnectorClass(connectionString, options);
  }

  constructor(driver, connectionString, options) {
    this.driver = driver;
    this.connectionString = connectionString;
    this.options = options || {};
    this.relational = false;
    this._mapOfConnectionToId = new WeakMap();
  }

  makeNewConnectionString(components) {
    let url = new URL(this.connectionString);

    if (components.hasOwnProperty('username')) {
      url.username = components['username'];
    }

    if (components.hasOwnProperty('password')) {
      url.password = components['password'];
    }

    if (components.hasOwnProperty('database')) {
      url.pathname = '/' + components['database'];
    }

    if (components.hasOwnProperty('options')) {
      let options = components.options;

      _.forOwn(options, (value, key) => {
        url.searchParams.set(key, typeof value === 'boolean' ? value ? 1 : 0 : value);
      });
    }

    return url.href;
  }

  getConnectionStringWithoutCredential() {
    let url = new URL(this.connectionString);
    url.username = '';
    url.password = '';
    return url.href;
  }

  get database() {
    if (!this._database) {
      this._database = new URL(this.connectionString).pathname.substr(1);
    }

    return this._database;
  }

  get driverLib() {
    return this.constructor.driverLib;
  }

  log(...args) {
    if (this.options.logger) {
      this.options.logger.log(...args);
    }
  }

}

module.exports = Connector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Db25uZWN0b3IuanMiXSwibmFtZXMiOlsiVVJMIiwicmVxdWlyZSIsIl8iLCJTdXBwb3J0ZWREcml2ZXJzIiwiQ29ubmVjdG9yIiwiY3JlYXRlQ29ubmVjdG9yIiwiZHJpdmVyIiwiY29ubmVjdGlvblN0cmluZyIsIm9wdGlvbnMiLCJpbmRleE9mIiwiRXJyb3IiLCJDb25uZWN0b3JDbGFzcyIsImNvbnN0cnVjdG9yIiwicmVsYXRpb25hbCIsIl9tYXBPZkNvbm5lY3Rpb25Ub0lkIiwiV2Vha01hcCIsIm1ha2VOZXdDb25uZWN0aW9uU3RyaW5nIiwiY29tcG9uZW50cyIsInVybCIsImhhc093blByb3BlcnR5IiwidXNlcm5hbWUiLCJwYXNzd29yZCIsInBhdGhuYW1lIiwiZm9yT3duIiwidmFsdWUiLCJrZXkiLCJzZWFyY2hQYXJhbXMiLCJzZXQiLCJocmVmIiwiZ2V0Q29ubmVjdGlvblN0cmluZ1dpdGhvdXRDcmVkZW50aWFsIiwiZGF0YWJhc2UiLCJfZGF0YWJhc2UiLCJzdWJzdHIiLCJkcml2ZXJMaWIiLCJsb2ciLCJhcmdzIiwibG9nZ2VyIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNO0FBQUVBLEVBQUFBO0FBQUYsSUFBVUMsT0FBTyxDQUFDLEtBQUQsQ0FBdkI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQTtBQUFGLElBQVFELE9BQU8sQ0FBQyxVQUFELENBQXJCOztBQUNBLE1BQU07QUFBRUUsRUFBQUE7QUFBRixJQUF1QkYsT0FBTyxDQUFDLGNBQUQsQ0FBcEM7O0FBTUEsTUFBTUcsU0FBTixDQUFnQjtBQU9aLFNBQU9DLGVBQVAsQ0FBdUJDLE1BQXZCLEVBQStCQyxnQkFBL0IsRUFBaURDLE9BQWpELEVBQTBEO0FBQ3RELFFBQUlMLGdCQUFnQixDQUFDTSxPQUFqQixDQUF5QkgsTUFBekIsTUFBcUMsQ0FBQyxDQUExQyxFQUE2QztBQUN6QyxZQUFNLElBQUlJLEtBQUosQ0FBVyxrQ0FBaUNK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Q0g7QUFDSjs7QUF0SVc7O0FBeUpoQkUsTUFBTSxDQUFDQyxPQUFQLEdBQWlCbEMsU0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgeyBVUkwgfSA9IHJlcXVpcmUoJ3VybCcpO1xuY29uc3QgeyBfIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyBTdXBwb3J0ZWREcml2ZXJzIH0gPSByZXF1aXJlKCcuL3V0aWxzL2xhbmcnKTtcblxuLyoqXG4gKiBBIGRhdGFiYXNlIHN0b3JhZ2UgY29ubmVjdG9yIG9iamVjdC5cbiAqIEBjbGFzc1xuICovXG5jbGFzcyBDb25uZWN0b3Ige1xuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIGNvbm5lY3Rvci5cbiAgICAgKiBAcGFyYW0geyp9IGRyaXZlciBcbiAgICAgKiBAcGFyYW0geyp9IGNvbm5lY3Rpb25TdHJpbmcgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIHN0YXRpYyBjcmVhdGVDb25uZWN0b3IoZHJpdmVyLCBjb25uZWN0aW9uU3RyaW5nLCBvcHRpb25zKSB7XG4gICAgICAgIGlmIChTdXBwb3J0ZWREcml2ZXJzLmluZGV4T2YoZHJpdmVyKSA9PT0gLTEpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5zdXBwb3J0ZWQgY29ubmVjdG9yIGRyaXZlcjogXCIke2RyaXZlcn1cIiFgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghY29ubmVjdGlvblN0cmluZykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBNaXNzaW5nIHJlcXVpcmVkIGNvbm5lY3Rpb24gc3RyaW5nYCk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgQ29ubmVjdG9yQ2xhc3MgPSByZXF1aXJlKGAuL2RyaXZlcnMvJHtkcml2ZXJ9L0Nvbm5lY3RvcmApO1xuICAgICAgICBcbiAgICAgICAgcmV0dXJuIG5ldyBDb25uZWN0b3JDbGFzcyhjb25uZWN0aW9uU3RyaW5nLCBvcHRpb25zKTtcbiAgICB9XG5cbiAgICAvKiogICAgIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBkcml2ZXIgLSBEYXRhIHN0b3JhZ2UgdHlwZVxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBjb25uZWN0aW9uU3RyaW5nIC0gVGhlIGNvbm5lY3Rpb24gc3RyaW5nXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zXSAtIENvbm5lY3RvciBvcHRpb25zXG4gICAgICogQHByb3BlcnR5IHtib29sZWFufSBbb3B0aW9ucy5sb2dnZXJdIC0gTG9nZ2VyIGluc3RhbmNlIFxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKGRyaXZlciwgY29ubmVjdGlvblN0cmluZywgb3B0aW9ucykge1xuICAgICAgICAvKipcbiAgICAgICAgICogVGhlIGRhdGFiYXNlIHN0b3JhZ2UgdHlwZSwgZS5nLiBteXNxbCwgbW9uZ29kYlxuICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmRyaXZlciA9IGRyaXZlcjtcblxuICAgICAgICAvKipcbiAgICAgICAgICogVGhlIGRlZmF1bHQgVVJMIHN0eWxlIGNvbm5lY3Rpb24gc3RyaW5nLCBlLmcuIG15c3FsOi8vdXNlcm5hbWU6cGFzc3dvcmRAaG9zdDpwb3J0L2RibmFtZVxuICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmNvbm5lY3Rpb25TdHJpbmcgPSBjb25uZWN0aW9uU3RyaW5nO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBDb25uZWN0b3Igb3B0aW9uc1xuICAgICAgICAgKiBAbWVtYmVyIHtvYmplY3R9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OyAgICAgIFxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBJcyB0aGUgZGF0YWJhc2UgYSByZWxhdGlvbmFsIGRhdGFiYXNlXG4gICAgICAgICAqIEBtZW1iZXIge2Jvb2xlYW59XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLnJlbGF0aW9uYWwgPSBmYWxzZTtcbiAgICAgICAgXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBNYXAgb2YgY29ubmVjdGlvbiBvYmplY3QgdG8gdW5pcXVlIGlkLCBmb3IgdHJhY2luZyBwdXJwb3NlXG4gICAgICAgICAqIEBwcml2YXRlXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLl9tYXBPZkNvbm5lY3Rpb25Ub0lkID0gbmV3IFdlYWtNYXAoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBNYWtlIGEgbmV3IGNvbm5lY3Rpb24gY29tcG9uZW50cyBmcm9tIGN1cnJlbnQgY29ubmVjdGlvbiBzdHJpbmcgYW5kIGdpdmVuIGNvbXBvbmVudHMuXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGNvbXBvbmVudHMgXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtjb21wb25lbnRzLnVzZXJuYW1lXVxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbY29tcG9uZW50cy5wYXNzd29yZF1cbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW2NvbXBvbmVudHMuZGF0YWJhc2VdXG4gICAgICogQHByb3BlcnR5IHtvYmplY3R9IFtjb21wb25lbnRzLm9wdGlvbnNdXG4gICAgICovXG4gICAgbWFrZU5ld0Nvbm5lY3Rpb25TdHJpbmcoY29tcG9uZW50cykge1xuICAgICAgICBsZXQgdXJsID0gbmV3IFVSTCh0aGlzLmNvbm5lY3Rpb25TdHJpbmcpO1xuXG4gICAgICAgIGlmIChjb21wb25lbnRzLmhhc093blByb3BlcnR5KCd1c2VybmFtZScpKSB7XG4gICAgICAgICAgICB1cmwudXNlcm5hbWUgPSBjb21wb25lbnRzWyd1c2VybmFtZSddO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGNvbXBvbmVudHMuaGFzT3duUHJvcGVydHkoJ3Bhc3N3b3JkJykpIHtcbiAgICAgICAgICAgIHVybC5wYXNzd29yZCA9IGNvbXBvbmVudHNbJ3Bhc3N3b3JkJ107XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY29tcG9uZW50cy5oYXNPd25Qcm9wZXJ0eSgnZGF0YWJhc2UnKSkge1xuICAgICAgICAgICAgdXJsLnBhdGhuYW1lID0gJy8nICsgY29tcG9uZW50c1snZGF0YWJhc2UnXTtcbiAgICAgICAgfSAgICAgICAgXG5cbiAgICAgICAgaWYgKGNvbXBvbmVudHMuaGFzT3duUHJvcGVydHkoJ29wdGlvbnMnKSkge1xuICAgICAgICAgICAgbGV0IG9wdGlvbnMgPSBjb21wb25lbnRzLm9wdGlvbnM7XG5cbiAgICAgICAgICAgIF8uZm9yT3duKG9wdGlvbnMsICh2YWx1ZSwga2V5KSA9PiB7XG4gICAgICAgICAgICAgICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoa2V5LCB0eXBlb2YgdmFsdWUgPT09ICdib29sZWFuJyA/ICh2YWx1ZSA/IDEgOiAwKSA6IHZhbHVlKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHVybC5ocmVmO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCB0aGUgY29ubmVjdGlvbiB3aXRob3V0IGNyZWRlbnRpYWwgaW5mb3JtYXRpb24sIHVzdWFsbHkgdXNlZCBmb3IgZGlzcGxheWluZy5cbiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfVxuICAgICAqL1xuICAgIGdldENvbm5lY3Rpb25TdHJpbmdXaXRob3V0Q3JlZGVudGlhbCgpIHtcbiAgICAgICAgbGV0IHVybCA9IG5ldyBVUkwodGhpcy5jb25uZWN0aW9uU3RyaW5nKTtcbiAgICAgICAgXG4gICAgICAgIHVybC51c2VybmFtZSA9ICcnO1xuICAgICAgICB1cmwucGFzc3dvcmQgPSAnJztcblxuICAgICAgICByZXR1cm4gdXJsLmhyZWY7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRGF0YWJhc2UgbmFtZS5cbiAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICovXG4gICAgZ2V0IGRhdGFiYXNlKCkge1xuICAgICAgICBpZiAoIXRoaXMuX2RhdGFiYXNlKSB7XG4gICAgICAgICAgICB0aGlzLl9kYXRhYmFzZSA9IChuZXcgVVJMKHRoaXMuY29ubmVjdGlvblN0cmluZykpLnBhdGhuYW1lLnN1YnN0cigxKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLl9kYXRhYmFzZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDbGllbnQgbGlicmFyeS5cbiAgICAgKiBAbWVtYmVyIHtvYmplY3R9XG4gICAgICovXG4gICAgZ2V0IGRyaXZlckxpYigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY29uc3RydWN0b3IuZHJpdmVyTGliO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFdyaXRlIGxvZy5cbiAgICAgKiBAcGFyYW0gIHsuLi5hbnl9IGFyZ3MgXG4gICAgICovXG4gICAgbG9nKC4uLmFyZ3MpIHtcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dnZXIpIHtcbiAgICAgICAgICAgIHRoaXMub3B0aW9ucy5sb2dnZXIubG9nKC4uLmFyZ3MpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTG9nIHF1ZXJ5LlxuICAgICAqL1xuXG4gICAgLypcbiAgICBhc3luYyBjb25uZWN0XygpIHt9XG5cbiAgICBhc3luYyBkaXNjb25uZWN0XygpIHt9XG5cbiAgICBhc3luYyBwaW5nXygpIHt9XG5cbiAgICBhc3luYyBleGVjdXRlXygpIHt9XG5cbiAgICBhc3luYyBlbmRfKCkge31cbiAgICAqL1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IENvbm5lY3RvcjsiXX0=