"use strict";

require("source-map-support/register");

const {
  URL
} = require('url');

const {
  _
} = require('rk-utils');

const {
  SupportedDrivers
} = require('./utils/lang');

class Connector {
  static createConnector(driver, connectionString, options) {
    if (SupportedDrivers.indexOf(driver) === -1) {
      throw new Error(`Unsupported connector driver: "${driver}"!`);
    }

    if (!connectionString) {
      throw new Error(`Missing required connection string`);
    }

    let ConnectorClass = require(`./drivers/${driver}/Connector`);

    return new ConnectorClass(connectionString, options);
  }

  constructor(driver, connectionString, options) {
    this.driver = driver;
    this.connectionString = connectionString;
    this.options = options || {};
    this.relational = false;
    this._mapOfConnectionToId = new WeakMap();
  }

  makeNewConnectionString(components) {
    let url = new URL(this.connectionString);

    if (components.hasOwnProperty('username')) {
      url.username = components['username'];
    }

    if (components.hasOwnProperty('password')) {
      url.password = components['password'];
    }

    if (components.hasOwnProperty('database')) {
      url.pathname = '/' + components['database'];
    }

    if (components.hasOwnProperty('options')) {
      let options = components.options;

      _.forOwn(options, (value, key) => {
        url.searchParams.set(key, typeof value === 'boolean' ? value ? 1 : 0 : value);
      });
    }

    return url.href;
  }

  getConnectionStringWithoutCredential() {
    let url = new URL(this.connectionString);
    url.username = '';
    url.password = '';
    return url.href;
  }

  get database() {
    if (!this._database) {
      this._database = new URL(this.connectionString).pathname.substr(1);
    }

    return this._database;
  }

  get driverLib() {
    return this.constructor.driverLib;
  }

  log(...args) {
    if (this.options.logger) {
      this.options.logger.log(...args);
    }
  }

}

module.exports = Connector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Db25uZWN0b3IuanMiXSwibmFtZXMiOlsiVVJMIiwicmVxdWlyZSIsIl8iLCJTdXBwb3J0ZWREcml2ZXJzIiwiQ29ubmVjdG9yIiwiY3JlYXRlQ29ubmVjdG9yIiwiZHJpdmVyIiwiY29ubmVjdGlvblN0cmluZyIsIm9wdGlvbnMiLCJpbmRleE9mIiwiRXJyb3IiLCJDb25uZWN0b3JDbGFzcyIsImNvbnN0cnVjdG9yIiwicmVsYXRpb25hbCIsIl9tYXBPZkNvbm5lY3Rpb25Ub0lkIiwiV2Vha01hcCIsIm1ha2VOZXdDb25uZWN0aW9uU3RyaW5nIiwiY29tcG9uZW50cyIsInVybCIsImhhc093blByb3BlcnR5IiwidXNlcm5hbWUiLCJwYXNzd29yZCIsInBhdGhuYW1lIiwiZm9yT3duIiwidmFsdWUiLCJrZXkiLCJzZWFyY2hQYXJhbXMiLCJzZXQiLCJocmVmIiwiZ2V0Q29ubmVjdGlvblN0cmluZ1dpdGhvdXRDcmVkZW50aWFsIiwiZGF0YWJhc2UiLCJfZGF0YWJhc2UiLCJzdWJzdHIiLCJkcml2ZXJMaWIiLCJsb2ciLCJhcmdzIiwibG9nZ2VyIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNO0FBQUVBLEVBQUFBO0FBQUYsSUFBVUMsT0FBTyxDQUFDLEtBQUQsQ0FBdkI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQTtBQUFGLElBQVFELE9BQU8sQ0FBQyxVQUFELENBQXJCOztBQUNBLE1BQU07QUFBRUUsRUFBQUE7QUFBRixJQUF1QkYsT0FBTyxDQUFDLGNBQUQsQ0FBcEM7O0FBTUEsTUFBTUcsU0FBTixDQUFnQjtBQU9VLFNBQWZDLGVBQWUsQ0FBQ0MsTUFBRCxFQUFTQyxnQkFBVCxFQUEyQkMsT0FBM0IsRUFBb0M7QUFDdEQsUUFBSUwsZ0JBQWdCLENBQUNNLE9BQWpCLENBQXlCSCxNQUF6QixNQUFxQyxDQUFDLENBQTFDLEVBQTZDO0FBQ3pDLFlBQU0sSUFBSUksS0FBSixDQUFXLGtDQUFpQ0osTUFBTyxJQUFuRCxDQUFOO0FBQ0g7O0FBRUQsUUFBSSxDQUFDQyxnQkFBTCxFQUF1QjtBQUNuQixZQUFNLElBQUlHLEtBQUosQ0FBVyxvQ0FBWCxDQUFOO0FBQ0g7O0FBRUQsUUFBSUMsY0FBYyxHQUFHVixPQUFPLENBQUUsYUFBWUssTUFBTyxZQUFyQixDQUE1Qjs7QUFFQSxXQUFPLElBQUlLLGNBQUosQ0FBbUJKLGdCQUFuQixFQUFxQ0MsT0FBckMsQ0FBUDtBQUNIOztBQVFESSxFQUFBQSxXQUFXLENBQUNOLE1BQUQsRUFBU0MsZ0JBQVQsRUFBMkJDLE9BQTNCLEVBQW9DO0FBSzNDLFNBQUtGLE1BQUwsR0FBY0EsTUFBZDtBQU1BLFNBQUtDLGdCQUFMLEdBQXdCQSxnQkFBeEI7QUFNQSxTQUFLQyxPQUFMLEdBQWVBLE9BQU8sSUFBSSxFQUExQjtBQU1BLFNBQUtLLFVBQUwsR0FBa0IsS0FBbEI7QUFNQSxTQUFLQyxvQkFBTCxHQUE0QixJQUFJQyxPQUFKLEVBQTVCO0FBQ0g7O0FBVURDLEVBQUFBLHVCQUF1QixDQUFDQyxVQUFELEVBQWE7QUFDaEMsUUFBSUMsR0FBRyxHQUFHLElBQUlsQixHQUFKLENBQVEsS0FBS08sZ0JBQWIsQ0FBVjs7QUFFQSxRQUFJVSxVQUFVLENBQUNFLGNBQVgsQ0FBMEIsVUFBMUIsQ0FBSixFQUEyQztBQUN2Q0QsTUFBQUEsR0FBRyxDQUFDRSxRQUFKLEdBQWVILFVBQVUsQ0FBQyxVQUFELENBQXpCO0FBQ0g7O0FBRUQsUUFBSUEsVUFBVSxDQUFDRSxjQUFYLENBQTBCLFVBQTFCLENBQUosRUFBMkM7QUFDdkNELE1BQUFBLEdBQUcsQ0FBQ0csUUFBSixHQUFlSixVQUFVLENBQUMsVUFBRCxDQUF6QjtBQUNIOztBQUVELFFBQUlBLFVBQVUsQ0FBQ0UsY0FBWCxDQUEwQixVQUExQixDQUFKLEVBQTJDO0FBQ3ZDRCxNQUFBQSxHQUFHLENBQUNJLFFBQUosR0FBZSxNQUFNTCxVQUFVLENBQUMsVUFBRCxDQUEvQjtBQUNIOztBQUVELFFBQUlBLFVBQVUsQ0FBQ0UsY0FBWCxDQUEwQixTQUExQixDQUFKLEVBQTBDO0FBQ3RDLFVBQUlYLE9BQU8sR0FBR1MsVUFBVSxDQUFDVCxPQUF6Qjs7QUFFQU4sTUFBQUEsQ0FBQyxDQUFDcUIsTUFBRixDQUFTZixPQUFULEVBQWtCLENBQUNnQixLQUFELEVBQVFDLEdBQVIsS0FBZ0I7QUFDOUJQLFFBQUFBLEdBQUcsQ0FBQ1EsWUFBSixDQUFpQkMsR0FBakIsQ0FBcUJGLEdBQXJCLEVBQTBCLE9BQU9ELEtBQVAsS0FBaUIsU0FBakIsR0FBOEJBLEtBQUssR0FBRyxDQUFILEdBQU8sQ0FBMUMsR0FBK0NBLEtBQXpFO0FBQ0gsT0FGRDtBQUdIOztBQUVELFdBQU9OLEdBQUcsQ0FBQ1UsSUFBWDtBQUNIOztBQU1EQyxFQUFBQSxvQ0FBb0MsR0FBRztBQUNuQyxRQUFJWCxHQUFHLEdBQUcsSUFBSWxCLEdBQUosQ0FBUSxLQUFLTyxnQkFBYixDQUFWO0FBRUFXLElBQUFBLEdBQUcsQ0FBQ0UsUUFBSixHQUFlLEVBQWY7QUFDQUYsSUFBQUEsR0FBRyxDQUFDRyxRQUFKLEdBQWUsRUFBZjtBQUVBLFdBQU9ILEdBQUcsQ0FBQ1UsSUFBWDtBQUNIOztBQU1XLE1BQVJFLFFBQVEsR0FBRztBQUNYLFFBQUksQ0FBQyxLQUFLQyxTQUFWLEVBQXFCO0FBQ2pCLFdBQUtBLFNBQUwsR0FBa0IsSUFBSS9CLEdBQUosQ0FBUSxLQUFLTyxnQkFBYixDQUFELENBQWlDZSxRQUFqQyxDQUEwQ1UsTUFBMUMsQ0FBaUQsQ0FBakQsQ0FBakI7QUFDSDs7QUFFRCxXQUFPLEtBQUtELFNBQVo7QUFDSDs7QUFNWSxNQUFURSxTQUFTLEdBQUc7QUFDWixXQUFPLEtBQUtyQixXQUFMLENBQWlCcUIsU0FBeEI7QUFDSDs7QUFNREMsRUFBQUEsR0FBRyxDQUFDLEdBQUdDLElBQUosRUFBVTtBQUNULFFBQUksS0FBSzNCLE9BQUwsQ0FBYTRCLE1BQWpCLEVBQXlCO0FBQ3JCLFdBQUs1QixPQUFMLENBQWE0QixNQUFiLENBQW9CRixHQUFwQixDQUF3QixHQUFHQyxJQUEzQjtBQUNIO0FBQ0o7O0FBdElXOztBQXlKaEJFLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQmxDLFNBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IHsgVVJMIH0gPSByZXF1aXJlKCd1cmwnKTtcbmNvbnN0IHsgXyB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgU3VwcG9ydGVkRHJpdmVycyB9ID0gcmVxdWlyZSgnLi91dGlscy9sYW5nJyk7XG5cbi8qKlxuICogQSBkYXRhYmFzZSBzdG9yYWdlIGNvbm5lY3RvciBvYmplY3QuXG4gKiBAY2xhc3NcbiAqL1xuY2xhc3MgQ29ubmVjdG9yIHtcbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBjb25uZWN0b3IuXG4gICAgICogQHBhcmFtIHsqfSBkcml2ZXIgXG4gICAgICogQHBhcmFtIHsqfSBjb25uZWN0aW9uU3RyaW5nIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBzdGF0aWMgY3JlYXRlQ29ubmVjdG9yKGRyaXZlciwgY29ubmVjdGlvblN0cmluZywgb3B0aW9ucykge1xuICAgICAgICBpZiAoU3VwcG9ydGVkRHJpdmVycy5pbmRleE9mKGRyaXZlcikgPT09IC0xKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuc3VwcG9ydGVkIGNvbm5lY3RvciBkcml2ZXI6IFwiJHtkcml2ZXJ9XCIhYCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWNvbm5lY3Rpb25TdHJpbmcpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgTWlzc2luZyByZXF1aXJlZCBjb25uZWN0aW9uIHN0cmluZ2ApO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IENvbm5lY3RvckNsYXNzID0gcmVxdWlyZShgLi9kcml2ZXJzLyR7ZHJpdmVyfS9Db25uZWN0b3JgKTtcbiAgICAgICAgXG4gICAgICAgIHJldHVybiBuZXcgQ29ubmVjdG9yQ2xhc3MoY29ubmVjdGlvblN0cmluZywgb3B0aW9ucyk7XG4gICAgfVxuXG4gICAgLyoqICAgICBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZHJpdmVyIC0gRGF0YSBzdG9yYWdlIHR5cGVcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gY29ubmVjdGlvblN0cmluZyAtIFRoZSBjb25uZWN0aW9uIHN0cmluZ1xuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbb3B0aW9uc10gLSBDb25uZWN0b3Igb3B0aW9uc1xuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW29wdGlvbnMubG9nZ2VyXSAtIExvZ2dlciBpbnN0YW5jZSBcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3Rvcihkcml2ZXIsIGNvbm5lY3Rpb25TdHJpbmcsIG9wdGlvbnMpIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIFRoZSBkYXRhYmFzZSBzdG9yYWdlIHR5cGUsIGUuZy4gbXlzcWwsIG1vbmdvZGJcbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5kcml2ZXIgPSBkcml2ZXI7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFRoZSBkZWZhdWx0IFVSTCBzdHlsZSBjb25uZWN0aW9uIHN0cmluZywgZS5nLiBteXNxbDovL3VzZXJuYW1lOnBhc3N3b3JkQGhvc3Q6cG9ydC9kYm5hbWVcbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5jb25uZWN0aW9uU3RyaW5nID0gY29ubmVjdGlvblN0cmluZztcblxuICAgICAgICAvKipcbiAgICAgICAgICogQ29ubmVjdG9yIG9wdGlvbnNcbiAgICAgICAgICogQG1lbWJlciB7b2JqZWN0fVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9ucyB8fCB7fTsgICAgICBcblxuICAgICAgICAvKipcbiAgICAgICAgICogSXMgdGhlIGRhdGFiYXNlIGEgcmVsYXRpb25hbCBkYXRhYmFzZVxuICAgICAgICAgKiBAbWVtYmVyIHtib29sZWFufVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5yZWxhdGlvbmFsID0gZmFsc2U7XG4gICAgICAgIFxuICAgICAgICAvKipcbiAgICAgICAgICogTWFwIG9mIGNvbm5lY3Rpb24gb2JqZWN0IHRvIHVuaXF1ZSBpZCwgZm9yIHRyYWNpbmcgcHVycG9zZVxuICAgICAgICAgKiBAcHJpdmF0ZVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5fbWFwT2ZDb25uZWN0aW9uVG9JZCA9IG5ldyBXZWFrTWFwKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTWFrZSBhIG5ldyBjb25uZWN0aW9uIGNvbXBvbmVudHMgZnJvbSBjdXJyZW50IGNvbm5lY3Rpb24gc3RyaW5nIGFuZCBnaXZlbiBjb21wb25lbnRzLlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBjb21wb25lbnRzIFxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbY29tcG9uZW50cy51c2VybmFtZV1cbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW2NvbXBvbmVudHMucGFzc3dvcmRdXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtjb21wb25lbnRzLmRhdGFiYXNlXVxuICAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBbY29tcG9uZW50cy5vcHRpb25zXVxuICAgICAqL1xuICAgIG1ha2VOZXdDb25uZWN0aW9uU3RyaW5nKGNvbXBvbmVudHMpIHtcbiAgICAgICAgbGV0IHVybCA9IG5ldyBVUkwodGhpcy5jb25uZWN0aW9uU3RyaW5nKTtcblxuICAgICAgICBpZiAoY29tcG9uZW50cy5oYXNPd25Qcm9wZXJ0eSgndXNlcm5hbWUnKSkge1xuICAgICAgICAgICAgdXJsLnVzZXJuYW1lID0gY29tcG9uZW50c1sndXNlcm5hbWUnXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjb21wb25lbnRzLmhhc093blByb3BlcnR5KCdwYXNzd29yZCcpKSB7XG4gICAgICAgICAgICB1cmwucGFzc3dvcmQgPSBjb21wb25lbnRzWydwYXNzd29yZCddO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGNvbXBvbmVudHMuaGFzT3duUHJvcGVydHkoJ2RhdGFiYXNlJykpIHtcbiAgICAgICAgICAgIHVybC5wYXRobmFtZSA9ICcvJyArIGNvbXBvbmVudHNbJ2RhdGFiYXNlJ107XG4gICAgICAgIH0gICAgICAgIFxuXG4gICAgICAgIGlmIChjb21wb25lbnRzLmhhc093blByb3BlcnR5KCdvcHRpb25zJykpIHtcbiAgICAgICAgICAgIGxldCBvcHRpb25zID0gY29tcG9uZW50cy5vcHRpb25zO1xuXG4gICAgICAgICAgICBfLmZvck93bihvcHRpb25zLCAodmFsdWUsIGtleSkgPT4ge1xuICAgICAgICAgICAgICAgIHVybC5zZWFyY2hQYXJhbXMuc2V0KGtleSwgdHlwZW9mIHZhbHVlID09PSAnYm9vbGVhbicgPyAodmFsdWUgPyAxIDogMCkgOiB2YWx1ZSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB1cmwuaHJlZjtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgdGhlIGNvbm5lY3Rpb24gd2l0aG91dCBjcmVkZW50aWFsIGluZm9ybWF0aW9uLCB1c3VhbGx5IHVzZWQgZm9yIGRpc3BsYXlpbmcuXG4gICAgICogQHJldHVybnMge3N0cmluZ31cbiAgICAgKi9cbiAgICBnZXRDb25uZWN0aW9uU3RyaW5nV2l0aG91dENyZWRlbnRpYWwoKSB7XG4gICAgICAgIGxldCB1cmwgPSBuZXcgVVJMKHRoaXMuY29ubmVjdGlvblN0cmluZyk7XG4gICAgICAgIFxuICAgICAgICB1cmwudXNlcm5hbWUgPSAnJztcbiAgICAgICAgdXJsLnBhc3N3b3JkID0gJyc7XG5cbiAgICAgICAgcmV0dXJuIHVybC5ocmVmO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIERhdGFiYXNlIG5hbWUuXG4gICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAqL1xuICAgIGdldCBkYXRhYmFzZSgpIHtcbiAgICAgICAgaWYgKCF0aGlzLl9kYXRhYmFzZSkge1xuICAgICAgICAgICAgdGhpcy5fZGF0YWJhc2UgPSAobmV3IFVSTCh0aGlzLmNvbm5lY3Rpb25TdHJpbmcpKS5wYXRobmFtZS5zdWJzdHIoMSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5fZGF0YWJhc2U7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2xpZW50IGxpYnJhcnkuXG4gICAgICogQG1lbWJlciB7b2JqZWN0fVxuICAgICAqL1xuICAgIGdldCBkcml2ZXJMaWIoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmNvbnN0cnVjdG9yLmRyaXZlckxpYjtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBXcml0ZSBsb2cuXG4gICAgICogQHBhcmFtICB7Li4uYW55fSBhcmdzIFxuICAgICAqL1xuICAgIGxvZyguLi5hcmdzKSB7XG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nZ2VyKSB7XG4gICAgICAgICAgICB0aGlzLm9wdGlvbnMubG9nZ2VyLmxvZyguLi5hcmdzKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIExvZyBxdWVyeS5cbiAgICAgKi9cblxuICAgIC8qXG4gICAgYXN5bmMgY29ubmVjdF8oKSB7fVxuXG4gICAgYXN5bmMgZGlzY29ubmVjdF8oKSB7fVxuXG4gICAgYXN5bmMgcGluZ18oKSB7fVxuXG4gICAgYXN5bmMgZXhlY3V0ZV8oKSB7fVxuXG4gICAgYXN5bmMgZW5kXygpIHt9XG4gICAgKi9cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBDb25uZWN0b3I7Il19