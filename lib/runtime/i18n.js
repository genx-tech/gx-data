"use strict";

require("source-map-support/register");

const path = require('path');

const util = require('util');

const Util = require('../../util.js');

const Promise = Util.Promise;

const Convertors = require('./convertors');

class I18n {
  constructor(config) {
    config || (config = {});
    this.supportedLocales = config.supportedLocales ? config.supportedLocales.map(l => I18n.normalizeLocale(l)) : ['en_AU', 'en_US', 'zh_CN'];
    this.reverseUpdate = util.isNullOrUndefined(config.reverseUpdate) ? false : Convertors.toBoolean(config.reverseUpdate);
    this.updateWithMeta = util.isNullOrUndefined(config.updateWithMeta) ? false : Convertors.toBoolean(config.updateWithMeta);
    this.timezone = config.timezone;
    this.pendingUpdates = {};
  }

  isLocaleSupported(locale) {
    let n = locale && I18n.normalizeLocale(locale);
    return this.supportedLocales.some(l => n === l);
  }

  async setupAsync(locale) {
    if (!this.isLocaleSupported(locale)) return Promise.reject('unsupported_locale');
    this.dictionary = {};
    this.locale = I18n.normalizeLocale(locale || this.supportedLocales[0]);
    this.momentLocale = I18n.localeToDash(this.locale).toLowerCase();
    this.momentTimezone = Util.timezone;
    return this;
  }

  getText(token, values, defaultText) {
    if (Util._.isString(values)) {
      defaultText = values;
      values = null;
    }

    var phrase = Util.getValueByPath(this.dictionary, token);

    if (util.isNullOrUndefined(phrase)) {
      phrase = defaultText;

      if (phrase) {
        if (this.reverseUpdate) this.addToDictionary(token, phrase);
      } else {
        phrase = token;
      }
    } else if (util.isObject(phrase)) {
      phrase = phrase['text'];
    }

    return Util._.isEmpty(values) ? phrase : Util.template(phrase, values);
  }

  addToDictionary(token, text, saveImmediate) {
    if (this.updateWithMeta) {
      text = {
        text: text,
        comment: 'Added at ' + this.datetime().format()
      };
    }

    Util.setValueByPath(this.dictionary, token, text);
    this.pendingUpdates[token] = text;

    if (saveImmediate) {
      this.save();
    }
  }

  save() {
    this.pendingUpdates = {};
  }

  datetime(value, timezone) {
    timezone || (timezone = this.timezone);
    var r = this.momentTimezone(value).locale(this.momentLocale);
    return timezone ? r.tz(timezone) : r;
  }

  flush() {
    if (this.reverseUpdate) {
      this.save();
    }
  }

  get dashForm() {
    return I18n.localeToDash(this.locale);
  }

  static normalizeLocale(locale) {
    var l = locale.replace('-', '_').split('_', 2);
    var l2 = l[0].toLowerCase();

    if (l.length > 1) {
      l2 += '_' + l[1].toUpperCase();
    }

    return l2;
  }

  static localeToDash(locale) {
    return locale.replace('_', '-');
  }

  static extractLanguageCode(locale) {
    var pos = locale.lastIndexOf('_');
    if (pos == -1) return locale;
    return locale.substr(0, pos);
  }

  static extractCountryCode(locale) {
    var pos = locale.lastIndexOf('_');
    if (pos == -1) return '';
    return locale.substr(pos + 1);
  }

}

class FileI18n extends I18n {
  constructor(config) {
    super(config);
    config || (config = {});
    this.directory = config.directory || './locale';
  }

  async setupAsync(locale) {
    const self = this;

    function loadDir(dict, dir, finish) {
      Util.fs.readdir(dir, function (err, files) {
        if (err) return finish(err);
        Util.async.each(files, function (file, cb) {
          let langFilePath = path.join(dir, file);
          let stats = Util.fs.statSync(langFilePath);

          if (stats.isDirectory()) {
            dict[file] = {};
            return loadDir(dict[file], langFilePath, cb);
          }

          let extName = path.extname(file);
          if (extName.toLowerCase() !== '.json') return cb();
          Util.fs.readJson(langFilePath, function (err, content) {
            if (err) return cb(err);
            let basename = path.basename(file, extName);
            dict[basename] = content;
            cb();
          });
        }, finish);
      });
    }

    return super.setupAsync(locale).then(() => {
      let langPath = path.resolve(self.directory, 'lang');
      return new Promise((resolve, reject) => {
        let p = path.join(langPath, self.locale);

        if (!Util.fs.existsSync(p)) {
          let lang = I18n.extractLanguageCode(self.locale);
          p = path.join(langPath, lang);

          if (!Util.fs.existsSync(p)) {
            return resolve(self);
          }
        }

        loadDir(self.dictionary, p, err => {
          if (err) return reject(err);
          resolve(self);
        });
      });
    });
  }

  save() {
    var fileSet = new Set();

    Util._.forOwn(this.pendingUpdates, (v, k) => {
      let keyword = path.extname(k);
      let p = path.basename(k, keyword);
      fileSet.add(p);
    });

    var langPath = path.resolve(this.directory, 'lang');
    var bp = path.join(langPath, this.locale);

    for (let p of fileSet) {
      let content = Util.getValueByPath(this.dictionary, p);
      let f = Util.replaceAll(p, '.', path.delimiter) + '.json';
      Util.fs.outputJsonSync(path.join(bp, f), content);
    }

    fileSet.clear();
    super.save();
  }

}

I18n.File = FileI18n;
module.exports = I18n;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ydW50aW1lL2kxOG4uanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJ1dGlsIiwiVXRpbCIsIlByb21pc2UiLCJDb252ZXJ0b3JzIiwiSTE4biIsImNvbnN0cnVjdG9yIiwiY29uZmlnIiwic3VwcG9ydGVkTG9jYWxlcyIsIm1hcCIsImwiLCJub3JtYWxpemVMb2NhbGUiLCJyZXZlcnNlVXBkYXRlIiwiaXNOdWxsT3JVbmRlZmluZWQiLCJ0b0Jvb2xlYW4iLCJ1cGRhdGVXaXRoTWV0YSIsInRpbWV6b25lIiwicGVuZGluZ1VwZGF0ZXMiLCJpc0xvY2FsZVN1cHBvcnRlZCIsImxvY2FsZSIsIm4iLCJzb21lIiwic2V0dXBBc3luYyIsInJlamVjdCIsImRpY3Rpb25hcnkiLCJtb21lbnRMb2NhbGUiLCJsb2NhbGVUb0Rhc2giLCJ0b0xvd2VyQ2FzZSIsIm1vbWVudFRpbWV6b25lIiwiZ2V0VGV4dCIsInRva2VuIiwidmFsdWVzIiwiZGVmYXVsdFRleHQiLCJfIiwiaXNTdHJpbmciLCJwaHJhc2UiLCJnZXRWYWx1ZUJ5UGF0aCIsImFkZFRvRGljdGlvbmFyeSIsImlzT2JqZWN0IiwiaXNFbXB0eSIsInRlbXBsYXRlIiwidGV4dCIsInNhdmVJbW1lZGlhdGUiLCJjb21tZW50IiwiZGF0ZXRpbWUiLCJmb3JtYXQiLCJzZXRWYWx1ZUJ5UGF0aCIsInNhdmUiLCJ2YWx1ZSIsInIiLCJ0eiIsImZsdXNoIiwiZGFzaEZvcm0iLCJyZXBsYWNlIiwic3BsaXQiLCJsMiIsImxlbmd0aCIsInRvVXBwZXJDYXNlIiwiZXh0cmFjdExhbmd1YWdlQ29kZSIsInBvcyIsImxhc3RJbmRleE9mIiwic3Vic3RyIiwiZXh0cmFjdENvdW50cnlDb2RlIiwiRmlsZUkxOG4iLCJkaXJlY3RvcnkiLCJzZWxmIiwibG9hZERpciIsImRpY3QiLCJkaXIiLCJmaW5pc2giLCJmcyIsInJlYWRkaXIiLCJlcnIiLCJmaWxlcyIsImFzeW5jIiwiZWFjaCIsImZpbGUiLCJjYiIsImxhbmdGaWxlUGF0aCIsImpvaW4iLCJzdGF0cyIsInN0YXRTeW5jIiwiaXNEaXJlY3RvcnkiLCJleHROYW1lIiwiZXh0bmFtZSIsInJlYWRKc29uIiwiY29udGVudCIsImJhc2VuYW1lIiwidGhlbiIsImxhbmdQYXRoIiwicmVzb2x2ZSIsInAiLCJleGlzdHNTeW5jIiwibGFuZyIsImZpbGVTZXQiLCJTZXQiLCJmb3JPd24iLCJ2IiwiayIsImtleXdvcmQiLCJhZGQiLCJicCIsImYiLCJyZXBsYWNlQWxsIiwiZGVsaW1pdGVyIiwib3V0cHV0SnNvblN5bmMiLCJjbGVhciIsIkZpbGUiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTUMsSUFBSSxHQUFHRCxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNRSxJQUFJLEdBQUdGLE9BQU8sQ0FBQyxlQUFELENBQXBCOztBQUNBLE1BQU1HLE9BQU8sR0FBR0QsSUFBSSxDQUFDQyxPQUFyQjs7QUFDQSxNQUFNQyxVQUFVLEdBQUdKLE9BQU8sQ0FBQyxjQUFELENBQTFCOztBQUVBLE1BQU1LLElBQU4sQ0FBVztBQVVQQyxFQUFBQSxXQUFXLENBQUNDLE1BQUQsRUFBUztBQUNoQkEsSUFBQUEsTUFBTSxLQUFLQSxNQUFNLEdBQUcsRUFBZCxDQUFOO0FBRUEsU0FBS0MsZ0JBQUwsR0FBd0JELE1BQU0sQ0FBQ0MsZ0JBQVAsR0FBMEJELE1BQU0sQ0FBQ0MsZ0JBQVAsQ0FBd0JDLEdBQXhCLENBQTRCQyxDQUFDLElBQUlMLElBQUksQ0FBQ00sZUFBTCxDQUFxQkQsQ0FBckIsQ0FBakMsQ0FBMUIsR0FBc0YsQ0FBRSxPQUFGLEVBQVcsT0FBWCxFQUFvQixPQUFwQixDQUE5RztBQUNBLFNBQUtFLGFBQUwsR0FBcUJYLElBQUksQ0FBQ1ksaUJBQUwsQ0FBdUJOLE1BQU0sQ0FBQ0ssYUFBOUIsSUFBK0MsS0FBL0MsR0FBd0RSLFVBQVUs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LElBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCB1dGlsID0gcmVxdWlyZSgndXRpbCcpO1xuY29uc3QgVXRpbCA9IHJlcXVpcmUoJy4uLy4uL3V0aWwuanMnKTtcbmNvbnN0IFByb21pc2UgPSBVdGlsLlByb21pc2U7XG5jb25zdCBDb252ZXJ0b3JzID0gcmVxdWlyZSgnLi9jb252ZXJ0b3JzJyk7XG5cbmNsYXNzIEkxOG4ge1xuICAgIC8qKlxuICAgICAqIEFuIGFwcCBtb2R1bGUgb2JqZWN0LlxuICAgICAqIEBjb25zdHJ1Y3RzIEkxOG5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gW2NvbmZpZ10gLSBUaGUgaTE4biBjb25maWd1cmF0aW9uLlxuICAgICAqIEBwcm9wZXJ0eSB7YXJyYXl9IFtjb25maWcuc3VwcG9ydGVkTG9jYWxlc10gLSBUaGUgZGVmYXVsdCBsb2NhbGVcbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtjb25maWcucmV2ZXJzZVVwZGF0ZT1mYWxzZV0gLSBSZXZlcnNlIHVwZGF0ZSB3aGVuXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbY29uZmlnLnVwZGF0ZVdpdGhNZXRhPWZhbHNlXSAtXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtjb25maWcudGltZXpvbmVdIC0gVGltZXpvbmVcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3Rvcihjb25maWcpIHtcbiAgICAgICAgY29uZmlnIHx8IChjb25maWcgPSB7fSk7XG5cbiAgICAgICAgdGhpcy5zdXBwb3J0ZWRMb2NhbGVzID0gY29uZmlnLnN1cHBvcnRlZExvY2FsZXMgPyBjb25maWcuc3VwcG9ydGVkTG9jYWxlcy5tYXAobCA9PiBJMThuLm5vcm1hbGl6ZUxvY2FsZShsKSkgOiBbICdlbl9BVScsICdlbl9VUycsICd6aF9DTicgXTtcbiAgICAgICAgdGhpcy5yZXZlcnNlVXBkYXRlID0gdXRpbC5pc051bGxPclVuZGVmaW5lZChjb25maWcucmV2ZXJzZVVwZGF0ZSkgPyBmYWxzZSA6ICBDb252ZXJ0b3JzLnRvQm9vbGVhbihjb25maWcucmV2ZXJzZVVwZGF0ZSk7XG4gICAgICAgIHRoaXMudXBkYXRlV2l0aE1ldGEgPSB1dGlsLmlzTnVsbE9yVW5kZWZpbmVkKGNvbmZpZy51cGRhdGVXaXRoTWV0YSkgPyBmYWxzZSA6IENvbnZlcnRvcnMudG9Cb29sZWFuKGNvbmZpZy51cGRhdGVXaXRoTWV0YSk7XG4gICAgICAgIHRoaXMudGltZXpvbmUgPSBjb25maWcudGltZXpvbmU7XG4gICAgICAgIHRoaXMucGVuZGluZ1VwZGF0ZXMgPSB7fTtcbiAgICB9XG5cbiAgICBpc0xvY2FsZVN1cHBvcnRlZChsb2NhbGUpIHtcbiAgICAgICAgbGV0IG4gPSBsb2NhbGUgJiYgSTE4bi5ub3JtYWxpemVMb2NhbGUobG9jYWxlKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3VwcG9ydGVkTG9jYWxlcy5zb21lKGwgPT4gbiA9PT0gbCk7XG4gICAgfVxuXG4gICAgYXN5bmMgc2V0dXBBc3luYyhsb2NhbGUpIHtcbiAgICAgICAgaWYgKCF0aGlzLmlzTG9jYWxlU3VwcG9ydGVkKGxvY2FsZSkpIHJldHVybiBQcm9taXNlLnJlamVjdCgndW5zdXBwb3J0ZWRfbG9jYWxlJyk7XG5cbiAgICAgICAgdGhpcy5kaWN0aW9uYXJ5ID0ge307XG5cbiAgICAgICAgdGhpcy5sb2NhbGUgPSBJMThuLm5vcm1hbGl6ZUxvY2FsZShsb2NhbGUgfHwgdGhpcy5zdXBwb3J0ZWRMb2NhbGVzWzBdKTtcbiAgICAgICAgdGhpcy5tb21lbnRMb2NhbGUgPSBJMThuLmxvY2FsZVRvRGFzaCh0aGlzLmxvY2FsZSkudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgdGhpcy5tb21lbnRUaW1lem9uZSA9IFV0aWwudGltZXpvbmU7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgZ2V0VGV4dCh0b2tlbiwgdmFsdWVzLCBkZWZhdWx0VGV4dCkge1xuICAgICAgICBpZiAoVXRpbC5fLmlzU3RyaW5nKHZhbHVlcykpIHtcbiAgICAgICAgICAgIGRlZmF1bHRUZXh0ID0gdmFsdWVzO1xuICAgICAgICAgICAgdmFsdWVzID0gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIHZhciBwaHJhc2UgPSBVdGlsLmdldFZhbHVlQnlQYXRoKHRoaXMuZGljdGlvbmFyeSwgdG9rZW4pO1xuXG4gICAgICAgIGlmICh1dGlsLmlzTnVsbE9yVW5kZWZpbmVkKHBocmFzZSkpIHtcbiAgICAgICAgICAgIHBocmFzZSA9IGRlZmF1bHRUZXh0O1xuXG4gICAgICAgICAgICBpZiAocGhyYXNlKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMucmV2ZXJzZVVwZGF0ZSkgdGhpcy5hZGRUb0RpY3Rpb25hcnkodG9rZW4sIHBocmFzZSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHBocmFzZSA9IHRva2VuO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKHV0aWwuaXNPYmplY3QocGhyYXNlKSkge1xuICAgICAgICAgICAgcGhyYXNlID0gcGhyYXNlWyd0ZXh0J107XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gVXRpbC5fLmlzRW1wdHkodmFsdWVzKSA/IHBocmFzZSA6IFV0aWwudGVtcGxhdGUocGhyYXNlLCB2YWx1ZXMpO1xuICAgIH1cblxuICAgIGFkZFRvRGljdGlvbmFyeSh0b2tlbiwgdGV4dCwgc2F2ZUltbWVkaWF0ZSkge1xuICAgICAgICBpZiAodGhpcy51cGRhdGVXaXRoTWV0YSkge1xuICAgICAgICAgICAgdGV4dCA9IHsgdGV4dDogdGV4dCwgY29tbWVudDogJ0FkZGVkIGF0ICcgKyB0aGlzLmRhdGV0aW1lKCkuZm9ybWF0KCkgfVxuICAgICAgICB9XG5cbiAgICAgICAgVXRpbC5zZXRWYWx1ZUJ5UGF0aCh0aGlzLmRpY3Rpb25hcnksIHRva2VuLCB0ZXh0KTtcblxuICAgICAgICB0aGlzLnBlbmRpbmdVcGRhdGVzW3Rva2VuXSA9IHRleHQ7XG5cbiAgICAgICAgaWYgKHNhdmVJbW1lZGlhdGUpIHtcbiAgICAgICAgICAgIHRoaXMuc2F2ZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgc2F2ZSgpIHtcbiAgICAgICAgdGhpcy5wZW5kaW5nVXBkYXRlcyA9IHt9O1xuICAgIH1cblxuICAgIGRhdGV0aW1lKHZhbHVlLCB0aW1lem9uZSkge1xuICAgICAgICB0aW1lem9uZSB8fCAodGltZXpvbmUgPSB0aGlzLnRpbWV6b25lKTtcblxuICAgICAgICB2YXIgciA9IHRoaXMubW9tZW50VGltZXpvbmUodmFsdWUpLmxvY2FsZSh0aGlzLm1vbWVudExvY2FsZSk7XG5cbiAgICAgICAgcmV0dXJuIHRpbWV6b25lID8gci50eih0aW1lem9uZSkgOiByO1xuICAgIH1cblxuICAgIGZsdXNoKCkge1xuICAgICAgICBpZiAodGhpcy5yZXZlcnNlVXBkYXRlKSB7IHRoaXMuc2F2ZSgpOyB9XG4gICAgfVxuXG4gICAgZ2V0IGRhc2hGb3JtKCkge1xuICAgICAgICByZXR1cm4gSTE4bi5sb2NhbGVUb0Rhc2godGhpcy5sb2NhbGUpO1xuICAgIH1cblxuICAgIHN0YXRpYyBub3JtYWxpemVMb2NhbGUobG9jYWxlKSB7XG4gICAgICAgIHZhciBsID0gbG9jYWxlLnJlcGxhY2UoJy0nLCAnXycpLnNwbGl0KCdfJywgMik7XG4gICAgICAgIHZhciBsMiA9IGxbMF0udG9Mb3dlckNhc2UoKTtcbiAgICAgICAgaWYgKGwubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgbDIgKz0gJ18nICsgbFsxXS50b1VwcGVyQ2FzZSgpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBsMjtcbiAgICB9XG5cbiAgICBzdGF0aWMgbG9jYWxlVG9EYXNoKGxvY2FsZSkge1xuICAgICAgICByZXR1cm4gbG9jYWxlLnJlcGxhY2UoJ18nLCAnLScpO1xuICAgIH1cblxuICAgIHN0YXRpYyBleHRyYWN0TGFuZ3VhZ2VDb2RlKGxvY2FsZSkge1xuICAgICAgICB2YXIgcG9zID0gbG9jYWxlLmxhc3RJbmRleE9mKCdfJyk7XG4gICAgICAgIGlmIChwb3MgPT0gLTEpIHJldHVybiBsb2NhbGU7XG5cbiAgICAgICAgcmV0dXJuIGxvY2FsZS5zdWJzdHIoMCwgcG9zKTtcbiAgICB9XG5cbiAgICBzdGF0aWMgZXh0cmFjdENvdW50cnlDb2RlKGxvY2FsZSkge1xuICAgICAgICB2YXIgcG9zID0gbG9jYWxlLmxhc3RJbmRleE9mKCdfJyk7XG4gICAgICAgIGlmIChwb3MgPT0gLTEpIHJldHVybiAnJztcblxuICAgICAgICByZXR1cm4gbG9jYWxlLnN1YnN0cihwb3MgKyAxKTtcbiAgICB9ICAgIFxufVxuXG5jbGFzcyBGaWxlSTE4biBleHRlbmRzIEkxOG4ge1xuXG4gICAgY29uc3RydWN0b3IoY29uZmlnKSB7XG4gICAgICAgIHN1cGVyKGNvbmZpZyk7XG5cbiAgICAgICAgY29uZmlnIHx8IChjb25maWcgPSB7fSk7XG5cbiAgICAgICAgdGhpcy5kaXJlY3RvcnkgPSBjb25maWcuZGlyZWN0b3J5IHx8ICcuL2xvY2FsZSc7XG4gICAgfVxuXG4gICAgYXN5bmMgc2V0dXBBc3luYyhsb2NhbGUpIHtcbiAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XG5cbiAgICAgICAgZnVuY3Rpb24gbG9hZERpcihkaWN0LCBkaXIsIGZpbmlzaCkge1xuICAgICAgICAgICAgVXRpbC5mcy5yZWFkZGlyKGRpciwgZnVuY3Rpb24gKGVyciwgZmlsZXMpIHtcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSByZXR1cm4gZmluaXNoKGVycik7XG5cbiAgICAgICAgICAgICAgICBVdGlsLmFzeW5jLmVhY2goZmlsZXMsIGZ1bmN0aW9uIChmaWxlLCBjYikge1xuICAgICAgICAgICAgICAgICAgICBsZXQgbGFuZ0ZpbGVQYXRoID0gcGF0aC5qb2luKGRpciwgZmlsZSk7XG4gICAgICAgICAgICAgICAgICAgIGxldCBzdGF0cyA9IFV0aWwuZnMuc3RhdFN5bmMobGFuZ0ZpbGVQYXRoKTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdHMuaXNEaXJlY3RvcnkoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZGljdFtmaWxlXSA9IHt9O1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxvYWREaXIoZGljdFtmaWxlXSwgbGFuZ0ZpbGVQYXRoLCBjYik7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBsZXQgZXh0TmFtZSA9IHBhdGguZXh0bmFtZShmaWxlKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV4dE5hbWUudG9Mb3dlckNhc2UoKSAhPT0gJy5qc29uJykgcmV0dXJuIGNiKCk7XG5cbiAgICAgICAgICAgICAgICAgICAgVXRpbC5mcy5yZWFkSnNvbihsYW5nRmlsZVBhdGgsIGZ1bmN0aW9uIChlcnIsIGNvbnRlbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHJldHVybiBjYihlcnIpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgYmFzZW5hbWUgPSBwYXRoLmJhc2VuYW1lKGZpbGUsIGV4dE5hbWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZGljdFtiYXNlbmFtZV0gPSBjb250ZW50O1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBjYigpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIH0sIGZpbmlzaCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBzdXBlci5zZXR1cEFzeW5jKGxvY2FsZSkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICBsZXQgbGFuZ1BhdGggPSBwYXRoLnJlc29sdmUoc2VsZi5kaXJlY3RvcnksICdsYW5nJyk7XG5cbiAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IHAgPSBwYXRoLmpvaW4obGFuZ1BhdGgsIHNlbGYubG9jYWxlKTtcblxuICAgICAgICAgICAgICAgIGlmICghVXRpbC5mcy5leGlzdHNTeW5jKHApKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vdHJ5IG9ubHkgbGFuZ3VhZ2UgY29kZVxuICAgICAgICAgICAgICAgICAgICBsZXQgbGFuZyA9IEkxOG4uZXh0cmFjdExhbmd1YWdlQ29kZShzZWxmLmxvY2FsZSk7XG4gICAgICAgICAgICAgICAgICAgIHAgPSBwYXRoLmpvaW4obGFuZ1BhdGgsIGxhbmcpO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmICghVXRpbC5mcy5leGlzdHNTeW5jKHApKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZShzZWxmKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGxvYWREaXIoc2VsZi5kaWN0aW9uYXJ5LCBwLCAoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHJldHVybiByZWplY3QoZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShzZWxmKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBzYXZlKCkge1xuICAgICAgICB2YXIgZmlsZVNldCA9IG5ldyBTZXQoKTtcblxuICAgICAgICBVdGlsLl8uZm9yT3duKHRoaXMucGVuZGluZ1VwZGF0ZXMsICh2LCBrKSA9PiB7XG4gICAgICAgICAgICBsZXQga2V5d29yZCA9IHBhdGguZXh0bmFtZShrKTtcbiAgICAgICAgICAgIGxldCBwID0gcGF0aC5iYXNlbmFtZShrLCBrZXl3b3JkKTtcbiAgICAgICAgICAgIGZpbGVTZXQuYWRkKHApO1xuICAgICAgICB9KTtcblxuICAgICAgICB2YXIgbGFuZ1BhdGggPSBwYXRoLnJlc29sdmUodGhpcy5kaXJlY3RvcnksICdsYW5nJyk7XG4gICAgICAgIHZhciBicCA9IHBhdGguam9pbihsYW5nUGF0aCwgdGhpcy5sb2NhbGUpO1xuXG4gICAgICAgIGZvciAobGV0IHAgb2YgZmlsZVNldCkge1xuICAgICAgICAgICAgbGV0IGNvbnRlbnQgPSBVdGlsLmdldFZhbHVlQnlQYXRoKHRoaXMuZGljdGlvbmFyeSwgcCk7XG4gICAgICAgICAgICBsZXQgZiA9IFV0aWwucmVwbGFjZUFsbChwLCAnLicsIHBhdGguZGVsaW1pdGVyKSArICcuanNvbic7XG5cbiAgICAgICAgICAgIFV0aWwuZnMub3V0cHV0SnNvblN5bmMocGF0aC5qb2luKGJwLCBmKSwgY29udGVudCk7XG4gICAgICAgIH1cblxuICAgICAgICBmaWxlU2V0LmNsZWFyKCk7XG5cbiAgICAgICAgc3VwZXIuc2F2ZSgpO1xuICAgIH1cbn1cblxuSTE4bi5GaWxlID0gRmlsZUkxOG47XG5cbm1vZHVsZS5leHBvcnRzID0gSTE4bjsiXX0=