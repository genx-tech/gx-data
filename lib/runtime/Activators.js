"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const {
  OolongUsageError,
  BusinessError
} = require('./Errors');

module.exports = {
  datetimeAdd: function (model, context, startTime, duration) {
    return startTime.plus(duration);
  },
  isEqual: function (model, context, value1, value2) {
    return value1 === value2;
  },
  triggerUpdate: function (model, context, value, condition) {
    return condition ? value : null;
  },
  sum: (model, context, ...args) => args.reduce((sum, v) => sum += v, 0),
  multiply: (model, context, multiplier, multiplicand) => multiplier * multiplicand,
  populate: async (model, context, assoc, options) => {
    let parts = assoc.split('.');

    if (!(parts.length > 1)) {
      throw new Error("Assertion failed: parts.length > 1");
    }

    let selectedField = parts.pop();
    let remoteAssoc = parts.join('.');
    let localAssoc = parts.shift();
    let interAssoc;

    if (parts.length > 0) {
      interAssoc = parts.join('.');
    }

    if (!context.latest.hasOwnProperty(localAssoc)) {
      return undefined;
    }

    let assocValue = context.latest[localAssoc];

    if (_.isNil(assocValue)) {
      throw new OolongUsageError(`The value of referenced association "${localAssoc}" of entity "${model.meta.name}" should not be null.`);
    }

    let assocMeta = model.meta.associations[localAssoc];

    if (!assocMeta) {
      throw new OolongUsageError(`"${localAssoc}" is not an association field of entity "${model.meta.name}".`);
    }

    if (assocMeta.list) {
      throw new OolongUsageError(`"${localAssoc}" entity "${model.meta.name}" is a list-style association which is not supported by the built-in populate Activators.`);
    }

    let remoteEntity = context.populated && context.populated[remoteAssoc];

    if (!remoteEntity) {
      if (options && options.useCache) {
        remoteEntity = (await model.db.model(assocMeta.entity).cached_(assocMeta.key, interAssoc ? [interAssoc] : null, context.connOptions))[assocValue];
      } else {
        let findOptions = {
          $query: {
            [assocMeta.key]: assocValue
          }
        };

        if (interAssoc) {
          findOptions.$associations = [interAssoc];
        }

        await model.ensureTransaction_(context);
        remoteEntity = await model.db.model(assocMeta.entity).findOne_(findOptions, context.connOptions);
      }

      if (!remoteEntity) {
        throw new BusinessError(`Unable to find the "${assocMeta.entity}" with [${assocMeta.key}=${assocValue}].`);
      }

      context.populated || (context.populated = {});
      context.populated[localAssoc] = remoteEntity;
      let currentAssoc = localAssoc;

      while (parts.length > 0) {
        let nextAssoc = parts.shift();
        remoteEntity = remoteEntity[':' + nextAssoc];

        if (!!Array.isArray(remoteEntity)) {
          throw new Error("Assertion failed: !Array.isArray(remoteEntity)");
        }

        currentAssoc = currentAssoc + '.' + nextAssoc;
        context.populated[currentAssoc] = remoteEntity;
      }
    }

    if (!remoteEntity.hasOwnProperty(selectedField)) {
      throw new OolongUsageError(`"${selectedField}" is not a field of remote association "${remoteAssoc}" of entity "${model.meta.name}".`);
    }

    return remoteEntity[selectedField];
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ydW50aW1lL0FjdGl2YXRvcnMuanMiXSwibmFtZXMiOlsiXyIsInJlcXVpcmUiLCJPb2xvbmdVc2FnZUVycm9yIiwiQnVzaW5lc3NFcnJvciIsIm1vZHVsZSIsImV4cG9ydHMiLCJkYXRldGltZUFkZCIsIm1vZGVsIiwiY29udGV4dCIsInN0YXJ0VGltZSIsImR1cmF0aW9uIiwicGx1cyIsImlzRXF1YWwiLCJ2YWx1ZTEiLCJ2YWx1ZTIiLCJ0cmlnZ2VyVXBkYXRlIiwidmFsdWUiLCJjb25kaXRpb24iLCJzdW0iLCJhcmdzIiwicmVkdWNlIiwidiIsIm11bHRpcGx5IiwibXVsdGlwbGllciIsIm11bHRpcGxpY2FuZCIsInBvcHVsYXRlIiwiYXNzb2MiLCJvcHRpb25zIiwicGFydHMiLCJzcGxpdCIsImxlbmd0aCIsInNlbGVjdGVkRmllbGQiLCJwb3AiLCJyZW1vdGVBc3NvYyIsImpvaW4iLCJsb2NhbEFzc29jIiwic2hpZnQiLCJpbnRlckFzc29jIiwibGF0ZXN0IiwiaGFzT3duUHJvcGVydHkiLCJ1bmRlZmluZWQiLCJhc3NvY1ZhbHVlIiwiaXNOaWwiLCJtZXRhIiwibmFtZSIsImFzc29jTWV0YSIsImFzc29jaWF0aW9ucyIsImxpc3QiLCJyZW1vdGVFbnRpdHkiLCJwb3B1bGF0ZWQiLCJ1c2VDYWNoZSIsImRiIiwiZW50aXR5IiwiY2FjaGVkXyIsImtleSIsImNvbm5PcHRpb25zIiwiZmluZE9wdGlvbnMiLCIkcXVlcnkiLCIkYXNzb2NpYXRpb25zIiwiZW5zdXJlVHJhbnNhY3Rpb25fIiwiZmluZE9uZV8iLCJjdXJyZW50QXNzb2MiLCJuZXh0QXNzb2MiLCJBcnJheSIsImlzQXJyYXkiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTTtBQUFFQSxFQUFBQTtBQUFGLElBQVFDLE9BQU8sQ0FBQyxVQUFELENBQXJCOztBQUNBLE1BQU07QUFBRUMsRUFBQUEsZ0JBQUY7QUFBb0JDLEVBQUFBO0FBQXBCLElBQXNDRixPQUFPLENB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QUFDQXpDLE1BQUFBLE9BQU8sQ0FBQ3lDLFNBQVIsQ0FBa0JkLFVBQWxCLElBQWdDYSxZQUFoQztBQUVBLFVBQUlhLFlBQVksR0FBRzFCLFVBQW5COztBQUNBLGFBQU9QLEtBQUssQ0FBQ0UsTUFBTixHQUFlLENBQXRCLEVBQXlCO0FBQ3JCLFlBQUlnQyxTQUFTLEdBQUdsQyxLQUFLLENBQUNRLEtBQU4sRUFBaEI7QUFDQVksUUFBQUEsWUFBWSxHQUFHQSxZQUFZLENBQUMsTUFBSWMsU0FBTCxDQUEzQjs7QUFGcUIsYUFHYixDQUFDQyxLQUFLLENBQUNDLE9BQU4sQ0FBY2hCLFlBQWQsQ0FIWTtBQUFBO0FBQUE7O0FBS3JCYSxRQUFBQSxZQUFZLEdBQUdBLFlBQVksR0FBQyxHQUFiLEdBQWlCQyxTQUFoQztBQUNBdEQsUUFBQUEsT0FBTyxDQUFDeUMsU0FBUixDQUFrQlksWUFBbEIsSUFBa0NiLFlBQWxDO0FBQ0g7QUFDSjs7QUFFRCxRQUFJLENBQUNBLFlBQVksQ0FBQ1QsY0FBYixDQUE0QlIsYUFBNUIsQ0FBTCxFQUFpRDtBQUM3QyxZQUFNLElBQUk3QixnQkFBSixDQUFzQixJQUFHNkIsYUFBYywyQ0FBMENFLFdBQVksZ0JBQWUxQixLQUFLLENBQUNvQyxJQUFOLENBQVdDLElBQUssSUFBNUgsQ0FBTjtBQUNIOztBQUVELFdBQU9JLFlBQVksQ0FBQ2pCLGFBQUQsQ0FBbkI7QUFDSDtBQXhGWSxDQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCB7IF8gfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IE9vbG9uZ1VzYWdlRXJyb3IsIEJ1c2luZXNzRXJyb3IgfSA9IHJlcXVpcmUoJy4vRXJyb3JzJyk7XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICAgIGRhdGV0aW1lQWRkOiBmdW5jdGlvbiAobW9kZWwsIGNvbnRleHQsIHN0YXJ0VGltZSwgZHVyYXRpb24pIHtcbiAgICAgICAgcmV0dXJuIHN0YXJ0VGltZS5wbHVzKGR1cmF0aW9uKTtcbiAgICB9LFxuXG4gICAgaXNFcXVhbDogZnVuY3Rpb24gKG1vZGVsLCBjb250ZXh0LCB2YWx1ZTEsIHZhbHVlMikge1xuICAgICAgICByZXR1cm4gdmFsdWUxID09PSB2YWx1ZTI7XG4gICAgfSxcblxuICAgIHRyaWdnZXJVcGRhdGU6IGZ1bmN0aW9uIChtb2RlbCwgY29udGV4dCwgdmFsdWUsIGNvbmRpdGlvbikge1xuICAgICAgICByZXR1cm4gY29uZGl0aW9uID8gdmFsdWUgOiBudWxsO1xuICAgIH0sXG5cbiAgICBzdW06IChtb2RlbCwgY29udGV4dCwgLi4uYXJncykgPT4gYXJncy5yZWR1Y2UoKHN1bSwgdikgPT4gc3VtICs9IHYsIDApLFxuXG4gICAgbXVsdGlwbHk6IChtb2RlbCwgY29udGV4dCwgbXVsdGlwbGllciwgbXVsdGlwbGljYW5kKSA9PiBtdWx0aXBsaWVyKm11bHRpcGxpY2FuZCxcblxuICAgIHBvcHVsYXRlOiBhc3luYyAobW9kZWwsIGNvbnRleHQsIGFzc29jLCBvcHRpb25zKSA9PiB7XG4gICAgICAgIGxldCBwYXJ0cyA9IGFzc29jLnNwbGl0KCcuJyk7XG4gICAgICAgIGFzc2VydDogcGFydHMubGVuZ3RoID4gMTtcblxuICAgICAgICBsZXQgc2VsZWN0ZWRGaWVsZCA9IHBhcnRzLnBvcCgpO1xuICAgICAgICBsZXQgcmVtb3RlQXNzb2MgPSBwYXJ0cy5qb2luKCcuJyk7XG4gICAgICAgIGxldCBsb2NhbEFzc29jID0gcGFydHMuc2hpZnQoKTtcbiAgICAgICAgbGV0IGludGVyQXNzb2M7XG4gICAgICAgIFxuICAgICAgICBpZiAocGFydHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgaW50ZXJBc3NvYyA9IHBhcnRzLmpvaW4oJy4nKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgaWYgKCFjb250ZXh0LmxhdGVzdC5oYXNPd25Qcm9wZXJ0eShsb2NhbEFzc29jKSkge1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBhc3NvY1ZhbHVlID0gY29udGV4dC5sYXRlc3RbbG9jYWxBc3NvY107XG4gICAgICAgIGlmIChfLmlzTmlsKGFzc29jVmFsdWUpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgT29sb25nVXNhZ2VFcnJvcihgVGhlIHZhbHVlIG9mIHJlZmVyZW5jZWQgYXNzb2NpYXRpb24gXCIke2xvY2FsQXNzb2N9XCIgb2YgZW50aXR5IFwiJHttb2RlbC5tZXRhLm5hbWV9XCIgc2hvdWxkIG5vdCBiZSBudWxsLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGFzc29jTWV0YSA9IG1vZGVsLm1ldGEuYXNzb2NpYXRpb25zW2xvY2FsQXNzb2NdO1xuICAgICAgICBpZiAoIWFzc29jTWV0YSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IE9vbG9uZ1VzYWdlRXJyb3IoYFwiJHtsb2NhbEFzc29jfVwiIGlzIG5vdCBhbiBhc3NvY2lhdGlvbiBmaWVsZCBvZiBlbnRpdHkgXCIke21vZGVsLm1ldGEubmFtZX1cIi5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChhc3NvY01ldGEubGlzdCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IE9vbG9uZ1VzYWdlRXJyb3IoYFwiJHtsb2NhbEFzc29jfVwiIGVudGl0eSBcIiR7bW9kZWwubWV0YS5uYW1lfVwiIGlzIGEgbGlzdC1zdHlsZSBhc3NvY2lhdGlvbiB3aGljaCBpcyBub3Qgc3VwcG9ydGVkIGJ5IHRoZSBidWlsdC1pbiBwb3B1bGF0ZSBBY3RpdmF0b3JzLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgLy9sb2NhbCBjYWNoZSBpbiBjb250ZXh0LCBzaGFyZWQgYnkgb3RoZXIgZmllbGRzIGlmIGFueSBcbiAgICAgICAgbGV0IHJlbW90ZUVudGl0eSA9IGNvbnRleHQucG9wdWxhdGVkICYmIGNvbnRleHQucG9wdWxhdGVkW3JlbW90ZUFzc29jXTtcbiAgICAgICAgaWYgKCFyZW1vdGVFbnRpdHkpIHtcbiAgICAgICAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMudXNlQ2FjaGUpIHtcbiAgICAgICAgICAgICAgICByZW1vdGVFbnRpdHkgPSAoYXdhaXQgbW9kZWwuZGIubW9kZWwoYXNzb2NNZXRhLmVudGl0eSkuY2FjaGVkXyhhc3NvY01ldGEua2V5LCBpbnRlckFzc29jID8gWyBpbnRlckFzc29jIF0gOiBudWxsLCBjb250ZXh0LmNvbm5PcHRpb25zKSlbYXNzb2NWYWx1ZV07ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBsZXQgZmluZE9wdGlvbnMgPSB7ICRxdWVyeTogeyBbYXNzb2NNZXRhLmtleV06IGFzc29jVmFsdWUgfSB9O1xuXG4gICAgICAgICAgICAgICAgaWYgKGludGVyQXNzb2MpIHtcbiAgICAgICAgICAgICAgICAgICAgZmluZE9wdGlvbnMuJGFzc29jaWF0aW9ucyA9IFsgaW50ZXJBc3NvYyBdO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGF3YWl0IG1vZGVsLmVuc3VyZVRyYW5zYWN0aW9uXyhjb250ZXh0KTtcblxuICAgICAgICAgICAgICAgIHJlbW90ZUVudGl0eSA9IGF3YWl0IG1vZGVsLmRiLm1vZGVsKGFzc29jTWV0YS5lbnRpdHkpLmZpbmRPbmVfKGZpbmRPcHRpb25zLCBjb250ZXh0LmNvbm5PcHRpb25zKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFyZW1vdGVFbnRpdHkpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQnVzaW5lc3NFcnJvcihgVW5hYmxlIHRvIGZpbmQgdGhlIFwiJHthc3NvY01ldGEuZW50aXR5fVwiIHdpdGggWyR7YXNzb2NNZXRhLmtleX09JHthc3NvY1ZhbHVlfV0uYCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnRleHQucG9wdWxhdGVkIHx8IChjb250ZXh0LnBvcHVsYXRlZCA9IHt9KTtcbiAgICAgICAgICAgIGNvbnRleHQucG9wdWxhdGVkW2xvY2FsQXNzb2NdID0gcmVtb3RlRW50aXR5O1xuXG4gICAgICAgICAgICBsZXQgY3VycmVudEFzc29jID0gbG9jYWxBc3NvYztcbiAgICAgICAgICAgIHdoaWxlIChwYXJ0cy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgbGV0IG5leHRBc3NvYyA9IHBhcnRzLnNoaWZ0KCk7XG4gICAgICAgICAgICAgICAgcmVtb3RlRW50aXR5ID0gcmVtb3RlRW50aXR5Wyc6JytuZXh0QXNzb2NdO1xuICAgICAgICAgICAgICAgIGFzc2VydDogIUFycmF5LmlzQXJyYXkocmVtb3RlRW50aXR5KTtcblxuICAgICAgICAgICAgICAgIGN1cnJlbnRBc3NvYyA9IGN1cnJlbnRBc3NvYysnLicrbmV4dEFzc29jO1xuICAgICAgICAgICAgICAgIGNvbnRleHQucG9wdWxhdGVkW2N1cnJlbnRBc3NvY10gPSByZW1vdGVFbnRpdHk7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFyZW1vdGVFbnRpdHkuaGFzT3duUHJvcGVydHkoc2VsZWN0ZWRGaWVsZCkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBPb2xvbmdVc2FnZUVycm9yKGBcIiR7c2VsZWN0ZWRGaWVsZH1cIiBpcyBub3QgYSBmaWVsZCBvZiByZW1vdGUgYXNzb2NpYXRpb24gXCIke3JlbW90ZUFzc29jfVwiIG9mIGVudGl0eSBcIiR7bW9kZWwubWV0YS5uYW1lfVwiLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlbW90ZUVudGl0eVtzZWxlY3RlZEZpZWxkXTtcbiAgICB9XG59OyJdfQ==