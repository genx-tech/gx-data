"use strict";

require("source-map-support/register");

const {
  _,
  waitUntil_
} = require('rk-utils');

const {
  tryRequire
} = require('@k-suite/app/lib/utils/Helpers');

const mongodb = tryRequire('mongodb');
const {
  MongoClient,
  GridFSBucket
} = mongodb;

const Connector = require('../../Connector');

const UpdateOpsField = ['$currentDate', '$inc', '$min', '$max', '$mul', '$rename', '$set', '$setOnInsert', '$unset'];
const UpdateOpsArray = ['$addToSet', '$pop', '$pull', '$push', '$pullAll'];
const UpdateOps = UpdateOpsField.concat(UpdateOpsArray);

class MongodbConnector extends Connector {
  constructor(connectionString, options) {
    super('mongodb', connectionString, options);
    this.findAll_ = this.find_;
  }

  async end_() {
    if (this.client && this.client.isConnected()) {
      await this.client.close();
    }

    delete this.client;
  }

  async connect_() {
    if (!this.client || !this.client.isConnected()) {
      let client = new MongoClient(this.connectionString, {
        useNewUrlParser: true
      });
      this.client = await client.connect();
    }

    return this.client.db(this.database);
  }

  async execute_(dbExecutor) {
    let db;

    try {
      db = await this.connect_();
      return await dbExecutor(db);
    } catch (err) {
      throw err;
    } finally {
      db && (await this.disconnect_(db));
    }
  }

  async disconnect_(conn) {}

  async ping_() {
    return this.execute_(db => {
      return db.listCollections(null, {
        nameOnly: true
      }).toArray();
    });
  }

  async createGridFSBucket_(options) {
    let db = await this.connect_();
    return new GridFSBucket(db, options);
  }

  async insertOne_(model, data, options) {
    return this.onCollection_(model, coll => coll.insertOne(data, {
      bypassDocumentValidation: true,
      ...options
    }));
  }

  async insertMany_(model, data, options) {
    return this.onCollection_(model, coll => coll.insertMany(data, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async insertOneIfNotExist_(model, data, options) {
    try {
      return await this.insertOne_(model, data, options);
    } catch (error) {
      if (error.code === 11000) {
        return false;
      }

      throw error;
    }
  }

  async findOneAndReplace_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndReplace(condition, data, options));
  }

  async findOneAndUpdate_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndUpdate(condition, this._translateUpdate(data), options));
  }

  async findOneAndDelete_(model, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndDelete(condition, options));
  }

  async findOne_(model, condition, options) {
    return this.onCollection_(model, coll => coll.findOne(condition, options));
  }

  async updateOne_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.updateOne(condition, this._translateUpdate(data), options));
  }

  async upsertOne_(model, data, condition, options, retry) {
    return this.onCollection_(model, async coll => {
      let current,
          locked = false;

      try {
        do {
          current = await coll.findOneAndUpdate(condition, {
            $set: {
              __lock__: true
            }
          });
        } while (current.value && current.value.__lock__);

        if (current.value) {
          locked = true;
          return await coll.updateOne({
            _id: current.value._id
          }, {
            $set: _.omit(data, ['_id']),
            $unset: {
              __lock__: ""
            }
          }, {
            bypassDocumentValidation: true,
            ...options
          });
        }

        try {
          return await coll.insertOne(data, {
            bypassDocumentValidation: true,
            ...options
          });
        } catch (error2) {
          if (!retry && error2.message.startsWith('E11000 duplicate key error')) {
            return this.upsertOne_(model, data, condition, options, true);
          }

          throw error2;
        }
      } catch (error) {
        if (locked) {
          await coll.updateOne({
            _id: current.value._id
          }, {
            $unset: {
              __lock__: ""
            }
          });
        }

        throw error;
      }
    });
  }

  async upsertMany_(model, data, uniqueKeys, options) {
    let ops = data.map(record => {
      let {
        _id,
        ...updateData
      } = record;
      let updateOp = {
        $set: updateData
      };

      if (_id) {
        updateOp.$setOnInsert = {
          _id
        };
      }

      return {
        updateOne: {
          filter: { ..._.pick(record, uniqueKeys)
          },
          update: updateOp,
          upsert: true
        }
      };
    });
    return this.onCollection_(model, coll => coll.bulkWrite(ops, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async insertManyIfNotExist_(model, data, uniqueKeys, options) {
    let ops = data.map(record => ({
      updateOne: {
        filter: { ..._.pick(record, uniqueKeys)
        },
        update: {
          $setOnInsert: record
        },
        upsert: true
      }
    }));
    return this.onCollection_(model, coll => coll.bulkWrite(ops, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async updateMany_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.updateMany(condition, this._translateUpdate(data), options));
  }

  async replaceOne_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.replaceOne(condition, data, options));
  }

  async deleteOne_(model, condition, options) {
    return this.onCollection_(model, coll => coll.deleteOne(condition, options));
  }

  async deleteMany_(model, condition, options) {
    return this.onCollection_(model, coll => coll.deleteMany(condition, options));
  }

  async find_(model, condition, options) {
    return this.onCollection_(model, async coll => {
      let queryOptions = { ...options
      };
      let query = {};

      if (condition) {
        let {
          $projection,
          $orderBy,
          $offset,
          $limit,
          $query,
          ...others
        } = condition;

        if ($projection) {
          queryOptions.projection = $projection;
        }

        if ($orderBy) {
          queryOptions.sort = $orderBy;
        }

        if ($offset) {
          queryOptions.skip = $offset;
        }

        if ($limit) {
          queryOptions.limit = $limit;
        }

        Object.assign(query, _.pickBy(others, (v, k) => k[0] !== '$'));

        if ($query) {
          Object.assign(query, $query);
        }
      }

      let result = await coll.find(query, queryOptions).toArray();

      if (condition && condition.$totalCount) {
        let totalCount = await coll.find(query).count();
        return [result, totalCount];
      }

      return result;
    });
  }

  async onCollection_(model, executor) {
    return this.execute_(db => executor(db.collection(model)));
  }

  _translateUpdate(update) {
    let ops = _.pick(update, UpdateOps);

    let others = _.omit(update, UpdateOps);

    if (ops.$set) {
      ops.$set = { ...ops.$set,
        ...others
      };
    } else if (!_.isEmpty(others)) {
      ops.$set = others;
    }

    return ops;
  }

}

module.exports = MongodbConnector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9ydW50aW1lL2RyaXZlcnMvbW9uZ29kYi9Db25uZWN0b3IuanMiXSwibmFtZXMiOlsiXyIsIndhaXRVbnRpbF8iLCJyZXF1aXJlIiwidHJ5UmVxdWlyZSIsIm1vbmdvZGIiLCJNb25nb0NsaWVudCIsIkdyaWRGU0J1Y2tldCIsIkNvbm5lY3RvciIsIlVwZGF0ZU9wc0ZpZWxkIiwiVXBkYXRlT3BzQXJyYXkiLCJVcGRhdGVPcHMiLCJjb25jYXQiLCJNb25nb2RiQ29ubmVjdG9yIiwiY29uc3RydWN0b3IiLCJjb25uZWN0aW9uU3RyaW5nIiwib3B0aW9ucyIsImZpbmRBbGxfIiwiZmluZF8iLCJlbmRfIiwiY2xpZW50IiwiaXNDb25uZWN0ZWQiLCJjbG9zZSIsImNvbm5lY3RfIiwidXNlTmV3VXJsUGFyc2VyIiwiY29ubmVjdCIsImRiIiwiZGF0YWJhc2UiLCJleGVjdXRlXyIsImRiRXhlY3V0b3IiLCJlcnIiLCJkaXNjb25uZWN0XyIsImNvbm4iLCJwaW5nXyIsImxpc3RDb2xsZWN0aW9ucyIsIm5hbWVPbmx5IiwidG9BcnJheSIsImNyZWF0ZUdyaWRGU0J1Y2tldF8iLCJpbnNlcnRPbmVfIiwibW9kZWwiLCJkYXRhIiwib25Db2xsZWN0aW9uXyIsImNvbGwiLCJpbnNlcnRPbmUiLCJieXBhc3NEb2N1bWVudFZhbGlkYXRpb24iLCJpbnNlcnRNYW55XyIsImluc2VydE1hbnkiLCJvcmRlcmVkIiwiaW5zZXJ0T25lSWZOb3RFeGlzdF8iLCJlcnJvciIsImNvZGUiLCJmaW5kT25lQW5kUmVwbGFjZV8iLCJjb25kaXRpb24iLCJmaW5kT25lQW5kUmVwbGFjZSIsImZpbmRPbmVBbmRVcGRhdGVfIiwiZmluZE9uZUFuZFVwZGF0ZSIsIl90cmFuc2xhdGVVcGRhdGUiLCJmaW5kT25lQW5kRGVsZXRlXyIsImZpbmRPbmVBbmREZWxldGUiLCJmaW5kT25lXyIsImZpbmRPbmUiLCJ1cGRhdGVPbmVfIiwidXBkYXRlT25lIiwidXBzZXJ0T25lXyIsInJldHJ5IiwiY3VycmVudCIsImxvY2tlZCIsIiRzZXQiLCJfX2xvY2tfXyIsInZhbHVlIiwiX2lkIiwib21pdCIsIiR1bnNldCIsImVycm9yMiIsIm1lc3NhZ2UiLCJzdGFydHNXaXRoIiwidXBzZXJ0TWFueV8iLCJ1bmlxdWVLZXlzIiwib3BzIiwibWFwIiwicmVjb3JkIiwidXBkYXRlRGF0YSIsInVwZGF0ZU9wIiwiJHNldE9uSW5zZXJ0IiwiZmlsdGVyIiwicGljayIsInVwZGF0ZSIsInVwc2VydCIsImJ1bGtXcml0ZSIsImluc2VydE1hbnlJZk5vdEV4aXN0XyIsInVwZGF0ZU1hbnlfIiwidXBkYXRlTWFueSIsInJlcGxhY2VPbmVfIiwicmVwbGFjZU9uZSIsImRlbGV0ZU9uZV8iLCJkZWxldGVPbmUiLCJkZWxldGVNYW55XyIsImRlbGV0ZU1hbnkiLCJxdWVyeU9wdGlvbnMiLCJxdWVyeSIsIiRwcm9qZWN0aW9uIiwiJG9yZGVyQnkiLCIkb2Zmc2V0IiwiJGxpbWl0IiwiJHF1ZXJ5Iiwib3RoZXJzIiwicHJvamVjdGlvbiIsInNvcnQiLCJza2lwIiwibGltaXQiLCJPYmplY3QiLCJhc3NpZ24iLCJwaWNrQnkiLCJ2IiwiayIsInJlc3VsdCIsImZpbmQiLCIkdG90YWxDb3VudCIsInRvdGFsQ291bnQiLCJjb3VudCIsImV4ZWN1dG9yIiwiY29sbGVjdGlvbiIsImlzRW1wdHkiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTTtBQUFFQSxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBO0FBQUwsSUFBb0JDLE9BQU8sQ0FBQyxVQUFELENBQWpDOztBQUNBLE1BQU07QUFBRUMsRUFBQUE7QUFBRixJQUFpQkQsT0FBTyxDQUFDLGdDQUFELENBQTlCOztBQUNBLE1BQU1FLE9BQU8sR0FBR0QsVUFBVSxDQUFDLFNBQUQsQ0FBMUI7QUFDQSxNQUFNO0FBQUVFLEVBQUFBLFdBQUY7QUFBZUMsRUFBQUE7QUFBZixJQUFnQ0YsT0FBdEM7O0FBQ0EsTUFBTUcsU0FBUyxHQUFHTCxPQUFPLENBQUMsaUJBQUQsQ0FBekI7O0FBRUEsTUFBTU0sY0FBYyxHQUFHLENBQUUsY0FBRixFQUFrQixNQUFsQixFQUEwQixNQUExQixFQUFrQyxNQUFsQyxFQUEwQyxNQUExQyxFQUFrRCxTQUFsRCxFQUE2RCxNQUE3RCxFQUFxRSxjQUFyRSxFQUFxRixRQUFyRixDQUF2QjtBQUNBLE1BQU1DLGNBQWMsR0FBRyxDQUFFLFdBQUYsRUFBZSxNQUFmLEVBQXVCLE9BQXZCLEVBQWdDLE9BQWhDLEVBQXlDLFVBQXpDLENBQXZCO0FBQ0EsTUFBTUMsU0FBUyxHQUFHRixjQUFjLENBQUNHLE1BQWYsQ0FBc0JGLGNBQXRCLENBQWxCOztBQU9BLE1BQU1HLGdCQUFOLFNBQStCTCxTQUEvQixDQUF5QztBQU1yQ00sRUFBQUEsV0FBVyxDQUFDQyxnQkFBRCxFQUFtQkMsT0FBbkIsRUFBNEI7QUFDbkMsVUFBTSxTQUFOLEVBQWlCRCxnQkFBakIsRUFBbUNDLE9BQW5DO0FBRG1DLFNBSXZDQyxRQUp1QyxHQUk1QixLQUFLQyxLQUp1QjtBQUV0Qzs7QUFPRCxRQUFNQyxJQUFOLEdBQWE7QUFDVCxRQUFJLEtBQUtDLE1BQUwsSUFBZSxLQUFLQSxNQUFMLENBQVlDLFdBQVosRUFBbkIsRUFBOEM7QUFDMUMsWUFBTSxLQUFLRCxNQUFMLENBQVlFLEtBQVosRUFBTjtBQUNIOztBQUVELFdBQU8sS0FBS0YsTUFBWjtBQUNIOztBQVNELFFBQU1HLFFBQU4sR0FBaUI7QUFDYixRQUFJLENBQUMsS0FBS0gsTUFBTixJQUFnQixDQUFDLEtBQUtBLE1BQUwsQ0FBWUMsV0FBWixFQUFyQixFQUFnRDtBQUM1QyxVQUFJRCxNQUFNLEdBQUcsSUFBSWQsV0FBSixDQUFnQixLQUFLUyxnQkFBckIsRUFBdUM7QUFBQ1MsUUFBQUEsZUFBZSxFQUFFO0FBQWxCLE9BQXZDLENBQWI7QUFDQSxXQUFLSixNQUFMLEdBQWMsTUFBTUEsTUFBTSxDQUFDSyxPQUFQLEVBQXBCO0FBQ0g7O0FBRUQsV0FBTyxLQUFLTCxNQUFMLENBQVlNLEVBQVosQ0FBZSxLQUFLQyxRQUFwQixDQUFQO0FBQ0g7O0FBRUQsUUFBTUMsUUFBTixDQUFlQyxVQUFmLEVBQTJCO0FBQ3ZCLFFBQUlILEVBQUo7O0FBRUEsUUFBSTtBQUNBQSxNQUFBQSxFQUFFLEdBQUcsTUFBTSxLQUFLSCxRQUFMLEVBQVg7QUFFQSxhQUFPLE1BQU1NLFVBQVUsQ0FBQ0gsRUFBRCxDQUF2QjtBQUNILEtBSkQsQ0FJRSxPQUFNSSxHQUFOLEVBQVc7QUFDVCxZQUFNQSxHQUFOO0FBQ0gsS0FORCxTQU1VO0FBQ05KLE1BQUFBLEVBQUUsS0FBSSxNQUFNLEtBQUtLLFdBQUwsQ0FBaUJMLEVBQWpCLENBQVYsQ0FBRjtBQUNIO0FBQ0o7O0FBTUQsUUFBTUssV0FBTixDQUFrQkMsSUFBbEIsRUFBd0IsQ0FDdkI7O0FBRUQsUUFBTUMsS0FBTixHQUFjO0FBQ1YsV0FBTyxLQUFLTCxRQUFMLENBQWNGLEVBQUUsSUFBSTtBQUN2QixhQUFPQSxFQUFFLENBQUNRLGVBQUgsQ0FBbUIsSUFBbkIsRUFBeUI7QUFBRUMsUUFBQUEsUUFBUSxFQUFFO0FBQVosT0FBekIsRUFBNkNDLE9BQTdDLEVBQVA7QUFDSCxLQUZNLENBQVA7QUFHSDs7QUFTRCxRQUFNQyxtQkFBTixDQUEwQnJCLE9BQTFCLEVBQW1DO0FBQy9CLFFBQUlVLEVBQUUsR0FBRyxNQUFNLEtBQUtILFFBQUwsRUFBZjtBQUVBLFdBQU8sSUFBSWhCLFlBQUosQ0FBaUJtQixFQUFqQixFQUFxQlYsT0FBckIsQ0FBUDtBQUNIOztBQVFELFFBQU1zQixVQUFOLENBQWlCQyxLQUFqQixFQUF3QkMsSUFBeEIsRUFBOEJ4QixPQUE5QixFQUF1QztBQUNuQyxXQUFPLEtBQUt5QixhQUFMLENBQW1CRixLQUFuQixFQUEyQkcsSUFBRCxJQUFVQSxJQUFJLENBQUNDLFNBQUwsQ0FBZUgsSUFBZixFQUFxQjtBQUFFSSxNQUFBQSx3QkFBd0IsRUFBRSxJQUE1QjtBQUFrQyxTQUFHNUI7QUFBckMsS0FBckIsQ0FBcEMsQ0FBUDtBQUNIOztBQVFELFFBQU02QixXQUFOLENBQWtCTixLQUFsQixFQUF5QkMsSUFBekIsRUFBK0J4QixPQUEvQixFQUF3QztBQUNwQyxXQUFPLEtBQUt5QixhQUFMLENBQW1CRixLQUFuQixFQUEyQkcsSUFBRCxJQUFVQSxJQUFJLENBQUNJLFVBQUwsQ0FBZ0JOLElBQWhCLEVBQXNCO0FBQUVJLE1BQUFBLHdCQUF3QixFQUFFLElBQTVCO0FBQWtDRyxNQUFBQSxPQUFPLEVBQUUsS0FBM0M7QUFBa0QsU0FBRy9CO0FBQXJELEtBQXRCLENBQXBDLENBQVA7QUFDSDs7QUFFRCxRQUFNZ0Msb0JBQU4sQ0FBMkJULEtBQTNCLEVBQWtDQyxJQUFsQyxFQUF3Q3hCLE9BQXhDLEVBQWlEO0FBQzdDLFFBQUk7QUFDQSxhQUFPLE1BQU0sS0FBS3NCLFVBQUwsQ0FBZ0JDLEtBQWhCLEVBQXVCQyxJQUF2QixFQUE2QnhCLE9BQTdCLENBQWI7QUFDSCxLQUZELENBRUUsT0FBT2lDLEtBQVAsRUFBYztBQUNaLFVBQUlBLEtBQUssQ0FBQ0MsSUFBTixLQUFlLEtBQW5CLEVBQTBCO0FBQ3RCLGVBQU8sS0FBUDtBQUNIOztBQUVELFlBQU1ELEtBQU47QUFDSDtBQUNKOztBQVFELFFBQU1FLGtCQUFOLENBQXlCWixLQUF6QixFQUFnQ0MsSUFBaEMsRUFBc0NZLFNBQXRDLEVBQWlEcEMsT0FBakQsRUFBMEQ7QUFDdEQsV0FBTyxLQUFLeUIsYUFBTCxDQUFtQkYsS0FBbkIsRUFBMkJHLElBQUQsSUFBVUEsSUFBSSxDQUFDVyxpQkFBTCxDQUF1QkQsU0FBdkIsRUFBa0NaLElBQWxDLEVBQXdDeEIsT0FBeEMsQ0FBcEMsQ0FBUDtBQUNIOztBQVFELFFBQU1zQyxpQkFBTixDQUF3QmYsS0FBeEIsRUFBK0JDLElBQS9CLEVBQXFDWSxTQUFyQyxFQUFnRHBDLE9BQWhELEVBQXlEO0FBQ3JELFdBQU8sS0FBS3lCLGFBQUwsQ0FBbUJGLEtBQW5CLEVBQTJCRyxJQUFELElBQVVBLElBQUksQ0FBQ2EsZ0JBQUwsQ0FBc0JILFNBQXRCLEVBQWlDLEtBQUtJLGdCQUFMLENBQXNCaEIsSUFBdEIsQ0FBakMsRUFBOER4QixPQUE5RCxDQUFwQyxDQUFQO0FBQ0g7O0FBRUQsUUFBTXlDLGlCQUFOLENBQXdCbEIsS0FBeEIsRUFBK0JhLFNBQS9CLEVBQTBDcEMsT0FBMUMsRUFBbUQ7QUFDL0MsV0FBTyxLQUFLeUIsYUFBTCxDQUFtQkYsS0FBbkIsRUFBMkJHLElBQUQsSUFBVUEsSUFBSSxDQUFDZ0IsZ0JBQUwsQ0FBc0JOLFNBQXRCLEVBQWlDcEMsT0FBakMsQ0FBcEMsQ0FBUDtBQUNIOztBQUVELFFBQU0yQyxRQUFOLENBQWVwQixLQUFmLEVBQXNCYSxTQUF0QixFQUFpQ3BDLE9BQWpDLEVBQTBDO0FBQ3RDLFdBQU8sS0FBS3lCLGFBQUwsQ0FBbUJGLEtBQW5CLEVBQTJCRyxJQUFELElBQVVBLElBQUksQ0FBQ2tCLE9BQUwsQ0FBYVIsU0FBYixFQUF3QnBDLE9BQXhCLENBQXBDLENBQVA7QUFDSDs7QUFTRCxRQUFNNkMsVUFBTixDQUFpQnRCLEtBQWpCLEVBQXdCQyxJQUF4QixFQUE4QlksU0FBOUIsRUFBeUNwQyxPQUF6QyxFQUFrRDtBQUc5QyxXQUFPLEtBQUt5QixhQUFMLENBQW1CRixLQUFuQixFQUEyQkcsSUFBRCxJQUFVQSxJQUFJLENBQUNvQixTQUFMLENBQWVWLFNBQWYsRUFBMEIsS0FBS0ksZ0JBQUwsQ0FBc0JoQixJQUF0QixDQUExQixFQUF1RHhCLE9BQXZELENBQXBDLENBQVA7QUFDSDs7QUFTRCxRQUFNK0MsVUFBTixDQUFpQnhCLEtBQWpCLEVBQXdCQyxJQUF4QixFQUE4QlksU0FBOUIsRUFBeUNwQyxPQUF6QyxFQUFrRGdELEtBQWxELEVBQXlEO0FBR3JELFdBQU8sS0FBS3ZCLGFBQUwsQ0FBbUJGLEtBQW5CLEVBQTBCLE1BQU9HLElBQVAsSUFBZ0I7QUFFN0MsVUFBSXVCLE9BQUo7QUFBQSxVQUFhQyxNQUFNLEdBQUcsS0FBdEI7O0FBRUEsVUFBSTtBQUNBLFdBQUc7QUFDQ0QsVUFBQUEsT0FBTyxHQUFHLE1BQU12QixJQUFJLENBQUNhLGdCQUFMLENBQXNCSCxTQUF0QixFQUFpQztBQUFFZSxZQUFBQSxJQUFJLEVBQUU7QUFBRUMsY0FBQUEsUUFBUSxFQUFFO0FBQVo7QUFBUixXQUFqQyxDQUFoQjtBQUNILFNBRkQsUUFFU0gsT0FBTyxDQUFDSSxLQUFSLElBQWlCSixPQUFPLENBQUNJLEtBQVIsQ0FBY0QsUUFGeEM7O0FBSUEsWUFBSUgsT0FBTyxDQUFDSSxLQUFaLEVBQW1CO0FBQ2ZILFVBQUFBLE1BQU0sR0FBRyxJQUFUO0FBRUEsaUJBQU8sTUFBTXhCLElBQUksQ0FBQ29CLFNBQUwsQ0FBZTtBQUFFUSxZQUFBQSxHQUFHLEVBQUVMLE9BQU8sQ0FBQ0ksS0FBUixDQUFjQztBQUFyQixXQUFmLEVBQTJDO0FBQUVILFlBQUFBLElBQUksRUFBRWxFLENBQUMsQ0FBQ3NFLElBQUYsQ0FBTy9CLElBQVAsRUFBYSxDQUFFLEtBQUYsQ0FBYixDQUFSO0FBQWlDZ0MsWUFBQUEsTUFBTSxFQUFFO0FBQUVKLGNBQUFBLFFBQVEsRUFBRTtBQUFaO0FBQXpDLFdBQTNDLEVBQXdHO0FBQUV4QixZQUFBQSx3QkFBd0IsRUFBRSxJQUE1QjtBQUFrQyxlQUFHNUI7QUFBckMsV0FBeEcsQ0FBYjtBQUNIOztBQUVELFlBQUk7QUFDQSxpQkFBTyxNQUFNMEIsSUFBSSxDQUFDQyxTQUFMLENBQWVILElBQWYsRUFBcUI7QUFBRUksWUFBQUEsd0JBQXdCLEVBQUUsSUFBNUI7QUFBa0MsZUFBRzVCO0FBQXJDLFdBQXJCLENBQWI7QUFDSCxTQUZELENBRUUsT0FBT3lELE1BQVAsRUFBZTtBQUNiLGNBQUksQ0FBQ1QsS0FBRCxJQUFVUyxNQUFNLENBQUNDLE9BQVAsQ0FBZUMsVUFBZixDQUEwQiw0QkFBMUIsQ0FBZCxFQUF1RTtBQUNuRSxtQkFBTyxLQUFLWixVQUFMLENBQWdCeEIsS0FBaEIsRUFBdUJDLElBQXZCLEVBQTZCWSxTQUE3QixFQUF3Q3BDLE9BQXhDLEVBQWlELElBQWpELENBQVA7QUFDSDs7QUFFRCxnQkFBTXlELE1BQU47QUFDSDtBQUVKLE9BckJELENBcUJFLE9BQU94QixLQUFQLEVBQWM7QUFFWixZQUFJaUIsTUFBSixFQUFZO0FBQ1IsZ0JBQU14QixJQUFJLENBQUNvQixTQUFMLENBQWU7QUFBRVEsWUFBQUEsR0FBRyxFQUFFTCxPQUFPLENBQUNJLEtBQVIsQ0FBY0M7QUFBckIsV0FBZixFQUEyQztBQUFFRSxZQUFBQSxNQUFNLEVBQUU7QUFBRUosY0FBQUEsUUFBUSxFQUFFO0FBQVo7QUFBVixXQUEzQyxDQUFOO0FBQ0g7O0FBRUQsY0FBTW5CLEtBQU47QUFDSDtBQUNKLEtBakNNLENBQVA7QUFrQ0g7O0FBUUQsUUFBTTJCLFdBQU4sQ0FBa0JyQyxLQUFsQixFQUF5QkMsSUFBekIsRUFBK0JxQyxVQUEvQixFQUEyQzdELE9BQTNDLEVBQW9EO0FBQ2hELFFBQUk4RCxHQUFHLEdBQUd0QyxJQUFJLENBQUN1QyxHQUFMLENBQVNDLE1BQU0sSUFBSTtBQUN6QixVQUFJO0FBQUVWLFFBQUFBLEdBQUY7QUFBTyxXQUFHVztBQUFWLFVBQXlCRCxNQUE3QjtBQUVBLFVBQUlFLFFBQVEsR0FBRztBQUNYZixRQUFBQSxJQUFJLEVBQUVjO0FBREssT0FBZjs7QUFJQSxVQUFJWCxHQUFKLEVBQVM7QUFDTFksUUFBQUEsUUFBUSxDQUFDQyxZQUFULEdBQXdCO0FBQUViLFVBQUFBO0FBQUYsU0FBeEI7QUFDSDs7QUFFRCxhQUFPO0FBQ0hSLFFBQUFBLFNBQVMsRUFBRTtBQUFFc0IsVUFBQUEsTUFBTSxFQUFFLEVBQUUsR0FBR25GLENBQUMsQ0FBQ29GLElBQUYsQ0FBT0wsTUFBUCxFQUFlSCxVQUFmO0FBQUwsV0FBVjtBQUE2Q1MsVUFBQUEsTUFBTSxFQUFFSixRQUFyRDtBQUErREssVUFBQUEsTUFBTSxFQUFFO0FBQXZFO0FBRFIsT0FBUDtBQUdILEtBZFMsQ0FBVjtBQWdCQSxXQUFPLEtBQUs5QyxhQUFMLENBQW1CRixLQUFuQixFQUEyQkcsSUFBRCxJQUFVQSxJQUFJLENBQUM4QyxTQUFMLENBQWVWLEdBQWYsRUFBb0I7QUFBRWxDLE1BQUFBLHdCQUF3QixFQUFFLElBQTVCO0FBQWtDRyxNQUFBQSxPQUFPLEVBQUUsS0FBM0M7QUFBa0QsU0FBRy9CO0FBQXJELEtBQXBCLENBQXBDLENBQVA7QUFDSDs7QUFTRCxRQUFNeUUscUJBQU4sQ0FBNEJsRCxLQUE1QixFQUFtQ0MsSUFBbkMsRUFBeUNxQyxVQUF6QyxFQUFxRDdELE9BQXJELEVBQThEO0FBQzFELFFBQUk4RCxHQUFHLEdBQUd0QyxJQUFJLENBQUN1QyxHQUFMLENBQVNDLE1BQU0sS0FBSztBQUMxQmxCLE1BQUFBLFNBQVMsRUFBRTtBQUFFc0IsUUFBQUEsTUFBTSxFQUFFLEVBQUUsR0FBR25GLENBQUMsQ0FBQ29GLElBQUYsQ0FBT0wsTUFBUCxFQUFlSCxVQUFmO0FBQUwsU0FBVjtBQUE2Q1MsUUFBQUEsTUFBTSxFQUFFO0FBQUVILFVBQUFBLFlBQVksRUFBRUg7QUFBaEIsU0FBckQ7QUFBK0VPLFFBQUFBLE1BQU0sRUFBRTtBQUF2RjtBQURlLEtBQUwsQ0FBZixDQUFWO0FBSUEsV0FBTyxLQUFLOUMsYUFBTCxDQUFtQkYsS0FBbkIsRUFBMkJHLElBQUQsSUFBVUEsSUFBSSxDQUFDOEMsU0FBTCxDQUFlVixHQUFmLEVBQW9CO0FBQUVsQyxNQUFBQSx3QkFBd0IsRUFBRSxJQUE1QjtBQUFrQ0csTUFBQUEsT0FBTyxFQUFFLEtBQTNDO0FBQWtELFNBQUcvQjtBQUFyRCxLQUFwQixDQUFwQyxDQUFQO0FBQ0g7O0FBU0QsUUFBTTBFLFdBQU4sQ0FBa0JuRCxLQUFsQixFQUF5QkMsSUFBekIsRUFBK0JZLFNBQS9CLEVBQTBDcEMsT0FBMUMsRUFBbUQ7QUFDL0MsV0FBTyxLQUFLeUIsYUFBTCxDQUFtQkYsS0FBbkIsRUFBMkJHLElBQUQsSUFBVUEsSUFBSSxDQUFDaUQsVUFBTCxDQUFnQnZDLFNBQWhCLEVBQTJCLEtBQUtJLGdCQUFMLENBQXNCaEIsSUFBdEIsQ0FBM0IsRUFBd0R4QixPQUF4RCxDQUFwQyxDQUFQO0FBQ0g7O0FBUUQsUUFBTTRFLFdBQU4sQ0FBa0JyRCxLQUFsQixFQUF5QkMsSUFBekIsRUFBK0JZLFNBQS9CLEVBQTBDcEMsT0FBMUMsRUFBbUQ7QUFDL0MsV0FBTyxLQUFLeUIsYUFBTCxDQUFtQkYsS0FBbkIsRUFBMkJHLElBQUQsSUFBVUEsSUFBSSxDQUFDbUQsVUFBTCxDQUFnQnpDLFNBQWhCLEVBQTJCWixJQUEzQixFQUFpQ3hCLE9BQWpDLENBQXBDLENBQVA7QUFDSDs7QUFRRCxRQUFNOEUsVUFBTixDQUFpQnZELEtBQWpCLEVBQXdCYSxTQUF4QixFQUFtQ3BDLE9BQW5DLEVBQTRDO0FBQ3hDLFdBQU8sS0FBS3lCLGFBQUwsQ0FBbUJGLEtBQW5CLEVBQTJCRyxJQUFELElBQVVBLElBQUksQ0FBQ3FELFNBQUwsQ0FBZTNDLFNBQWYsRUFBMEJwQyxPQUExQixDQUFwQyxDQUFQO0FBQ0g7O0FBUUQsUUFBTWdGLFdBQU4sQ0FBa0J6RCxLQUFsQixFQUF5QmEsU0FBekIsRUFBb0NwQyxPQUFwQyxFQUE2QztBQUN6QyxXQUFPLEtBQUt5QixhQUFMLENBQW1CRixLQUFuQixFQUEyQkcsSUFBRCxJQUFVQSxJQUFJLENBQUN1RCxVQUFMLENBQWdCN0MsU0FBaEIsRUFBMkJwQyxPQUEzQixDQUFwQyxDQUFQO0FBQ0g7O0FBUUQsUUFBTUUsS0FBTixDQUFZcUIsS0FBWixFQUFtQmEsU0FBbkIsRUFBOEJwQyxPQUE5QixFQUF1QztBQUNuQyxXQUFPLEtBQUt5QixhQUFMLENBQW1CRixLQUFuQixFQUEwQixNQUFNRyxJQUFOLElBQWM7QUFDM0MsVUFBSXdELFlBQVksR0FBRyxFQUFDLEdBQUdsRjtBQUFKLE9BQW5CO0FBQ0EsVUFBSW1GLEtBQUssR0FBRyxFQUFaOztBQUVBLFVBQUkvQyxTQUFKLEVBQWU7QUFDWCxZQUFJO0FBQUVnRCxVQUFBQSxXQUFGO0FBQWVDLFVBQUFBLFFBQWY7QUFBeUJDLFVBQUFBLE9BQXpCO0FBQWtDQyxVQUFBQSxNQUFsQztBQUEwQ0MsVUFBQUEsTUFBMUM7QUFBa0QsYUFBR0M7QUFBckQsWUFBZ0VyRCxTQUFwRTs7QUFFQSxZQUFJZ0QsV0FBSixFQUFpQjtBQUNiRixVQUFBQSxZQUFZLENBQUNRLFVBQWIsR0FBMEJOLFdBQTFCO0FBQ0g7O0FBRUQsWUFBSUMsUUFBSixFQUFjO0FBQ1ZILFVBQUFBLFlBQVksQ0FBQ1MsSUFBYixHQUFvQk4sUUFBcEI7QUFDSDs7QUFFRCxZQUFJQyxPQUFKLEVBQWE7QUFDVEosVUFBQUEsWUFBWSxDQUFDVSxJQUFiLEdBQW9CTixPQUFwQjtBQUNIOztBQUVELFlBQUlDLE1BQUosRUFBWTtBQUNSTCxVQUFBQSxZQUFZLENBQUNXLEtBQWIsR0FBcUJOLE1BQXJCO0FBQ0g7O0FBRURPLFFBQUFBLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjWixLQUFkLEVBQXFCbEcsQ0FBQyxDQUFDK0csTUFBRixDQUFTUCxNQUFULEVBQWlCLENBQUNRLENBQUQsRUFBR0MsQ0FBSCxLQUFTQSxDQUFDLENBQUMsQ0FBRCxDQUFELEtBQVMsR0FBbkMsQ0FBckI7O0FBRUEsWUFBSVYsTUFBSixFQUFZO0FBQ1JNLFVBQUFBLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjWixLQUFkLEVBQXFCSyxNQUFyQjtBQUNIO0FBQ0o7O0FBRUQsVUFBSVcsTUFBTSxHQUFHLE1BQU16RSxJQUFJLENBQUMwRSxJQUFMLENBQVVqQixLQUFWLEVBQWlCRCxZQUFqQixFQUErQjlELE9BQS9CLEVBQW5COztBQUVBLFVBQUlnQixTQUFTLElBQUlBLFNBQVMsQ0FBQ2lFLFdBQTNCLEVBQXdDO0FBQ3BDLFlBQUlDLFVBQVUsR0FBRyxNQUFNNUUsSUFBSSxDQUFDMEUsSUFBTCxDQUFVakIsS0FBVixFQUFpQm9CLEtBQWpCLEVBQXZCO0FBQ0EsZUFBTyxDQUFFSixNQUFGLEVBQVVHLFVBQVYsQ0FBUDtBQUNIOztBQUVELGFBQU9ILE1BQVA7QUFDSCxLQXRDTSxDQUFQO0FBdUNIOztBQUVELFFBQU0xRSxhQUFOLENBQW9CRixLQUFwQixFQUEyQmlGLFFBQTNCLEVBQXFDO0FBQ2pDLFdBQU8sS0FBSzVGLFFBQUwsQ0FBY0YsRUFBRSxJQUFJOEYsUUFBUSxDQUFDOUYsRUFBRSxDQUFDK0YsVUFBSCxDQUFjbEYsS0FBZCxDQUFELENBQTVCLENBQVA7QUFDSDs7QUFFRGlCLEVBQUFBLGdCQUFnQixDQUFDOEIsTUFBRCxFQUFTO0FBQ3JCLFFBQUlSLEdBQUcsR0FBRzdFLENBQUMsQ0FBQ29GLElBQUYsQ0FBT0MsTUFBUCxFQUFlM0UsU0FBZixDQUFWOztBQUNBLFFBQUk4RixNQUFNLEdBQUd4RyxDQUFDLENBQUNzRSxJQUFGLENBQU9lLE1BQVAsRUFBZTNFLFNBQWYsQ0FBYjs7QUFFQSxRQUFJbUUsR0FBRyxDQUFDWCxJQUFSLEVBQWM7QUFDVlcsTUFBQUEsR0FBRyxDQUFDWCxJQUFKLEdBQVcsRUFBRSxHQUFHVyxHQUFHLENBQUNYLElBQVQ7QUFBZSxXQUFHc0M7QUFBbEIsT0FBWDtBQUNILEtBRkQsTUFFTyxJQUFJLENBQUN4RyxDQUFDLENBQUN5SCxPQUFGLENBQVVqQixNQUFWLENBQUwsRUFBd0I7QUFDM0IzQixNQUFBQSxHQUFHLENBQUNYLElBQUosR0FBV3NDLE1BQVg7QUFDSDs7QUFFRCxXQUFPM0IsR0FBUDtBQUNIOztBQXZWb0M7O0FBMFZ6QzZDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQi9HLGdCQUFqQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHsgXywgd2FpdFVudGlsXyB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgdHJ5UmVxdWlyZSB9ID0gcmVxdWlyZSgnQGstc3VpdGUvYXBwL2xpYi91dGlscy9IZWxwZXJzJyk7XG5jb25zdCBtb25nb2RiID0gdHJ5UmVxdWlyZSgnbW9uZ29kYicpO1xuY29uc3QgeyBNb25nb0NsaWVudCwgR3JpZEZTQnVja2V0IH0gPSBtb25nb2RiO1xuY29uc3QgQ29ubmVjdG9yID0gcmVxdWlyZSgnLi4vLi4vQ29ubmVjdG9yJyk7XG5cbmNvbnN0IFVwZGF0ZU9wc0ZpZWxkID0gWyAnJGN1cnJlbnREYXRlJywgJyRpbmMnLCAnJG1pbicsICckbWF4JywgJyRtdWwnLCAnJHJlbmFtZScsICckc2V0JywgJyRzZXRPbkluc2VydCcsICckdW5zZXQnIF07XG5jb25zdCBVcGRhdGVPcHNBcnJheSA9IFsgJyRhZGRUb1NldCcsICckcG9wJywgJyRwdWxsJywgJyRwdXNoJywgJyRwdWxsQWxsJyBdO1xuY29uc3QgVXBkYXRlT3BzID0gVXBkYXRlT3BzRmllbGQuY29uY2F0KFVwZGF0ZU9wc0FycmF5KTtcblxuLyoqXG4gKiBNb25nb2RiIGRhdGEgc3RvcmFnZSBjb25uZWN0b3IuXG4gKiBAY2xhc3NcbiAqIEBleHRlbmRzIENvbm5lY3RvclxuICovXG5jbGFzcyBNb25nb2RiQ29ubmVjdG9yIGV4dGVuZHMgQ29ubmVjdG9yIHtcbiAgICAvKiogICAgICAgICAgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgXG4gICAgICogQHByb3BlcnR5IHtib29sZWFufSBbb3B0aW9ucy51c2VQcmVwYXJlZFN0YXRlbWVudF0gLSBcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3Rvcihjb25uZWN0aW9uU3RyaW5nLCBvcHRpb25zKSB7ICAgICAgICBcbiAgICAgICAgc3VwZXIoJ21vbmdvZGInLCBjb25uZWN0aW9uU3RyaW5nLCBvcHRpb25zKTsgICAgICAgICBcbiAgICB9XG5cbiAgICBmaW5kQWxsXyA9IHRoaXMuZmluZF87XG5cbiAgICAvKipcbiAgICAgKiBDbG9zZSBhbGwgY29ubmVjdGlvbiBpbml0aWF0ZWQgYnkgdGhpcyBjb25uZWN0b3IuXG4gICAgICovXG4gICAgYXN5bmMgZW5kXygpIHtcbiAgICAgICAgaWYgKHRoaXMuY2xpZW50ICYmIHRoaXMuY2xpZW50LmlzQ29ubmVjdGVkKCkpIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuY2xpZW50LmNsb3NlKCk7XG4gICAgICAgIH1cblxuICAgICAgICBkZWxldGUgdGhpcy5jbGllbnQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgZGF0YWJhc2UgY29ubmVjdGlvbiBiYXNlZCBvbiB0aGUgZGVmYXVsdCBjb25uZWN0aW9uIHN0cmluZyBvZiB0aGUgY29ubmVjdG9yIGFuZCBnaXZlbiBvcHRpb25zLiAgICAgXG4gICAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXSAtIEV4dHJhIG9wdGlvbnMgZm9yIHRoZSBjb25uZWN0aW9uLCBvcHRpb25hbC5cbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtvcHRpb25zLm11bHRpcGxlU3RhdGVtZW50cz1mYWxzZV0gLSBBbGxvdyBydW5uaW5nIG11bHRpcGxlIHN0YXRlbWVudHMgYXQgYSB0aW1lLlxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbH0gW29wdGlvbnMuY3JlYXRlRGF0YWJhc2U9ZmFsc2VdIC0gRmxhZyB0byB1c2VkIHdoZW4gY3JlYXRpbmcgYSBkYXRhYmFzZS5cbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZS48RGI+fVxuICAgICAqL1xuICAgIGFzeW5jIGNvbm5lY3RfKCkge1xuICAgICAgICBpZiAoIXRoaXMuY2xpZW50IHx8ICF0aGlzLmNsaWVudC5pc0Nvbm5lY3RlZCgpKSB7XG4gICAgICAgICAgICBsZXQgY2xpZW50ID0gbmV3IE1vbmdvQ2xpZW50KHRoaXMuY29ubmVjdGlvblN0cmluZywge3VzZU5ld1VybFBhcnNlcjogdHJ1ZX0pO1xuICAgICAgICAgICAgdGhpcy5jbGllbnQgPSBhd2FpdCBjbGllbnQuY29ubmVjdCgpO1xuICAgICAgICB9ICAgICAgIFxuXG4gICAgICAgIHJldHVybiB0aGlzLmNsaWVudC5kYih0aGlzLmRhdGFiYXNlKTtcbiAgICB9XG5cbiAgICBhc3luYyBleGVjdXRlXyhkYkV4ZWN1dG9yKSB7XG4gICAgICAgIGxldCBkYjtcbiAgICBcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGRiID0gYXdhaXQgdGhpcy5jb25uZWN0XygpO1xuXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgZGJFeGVjdXRvcihkYik7XG4gICAgICAgIH0gY2F0Y2goZXJyKSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICBkYiAmJiBhd2FpdCB0aGlzLmRpc2Nvbm5lY3RfKGRiKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENsb3NlIGEgZGF0YWJhc2UgY29ubmVjdGlvbi5cbiAgICAgKiBAcGFyYW0ge0RifSBjb25uIC0gTXlTUUwgY29ubmVjdGlvbi5cbiAgICAgKi9cbiAgICBhc3luYyBkaXNjb25uZWN0Xyhjb25uKSB7XG4gICAgfVxuICBcbiAgICBhc3luYyBwaW5nXygpIHsgIFxuICAgICAgICByZXR1cm4gdGhpcy5leGVjdXRlXyhkYiA9PiB7XG4gICAgICAgICAgICByZXR1cm4gZGIubGlzdENvbGxlY3Rpb25zKG51bGwsIHsgbmFtZU9ubHk6IHRydWUgfSkudG9BcnJheSgpO1xuICAgICAgICB9KTsgIFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbb3B0aW9uc10gLSBPcHRpb25hbCBzZXR0aW5ncy5cbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuYnVja2V0TmFtZT0nZnMnXSAtIFRoZSAnZmlsZXMnIGFuZCAnY2h1bmtzJyBjb2xsZWN0aW9ucyB3aWxsIGJlIHByZWZpeGVkIHdpdGggdGhlIGJ1Y2tldCBuYW1lIGZvbGxvd2VkIGJ5IGEgZG90LlxuICAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBbb3B0aW9ucy5jaHVua1NpemVCeXRlc10gLSBOdW1iZXIgb2YgYnl0ZXMgc3RvcmVkIGluIGVhY2ggY2h1bmsuIERlZmF1bHRzIHRvIDI1NUtCXG4gICAgICogQHByb3BlcnR5IHtvYmplY3R9IFtvcHRpb25zLndyaXRlQ29uY2Vybl1cbiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gW29wdGlvbnMucmVhZFByZWZlcmVuY2VdXG4gICAgICovXG4gICAgYXN5bmMgY3JlYXRlR3JpZEZTQnVja2V0XyhvcHRpb25zKSB7XG4gICAgICAgIGxldCBkYiA9IGF3YWl0IHRoaXMuY29ubmVjdF8oKTtcblxuICAgICAgICByZXR1cm4gbmV3IEdyaWRGU0J1Y2tldChkYiwgb3B0aW9ucyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgbmV3IGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGluc2VydE9uZV8obW9kZWwsIGRhdGEsIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuaW5zZXJ0T25lKGRhdGEsIHsgYnlwYXNzRG9jdW1lbnRWYWxpZGF0aW9uOiB0cnVlLCAuLi5vcHRpb25zIH0pKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYW4gYXJyYXkgb2YgbmV3IGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHthcnJheX0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgaW5zZXJ0TWFueV8obW9kZWwsIGRhdGEsIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuaW5zZXJ0TWFueShkYXRhLCB7IGJ5cGFzc0RvY3VtZW50VmFsaWRhdGlvbjogdHJ1ZSwgb3JkZXJlZDogZmFsc2UsIC4uLm9wdGlvbnMgfSkpO1xuICAgIH1cblxuICAgIGFzeW5jIGluc2VydE9uZUlmTm90RXhpc3RfKG1vZGVsLCBkYXRhLCBvcHRpb25zKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5pbnNlcnRPbmVfKG1vZGVsLCBkYXRhLCBvcHRpb25zKVxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgaWYgKGVycm9yLmNvZGUgPT09IDExMDAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlcGxhY2UgKGluc2VydCBvciB1cGRhdGUgZm9yIGV4c2lzdGluZykgYW4gZW50aXR5IGFuZCByZXR1cm4gb3JpZ2luYWwgcmVjb3JkLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgZmluZE9uZUFuZFJlcGxhY2VfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZmluZE9uZUFuZFJlcGxhY2UoY29uZGl0aW9uLCBkYXRhLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRmluZCBhIGRvY3VtZW50IGFuZCB1cGRhdGUgaXQgaW4gb25lIGF0b21pYyBvcGVyYXRpb24uIFJlcXVpcmVzIGEgd3JpdGUgbG9jayBmb3IgdGhlIGR1cmF0aW9uIG9mIHRoZSBvcGVyYXRpb24uXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBmaW5kT25lQW5kVXBkYXRlXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7ICAgICBcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZmluZE9uZUFuZFVwZGF0ZShjb25kaXRpb24sIHRoaXMuX3RyYW5zbGF0ZVVwZGF0ZShkYXRhKSwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIGFzeW5jIGZpbmRPbmVBbmREZWxldGVfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZmluZE9uZUFuZERlbGV0ZShjb25kaXRpb24sIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICBhc3luYyBmaW5kT25lXyhtb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmZpbmRPbmUoY29uZGl0aW9uLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIGFuIGV4aXN0aW5nIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIHVwZGF0ZU9uZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykgeyBcbiAgICAgICAgLy90b2RvOiBzcGluIHRvIHdhaXQgZm9yIG5vbiBfX2xvY2tfXyBcblxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC51cGRhdGVPbmUoY29uZGl0aW9uLCB0aGlzLl90cmFuc2xhdGVVcGRhdGUoZGF0YSksIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgYW4gZXhpc3RpbmcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgdXBzZXJ0T25lXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zLCByZXRyeSkgeyBcbiAgICAgICAgLy93YWxrIGFyb3VuZCBtb25nb2RiIGZhaWxlZCB0byBzZXRPbkluc2VydCB3aXRoIF9pZFxuXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIGFzeW5jIChjb2xsKSA9PiB7XG5cbiAgICAgICAgICAgIGxldCBjdXJyZW50LCBsb2NrZWQgPSBmYWxzZTtcblxuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBkbyB7XG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBhd2FpdCBjb2xsLmZpbmRPbmVBbmRVcGRhdGUoY29uZGl0aW9uLCB7ICRzZXQ6IHsgX19sb2NrX186IHRydWUgfSB9KTtcbiAgICAgICAgICAgICAgICB9IHdoaWxlIChjdXJyZW50LnZhbHVlICYmIGN1cnJlbnQudmFsdWUuX19sb2NrX18pO1xuXG4gICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQudmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgbG9ja2VkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCBjb2xsLnVwZGF0ZU9uZSh7IF9pZDogY3VycmVudC52YWx1ZS5faWQgfSwgeyAkc2V0OiBfLm9taXQoZGF0YSwgWyAnX2lkJyBdKSwgJHVuc2V0OiB7IF9fbG9ja19fOiBcIlwiIH0gfSwgeyBieXBhc3NEb2N1bWVudFZhbGlkYXRpb246IHRydWUsIC4uLm9wdGlvbnMgfSk7ICAgIFxuICAgICAgICAgICAgICAgIH0gXG5cbiAgICAgICAgICAgICAgICB0cnkgeyBcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGF3YWl0IGNvbGwuaW5zZXJ0T25lKGRhdGEsIHsgYnlwYXNzRG9jdW1lbnRWYWxpZGF0aW9uOiB0cnVlLCAuLi5vcHRpb25zIH0pO1xuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgeyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmICghcmV0cnkgJiYgZXJyb3IyLm1lc3NhZ2Uuc3RhcnRzV2l0aCgnRTExMDAwIGR1cGxpY2F0ZSBrZXkgZXJyb3InKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudXBzZXJ0T25lXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zLCB0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIHRocm93IGVycm9yMjtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKGxvY2tlZCkge1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCBjb2xsLnVwZGF0ZU9uZSh7IF9pZDogY3VycmVudC52YWx1ZS5faWQgfSwgeyAkdW5zZXQ6IHsgX19sb2NrX186IFwiXCIgfSB9KTsgICAgXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pOyAgICAgICAgXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIG1hbnkgZW50aXRpZXMuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIC0gQXJyYXkgb2YgcmVjb3JkIHdpdGggX2lkXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIHVwc2VydE1hbnlfKG1vZGVsLCBkYXRhLCB1bmlxdWVLZXlzLCBvcHRpb25zKSB7IFxuICAgICAgICBsZXQgb3BzID0gZGF0YS5tYXAocmVjb3JkID0+IHtcbiAgICAgICAgICAgIGxldCB7IF9pZCwgLi4udXBkYXRlRGF0YSB9ID0gcmVjb3JkO1xuXG4gICAgICAgICAgICBsZXQgdXBkYXRlT3AgPSB7XG4gICAgICAgICAgICAgICAgJHNldDogdXBkYXRlRGF0YVxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgaWYgKF9pZCkge1xuICAgICAgICAgICAgICAgIHVwZGF0ZU9wLiRzZXRPbkluc2VydCA9IHsgX2lkIH07XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgdXBkYXRlT25lOiB7IGZpbHRlcjogeyAuLi5fLnBpY2socmVjb3JkLCB1bmlxdWVLZXlzKSB9LCB1cGRhdGU6IHVwZGF0ZU9wLCB1cHNlcnQ6IHRydWUgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuYnVsa1dyaXRlKG9wcywgeyBieXBhc3NEb2N1bWVudFZhbGlkYXRpb246IHRydWUsIG9yZGVyZWQ6IGZhbHNlLCAuLi5vcHRpb25zIH0pKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBJbnNlcnQgbWFueSBlbnRpdGllcyBpZiBub3QgZXhpc3QuXG4gICAgICogQHBhcmFtIHsqfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0geyp9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSB1bmlxdWVLZXlzIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBpbnNlcnRNYW55SWZOb3RFeGlzdF8obW9kZWwsIGRhdGEsIHVuaXF1ZUtleXMsIG9wdGlvbnMpIHtcbiAgICAgICAgbGV0IG9wcyA9IGRhdGEubWFwKHJlY29yZCA9PiAoe1xuICAgICAgICAgICAgdXBkYXRlT25lOiB7IGZpbHRlcjogeyAuLi5fLnBpY2socmVjb3JkLCB1bmlxdWVLZXlzKSB9LCB1cGRhdGU6IHsgJHNldE9uSW5zZXJ0OiByZWNvcmQgfSwgdXBzZXJ0OiB0cnVlIH1cbiAgICAgICAgfSkpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmJ1bGtXcml0ZShvcHMsIHsgYnlwYXNzRG9jdW1lbnRWYWxpZGF0aW9uOiB0cnVlLCBvcmRlcmVkOiBmYWxzZSwgLi4ub3B0aW9ucyB9KSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIG11bHRpcGxlIGRvY3VtZW50cy5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyB1cGRhdGVNYW55Xyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7IFxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC51cGRhdGVNYW55KGNvbmRpdGlvbiwgdGhpcy5fdHJhbnNsYXRlVXBkYXRlKGRhdGEpLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVwbGFjZSBhbiBleGlzdGluZyBlbnRpdHkgb3IgY3JlYXRlIGEgbmV3IG9uZS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIHJlcGxhY2VPbmVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgIFxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5yZXBsYWNlT25lKGNvbmRpdGlvbiwgZGF0YSwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZSBhbiBleGlzdGluZyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBkZWxldGVPbmVfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZGVsZXRlT25lKGNvbmRpdGlvbiwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZSBhbiBleGlzdGluZyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBkZWxldGVNYW55Xyhtb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmRlbGV0ZU1hbnkoY29uZGl0aW9uLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUGVyZm9ybSBzZWxlY3Qgb3BlcmF0aW9uLlxuICAgICAqIEBwYXJhbSB7Kn0gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGZpbmRfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgYXN5bmMgY29sbCA9PiB7XG4gICAgICAgICAgICBsZXQgcXVlcnlPcHRpb25zID0gey4uLm9wdGlvbnN9O1xuICAgICAgICAgICAgbGV0IHF1ZXJ5ID0ge307XG5cbiAgICAgICAgICAgIGlmIChjb25kaXRpb24pIHtcbiAgICAgICAgICAgICAgICBsZXQgeyAkcHJvamVjdGlvbiwgJG9yZGVyQnksICRvZmZzZXQsICRsaW1pdCwgJHF1ZXJ5LCAuLi5vdGhlcnMgfSA9IGNvbmRpdGlvbjtcblxuICAgICAgICAgICAgICAgIGlmICgkcHJvamVjdGlvbikge1xuICAgICAgICAgICAgICAgICAgICBxdWVyeU9wdGlvbnMucHJvamVjdGlvbiA9ICRwcm9qZWN0aW9uOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoJG9yZGVyQnkpIHtcbiAgICAgICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLnNvcnQgPSAkb3JkZXJCeTsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKCRvZmZzZXQpIHtcbiAgICAgICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLnNraXAgPSAkb2Zmc2V0OyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoJGxpbWl0KSB7XG4gICAgICAgICAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucy5saW1pdCA9ICRsaW1pdDsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihxdWVyeSwgXy5waWNrQnkob3RoZXJzLCAodixrKSA9PiBrWzBdICE9PSAnJCcpKTtcblxuICAgICAgICAgICAgICAgIGlmICgkcXVlcnkpIHtcbiAgICAgICAgICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihxdWVyeSwgJHF1ZXJ5KTtcbiAgICAgICAgICAgICAgICB9IFxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgcmVzdWx0ID0gYXdhaXQgY29sbC5maW5kKHF1ZXJ5LCBxdWVyeU9wdGlvbnMpLnRvQXJyYXkoKTtcblxuICAgICAgICAgICAgaWYgKGNvbmRpdGlvbiAmJiBjb25kaXRpb24uJHRvdGFsQ291bnQpIHtcbiAgICAgICAgICAgICAgICBsZXQgdG90YWxDb3VudCA9IGF3YWl0IGNvbGwuZmluZChxdWVyeSkuY291bnQoKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gWyByZXN1bHQsIHRvdGFsQ291bnQgXTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgfSk7XG4gICAgfSAgIFxuXG4gICAgYXN5bmMgb25Db2xsZWN0aW9uXyhtb2RlbCwgZXhlY3V0b3IpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZXhlY3V0ZV8oZGIgPT4gZXhlY3V0b3IoZGIuY29sbGVjdGlvbihtb2RlbCkpKTtcbiAgICB9XG5cbiAgICBfdHJhbnNsYXRlVXBkYXRlKHVwZGF0ZSkge1xuICAgICAgICBsZXQgb3BzID0gXy5waWNrKHVwZGF0ZSwgVXBkYXRlT3BzKTtcbiAgICAgICAgbGV0IG90aGVycyA9IF8ub21pdCh1cGRhdGUsIFVwZGF0ZU9wcyk7XG5cbiAgICAgICAgaWYgKG9wcy4kc2V0KSB7XG4gICAgICAgICAgICBvcHMuJHNldCA9IHsgLi4ub3BzLiRzZXQsIC4uLm90aGVycyB9O1xuICAgICAgICB9IGVsc2UgaWYgKCFfLmlzRW1wdHkob3RoZXJzKSkge1xuICAgICAgICAgICAgb3BzLiRzZXQgPSBvdGhlcnM7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gb3BzO1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBNb25nb2RiQ29ubmVjdG9yOyJdfQ==