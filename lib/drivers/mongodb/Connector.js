"use strict";

require("source-map-support/register");

const {
  _,
  waitUntil_
} = require('rk-utils');

const {
  tryRequire
} = require('../../utils/lib');

const mongodb = tryRequire('mongodb');
const {
  MongoClient,
  GridFSBucket
} = mongodb;

const Connector = require('../../Connector');

const Generators = require('../../Generators');

const UpdateOpsField = ['$currentDate', '$inc', '$min', '$max', '$mul', '$rename', '$set', '$setOnInsert', '$unset'];
const UpdateOpsArray = ['$addToSet', '$pop', '$pull', '$push', '$pullAll'];
const UpdateOps = UpdateOpsField.concat(UpdateOpsArray);

class MongodbConnector extends Connector {
  constructor(connectionString, options) {
    super('mongodb', connectionString, options);
    this.findAll_ = this.find_;
    this.lockerField = this.options.lockerField || '__lock__';
  }

  async end_() {
    if (this.client && this.client.isConnected()) {
      await this.client.close();
      this.log('verbose', `mongodb: successfully disconnected from "${this.getConnectionStringWithoutCredential()}".`);
    }

    delete this.client;
  }

  async connect_(options) {
    if (!this.client || !this.client.isConnected()) {
      let client = new MongoClient(this.connectionString, {
        useNewUrlParser: true
      });
      this.client = await client.connect();
      this.log('verbose', `mongodb: successfully connected to "${this.getConnectionStringWithoutCredential()}".`);
    }

    return this.client.db(this.database);
  }

  async disconnect_(conn) {}

  async ping_() {
    return this.execute_(db => {
      return db.listCollections(null, {
        nameOnly: true
      }).toArray();
    });
  }

  async execute_(dbExecutor) {
    let db;

    try {
      db = await this.connect_();
      return await dbExecutor(db);
    } catch (err) {
      throw err;
    } finally {
      db && (await this.disconnect_(db));
    }
  }

  async createGridFSBucket_(options) {
    let db = await this.connect_();
    return new GridFSBucket(db, options);
  }

  async insertOne_(model, data, options) {
    return this.onCollection_(model, coll => coll.insertOne(data, {
      bypassDocumentValidation: true,
      ...options
    }));
  }

  async insertMany_(model, data, options) {
    return this.onCollection_(model, coll => coll.insertMany(data, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async insertOneIfNotExist_(model, data, options) {
    try {
      return await this.insertOne_(model, data, options);
    } catch (error) {
      if (error.code === 11000) {
        return false;
      }

      throw error;
    }
  }

  async findOneAndReplace_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndReplace(condition, data, options));
  }

  async findOneAndUpdate_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndUpdate(condition, this._translateUpdate(data), options));
  }

  async findOneAndDelete_(model, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndDelete(condition, options));
  }

  async findOne_(model, condition, options) {
    return this.onCollection_(model, coll => coll.findOne(condition, options));
  }

  async updateOne_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.updateOne(condition, this._translateUpdate(data), options));
  }

  async updateOneAndReturn_(model, data, condition, options) {
    let ret = await this.findOneAndUpdate_(model, data, condition, { ...options,
      upsert: false,
      returnOriginal: false
    });
    return ret && ret.value;
  }

  async upsertOne_(model, data, condition, options) {
    let trans = this._translateUpdate(data);

    let {
      _id,
      ...others
    } = trans.$set;

    if (!_.isNil(_id)) {
      trans.$set = others;
      trans.$setOnInsert = {
        _id
      };
    }

    return this.onCollection_(model, coll => coll.updateOne(condition, trans, { ...options,
      upsert: true
    }));
  }

  async upsertMany_(model, data, uniqueKeys, options) {
    let ops = data.map(record => {
      let {
        _id,
        ...updateData
      } = record;
      let updateOp = {
        $set: updateData
      };

      if (_id) {
        updateOp.$setOnInsert = {
          _id
        };
      }

      return {
        updateOne: {
          filter: { ..._.pick(record, uniqueKeys)
          },
          update: updateOp,
          upsert: true
        }
      };
    });
    return this.onCollection_(model, coll => coll.bulkWrite(ops, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async updateManyAndReturn_(model, data, condition, options) {
    let lockerId = Generators.shortid();
    return this.onCollection_(model, async coll => {
      let ret = await coll.updateMany({ ...condition,
        [this.lockerField]: {
          $exists: false
        }
      }, {
        $set: { ...data,
          [this.lockerField]: lockerId
        }
      }, { ...options,
        upsert: false
      });

      try {
        return await coll.find({
          [this.lockerField]: lockerId
        }, {
          projection: {
            [this.lockerField]: 0
          }
        }).toArray();
      } finally {
        if (ret.result.nModified > 0) {
          await coll.updateMany({
            [this.lockerField]: lockerId
          }, {
            $unset: {
              [this.lockerField]: ""
            }
          }, {
            upsert: false
          });
        }
      }
    });
  }

  async insertManyIfNotExist_(model, data, uniqueKeys, options) {
    let ops = data.map(record => ({
      updateOne: {
        filter: { ..._.pick(record, uniqueKeys)
        },
        update: {
          $setOnInsert: record
        },
        upsert: true
      }
    }));
    return this.onCollection_(model, coll => coll.bulkWrite(ops, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async updateMany_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.updateMany(condition, this._translateUpdate(data), options));
  }

  async replaceOne_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.replaceOne(condition, data, options));
  }

  async deleteOne_(model, condition, options) {
    return this.onCollection_(model, coll => coll.deleteOne(condition, options));
  }

  async deleteMany_(model, condition, options) {
    return this.onCollection_(model, coll => coll.deleteMany(condition, options));
  }

  async find_(model, condition, options) {
    return this.onCollection_(model, async coll => {
      let queryOptions = { ...options
      };
      let query = {};

      if (condition) {
        let {
          $projection,
          $orderBy,
          $offset,
          $limit,
          $query,
          ...others
        } = condition;

        if ($projection) {
          queryOptions.projection = $projection;
        }

        if ($orderBy) {
          queryOptions.sort = $orderBy;
        }

        if ($offset) {
          queryOptions.skip = $offset;
        }

        if ($limit) {
          queryOptions.limit = $limit;
        }

        Object.assign(query, _.pickBy(others, (v, k) => k[0] !== '$'));

        if ($query) {
          Object.assign(query, $query);
        }
      }

      let result = await coll.find(query, queryOptions).toArray();

      if (condition && condition.$totalCount) {
        let totalCount = await coll.find(query).count();
        return [result, totalCount];
      }

      return result;
    });
  }

  async aggregate_(model, pipeline, options) {
    return this.onCollection_(model, coll => coll.aggregate(pipeline, options));
  }

  async onCollection_(model, executor) {
    return this.execute_(db => executor(db.collection(model)));
  }

  _translateUpdate(update) {
    let ops = _.pick(update, UpdateOps);

    let others = _.omit(update, UpdateOps);

    if (ops.$set) {
      ops.$set = { ...ops.$set,
        ...others
      };
    } else if (!_.isEmpty(others)) {
      ops.$set = others;
    }

    return ops;
  }

}

MongodbConnector.driverLib = mongodb;
module.exports = MongodbConnector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kcml2ZXJzL21vbmdvZGIvQ29ubmVjdG9yLmpzIl0sIm5hbWVzIjpbIl8iLCJ3YWl0VW50aWxfIiwicmVxdWlyZSIsInRyeVJlcXVpcmUiLCJtb25nb2RiIiwiTW9uZ29DbGllbnQiLCJHcmlkRlNCdWNrZXQiLCJDb25uZWN0b3IiLCJHZW5lcmF0b3JzIiwiVXBkYXRlT3BzRmllbGQiLCJVcGRhdGVPcHNBcnJheSIsIlVwZGF0ZU9wcyIsImNvbmNhdCIsIk1vbmdvZGJDb25uZWN0b3IiLCJjb25zdHJ1Y3RvciIsImNvbm5lY3Rpb25TdHJpbmciLCJvcHRpb25zIiwiZmluZEFsbF8iLCJmaW5kXyIsImxvY2tlckZpZWxkIiwiZW5kXyIsImNsaWVudCIsImlzQ29ubmVjdGVkIiwiY2xvc2UiLCJsb2ciLCJnZXRDb25uZWN0aW9uU3RyaW5nV2l0aG91dENyZWRlbnRpYWwiLCJjb25uZWN0XyIsInVzZU5ld1VybFBhcnNlciIsImNvbm5lY3QiLCJkYiIsImRhdGFiYXNlIiwiZGlzY29ubmVjdF8iLCJjb25uIiwicGluZ18iLCJleGVjdXRlXyIsImxpc3RDb2xsZWN0aW9ucyIsIm5hbWVPbmx5IiwidG9BcnJheSIsImRiRXhlY3V0b3IiLCJlcnIiLCJjcmVhdGVHcmlkRlNCdWNrZXRfIiwiaW5zZXJ0T25lXyIsIm1vZGVsIiwiZGF0YSIsIm9uQ29sbGVjdGlvbl8iLCJjb2xsIiwiaW5zZXJ0T25lIiwiYnlwYXNzRG9jdW1lbnRWYWxpZGF0aW9uIiwiaW5zZXJ0TWFueV8iLCJpbnNlcnRNYW55Iiwib3JkZXJlZCIsImluc2VydE9uZUlmTm90RXhpc3RfIiwiZXJyb3IiLCJjb2RlIiwiZmluZE9uZUFuZFJlcGxhY2VfIiwiY29uZGl0aW9uIiwiZmluZE9uZUFuZFJlcGxhY2UiLCJmaW5kT25lQW5kVXBkYXRlXyIsImZpbmRPbmVBbmRVcGRhdGUiLCJfdHJhbnNsYXRlVXBkYXRlIiwiZmluZE9uZUFuZERlbGV0ZV8iLCJmaW5kT25lQW5kRGVsZXRlIiwiZmluZE9uZV8iLCJmaW5kT25lIiwidXBkYXRlT25lXyIsInVwZGF0ZU9uZSIsInVwZGF0ZU9uZUFuZFJldHVybl8iLCJyZXQiLCJ1cHNlcnQiLCJyZXR1cm5PcmlnaW5hbCIsInZhbHVlIiwidXBzZXJ0T25lXyIsInRyYW5zIiwiX2lkIiwib3RoZXJzIiwiJHNldCIsImlzTmlsIiwiJHNldE9uSW5zZXJ0IiwidXBzZXJ0TWFueV8iLCJ1bmlxdWVLZXlzIiwib3BzIiwibWFwIiwicmVjb3JkIiwidXBkYXRlRGF0YSIsInVwZGF0ZU9wIiwiZmlsdGVyIiwicGljayIsInVwZGF0ZSIsImJ1bGtXcml0ZSIsInVwZGF0ZU1hbnlBbmRSZXR1cm5fIiwibG9ja2VySWQiLCJzaG9ydGlkIiwidXBkYXRlTWFueSIsIiRleGlzdHMiLCJmaW5kIiwicHJvamVjdGlvbiIsInJlc3VsdCIsIm5Nb2RpZmllZCIsIiR1bnNldCIsImluc2VydE1hbnlJZk5vdEV4aXN0XyIsInVwZGF0ZU1hbnlfIiwicmVwbGFjZU9uZV8iLCJyZXBsYWNlT25lIiwiZGVsZXRlT25lXyIsImRlbGV0ZU9uZSIsImRlbGV0ZU1hbnlfIiwiZGVsZXRlTWFueSIsInF1ZXJ5T3B0aW9ucyIsInF1ZXJ5IiwiJHByb2plY3Rpb24iLCIkb3JkZXJCeSIsIiRvZmZzZXQiLCIkbGltaXQiLCIkcXVlcnkiLCJzb3J0Iiwic2tpcCIsImxpbWl0IiwiT2JqZWN0IiwiYXNzaWduIiwicGlja0J5IiwidiIsImsiLCIkdG90YWxDb3VudCIsInRvdGFsQ291bnQiLCJjb3VudCIsImFnZ3JlZ2F0ZV8iLCJwaXBlbGluZSIsImFnZ3JlZ2F0ZSIsImV4ZWN1dG9yIiwiY29sbGVjdGlvbiIsIm9taXQiLCJpc0VtcHR5IiwiZHJpdmVyTGliIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU07QUFBRUEsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQTtBQUFMLElBQW9CQyxPQUFPLENBQUMsVUFBRCxDQUFqQzs7QUFDQSxNQUFNO0FB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UUFBUSxDQUFDbkcsRUFBRSxDQUFDb0csVUFBSCxDQUFjdkYsS0FBZCxDQUFELENBQTVCLENBQVA7QUFDSDs7QUFFRGlCLEVBQUFBLGdCQUFnQixDQUFDNEIsTUFBRCxFQUFTO0FBQ3JCLFFBQUlQLEdBQUcsR0FBR2hGLENBQUMsQ0FBQ3NGLElBQUYsQ0FBT0MsTUFBUCxFQUFlNUUsU0FBZixDQUFWOztBQUNBLFFBQUkrRCxNQUFNLEdBQUcxRSxDQUFDLENBQUNrSSxJQUFGLENBQU8zQyxNQUFQLEVBQWU1RSxTQUFmLENBQWI7O0FBRUEsUUFBSXFFLEdBQUcsQ0FBQ0wsSUFBUixFQUFjO0FBQ1ZLLE1BQUFBLEdBQUcsQ0FBQ0wsSUFBSixHQUFXLEVBQUUsR0FBR0ssR0FBRyxDQUFDTCxJQUFUO0FBQWUsV0FBR0Q7QUFBbEIsT0FBWDtBQUNILEtBRkQsTUFFTyxJQUFJLENBQUMxRSxDQUFDLENBQUNtSSxPQUFGLENBQVV6RCxNQUFWLENBQUwsRUFBd0I7QUFDM0JNLE1BQUFBLEdBQUcsQ0FBQ0wsSUFBSixHQUFXRCxNQUFYO0FBQ0g7O0FBRUQsV0FBT00sR0FBUDtBQUNIOztBQTVWb0M7O0FBK1Z6Q25FLGdCQUFnQixDQUFDdUgsU0FBakIsR0FBNkJoSSxPQUE3QjtBQUVBaUksTUFBTSxDQUFDQyxPQUFQLEdBQWlCekgsZ0JBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgeyBfLCB3YWl0VW50aWxfIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyB0cnlSZXF1aXJlIH0gPSByZXF1aXJlKCcuLi8uLi91dGlscy9saWInKTtcbmNvbnN0IG1vbmdvZGIgPSB0cnlSZXF1aXJlKCdtb25nb2RiJyk7XG5jb25zdCB7IE1vbmdvQ2xpZW50LCBHcmlkRlNCdWNrZXQgfSA9IG1vbmdvZGI7XG5jb25zdCBDb25uZWN0b3IgPSByZXF1aXJlKCcuLi8uLi9Db25uZWN0b3InKTtcbmNvbnN0IEdlbmVyYXRvcnMgPSByZXF1aXJlKCcuLi8uLi9HZW5lcmF0b3JzJyk7XG5cbmNvbnN0IFVwZGF0ZU9wc0ZpZWxkID0gWyAnJGN1cnJlbnREYXRlJywgJyRpbmMnLCAnJG1pbicsICckbWF4JywgJyRtdWwnLCAnJHJlbmFtZScsICckc2V0JywgJyRzZXRPbkluc2VydCcsICckdW5zZXQnIF07XG5jb25zdCBVcGRhdGVPcHNBcnJheSA9IFsgJyRhZGRUb1NldCcsICckcG9wJywgJyRwdWxsJywgJyRwdXNoJywgJyRwdWxsQWxsJyBdO1xuY29uc3QgVXBkYXRlT3BzID0gVXBkYXRlT3BzRmllbGQuY29uY2F0KFVwZGF0ZU9wc0FycmF5KTtcblxuLyoqXG4gKiBNb25nb2RiIGRhdGEgc3RvcmFnZSBjb25uZWN0b3IuXG4gKiBAY2xhc3NcbiAqIEBleHRlbmRzIENvbm5lY3RvclxuICovXG5jbGFzcyBNb25nb2RiQ29ubmVjdG9yIGV4dGVuZHMgQ29ubmVjdG9yIHtcbiAgICAvKiogICAgICAgICAgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgXG4gICAgICogQHByb3BlcnR5IHtib29sZWFufSBbb3B0aW9ucy51c2VQcmVwYXJlZFN0YXRlbWVudF0gLSBcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3Rvcihjb25uZWN0aW9uU3RyaW5nLCBvcHRpb25zKSB7ICAgICAgICBcbiAgICAgICAgc3VwZXIoJ21vbmdvZGInLCBjb25uZWN0aW9uU3RyaW5nLCBvcHRpb25zKTsgICAgXG4gICAgICAgIFxuICAgICAgICB0aGlzLmxvY2tlckZpZWxkID0gdGhpcy5vcHRpb25zLmxvY2tlckZpZWxkIHx8ICdfX2xvY2tfXyc7XG4gICAgfVxuXG4gICAgZmluZEFsbF8gPSB0aGlzLmZpbmRfO1xuXG4gICAgLyoqXG4gICAgICogQ2xvc2UgYWxsIGNvbm5lY3Rpb24gaW5pdGlhdGVkIGJ5IHRoaXMgY29ubmVjdG9yLlxuICAgICAqL1xuICAgIGFzeW5jIGVuZF8oKSB7XG4gICAgICAgIGlmICh0aGlzLmNsaWVudCAmJiB0aGlzLmNsaWVudC5pc0Nvbm5lY3RlZCgpKSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmNsaWVudC5jbG9zZSgpO1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBgbW9uZ29kYjogc3VjY2Vzc2Z1bGx5IGRpc2Nvbm5lY3RlZCBmcm9tIFwiJHt0aGlzLmdldENvbm5lY3Rpb25TdHJpbmdXaXRob3V0Q3JlZGVudGlhbCgpfVwiLmApOyAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgfVxuXG4gICAgICAgIGRlbGV0ZSB0aGlzLmNsaWVudDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBkYXRhYmFzZSBjb25uZWN0aW9uIGJhc2VkIG9uIHRoZSBkZWZhdWx0IGNvbm5lY3Rpb24gc3RyaW5nIG9mIHRoZSBjb25uZWN0b3IgYW5kIGdpdmVuIG9wdGlvbnMuICAgICBcbiAgICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdIC0gRXh0cmEgb3B0aW9ucyBmb3IgdGhlIGNvbm5lY3Rpb24sIG9wdGlvbmFsLlxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbH0gW29wdGlvbnMubXVsdGlwbGVTdGF0ZW1lbnRzPWZhbHNlXSAtIEFsbG93IHJ1bm5pbmcgbXVsdGlwbGUgc3RhdGVtZW50cyBhdCBhIHRpbWUuXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbb3B0aW9ucy5jcmVhdGVEYXRhYmFzZT1mYWxzZV0gLSBGbGFnIHRvIHVzZWQgd2hlbiBjcmVhdGluZyBhIGRhdGFiYXNlLlxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjxEYj59XG4gICAgICovXG4gICAgYXN5bmMgY29ubmVjdF8ob3B0aW9ucykge1xuICAgICAgICBpZiAoIXRoaXMuY2xpZW50IHx8ICF0aGlzLmNsaWVudC5pc0Nvbm5lY3RlZCgpKSB7XG4gICAgICAgICAgICBsZXQgY2xpZW50ID0gbmV3IE1vbmdvQ2xpZW50KHRoaXMuY29ubmVjdGlvblN0cmluZywge3VzZU5ld1VybFBhcnNlcjogdHJ1ZX0pO1xuICAgICAgICAgICAgdGhpcy5jbGllbnQgPSBhd2FpdCBjbGllbnQuY29ubmVjdCgpOyBcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYG1vbmdvZGI6IHN1Y2Nlc3NmdWxseSBjb25uZWN0ZWQgdG8gXCIke3RoaXMuZ2V0Q29ubmVjdGlvblN0cmluZ1dpdGhvdXRDcmVkZW50aWFsKCl9XCIuYCk7ICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICB9ICAgICAgIFxuXG4gICAgICAgIHJldHVybiB0aGlzLmNsaWVudC5kYih0aGlzLmRhdGFiYXNlKTtcbiAgICB9XG4gICAgXG4gICAgLyoqXG4gICAgICogQ2xvc2UgYSBkYXRhYmFzZSBjb25uZWN0aW9uLlxuICAgICAqIEBwYXJhbSB7RGJ9IGNvbm4gLSBNeVNRTCBjb25uZWN0aW9uLlxuICAgICAqL1xuICAgIGFzeW5jIGRpc2Nvbm5lY3RfKGNvbm4pIHtcbiAgICB9XG5cbiAgICBhc3luYyBwaW5nXygpIHsgIFxuICAgICAgICByZXR1cm4gdGhpcy5leGVjdXRlXyhkYiA9PiB7XG4gICAgICAgICAgICByZXR1cm4gZGIubGlzdENvbGxlY3Rpb25zKG51bGwsIHsgbmFtZU9ubHk6IHRydWUgfSkudG9BcnJheSgpO1xuICAgICAgICB9KTsgIFxuICAgIH1cblxuICAgIGFzeW5jIGV4ZWN1dGVfKGRiRXhlY3V0b3IpIHtcbiAgICAgICAgbGV0IGRiO1xuICAgIFxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgZGIgPSBhd2FpdCB0aGlzLmNvbm5lY3RfKCk7XG5cbiAgICAgICAgICAgIHJldHVybiBhd2FpdCBkYkV4ZWN1dG9yKGRiKTtcbiAgICAgICAgfSBjYXRjaChlcnIpIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgIGRiICYmIGF3YWl0IHRoaXMuZGlzY29ubmVjdF8oZGIpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zXSAtIE9wdGlvbmFsIHNldHRpbmdzLlxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5idWNrZXROYW1lPSdmcyddIC0gVGhlICdmaWxlcycgYW5kICdjaHVua3MnIGNvbGxlY3Rpb25zIHdpbGwgYmUgcHJlZml4ZWQgd2l0aCB0aGUgYnVja2V0IG5hbWUgZm9sbG93ZWQgYnkgYSBkb3QuXG4gICAgICogQHByb3BlcnR5IHtudW1iZXJ9IFtvcHRpb25zLmNodW5rU2l6ZUJ5dGVzXSAtIE51bWJlciBvZiBieXRlcyBzdG9yZWQgaW4gZWFjaCBjaHVuay4gRGVmYXVsdHMgdG8gMjU1S0JcbiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gW29wdGlvbnMud3JpdGVDb25jZXJuXVxuICAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBbb3B0aW9ucy5yZWFkUHJlZmVyZW5jZV1cbiAgICAgKi9cbiAgICBhc3luYyBjcmVhdGVHcmlkRlNCdWNrZXRfKG9wdGlvbnMpIHtcbiAgICAgICAgbGV0IGRiID0gYXdhaXQgdGhpcy5jb25uZWN0XygpO1xuXG4gICAgICAgIHJldHVybiBuZXcgR3JpZEZTQnVja2V0KGRiLCBvcHRpb25zKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBuZXcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgaW5zZXJ0T25lXyhtb2RlbCwgZGF0YSwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5pbnNlcnRPbmUoZGF0YSwgeyBieXBhc3NEb2N1bWVudFZhbGlkYXRpb246IHRydWUsIC4uLm9wdGlvbnMgfSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhbiBhcnJheSBvZiBuZXcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge2FycmF5fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBpbnNlcnRNYW55Xyhtb2RlbCwgZGF0YSwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5pbnNlcnRNYW55KGRhdGEsIHsgYnlwYXNzRG9jdW1lbnRWYWxpZGF0aW9uOiB0cnVlLCBvcmRlcmVkOiBmYWxzZSwgLi4ub3B0aW9ucyB9KSk7XG4gICAgfVxuXG4gICAgYXN5bmMgaW5zZXJ0T25lSWZOb3RFeGlzdF8obW9kZWwsIGRhdGEsIG9wdGlvbnMpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCB0aGlzLmluc2VydE9uZV8obW9kZWwsIGRhdGEsIG9wdGlvbnMpXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBpZiAoZXJyb3IuY29kZSA9PT0gMTEwMDApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVwbGFjZSAoaW5zZXJ0IG9yIHVwZGF0ZSBmb3IgZXhzaXN0aW5nKSBhbiBlbnRpdHkgYW5kIHJldHVybiBvcmlnaW5hbCByZWNvcmQuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBmaW5kT25lQW5kUmVwbGFjZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5maW5kT25lQW5kUmVwbGFjZShjb25kaXRpb24sIGRhdGEsIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBGaW5kIGEgZG9jdW1lbnQgYW5kIHVwZGF0ZSBpdCBpbiBvbmUgYXRvbWljIG9wZXJhdGlvbi4gUmVxdWlyZXMgYSB3cml0ZSBsb2NrIGZvciB0aGUgZHVyYXRpb24gb2YgdGhlIG9wZXJhdGlvbi5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGZpbmRPbmVBbmRVcGRhdGVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgICAgIFxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5maW5kT25lQW5kVXBkYXRlKGNvbmRpdGlvbiwgdGhpcy5fdHJhbnNsYXRlVXBkYXRlKGRhdGEpLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgZmluZE9uZUFuZERlbGV0ZV8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5maW5kT25lQW5kRGVsZXRlKGNvbmRpdGlvbiwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIGFzeW5jIGZpbmRPbmVfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZmluZE9uZShjb25kaXRpb24sIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgYW4gZXhpc3RpbmcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgdXBkYXRlT25lXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7IFxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC51cGRhdGVPbmUoY29uZGl0aW9uLCB0aGlzLl90cmFuc2xhdGVVcGRhdGUoZGF0YSksIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICBhc3luYyB1cGRhdGVPbmVBbmRSZXR1cm5fKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgICAgIFxuICAgICAgICBsZXQgcmV0ID0gYXdhaXQgdGhpcy5maW5kT25lQW5kVXBkYXRlXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCB7IC4uLm9wdGlvbnMsIHVwc2VydDogZmFsc2UsIHJldHVybk9yaWdpbmFsOiBmYWxzZSB9KTtcbiAgICAgICAgcmV0dXJuIHJldCAmJiByZXQudmFsdWU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIGFuIGV4aXN0aW5nIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIHVwc2VydE9uZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykgeyBcbiAgICAgICAgbGV0IHRyYW5zID0gdGhpcy5fdHJhbnNsYXRlVXBkYXRlKGRhdGEpO1xuICAgICAgICBsZXQgeyBfaWQsIC4uLm90aGVycyB9ID0gdHJhbnMuJHNldDsgXG4gICAgICAgIGlmICghXy5pc05pbChfaWQpKSB7XG4gICAgICAgICAgICB0cmFucy4kc2V0ID0gb3RoZXJzO1xuICAgICAgICAgICAgdHJhbnMuJHNldE9uSW5zZXJ0ID0geyBfaWQgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLnVwZGF0ZU9uZShjb25kaXRpb24sIHRyYW5zLCB7IC4uLm9wdGlvbnMsIHVwc2VydDogdHJ1ZSB9KSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIG1hbnkgZW50aXRpZXMuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIC0gQXJyYXkgb2YgcmVjb3JkIHdpdGggX2lkXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIHVwc2VydE1hbnlfKG1vZGVsLCBkYXRhLCB1bmlxdWVLZXlzLCBvcHRpb25zKSB7IFxuICAgICAgICBsZXQgb3BzID0gZGF0YS5tYXAocmVjb3JkID0+IHtcbiAgICAgICAgICAgIGxldCB7IF9pZCwgLi4udXBkYXRlRGF0YSB9ID0gcmVjb3JkO1xuXG4gICAgICAgICAgICBsZXQgdXBkYXRlT3AgPSB7XG4gICAgICAgICAgICAgICAgJHNldDogdXBkYXRlRGF0YVxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgaWYgKF9pZCkge1xuICAgICAgICAgICAgICAgIHVwZGF0ZU9wLiRzZXRPbkluc2VydCA9IHsgX2lkIH07XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgdXBkYXRlT25lOiB7IGZpbHRlcjogeyAuLi5fLnBpY2socmVjb3JkLCB1bmlxdWVLZXlzKSB9LCB1cGRhdGU6IHVwZGF0ZU9wLCB1cHNlcnQ6IHRydWUgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuYnVsa1dyaXRlKG9wcywgeyBieXBhc3NEb2N1bWVudFZhbGlkYXRpb246IHRydWUsIG9yZGVyZWQ6IGZhbHNlLCAuLi5vcHRpb25zIH0pKTtcbiAgICB9XG5cbiAgICBhc3luYyB1cGRhdGVNYW55QW5kUmV0dXJuXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7ICAgICAgICBcbiAgICAgICAgbGV0IGxvY2tlcklkID0gR2VuZXJhdG9ycy5zaG9ydGlkKCk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgYXN5bmMgKGNvbGwpID0+IHtcbiAgICAgICAgICAgIC8vMS51cGRhdGUgYW5kIHNldCBsb2NrZXJcbiAgICAgICAgICAgIGxldCByZXQgPSBhd2FpdCBjb2xsLnVwZGF0ZU1hbnkoXG4gICAgICAgICAgICAgICAgeyAuLi5jb25kaXRpb24sIFt0aGlzLmxvY2tlckZpZWxkXTogeyAkZXhpc3RzOiBmYWxzZSB9IH0sIC8vIGZvciBhbGwgbm9uLWxvY2tlZFxuICAgICAgICAgICAgICAgIHsgJHNldDogeyAuLi5kYXRhLCBbdGhpcy5sb2NrZXJGaWVsZF06IGxvY2tlcklkIH0gfSwgLy8gbG9jayBpdCBcbiAgICAgICAgICAgICAgICB7IC4uLm9wdGlvbnMsIHVwc2VydDogZmFsc2UgfSApO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIC8vMi5yZXR1cm4gYWxsIGxvY2tlZCByZWNvcmRzXG4gICAgICAgICAgICAgICAgcmV0dXJuIGF3YWl0IGNvbGwuZmluZCh7IFt0aGlzLmxvY2tlckZpZWxkXTogbG9ja2VySWQgfSwgeyBwcm9qZWN0aW9uOiB7IFt0aGlzLmxvY2tlckZpZWxkXTogMCB9IH0pLnRvQXJyYXkoKTsgLy8gcmV0dXJuIGFsbCBsb2NrZWRcbiAgICAgICAgICAgIH0gZmluYWxseSB7ICAgIFxuICAgICAgICAgICAgICAgIC8vMy5yZW1vdmUgbG9ja2Vyc1xuICAgICAgICAgICAgICAgIGlmIChyZXQucmVzdWx0Lm5Nb2RpZmllZCA+IDApIHsgLy8gdW5sb2NrXG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IGNvbGwudXBkYXRlTWFueSh7IFt0aGlzLmxvY2tlckZpZWxkXTogbG9ja2VySWQgfSwgeyAkdW5zZXQ6IHsgW3RoaXMubG9ja2VyRmllbGRdOiBcIlwiIH0gfSwgeyB1cHNlcnQ6IGZhbHNlIH0pOyAgICBcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pOyAgICAgICAgIFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEluc2VydCBtYW55IGVudGl0aWVzIGlmIG5vdCBleGlzdC5cbiAgICAgKiBAcGFyYW0geyp9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IHVuaXF1ZUtleXMgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGluc2VydE1hbnlJZk5vdEV4aXN0Xyhtb2RlbCwgZGF0YSwgdW5pcXVlS2V5cywgb3B0aW9ucykge1xuICAgICAgICBsZXQgb3BzID0gZGF0YS5tYXAocmVjb3JkID0+ICh7XG4gICAgICAgICAgICB1cGRhdGVPbmU6IHsgZmlsdGVyOiB7IC4uLl8ucGljayhyZWNvcmQsIHVuaXF1ZUtleXMpIH0sIHVwZGF0ZTogeyAkc2V0T25JbnNlcnQ6IHJlY29yZCB9LCB1cHNlcnQ6IHRydWUgfVxuICAgICAgICB9KSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuYnVsa1dyaXRlKG9wcywgeyBieXBhc3NEb2N1bWVudFZhbGlkYXRpb246IHRydWUsIG9yZGVyZWQ6IGZhbHNlLCAuLi5vcHRpb25zIH0pKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgbXVsdGlwbGUgZG9jdW1lbnRzLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0geyp9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIHVwZGF0ZU1hbnlfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLnVwZGF0ZU1hbnkoY29uZGl0aW9uLCB0aGlzLl90cmFuc2xhdGVVcGRhdGUoZGF0YSksIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXBsYWNlIGFuIGV4aXN0aW5nIGVudGl0eSBvciBjcmVhdGUgYSBuZXcgb25lLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgcmVwbGFjZU9uZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykgeyAgXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLnJlcGxhY2VPbmUoY29uZGl0aW9uLCBkYXRhLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlIGFuIGV4aXN0aW5nIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGRlbGV0ZU9uZV8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5kZWxldGVPbmUoY29uZGl0aW9uLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlIGFuIGV4aXN0aW5nIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGRlbGV0ZU1hbnlfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZGVsZXRlTWFueShjb25kaXRpb24sIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBQZXJmb3JtIHNlbGVjdCBvcGVyYXRpb24uXG4gICAgICogQHBhcmFtIHsqfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgZmluZF8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCBhc3luYyBjb2xsID0+IHtcbiAgICAgICAgICAgIGxldCBxdWVyeU9wdGlvbnMgPSB7Li4ub3B0aW9uc307XG4gICAgICAgICAgICBsZXQgcXVlcnkgPSB7fTtcblxuICAgICAgICAgICAgaWYgKGNvbmRpdGlvbikge1xuICAgICAgICAgICAgICAgIGxldCB7ICRwcm9qZWN0aW9uLCAkb3JkZXJCeSwgJG9mZnNldCwgJGxpbWl0LCAkcXVlcnksIC4uLm90aGVycyB9ID0gY29uZGl0aW9uO1xuXG4gICAgICAgICAgICAgICAgaWYgKCRwcm9qZWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucy5wcm9qZWN0aW9uID0gJHByb2plY3Rpb247ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmICgkb3JkZXJCeSkge1xuICAgICAgICAgICAgICAgICAgICBxdWVyeU9wdGlvbnMuc29ydCA9ICRvcmRlckJ5OyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoJG9mZnNldCkge1xuICAgICAgICAgICAgICAgICAgICBxdWVyeU9wdGlvbnMuc2tpcCA9ICRvZmZzZXQ7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmICgkbGltaXQpIHtcbiAgICAgICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLmxpbWl0ID0gJGxpbWl0OyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBPYmplY3QuYXNzaWduKHF1ZXJ5LCBfLnBpY2tCeShvdGhlcnMsICh2LGspID0+IGtbMF0gIT09ICckJykpO1xuXG4gICAgICAgICAgICAgICAgaWYgKCRxdWVyeSkge1xuICAgICAgICAgICAgICAgICAgICBPYmplY3QuYXNzaWduKHF1ZXJ5LCAkcXVlcnkpO1xuICAgICAgICAgICAgICAgIH0gXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCByZXN1bHQgPSBhd2FpdCBjb2xsLmZpbmQocXVlcnksIHF1ZXJ5T3B0aW9ucykudG9BcnJheSgpO1xuXG4gICAgICAgICAgICBpZiAoY29uZGl0aW9uICYmIGNvbmRpdGlvbi4kdG90YWxDb3VudCkge1xuICAgICAgICAgICAgICAgIGxldCB0b3RhbENvdW50ID0gYXdhaXQgY29sbC5maW5kKHF1ZXJ5KS5jb3VudCgpO1xuICAgICAgICAgICAgICAgIHJldHVybiBbIHJlc3VsdCwgdG90YWxDb3VudCBdO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9KTtcbiAgICB9ICAgXG5cbiAgICBhc3luYyBhZ2dyZWdhdGVfKG1vZGVsLCBwaXBlbGluZSwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5hZ2dyZWdhdGUocGlwZWxpbmUsIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICBhc3luYyBvbkNvbGxlY3Rpb25fKG1vZGVsLCBleGVjdXRvcikge1xuICAgICAgICByZXR1cm4gdGhpcy5leGVjdXRlXyhkYiA9PiBleGVjdXRvcihkYi5jb2xsZWN0aW9uKG1vZGVsKSkpO1xuICAgIH1cblxuICAgIF90cmFuc2xhdGVVcGRhdGUodXBkYXRlKSB7XG4gICAgICAgIGxldCBvcHMgPSBfLnBpY2sodXBkYXRlLCBVcGRhdGVPcHMpO1xuICAgICAgICBsZXQgb3RoZXJzID0gXy5vbWl0KHVwZGF0ZSwgVXBkYXRlT3BzKTtcblxuICAgICAgICBpZiAob3BzLiRzZXQpIHtcbiAgICAgICAgICAgIG9wcy4kc2V0ID0geyAuLi5vcHMuJHNldCwgLi4ub3RoZXJzIH07XG4gICAgICAgIH0gZWxzZSBpZiAoIV8uaXNFbXB0eShvdGhlcnMpKSB7XG4gICAgICAgICAgICBvcHMuJHNldCA9IG90aGVycztcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBvcHM7XG4gICAgfVxufVxuXG5Nb25nb2RiQ29ubmVjdG9yLmRyaXZlckxpYiA9IG1vbmdvZGI7XG5cbm1vZHVsZS5leHBvcnRzID0gTW9uZ29kYkNvbm5lY3RvcjsiXX0=