"use strict";

require("source-map-support/register");

const {
  _,
  waitUntil_
} = require('rk-utils');

const {
  tryRequire
} = require('../../utils/lib');

const mongodb = tryRequire('mongodb');
const {
  MongoClient,
  GridFSBucket
} = mongodb;

const Connector = require('../../Connector');

const Generators = require('../../Generators');

const {
  InvalidArgument,
  DatabaseError
} = require('../../utils/Errors');

const UpdateOpsField = ['$currentDate', '$inc', '$min', '$max', '$mul', '$rename', '$set', '$setOnInsert', '$unset'];
const UpdateOpsArray = ['$addToSet', '$pop', '$pull', '$push', '$pullAll'];
const UpdateOps = UpdateOpsField.concat(UpdateOpsArray);

class MongodbConnector extends Connector {
  constructor(connectionString, options) {
    super('mongodb', connectionString, options);
    this.findAll_ = this.find_;
    this.lockerField = this.options.lockerField || '__lock__';
  }

  ensureInsertOne(opReturn) {
    if (opReturn.result.ok !== 1 || opReturn.result.n !== 1) {
      throw new DatabaseError('Mongodb "insertOne" operation failed');
    }

    return opReturn.insertedId;
  }

  ensureUpdateOne(opReturn, enforceUpdated) {
    if (opReturn.result.ok !== 1 || enforceUpdated && opReturn.result.nModified !== 1) {
      throw new DatabaseError('Mongodb "updateOne" operation failed');
    }
  }

  async end_() {
    if (this.client && this.client.isConnected()) {
      await this.client.close();
      this.log('verbose', `mongodb: successfully disconnected from "${this.getConnectionStringWithoutCredential()}".`);
    }

    delete this.client;
  }

  async connect_(options) {
    if (!this.client || !this.client.isConnected()) {
      let client = new MongoClient(this.connectionString, {
        useNewUrlParser: true
      });
      this.client = await client.connect();
      this.log('verbose', `mongodb: successfully connected to "${this.getConnectionStringWithoutCredential()}".`);
    }

    return this.client.db(this.database);
  }

  async disconnect_(conn) {}

  async ping_() {
    return this.execute_(db => {
      return db.listCollections(null, {
        nameOnly: true
      }).toArray();
    });
  }

  async execute_(dbExecutor) {
    let db;

    try {
      db = await this.connect_();
      return await dbExecutor(db);
    } catch (err) {
      throw err;
    } finally {
      db && (await this.disconnect_(db));
    }
  }

  async createGridFSBucket_(options) {
    let db = await this.connect_();
    return new GridFSBucket(db, options);
  }

  async insertOne_(model, data, options) {
    options = {
      bypassDocumentValidation: true,
      ...options
    };

    if (this.options.logStatement) {
      this.log('verbose', 'insertOne: ' + JSON.stringify({
        model,
        data,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.insertOne(data, options));
  }

  async insertMany_(model, data, options) {
    options = {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    };

    if (this.options.logStatement) {
      this.log('verbose', 'insertMany: ' + JSON.stringify({
        model,
        count: data.length,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.insertMany(data, options));
  }

  async insertOneIfNotExist_(model, data, options) {
    try {
      return await this.insertOne_(model, data, options);
    } catch (error) {
      if (error.code === 11000) {
        return false;
      }

      throw error;
    }
  }

  async updateOne_(model, data, condition, options) {
    data = this._translateUpdate(data);

    if (this.options.logStatement) {
      this.log('verbose', 'updateOne: ' + JSON.stringify({
        model,
        data,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.updateOne(condition, data, options));
  }

  async updateOneAndReturn_(model, data, condition, options) {
    let ret = await this.findOneAndUpdate_(model, data, condition, { ...options,
      upsert: false,
      returnOriginal: false
    });
    return ret && ret.value;
  }

  async upsertOne_(model, data, condition, options, dataOnInsert) {
    let trans = this._translateUpdate(data);

    let {
      _id,
      ...others
    } = trans.$set || {};

    if (!_.isNil(_id)) {
      trans.$set = others;
      trans.$setOnInsert = {
        _id
      };
    }

    if (!_.isEmpty(dataOnInsert)) {
      trans.$setOnInsert = { ...trans.$setOnInsert,
        ...dataOnInsert
      };
    }

    options = { ...options,
      upsert: true
    };

    if (this.options.logStatement) {
      this.log('verbose', 'upsertOne: ' + JSON.stringify({
        model,
        data: trans,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.updateOne(condition, trans, options));
  }

  async upsertOneAndReturn_(model, data, condition, options, dataOnInsert) {
    let trans = this._translateUpdate(data);

    let {
      _id,
      ...others
    } = trans.$set || {};

    if (!_.isNil(_id)) {
      trans.$set = others;
      trans.$setOnInsert = {
        _id
      };
    }

    if (!_.isEmpty(dataOnInsert)) {
      trans.$setOnInsert = { ...trans.$setOnInsert,
        ...dataOnInsert
      };
    }

    options = { ...options,
      upsert: true,
      returnOriginal: false
    };

    if (this.options.logStatement) {
      this.log('verbose', 'upsertOne: ' + JSON.stringify({
        model,
        data: trans,
        condition,
        options
      }));
    }

    let ret = await this.onCollection_(model, coll => coll.findOneAndUpdate(condition, trans, options));
    return ret && ret.value;
  }

  async upsertMany_(model, data, uniqueKeys, options, dataOnInsert) {
    let ops = data.map(record => {
      let {
        _id,
        ...updateData
      } = record;

      let updateOp = this._translateUpdate(updateData);

      if (_id) {
        updateOp.$setOnInsert = {
          _id,
          ...dataOnInsert
        };
      } else if (!_.isEmpty(dataOnInsert)) {
        updateOp.$setOnInsert = dataOnInsert;
      }

      return {
        updateOne: {
          filter: { ..._.pick(record, uniqueKeys)
          },
          update: updateOp,
          upsert: true
        }
      };
    });
    options = {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    };

    if (this.options.logStatement) {
      this.log('verbose', 'bulkWrite: ' + JSON.stringify({
        model,
        count: ops.length,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.bulkWrite(ops, options));
  }

  async updateManyAndReturn_(model, data, condition, options) {
    let lockerId = Generators.shortid();

    if (this.options.logStatement) {
      this.log('verbose', 'updateMany+find+updateMany: ' + JSON.stringify({
        model,
        count: data.length,
        condition,
        options
      }));
    }

    return this.onCollection_(model, async coll => {
      let ret = await coll.updateMany({ ...condition,
        [this.lockerField]: {
          $exists: false
        }
      }, {
        $set: { ...data,
          [this.lockerField]: lockerId
        }
      }, { ...options,
        upsert: false
      });

      try {
        return await coll.find({
          [this.lockerField]: lockerId
        }, {
          projection: {
            [this.lockerField]: 0
          }
        }).toArray();
      } finally {
        if (ret.result.nModified > 0) {
          await coll.updateMany({
            [this.lockerField]: lockerId
          }, {
            $unset: {
              [this.lockerField]: ""
            }
          }, {
            upsert: false
          });
        }
      }
    });
  }

  async insertManyIfNotExist_(model, data, uniqueKeys, options) {
    console.log('buggy: tofix');
    let ops = data.map(record => ({
      updateOne: {
        filter: { ..._.pick(record, uniqueKeys)
        },
        update: {
          $setOnInsert: record
        },
        upsert: true
      }
    }));
    return this.onCollection_(model, coll => coll.bulkWrite(ops, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async updateMany_(model, data, condition, options) {
    data = this._translateUpdate(data);

    if (this.options.logStatement) {
      this.log('verbose', 'updateMany: ' + JSON.stringify({
        model,
        count: data.length,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.updateMany(condition, data, options));
  }

  async replaceOne_(model, data, condition, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'replaceOne: ' + JSON.stringify({
        model,
        data,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.replaceOne(condition, data, options));
  }

  async deleteOne_(model, condition, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'deleteOne: ' + JSON.stringify({
        model,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.deleteOne(condition, options));
  }

  async deleteMany_(model, condition, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'deleteMany: ' + JSON.stringify({
        model,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.deleteMany(condition, options));
  }

  async findOneAndReplace_(model, data, condition, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'findOneAndReplace: ' + JSON.stringify({
        model,
        data,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.findOneAndReplace(condition, data, options));
  }

  async findOneAndUpdate_(model, data, condition, options) {
    data = this._translateUpdate(data);

    if (this.options.logStatement) {
      this.log('verbose', 'findOneAndUpdate: ' + JSON.stringify({
        model,
        data,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.findOneAndUpdate(condition, data, options));
  }

  async findOneAndDelete_(model, condition, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'findOneAndDelete: ' + JSON.stringify({
        model,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.findOneAndDelete(condition, options));
  }

  async findOne_(model, condition, options) {
    let queryOptions = { ...options
    };
    let query;

    if (!_.isEmpty(condition)) {
      let {
        $projection,
        $query,
        ...others
      } = condition;

      if ($projection) {
        queryOptions.projection = $projection;
      }

      query = { ...others,
        ...$query
      };
    } else {
      throw new InvalidArgument('findOne requires non-empty query condition.');
    }

    if (this.options.logStatement) {
      this.log('verbose', 'findOne: ' + JSON.stringify({
        model,
        condition: query,
        options: queryOptions
      }));
    }

    return this.onCollection_(model, coll => coll.findOne(query, queryOptions));
  }

  async find_(model, condition, options) {
    let queryOptions = { ...options
    };
    let query, requireTotalCount;

    if (!_.isEmpty(condition)) {
      let {
        $projection,
        $totalCount,
        $orderBy,
        $offset,
        $limit,
        $query,
        ...others
      } = condition;

      if ($projection) {
        queryOptions.projection = $projection;
      }

      if ($orderBy) {
        queryOptions.sort = $orderBy;
      }

      if ($offset) {
        queryOptions.skip = $offset;
      }

      if ($limit) {
        queryOptions.limit = $limit;
      }

      query = { ...others,
        ...$query
      };
      requireTotalCount = $totalCount;
    } else {
      query = {};
      requireTotalCount = false;
    }

    if (this.options.logStatement) {
      this.log('verbose', 'find: ' + JSON.stringify({
        model,
        condition: query,
        options: queryOptions
      }));
    }

    return this.onCollection_(model, async coll => {
      let result = await coll.find(query, queryOptions).toArray();

      if (requireTotalCount) {
        let totalCount = await coll.find(query).count();
        return [result, totalCount];
      }

      return result;
    });
  }

  async aggregate_(model, pipeline, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'aggregate: ' + JSON.stringify({
        model,
        pipeline,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.aggregate(pipeline, options).toArray());
  }

  async distinct_(model, field, query, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'distinct: ' + JSON.stringify({
        model,
        field,
        query,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.distinct(field, query, options));
  }

  async count_(model, query, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'count: ' + JSON.stringify({
        model,
        query,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.countDocuments(query, options));
  }

  async onCollection_(model, executor) {
    return this.execute_(db => executor(db.collection(model)));
  }

  _translateUpdate(update) {
    let ops = _.pick(update, UpdateOps);

    let others = _.omit(update, UpdateOps);

    if (ops.$set) {
      ops.$set = { ...ops.$set,
        ...others
      };
    } else if (!_.isEmpty(others)) {
      ops.$set = others;
    }

    return ops;
  }

}

MongodbConnector.driverLib = mongodb;
module.exports = MongodbConnector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kcml2ZXJzL21vbmdvZGIvQ29ubmVjdG9yLmpzIl0sIm5hbWVzIjpbIl8iLCJ3YWl0VW50aWxfIiwicmVxdWlyZSIsInRyeVJlcXVpcmUiLCJtb25nb2RiIiwiTW9uZ29DbGllbnQiLCJHcmlkRlNCdWNrZXQiLCJDb25uZWN0b3IiLCJHZW5lcmF0b3JzIiwiSW52YWxpZEFyZ3VtZW50IiwiRGF0YWJhc2VFcnJvciIsIlVwZGF0ZU9wc0ZpZWxkIiwiVXBkYXRlT3BzQXJyYXkiLCJVcGRhdGVPcHMiLCJjb25jYXQiLCJNb25nb2RiQ29ubmVjdG9yIiwiY29uc3RydWN0b3IiLCJjb25uZWN0aW9uU3RyaW5nIiwib3B0aW9ucyIsImZpbmRBbGxfIiwiZmluZF8iLCJsb2NrZXJGaWVsZCIsImVuc3VyZUluc2VydE9uZSIsIm9wUmV0dXJuIiwicmVzdWx0Iiwib2siLCJuIiwiaW5zZXJ0ZWRJZCIsImVuc3VyZVVwZGF0ZU9uZSIsImVuZm9yY2VVcGRhdGVkIiwibk1vZGlmaWVkIiwiZW5kXyIsImNsaWVudCIsImlzQ29ubmVjdGVkIiwiY2xvc2UiLCJsb2ciLCJnZXRDb25uZWN0aW9uU3RyaW5nV2l0aG91dENyZWRlbnRpYWwiLCJjb25uZWN0XyIsInVzZU5ld1VybFBhcnNlciIsImNvbm5lY3QiLCJkYiIsImRhdGFiYXNlIiwiZGlzY29ubmVjdF8iLCJjb25uIiwicGluZ18iLCJleGVjdXRlXyIsImxpc3RDb2xsZWN0aW9ucyIsIm5hbWVPbmx5IiwidG9BcnJheSIsImRiRXhlY3V0b3IiLCJlcnIiLCJjcmVhdGVHcmlkRlNCdWNrZXRfIiwiaW5zZXJ0T25lXyIsIm1vZGVsIiwiZGF0YSIsImJ5cGFzc0RvY3VtZW50VmFsaWRhdGlvbiIsImxvZ1N0YXRlbWVudCIsIkpTT04iLCJzdHJpbmdpZnkiLCJvbkNvbGxlY3Rpb25fIiwiY29sbCIsImluc2VydE9uZSIsImluc2VydE1hbnlfIiwib3JkZXJlZCIsImNvdW50IiwibGVuZ3RoIiwiaW5zZXJ0TWFueSIsImluc2VydE9uZUlmTm90RXhpc3RfIiwiZXJyb3IiLCJjb2RlIiwidXBkYXRlT25lXyIsImNvbmRpdGlvbiIsIl90cmFuc2xhdGVVcGRhdGUiLCJ1cGRhdGVPbmUiLCJ1cGRhdGVPbmVBbmRSZXR1cm5fIiwicmV0IiwiZmluZE9uZUFuZFVwZGF0ZV8iLCJ1cHNlcnQiLCJyZXR1cm5PcmlnaW5hbCIsInZhbHVlIiwidXBzZXJ0T25lXyIsImRhdGFPbkluc2VydCIsInRyYW5zIiwiX2lkIiwib3RoZXJzIiwiJHNldCIsImlzTmlsIiwiJHNldE9uSW5zZXJ0IiwiaXNFbXB0eSIsInVwc2VydE9uZUFuZFJldHVybl8iLCJmaW5kT25lQW5kVXBkYXRlIiwidXBzZXJ0TWFueV8iLCJ1bmlxdWVLZXlzIiwib3BzIiwibWFwIiwicmVjb3JkIiwidXBkYXRlRGF0YSIsInVwZGF0ZU9wIiwiZmlsdGVyIiwicGljayIsInVwZGF0ZSIsImJ1bGtXcml0ZSIsInVwZGF0ZU1hbnlBbmRSZXR1cm5fIiwibG9ja2VySWQiLCJzaG9ydGlkIiwidXBkYXRlTWFueSIsIiRleGlzdHMiLCJmaW5kIiwicHJvamVjdGlvbiIsIiR1bnNldCIsImluc2VydE1hbnlJZk5vdEV4aXN0XyIsImNvbnNvbGUiLCJ1cGRhdGVNYW55XyIsInJlcGxhY2VPbmVfIiwicmVwbGFjZU9uZSIsImRlbGV0ZU9uZV8iLCJkZWxldGVPbmUiLCJkZWxldGVNYW55XyIsImRlbGV0ZU1hbnkiLCJmaW5kT25lQW5kUmVwbGFjZV8iLCJmaW5kT25lQW5kUmVwbGFjZSIsImZpbmRPbmVBbmREZWxldGVfIiwiZmluZE9uZUFuZERlbGV0ZSIsImZpbmRPbmVfIiwicXVlcnlPcHRpb25zIiwicXVlcnkiLCIkcHJvamVjdGlvbiIsIiRxdWVyeSIsImZpbmRPbmUiLCJyZXF1aXJlVG90YWxDb3VudCIsIiR0b3RhbENvdW50IiwiJG9yZGVyQnkiLCIkb2Zmc2V0IiwiJGxpbWl0Iiwic29ydCIsInNraXAiLCJsaW1pdCIsInRvdGFsQ291bnQiLCJhZ2dyZWdhdGVfIiwicGlwZWxpbmUiLCJhZ2dyZWdhdGUiLCJkaXN0aW5jdF8iLCJmaWVsZCIsImRpc3RpbmN0IiwiY291bnRfIiwiY291bnREb2N1bWVudHMiLCJleGVjdXRvciIsImNvbGxlY3Rpb24iLCJvbWl0IiwiZHJpdmVyTGliIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU07QUFBRUEsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQTtBQUFMLElBQW9CQyxPQUFPLENBQUMsVUFBRCxDQUFqQzs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBO0FBQUYsSUFBaUJELE9BQU8sQ0FBQyxpQkFBRCxDQUE5Qjs7QUFDQSxNQUFNRSxPQUFPLEdBQUdELFVBQVUsQ0FBQyxTQUFELENBQTFCO0FBQ0EsTUFBTTtBQUFFRSxFQUFBQSxXQUFGO0FBQWVDLEVBQUFBO0FBQWYsSUFBZ0NGLE9BQXRDOztBQUNBLE1BQU1HLFNBQVMsR0FBR0wsT0FBTyxDQUFDLGlCQUFELENBQXpCOztBQUNBLE1BQU1NLFVBQVUsR0FBR04sT0FBTyxDQUFDLGtCQUFELENBQTFCOztBQUNBLE1BQU07QUFBRU8sRUFBQUEsZUFBRjtBQUFtQkMsRUFBQUE7QUFBbkIsSUFBcUNSLE9BQU8sQ0FBQyxvQkFBRCxDQUFsRDs7QUFFQSxNQUFNUyxjQUFjLEdBQUcsQ0FBRSxjQUFGLEVBQWtCLE1BQWxCLEVBQTBCLE1BQTFCLEVBQWtDLE1BQWxDLEVBQTBDLE1BQTFDLEVBQWtELFNBQWxELEVBQTZELE1BQTdELEVBQXFFLGNBQXJFLEVBQXFGLFFBQXJGLENBQXZCO0FBQ0EsTUFBTUMsY0FBYyxHQUFHLENBQUUsV0FBRixFQUFlLE1BQWYsRUFBdUIsT0FBdkIsRUFBZ0MsT0FBaEMsRUFBeUMsVUFBekMsQ0FBdkI7QUFDQSxNQUFNQyxTQUFTLEdBQUdGLGNBQWMsQ0FBQ0csTUFBZixDQUFzQkYsY0FBdEIsQ0FBbEI7O0FBT0EsTUFBTUcsZ0JBQU4sU0FBK0JSLFNBQS9CLENBQXlDO0FBTXJDUyxFQUFBQSxXQUFXLENBQUNDLGdC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LCB3YWl0VW50aWxfIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyB0cnlSZXF1aXJlIH0gPSByZXF1aXJlKCcuLi8uLi91dGlscy9saWInKTtcbmNvbnN0IG1vbmdvZGIgPSB0cnlSZXF1aXJlKCdtb25nb2RiJyk7XG5jb25zdCB7IE1vbmdvQ2xpZW50LCBHcmlkRlNCdWNrZXQgfSA9IG1vbmdvZGI7XG5jb25zdCBDb25uZWN0b3IgPSByZXF1aXJlKCcuLi8uLi9Db25uZWN0b3InKTtcbmNvbnN0IEdlbmVyYXRvcnMgPSByZXF1aXJlKCcuLi8uLi9HZW5lcmF0b3JzJyk7XG5jb25zdCB7IEludmFsaWRBcmd1bWVudCwgRGF0YWJhc2VFcnJvciB9ID0gcmVxdWlyZSgnLi4vLi4vdXRpbHMvRXJyb3JzJyk7XG5cbmNvbnN0IFVwZGF0ZU9wc0ZpZWxkID0gWyAnJGN1cnJlbnREYXRlJywgJyRpbmMnLCAnJG1pbicsICckbWF4JywgJyRtdWwnLCAnJHJlbmFtZScsICckc2V0JywgJyRzZXRPbkluc2VydCcsICckdW5zZXQnIF07XG5jb25zdCBVcGRhdGVPcHNBcnJheSA9IFsgJyRhZGRUb1NldCcsICckcG9wJywgJyRwdWxsJywgJyRwdXNoJywgJyRwdWxsQWxsJyBdO1xuY29uc3QgVXBkYXRlT3BzID0gVXBkYXRlT3BzRmllbGQuY29uY2F0KFVwZGF0ZU9wc0FycmF5KTtcblxuLyoqXG4gKiBNb25nb2RiIGRhdGEgc3RvcmFnZSBjb25uZWN0b3IuXG4gKiBAY2xhc3NcbiAqIEBleHRlbmRzIENvbm5lY3RvclxuICovXG5jbGFzcyBNb25nb2RiQ29ubmVjdG9yIGV4dGVuZHMgQ29ubmVjdG9yIHtcbiAgICAvKiogICAgICAgICAgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgXG4gICAgICogQHByb3BlcnR5IHtib29sZWFufSBbb3B0aW9ucy51c2VQcmVwYXJlZFN0YXRlbWVudF0gLSBcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3Rvcihjb25uZWN0aW9uU3RyaW5nLCBvcHRpb25zKSB7ICAgICAgICBcbiAgICAgICAgc3VwZXIoJ21vbmdvZGInLCBjb25uZWN0aW9uU3RyaW5nLCBvcHRpb25zKTsgICAgXG4gICAgICAgIFxuICAgICAgICB0aGlzLmxvY2tlckZpZWxkID0gdGhpcy5vcHRpb25zLmxvY2tlckZpZWxkIHx8ICdfX2xvY2tfXyc7XG4gICAgfVxuXG4gICAgZmluZEFsbF8gPSB0aGlzLmZpbmRfO1xuXG4gICAgLyoqXG4gICAgICogVGhyb3cgZGIgZXJyb3IgaWYgbm8gcmVjb3JkIGluc2VydGVkXG4gICAgICogQHBhcmFtIHtpbnNlcnRPbmVXcml0ZU9wUmVzdWx0T2JqZWN0fSBvcFJldHVybiBcbiAgICAgKi9cbiAgICBlbnN1cmVJbnNlcnRPbmUob3BSZXR1cm4pIHtcbiAgICAgICAgaWYgKG9wUmV0dXJuLnJlc3VsdC5vayAhPT0gMSB8fCBvcFJldHVybi5yZXN1bHQubiAhPT0gMSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IERhdGFiYXNlRXJyb3IoJ01vbmdvZGIgXCJpbnNlcnRPbmVcIiBvcGVyYXRpb24gZmFpbGVkJyk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gb3BSZXR1cm4uaW5zZXJ0ZWRJZDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUaHJvdyBkYiBlcnJvciBpZiBubyByZWNvcmQgdXBkYXRlZFxuICAgICAqIEBwYXJhbSB7dXBkYXRlV3JpdGVPcFJlc3VsdE9iamVjdH0gb3BSZXR1cm4gXG4gICAgICovXG4gICAgZW5zdXJlVXBkYXRlT25lKG9wUmV0dXJuLCBlbmZvcmNlVXBkYXRlZCkge1xuICAgICAgICBpZiAob3BSZXR1cm4ucmVzdWx0Lm9rICE9PSAxIHx8IChlbmZvcmNlVXBkYXRlZCAmJiBvcFJldHVybi5yZXN1bHQubk1vZGlmaWVkICE9PSAxKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IERhdGFiYXNlRXJyb3IoJ01vbmdvZGIgXCJ1cGRhdGVPbmVcIiBvcGVyYXRpb24gZmFpbGVkJyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDbG9zZSBhbGwgY29ubmVjdGlvbiBpbml0aWF0ZWQgYnkgdGhpcyBjb25uZWN0b3IuXG4gICAgICovXG4gICAgYXN5bmMgZW5kXygpIHtcbiAgICAgICAgaWYgKHRoaXMuY2xpZW50ICYmIHRoaXMuY2xpZW50LmlzQ29ubmVjdGVkKCkpIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuY2xpZW50LmNsb3NlKCk7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGBtb25nb2RiOiBzdWNjZXNzZnVsbHkgZGlzY29ubmVjdGVkIGZyb20gXCIke3RoaXMuZ2V0Q29ubmVjdGlvblN0cmluZ1dpdGhvdXRDcmVkZW50aWFsKCl9XCIuYCk7ICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICB9XG5cbiAgICAgICAgZGVsZXRlIHRoaXMuY2xpZW50O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIGRhdGFiYXNlIGNvbm5lY3Rpb24gYmFzZWQgb24gdGhlIGRlZmF1bHQgY29ubmVjdGlvbiBzdHJpbmcgb2YgdGhlIGNvbm5lY3RvciBhbmQgZ2l2ZW4gb3B0aW9ucy4gICAgIFxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc10gLSBFeHRyYSBvcHRpb25zIGZvciB0aGUgY29ubmVjdGlvbiwgb3B0aW9uYWwuXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbb3B0aW9ucy5tdWx0aXBsZVN0YXRlbWVudHM9ZmFsc2VdIC0gQWxsb3cgcnVubmluZyBtdWx0aXBsZSBzdGF0ZW1lbnRzIGF0IGEgdGltZS5cbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtvcHRpb25zLmNyZWF0ZURhdGFiYXNlPWZhbHNlXSAtIEZsYWcgdG8gdXNlZCB3aGVuIGNyZWF0aW5nIGEgZGF0YWJhc2UuXG4gICAgICogQHJldHVybnMge1Byb21pc2UuPERiPn1cbiAgICAgKi9cbiAgICBhc3luYyBjb25uZWN0XyhvcHRpb25zKSB7XG4gICAgICAgIGlmICghdGhpcy5jbGllbnQgfHwgIXRoaXMuY2xpZW50LmlzQ29ubmVjdGVkKCkpIHtcbiAgICAgICAgICAgIGxldCBjbGllbnQgPSBuZXcgTW9uZ29DbGllbnQodGhpcy5jb25uZWN0aW9uU3RyaW5nLCB7dXNlTmV3VXJsUGFyc2VyOiB0cnVlfSk7XG4gICAgICAgICAgICB0aGlzLmNsaWVudCA9IGF3YWl0IGNsaWVudC5jb25uZWN0KCk7IFxuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBgbW9uZ29kYjogc3VjY2Vzc2Z1bGx5IGNvbm5lY3RlZCB0byBcIiR7dGhpcy5nZXRDb25uZWN0aW9uU3RyaW5nV2l0aG91dENyZWRlbnRpYWwoKX1cIi5gKTsgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgIH0gICAgICAgXG5cbiAgICAgICAgcmV0dXJuIHRoaXMuY2xpZW50LmRiKHRoaXMuZGF0YWJhc2UpO1xuICAgIH1cbiAgICBcbiAgICAvKipcbiAgICAgKiBDbG9zZSBhIGRhdGFiYXNlIGNvbm5lY3Rpb24uXG4gICAgICogQHBhcmFtIHtEYn0gY29ubiAtIE15U1FMIGNvbm5lY3Rpb24uXG4gICAgICovXG4gICAgYXN5bmMgZGlzY29ubmVjdF8oY29ubikge1xuICAgIH1cblxuICAgIGFzeW5jIHBpbmdfKCkgeyAgXG4gICAgICAgIHJldHVybiB0aGlzLmV4ZWN1dGVfKGRiID0+IHtcbiAgICAgICAgICAgIHJldHVybiBkYi5saXN0Q29sbGVjdGlvbnMobnVsbCwgeyBuYW1lT25seTogdHJ1ZSB9KS50b0FycmF5KCk7XG4gICAgICAgIH0pOyAgXG4gICAgfVxuXG4gICAgYXN5bmMgZXhlY3V0ZV8oZGJFeGVjdXRvcikge1xuICAgICAgICBsZXQgZGI7XG4gICAgXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBkYiA9IGF3YWl0IHRoaXMuY29ubmVjdF8oKTtcblxuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IGRiRXhlY3V0b3IoZGIpO1xuICAgICAgICB9IGNhdGNoKGVycikgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgICAgZGIgJiYgYXdhaXQgdGhpcy5kaXNjb25uZWN0XyhkYik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gW29wdGlvbnNdIC0gT3B0aW9uYWwgc2V0dGluZ3MuXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLmJ1Y2tldE5hbWU9J2ZzJ10gLSBUaGUgJ2ZpbGVzJyBhbmQgJ2NodW5rcycgY29sbGVjdGlvbnMgd2lsbCBiZSBwcmVmaXhlZCB3aXRoIHRoZSBidWNrZXQgbmFtZSBmb2xsb3dlZCBieSBhIGRvdC5cbiAgICAgKiBAcHJvcGVydHkge251bWJlcn0gW29wdGlvbnMuY2h1bmtTaXplQnl0ZXNdIC0gTnVtYmVyIG9mIGJ5dGVzIHN0b3JlZCBpbiBlYWNoIGNodW5rLiBEZWZhdWx0cyB0byAyNTVLQlxuICAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBbb3B0aW9ucy53cml0ZUNvbmNlcm5dXG4gICAgICogQHByb3BlcnR5IHtvYmplY3R9IFtvcHRpb25zLnJlYWRQcmVmZXJlbmNlXVxuICAgICAqL1xuICAgIGFzeW5jIGNyZWF0ZUdyaWRGU0J1Y2tldF8ob3B0aW9ucykge1xuICAgICAgICBsZXQgZGIgPSBhd2FpdCB0aGlzLmNvbm5lY3RfKCk7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBHcmlkRlNCdWNrZXQoZGIsIG9wdGlvbnMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIG5ldyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBpbnNlcnRPbmVfKG1vZGVsLCBkYXRhLCBvcHRpb25zKSB7XG4gICAgICAgIG9wdGlvbnMgPSB7IGJ5cGFzc0RvY3VtZW50VmFsaWRhdGlvbjogdHJ1ZSwgLi4ub3B0aW9ucyB9O1xuXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdpbnNlcnRPbmU6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIGRhdGEsIG9wdGlvbnN9KSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5pbnNlcnRPbmUoZGF0YSwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhbiBhcnJheSBvZiBuZXcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge2FycmF5fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBpbnNlcnRNYW55Xyhtb2RlbCwgZGF0YSwgb3B0aW9ucykge1xuICAgICAgICBvcHRpb25zID0geyBieXBhc3NEb2N1bWVudFZhbGlkYXRpb246IHRydWUsIG9yZGVyZWQ6IGZhbHNlLCAuLi5vcHRpb25zIH07XG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdpbnNlcnRNYW55OiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBjb3VudDogZGF0YS5sZW5ndGgsIG9wdGlvbnN9KSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuaW5zZXJ0TWFueShkYXRhLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgbmV3IGVudGl0eSBpZiBub3QgZXhpc3QuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgaW5zZXJ0T25lSWZOb3RFeGlzdF8obW9kZWwsIGRhdGEsIG9wdGlvbnMpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCB0aGlzLmluc2VydE9uZV8obW9kZWwsIGRhdGEsIG9wdGlvbnMpXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBpZiAoZXJyb3IuY29kZSA9PT0gMTEwMDApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIGFuIGV4aXN0aW5nIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIHVwZGF0ZU9uZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykgeyBcbiAgICAgICAgZGF0YSA9IHRoaXMuX3RyYW5zbGF0ZVVwZGF0ZShkYXRhKTtcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ3VwZGF0ZU9uZTogJyArIEpTT04uc3RyaW5naWZ5KHttb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zfSkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLnVwZGF0ZU9uZShjb25kaXRpb24sIGRhdGEsIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgYW4gZXhpc3RpbmcgZW50aXR5IGFuZCByZXR1cm4gdGhlIHVwZGF0ZWQgcmVjb3JkLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0geyp9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIHVwZGF0ZU9uZUFuZFJldHVybl8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykgeyAgICAgICAgICAgIFxuICAgICAgICBsZXQgcmV0ID0gYXdhaXQgdGhpcy5maW5kT25lQW5kVXBkYXRlXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCB7IC4uLm9wdGlvbnMsIHVwc2VydDogZmFsc2UsIHJldHVybk9yaWdpbmFsOiBmYWxzZSB9KTtcbiAgICAgICAgcmV0dXJuIHJldCAmJiByZXQudmFsdWU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIGFuIGV4aXN0aW5nIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhT25JbnNlcnQgLSBTaGFyZWQgZGF0YSBvbiBpbnNlcnRcbiAgICAgKi9cbiAgICBhc3luYyB1cHNlcnRPbmVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMsIGRhdGFPbkluc2VydCkgeyBcbiAgICAgICAgbGV0IHRyYW5zID0gdGhpcy5fdHJhbnNsYXRlVXBkYXRlKGRhdGEpO1xuICAgICAgICBsZXQgeyBfaWQsIC4uLm90aGVycyB9ID0gdHJhbnMuJHNldCB8fCB7fTsgXG4gICAgICAgIGlmICghXy5pc05pbChfaWQpKSB7XG4gICAgICAgICAgICB0cmFucy4kc2V0ID0gb3RoZXJzO1xuICAgICAgICAgICAgdHJhbnMuJHNldE9uSW5zZXJ0ID0geyBfaWQgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghXy5pc0VtcHR5KGRhdGFPbkluc2VydCkpIHtcbiAgICAgICAgICAgIHRyYW5zLiRzZXRPbkluc2VydCA9IHsgLi4udHJhbnMuJHNldE9uSW5zZXJ0LCAuLi5kYXRhT25JbnNlcnQgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIG9wdGlvbnMgPSB7IC4uLm9wdGlvbnMsIHVwc2VydDogdHJ1ZSB9O1xuXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICd1cHNlcnRPbmU6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIGRhdGE6IHRyYW5zLCBjb25kaXRpb24sIG9wdGlvbnN9KSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC51cGRhdGVPbmUoY29uZGl0aW9uLCB0cmFucywgb3B0aW9ucykpOyAgICAgICAgXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBzZXJ0IGFuIGVudGl0eSBhbmQgcmV0dXJuIHVwZGF0ZWQuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YU9uSW5zZXJ0IC0gU2hhcmVkIGRhdGEgb24gaW5zZXJ0XG4gICAgICovXG4gICAgYXN5bmMgdXBzZXJ0T25lQW5kUmV0dXJuXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zLCBkYXRhT25JbnNlcnQpIHsgXG4gICAgICAgIGxldCB0cmFucyA9IHRoaXMuX3RyYW5zbGF0ZVVwZGF0ZShkYXRhKTtcbiAgICAgICAgbGV0IHsgX2lkLCAuLi5vdGhlcnMgfSA9IHRyYW5zLiRzZXQgfHwge307IFxuICAgICAgICBpZiAoIV8uaXNOaWwoX2lkKSkge1xuICAgICAgICAgICAgdHJhbnMuJHNldCA9IG90aGVycztcbiAgICAgICAgICAgIHRyYW5zLiRzZXRPbkluc2VydCA9IHsgX2lkIH07XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIV8uaXNFbXB0eShkYXRhT25JbnNlcnQpKSB7XG4gICAgICAgICAgICB0cmFucy4kc2V0T25JbnNlcnQgPSB7IC4uLnRyYW5zLiRzZXRPbkluc2VydCwgLi4uZGF0YU9uSW5zZXJ0IH07XG4gICAgICAgIH1cblxuICAgICAgICBvcHRpb25zID0geyAuLi5vcHRpb25zLCB1cHNlcnQ6IHRydWUsIHJldHVybk9yaWdpbmFsOiBmYWxzZSB9O1xuXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICd1cHNlcnRPbmU6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIGRhdGE6IHRyYW5zLCBjb25kaXRpb24sIG9wdGlvbnN9KSk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgcmV0ID0gYXdhaXQgdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5maW5kT25lQW5kVXBkYXRlKGNvbmRpdGlvbiwgdHJhbnMsIG9wdGlvbnMpKTtcbiAgICAgICAgcmV0dXJuIHJldCAmJiByZXQudmFsdWU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIG1hbnkgZW50aXRpZXMuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIC0gQXJyYXkgb2YgcmVjb3JkIHdpdGggX2lkXG4gICAgICogQHBhcmFtIHthcnJheX0gdW5pcXVlS2V5cyAtIFVuaXF1ZSBrZXlzIGluIHRoZSBkYXRhIHJlY29yZCB1c2VkIGFzIGZpbHRlclxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YU9uSW5zZXJ0IC0gU2hhcmVkIGRhdGEgb24gaW5zZXJ0XG4gICAgICovXG4gICAgYXN5bmMgdXBzZXJ0TWFueV8obW9kZWwsIGRhdGEsIHVuaXF1ZUtleXMsIG9wdGlvbnMsIGRhdGFPbkluc2VydCkgeyBcbiAgICAgICAgbGV0IG9wcyA9IGRhdGEubWFwKHJlY29yZCA9PiB7XG4gICAgICAgICAgICBsZXQgeyBfaWQsIC4uLnVwZGF0ZURhdGEgfSA9IHJlY29yZDtcblxuICAgICAgICAgICAgbGV0IHVwZGF0ZU9wID0gdGhpcy5fdHJhbnNsYXRlVXBkYXRlKHVwZGF0ZURhdGEpO1xuXG4gICAgICAgICAgICBpZiAoX2lkKSB7XG4gICAgICAgICAgICAgICAgdXBkYXRlT3AuJHNldE9uSW5zZXJ0ID0geyBfaWQsIC4uLmRhdGFPbkluc2VydCB9O1xuICAgICAgICAgICAgfSBlbHNlIGlmICghXy5pc0VtcHR5KGRhdGFPbkluc2VydCkpIHtcbiAgICAgICAgICAgICAgICB1cGRhdGVPcC4kc2V0T25JbnNlcnQgPSBkYXRhT25JbnNlcnQ7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgdXBkYXRlT25lOiB7IGZpbHRlcjogeyAuLi5fLnBpY2socmVjb3JkLCB1bmlxdWVLZXlzKSB9LCB1cGRhdGU6IHVwZGF0ZU9wLCB1cHNlcnQ6IHRydWUgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgb3B0aW9ucyA9IHsgYnlwYXNzRG9jdW1lbnRWYWxpZGF0aW9uOiB0cnVlLCBvcmRlcmVkOiBmYWxzZSwgLi4ub3B0aW9ucyB9O1xuXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdidWxrV3JpdGU6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIGNvdW50OiBvcHMubGVuZ3RoLCBvcHRpb25zfSkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuYnVsa1dyaXRlKG9wcywgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZSBtYW55IGVudGl0aWVzIGFuZCByZXR1cm4gdXBkYXRlZC5cbiAgICAgKiBAcGFyYW0geyp9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgdXBkYXRlTWFueUFuZFJldHVybl8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykgeyAgICAgICAgXG4gICAgICAgIGxldCBsb2NrZXJJZCA9IEdlbmVyYXRvcnMuc2hvcnRpZCgpO1xuXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICd1cGRhdGVNYW55K2ZpbmQrdXBkYXRlTWFueTogJyArIEpTT04uc3RyaW5naWZ5KHttb2RlbCwgY291bnQ6IGRhdGEubGVuZ3RoLCBjb25kaXRpb24sIG9wdGlvbnN9KSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCBhc3luYyAoY29sbCkgPT4ge1xuICAgICAgICAgICAgLy8xLnVwZGF0ZSBhbmQgc2V0IGxvY2tlclxuICAgICAgICAgICAgbGV0IHJldCA9IGF3YWl0IGNvbGwudXBkYXRlTWFueShcbiAgICAgICAgICAgICAgICB7IC4uLmNvbmRpdGlvbiwgW3RoaXMubG9ja2VyRmllbGRdOiB7ICRleGlzdHM6IGZhbHNlIH0gfSwgLy8gZm9yIGFsbCBub24tbG9ja2VkXG4gICAgICAgICAgICAgICAgeyAkc2V0OiB7IC4uLmRhdGEsIFt0aGlzLmxvY2tlckZpZWxkXTogbG9ja2VySWQgfSB9LCAvLyBsb2NrIGl0IFxuICAgICAgICAgICAgICAgIHsgLi4ub3B0aW9ucywgdXBzZXJ0OiBmYWxzZSB9ICk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgLy8yLnJldHVybiBhbGwgbG9ja2VkIHJlY29yZHNcbiAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgY29sbC5maW5kKHsgW3RoaXMubG9ja2VyRmllbGRdOiBsb2NrZXJJZCB9LCB7IHByb2plY3Rpb246IHsgW3RoaXMubG9ja2VyRmllbGRdOiAwIH0gfSkudG9BcnJheSgpOyAvLyByZXR1cm4gYWxsIGxvY2tlZFxuICAgICAgICAgICAgfSBmaW5hbGx5IHsgICAgXG4gICAgICAgICAgICAgICAgLy8zLnJlbW92ZSBsb2NrZXJzXG4gICAgICAgICAgICAgICAgaWYgKHJldC5yZXN1bHQubk1vZGlmaWVkID4gMCkgeyAvLyB1bmxvY2tcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgY29sbC51cGRhdGVNYW55KHsgW3RoaXMubG9ja2VyRmllbGRdOiBsb2NrZXJJZCB9LCB7ICR1bnNldDogeyBbdGhpcy5sb2NrZXJGaWVsZF06IFwiXCIgfSB9LCB7IHVwc2VydDogZmFsc2UgfSk7ICAgIFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7ICAgICAgICAgXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogSW5zZXJ0IG1hbnkgZW50aXRpZXMgaWYgbm90IGV4aXN0LlxuICAgICAqIEBwYXJhbSB7Kn0gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gdW5pcXVlS2V5cyBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgaW5zZXJ0TWFueUlmTm90RXhpc3RfKG1vZGVsLCBkYXRhLCB1bmlxdWVLZXlzLCBvcHRpb25zKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdidWdneTogdG9maXgnKTtcbiAgICAgICAgbGV0IG9wcyA9IGRhdGEubWFwKHJlY29yZCA9PiAoe1xuICAgICAgICAgICAgdXBkYXRlT25lOiB7IGZpbHRlcjogeyAuLi5fLnBpY2socmVjb3JkLCB1bmlxdWVLZXlzKSB9LCB1cGRhdGU6IHsgJHNldE9uSW5zZXJ0OiByZWNvcmQgfSwgdXBzZXJ0OiB0cnVlIH1cbiAgICAgICAgfSkpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmJ1bGtXcml0ZShvcHMsIHsgYnlwYXNzRG9jdW1lbnRWYWxpZGF0aW9uOiB0cnVlLCBvcmRlcmVkOiBmYWxzZSwgLi4ub3B0aW9ucyB9KSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIG11bHRpcGxlIGRvY3VtZW50cy5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyB1cGRhdGVNYW55Xyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7IFxuICAgICAgICBkYXRhID0gdGhpcy5fdHJhbnNsYXRlVXBkYXRlKGRhdGEpO1xuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ1N0YXRlbWVudCkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAndXBkYXRlTWFueTogJyArIEpTT04uc3RyaW5naWZ5KHttb2RlbCwgY291bnQ6IGRhdGEubGVuZ3RoLCBjb25kaXRpb24sIG9wdGlvbnN9KSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC51cGRhdGVNYW55KGNvbmRpdGlvbiwgZGF0YSwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlcGxhY2UgYW4gZXhpc3RpbmcgZW50aXR5IG9yIGNyZWF0ZSBhIG5ldyBvbmUuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyByZXBsYWNlT25lXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdyZXBsYWNlT25lOiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnN9KSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5yZXBsYWNlT25lKGNvbmRpdGlvbiwgZGF0YSwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZSBhbiBleGlzdGluZyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBkZWxldGVPbmVfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ2RlbGV0ZU9uZTogJyArIEpTT04uc3RyaW5naWZ5KHttb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zfSkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZGVsZXRlT25lKGNvbmRpdGlvbiwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZSBhbiBleGlzdGluZyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBkZWxldGVNYW55Xyhtb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdkZWxldGVNYW55OiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBjb25kaXRpb24sIG9wdGlvbnN9KSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZGVsZXRlTWFueShjb25kaXRpb24sIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXBsYWNlIChpbnNlcnQgb3IgdXBkYXRlIGZvciBleHNpc3RpbmcpIGFuIGVudGl0eSBhbmQgcmV0dXJuIG9yaWdpbmFsIHJlY29yZC5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGZpbmRPbmVBbmRSZXBsYWNlXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdmaW5kT25lQW5kUmVwbGFjZTogJyArIEpTT04uc3RyaW5naWZ5KHttb2RlbCwgZGF0YSwgb3B0aW9uc30pKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5maW5kT25lQW5kUmVwbGFjZShjb25kaXRpb24sIGRhdGEsIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBGaW5kIGEgZG9jdW1lbnQgYW5kIHVwZGF0ZSBpdCBpbiBvbmUgYXRvbWljIG9wZXJhdGlvbi4gUmVxdWlyZXMgYSB3cml0ZSBsb2NrIGZvciB0aGUgZHVyYXRpb24gb2YgdGhlIG9wZXJhdGlvbi5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGZpbmRPbmVBbmRVcGRhdGVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgICAgIFxuICAgICAgICBkYXRhID0gdGhpcy5fdHJhbnNsYXRlVXBkYXRlKGRhdGEpO1xuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ1N0YXRlbWVudCkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAnZmluZE9uZUFuZFVwZGF0ZTogJyArIEpTT04uc3RyaW5naWZ5KHttb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zfSkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmZpbmRPbmVBbmRVcGRhdGUoY29uZGl0aW9uLCBkYXRhLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgZmluZE9uZUFuZERlbGV0ZV8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ1N0YXRlbWVudCkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAnZmluZE9uZUFuZERlbGV0ZTogJyArIEpTT04uc3RyaW5naWZ5KHttb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zfSkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmZpbmRPbmVBbmREZWxldGUoY29uZGl0aW9uLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgZmluZE9uZV8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICBsZXQgcXVlcnlPcHRpb25zID0gey4uLm9wdGlvbnN9O1xuICAgICAgICBsZXQgcXVlcnk7XG5cbiAgICAgICAgaWYgKCFfLmlzRW1wdHkoY29uZGl0aW9uKSkge1xuICAgICAgICAgICAgbGV0IHsgJHByb2plY3Rpb24sICRxdWVyeSwgLi4ub3RoZXJzIH0gPSBjb25kaXRpb247XG5cbiAgICAgICAgICAgIGlmICgkcHJvamVjdGlvbikge1xuICAgICAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucy5wcm9qZWN0aW9uID0gJHByb2plY3Rpb247ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBxdWVyeSA9IHsgLi4ub3RoZXJzLCAuLi4kcXVlcnkgfTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkQXJndW1lbnQoJ2ZpbmRPbmUgcmVxdWlyZXMgbm9uLWVtcHR5IHF1ZXJ5IGNvbmRpdGlvbi4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdmaW5kT25lOiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBjb25kaXRpb246IHF1ZXJ5LCBvcHRpb25zOiBxdWVyeU9wdGlvbnN9KSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5maW5kT25lKHF1ZXJ5LCBxdWVyeU9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBQZXJmb3JtIHNlbGVjdCBvcGVyYXRpb24uXG4gICAgICogQHBhcmFtIHsqfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgZmluZF8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICBsZXQgcXVlcnlPcHRpb25zID0gey4uLm9wdGlvbnN9O1xuICAgICAgICBsZXQgcXVlcnksIHJlcXVpcmVUb3RhbENvdW50O1xuXG4gICAgICAgIGlmICghXy5pc0VtcHR5KGNvbmRpdGlvbikpIHtcbiAgICAgICAgICAgIGxldCB7ICRwcm9qZWN0aW9uLCAkdG90YWxDb3VudCwgJG9yZGVyQnksICRvZmZzZXQsICRsaW1pdCwgJHF1ZXJ5LCAuLi5vdGhlcnMgfSA9IGNvbmRpdGlvbjtcblxuICAgICAgICAgICAgaWYgKCRwcm9qZWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLnByb2plY3Rpb24gPSAkcHJvamVjdGlvbjsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICgkb3JkZXJCeSkge1xuICAgICAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucy5zb3J0ID0gJG9yZGVyQnk7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoJG9mZnNldCkge1xuICAgICAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucy5za2lwID0gJG9mZnNldDsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICgkbGltaXQpIHtcbiAgICAgICAgICAgICAgICBxdWVyeU9wdGlvbnMubGltaXQgPSAkbGltaXQ7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBxdWVyeSA9IHsgLi4ub3RoZXJzLCAuLi4kcXVlcnkgfTtcbiAgICAgICAgICAgIHJlcXVpcmVUb3RhbENvdW50ID0gJHRvdGFsQ291bnQ7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBxdWVyeSA9IHt9O1xuICAgICAgICAgICAgcmVxdWlyZVRvdGFsQ291bnQgPSBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdmaW5kOiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBjb25kaXRpb246IHF1ZXJ5LCBvcHRpb25zOiBxdWVyeU9wdGlvbnN9KSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCBhc3luYyBjb2xsID0+IHsgICAgICAgICAgICBcbiAgICAgICAgICAgIGxldCByZXN1bHQgPSBhd2FpdCBjb2xsLmZpbmQocXVlcnksIHF1ZXJ5T3B0aW9ucykudG9BcnJheSgpO1xuXG4gICAgICAgICAgICBpZiAocmVxdWlyZVRvdGFsQ291bnQpIHtcbiAgICAgICAgICAgICAgICBsZXQgdG90YWxDb3VudCA9IGF3YWl0IGNvbGwuZmluZChxdWVyeSkuY291bnQoKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gWyByZXN1bHQsIHRvdGFsQ291bnQgXTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgfSk7XG4gICAgfSAgIFxuXG4gICAgYXN5bmMgYWdncmVnYXRlXyhtb2RlbCwgcGlwZWxpbmUsIG9wdGlvbnMpIHsgICAgICAgIFxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ1N0YXRlbWVudCkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAnYWdncmVnYXRlOiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBwaXBlbGluZSwgb3B0aW9uc30pKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5hZ2dyZWdhdGUocGlwZWxpbmUsIG9wdGlvbnMpLnRvQXJyYXkoKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgZGlzdGluY3RfKG1vZGVsLCBmaWVsZCwgcXVlcnksIG9wdGlvbnMpIHsgICAgICAgIFxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ1N0YXRlbWVudCkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAnZGlzdGluY3Q6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIGZpZWxkLCBxdWVyeSwgb3B0aW9uc30pKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5kaXN0aW5jdChmaWVsZCwgcXVlcnksIG9wdGlvbnMpKTtcbiAgICB9ICAgIFxuXG4gICAgYXN5bmMgY291bnRfKG1vZGVsLCBxdWVyeSwgb3B0aW9ucykge1xuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ1N0YXRlbWVudCkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAnY291bnQ6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIHF1ZXJ5LCBvcHRpb25zfSkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmNvdW50RG9jdW1lbnRzKHF1ZXJ5LCBvcHRpb25zKSk7ICAgICAgICBcbiAgICB9XG5cbiAgICBhc3luYyBvbkNvbGxlY3Rpb25fKG1vZGVsLCBleGVjdXRvcikge1xuICAgICAgICByZXR1cm4gdGhpcy5leGVjdXRlXyhkYiA9PiBleGVjdXRvcihkYi5jb2xsZWN0aW9uKG1vZGVsKSkpO1xuICAgIH1cblxuICAgIF90cmFuc2xhdGVVcGRhdGUodXBkYXRlKSB7XG4gICAgICAgIGxldCBvcHMgPSBfLnBpY2sodXBkYXRlLCBVcGRhdGVPcHMpO1xuICAgICAgICBsZXQgb3RoZXJzID0gXy5vbWl0KHVwZGF0ZSwgVXBkYXRlT3BzKTtcblxuICAgICAgICBpZiAob3BzLiRzZXQpIHtcbiAgICAgICAgICAgIG9wcy4kc2V0ID0geyAuLi5vcHMuJHNldCwgLi4ub3RoZXJzIH07XG4gICAgICAgIH0gZWxzZSBpZiAoIV8uaXNFbXB0eShvdGhlcnMpKSB7XG4gICAgICAgICAgICBvcHMuJHNldCA9IG90aGVycztcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBvcHM7XG4gICAgfVxufVxuXG5Nb25nb2RiQ29ubmVjdG9yLmRyaXZlckxpYiA9IG1vbmdvZGI7XG5cbm1vZHVsZS5leHBvcnRzID0gTW9uZ29kYkNvbm5lY3RvcjsiXX0=