"use strict";

require("source-map-support/register");

const {
  _,
  waitUntil_
} = require('rk-utils');

const {
  tryRequire
} = require('../../utils/lib');

const mongodb = tryRequire('mongodb');
const {
  MongoClient,
  GridFSBucket
} = mongodb;

const Connector = require('../../Connector');

const Generators = require('../../Generators');

const {
  InvalidArgument
} = require('../../utils/Errors');

const UpdateOpsField = ['$currentDate', '$inc', '$min', '$max', '$mul', '$rename', '$set', '$setOnInsert', '$unset'];
const UpdateOpsArray = ['$addToSet', '$pop', '$pull', '$push', '$pullAll'];
const UpdateOps = UpdateOpsField.concat(UpdateOpsArray);

class MongodbConnector extends Connector {
  constructor(connectionString, options) {
    super('mongodb', connectionString, options);
    this.findAll_ = this.find_;
    this.lockerField = this.options.lockerField || '__lock__';
  }

  async end_() {
    if (this.client && this.client.isConnected()) {
      await this.client.close();
      this.log('verbose', `mongodb: successfully disconnected from "${this.getConnectionStringWithoutCredential()}".`);
    }

    delete this.client;
  }

  async connect_(options) {
    if (!this.client || !this.client.isConnected()) {
      let client = new MongoClient(this.connectionString, {
        useNewUrlParser: true
      });
      this.client = await client.connect();
      this.log('verbose', `mongodb: successfully connected to "${this.getConnectionStringWithoutCredential()}".`);
    }

    return this.client.db(this.database);
  }

  async disconnect_(conn) {}

  async ping_() {
    return this.execute_(db => {
      return db.listCollections(null, {
        nameOnly: true
      }).toArray();
    });
  }

  async execute_(dbExecutor) {
    let db;

    try {
      db = await this.connect_();
      return await dbExecutor(db);
    } catch (err) {
      throw err;
    } finally {
      db && (await this.disconnect_(db));
    }
  }

  async createGridFSBucket_(options) {
    let db = await this.connect_();
    return new GridFSBucket(db, options);
  }

  async insertOne_(model, data, options) {
    options = {
      bypassDocumentValidation: true,
      ...options
    };

    if (this.options.logStatement) {
      this.log('verbose', 'insertOne: ' + JSON.stringify({
        model,
        data,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.insertOne(data, options));
  }

  async insertMany_(model, data, options) {
    options = {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    };

    if (this.options.logStatement) {
      this.log('verbose', 'insertMany: ' + JSON.stringify({
        model,
        count: data.length,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.insertMany(data, options));
  }

  async insertOneIfNotExist_(model, data, options) {
    try {
      return await this.insertOne_(model, data, options);
    } catch (error) {
      if (error.code === 11000) {
        return false;
      }

      throw error;
    }
  }

  async updateOne_(model, data, condition, options) {
    data = this._translateUpdate(data);

    if (this.options.logStatement) {
      this.log('verbose', 'updateOne: ' + JSON.stringify({
        model,
        data,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.updateOne(condition, data, options));
  }

  async updateOneAndReturn_(model, data, condition, options) {
    let ret = await this.findOneAndUpdate_(model, data, condition, { ...options,
      upsert: false,
      returnOriginal: false
    });
    return ret && ret.value;
  }

  async upsertOne_(model, data, condition, options, dataOnInsert) {
    let trans = this._translateUpdate(data);

    let {
      _id,
      ...others
    } = trans.$set;

    if (!_.isNil(_id)) {
      trans.$set = others;
      trans.$setOnInsert = {
        _id
      };
    }

    if (!_.isEmpty(dataOnInsert)) {
      trans.$setOnInsert = { ...trans.$setOnInsert,
        ...dataOnInsert
      };
    }

    options = { ...options,
      upsert: true
    };

    if (this.options.logStatement) {
      this.log('verbose', 'upsertOne: ' + JSON.stringify({
        model,
        data: trans,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.updateOne(condition, trans, options));
  }

  async upsertMany_(model, data, uniqueKeys, options, dataOnInsert) {
    let ops = data.map(record => {
      let {
        _id,
        ...updateData
      } = record;

      let updateOp = this._translateUpdate(updateData);

      if (_id) {
        updateOp.$setOnInsert = {
          _id,
          ...dataOnInsert
        };
      } else if (!_.isEmpty(dataOnInsert)) {
        updateOp.$setOnInsert = dataOnInsert;
      }

      return {
        updateOne: {
          filter: { ..._.pick(record, uniqueKeys)
          },
          update: updateOp,
          upsert: true
        }
      };
    });
    options = {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    };

    if (this.options.logStatement) {
      this.log('verbose', 'bulkWrite: ' + JSON.stringify({
        model,
        count: ops.length,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.bulkWrite(ops, options));
  }

  async updateManyAndReturn_(model, data, condition, options) {
    let lockerId = Generators.shortid();

    if (this.options.logStatement) {
      this.log('verbose', 'updateMany+find+updateMany: ' + JSON.stringify({
        model,
        count: data.length,
        condition,
        options
      }));
    }

    return this.onCollection_(model, async coll => {
      let ret = await coll.updateMany({ ...condition,
        [this.lockerField]: {
          $exists: false
        }
      }, {
        $set: { ...data,
          [this.lockerField]: lockerId
        }
      }, { ...options,
        upsert: false
      });

      try {
        return await coll.find({
          [this.lockerField]: lockerId
        }, {
          projection: {
            [this.lockerField]: 0
          }
        }).toArray();
      } finally {
        if (ret.result.nModified > 0) {
          await coll.updateMany({
            [this.lockerField]: lockerId
          }, {
            $unset: {
              [this.lockerField]: ""
            }
          }, {
            upsert: false
          });
        }
      }
    });
  }

  async insertManyIfNotExist_(model, data, uniqueKeys, options) {
    console.log('buggy: tofix');
    let ops = data.map(record => ({
      updateOne: {
        filter: { ..._.pick(record, uniqueKeys)
        },
        update: {
          $setOnInsert: record
        },
        upsert: true
      }
    }));
    return this.onCollection_(model, coll => coll.bulkWrite(ops, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async updateMany_(model, data, condition, options) {
    data = this._translateUpdate(data);

    if (this.options.logStatement) {
      this.log('verbose', 'updateMany: ' + JSON.stringify({
        model,
        count: data.length,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.updateMany(condition, data, options));
  }

  async replaceOne_(model, data, condition, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'replaceOne: ' + JSON.stringify({
        model,
        data,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.replaceOne(condition, data, options));
  }

  async deleteOne_(model, condition, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'deleteOne: ' + JSON.stringify({
        model,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.deleteOne(condition, options));
  }

  async deleteMany_(model, condition, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'deleteMany: ' + JSON.stringify({
        model,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.deleteMany(condition, options));
  }

  async findOneAndReplace_(model, data, condition, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'findOneAndReplace: ' + JSON.stringify({
        model,
        data,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.findOneAndReplace(condition, data, options));
  }

  async findOneAndUpdate_(model, data, condition, options) {
    data = this._translateUpdate(data);

    if (this.options.logStatement) {
      this.log('verbose', 'findOneAndUpdate: ' + JSON.stringify({
        model,
        data,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.findOneAndUpdate(condition, data, options));
  }

  async findOneAndDelete_(model, condition, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'findOneAndDelete: ' + JSON.stringify({
        model,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.findOneAndDelete(condition, options));
  }

  async findOne_(model, condition, options) {
    let queryOptions = { ...options
    };
    let query;

    if (!_.isEmpty(condition)) {
      let {
        $projection,
        $query,
        ...others
      } = condition;

      if ($projection) {
        queryOptions.projection = $projection;
      }

      query = { ...others,
        ...$query
      };
    } else {
      throw new InvalidArgument('findOne requires non-empty query condition.');
    }

    if (this.options.logStatement) {
      this.log('verbose', 'findOne: ' + JSON.stringify({
        model,
        condition: query,
        options: queryOptions
      }));
    }

    return this.onCollection_(model, coll => coll.findOne(query, queryOptions));
  }

  async find_(model, condition, options) {
    let queryOptions = { ...options
    };
    let query;

    if (!_.isEmpty(condition)) {
      let {
        $projection,
        $orderBy,
        $offset,
        $limit,
        $query,
        ...others
      } = condition;

      if ($projection) {
        queryOptions.projection = $projection;
      }

      if ($orderBy) {
        queryOptions.sort = $orderBy;
      }

      if ($offset) {
        queryOptions.skip = $offset;
      }

      if ($limit) {
        queryOptions.limit = $limit;
      }

      query = { ...others,
        ...$query
      };
    } else {
      query = {};
    }

    if (this.options.logStatement) {
      this.log('verbose', 'find: ' + JSON.stringify({
        model,
        condition: query,
        options: queryOptions
      }));
    }

    return this.onCollection_(model, async coll => {
      let result = await coll.find(query, queryOptions).toArray();

      if (condition && condition.$totalCount) {
        let totalCount = await coll.find(query).count();
        return [result, totalCount];
      }

      return result;
    });
  }

  async aggregate_(model, pipeline, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'aggregate: ' + JSON.stringify({
        model,
        pipeline,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.aggregate(pipeline, options).toArray());
  }

  async onCollection_(model, executor) {
    return this.execute_(db => executor(db.collection(model)));
  }

  _translateUpdate(update) {
    let ops = _.pick(update, UpdateOps);

    let others = _.omit(update, UpdateOps);

    if (ops.$set) {
      ops.$set = { ...ops.$set,
        ...others
      };
    } else if (!_.isEmpty(others)) {
      ops.$set = others;
    }

    return ops;
  }

}

MongodbConnector.driverLib = mongodb;
module.exports = MongodbConnector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kcml2ZXJzL21vbmdvZGIvQ29ubmVjdG9yLmpzIl0sIm5hbWVzIjpbIl8iLCJ3YWl0VW50aWxfIiwicmVxdWlyZSIsInRyeVJlcXVpcmUiLCJtb25nb2RiIiwiTW9uZ29DbGllbnQiLCJHcmlkRlNCdWNrZXQiLCJDb25uZWN0b3IiLCJHZW5lcmF0b3JzIiwiSW52YWxpZEFyZ3VtZW50IiwiVXBkYXRlT3BzRmllbGQiLCJVcGRhdGVPcHNBcnJheSIsIlVwZGF0ZU9wcyIsImNvbmNhdCIsIk1vbmdvZGJDb25uZWN0b3IiLCJjb25zdHJ1Y3RvciIsImNvbm5lY3Rpb25TdHJpbmciLCJvcHRpb25zIiwiZmluZEFsbF8iLCJmaW5kXyIsImxvY2tlckZpZWxkIiwiZW5kXyIsImNsaWVudCIsImlzQ29ubmVjdGVkIiwiY2xvc2UiLCJsb2ciLCJnZXRDb25uZWN0aW9uU3RyaW5nV2l0aG91dENyZWRlbnRpYWwiLCJjb25uZWN0XyIsInVzZU5ld1VybFBhcnNlciIsImNvbm5lY3QiLCJkYiIsImRhdGFiYXNlIiwiZGlzY29ubmVjdF8iLCJjb25uIiwicGluZ18iLCJleGVjdXRlXyIsImxpc3RDb2xsZWN0aW9ucyIsIm5hbWVPbmx5IiwidG9BcnJheSIsImRiRXhlY3V0b3IiLCJlcnIiLCJjcmVhdGVHcmlkRlNCdWNrZXRfIiwiaW5zZXJ0T25lXyIsIm1vZGVsIiwiZGF0YSIsImJ5cGFzc0RvY3VtZW50VmFsaWRhdGlvbiIsImxvZ1N0YXRlbWVudCIsIkpTT04iLCJzdHJpbmdpZnkiLCJvbkNvbGxlY3Rpb25fIiwiY29sbCIsImluc2VydE9uZSIsImluc2VydE1hbnlfIiwib3JkZXJlZCIsImNvdW50IiwibGVuZ3RoIiwiaW5zZXJ0TWFueSIsImluc2VydE9uZUlmTm90RXhpc3RfIiwiZXJyb3IiLCJjb2RlIiwidXBkYXRlT25lXyIsImNvbmRpdGlvbiIsIl90cmFuc2xhdGVVcGRhdGUiLCJ1cGRhdGVPbmUiLCJ1cGRhdGVPbmVBbmRSZXR1cm5fIiwicmV0IiwiZmluZE9uZUFuZFVwZGF0ZV8iLCJ1cHNlcnQiLCJyZXR1cm5PcmlnaW5hbCIsInZhbHVlIiwidXBzZXJ0T25lXyIsImRhdGFPbkluc2VydCIsInRyYW5zIiwiX2lkIiwib3RoZXJzIiwiJHNldCIsImlzTmlsIiwiJHNldE9uSW5zZXJ0IiwiaXNFbXB0eSIsInVwc2VydE1hbnlfIiwidW5pcXVlS2V5cyIsIm9wcyIsIm1hcCIsInJlY29yZCIsInVwZGF0ZURhdGEiLCJ1cGRhdGVPcCIsImZpbHRlciIsInBpY2siLCJ1cGRhdGUiLCJidWxrV3JpdGUiLCJ1cGRhdGVNYW55QW5kUmV0dXJuXyIsImxvY2tlcklkIiwic2hvcnRpZCIsInVwZGF0ZU1hbnkiLCIkZXhpc3RzIiwiZmluZCIsInByb2plY3Rpb24iLCJyZXN1bHQiLCJuTW9kaWZpZWQiLCIkdW5zZXQiLCJpbnNlcnRNYW55SWZOb3RFeGlzdF8iLCJjb25zb2xlIiwidXBkYXRlTWFueV8iLCJyZXBsYWNlT25lXyIsInJlcGxhY2VPbmUiLCJkZWxldGVPbmVfIiwiZGVsZXRlT25lIiwiZGVsZXRlTWFueV8iLCJkZWxldGVNYW55IiwiZmluZE9uZUFuZFJlcGxhY2VfIiwiZmluZE9uZUFuZFJlcGxhY2UiLCJmaW5kT25lQW5kVXBkYXRlIiwiZmluZE9uZUFuZERlbGV0ZV8iLCJmaW5kT25lQW5kRGVsZXRlIiwiZmluZE9uZV8iLCJxdWVyeU9wdGlvbnMiLCJxdWVyeSIsIiRwcm9qZWN0aW9uIiwiJHF1ZXJ5IiwiZmluZE9uZSIsIiRvcmRlckJ5IiwiJG9mZnNldCIsIiRsaW1pdCIsInNvcnQiLCJza2lwIiwibGltaXQiLCIkdG90YWxDb3VudCIsInRvdGFsQ291bnQiLCJhZ2dyZWdhdGVfIiwicGlwZWxpbmUiLCJhZ2dyZWdhdGUiLCJleGVjdXRvciIsImNvbGxlY3Rpb24iLCJvbWl0IiwiZHJpdmVyTGliIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU07QUFBRUEsRUFBQUEsQ0FBRjtBQUFLQyxF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TUFBQUEsR0FBRyxDQUFDTixJQUFKLEdBQVdELE1BQVg7QUFDSDs7QUFFRCxXQUFPTyxHQUFQO0FBQ0g7O0FBbmJvQzs7QUFzYnpDbkUsZ0JBQWdCLENBQUN3SCxTQUFqQixHQUE2QmxJLE9BQTdCO0FBRUFtSSxNQUFNLENBQUNDLE9BQVAsR0FBaUIxSCxnQkFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCB7IF8sIHdhaXRVbnRpbF8gfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IHRyeVJlcXVpcmUgfSA9IHJlcXVpcmUoJy4uLy4uL3V0aWxzL2xpYicpO1xuY29uc3QgbW9uZ29kYiA9IHRyeVJlcXVpcmUoJ21vbmdvZGInKTtcbmNvbnN0IHsgTW9uZ29DbGllbnQsIEdyaWRGU0J1Y2tldCB9ID0gbW9uZ29kYjtcbmNvbnN0IENvbm5lY3RvciA9IHJlcXVpcmUoJy4uLy4uL0Nvbm5lY3RvcicpO1xuY29uc3QgR2VuZXJhdG9ycyA9IHJlcXVpcmUoJy4uLy4uL0dlbmVyYXRvcnMnKTtcbmNvbnN0IHsgSW52YWxpZEFyZ3VtZW50IH0gPSByZXF1aXJlKCcuLi8uLi91dGlscy9FcnJvcnMnKTtcblxuY29uc3QgVXBkYXRlT3BzRmllbGQgPSBbICckY3VycmVudERhdGUnLCAnJGluYycsICckbWluJywgJyRtYXgnLCAnJG11bCcsICckcmVuYW1lJywgJyRzZXQnLCAnJHNldE9uSW5zZXJ0JywgJyR1bnNldCcgXTtcbmNvbnN0IFVwZGF0ZU9wc0FycmF5ID0gWyAnJGFkZFRvU2V0JywgJyRwb3AnLCAnJHB1bGwnLCAnJHB1c2gnLCAnJHB1bGxBbGwnIF07XG5jb25zdCBVcGRhdGVPcHMgPSBVcGRhdGVPcHNGaWVsZC5jb25jYXQoVXBkYXRlT3BzQXJyYXkpO1xuXG4vKipcbiAqIE1vbmdvZGIgZGF0YSBzdG9yYWdlIGNvbm5lY3Rvci5cbiAqIEBjbGFzc1xuICogQGV4dGVuZHMgQ29ubmVjdG9yXG4gKi9cbmNsYXNzIE1vbmdvZGJDb25uZWN0b3IgZXh0ZW5kcyBDb25uZWN0b3Ige1xuICAgIC8qKiAgICAgICAgICBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gb3B0aW9ucyBcbiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IFtvcHRpb25zLnVzZVByZXBhcmVkU3RhdGVtZW50XSAtIFxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKGNvbm5lY3Rpb25TdHJpbmcsIG9wdGlvbnMpIHsgICAgICAgIFxuICAgICAgICBzdXBlcignbW9uZ29kYicsIGNvbm5lY3Rpb25TdHJpbmcsIG9wdGlvbnMpOyAgICBcbiAgICAgICAgXG4gICAgICAgIHRoaXMubG9ja2VyRmllbGQgPSB0aGlzLm9wdGlvbnMubG9ja2VyRmllbGQgfHwgJ19fbG9ja19fJztcbiAgICB9XG5cbiAgICBmaW5kQWxsXyA9IHRoaXMuZmluZF87XG5cbiAgICAvKipcbiAgICAgKiBDbG9zZSBhbGwgY29ubmVjdGlvbiBpbml0aWF0ZWQgYnkgdGhpcyBjb25uZWN0b3IuXG4gICAgICovXG4gICAgYXN5bmMgZW5kXygpIHtcbiAgICAgICAgaWYgKHRoaXMuY2xpZW50ICYmIHRoaXMuY2xpZW50LmlzQ29ubmVjdGVkKCkpIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuY2xpZW50LmNsb3NlKCk7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGBtb25nb2RiOiBzdWNjZXNzZnVsbHkgZGlzY29ubmVjdGVkIGZyb20gXCIke3RoaXMuZ2V0Q29ubmVjdGlvblN0cmluZ1dpdGhvdXRDcmVkZW50aWFsKCl9XCIuYCk7ICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICB9XG5cbiAgICAgICAgZGVsZXRlIHRoaXMuY2xpZW50O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIGRhdGFiYXNlIGNvbm5lY3Rpb24gYmFzZWQgb24gdGhlIGRlZmF1bHQgY29ubmVjdGlvbiBzdHJpbmcgb2YgdGhlIGNvbm5lY3RvciBhbmQgZ2l2ZW4gb3B0aW9ucy4gICAgIFxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc10gLSBFeHRyYSBvcHRpb25zIGZvciB0aGUgY29ubmVjdGlvbiwgb3B0aW9uYWwuXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbb3B0aW9ucy5tdWx0aXBsZVN0YXRlbWVudHM9ZmFsc2VdIC0gQWxsb3cgcnVubmluZyBtdWx0aXBsZSBzdGF0ZW1lbnRzIGF0IGEgdGltZS5cbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtvcHRpb25zLmNyZWF0ZURhdGFiYXNlPWZhbHNlXSAtIEZsYWcgdG8gdXNlZCB3aGVuIGNyZWF0aW5nIGEgZGF0YWJhc2UuXG4gICAgICogQHJldHVybnMge1Byb21pc2UuPERiPn1cbiAgICAgKi9cbiAgICBhc3luYyBjb25uZWN0XyhvcHRpb25zKSB7XG4gICAgICAgIGlmICghdGhpcy5jbGllbnQgfHwgIXRoaXMuY2xpZW50LmlzQ29ubmVjdGVkKCkpIHtcbiAgICAgICAgICAgIGxldCBjbGllbnQgPSBuZXcgTW9uZ29DbGllbnQodGhpcy5jb25uZWN0aW9uU3RyaW5nLCB7dXNlTmV3VXJsUGFyc2VyOiB0cnVlfSk7XG4gICAgICAgICAgICB0aGlzLmNsaWVudCA9IGF3YWl0IGNsaWVudC5jb25uZWN0KCk7IFxuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBgbW9uZ29kYjogc3VjY2Vzc2Z1bGx5IGNvbm5lY3RlZCB0byBcIiR7dGhpcy5nZXRDb25uZWN0aW9uU3RyaW5nV2l0aG91dENyZWRlbnRpYWwoKX1cIi5gKTsgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgIH0gICAgICAgXG5cbiAgICAgICAgcmV0dXJuIHRoaXMuY2xpZW50LmRiKHRoaXMuZGF0YWJhc2UpO1xuICAgIH1cbiAgICBcbiAgICAvKipcbiAgICAgKiBDbG9zZSBhIGRhdGFiYXNlIGNvbm5lY3Rpb24uXG4gICAgICogQHBhcmFtIHtEYn0gY29ubiAtIE15U1FMIGNvbm5lY3Rpb24uXG4gICAgICovXG4gICAgYXN5bmMgZGlzY29ubmVjdF8oY29ubikge1xuICAgIH1cblxuICAgIGFzeW5jIHBpbmdfKCkgeyAgXG4gICAgICAgIHJldHVybiB0aGlzLmV4ZWN1dGVfKGRiID0+IHtcbiAgICAgICAgICAgIHJldHVybiBkYi5saXN0Q29sbGVjdGlvbnMobnVsbCwgeyBuYW1lT25seTogdHJ1ZSB9KS50b0FycmF5KCk7XG4gICAgICAgIH0pOyAgXG4gICAgfVxuXG4gICAgYXN5bmMgZXhlY3V0ZV8oZGJFeGVjdXRvcikge1xuICAgICAgICBsZXQgZGI7XG4gICAgXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBkYiA9IGF3YWl0IHRoaXMuY29ubmVjdF8oKTtcblxuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IGRiRXhlY3V0b3IoZGIpO1xuICAgICAgICB9IGNhdGNoKGVycikgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgICAgZGIgJiYgYXdhaXQgdGhpcy5kaXNjb25uZWN0XyhkYik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gW29wdGlvbnNdIC0gT3B0aW9uYWwgc2V0dGluZ3MuXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLmJ1Y2tldE5hbWU9J2ZzJ10gLSBUaGUgJ2ZpbGVzJyBhbmQgJ2NodW5rcycgY29sbGVjdGlvbnMgd2lsbCBiZSBwcmVmaXhlZCB3aXRoIHRoZSBidWNrZXQgbmFtZSBmb2xsb3dlZCBieSBhIGRvdC5cbiAgICAgKiBAcHJvcGVydHkge251bWJlcn0gW29wdGlvbnMuY2h1bmtTaXplQnl0ZXNdIC0gTnVtYmVyIG9mIGJ5dGVzIHN0b3JlZCBpbiBlYWNoIGNodW5rLiBEZWZhdWx0cyB0byAyNTVLQlxuICAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBbb3B0aW9ucy53cml0ZUNvbmNlcm5dXG4gICAgICogQHByb3BlcnR5IHtvYmplY3R9IFtvcHRpb25zLnJlYWRQcmVmZXJlbmNlXVxuICAgICAqL1xuICAgIGFzeW5jIGNyZWF0ZUdyaWRGU0J1Y2tldF8ob3B0aW9ucykge1xuICAgICAgICBsZXQgZGIgPSBhd2FpdCB0aGlzLmNvbm5lY3RfKCk7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBHcmlkRlNCdWNrZXQoZGIsIG9wdGlvbnMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIG5ldyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBpbnNlcnRPbmVfKG1vZGVsLCBkYXRhLCBvcHRpb25zKSB7XG4gICAgICAgIG9wdGlvbnMgPSB7IGJ5cGFzc0RvY3VtZW50VmFsaWRhdGlvbjogdHJ1ZSwgLi4ub3B0aW9ucyB9O1xuXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdpbnNlcnRPbmU6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIGRhdGEsIG9wdGlvbnN9KSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuaW5zZXJ0T25lKGRhdGEsIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYW4gYXJyYXkgb2YgbmV3IGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHthcnJheX0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgaW5zZXJ0TWFueV8obW9kZWwsIGRhdGEsIG9wdGlvbnMpIHtcbiAgICAgICAgb3B0aW9ucyA9IHsgYnlwYXNzRG9jdW1lbnRWYWxpZGF0aW9uOiB0cnVlLCBvcmRlcmVkOiBmYWxzZSwgLi4ub3B0aW9ucyB9O1xuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ1N0YXRlbWVudCkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAnaW5zZXJ0TWFueTogJyArIEpTT04uc3RyaW5naWZ5KHttb2RlbCwgY291bnQ6IGRhdGEubGVuZ3RoLCBvcHRpb25zfSkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmluc2VydE1hbnkoZGF0YSwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIGFzeW5jIGluc2VydE9uZUlmTm90RXhpc3RfKG1vZGVsLCBkYXRhLCBvcHRpb25zKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5pbnNlcnRPbmVfKG1vZGVsLCBkYXRhLCBvcHRpb25zKVxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgaWYgKGVycm9yLmNvZGUgPT09IDExMDAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZSBhbiBleGlzdGluZyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyB1cGRhdGVPbmVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgXG4gICAgICAgIGRhdGEgPSB0aGlzLl90cmFuc2xhdGVVcGRhdGUoZGF0YSk7XG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICd1cGRhdGVPbmU6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9uc30pKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC51cGRhdGVPbmUoY29uZGl0aW9uLCBkYXRhLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgdXBkYXRlT25lQW5kUmV0dXJuXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7ICAgICAgICAgICAgXG4gICAgICAgIGxldCByZXQgPSBhd2FpdCB0aGlzLmZpbmRPbmVBbmRVcGRhdGVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIHsgLi4ub3B0aW9ucywgdXBzZXJ0OiBmYWxzZSwgcmV0dXJuT3JpZ2luYWw6IGZhbHNlIH0pO1xuICAgICAgICByZXR1cm4gcmV0ICYmIHJldC52YWx1ZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgYW4gZXhpc3RpbmcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGFPbkluc2VydCAtIFNoYXJlZCBkYXRhIG9uIGluc2VydFxuICAgICAqL1xuICAgIGFzeW5jIHVwc2VydE9uZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucywgZGF0YU9uSW5zZXJ0KSB7IFxuICAgICAgICBsZXQgdHJhbnMgPSB0aGlzLl90cmFuc2xhdGVVcGRhdGUoZGF0YSk7XG4gICAgICAgIGxldCB7IF9pZCwgLi4ub3RoZXJzIH0gPSB0cmFucy4kc2V0OyBcbiAgICAgICAgaWYgKCFfLmlzTmlsKF9pZCkpIHtcbiAgICAgICAgICAgIHRyYW5zLiRzZXQgPSBvdGhlcnM7XG4gICAgICAgICAgICB0cmFucy4kc2V0T25JbnNlcnQgPSB7IF9pZCB9O1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFfLmlzRW1wdHkoZGF0YU9uSW5zZXJ0KSkge1xuICAgICAgICAgICAgdHJhbnMuJHNldE9uSW5zZXJ0ID0geyAuLi50cmFucy4kc2V0T25JbnNlcnQsIC4uLmRhdGFPbkluc2VydCB9O1xuICAgICAgICB9XG5cbiAgICAgICAgb3B0aW9ucyA9IHsgLi4ub3B0aW9ucywgdXBzZXJ0OiB0cnVlIH07XG5cbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ3Vwc2VydE9uZTogJyArIEpTT04uc3RyaW5naWZ5KHttb2RlbCwgZGF0YTogdHJhbnMsIGNvbmRpdGlvbiwgb3B0aW9uc30pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLnVwZGF0ZU9uZShjb25kaXRpb24sIHRyYW5zLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIG1hbnkgZW50aXRpZXMuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIC0gQXJyYXkgb2YgcmVjb3JkIHdpdGggX2lkXG4gICAgICogQHBhcmFtIHthcnJheX0gdW5pcXVlS2V5cyAtIFVuaXF1ZSBrZXlzIGluIHRoZSBkYXRhIHJlY29yZCB1c2VkIGFzIGZpbHRlclxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YU9uSW5zZXJ0IC0gU2hhcmVkIGRhdGEgb24gaW5zZXJ0XG4gICAgICovXG4gICAgYXN5bmMgdXBzZXJ0TWFueV8obW9kZWwsIGRhdGEsIHVuaXF1ZUtleXMsIG9wdGlvbnMsIGRhdGFPbkluc2VydCkgeyBcbiAgICAgICAgbGV0IG9wcyA9IGRhdGEubWFwKHJlY29yZCA9PiB7XG4gICAgICAgICAgICBsZXQgeyBfaWQsIC4uLnVwZGF0ZURhdGEgfSA9IHJlY29yZDtcblxuICAgICAgICAgICAgbGV0IHVwZGF0ZU9wID0gdGhpcy5fdHJhbnNsYXRlVXBkYXRlKHVwZGF0ZURhdGEpO1xuXG4gICAgICAgICAgICBpZiAoX2lkKSB7XG4gICAgICAgICAgICAgICAgdXBkYXRlT3AuJHNldE9uSW5zZXJ0ID0geyBfaWQsIC4uLmRhdGFPbkluc2VydCB9O1xuICAgICAgICAgICAgfSBlbHNlIGlmICghXy5pc0VtcHR5KGRhdGFPbkluc2VydCkpIHtcbiAgICAgICAgICAgICAgICB1cGRhdGVPcC4kc2V0T25JbnNlcnQgPSBkYXRhT25JbnNlcnQ7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgdXBkYXRlT25lOiB7IGZpbHRlcjogeyAuLi5fLnBpY2socmVjb3JkLCB1bmlxdWVLZXlzKSB9LCB1cGRhdGU6IHVwZGF0ZU9wLCB1cHNlcnQ6IHRydWUgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgb3B0aW9ucyA9IHsgYnlwYXNzRG9jdW1lbnRWYWxpZGF0aW9uOiB0cnVlLCBvcmRlcmVkOiBmYWxzZSwgLi4ub3B0aW9ucyB9O1xuXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdidWxrV3JpdGU6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIGNvdW50OiBvcHMubGVuZ3RoLCBvcHRpb25zfSkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuYnVsa1dyaXRlKG9wcywgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIGFzeW5jIHVwZGF0ZU1hbnlBbmRSZXR1cm5fKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgICAgICAgIFxuICAgICAgICBsZXQgbG9ja2VySWQgPSBHZW5lcmF0b3JzLnNob3J0aWQoKTtcblxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ1N0YXRlbWVudCkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAndXBkYXRlTWFueStmaW5kK3VwZGF0ZU1hbnk6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIGNvdW50OiBkYXRhLmxlbmd0aCwgY29uZGl0aW9uLCBvcHRpb25zfSkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgYXN5bmMgKGNvbGwpID0+IHtcbiAgICAgICAgICAgIC8vMS51cGRhdGUgYW5kIHNldCBsb2NrZXJcbiAgICAgICAgICAgIGxldCByZXQgPSBhd2FpdCBjb2xsLnVwZGF0ZU1hbnkoXG4gICAgICAgICAgICAgICAgeyAuLi5jb25kaXRpb24sIFt0aGlzLmxvY2tlckZpZWxkXTogeyAkZXhpc3RzOiBmYWxzZSB9IH0sIC8vIGZvciBhbGwgbm9uLWxvY2tlZFxuICAgICAgICAgICAgICAgIHsgJHNldDogeyAuLi5kYXRhLCBbdGhpcy5sb2NrZXJGaWVsZF06IGxvY2tlcklkIH0gfSwgLy8gbG9jayBpdCBcbiAgICAgICAgICAgICAgICB7IC4uLm9wdGlvbnMsIHVwc2VydDogZmFsc2UgfSApO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIC8vMi5yZXR1cm4gYWxsIGxvY2tlZCByZWNvcmRzXG4gICAgICAgICAgICAgICAgcmV0dXJuIGF3YWl0IGNvbGwuZmluZCh7IFt0aGlzLmxvY2tlckZpZWxkXTogbG9ja2VySWQgfSwgeyBwcm9qZWN0aW9uOiB7IFt0aGlzLmxvY2tlckZpZWxkXTogMCB9IH0pLnRvQXJyYXkoKTsgLy8gcmV0dXJuIGFsbCBsb2NrZWRcbiAgICAgICAgICAgIH0gZmluYWxseSB7ICAgIFxuICAgICAgICAgICAgICAgIC8vMy5yZW1vdmUgbG9ja2Vyc1xuICAgICAgICAgICAgICAgIGlmIChyZXQucmVzdWx0Lm5Nb2RpZmllZCA+IDApIHsgLy8gdW5sb2NrXG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IGNvbGwudXBkYXRlTWFueSh7IFt0aGlzLmxvY2tlckZpZWxkXTogbG9ja2VySWQgfSwgeyAkdW5zZXQ6IHsgW3RoaXMubG9ja2VyRmllbGRdOiBcIlwiIH0gfSwgeyB1cHNlcnQ6IGZhbHNlIH0pOyAgICBcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pOyAgICAgICAgIFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEluc2VydCBtYW55IGVudGl0aWVzIGlmIG5vdCBleGlzdC5cbiAgICAgKiBAcGFyYW0geyp9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IHVuaXF1ZUtleXMgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGluc2VydE1hbnlJZk5vdEV4aXN0Xyhtb2RlbCwgZGF0YSwgdW5pcXVlS2V5cywgb3B0aW9ucykge1xuICAgICAgICBjb25zb2xlLmxvZygnYnVnZ3k6IHRvZml4Jyk7XG4gICAgICAgIGxldCBvcHMgPSBkYXRhLm1hcChyZWNvcmQgPT4gKHtcbiAgICAgICAgICAgIHVwZGF0ZU9uZTogeyBmaWx0ZXI6IHsgLi4uXy5waWNrKHJlY29yZCwgdW5pcXVlS2V5cykgfSwgdXBkYXRlOiB7ICRzZXRPbkluc2VydDogcmVjb3JkIH0sIHVwc2VydDogdHJ1ZSB9XG4gICAgICAgIH0pKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5idWxrV3JpdGUob3BzLCB7IGJ5cGFzc0RvY3VtZW50VmFsaWRhdGlvbjogdHJ1ZSwgb3JkZXJlZDogZmFsc2UsIC4uLm9wdGlvbnMgfSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZSBtdWx0aXBsZSBkb2N1bWVudHMuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgdXBkYXRlTWFueV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykgeyBcbiAgICAgICAgZGF0YSA9IHRoaXMuX3RyYW5zbGF0ZVVwZGF0ZShkYXRhKTtcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ3VwZGF0ZU1hbnk6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIGNvdW50OiBkYXRhLmxlbmd0aCwgY29uZGl0aW9uLCBvcHRpb25zfSkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwudXBkYXRlTWFueShjb25kaXRpb24sIGRhdGEsIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXBsYWNlIGFuIGV4aXN0aW5nIGVudGl0eSBvciBjcmVhdGUgYSBuZXcgb25lLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgcmVwbGFjZU9uZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ1N0YXRlbWVudCkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAncmVwbGFjZU9uZTogJyArIEpTT04uc3RyaW5naWZ5KHttb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zfSkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwucmVwbGFjZU9uZShjb25kaXRpb24sIGRhdGEsIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZW1vdmUgYW4gZXhpc3RpbmcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgZGVsZXRlT25lXyhtb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdkZWxldGVPbmU6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9uc30pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmRlbGV0ZU9uZShjb25kaXRpb24sIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZW1vdmUgYW4gZXhpc3RpbmcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgZGVsZXRlTWFueV8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ1N0YXRlbWVudCkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAnZGVsZXRlTWFueTogJyArIEpTT04uc3RyaW5naWZ5KHttb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zfSkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmRlbGV0ZU1hbnkoY29uZGl0aW9uLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVwbGFjZSAoaW5zZXJ0IG9yIHVwZGF0ZSBmb3IgZXhzaXN0aW5nKSBhbiBlbnRpdHkgYW5kIHJldHVybiBvcmlnaW5hbCByZWNvcmQuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBmaW5kT25lQW5kUmVwbGFjZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ1N0YXRlbWVudCkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAnZmluZE9uZUFuZFJlcGxhY2U6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIGRhdGEsIG9wdGlvbnN9KSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZmluZE9uZUFuZFJlcGxhY2UoY29uZGl0aW9uLCBkYXRhLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRmluZCBhIGRvY3VtZW50IGFuZCB1cGRhdGUgaXQgaW4gb25lIGF0b21pYyBvcGVyYXRpb24uIFJlcXVpcmVzIGEgd3JpdGUgbG9jayBmb3IgdGhlIGR1cmF0aW9uIG9mIHRoZSBvcGVyYXRpb24uXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBmaW5kT25lQW5kVXBkYXRlXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7ICAgICBcbiAgICAgICAgZGF0YSA9IHRoaXMuX3RyYW5zbGF0ZVVwZGF0ZShkYXRhKTtcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ2ZpbmRPbmVBbmRVcGRhdGU6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9uc30pKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5maW5kT25lQW5kVXBkYXRlKGNvbmRpdGlvbiwgZGF0YSwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIGFzeW5jIGZpbmRPbmVBbmREZWxldGVfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ2ZpbmRPbmVBbmREZWxldGU6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9uc30pKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5maW5kT25lQW5kRGVsZXRlKGNvbmRpdGlvbiwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIGFzeW5jIGZpbmRPbmVfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgbGV0IHF1ZXJ5T3B0aW9ucyA9IHsuLi5vcHRpb25zfTtcbiAgICAgICAgbGV0IHF1ZXJ5O1xuXG4gICAgICAgIGlmICghXy5pc0VtcHR5KGNvbmRpdGlvbikpIHtcbiAgICAgICAgICAgIGxldCB7ICRwcm9qZWN0aW9uLCAkcXVlcnksIC4uLm90aGVycyB9ID0gY29uZGl0aW9uO1xuXG4gICAgICAgICAgICBpZiAoJHByb2plY3Rpb24pIHtcbiAgICAgICAgICAgICAgICBxdWVyeU9wdGlvbnMucHJvamVjdGlvbiA9ICRwcm9qZWN0aW9uOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcXVlcnkgPSB7IC4uLm90aGVycywgLi4uJHF1ZXJ5IH07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgSW52YWxpZEFyZ3VtZW50KCdmaW5kT25lIHJlcXVpcmVzIG5vbi1lbXB0eSBxdWVyeSBjb25kaXRpb24uJyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ1N0YXRlbWVudCkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAnZmluZE9uZTogJyArIEpTT04uc3RyaW5naWZ5KHttb2RlbCwgY29uZGl0aW9uOiBxdWVyeSwgb3B0aW9uczogcXVlcnlPcHRpb25zfSkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZmluZE9uZShxdWVyeSwgcXVlcnlPcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUGVyZm9ybSBzZWxlY3Qgb3BlcmF0aW9uLlxuICAgICAqIEBwYXJhbSB7Kn0gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGZpbmRfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgbGV0IHF1ZXJ5T3B0aW9ucyA9IHsuLi5vcHRpb25zfTtcbiAgICAgICAgbGV0IHF1ZXJ5O1xuXG4gICAgICAgIGlmICghXy5pc0VtcHR5KGNvbmRpdGlvbikpIHtcbiAgICAgICAgICAgIGxldCB7ICRwcm9qZWN0aW9uLCAkb3JkZXJCeSwgJG9mZnNldCwgJGxpbWl0LCAkcXVlcnksIC4uLm90aGVycyB9ID0gY29uZGl0aW9uO1xuXG4gICAgICAgICAgICBpZiAoJHByb2plY3Rpb24pIHtcbiAgICAgICAgICAgICAgICBxdWVyeU9wdGlvbnMucHJvamVjdGlvbiA9ICRwcm9qZWN0aW9uOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCRvcmRlckJ5KSB7XG4gICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLnNvcnQgPSAkb3JkZXJCeTsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICgkb2Zmc2V0KSB7XG4gICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLnNraXAgPSAkb2Zmc2V0OyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCRsaW1pdCkge1xuICAgICAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucy5saW1pdCA9ICRsaW1pdDsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHF1ZXJ5ID0geyAuLi5vdGhlcnMsIC4uLiRxdWVyeSB9O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcXVlcnkgPSB7fTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdmaW5kOiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBjb25kaXRpb246IHF1ZXJ5LCBvcHRpb25zOiBxdWVyeU9wdGlvbnN9KSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCBhc3luYyBjb2xsID0+IHsgICAgICAgICAgICBcbiAgICAgICAgICAgIGxldCByZXN1bHQgPSBhd2FpdCBjb2xsLmZpbmQocXVlcnksIHF1ZXJ5T3B0aW9ucykudG9BcnJheSgpO1xuXG4gICAgICAgICAgICBpZiAoY29uZGl0aW9uICYmIGNvbmRpdGlvbi4kdG90YWxDb3VudCkge1xuICAgICAgICAgICAgICAgIGxldCB0b3RhbENvdW50ID0gYXdhaXQgY29sbC5maW5kKHF1ZXJ5KS5jb3VudCgpO1xuICAgICAgICAgICAgICAgIHJldHVybiBbIHJlc3VsdCwgdG90YWxDb3VudCBdO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9KTtcbiAgICB9ICAgXG5cbiAgICBhc3luYyBhZ2dyZWdhdGVfKG1vZGVsLCBwaXBlbGluZSwgb3B0aW9ucykgeyAgICAgICAgXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdhZ2dyZWdhdGU6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIHBpcGVsaW5lLCBvcHRpb25zfSkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmFnZ3JlZ2F0ZShwaXBlbGluZSwgb3B0aW9ucykudG9BcnJheSgpKTtcbiAgICB9XG5cbiAgICBhc3luYyBvbkNvbGxlY3Rpb25fKG1vZGVsLCBleGVjdXRvcikge1xuICAgICAgICByZXR1cm4gdGhpcy5leGVjdXRlXyhkYiA9PiBleGVjdXRvcihkYi5jb2xsZWN0aW9uKG1vZGVsKSkpO1xuICAgIH1cblxuICAgIF90cmFuc2xhdGVVcGRhdGUodXBkYXRlKSB7XG4gICAgICAgIGxldCBvcHMgPSBfLnBpY2sodXBkYXRlLCBVcGRhdGVPcHMpO1xuICAgICAgICBsZXQgb3RoZXJzID0gXy5vbWl0KHVwZGF0ZSwgVXBkYXRlT3BzKTtcblxuICAgICAgICBpZiAob3BzLiRzZXQpIHtcbiAgICAgICAgICAgIG9wcy4kc2V0ID0geyAuLi5vcHMuJHNldCwgLi4ub3RoZXJzIH07XG4gICAgICAgIH0gZWxzZSBpZiAoIV8uaXNFbXB0eShvdGhlcnMpKSB7XG4gICAgICAgICAgICBvcHMuJHNldCA9IG90aGVycztcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBvcHM7XG4gICAgfVxufVxuXG5Nb25nb2RiQ29ubmVjdG9yLmRyaXZlckxpYiA9IG1vbmdvZGI7XG5cbm1vZHVsZS5leHBvcnRzID0gTW9uZ29kYkNvbm5lY3RvcjsiXX0=