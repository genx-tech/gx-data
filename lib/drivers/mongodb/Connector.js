"use strict";

require("source-map-support/register");

const {
  _,
  waitUntil_
} = require('rk-utils');

const {
  tryRequire
} = require('../../utils/lib');

const mongodb = tryRequire('mongodb');
const {
  MongoClient,
  GridFSBucket
} = mongodb;

const Connector = require('../../Connector');

const Generators = require('../../Generators');

const UpdateOpsField = ['$currentDate', '$inc', '$min', '$max', '$mul', '$rename', '$set', '$setOnInsert', '$unset'];
const UpdateOpsArray = ['$addToSet', '$pop', '$pull', '$push', '$pullAll'];
const UpdateOps = UpdateOpsField.concat(UpdateOpsArray);

class MongodbConnector extends Connector {
  constructor(connectionString, options) {
    super('mongodb', connectionString, options);
    this.findAll_ = this.find_;
    this.lockerField = this.options.lockerField || '__lock__';
  }

  async end_() {
    if (this.client && this.client.isConnected()) {
      await this.client.close();
      this.log('verbose', `mongodb: successfully disconnected from "${this.getConnectionStringWithoutCredential()}".`);
    }

    delete this.client;
  }

  async connect_(options) {
    if (!this.client || !this.client.isConnected()) {
      let client = new MongoClient(this.connectionString, {
        useNewUrlParser: true
      });
      this.client = await client.connect();
      this.log('verbose', `mongodb: successfully connected to "${this.getConnectionStringWithoutCredential()}".`);
    }

    return this.client.db(this.database);
  }

  async disconnect_(conn) {}

  async ping_() {
    return this.execute_(db => {
      return db.listCollections(null, {
        nameOnly: true
      }).toArray();
    });
  }

  async execute_(dbExecutor) {
    let db;

    try {
      db = await this.connect_();
      return await dbExecutor(db);
    } catch (err) {
      throw err;
    } finally {
      db && (await this.disconnect_(db));
    }
  }

  async createGridFSBucket_(options) {
    let db = await this.connect_();
    return new GridFSBucket(db, options);
  }

  async insertOne_(model, data, options) {
    options = {
      bypassDocumentValidation: true,
      ...options
    };

    if (this.options.logStatement) {
      this.log('verbose', 'insertOne: ' + JSON.stringify({
        model,
        data,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.insertOne(data, options));
  }

  async insertMany_(model, data, options) {
    options = {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    };

    if (this.options.logStatement) {
      this.log('verbose', 'insertMany: ' + JSON.stringify({
        model,
        count: data.length,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.insertMany(data, options));
  }

  async insertOneIfNotExist_(model, data, options) {
    try {
      return await this.insertOne_(model, data, options);
    } catch (error) {
      if (error.code === 11000) {
        return false;
      }

      throw error;
    }
  }

  async updateOne_(model, data, condition, options) {
    data = this._translateUpdate(data);

    if (this.options.logStatement) {
      this.log('verbose', 'updateOne: ' + JSON.stringify({
        model,
        data,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.updateOne(condition, data, options));
  }

  async updateOneAndReturn_(model, data, condition, options) {
    let ret = await this.findOneAndUpdate_(model, data, condition, { ...options,
      upsert: false,
      returnOriginal: false
    });
    return ret && ret.value;
  }

  async upsertOne_(model, data, condition, options) {
    let trans = this._translateUpdate(data);

    let {
      _id,
      ...others
    } = trans.$set;

    if (!_.isNil(_id)) {
      trans.$set = others;
      trans.$setOnInsert = {
        _id
      };
    }

    options = { ...options,
      upsert: true
    };

    if (this.options.logStatement) {
      this.log('verbose', 'updateOne: ' + JSON.stringify({
        model,
        data: trans,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.updateOne(condition, trans, options));
  }

  async upsertMany_(model, data, uniqueKeys, options) {
    let ops = data.map(record => {
      let {
        _id,
        ...updateData
      } = record;
      let updateOp = {
        $set: updateData
      };

      if (_id) {
        updateOp.$setOnInsert = {
          _id
        };
      }

      return {
        updateOne: {
          filter: { ..._.pick(record, uniqueKeys)
          },
          update: updateOp,
          upsert: true
        }
      };
    });
    options = {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    };

    if (this.options.logStatement) {
      this.log('verbose', 'bulkWrite: ' + JSON.stringify({
        model,
        count: ops.length,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.bulkWrite(ops, options));
  }

  async updateManyAndReturn_(model, data, condition, options) {
    let lockerId = Generators.shortid();

    if (this.options.logStatement) {
      this.log('verbose', 'updateMany+find+updateMany: ' + JSON.stringify({
        model,
        count: data.length,
        condition,
        options
      }));
    }

    return this.onCollection_(model, async coll => {
      let ret = await coll.updateMany({ ...condition,
        [this.lockerField]: {
          $exists: false
        }
      }, {
        $set: { ...data,
          [this.lockerField]: lockerId
        }
      }, { ...options,
        upsert: false
      });

      try {
        return await coll.find({
          [this.lockerField]: lockerId
        }, {
          projection: {
            [this.lockerField]: 0
          }
        }).toArray();
      } finally {
        if (ret.result.nModified > 0) {
          await coll.updateMany({
            [this.lockerField]: lockerId
          }, {
            $unset: {
              [this.lockerField]: ""
            }
          }, {
            upsert: false
          });
        }
      }
    });
  }

  async insertManyIfNotExist_(model, data, uniqueKeys, options) {
    console.log('buggy: tofix');
    let ops = data.map(record => ({
      updateOne: {
        filter: { ..._.pick(record, uniqueKeys)
        },
        update: {
          $setOnInsert: record
        },
        upsert: true
      }
    }));
    return this.onCollection_(model, coll => coll.bulkWrite(ops, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async updateMany_(model, data, condition, options) {
    data = this._translateUpdate(data);

    if (this.options.logStatement) {
      this.log('verbose', 'updateMany: ' + JSON.stringify({
        model,
        count: data.length,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.updateMany(condition, data, options));
  }

  async replaceOne_(model, data, condition, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'replaceOne: ' + JSON.stringify({
        model,
        data,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.replaceOne(condition, data, options));
  }

  async deleteOne_(model, condition, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'deleteOne: ' + JSON.stringify({
        model,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.deleteOne(condition, options));
  }

  async deleteMany_(model, condition, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'deleteMany: ' + JSON.stringify({
        model,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.deleteMany(condition, options));
  }

  async findOneAndReplace_(model, data, condition, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'findOneAndReplace: ' + JSON.stringify({
        model,
        data,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.findOneAndReplace(condition, data, options));
  }

  async findOneAndUpdate_(model, data, condition, options) {
    data = this._translateUpdate(data);

    if (this.options.logStatement) {
      this.log('verbose', 'findOneAndUpdate: ' + JSON.stringify({
        model,
        data,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.findOneAndUpdate(condition, data, options));
  }

  async findOneAndDelete_(model, condition, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'findOneAndDelete: ' + JSON.stringify({
        model,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.findOneAndDelete(condition, options));
  }

  async findOne_(model, condition, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'findOne: ' + JSON.stringify({
        model,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.findOne(condition, options));
  }

  async find_(model, condition, options) {
    let queryOptions = { ...options
    };
    let query = {};

    if (condition) {
      let {
        $projection,
        $orderBy,
        $offset,
        $limit,
        $query,
        ...others
      } = condition;

      if ($projection) {
        queryOptions.projection = $projection;
      }

      if ($orderBy) {
        queryOptions.sort = $orderBy;
      }

      if ($offset) {
        queryOptions.skip = $offset;
      }

      if ($limit) {
        queryOptions.limit = $limit;
      }

      Object.assign(query, _.pickBy(others, (v, k) => k[0] !== '$'));

      if ($query) {
        Object.assign(query, $query);
      }
    }

    if (this.options.logStatement) {
      this.log('verbose', 'find: ' + JSON.stringify({
        model,
        condition: query,
        options: queryOptions
      }));
    }

    return this.onCollection_(model, async coll => {
      let result = await coll.find(query, queryOptions).toArray();

      if (condition && condition.$totalCount) {
        let totalCount = await coll.find(query).count();
        return [result, totalCount];
      }

      return result;
    });
  }

  async aggregate_(model, pipeline, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'aggregate: ' + JSON.stringify({
        model,
        pipeline,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.aggregate(pipeline, options).toArray());
  }

  async onCollection_(model, executor) {
    return this.execute_(db => executor(db.collection(model)));
  }

  _translateUpdate(update) {
    let ops = _.pick(update, UpdateOps);

    let others = _.omit(update, UpdateOps);

    if (ops.$set) {
      ops.$set = { ...ops.$set,
        ...others
      };
    } else if (!_.isEmpty(others)) {
      ops.$set = others;
    }

    return ops;
  }

}

MongodbConnector.driverLib = mongodb;
module.exports = MongodbConnector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kcml2ZXJzL21vbmdvZGIvQ29ubmVjdG9yLmpzIl0sIm5hbWVzIjpbIl8iLCJ3YWl0VW50aWxfIiwicmVxdWlyZSIsInRyeVJlcXVpcmUiLCJtb25nb2RiIiwiTW9uZ29DbGllbnQiLCJHcmlkRlNCdWNrZXQiLCJDb25uZWN0b3IiLCJHZW5lcmF0b3JzIiwiVXBkYXRlT3BzRmllbGQiLCJVcGRhdGVPcHNBcnJheSIsIlVwZGF0ZU9wcyIsImNvbmNhdCIsIk1vbmdvZGJDb25uZWN0b3IiLCJjb25zdHJ1Y3RvciIsImNvbm5lY3Rpb25TdHJpbmciLCJvcHRpb25zIiwiZmluZEFsbF8iLCJmaW5kXyIsImxvY2tlckZpZWxkIiwiZW5kXyIsImNsaWVudCIsImlzQ29ubmVjdGVkIiwiY2xvc2UiLCJsb2ciLCJnZXRDb25uZWN0aW9uU3RyaW5nV2l0aG91dENyZWRlbnRpYWwiLCJjb25uZWN0XyIsInVzZU5ld1VybFBhcnNlciIsImNvbm5lY3QiLCJkYiIsImRhdGFiYXNlIiwiZGlzY29ubmVjdF8iLCJjb25uIiwicGluZ18iLCJleGVjdXRlXyIsImxpc3RDb2xsZWN0aW9ucyIsIm5hbWVPbmx5IiwidG9BcnJheSIsImRiRXhlY3V0b3IiLCJlcnIiLCJjcmVhdGVHcmlkRlNCdWNrZXRfIiwiaW5zZXJ0T25lXyIsIm1vZGVsIiwiZGF0YSIsImJ5cGFzc0RvY3VtZW50VmFsaWRhdGlvbiIsImxvZ1N0YXRlbWVudCIsIkpTT04iLCJzdHJpbmdpZnkiLCJvbkNvbGxlY3Rpb25fIiwiY29sbCIsImluc2VydE9uZSIsImluc2VydE1hbnlfIiwib3JkZXJlZCIsImNvdW50IiwibGVuZ3RoIiwiaW5zZXJ0TWFueSIsImluc2VydE9uZUlmTm90RXhpc3RfIiwiZXJyb3IiLCJjb2RlIiwidXBkYXRlT25lXyIsImNvbmRpdGlvbiIsIl90cmFuc2xhdGVVcGRhdGUiLCJ1cGRhdGVPbmUiLCJ1cGRhdGVPbmVBbmRSZXR1cm5fIiwicmV0IiwiZmluZE9uZUFuZFVwZGF0ZV8iLCJ1cHNlcnQiLCJyZXR1cm5PcmlnaW5hbCIsInZhbHVlIiwidXBzZXJ0T25lXyIsInRyYW5zIiwiX2lkIiwib3RoZXJzIiwiJHNldCIsImlzTmlsIiwiJHNldE9uSW5zZXJ0IiwidXBzZXJ0TWFueV8iLCJ1bmlxdWVLZXlzIiwib3BzIiwibWFwIiwicmVjb3JkIiwidXBkYXRlRGF0YSIsInVwZGF0ZU9wIiwiZmlsdGVyIiwicGljayIsInVwZGF0ZSIsImJ1bGtXcml0ZSIsInVwZGF0ZU1hbnlBbmRSZXR1cm5fIiwibG9ja2VySWQiLCJzaG9ydGlkIiwidXBkYXRlTWFueSIsIiRleGlzdHMiLCJmaW5kIiwicHJvamVjdGlvbiIsInJlc3VsdCIsIm5Nb2RpZmllZCIsIiR1bnNldCIsImluc2VydE1hbnlJZk5vdEV4aXN0XyIsImNvbnNvbGUiLCJ1cGRhdGVNYW55XyIsInJlcGxhY2VPbmVfIiwicmVwbGFjZU9uZSIsImRlbGV0ZU9uZV8iLCJkZWxldGVPbmUiLCJkZWxldGVNYW55XyIsImRlbGV0ZU1hbnkiLCJmaW5kT25lQW5kUmVwbGFjZV8iLCJmaW5kT25lQW5kUmVwbGFjZSIsImZpbmRPbmVBbmRVcGRhdGUiLCJmaW5kT25lQW5kRGVsZXRlXyIsImZpbmRPbmVBbmREZWxldGUiLCJmaW5kT25lXyIsImZpbmRPbmUiLCJxdWVyeU9wdGlvbnMiLCJxdWVyeSIsIiRwcm9qZWN0aW9uIiwiJG9yZGVyQnkiLCIkb2Zmc2V0IiwiJGxpbWl0IiwiJHF1ZXJ5Iiwic29ydCIsInNraXAiLCJsaW1pdCIsIk9iamVjdCIsImFzc2lnbiIsInBpY2tCeSIsInYiLCJrIiwiJHRvdGFsQ291bnQiLCJ0b3RhbENvdW50IiwiYWdncmVnYXRlXyIsInBpcGVsaW5lIiwiYWdncmVnYXRlIiwiZXhlY3V0b3IiLCJjb2xsZWN0aW9uIiwib21pdCIsImlzRW1wdHkiLCJkcml2ZXJMaWIiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTTtBQUFFQSxFQUFBQSxDQUFGO0FBQUtD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SUFBRixDQUFPbEQsTUFBUCxFQUFlMUUsU0FBZixDQUFiOztBQUVBLFFBQUltRSxHQUFHLENBQUNMLElBQVIsRUFBYztBQUNWSyxNQUFBQSxHQUFHLENBQUNMLElBQUosR0FBVyxFQUFFLEdBQUdLLEdBQUcsQ0FBQ0wsSUFBVDtBQUFlLFdBQUdEO0FBQWxCLE9BQVg7QUFDSCxLQUZELE1BRU8sSUFBSSxDQUFDeEUsQ0FBQyxDQUFDd0ksT0FBRixDQUFVaEUsTUFBVixDQUFMLEVBQXdCO0FBQzNCTSxNQUFBQSxHQUFHLENBQUNMLElBQUosR0FBV0QsTUFBWDtBQUNIOztBQUVELFdBQU9NLEdBQVA7QUFDSDs7QUEvWm9DOztBQWthekNqRSxnQkFBZ0IsQ0FBQzRILFNBQWpCLEdBQTZCckksT0FBN0I7QUFFQXNJLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjlILGdCQUFqQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHsgXywgd2FpdFVudGlsXyB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgdHJ5UmVxdWlyZSB9ID0gcmVxdWlyZSgnLi4vLi4vdXRpbHMvbGliJyk7XG5jb25zdCBtb25nb2RiID0gdHJ5UmVxdWlyZSgnbW9uZ29kYicpO1xuY29uc3QgeyBNb25nb0NsaWVudCwgR3JpZEZTQnVja2V0IH0gPSBtb25nb2RiO1xuY29uc3QgQ29ubmVjdG9yID0gcmVxdWlyZSgnLi4vLi4vQ29ubmVjdG9yJyk7XG5jb25zdCBHZW5lcmF0b3JzID0gcmVxdWlyZSgnLi4vLi4vR2VuZXJhdG9ycycpO1xuXG5jb25zdCBVcGRhdGVPcHNGaWVsZCA9IFsgJyRjdXJyZW50RGF0ZScsICckaW5jJywgJyRtaW4nLCAnJG1heCcsICckbXVsJywgJyRyZW5hbWUnLCAnJHNldCcsICckc2V0T25JbnNlcnQnLCAnJHVuc2V0JyBdO1xuY29uc3QgVXBkYXRlT3BzQXJyYXkgPSBbICckYWRkVG9TZXQnLCAnJHBvcCcsICckcHVsbCcsICckcHVzaCcsICckcHVsbEFsbCcgXTtcbmNvbnN0IFVwZGF0ZU9wcyA9IFVwZGF0ZU9wc0ZpZWxkLmNvbmNhdChVcGRhdGVPcHNBcnJheSk7XG5cbi8qKlxuICogTW9uZ29kYiBkYXRhIHN0b3JhZ2UgY29ubmVjdG9yLlxuICogQGNsYXNzXG4gKiBAZXh0ZW5kcyBDb25uZWN0b3JcbiAqL1xuY2xhc3MgTW9uZ29kYkNvbm5lY3RvciBleHRlbmRzIENvbm5lY3RvciB7XG4gICAgLyoqICAgICAgICAgIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIFxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW29wdGlvbnMudXNlUHJlcGFyZWRTdGF0ZW1lbnRdIC0gXG4gICAgICovXG4gICAgY29uc3RydWN0b3IoY29ubmVjdGlvblN0cmluZywgb3B0aW9ucykgeyAgICAgICAgXG4gICAgICAgIHN1cGVyKCdtb25nb2RiJywgY29ubmVjdGlvblN0cmluZywgb3B0aW9ucyk7ICAgIFxuICAgICAgICBcbiAgICAgICAgdGhpcy5sb2NrZXJGaWVsZCA9IHRoaXMub3B0aW9ucy5sb2NrZXJGaWVsZCB8fCAnX19sb2NrX18nO1xuICAgIH1cblxuICAgIGZpbmRBbGxfID0gdGhpcy5maW5kXztcblxuICAgIC8qKlxuICAgICAqIENsb3NlIGFsbCBjb25uZWN0aW9uIGluaXRpYXRlZCBieSB0aGlzIGNvbm5lY3Rvci5cbiAgICAgKi9cbiAgICBhc3luYyBlbmRfKCkge1xuICAgICAgICBpZiAodGhpcy5jbGllbnQgJiYgdGhpcy5jbGllbnQuaXNDb25uZWN0ZWQoKSkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5jbGllbnQuY2xvc2UoKTtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYG1vbmdvZGI6IHN1Y2Nlc3NmdWxseSBkaXNjb25uZWN0ZWQgZnJvbSBcIiR7dGhpcy5nZXRDb25uZWN0aW9uU3RyaW5nV2l0aG91dENyZWRlbnRpYWwoKX1cIi5gKTsgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgIH1cblxuICAgICAgICBkZWxldGUgdGhpcy5jbGllbnQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgZGF0YWJhc2UgY29ubmVjdGlvbiBiYXNlZCBvbiB0aGUgZGVmYXVsdCBjb25uZWN0aW9uIHN0cmluZyBvZiB0aGUgY29ubmVjdG9yIGFuZCBnaXZlbiBvcHRpb25zLiAgICAgXG4gICAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXSAtIEV4dHJhIG9wdGlvbnMgZm9yIHRoZSBjb25uZWN0aW9uLCBvcHRpb25hbC5cbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtvcHRpb25zLm11bHRpcGxlU3RhdGVtZW50cz1mYWxzZV0gLSBBbGxvdyBydW5uaW5nIG11bHRpcGxlIHN0YXRlbWVudHMgYXQgYSB0aW1lLlxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbH0gW29wdGlvbnMuY3JlYXRlRGF0YWJhc2U9ZmFsc2VdIC0gRmxhZyB0byB1c2VkIHdoZW4gY3JlYXRpbmcgYSBkYXRhYmFzZS5cbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZS48RGI+fVxuICAgICAqL1xuICAgIGFzeW5jIGNvbm5lY3RfKG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKCF0aGlzLmNsaWVudCB8fCAhdGhpcy5jbGllbnQuaXNDb25uZWN0ZWQoKSkge1xuICAgICAgICAgICAgbGV0IGNsaWVudCA9IG5ldyBNb25nb0NsaWVudCh0aGlzLmNvbm5lY3Rpb25TdHJpbmcsIHt1c2VOZXdVcmxQYXJzZXI6IHRydWV9KTtcbiAgICAgICAgICAgIHRoaXMuY2xpZW50ID0gYXdhaXQgY2xpZW50LmNvbm5lY3QoKTsgXG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGBtb25nb2RiOiBzdWNjZXNzZnVsbHkgY29ubmVjdGVkIHRvIFwiJHt0aGlzLmdldENvbm5lY3Rpb25TdHJpbmdXaXRob3V0Q3JlZGVudGlhbCgpfVwiLmApOyAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgfSAgICAgICBcblxuICAgICAgICByZXR1cm4gdGhpcy5jbGllbnQuZGIodGhpcy5kYXRhYmFzZSk7XG4gICAgfVxuICAgIFxuICAgIC8qKlxuICAgICAqIENsb3NlIGEgZGF0YWJhc2UgY29ubmVjdGlvbi5cbiAgICAgKiBAcGFyYW0ge0RifSBjb25uIC0gTXlTUUwgY29ubmVjdGlvbi5cbiAgICAgKi9cbiAgICBhc3luYyBkaXNjb25uZWN0Xyhjb25uKSB7XG4gICAgfVxuXG4gICAgYXN5bmMgcGluZ18oKSB7ICBcbiAgICAgICAgcmV0dXJuIHRoaXMuZXhlY3V0ZV8oZGIgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGRiLmxpc3RDb2xsZWN0aW9ucyhudWxsLCB7IG5hbWVPbmx5OiB0cnVlIH0pLnRvQXJyYXkoKTtcbiAgICAgICAgfSk7ICBcbiAgICB9XG5cbiAgICBhc3luYyBleGVjdXRlXyhkYkV4ZWN1dG9yKSB7XG4gICAgICAgIGxldCBkYjtcbiAgICBcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGRiID0gYXdhaXQgdGhpcy5jb25uZWN0XygpO1xuXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgZGJFeGVjdXRvcihkYik7XG4gICAgICAgIH0gY2F0Y2goZXJyKSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICBkYiAmJiBhd2FpdCB0aGlzLmRpc2Nvbm5lY3RfKGRiKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbb3B0aW9uc10gLSBPcHRpb25hbCBzZXR0aW5ncy5cbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuYnVja2V0TmFtZT0nZnMnXSAtIFRoZSAnZmlsZXMnIGFuZCAnY2h1bmtzJyBjb2xsZWN0aW9ucyB3aWxsIGJlIHByZWZpeGVkIHdpdGggdGhlIGJ1Y2tldCBuYW1lIGZvbGxvd2VkIGJ5IGEgZG90LlxuICAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBbb3B0aW9ucy5jaHVua1NpemVCeXRlc10gLSBOdW1iZXIgb2YgYnl0ZXMgc3RvcmVkIGluIGVhY2ggY2h1bmsuIERlZmF1bHRzIHRvIDI1NUtCXG4gICAgICogQHByb3BlcnR5IHtvYmplY3R9IFtvcHRpb25zLndyaXRlQ29uY2Vybl1cbiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gW29wdGlvbnMucmVhZFByZWZlcmVuY2VdXG4gICAgICovXG4gICAgYXN5bmMgY3JlYXRlR3JpZEZTQnVja2V0XyhvcHRpb25zKSB7XG4gICAgICAgIGxldCBkYiA9IGF3YWl0IHRoaXMuY29ubmVjdF8oKTtcblxuICAgICAgICByZXR1cm4gbmV3IEdyaWRGU0J1Y2tldChkYiwgb3B0aW9ucyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgbmV3IGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGluc2VydE9uZV8obW9kZWwsIGRhdGEsIG9wdGlvbnMpIHtcbiAgICAgICAgb3B0aW9ucyA9IHsgYnlwYXNzRG9jdW1lbnRWYWxpZGF0aW9uOiB0cnVlLCAuLi5vcHRpb25zIH07XG5cbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ2luc2VydE9uZTogJyArIEpTT04uc3RyaW5naWZ5KHttb2RlbCwgZGF0YSwgb3B0aW9uc30pKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5pbnNlcnRPbmUoZGF0YSwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhbiBhcnJheSBvZiBuZXcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge2FycmF5fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBpbnNlcnRNYW55Xyhtb2RlbCwgZGF0YSwgb3B0aW9ucykge1xuICAgICAgICBvcHRpb25zID0geyBieXBhc3NEb2N1bWVudFZhbGlkYXRpb246IHRydWUsIG9yZGVyZWQ6IGZhbHNlLCAuLi5vcHRpb25zIH07XG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdpbnNlcnRNYW55OiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBjb3VudDogZGF0YS5sZW5ndGgsIG9wdGlvbnN9KSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuaW5zZXJ0TWFueShkYXRhLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgaW5zZXJ0T25lSWZOb3RFeGlzdF8obW9kZWwsIGRhdGEsIG9wdGlvbnMpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCB0aGlzLmluc2VydE9uZV8obW9kZWwsIGRhdGEsIG9wdGlvbnMpXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBpZiAoZXJyb3IuY29kZSA9PT0gMTEwMDApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIGFuIGV4aXN0aW5nIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIHVwZGF0ZU9uZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykgeyBcbiAgICAgICAgZGF0YSA9IHRoaXMuX3RyYW5zbGF0ZVVwZGF0ZShkYXRhKTtcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ3VwZGF0ZU9uZTogJyArIEpTT04uc3RyaW5naWZ5KHttb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zfSkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLnVwZGF0ZU9uZShjb25kaXRpb24sIGRhdGEsIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICBhc3luYyB1cGRhdGVPbmVBbmRSZXR1cm5fKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgICAgICAgICAgICBcbiAgICAgICAgbGV0IHJldCA9IGF3YWl0IHRoaXMuZmluZE9uZUFuZFVwZGF0ZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgeyAuLi5vcHRpb25zLCB1cHNlcnQ6IGZhbHNlLCByZXR1cm5PcmlnaW5hbDogZmFsc2UgfSk7XG4gICAgICAgIHJldHVybiByZXQgJiYgcmV0LnZhbHVlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZSBhbiBleGlzdGluZyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyB1cHNlcnRPbmVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgXG4gICAgICAgIGxldCB0cmFucyA9IHRoaXMuX3RyYW5zbGF0ZVVwZGF0ZShkYXRhKTtcbiAgICAgICAgbGV0IHsgX2lkLCAuLi5vdGhlcnMgfSA9IHRyYW5zLiRzZXQ7IFxuICAgICAgICBpZiAoIV8uaXNOaWwoX2lkKSkge1xuICAgICAgICAgICAgdHJhbnMuJHNldCA9IG90aGVycztcbiAgICAgICAgICAgIHRyYW5zLiRzZXRPbkluc2VydCA9IHsgX2lkIH07XG4gICAgICAgIH1cblxuICAgICAgICBvcHRpb25zID0geyAuLi5vcHRpb25zLCB1cHNlcnQ6IHRydWUgfTtcblxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ1N0YXRlbWVudCkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAndXBkYXRlT25lOiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBkYXRhOiB0cmFucywgY29uZGl0aW9uLCBvcHRpb25zfSkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwudXBkYXRlT25lKGNvbmRpdGlvbiwgdHJhbnMsIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgbWFueSBlbnRpdGllcy5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgLSBBcnJheSBvZiByZWNvcmQgd2l0aCBfaWRcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgdXBzZXJ0TWFueV8obW9kZWwsIGRhdGEsIHVuaXF1ZUtleXMsIG9wdGlvbnMpIHsgXG4gICAgICAgIGxldCBvcHMgPSBkYXRhLm1hcChyZWNvcmQgPT4ge1xuICAgICAgICAgICAgbGV0IHsgX2lkLCAuLi51cGRhdGVEYXRhIH0gPSByZWNvcmQ7XG5cbiAgICAgICAgICAgIGxldCB1cGRhdGVPcCA9IHtcbiAgICAgICAgICAgICAgICAkc2V0OiB1cGRhdGVEYXRhXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBpZiAoX2lkKSB7XG4gICAgICAgICAgICAgICAgdXBkYXRlT3AuJHNldE9uSW5zZXJ0ID0geyBfaWQgfTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICB1cGRhdGVPbmU6IHsgZmlsdGVyOiB7IC4uLl8ucGljayhyZWNvcmQsIHVuaXF1ZUtleXMpIH0sIHVwZGF0ZTogdXBkYXRlT3AsIHVwc2VydDogdHJ1ZSB9XG4gICAgICAgICAgICB9O1xuICAgICAgICB9KTtcblxuICAgICAgICBvcHRpb25zID0geyBieXBhc3NEb2N1bWVudFZhbGlkYXRpb246IHRydWUsIG9yZGVyZWQ6IGZhbHNlLCAuLi5vcHRpb25zIH07XG5cbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ2J1bGtXcml0ZTogJyArIEpTT04uc3RyaW5naWZ5KHttb2RlbCwgY291bnQ6IG9wcy5sZW5ndGgsIG9wdGlvbnN9KSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5idWxrV3JpdGUob3BzLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgdXBkYXRlTWFueUFuZFJldHVybl8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykgeyAgICAgICAgXG4gICAgICAgIGxldCBsb2NrZXJJZCA9IEdlbmVyYXRvcnMuc2hvcnRpZCgpO1xuXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICd1cGRhdGVNYW55K2ZpbmQrdXBkYXRlTWFueTogJyArIEpTT04uc3RyaW5naWZ5KHttb2RlbCwgY291bnQ6IGRhdGEubGVuZ3RoLCBjb25kaXRpb24sIG9wdGlvbnN9KSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCBhc3luYyAoY29sbCkgPT4ge1xuICAgICAgICAgICAgLy8xLnVwZGF0ZSBhbmQgc2V0IGxvY2tlclxuICAgICAgICAgICAgbGV0IHJldCA9IGF3YWl0IGNvbGwudXBkYXRlTWFueShcbiAgICAgICAgICAgICAgICB7IC4uLmNvbmRpdGlvbiwgW3RoaXMubG9ja2VyRmllbGRdOiB7ICRleGlzdHM6IGZhbHNlIH0gfSwgLy8gZm9yIGFsbCBub24tbG9ja2VkXG4gICAgICAgICAgICAgICAgeyAkc2V0OiB7IC4uLmRhdGEsIFt0aGlzLmxvY2tlckZpZWxkXTogbG9ja2VySWQgfSB9LCAvLyBsb2NrIGl0IFxuICAgICAgICAgICAgICAgIHsgLi4ub3B0aW9ucywgdXBzZXJ0OiBmYWxzZSB9ICk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgLy8yLnJldHVybiBhbGwgbG9ja2VkIHJlY29yZHNcbiAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgY29sbC5maW5kKHsgW3RoaXMubG9ja2VyRmllbGRdOiBsb2NrZXJJZCB9LCB7IHByb2plY3Rpb246IHsgW3RoaXMubG9ja2VyRmllbGRdOiAwIH0gfSkudG9BcnJheSgpOyAvLyByZXR1cm4gYWxsIGxvY2tlZFxuICAgICAgICAgICAgfSBmaW5hbGx5IHsgICAgXG4gICAgICAgICAgICAgICAgLy8zLnJlbW92ZSBsb2NrZXJzXG4gICAgICAgICAgICAgICAgaWYgKHJldC5yZXN1bHQubk1vZGlmaWVkID4gMCkgeyAvLyB1bmxvY2tcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgY29sbC51cGRhdGVNYW55KHsgW3RoaXMubG9ja2VyRmllbGRdOiBsb2NrZXJJZCB9LCB7ICR1bnNldDogeyBbdGhpcy5sb2NrZXJGaWVsZF06IFwiXCIgfSB9LCB7IHVwc2VydDogZmFsc2UgfSk7ICAgIFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7ICAgICAgICAgXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogSW5zZXJ0IG1hbnkgZW50aXRpZXMgaWYgbm90IGV4aXN0LlxuICAgICAqIEBwYXJhbSB7Kn0gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gdW5pcXVlS2V5cyBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgaW5zZXJ0TWFueUlmTm90RXhpc3RfKG1vZGVsLCBkYXRhLCB1bmlxdWVLZXlzLCBvcHRpb25zKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdidWdneTogdG9maXgnKTtcbiAgICAgICAgbGV0IG9wcyA9IGRhdGEubWFwKHJlY29yZCA9PiAoe1xuICAgICAgICAgICAgdXBkYXRlT25lOiB7IGZpbHRlcjogeyAuLi5fLnBpY2socmVjb3JkLCB1bmlxdWVLZXlzKSB9LCB1cGRhdGU6IHsgJHNldE9uSW5zZXJ0OiByZWNvcmQgfSwgdXBzZXJ0OiB0cnVlIH1cbiAgICAgICAgfSkpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmJ1bGtXcml0ZShvcHMsIHsgYnlwYXNzRG9jdW1lbnRWYWxpZGF0aW9uOiB0cnVlLCBvcmRlcmVkOiBmYWxzZSwgLi4ub3B0aW9ucyB9KSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIG11bHRpcGxlIGRvY3VtZW50cy5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyB1cGRhdGVNYW55Xyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7IFxuICAgICAgICBkYXRhID0gdGhpcy5fdHJhbnNsYXRlVXBkYXRlKGRhdGEpO1xuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ1N0YXRlbWVudCkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAndXBkYXRlTWFueTogJyArIEpTT04uc3RyaW5naWZ5KHttb2RlbCwgY291bnQ6IGRhdGEubGVuZ3RoLCBjb25kaXRpb24sIG9wdGlvbnN9KSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC51cGRhdGVNYW55KGNvbmRpdGlvbiwgZGF0YSwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlcGxhY2UgYW4gZXhpc3RpbmcgZW50aXR5IG9yIGNyZWF0ZSBhIG5ldyBvbmUuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyByZXBsYWNlT25lXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdyZXBsYWNlT25lOiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnN9KSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5yZXBsYWNlT25lKGNvbmRpdGlvbiwgZGF0YSwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZSBhbiBleGlzdGluZyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBkZWxldGVPbmVfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ2RlbGV0ZU9uZTogJyArIEpTT04uc3RyaW5naWZ5KHttb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zfSkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZGVsZXRlT25lKGNvbmRpdGlvbiwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZSBhbiBleGlzdGluZyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBkZWxldGVNYW55Xyhtb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdkZWxldGVNYW55OiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBjb25kaXRpb24sIG9wdGlvbnN9KSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZGVsZXRlTWFueShjb25kaXRpb24sIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXBsYWNlIChpbnNlcnQgb3IgdXBkYXRlIGZvciBleHNpc3RpbmcpIGFuIGVudGl0eSBhbmQgcmV0dXJuIG9yaWdpbmFsIHJlY29yZC5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGZpbmRPbmVBbmRSZXBsYWNlXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdmaW5kT25lQW5kUmVwbGFjZTogJyArIEpTT04uc3RyaW5naWZ5KHttb2RlbCwgZGF0YSwgb3B0aW9uc30pKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5maW5kT25lQW5kUmVwbGFjZShjb25kaXRpb24sIGRhdGEsIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBGaW5kIGEgZG9jdW1lbnQgYW5kIHVwZGF0ZSBpdCBpbiBvbmUgYXRvbWljIG9wZXJhdGlvbi4gUmVxdWlyZXMgYSB3cml0ZSBsb2NrIGZvciB0aGUgZHVyYXRpb24gb2YgdGhlIG9wZXJhdGlvbi5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGZpbmRPbmVBbmRVcGRhdGVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgICAgIFxuICAgICAgICBkYXRhID0gdGhpcy5fdHJhbnNsYXRlVXBkYXRlKGRhdGEpO1xuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ1N0YXRlbWVudCkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAnZmluZE9uZUFuZFVwZGF0ZTogJyArIEpTT04uc3RyaW5naWZ5KHttb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zfSkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmZpbmRPbmVBbmRVcGRhdGUoY29uZGl0aW9uLCBkYXRhLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgZmluZE9uZUFuZERlbGV0ZV8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ1N0YXRlbWVudCkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAnZmluZE9uZUFuZERlbGV0ZTogJyArIEpTT04uc3RyaW5naWZ5KHttb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zfSkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmZpbmRPbmVBbmREZWxldGUoY29uZGl0aW9uLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgZmluZE9uZV8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ1N0YXRlbWVudCkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAnZmluZE9uZTogJyArIEpTT04uc3RyaW5naWZ5KHttb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zfSkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZmluZE9uZShjb25kaXRpb24sIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBQZXJmb3JtIHNlbGVjdCBvcGVyYXRpb24uXG4gICAgICogQHBhcmFtIHsqfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgZmluZF8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICBsZXQgcXVlcnlPcHRpb25zID0gey4uLm9wdGlvbnN9O1xuICAgICAgICBsZXQgcXVlcnkgPSB7fTtcblxuICAgICAgICBpZiAoY29uZGl0aW9uKSB7XG4gICAgICAgICAgICBsZXQgeyAkcHJvamVjdGlvbiwgJG9yZGVyQnksICRvZmZzZXQsICRsaW1pdCwgJHF1ZXJ5LCAuLi5vdGhlcnMgfSA9IGNvbmRpdGlvbjtcblxuICAgICAgICAgICAgaWYgKCRwcm9qZWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLnByb2plY3Rpb24gPSAkcHJvamVjdGlvbjsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICgkb3JkZXJCeSkge1xuICAgICAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucy5zb3J0ID0gJG9yZGVyQnk7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoJG9mZnNldCkge1xuICAgICAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucy5za2lwID0gJG9mZnNldDsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICgkbGltaXQpIHtcbiAgICAgICAgICAgICAgICBxdWVyeU9wdGlvbnMubGltaXQgPSAkbGltaXQ7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBPYmplY3QuYXNzaWduKHF1ZXJ5LCBfLnBpY2tCeShvdGhlcnMsICh2LGspID0+IGtbMF0gIT09ICckJykpO1xuXG4gICAgICAgICAgICBpZiAoJHF1ZXJ5KSB7XG4gICAgICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihxdWVyeSwgJHF1ZXJ5KTtcbiAgICAgICAgICAgIH0gXG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ1N0YXRlbWVudCkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAnZmluZDogJyArIEpTT04uc3RyaW5naWZ5KHttb2RlbCwgY29uZGl0aW9uOiBxdWVyeSwgb3B0aW9uczogcXVlcnlPcHRpb25zfSkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgYXN5bmMgY29sbCA9PiB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBsZXQgcmVzdWx0ID0gYXdhaXQgY29sbC5maW5kKHF1ZXJ5LCBxdWVyeU9wdGlvbnMpLnRvQXJyYXkoKTtcblxuICAgICAgICAgICAgaWYgKGNvbmRpdGlvbiAmJiBjb25kaXRpb24uJHRvdGFsQ291bnQpIHtcbiAgICAgICAgICAgICAgICBsZXQgdG90YWxDb3VudCA9IGF3YWl0IGNvbGwuZmluZChxdWVyeSkuY291bnQoKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gWyByZXN1bHQsIHRvdGFsQ291bnQgXTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgfSk7XG4gICAgfSAgIFxuXG4gICAgYXN5bmMgYWdncmVnYXRlXyhtb2RlbCwgcGlwZWxpbmUsIG9wdGlvbnMpIHsgICAgICAgIFxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ1N0YXRlbWVudCkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAnYWdncmVnYXRlOiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBwaXBlbGluZSwgb3B0aW9uc30pKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5hZ2dyZWdhdGUocGlwZWxpbmUsIG9wdGlvbnMpLnRvQXJyYXkoKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgb25Db2xsZWN0aW9uXyhtb2RlbCwgZXhlY3V0b3IpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZXhlY3V0ZV8oZGIgPT4gZXhlY3V0b3IoZGIuY29sbGVjdGlvbihtb2RlbCkpKTtcbiAgICB9XG5cbiAgICBfdHJhbnNsYXRlVXBkYXRlKHVwZGF0ZSkge1xuICAgICAgICBsZXQgb3BzID0gXy5waWNrKHVwZGF0ZSwgVXBkYXRlT3BzKTtcbiAgICAgICAgbGV0IG90aGVycyA9IF8ub21pdCh1cGRhdGUsIFVwZGF0ZU9wcyk7XG5cbiAgICAgICAgaWYgKG9wcy4kc2V0KSB7XG4gICAgICAgICAgICBvcHMuJHNldCA9IHsgLi4ub3BzLiRzZXQsIC4uLm90aGVycyB9O1xuICAgICAgICB9IGVsc2UgaWYgKCFfLmlzRW1wdHkob3RoZXJzKSkge1xuICAgICAgICAgICAgb3BzLiRzZXQgPSBvdGhlcnM7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gb3BzO1xuICAgIH1cbn1cblxuTW9uZ29kYkNvbm5lY3Rvci5kcml2ZXJMaWIgPSBtb25nb2RiO1xuXG5tb2R1bGUuZXhwb3J0cyA9IE1vbmdvZGJDb25uZWN0b3I7Il19