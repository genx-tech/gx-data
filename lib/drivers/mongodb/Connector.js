"use strict";

require("source-map-support/register");

const {
  _,
  waitUntil_
} = require('rk-utils');

const {
  tryRequire
} = require('../../utils/lib');

const mongodb = tryRequire('mongodb');
const {
  MongoClient,
  GridFSBucket
} = mongodb;

const Connector = require('../../Connector');

const Generators = require('../../Generators');

const {
  InvalidArgument
} = require('../../utils/Errors');

const UpdateOpsField = ['$currentDate', '$inc', '$min', '$max', '$mul', '$rename', '$set', '$setOnInsert', '$unset'];
const UpdateOpsArray = ['$addToSet', '$pop', '$pull', '$push', '$pullAll'];
const UpdateOps = UpdateOpsField.concat(UpdateOpsArray);

class MongodbConnector extends Connector {
  constructor(connectionString, options) {
    super('mongodb', connectionString, options);
    this.findAll_ = this.find_;
    this.lockerField = this.options.lockerField || '__lock__';
  }

  async end_() {
    if (this.client && this.client.isConnected()) {
      await this.client.close();
      this.log('verbose', `mongodb: successfully disconnected from "${this.getConnectionStringWithoutCredential()}".`);
    }

    delete this.client;
  }

  async connect_(options) {
    if (!this.client || !this.client.isConnected()) {
      let client = new MongoClient(this.connectionString, {
        useNewUrlParser: true
      });
      this.client = await client.connect();
      this.log('verbose', `mongodb: successfully connected to "${this.getConnectionStringWithoutCredential()}".`);
    }

    return this.client.db(this.database);
  }

  async disconnect_(conn) {}

  async ping_() {
    return this.execute_(db => {
      return db.listCollections(null, {
        nameOnly: true
      }).toArray();
    });
  }

  async execute_(dbExecutor) {
    let db;

    try {
      db = await this.connect_();
      return await dbExecutor(db);
    } catch (err) {
      throw err;
    } finally {
      db && (await this.disconnect_(db));
    }
  }

  async createGridFSBucket_(options) {
    let db = await this.connect_();
    return new GridFSBucket(db, options);
  }

  async insertOne_(model, data, options) {
    options = {
      bypassDocumentValidation: true,
      ...options
    };

    if (this.options.logStatement) {
      this.log('verbose', 'insertOne: ' + JSON.stringify({
        model,
        data,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.insertOne(data, options));
  }

  async insertMany_(model, data, options) {
    options = {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    };

    if (this.options.logStatement) {
      this.log('verbose', 'insertMany: ' + JSON.stringify({
        model,
        count: data.length,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.insertMany(data, options));
  }

  async insertOneIfNotExist_(model, data, options) {
    try {
      return await this.insertOne_(model, data, options);
    } catch (error) {
      if (error.code === 11000) {
        return false;
      }

      throw error;
    }
  }

  async updateOne_(model, data, condition, options) {
    data = this._translateUpdate(data);

    if (this.options.logStatement) {
      this.log('verbose', 'updateOne: ' + JSON.stringify({
        model,
        data,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.updateOne(condition, data, options));
  }

  async updateOneAndReturn_(model, data, condition, options) {
    let ret = await this.findOneAndUpdate_(model, data, condition, { ...options,
      upsert: false,
      returnOriginal: false
    });
    return ret && ret.value;
  }

  async upsertOne_(model, data, condition, options, dataOnInsert) {
    let trans = this._translateUpdate(data);

    let {
      _id,
      ...others
    } = trans.$set || {};

    if (!_.isNil(_id)) {
      trans.$set = others;
      trans.$setOnInsert = {
        _id
      };
    }

    if (!_.isEmpty(dataOnInsert)) {
      trans.$setOnInsert = { ...trans.$setOnInsert,
        ...dataOnInsert
      };
    }

    options = { ...options,
      upsert: true
    };

    if (this.options.logStatement) {
      this.log('verbose', 'upsertOne: ' + JSON.stringify({
        model,
        data: trans,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.updateOne(condition, trans, options));
  }

  async upsertMany_(model, data, uniqueKeys, options, dataOnInsert) {
    let ops = data.map(record => {
      let {
        _id,
        ...updateData
      } = record;

      let updateOp = this._translateUpdate(updateData);

      if (_id) {
        updateOp.$setOnInsert = {
          _id,
          ...dataOnInsert
        };
      } else if (!_.isEmpty(dataOnInsert)) {
        updateOp.$setOnInsert = dataOnInsert;
      }

      return {
        updateOne: {
          filter: { ..._.pick(record, uniqueKeys)
          },
          update: updateOp,
          upsert: true
        }
      };
    });
    options = {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    };

    if (this.options.logStatement) {
      this.log('verbose', 'bulkWrite: ' + JSON.stringify({
        model,
        count: ops.length,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.bulkWrite(ops, options));
  }

  async updateManyAndReturn_(model, data, condition, options) {
    let lockerId = Generators.shortid();

    if (this.options.logStatement) {
      this.log('verbose', 'updateMany+find+updateMany: ' + JSON.stringify({
        model,
        count: data.length,
        condition,
        options
      }));
    }

    return this.onCollection_(model, async coll => {
      let ret = await coll.updateMany({ ...condition,
        [this.lockerField]: {
          $exists: false
        }
      }, {
        $set: { ...data,
          [this.lockerField]: lockerId
        }
      }, { ...options,
        upsert: false
      });

      try {
        return await coll.find({
          [this.lockerField]: lockerId
        }, {
          projection: {
            [this.lockerField]: 0
          }
        }).toArray();
      } finally {
        if (ret.result.nModified > 0) {
          await coll.updateMany({
            [this.lockerField]: lockerId
          }, {
            $unset: {
              [this.lockerField]: ""
            }
          }, {
            upsert: false
          });
        }
      }
    });
  }

  async insertManyIfNotExist_(model, data, uniqueKeys, options) {
    console.log('buggy: tofix');
    let ops = data.map(record => ({
      updateOne: {
        filter: { ..._.pick(record, uniqueKeys)
        },
        update: {
          $setOnInsert: record
        },
        upsert: true
      }
    }));
    return this.onCollection_(model, coll => coll.bulkWrite(ops, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async updateMany_(model, data, condition, options) {
    data = this._translateUpdate(data);

    if (this.options.logStatement) {
      this.log('verbose', 'updateMany: ' + JSON.stringify({
        model,
        count: data.length,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.updateMany(condition, data, options));
  }

  async replaceOne_(model, data, condition, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'replaceOne: ' + JSON.stringify({
        model,
        data,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.replaceOne(condition, data, options));
  }

  async deleteOne_(model, condition, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'deleteOne: ' + JSON.stringify({
        model,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.deleteOne(condition, options));
  }

  async deleteMany_(model, condition, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'deleteMany: ' + JSON.stringify({
        model,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.deleteMany(condition, options));
  }

  async findOneAndReplace_(model, data, condition, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'findOneAndReplace: ' + JSON.stringify({
        model,
        data,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.findOneAndReplace(condition, data, options));
  }

  async findOneAndUpdate_(model, data, condition, options) {
    data = this._translateUpdate(data);

    if (this.options.logStatement) {
      this.log('verbose', 'findOneAndUpdate: ' + JSON.stringify({
        model,
        data,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.findOneAndUpdate(condition, data, options));
  }

  async findOneAndDelete_(model, condition, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'findOneAndDelete: ' + JSON.stringify({
        model,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.findOneAndDelete(condition, options));
  }

  async findOne_(model, condition, options) {
    let queryOptions = { ...options
    };
    let query;

    if (!_.isEmpty(condition)) {
      let {
        $projection,
        $query,
        ...others
      } = condition;

      if ($projection) {
        queryOptions.projection = $projection;
      }

      query = { ...others,
        ...$query
      };
    } else {
      throw new InvalidArgument('findOne requires non-empty query condition.');
    }

    if (this.options.logStatement) {
      this.log('verbose', 'findOne: ' + JSON.stringify({
        model,
        condition: query,
        options: queryOptions
      }));
    }

    return this.onCollection_(model, coll => coll.findOne(query, queryOptions));
  }

  async find_(model, condition, options) {
    let queryOptions = { ...options
    };
    let query, requireTotalCount;

    if (!_.isEmpty(condition)) {
      let {
        $projection,
        $totalCount,
        $orderBy,
        $offset,
        $limit,
        $query,
        ...others
      } = condition;

      if ($projection) {
        queryOptions.projection = $projection;
      }

      if ($orderBy) {
        queryOptions.sort = $orderBy;
      }

      if ($offset) {
        queryOptions.skip = $offset;
      }

      if ($limit) {
        queryOptions.limit = $limit;
      }

      query = { ...others,
        ...$query
      };
      requireTotalCount = $totalCount;
    } else {
      query = {};
      requireTotalCount = false;
    }

    if (this.options.logStatement) {
      this.log('verbose', 'find: ' + JSON.stringify({
        model,
        condition: query,
        options: queryOptions
      }));
    }

    return this.onCollection_(model, async coll => {
      let result = await coll.find(query, queryOptions).toArray();

      if (requireTotalCount) {
        let totalCount = await coll.find(query).count();
        return [result, totalCount];
      }

      return result;
    });
  }

  async aggregate_(model, pipeline, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'aggregate: ' + JSON.stringify({
        model,
        pipeline,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.aggregate(pipeline, options).toArray());
  }

  async distinct_(model, field, query, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'distinct: ' + JSON.stringify({
        model,
        field,
        query,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.distinct(field, query, options));
  }

  async onCollection_(model, executor) {
    return this.execute_(db => executor(db.collection(model)));
  }

  _translateUpdate(update) {
    let ops = _.pick(update, UpdateOps);

    let others = _.omit(update, UpdateOps);

    if (ops.$set) {
      ops.$set = { ...ops.$set,
        ...others
      };
    } else if (!_.isEmpty(others)) {
      ops.$set = others;
    }

    return ops;
  }

}

MongodbConnector.driverLib = mongodb;
module.exports = MongodbConnector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kcml2ZXJzL21vbmdvZGIvQ29ubmVjdG9yLmpzIl0sIm5hbWVzIjpbIl8iLCJ3YWl0VW50aWxfIiwicmVxdWlyZSIsInRyeVJlcXVpcmUiLCJtb25nb2RiIiwiTW9uZ29DbGllbnQiLCJHcmlkRlNCdWNrZXQiLCJDb25uZWN0b3IiLCJHZW5lcmF0b3JzIiwiSW52YWxpZEFyZ3VtZW50IiwiVXBkYXRlT3BzRmllbGQiLCJVcGRhdGVPcHNBcnJheSIsIlVwZGF0ZU9wcyIsImNvbmNhdCIsIk1vbmdvZGJDb25uZWN0b3IiLCJjb25zdHJ1Y3RvciIsImNvbm5lY3Rpb25TdHJpbmciLCJvcHRpb25zIiwiZmluZEFsbF8iLCJmaW5kXyIsImxvY2tlckZpZWxkIiwiZW5kXyIsImNsaWVudCIsImlzQ29ubmVjdGVkIiwiY2xvc2UiLCJsb2ciLCJnZXRDb25uZWN0aW9uU3RyaW5nV2l0aG91dENyZWRlbnRpYWwiLCJjb25uZWN0XyIsInVzZU5ld1VybFBhcnNlciIsImNvbm5lY3QiLCJkYiIsImRhdGFiYXNlIiwiZGlzY29ubmVjdF8iLCJjb25uIiwicGluZ18iLCJleGVjdXRlXyIsImxpc3RDb2xsZWN0aW9ucyIsIm5hbWVPbmx5IiwidG9BcnJheSIsImRiRXhlY3V0b3IiLCJlcnIiLCJjcmVhdGVHcmlkRlNCdWNrZXRfIiwiaW5zZXJ0T25lXyIsIm1vZGVsIiwiZGF0YSIsImJ5cGFzc0RvY3VtZW50VmFsaWRhdGlvbiIsImxvZ1N0YXRlbWVudCIsIkpTT04iLCJzdHJpbmdpZnkiLCJvbkNvbGxlY3Rpb25fIiwiY29sbCIsImluc2VydE9uZSIsImluc2VydE1hbnlfIiwib3JkZXJlZCIsImNvdW50IiwibGVuZ3RoIiwiaW5zZXJ0TWFueSIsImluc2VydE9uZUlmTm90RXhpc3RfIiwiZXJyb3IiLCJjb2RlIiwidXBkYXRlT25lXyIsImNvbmRpdGlvbiIsIl90cmFuc2xhdGVVcGRhdGUiLCJ1cGRhdGVPbmUiLCJ1cGRhdGVPbmVBbmRSZXR1cm5fIiwicmV0IiwiZmluZE9uZUFuZFVwZGF0ZV8iLCJ1cHNlcnQiLCJyZXR1cm5PcmlnaW5hbCIsInZhbHVlIiwidXBzZXJ0T25lXyIsImRhdGFPbkluc2VydCIsInRyYW5zIiwiX2lkIiwib3RoZXJzIiwiJHNldCIsImlzTmlsIiwiJHNldE9uSW5zZXJ0IiwiaXNFbXB0eSIsInVwc2VydE1hbnlfIiwidW5pcXVlS2V5cyIsIm9wcyIsIm1hcCIsInJlY29yZCIsInVwZGF0ZURhdGEiLCJ1cGRhdGVPcCIsImZpbHRlciIsInBpY2siLCJ1cGRhdGUiLCJidWxrV3JpdGUiLCJ1cGRhdGVNYW55QW5kUmV0dXJuXyIsImxvY2tlcklkIiwic2hvcnRpZCIsInVwZGF0ZU1hbnkiLCIkZXhpc3RzIiwiZmluZCIsInByb2plY3Rpb24iLCJyZXN1bHQiLCJuTW9kaWZpZWQiLCIkdW5zZXQiLCJpbnNlcnRNYW55SWZOb3RFeGlzdF8iLCJjb25zb2xlIiwidXBkYXRlTWFueV8iLCJyZXBsYWNlT25lXyIsInJlcGxhY2VPbmUiLCJkZWxldGVPbmVfIiwiZGVsZXRlT25lIiwiZGVsZXRlTWFueV8iLCJkZWxldGVNYW55IiwiZmluZE9uZUFuZFJlcGxhY2VfIiwiZmluZE9uZUFuZFJlcGxhY2UiLCJmaW5kT25lQW5kVXBkYXRlIiwiZmluZE9uZUFuZERlbGV0ZV8iLCJmaW5kT25lQW5kRGVsZXRlIiwiZmluZE9uZV8iLCJxdWVyeU9wdGlvbnMiLCJxdWVyeSIsIiRwcm9qZWN0aW9uIiwiJHF1ZXJ5IiwiZmluZE9uZSIsInJlcXVpcmVUb3RhbENvdW50IiwiJHRvdGFsQ291bnQiLCIkb3JkZXJCeSIsIiRvZmZzZXQiLCIkbGltaXQiLCJzb3J0Iiwic2tpcCIsImxpbWl0IiwidG90YWxDb3VudCIsImFnZ3JlZ2F0ZV8iLCJwaXBlbGluZSIsImFnZ3JlZ2F0ZSIsImRpc3RpbmN0XyIsImZpZWxkIiwiZGlzdGluY3QiLCJleGVjdXRvciIsImNvbGxlY3Rpb24iLCJvbWl0IiwiZHJpdmVyTGliIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU07QUFBRUEsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQTtBQUFMLElBQW9CQyxPQUFPLENBQUMsVUFBRCxDQUFqQzs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBO0FBQUYsSUFBaUJELE9BQU8sQ0FBQyxpQkFBRCxDQUE5Qjs7QUFDQSxNQUFNRSxPQUFPLEdBQUdELFVBQVUsQ0FBQyxTQUFELENBQTFCO0FBQ0EsTUFBTTtBQUFFRSxFQUFBQSxXQUFGO0FBQWVDLEVBQUFBO0FBQWYsSUFBZ0NGLE9BQXRDOztBQUNBLE1BQU1HLFNBQVMsR0FBR0wsT0FBTyxDQUFDLGlCQUFELENBQXpCOztBQUNBLE1BQU1NLFVBQVUsR0FBR04sT0FBTyxDQUFDLGtCQUFELENBQTFCOztBQUNBLE1BQU07QUFBRU8sRUFBQUE7QUFBRixJQUFzQlAsT0FBTyxDQUFDLG9CQUFELENBQW5DOztBQUVBLE1BQU1RLGNBQWMsR0FBRyxDQUFFLGNBQUYsRUFBa0IsTUFBbEIsRUFBMEIsTUFBMUIsRUFBa0MsTUFBbEMsRUFBMEMsTUFBMUMsRUFBa0QsU0FBbEQsRUFBNkQsTUFBN0QsRUFBcUUsY0FBckUsRUFBcUYsUUFBckYsQ0FBdkI7QUFDQSxNQUFNQyxjQUFjLEdBQUcsQ0FBRSxXQUFGLEVBQWUsTUFBZixFQUF1QixPQUF2QixFQUFnQyxPQUFoQyxFQUF5QyxVQUF6QyxDQUF2QjtBQUNBLE1BQU1DLFNBQVMsR0FBR0YsY0FBYyxDQUFDRyxNQUFmLENBQXNCRixjQUF0QixDQUFsQjs7QUFPQSxNQUFNRyxnQkFBTixTQUErQlAsU0FBL0IsQ0FBeUM7QUFNckNRLEVBQUFBLFdBQVcsQ0FBQ0MsZ0JBQUQsRUFBbUJDLE9BQW5CLEVBQTRCO0FBQ25DLFVBQU0sU0FBTixFQUFpQkQsZ0JBQWpCLEVBQW1DQyxPQUFuQztBQURtQyxTQU12Q0MsUUFOdUMsR0FNNUIsS0FBS0MsS0FOdUI7QUFHbkMsU0FBS0MsV0FBTCxHQUFtQixLQUFLSCxPQUFMLENBQWFHLFdBQWIsSUFBNEIsVUFBL0M7QUFDSDs7QUFPRCxRQUFNQyxJQUFOLEdBQWE7QUFDVCxRQUFJLEtBQUtDLE1BQUwsSUFBZSxLQUFLQSxNQUFMLENBQVlDLFdBQVosRUFBbkIsRUFBOEM7QUFDMUMsWUFBTSxLQUFLRCxNQUFMLENBQVlFLEtBQVosRUFBTjtBQUNBLFdBQUtDLEdBQUwsQ0FBUyxTQUFULEVBQXFCLDRDQUEyQyxLQUFLQyxvQ0FBTCxFQUE0QyxJQUE1RztBQUNIOztBQUVELFdBQU8sS0FBS0osTUFBWjtBQUNIOztBQVNELFFBQU1LLFFBQU4sQ0FBZVYsT0FBZixFQUF3QjtBQUNwQixRQUFJLENBQUMsS0FBS0ssTUFBTixJQUFnQixDQUFDLEtBQUtBLE1BQUwsQ0FBWUMsV0FBWixFQUFyQixFQUFnRDtBQUM1QyxVQUFJRCxNQUFNLEdBQUcsSUFBSWpCLFdBQUosQ0FBZ0IsS0FBS1csZ0JBQXJCLEVBQXVDO0FBQUNZLFFBQUFBLGVBQWUsRUFBRTtBQUFsQixPQUF2QyxDQUFiO0FBQ0EsV0FBS04sTUFBTCxHQUFjLE1BQU1BLE1BQU0sQ0FBQ08sT0FBUCxFQUFwQjtBQUNBLFdBQUtKLEdBQUwsQ0FBUyxTQUFULEVBQXFCLHVDQUFzQyxLQUFLQyxvQ0FBTCxFQUE0QyxJQUF2RztBQUNIOztBQUVELFdBQU8sS0FBS0osTUFBTCxDQUFZUSxFQUFaLENBQWUsS0FBS0MsUUFBcEIsQ0FBUDtBQUNIOztBQU1ELFFBQU1DLFdBQU4sQ0FBa0JDLElBQWxCLEVBQXdCLENBQ3ZCOztBQUVELFFBQU1DLEtBQU4sR0FBYztBQUNWLFdBQU8sS0FBS0MsUUFBTCxDQUFjTCxFQUFFLElBQUk7QUFDdkIsYUFBT0EsRUFBRSxDQUFDTSxlQUFILENBQW1CLElBQW5CLEVBQXlCO0FBQUVDLFFBQUFBLFFBQVEsRUFBRTtBQUFaLE9BQXpCLEVBQTZDQyxPQUE3QyxFQUFQO0FBQ0gsS0FGTSxDQUFQO0FBR0g7O0FBRUQsUUFBTUgsUUFBTixDQUFlSSxVQUFmLEVBQTJCO0FBQ3ZCLFFBQUlULEVBQUo7O0FBRUEsUUFBSTtBQUNBQSxNQUFBQSxFQUFFLEdBQUcsTUFBTSxLQUFLSCxRQUFMLEVBQVg7QUFFQSxhQUFPLE1BQU1ZLFVBQVUsQ0FBQ1QsRUFBRCxDQUF2QjtBQUNILEtBSkQsQ0FJRSxPQUFNVSxHQUFOLEVBQVc7QUFDVCxZQUFNQSxHQUFOO0FBQ0gsS0FORCxTQU1VO0FBQ05WLE1BQUFBLEVBQUUsS0FBSSxNQUFNLEtBQUtFLFdBQUwsQ0FBaUJGLEVBQWpCLENBQVYsQ0FBRjtBQUNIO0FBQ0o7O0FBU0QsUUFBTVcsbUJBQU4sQ0FBMEJ4QixPQUExQixFQUFtQztBQUMvQixRQUFJYSxFQUFFLEdBQUcsTUFBTSxLQUFLSCxRQUFMLEVBQWY7QUFFQSxXQUFPLElBQUlyQixZQUFKLENBQWlCd0IsRUFBakIsRUFBcUJiLE9BQXJCLENBQVA7QUFDSDs7QUFRRCxRQUFNeUIsVUFBTixDQUFpQkMsS0FBakIsRUFBd0JDLElBQXhCLEVBQThCM0IsT0FBOUIsRUFBdUM7QUFDbkNBLElBQUFBLE9BQU8sR0FBRztBQUFFNEIsTUFBQUEsd0JBQXdCLEVBQUUsSUFBNUI7QUFBa0MsU0FBRzVCO0FBQXJDLEtBQVY7O0FBRUEsUUFBSSxLQUFLQSxPQUFMLENBQWE2QixZQUFqQixFQUErQjtBQUMzQixXQUFLckIsR0FBTCxDQUFTLFNBQVQsRUFBb0IsZ0JBQWdCc0IsSUFBSSxDQUFDQyxTQUFMLENBQWU7QUFBQ0wsUUFBQUEsS0FBRDtBQUFRQyxRQUFBQSxJQUFSO0FBQWMzQixRQUFBQTtBQUFkLE9BQWYsQ0FBcEM7QUFDSDs7QUFDRCxXQUFPLEtBQUtnQyxhQUFMLENBQW1CTixLQUFuQixFQUEyQk8sSUFBRCxJQUFVQSxJQUFJLENBQUNDLFNBQUwsQ0FBZVAsSUFBZixFQUFxQjNCLE9BQXJCLENBQXBDLENBQVA7QUFDSDs7QUFRRCxRQUFNbUMsV0FBTixDQUFrQlQsS0FBbEIsRUFBeUJDLElBQXpCLEVBQStCM0IsT0FBL0IsRUFBd0M7QUFDcENBLElBQUFBLE9BQU8sR0FBRztBQUFFNEIsTUFBQUEsd0JBQXdCLEVBQUUsSUFBNUI7QUFBa0NRLE1BQUFBLE9BQU8sRUFBRSxLQUEzQztBQUFrRCxTQUFHcEM7QUFBckQsS0FBVjs7QUFDQSxRQUFJLEtBQUtBLE9BQUwsQ0FBYTZCLFlBQWpCLEVBQStCO0FBQzNCLFdBQUtyQixHQUFMLENBQVMsU0FBVCxFQUFvQixpQkFBaUJzQixJQUFJLENBQUNDLFNBQUwsQ0FBZTtBQUFDTCxRQUFBQSxLQUFEO0FBQVFXLFFBQUFBLEtBQUssRUFBRVYsSUFBSSxDQUFDVyxNQUFwQjtBQUE0QnRDLFFBQUFBO0FBQTVCLE9BQWYsQ0FBckM7QUFDSDs7QUFDRCxXQUFPLEtBQUtnQyxhQUFMLENBQW1CTixLQUFuQixFQUEyQk8sSUFBRCxJQUFVQSxJQUFJLENBQUNNLFVBQUwsQ0FBZ0JaLElBQWhCLEVBQXNCM0IsT0FBdEIsQ0FBcEMsQ0FBUDtBQUNIOztBQUVELFFBQU13QyxvQkFBTixDQUEyQmQsS0FBM0IsRUFBa0NDLElBQWxDLEVBQXdDM0IsT0FBeEMsRUFBaUQ7QUFDN0MsUUFBSTtBQUNBLGFBQU8sTUFBTSxLQUFLeUIsVUFBTCxDQUFnQkMsS0FBaEIsRUFBdUJDLElBQXZCLEVBQTZCM0IsT0FBN0IsQ0FBYjtBQUNILEtBRkQsQ0FFRSxPQUFPeUMsS0FBUCxFQUFjO0FBQ1osVUFBSUEsS0FBSyxDQUFDQyxJQUFOLEtBQWUsS0FBbkIsRUFBMEI7QUFDdEIsZUFBTyxLQUFQO0FBQ0g7O0FBRUQsWUFBTUQsS0FBTjtBQUNIO0FBQ0o7O0FBU0QsUUFBTUUsVUFBTixDQUFpQmpCLEtBQWpCLEVBQXdCQyxJQUF4QixFQUE4QmlCLFNBQTlCLEVBQXlDNUMsT0FBekMsRUFBa0Q7QUFDOUMyQixJQUFBQSxJQUFJLEdBQUcsS0FBS2tCLGdCQUFMLENBQXNCbEIsSUFBdEIsQ0FBUDs7QUFDQSxRQUFJLEtBQUszQixPQUFMLENBQWE2QixZQUFqQixFQUErQjtBQUMzQixXQUFLckIsR0FBTCxDQUFTLFNBQVQsRUFBb0IsZ0JBQWdCc0IsSUFBSSxDQUFDQyxTQUFMLENBQWU7QUFBQ0wsUUFBQUEsS0FBRDtBQUFRQyxRQUFBQSxJQUFSO0FBQWNpQixRQUFBQSxTQUFkO0FBQXlCNUMsUUFBQUE7QUFBekIsT0FBZixDQUFwQztBQUNIOztBQUNELFdBQU8sS0FBS2dDLGFBQUwsQ0FBbUJOLEtBQW5CLEVBQTJCTyxJQUFELElBQVVBLElBQUksQ0FBQ2EsU0FBTCxDQUFlRixTQUFmLEVBQTBCakIsSUFBMUIsRUFBZ0MzQixPQUFoQyxDQUFwQyxDQUFQO0FBQ0g7O0FBRUQsUUFBTStDLG1CQUFOLENBQTBCckIsS0FBMUIsRUFBaUNDLElBQWpDLEVBQXVDaUIsU0FBdkMsRUFBa0Q1QyxPQUFsRCxFQUEyRDtBQUN2RCxRQUFJZ0QsR0FBRyxHQUFHLE1BQU0sS0FBS0MsaUJBQUwsQ0FBdUJ2QixLQUF2QixFQUE4QkMsSUFBOUIsRUFBb0NpQixTQUFwQyxFQUErQyxFQUFFLEdBQUc1QyxPQUFMO0FBQWNrRCxNQUFBQSxNQUFNLEVBQUUsS0FBdEI7QUFBNkJDLE1BQUFBLGNBQWMsRUFBRTtBQUE3QyxLQUEvQyxDQUFoQjtBQUNBLFdBQU9ILEdBQUcsSUFBSUEsR0FBRyxDQUFDSSxLQUFsQjtBQUNIOztBQVVELFFBQU1DLFVBQU4sQ0FBaUIzQixLQUFqQixFQUF3QkMsSUFBeEIsRUFBOEJpQixTQUE5QixFQUF5QzVDLE9BQXpDLEVBQWtEc0QsWUFBbEQsRUFBZ0U7QUFDNUQsUUFBSUMsS0FBSyxHQUFHLEtBQUtWLGdCQUFMLENBQXNCbEIsSUFBdEIsQ0FBWjs7QUFDQSxRQUFJO0FBQUU2QixNQUFBQSxHQUFGO0FBQU8sU0FBR0M7QUFBVixRQUFxQkYsS0FBSyxDQUFDRyxJQUFOLElBQWMsRUFBdkM7O0FBQ0EsUUFBSSxDQUFDM0UsQ0FBQyxDQUFDNEUsS0FBRixDQUFRSCxHQUFSLENBQUwsRUFBbUI7QUFDZkQsTUFBQUEsS0FBSyxDQUFDRyxJQUFOLEdBQWFELE1BQWI7QUFDQUYsTUFBQUEsS0FBSyxDQUFDSyxZQUFOLEdBQXFCO0FBQUVKLFFBQUFBO0FBQUYsT0FBckI7QUFDSDs7QUFFRCxRQUFJLENBQUN6RSxDQUFDLENBQUM4RSxPQUFGLENBQVVQLFlBQVYsQ0FBTCxFQUE4QjtBQUMxQkMsTUFBQUEsS0FBSyxDQUFDSyxZQUFOLEdBQXFCLEVBQUUsR0FBR0wsS0FBSyxDQUFDSyxZQUFYO0FBQXlCLFdBQUdOO0FBQTVCLE9BQXJCO0FBQ0g7O0FBRUR0RCxJQUFBQSxPQUFPLEdBQUcsRUFBRSxHQUFHQSxPQUFMO0FBQWNrRCxNQUFBQSxNQUFNLEVBQUU7QUFBdEIsS0FBVjs7QUFFQSxRQUFJLEtBQUtsRCxPQUFMLENBQWE2QixZQUFqQixFQUErQjtBQUMzQixXQUFLckIsR0FBTCxDQUFTLFNBQVQsRUFBb0IsZ0JBQWdCc0IsSUFBSSxDQUFDQyxTQUFMLENBQWU7QUFBQ0wsUUFBQUEsS0FBRDtBQUFRQyxRQUFBQSxJQUFJLEVBQUU0QixLQUFkO0FBQXFCWCxRQUFBQSxTQUFyQjtBQUFnQzVDLFFBQUFBO0FBQWhDLE9BQWYsQ0FBcEM7QUFDSDs7QUFFRCxXQUFPLEtBQUtnQyxhQUFMLENBQW1CTixLQUFuQixFQUEyQk8sSUFBRCxJQUFVQSxJQUFJLENBQUNhLFNBQUwsQ0FBZUYsU0FBZixFQUEwQlcsS0FBMUIsRUFBaUN2RCxPQUFqQyxDQUFwQyxDQUFQO0FBQ0g7O0FBVUQsUUFBTThELFdBQU4sQ0FBa0JwQyxLQUFsQixFQUF5QkMsSUFBekIsRUFBK0JvQyxVQUEvQixFQUEyQy9ELE9BQTNDLEVBQW9Ec0QsWUFBcEQsRUFBa0U7QUFDOUQsUUFBSVUsR0FBRyxHQUFHckMsSUFBSSxDQUFDc0MsR0FBTCxDQUFTQyxNQUFNLElBQUk7QUFDekIsVUFBSTtBQUFFVixRQUFBQSxHQUFGO0FBQU8sV0FBR1c7QUFBVixVQUF5QkQsTUFBN0I7O0FBRUEsVUFBSUUsUUFBUSxHQUFHLEtBQUt2QixnQkFBTCxDQUFzQnNCLFVBQXRCLENBQWY7O0FBRUEsVUFBSVgsR0FBSixFQUFTO0FBQ0xZLFFBQUFBLFFBQVEsQ0FBQ1IsWUFBVCxHQUF3QjtBQUFFSixVQUFBQSxHQUFGO0FBQU8sYUFBR0Y7QUFBVixTQUF4QjtBQUNILE9BRkQsTUFFTyxJQUFJLENBQUN2RSxDQUFDLENBQUM4RSxPQUFGLENBQVVQLFlBQVYsQ0FBTCxFQUE4QjtBQUNqQ2MsUUFBQUEsUUFBUSxDQUFDUixZQUFULEdBQXdCTixZQUF4QjtBQUNIOztBQUVELGFBQU87QUFDSFIsUUFBQUEsU0FBUyxFQUFFO0FBQUV1QixVQUFBQSxNQUFNLEVBQUUsRUFBRSxHQUFHdEYsQ0FBQyxDQUFDdUYsSUFBRixDQUFPSixNQUFQLEVBQWVILFVBQWY7QUFBTCxXQUFWO0FBQTZDUSxVQUFBQSxNQUFNLEVBQUVILFFBQXJEO0FBQStEbEIsVUFBQUEsTUFBTSxFQUFFO0FBQXZFO0FBRFIsT0FBUDtBQUdILEtBZFMsQ0FBVjtBQWdCQWxELElBQUFBLE9BQU8sR0FBRztBQUFFNEIsTUFBQUEsd0JBQXdCLEVBQUUsSUFBNUI7QUFBa0NRLE1BQUFBLE9BQU8sRUFBRSxLQUEzQztBQUFrRCxTQUFHcEM7QUFBckQsS0FBVjs7QUFFQSxRQUFJLEtBQUtBLE9BQUwsQ0FBYTZCLFlBQWpCLEVBQStCO0FBQzNCLFdBQUtyQixHQUFMLENBQVMsU0FBVCxFQUFvQixnQkFBZ0JzQixJQUFJLENBQUNDLFNBQUwsQ0FBZTtBQUFDTCxRQUFBQSxLQUFEO0FBQVFXLFFBQUFBLEtBQUssRUFBRTJCLEdBQUcsQ0FBQzFCLE1BQW5CO0FBQTJCdEMsUUFBQUE7QUFBM0IsT0FBZixDQUFwQztBQUNIOztBQUVELFdBQU8sS0FBS2dDLGFBQUwsQ0FBbUJOLEtBQW5CLEVBQTJCTyxJQUFELElBQVVBLElBQUksQ0FBQ3VDLFNBQUwsQ0FBZVIsR0FBZixFQUFvQmhFLE9BQXBCLENBQXBDLENBQVA7QUFDSDs7QUFFRCxRQUFNeUUsb0JBQU4sQ0FBMkIvQyxLQUEzQixFQUFrQ0MsSUFBbEMsRUFBd0NpQixTQUF4QyxFQUFtRDVDLE9BQW5ELEVBQTREO0FBQ3hELFFBQUkwRSxRQUFRLEdBQUduRixVQUFVLENBQUNvRixPQUFYLEVBQWY7O0FBRUEsUUFBSSxLQUFLM0UsT0FBTCxDQUFhNkIsWUFBakIsRUFBK0I7QUFDM0IsV0FBS3JCLEdBQUwsQ0FBUyxTQUFULEVBQW9CLGlDQUFpQ3NCLElBQUksQ0FBQ0MsU0FBTCxDQUFlO0FBQUNMLFFBQUFBLEtBQUQ7QUFBUVcsUUFBQUEsS0FBSyxFQUFFVixJQUFJLENBQUNXLE1BQXBCO0FBQTRCTSxRQUFBQSxTQUE1QjtBQUF1QzVDLFFBQUFBO0FBQXZDLE9BQWYsQ0FBckQ7QUFDSDs7QUFFRCxXQUFPLEtBQUtnQyxhQUFMLENBQW1CTixLQUFuQixFQUEwQixNQUFPTyxJQUFQLElBQWdCO0FBRTdDLFVBQUllLEdBQUcsR0FBRyxNQUFNZixJQUFJLENBQUMyQyxVQUFMLENBQ1osRUFBRSxHQUFHaEMsU0FBTDtBQUFnQixTQUFDLEtBQUt6QyxXQUFOLEdBQW9CO0FBQUUwRSxVQUFBQSxPQUFPLEVBQUU7QUFBWDtBQUFwQyxPQURZLEVBRVo7QUFBRW5CLFFBQUFBLElBQUksRUFBRSxFQUFFLEdBQUcvQixJQUFMO0FBQVcsV0FBQyxLQUFLeEIsV0FBTixHQUFvQnVFO0FBQS9CO0FBQVIsT0FGWSxFQUdaLEVBQUUsR0FBRzFFLE9BQUw7QUFBY2tELFFBQUFBLE1BQU0sRUFBRTtBQUF0QixPQUhZLENBQWhCOztBQUtBLFVBQUk7QUFFQSxlQUFPLE1BQU1qQixJQUFJLENBQUM2QyxJQUFMLENBQVU7QUFBRSxXQUFDLEtBQUszRSxXQUFOLEdBQW9CdUU7QUFBdEIsU0FBVixFQUE0QztBQUFFSyxVQUFBQSxVQUFVLEVBQUU7QUFBRSxhQUFDLEtBQUs1RSxXQUFOLEdBQW9CO0FBQXRCO0FBQWQsU0FBNUMsRUFBdUZrQixPQUF2RixFQUFiO0FBQ0gsT0FIRCxTQUdVO0FBRU4sWUFBSTJCLEdBQUcsQ0FBQ2dDLE1BQUosQ0FBV0MsU0FBWCxHQUF1QixDQUEzQixFQUE4QjtBQUMxQixnQkFBTWhELElBQUksQ0FBQzJDLFVBQUwsQ0FBZ0I7QUFBRSxhQUFDLEtBQUt6RSxXQUFOLEdBQW9CdUU7QUFBdEIsV0FBaEIsRUFBa0Q7QUFBRVEsWUFBQUEsTUFBTSxFQUFFO0FBQUUsZUFBQyxLQUFLL0UsV0FBTixHQUFvQjtBQUF0QjtBQUFWLFdBQWxELEVBQTBGO0FBQUUrQyxZQUFBQSxNQUFNLEVBQUU7QUFBVixXQUExRixDQUFOO0FBQ0g7QUFDSjtBQUNKLEtBaEJNLENBQVA7QUFpQkg7O0FBU0QsUUFBTWlDLHFCQUFOLENBQTRCekQsS0FBNUIsRUFBbUNDLElBQW5DLEVBQXlDb0MsVUFBekMsRUFBcUQvRCxPQUFyRCxFQUE4RDtBQUMxRG9GLElBQUFBLE9BQU8sQ0FBQzVFLEdBQVIsQ0FBWSxjQUFaO0FBQ0EsUUFBSXdELEdBQUcsR0FBR3JDLElBQUksQ0FBQ3NDLEdBQUwsQ0FBU0MsTUFBTSxLQUFLO0FBQzFCcEIsTUFBQUEsU0FBUyxFQUFFO0FBQUV1QixRQUFBQSxNQUFNLEVBQUUsRUFBRSxHQUFHdEYsQ0FBQyxDQUFDdUYsSUFBRixDQUFPSixNQUFQLEVBQWVILFVBQWY7QUFBTCxTQUFWO0FBQTZDUSxRQUFBQSxNQUFNLEVBQUU7QUFBRVgsVUFBQUEsWUFBWSxFQUFFTTtBQUFoQixTQUFyRDtBQUErRWhCLFFBQUFBLE1BQU0sRUFBRTtBQUF2RjtBQURlLEtBQUwsQ0FBZixDQUFWO0FBSUEsV0FBTyxLQUFLbEIsYUFBTCxDQUFtQk4sS0FBbkIsRUFBMkJPLElBQUQsSUFBVUEsSUFBSSxDQUFDdUMsU0FBTCxDQUFlUixHQUFmLEVBQW9CO0FBQUVwQyxNQUFBQSx3QkFBd0IsRUFBRSxJQUE1QjtBQUFrQ1EsTUFBQUEsT0FBTyxFQUFFLEtBQTNDO0FBQWtELFNBQUdwQztBQUFyRCxLQUFwQixDQUFwQyxDQUFQO0FBQ0g7O0FBU0QsUUFBTXFGLFdBQU4sQ0FBa0IzRCxLQUFsQixFQUF5QkMsSUFBekIsRUFBK0JpQixTQUEvQixFQUEwQzVDLE9BQTFDLEVBQW1EO0FBQy9DMkIsSUFBQUEsSUFBSSxHQUFHLEtBQUtrQixnQkFBTCxDQUFzQmxCLElBQXRCLENBQVA7O0FBQ0EsUUFBSSxLQUFLM0IsT0FBTCxDQUFhNkIsWUFBakIsRUFBK0I7QUFDM0IsV0FBS3JCLEdBQUwsQ0FBUyxTQUFULEVBQW9CLGlCQUFpQnNCLElBQUksQ0FBQ0MsU0FBTCxDQUFlO0FBQUNMLFFBQUFBLEtBQUQ7QUFBUVcsUUFBQUEsS0FBSyxFQUFFVixJQUFJLENBQUNXLE1BQXBCO0FBQTRCTSxRQUFBQSxTQUE1QjtBQUF1QzVDLFFBQUFBO0FBQXZDLE9BQWYsQ0FBckM7QUFDSDs7QUFFRCxXQUFPLEtBQUtnQyxhQUFMLENBQW1CTixLQUFuQixFQUEyQk8sSUFBRCxJQUFVQSxJQUFJLENBQUMyQyxVQUFMLENBQWdCaEMsU0FBaEIsRUFBMkJqQixJQUEzQixFQUFpQzNCLE9BQWpDLENBQXBDLENBQVA7QUFDSDs7QUFRRCxRQUFNc0YsV0FBTixDQUFrQjVELEtBQWxCLEVBQXlCQyxJQUF6QixFQUErQmlCLFNBQS9CLEVBQTBDNUMsT0FBMUMsRUFBbUQ7QUFDL0MsUUFBSSxLQUFLQSxPQUFMLENBQWE2QixZQUFqQixFQUErQjtBQUMzQixXQUFLckIsR0FBTCxDQUFTLFNBQVQsRUFBb0IsaUJBQWlCc0IsSUFBSSxDQUFDQyxTQUFMLENBQWU7QUFBQ0wsUUFBQUEsS0FBRDtBQUFRQyxRQUFBQSxJQUFSO0FBQWNpQixRQUFBQSxTQUFkO0FBQXlCNUMsUUFBQUE7QUFBekIsT0FBZixDQUFyQztBQUNIOztBQUVELFdBQU8sS0FBS2dDLGFBQUwsQ0FBbUJOLEtBQW5CLEVBQTJCTyxJQUFELElBQVVBLElBQUksQ0FBQ3NELFVBQUwsQ0FBZ0IzQyxTQUFoQixFQUEyQmpCLElBQTNCLEVBQWlDM0IsT0FBakMsQ0FBcEMsQ0FBUDtBQUNIOztBQVFELFFBQU13RixVQUFOLENBQWlCOUQsS0FBakIsRUFBd0JrQixTQUF4QixFQUFtQzVDLE9BQW5DLEVBQTRDO0FBQ3hDLFFBQUksS0FBS0EsT0FBTCxDQUFhNkIsWUFBakIsRUFBK0I7QUFDM0IsV0FBS3JCLEdBQUwsQ0FBUyxTQUFULEVBQW9CLGdCQUFnQnNCLElBQUksQ0FBQ0MsU0FBTCxDQUFlO0FBQUNMLFFBQUFBLEtBQUQ7QUFBUWtCLFFBQUFBLFNBQVI7QUFBbUI1QyxRQUFBQTtBQUFuQixPQUFmLENBQXBDO0FBQ0g7O0FBRUQsV0FBTyxLQUFLZ0MsYUFBTCxDQUFtQk4sS0FBbkIsRUFBMkJPLElBQUQsSUFBVUEsSUFBSSxDQUFDd0QsU0FBTCxDQUFlN0MsU0FBZixFQUEwQjVDLE9BQTFCLENBQXBDLENBQVA7QUFDSDs7QUFRRCxRQUFNMEYsV0FBTixDQUFrQmhFLEtBQWxCLEVBQXlCa0IsU0FBekIsRUFBb0M1QyxPQUFwQyxFQUE2QztBQUN6QyxRQUFJLEtBQUtBLE9BQUwsQ0FBYTZCLFlBQWpCLEVBQStCO0FBQzNCLFdBQUtyQixHQUFMLENBQVMsU0FBVCxFQUFvQixpQkFBaUJzQixJQUFJLENBQUNDLFNBQUwsQ0FBZTtBQUFDTCxRQUFBQSxLQUFEO0FBQVFrQixRQUFBQSxTQUFSO0FBQW1CNUMsUUFBQUE7QUFBbkIsT0FBZixDQUFyQztBQUNIOztBQUNELFdBQU8sS0FBS2dDLGFBQUwsQ0FBbUJOLEtBQW5CLEVBQTJCTyxJQUFELElBQVVBLElBQUksQ0FBQzBELFVBQUwsQ0FBZ0IvQyxTQUFoQixFQUEyQjVDLE9BQTNCLENBQXBDLENBQVA7QUFDSDs7QUFRRCxRQUFNNEYsa0JBQU4sQ0FBeUJsRSxLQUF6QixFQUFnQ0MsSUFBaEMsRUFBc0NpQixTQUF0QyxFQUFpRDVDLE9BQWpELEVBQTBEO0FBQ3RELFFBQUksS0FBS0EsT0FBTCxDQUFhNkIsWUFBakIsRUFBK0I7QUFDM0IsV0FBS3JCLEdBQUwsQ0FBUyxTQUFULEVBQW9CLHdCQUF3QnNCLElBQUksQ0FBQ0MsU0FBTCxDQUFlO0FBQUNMLFFBQUFBLEtBQUQ7QUFBUUMsUUFBQUEsSUFBUjtBQUFjM0IsUUFBQUE7QUFBZCxPQUFmLENBQTVDO0FBQ0g7O0FBQ0QsV0FBTyxLQUFLZ0MsYUFBTCxDQUFtQk4sS0FBbkIsRUFBMkJPLElBQUQsSUFBVUEsSUFBSSxDQUFDNEQsaUJBQUwsQ0FBdUJqRCxTQUF2QixFQUFrQ2pCLElBQWxDLEVBQXdDM0IsT0FBeEMsQ0FBcEMsQ0FBUDtBQUNIOztBQVFELFFBQU1pRCxpQkFBTixDQUF3QnZCLEtBQXhCLEVBQStCQyxJQUEvQixFQUFxQ2lCLFNBQXJDLEVBQWdENUMsT0FBaEQsRUFBeUQ7QUFDckQyQixJQUFBQSxJQUFJLEdBQUcsS0FBS2tCLGdCQUFMLENBQXNCbEIsSUFBdEIsQ0FBUDs7QUFDQSxRQUFJLEtBQUszQixPQUFMLENBQWE2QixZQUFqQixFQUErQjtBQUMzQixXQUFLckIsR0FBTCxDQUFTLFNBQVQsRUFBb0IsdUJBQXVCc0IsSUFBSSxDQUFDQyxTQUFMLENBQWU7QUFBQ0wsUUFBQUEsS0FBRDtBQUFRQyxRQUFBQSxJQUFSO0FBQWNpQixRQUFBQSxTQUFkO0FBQXlCNUMsUUFBQUE7QUFBekIsT0FBZixDQUEzQztBQUNIOztBQUNELFdBQU8sS0FBS2dDLGFBQUwsQ0FBbUJOLEtBQW5CLEVBQTJCTyxJQUFELElBQVVBLElBQUksQ0FBQzZELGdCQUFMLENBQXNCbEQsU0FBdEIsRUFBaUNqQixJQUFqQyxFQUF1QzNCLE9BQXZDLENBQXBDLENBQVA7QUFDSDs7QUFFRCxRQUFNK0YsaUJBQU4sQ0FBd0JyRSxLQUF4QixFQUErQmtCLFNBQS9CLEVBQTBDNUMsT0FBMUMsRUFBbUQ7QUFDL0MsUUFBSSxLQUFLQSxPQUFMLENBQWE2QixZQUFqQixFQUErQjtBQUMzQixXQUFLckIsR0FBTCxDQUFTLFNBQVQsRUFBb0IsdUJBQXVCc0IsSUFBSSxDQUFDQyxTQUFMLENBQWU7QUFBQ0wsUUFBQUEsS0FBRDtBQUFRa0IsUUFBQUEsU0FBUjtBQUFtQjVDLFFBQUFBO0FBQW5CLE9BQWYsQ0FBM0M7QUFDSDs7QUFDRCxXQUFPLEtBQUtnQyxhQUFMLENBQW1CTixLQUFuQixFQUEyQk8sSUFBRCxJQUFVQSxJQUFJLENBQUMrRCxnQkFBTCxDQUFzQnBELFNBQXRCLEVBQWlDNUMsT0FBakMsQ0FBcEMsQ0FBUDtBQUNIOztBQUVELFFBQU1pRyxRQUFOLENBQWV2RSxLQUFmLEVBQXNCa0IsU0FBdEIsRUFBaUM1QyxPQUFqQyxFQUEwQztBQUN0QyxRQUFJa0csWUFBWSxHQUFHLEVBQUMsR0FBR2xHO0FBQUosS0FBbkI7QUFDQSxRQUFJbUcsS0FBSjs7QUFFQSxRQUFJLENBQUNwSCxDQUFDLENBQUM4RSxPQUFGLENBQVVqQixTQUFWLENBQUwsRUFBMkI7QUFDdkIsVUFBSTtBQUFFd0QsUUFBQUEsV0FBRjtBQUFlQyxRQUFBQSxNQUFmO0FBQXVCLFdBQUc1QztBQUExQixVQUFxQ2IsU0FBekM7O0FBRUEsVUFBSXdELFdBQUosRUFBaUI7QUFDYkYsUUFBQUEsWUFBWSxDQUFDbkIsVUFBYixHQUEwQnFCLFdBQTFCO0FBQ0g7O0FBRURELE1BQUFBLEtBQUssR0FBRyxFQUFFLEdBQUcxQyxNQUFMO0FBQWEsV0FBRzRDO0FBQWhCLE9BQVI7QUFDSCxLQVJELE1BUU87QUFDSCxZQUFNLElBQUk3RyxlQUFKLENBQW9CLDZDQUFwQixDQUFOO0FBQ0g7O0FBRUQsUUFBSSxLQUFLUSxPQUFMLENBQWE2QixZQUFqQixFQUErQjtBQUMzQixXQUFLckIsR0FBTCxDQUFTLFNBQVQsRUFBb0IsY0FBY3NCLElBQUksQ0FBQ0MsU0FBTCxDQUFlO0FBQUNMLFFBQUFBLEtBQUQ7QUFBUWtCLFFBQUFBLFNBQVMsRUFBRXVELEtBQW5CO0FBQTBCbkcsUUFBQUEsT0FBTyxFQUFFa0c7QUFBbkMsT0FBZixDQUFsQztBQUNIOztBQUVELFdBQU8sS0FBS2xFLGFBQUwsQ0FBbUJOLEtBQW5CLEVBQTJCTyxJQUFELElBQVVBLElBQUksQ0FBQ3FFLE9BQUwsQ0FBYUgsS0FBYixFQUFvQkQsWUFBcEIsQ0FBcEMsQ0FBUDtBQUNIOztBQVFELFFBQU1oRyxLQUFOLENBQVl3QixLQUFaLEVBQW1Ca0IsU0FBbkIsRUFBOEI1QyxPQUE5QixFQUF1QztBQUNuQyxRQUFJa0csWUFBWSxHQUFHLEVBQUMsR0FBR2xHO0FBQUosS0FBbkI7QUFDQSxRQUFJbUcsS0FBSixFQUFXSSxpQkFBWDs7QUFFQSxRQUFJLENBQUN4SCxDQUFDLENBQUM4RSxPQUFGLENBQVVqQixTQUFWLENBQUwsRUFBMkI7QUFDdkIsVUFBSTtBQUFFd0QsUUFBQUEsV0FBRjtBQUFlSSxRQUFBQSxXQUFmO0FBQTRCQyxRQUFBQSxRQUE1QjtBQUFzQ0MsUUFBQUEsT0FBdEM7QUFBK0NDLFFBQUFBLE1BQS9DO0FBQXVETixRQUFBQSxNQUF2RDtBQUErRCxXQUFHNUM7QUFBbEUsVUFBNkViLFNBQWpGOztBQUVBLFVBQUl3RCxXQUFKLEVBQWlCO0FBQ2JGLFFBQUFBLFlBQVksQ0FBQ25CLFVBQWIsR0FBMEJxQixXQUExQjtBQUNIOztBQUVELFVBQUlLLFFBQUosRUFBYztBQUNWUCxRQUFBQSxZQUFZLENBQUNVLElBQWIsR0FBb0JILFFBQXBCO0FBQ0g7O0FBRUQsVUFBSUMsT0FBSixFQUFhO0FBQ1RSLFFBQUFBLFlBQVksQ0FBQ1csSUFBYixHQUFvQkgsT0FBcEI7QUFDSDs7QUFFRCxVQUFJQyxNQUFKLEVBQVk7QUFDUlQsUUFBQUEsWUFBWSxDQUFDWSxLQUFiLEdBQXFCSCxNQUFyQjtBQUNIOztBQUVEUixNQUFBQSxLQUFLLEdBQUcsRUFBRSxHQUFHMUMsTUFBTDtBQUFhLFdBQUc0QztBQUFoQixPQUFSO0FBQ0FFLE1BQUFBLGlCQUFpQixHQUFHQyxXQUFwQjtBQUNILEtBckJELE1BcUJPO0FBQ0hMLE1BQUFBLEtBQUssR0FBRyxFQUFSO0FBQ0FJLE1BQUFBLGlCQUFpQixHQUFHLEtBQXBCO0FBQ0g7O0FBRUQsUUFBSSxLQUFLdkcsT0FBTCxDQUFhNkIsWUFBakIsRUFBK0I7QUFDM0IsV0FBS3JCLEdBQUwsQ0FBUyxTQUFULEVBQW9CLFdBQVdzQixJQUFJLENBQUNDLFNBQUwsQ0FBZTtBQUFDTCxRQUFBQSxLQUFEO0FBQVFrQixRQUFBQSxTQUFTLEVBQUV1RCxLQUFuQjtBQUEwQm5HLFFBQUFBLE9BQU8sRUFBRWtHO0FBQW5DLE9BQWYsQ0FBL0I7QUFDSDs7QUFFRCxXQUFPLEtBQUtsRSxhQUFMLENBQW1CTixLQUFuQixFQUEwQixNQUFNTyxJQUFOLElBQWM7QUFDM0MsVUFBSStDLE1BQU0sR0FBRyxNQUFNL0MsSUFBSSxDQUFDNkMsSUFBTCxDQUFVcUIsS0FBVixFQUFpQkQsWUFBakIsRUFBK0I3RSxPQUEvQixFQUFuQjs7QUFFQSxVQUFJa0YsaUJBQUosRUFBdUI7QUFDbkIsWUFBSVEsVUFBVSxHQUFHLE1BQU05RSxJQUFJLENBQUM2QyxJQUFMLENBQVVxQixLQUFWLEVBQWlCOUQsS0FBakIsRUFBdkI7QUFDQSxlQUFPLENBQUUyQyxNQUFGLEVBQVUrQixVQUFWLENBQVA7QUFDSDs7QUFFRCxhQUFPL0IsTUFBUDtBQUNILEtBVE0sQ0FBUDtBQVVIOztBQUVELFFBQU1nQyxVQUFOLENBQWlCdEYsS0FBakIsRUFBd0J1RixRQUF4QixFQUFrQ2pILE9BQWxDLEVBQTJDO0FBQ3ZDLFFBQUksS0FBS0EsT0FBTCxDQUFhNkIsWUFBakIsRUFBK0I7QUFDM0IsV0FBS3JCLEdBQUwsQ0FBUyxTQUFULEVBQW9CLGdCQUFnQnNCLElBQUksQ0FBQ0MsU0FBTCxDQUFlO0FBQUNMLFFBQUFBLEtBQUQ7QUFBUXVGLFFBQUFBLFFBQVI7QUFBa0JqSCxRQUFBQTtBQUFsQixPQUFmLENBQXBDO0FBQ0g7O0FBQ0QsV0FBTyxLQUFLZ0MsYUFBTCxDQUFtQk4sS0FBbkIsRUFBMkJPLElBQUQsSUFBVUEsSUFBSSxDQUFDaUYsU0FBTCxDQUFlRCxRQUFmLEVBQXlCakgsT0FBekIsRUFBa0NxQixPQUFsQyxFQUFwQyxDQUFQO0FBQ0g7O0FBRUQsUUFBTThGLFNBQU4sQ0FBZ0J6RixLQUFoQixFQUF1QjBGLEtBQXZCLEVBQThCakIsS0FBOUIsRUFBcUNuRyxPQUFyQyxFQUE4QztBQUMxQyxRQUFJLEtBQUtBLE9BQUwsQ0FBYTZCLFlBQWpCLEVBQStCO0FBQzNCLFdBQUtyQixHQUFMLENBQVMsU0FBVCxFQUFvQixlQUFlc0IsSUFBSSxDQUFDQyxTQUFMLENBQWU7QUFBQ0wsUUFBQUEsS0FBRDtBQUFRMEYsUUFBQUEsS0FBUjtBQUFlakIsUUFBQUEsS0FBZjtBQUFzQm5HLFFBQUFBO0FBQXRCLE9BQWYsQ0FBbkM7QUFDSDs7QUFDRCxXQUFPLEtBQUtnQyxhQUFMLENBQW1CTixLQUFuQixFQUEyQk8sSUFBRCxJQUFVQSxJQUFJLENBQUNvRixRQUFMLENBQWNELEtBQWQsRUFBcUJqQixLQUFyQixFQUE0Qm5HLE9BQTVCLENBQXBDLENBQVA7QUFDSDs7QUFFRCxRQUFNZ0MsYUFBTixDQUFvQk4sS0FBcEIsRUFBMkI0RixRQUEzQixFQUFxQztBQUNqQyxXQUFPLEtBQUtwRyxRQUFMLENBQWNMLEVBQUUsSUFBSXlHLFFBQVEsQ0FBQ3pHLEVBQUUsQ0FBQzBHLFVBQUgsQ0FBYzdGLEtBQWQsQ0FBRCxDQUE1QixDQUFQO0FBQ0g7O0FBRURtQixFQUFBQSxnQkFBZ0IsQ0FBQzBCLE1BQUQsRUFBUztBQUNyQixRQUFJUCxHQUFHLEdBQUdqRixDQUFDLENBQUN1RixJQUFGLENBQU9DLE1BQVAsRUFBZTVFLFNBQWYsQ0FBVjs7QUFDQSxRQUFJOEQsTUFBTSxHQUFHMUUsQ0FBQyxDQUFDeUksSUFBRixDQUFPakQsTUFBUCxFQUFlNUUsU0FBZixDQUFiOztBQUVBLFFBQUlxRSxHQUFHLENBQUNOLElBQVIsRUFBYztBQUNWTSxNQUFBQSxHQUFHLENBQUNOLElBQUosR0FBVyxFQUFFLEdBQUdNLEdBQUcsQ0FBQ04sSUFBVDtBQUFlLFdBQUdEO0FBQWxCLE9BQVg7QUFDSCxLQUZELE1BRU8sSUFBSSxDQUFDMUUsQ0FBQyxDQUFDOEUsT0FBRixDQUFVSixNQUFWLENBQUwsRUFBd0I7QUFDM0JPLE1BQUFBLEdBQUcsQ0FBQ04sSUFBSixHQUFXRCxNQUFYO0FBQ0g7O0FBRUQsV0FBT08sR0FBUDtBQUNIOztBQTVib0M7O0FBK2J6Q25FLGdCQUFnQixDQUFDNEgsU0FBakIsR0FBNkJ0SSxPQUE3QjtBQUVBdUksTUFBTSxDQUFDQyxPQUFQLEdBQWlCOUgsZ0JBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgeyBfLCB3YWl0VW50aWxfIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyB0cnlSZXF1aXJlIH0gPSByZXF1aXJlKCcuLi8uLi91dGlscy9saWInKTtcbmNvbnN0IG1vbmdvZGIgPSB0cnlSZXF1aXJlKCdtb25nb2RiJyk7XG5jb25zdCB7IE1vbmdvQ2xpZW50LCBHcmlkRlNCdWNrZXQgfSA9IG1vbmdvZGI7XG5jb25zdCBDb25uZWN0b3IgPSByZXF1aXJlKCcuLi8uLi9Db25uZWN0b3InKTtcbmNvbnN0IEdlbmVyYXRvcnMgPSByZXF1aXJlKCcuLi8uLi9HZW5lcmF0b3JzJyk7XG5jb25zdCB7IEludmFsaWRBcmd1bWVudCB9ID0gcmVxdWlyZSgnLi4vLi4vdXRpbHMvRXJyb3JzJyk7XG5cbmNvbnN0IFVwZGF0ZU9wc0ZpZWxkID0gWyAnJGN1cnJlbnREYXRlJywgJyRpbmMnLCAnJG1pbicsICckbWF4JywgJyRtdWwnLCAnJHJlbmFtZScsICckc2V0JywgJyRzZXRPbkluc2VydCcsICckdW5zZXQnIF07XG5jb25zdCBVcGRhdGVPcHNBcnJheSA9IFsgJyRhZGRUb1NldCcsICckcG9wJywgJyRwdWxsJywgJyRwdXNoJywgJyRwdWxsQWxsJyBdO1xuY29uc3QgVXBkYXRlT3BzID0gVXBkYXRlT3BzRmllbGQuY29uY2F0KFVwZGF0ZU9wc0FycmF5KTtcblxuLyoqXG4gKiBNb25nb2RiIGRhdGEgc3RvcmFnZSBjb25uZWN0b3IuXG4gKiBAY2xhc3NcbiAqIEBleHRlbmRzIENvbm5lY3RvclxuICovXG5jbGFzcyBNb25nb2RiQ29ubmVjdG9yIGV4dGVuZHMgQ29ubmVjdG9yIHtcbiAgICAvKiogICAgICAgICAgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgXG4gICAgICogQHByb3BlcnR5IHtib29sZWFufSBbb3B0aW9ucy51c2VQcmVwYXJlZFN0YXRlbWVudF0gLSBcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3Rvcihjb25uZWN0aW9uU3RyaW5nLCBvcHRpb25zKSB7ICAgICAgICBcbiAgICAgICAgc3VwZXIoJ21vbmdvZGInLCBjb25uZWN0aW9uU3RyaW5nLCBvcHRpb25zKTsgICAgXG4gICAgICAgIFxuICAgICAgICB0aGlzLmxvY2tlckZpZWxkID0gdGhpcy5vcHRpb25zLmxvY2tlckZpZWxkIHx8ICdfX2xvY2tfXyc7XG4gICAgfVxuXG4gICAgZmluZEFsbF8gPSB0aGlzLmZpbmRfO1xuXG4gICAgLyoqXG4gICAgICogQ2xvc2UgYWxsIGNvbm5lY3Rpb24gaW5pdGlhdGVkIGJ5IHRoaXMgY29ubmVjdG9yLlxuICAgICAqL1xuICAgIGFzeW5jIGVuZF8oKSB7XG4gICAgICAgIGlmICh0aGlzLmNsaWVudCAmJiB0aGlzLmNsaWVudC5pc0Nvbm5lY3RlZCgpKSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmNsaWVudC5jbG9zZSgpO1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBgbW9uZ29kYjogc3VjY2Vzc2Z1bGx5IGRpc2Nvbm5lY3RlZCBmcm9tIFwiJHt0aGlzLmdldENvbm5lY3Rpb25TdHJpbmdXaXRob3V0Q3JlZGVudGlhbCgpfVwiLmApOyAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgfVxuXG4gICAgICAgIGRlbGV0ZSB0aGlzLmNsaWVudDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBkYXRhYmFzZSBjb25uZWN0aW9uIGJhc2VkIG9uIHRoZSBkZWZhdWx0IGNvbm5lY3Rpb24gc3RyaW5nIG9mIHRoZSBjb25uZWN0b3IgYW5kIGdpdmVuIG9wdGlvbnMuICAgICBcbiAgICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdIC0gRXh0cmEgb3B0aW9ucyBmb3IgdGhlIGNvbm5lY3Rpb24sIG9wdGlvbmFsLlxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbH0gW29wdGlvbnMubXVsdGlwbGVTdGF0ZW1lbnRzPWZhbHNlXSAtIEFsbG93IHJ1bm5pbmcgbXVsdGlwbGUgc3RhdGVtZW50cyBhdCBhIHRpbWUuXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbb3B0aW9ucy5jcmVhdGVEYXRhYmFzZT1mYWxzZV0gLSBGbGFnIHRvIHVzZWQgd2hlbiBjcmVhdGluZyBhIGRhdGFiYXNlLlxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjxEYj59XG4gICAgICovXG4gICAgYXN5bmMgY29ubmVjdF8ob3B0aW9ucykge1xuICAgICAgICBpZiAoIXRoaXMuY2xpZW50IHx8ICF0aGlzLmNsaWVudC5pc0Nvbm5lY3RlZCgpKSB7XG4gICAgICAgICAgICBsZXQgY2xpZW50ID0gbmV3IE1vbmdvQ2xpZW50KHRoaXMuY29ubmVjdGlvblN0cmluZywge3VzZU5ld1VybFBhcnNlcjogdHJ1ZX0pO1xuICAgICAgICAgICAgdGhpcy5jbGllbnQgPSBhd2FpdCBjbGllbnQuY29ubmVjdCgpOyBcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYG1vbmdvZGI6IHN1Y2Nlc3NmdWxseSBjb25uZWN0ZWQgdG8gXCIke3RoaXMuZ2V0Q29ubmVjdGlvblN0cmluZ1dpdGhvdXRDcmVkZW50aWFsKCl9XCIuYCk7ICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICB9ICAgICAgIFxuXG4gICAgICAgIHJldHVybiB0aGlzLmNsaWVudC5kYih0aGlzLmRhdGFiYXNlKTtcbiAgICB9XG4gICAgXG4gICAgLyoqXG4gICAgICogQ2xvc2UgYSBkYXRhYmFzZSBjb25uZWN0aW9uLlxuICAgICAqIEBwYXJhbSB7RGJ9IGNvbm4gLSBNeVNRTCBjb25uZWN0aW9uLlxuICAgICAqL1xuICAgIGFzeW5jIGRpc2Nvbm5lY3RfKGNvbm4pIHtcbiAgICB9XG5cbiAgICBhc3luYyBwaW5nXygpIHsgIFxuICAgICAgICByZXR1cm4gdGhpcy5leGVjdXRlXyhkYiA9PiB7XG4gICAgICAgICAgICByZXR1cm4gZGIubGlzdENvbGxlY3Rpb25zKG51bGwsIHsgbmFtZU9ubHk6IHRydWUgfSkudG9BcnJheSgpO1xuICAgICAgICB9KTsgIFxuICAgIH1cblxuICAgIGFzeW5jIGV4ZWN1dGVfKGRiRXhlY3V0b3IpIHtcbiAgICAgICAgbGV0IGRiO1xuICAgIFxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgZGIgPSBhd2FpdCB0aGlzLmNvbm5lY3RfKCk7XG5cbiAgICAgICAgICAgIHJldHVybiBhd2FpdCBkYkV4ZWN1dG9yKGRiKTtcbiAgICAgICAgfSBjYXRjaChlcnIpIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgIGRiICYmIGF3YWl0IHRoaXMuZGlzY29ubmVjdF8oZGIpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zXSAtIE9wdGlvbmFsIHNldHRpbmdzLlxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5idWNrZXROYW1lPSdmcyddIC0gVGhlICdmaWxlcycgYW5kICdjaHVua3MnIGNvbGxlY3Rpb25zIHdpbGwgYmUgcHJlZml4ZWQgd2l0aCB0aGUgYnVja2V0IG5hbWUgZm9sbG93ZWQgYnkgYSBkb3QuXG4gICAgICogQHByb3BlcnR5IHtudW1iZXJ9IFtvcHRpb25zLmNodW5rU2l6ZUJ5dGVzXSAtIE51bWJlciBvZiBieXRlcyBzdG9yZWQgaW4gZWFjaCBjaHVuay4gRGVmYXVsdHMgdG8gMjU1S0JcbiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gW29wdGlvbnMud3JpdGVDb25jZXJuXVxuICAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBbb3B0aW9ucy5yZWFkUHJlZmVyZW5jZV1cbiAgICAgKi9cbiAgICBhc3luYyBjcmVhdGVHcmlkRlNCdWNrZXRfKG9wdGlvbnMpIHtcbiAgICAgICAgbGV0IGRiID0gYXdhaXQgdGhpcy5jb25uZWN0XygpO1xuXG4gICAgICAgIHJldHVybiBuZXcgR3JpZEZTQnVja2V0KGRiLCBvcHRpb25zKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBuZXcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgaW5zZXJ0T25lXyhtb2RlbCwgZGF0YSwgb3B0aW9ucykge1xuICAgICAgICBvcHRpb25zID0geyBieXBhc3NEb2N1bWVudFZhbGlkYXRpb246IHRydWUsIC4uLm9wdGlvbnMgfTtcblxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ1N0YXRlbWVudCkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAnaW5zZXJ0T25lOiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBkYXRhLCBvcHRpb25zfSkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmluc2VydE9uZShkYXRhLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGFuIGFycmF5IG9mIG5ldyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7YXJyYXl9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGluc2VydE1hbnlfKG1vZGVsLCBkYXRhLCBvcHRpb25zKSB7XG4gICAgICAgIG9wdGlvbnMgPSB7IGJ5cGFzc0RvY3VtZW50VmFsaWRhdGlvbjogdHJ1ZSwgb3JkZXJlZDogZmFsc2UsIC4uLm9wdGlvbnMgfTtcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ2luc2VydE1hbnk6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIGNvdW50OiBkYXRhLmxlbmd0aCwgb3B0aW9uc30pKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5pbnNlcnRNYW55KGRhdGEsIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICBhc3luYyBpbnNlcnRPbmVJZk5vdEV4aXN0Xyhtb2RlbCwgZGF0YSwgb3B0aW9ucykge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuaW5zZXJ0T25lXyhtb2RlbCwgZGF0YSwgb3B0aW9ucylcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGlmIChlcnJvci5jb2RlID09PSAxMTAwMCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgYW4gZXhpc3RpbmcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgdXBkYXRlT25lXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7IFxuICAgICAgICBkYXRhID0gdGhpcy5fdHJhbnNsYXRlVXBkYXRlKGRhdGEpO1xuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ1N0YXRlbWVudCkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAndXBkYXRlT25lOiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnN9KSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwudXBkYXRlT25lKGNvbmRpdGlvbiwgZGF0YSwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIGFzeW5jIHVwZGF0ZU9uZUFuZFJldHVybl8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykgeyAgICAgICAgICAgIFxuICAgICAgICBsZXQgcmV0ID0gYXdhaXQgdGhpcy5maW5kT25lQW5kVXBkYXRlXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCB7IC4uLm9wdGlvbnMsIHVwc2VydDogZmFsc2UsIHJldHVybk9yaWdpbmFsOiBmYWxzZSB9KTtcbiAgICAgICAgcmV0dXJuIHJldCAmJiByZXQudmFsdWU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIGFuIGV4aXN0aW5nIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhT25JbnNlcnQgLSBTaGFyZWQgZGF0YSBvbiBpbnNlcnRcbiAgICAgKi9cbiAgICBhc3luYyB1cHNlcnRPbmVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMsIGRhdGFPbkluc2VydCkgeyBcbiAgICAgICAgbGV0IHRyYW5zID0gdGhpcy5fdHJhbnNsYXRlVXBkYXRlKGRhdGEpO1xuICAgICAgICBsZXQgeyBfaWQsIC4uLm90aGVycyB9ID0gdHJhbnMuJHNldCB8fCB7fTsgXG4gICAgICAgIGlmICghXy5pc05pbChfaWQpKSB7XG4gICAgICAgICAgICB0cmFucy4kc2V0ID0gb3RoZXJzO1xuICAgICAgICAgICAgdHJhbnMuJHNldE9uSW5zZXJ0ID0geyBfaWQgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghXy5pc0VtcHR5KGRhdGFPbkluc2VydCkpIHtcbiAgICAgICAgICAgIHRyYW5zLiRzZXRPbkluc2VydCA9IHsgLi4udHJhbnMuJHNldE9uSW5zZXJ0LCAuLi5kYXRhT25JbnNlcnQgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIG9wdGlvbnMgPSB7IC4uLm9wdGlvbnMsIHVwc2VydDogdHJ1ZSB9O1xuXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICd1cHNlcnRPbmU6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIGRhdGE6IHRyYW5zLCBjb25kaXRpb24sIG9wdGlvbnN9KSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC51cGRhdGVPbmUoY29uZGl0aW9uLCB0cmFucywgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZSBtYW55IGVudGl0aWVzLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSAtIEFycmF5IG9mIHJlY29yZCB3aXRoIF9pZFxuICAgICAqIEBwYXJhbSB7YXJyYXl9IHVuaXF1ZUtleXMgLSBVbmlxdWUga2V5cyBpbiB0aGUgZGF0YSByZWNvcmQgdXNlZCBhcyBmaWx0ZXJcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGFPbkluc2VydCAtIFNoYXJlZCBkYXRhIG9uIGluc2VydFxuICAgICAqL1xuICAgIGFzeW5jIHVwc2VydE1hbnlfKG1vZGVsLCBkYXRhLCB1bmlxdWVLZXlzLCBvcHRpb25zLCBkYXRhT25JbnNlcnQpIHsgXG4gICAgICAgIGxldCBvcHMgPSBkYXRhLm1hcChyZWNvcmQgPT4ge1xuICAgICAgICAgICAgbGV0IHsgX2lkLCAuLi51cGRhdGVEYXRhIH0gPSByZWNvcmQ7XG5cbiAgICAgICAgICAgIGxldCB1cGRhdGVPcCA9IHRoaXMuX3RyYW5zbGF0ZVVwZGF0ZSh1cGRhdGVEYXRhKTtcblxuICAgICAgICAgICAgaWYgKF9pZCkge1xuICAgICAgICAgICAgICAgIHVwZGF0ZU9wLiRzZXRPbkluc2VydCA9IHsgX2lkLCAuLi5kYXRhT25JbnNlcnQgfTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoIV8uaXNFbXB0eShkYXRhT25JbnNlcnQpKSB7XG4gICAgICAgICAgICAgICAgdXBkYXRlT3AuJHNldE9uSW5zZXJ0ID0gZGF0YU9uSW5zZXJ0O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIHVwZGF0ZU9uZTogeyBmaWx0ZXI6IHsgLi4uXy5waWNrKHJlY29yZCwgdW5pcXVlS2V5cykgfSwgdXBkYXRlOiB1cGRhdGVPcCwgdXBzZXJ0OiB0cnVlIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgIH0pO1xuXG4gICAgICAgIG9wdGlvbnMgPSB7IGJ5cGFzc0RvY3VtZW50VmFsaWRhdGlvbjogdHJ1ZSwgb3JkZXJlZDogZmFsc2UsIC4uLm9wdGlvbnMgfTtcblxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ1N0YXRlbWVudCkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAnYnVsa1dyaXRlOiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBjb3VudDogb3BzLmxlbmd0aCwgb3B0aW9uc30pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmJ1bGtXcml0ZShvcHMsIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICBhc3luYyB1cGRhdGVNYW55QW5kUmV0dXJuXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7ICAgICAgICBcbiAgICAgICAgbGV0IGxvY2tlcklkID0gR2VuZXJhdG9ycy5zaG9ydGlkKCk7XG5cbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ3VwZGF0ZU1hbnkrZmluZCt1cGRhdGVNYW55OiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBjb3VudDogZGF0YS5sZW5ndGgsIGNvbmRpdGlvbiwgb3B0aW9uc30pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIGFzeW5jIChjb2xsKSA9PiB7XG4gICAgICAgICAgICAvLzEudXBkYXRlIGFuZCBzZXQgbG9ja2VyXG4gICAgICAgICAgICBsZXQgcmV0ID0gYXdhaXQgY29sbC51cGRhdGVNYW55KFxuICAgICAgICAgICAgICAgIHsgLi4uY29uZGl0aW9uLCBbdGhpcy5sb2NrZXJGaWVsZF06IHsgJGV4aXN0czogZmFsc2UgfSB9LCAvLyBmb3IgYWxsIG5vbi1sb2NrZWRcbiAgICAgICAgICAgICAgICB7ICRzZXQ6IHsgLi4uZGF0YSwgW3RoaXMubG9ja2VyRmllbGRdOiBsb2NrZXJJZCB9IH0sIC8vIGxvY2sgaXQgXG4gICAgICAgICAgICAgICAgeyAuLi5vcHRpb25zLCB1cHNlcnQ6IGZhbHNlIH0gKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAvLzIucmV0dXJuIGFsbCBsb2NrZWQgcmVjb3Jkc1xuICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCBjb2xsLmZpbmQoeyBbdGhpcy5sb2NrZXJGaWVsZF06IGxvY2tlcklkIH0sIHsgcHJvamVjdGlvbjogeyBbdGhpcy5sb2NrZXJGaWVsZF06IDAgfSB9KS50b0FycmF5KCk7IC8vIHJldHVybiBhbGwgbG9ja2VkXG4gICAgICAgICAgICB9IGZpbmFsbHkgeyAgICBcbiAgICAgICAgICAgICAgICAvLzMucmVtb3ZlIGxvY2tlcnNcbiAgICAgICAgICAgICAgICBpZiAocmV0LnJlc3VsdC5uTW9kaWZpZWQgPiAwKSB7IC8vIHVubG9ja1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCBjb2xsLnVwZGF0ZU1hbnkoeyBbdGhpcy5sb2NrZXJGaWVsZF06IGxvY2tlcklkIH0sIHsgJHVuc2V0OiB7IFt0aGlzLmxvY2tlckZpZWxkXTogXCJcIiB9IH0sIHsgdXBzZXJ0OiBmYWxzZSB9KTsgICAgXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTsgICAgICAgICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBJbnNlcnQgbWFueSBlbnRpdGllcyBpZiBub3QgZXhpc3QuXG4gICAgICogQHBhcmFtIHsqfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0geyp9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSB1bmlxdWVLZXlzIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBpbnNlcnRNYW55SWZOb3RFeGlzdF8obW9kZWwsIGRhdGEsIHVuaXF1ZUtleXMsIG9wdGlvbnMpIHtcbiAgICAgICAgY29uc29sZS5sb2coJ2J1Z2d5OiB0b2ZpeCcpO1xuICAgICAgICBsZXQgb3BzID0gZGF0YS5tYXAocmVjb3JkID0+ICh7XG4gICAgICAgICAgICB1cGRhdGVPbmU6IHsgZmlsdGVyOiB7IC4uLl8ucGljayhyZWNvcmQsIHVuaXF1ZUtleXMpIH0sIHVwZGF0ZTogeyAkc2V0T25JbnNlcnQ6IHJlY29yZCB9LCB1cHNlcnQ6IHRydWUgfVxuICAgICAgICB9KSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuYnVsa1dyaXRlKG9wcywgeyBieXBhc3NEb2N1bWVudFZhbGlkYXRpb246IHRydWUsIG9yZGVyZWQ6IGZhbHNlLCAuLi5vcHRpb25zIH0pKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgbXVsdGlwbGUgZG9jdW1lbnRzLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0geyp9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIHVwZGF0ZU1hbnlfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgXG4gICAgICAgIGRhdGEgPSB0aGlzLl90cmFuc2xhdGVVcGRhdGUoZGF0YSk7XG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICd1cGRhdGVNYW55OiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBjb3VudDogZGF0YS5sZW5ndGgsIGNvbmRpdGlvbiwgb3B0aW9uc30pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLnVwZGF0ZU1hbnkoY29uZGl0aW9uLCBkYXRhLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVwbGFjZSBhbiBleGlzdGluZyBlbnRpdHkgb3IgY3JlYXRlIGEgbmV3IG9uZS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIHJlcGxhY2VPbmVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ3JlcGxhY2VPbmU6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9uc30pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLnJlcGxhY2VPbmUoY29uZGl0aW9uLCBkYXRhLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlIGFuIGV4aXN0aW5nIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGRlbGV0ZU9uZV8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ1N0YXRlbWVudCkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAnZGVsZXRlT25lOiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBjb25kaXRpb24sIG9wdGlvbnN9KSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5kZWxldGVPbmUoY29uZGl0aW9uLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlIGFuIGV4aXN0aW5nIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGRlbGV0ZU1hbnlfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ2RlbGV0ZU1hbnk6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9uc30pKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5kZWxldGVNYW55KGNvbmRpdGlvbiwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlcGxhY2UgKGluc2VydCBvciB1cGRhdGUgZm9yIGV4c2lzdGluZykgYW4gZW50aXR5IGFuZCByZXR1cm4gb3JpZ2luYWwgcmVjb3JkLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgZmluZE9uZUFuZFJlcGxhY2VfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ2ZpbmRPbmVBbmRSZXBsYWNlOiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBkYXRhLCBvcHRpb25zfSkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmZpbmRPbmVBbmRSZXBsYWNlKGNvbmRpdGlvbiwgZGF0YSwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEZpbmQgYSBkb2N1bWVudCBhbmQgdXBkYXRlIGl0IGluIG9uZSBhdG9taWMgb3BlcmF0aW9uLiBSZXF1aXJlcyBhIHdyaXRlIGxvY2sgZm9yIHRoZSBkdXJhdGlvbiBvZiB0aGUgb3BlcmF0aW9uLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgZmluZE9uZUFuZFVwZGF0ZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykgeyAgICAgXG4gICAgICAgIGRhdGEgPSB0aGlzLl90cmFuc2xhdGVVcGRhdGUoZGF0YSk7XG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdmaW5kT25lQW5kVXBkYXRlOiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnN9KSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZmluZE9uZUFuZFVwZGF0ZShjb25kaXRpb24sIGRhdGEsIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICBhc3luYyBmaW5kT25lQW5kRGVsZXRlXyhtb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdmaW5kT25lQW5kRGVsZXRlOiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBjb25kaXRpb24sIG9wdGlvbnN9KSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZmluZE9uZUFuZERlbGV0ZShjb25kaXRpb24sIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICBhc3luYyBmaW5kT25lXyhtb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIGxldCBxdWVyeU9wdGlvbnMgPSB7Li4ub3B0aW9uc307XG4gICAgICAgIGxldCBxdWVyeTtcblxuICAgICAgICBpZiAoIV8uaXNFbXB0eShjb25kaXRpb24pKSB7XG4gICAgICAgICAgICBsZXQgeyAkcHJvamVjdGlvbiwgJHF1ZXJ5LCAuLi5vdGhlcnMgfSA9IGNvbmRpdGlvbjtcblxuICAgICAgICAgICAgaWYgKCRwcm9qZWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLnByb2plY3Rpb24gPSAkcHJvamVjdGlvbjsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHF1ZXJ5ID0geyAuLi5vdGhlcnMsIC4uLiRxdWVyeSB9O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRBcmd1bWVudCgnZmluZE9uZSByZXF1aXJlcyBub24tZW1wdHkgcXVlcnkgY29uZGl0aW9uLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ2ZpbmRPbmU6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIGNvbmRpdGlvbjogcXVlcnksIG9wdGlvbnM6IHF1ZXJ5T3B0aW9uc30pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmZpbmRPbmUocXVlcnksIHF1ZXJ5T3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFBlcmZvcm0gc2VsZWN0IG9wZXJhdGlvbi5cbiAgICAgKiBAcGFyYW0geyp9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBmaW5kXyhtb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIGxldCBxdWVyeU9wdGlvbnMgPSB7Li4ub3B0aW9uc307XG4gICAgICAgIGxldCBxdWVyeSwgcmVxdWlyZVRvdGFsQ291bnQ7XG5cbiAgICAgICAgaWYgKCFfLmlzRW1wdHkoY29uZGl0aW9uKSkge1xuICAgICAgICAgICAgbGV0IHsgJHByb2plY3Rpb24sICR0b3RhbENvdW50LCAkb3JkZXJCeSwgJG9mZnNldCwgJGxpbWl0LCAkcXVlcnksIC4uLm90aGVycyB9ID0gY29uZGl0aW9uO1xuXG4gICAgICAgICAgICBpZiAoJHByb2plY3Rpb24pIHtcbiAgICAgICAgICAgICAgICBxdWVyeU9wdGlvbnMucHJvamVjdGlvbiA9ICRwcm9qZWN0aW9uOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCRvcmRlckJ5KSB7XG4gICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLnNvcnQgPSAkb3JkZXJCeTsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICgkb2Zmc2V0KSB7XG4gICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLnNraXAgPSAkb2Zmc2V0OyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCRsaW1pdCkge1xuICAgICAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucy5saW1pdCA9ICRsaW1pdDsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHF1ZXJ5ID0geyAuLi5vdGhlcnMsIC4uLiRxdWVyeSB9O1xuICAgICAgICAgICAgcmVxdWlyZVRvdGFsQ291bnQgPSAkdG90YWxDb3VudDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHF1ZXJ5ID0ge307XG4gICAgICAgICAgICByZXF1aXJlVG90YWxDb3VudCA9IGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ2ZpbmQ6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIGNvbmRpdGlvbjogcXVlcnksIG9wdGlvbnM6IHF1ZXJ5T3B0aW9uc30pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIGFzeW5jIGNvbGwgPT4geyAgICAgICAgICAgIFxuICAgICAgICAgICAgbGV0IHJlc3VsdCA9IGF3YWl0IGNvbGwuZmluZChxdWVyeSwgcXVlcnlPcHRpb25zKS50b0FycmF5KCk7XG5cbiAgICAgICAgICAgIGlmIChyZXF1aXJlVG90YWxDb3VudCkge1xuICAgICAgICAgICAgICAgIGxldCB0b3RhbENvdW50ID0gYXdhaXQgY29sbC5maW5kKHF1ZXJ5KS5jb3VudCgpO1xuICAgICAgICAgICAgICAgIHJldHVybiBbIHJlc3VsdCwgdG90YWxDb3VudCBdO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9KTtcbiAgICB9ICAgXG5cbiAgICBhc3luYyBhZ2dyZWdhdGVfKG1vZGVsLCBwaXBlbGluZSwgb3B0aW9ucykgeyAgICAgICAgXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdhZ2dyZWdhdGU6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIHBpcGVsaW5lLCBvcHRpb25zfSkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmFnZ3JlZ2F0ZShwaXBlbGluZSwgb3B0aW9ucykudG9BcnJheSgpKTtcbiAgICB9XG5cbiAgICBhc3luYyBkaXN0aW5jdF8obW9kZWwsIGZpZWxkLCBxdWVyeSwgb3B0aW9ucykgeyAgICAgICAgXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdkaXN0aW5jdDogJyArIEpTT04uc3RyaW5naWZ5KHttb2RlbCwgZmllbGQsIHF1ZXJ5LCBvcHRpb25zfSkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmRpc3RpbmN0KGZpZWxkLCBxdWVyeSwgb3B0aW9ucykpO1xuICAgIH0gICAgXG5cbiAgICBhc3luYyBvbkNvbGxlY3Rpb25fKG1vZGVsLCBleGVjdXRvcikge1xuICAgICAgICByZXR1cm4gdGhpcy5leGVjdXRlXyhkYiA9PiBleGVjdXRvcihkYi5jb2xsZWN0aW9uKG1vZGVsKSkpO1xuICAgIH1cblxuICAgIF90cmFuc2xhdGVVcGRhdGUodXBkYXRlKSB7XG4gICAgICAgIGxldCBvcHMgPSBfLnBpY2sodXBkYXRlLCBVcGRhdGVPcHMpO1xuICAgICAgICBsZXQgb3RoZXJzID0gXy5vbWl0KHVwZGF0ZSwgVXBkYXRlT3BzKTtcblxuICAgICAgICBpZiAob3BzLiRzZXQpIHtcbiAgICAgICAgICAgIG9wcy4kc2V0ID0geyAuLi5vcHMuJHNldCwgLi4ub3RoZXJzIH07XG4gICAgICAgIH0gZWxzZSBpZiAoIV8uaXNFbXB0eShvdGhlcnMpKSB7XG4gICAgICAgICAgICBvcHMuJHNldCA9IG90aGVycztcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBvcHM7XG4gICAgfVxufVxuXG5Nb25nb2RiQ29ubmVjdG9yLmRyaXZlckxpYiA9IG1vbmdvZGI7XG5cbm1vZHVsZS5leHBvcnRzID0gTW9uZ29kYkNvbm5lY3RvcjsiXX0=