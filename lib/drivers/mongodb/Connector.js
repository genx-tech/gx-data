"use strict";

require("source-map-support/register");

const {
  _,
  waitUntil_
} = require('rk-utils');

const {
  tryRequire
} = require('../../utils/lib');

const mongodb = tryRequire('mongodb');
const {
  MongoClient,
  GridFSBucket
} = mongodb;

const Connector = require('../../Connector');

const Generators = require('../../Generators');

const UpdateOpsField = ['$currentDate', '$inc', '$min', '$max', '$mul', '$rename', '$set', '$setOnInsert', '$unset'];
const UpdateOpsArray = ['$addToSet', '$pop', '$pull', '$push', '$pullAll'];
const UpdateOps = UpdateOpsField.concat(UpdateOpsArray);

class MongodbConnector extends Connector {
  constructor(connectionString, options) {
    super('mongodb', connectionString, options);
    this.findAll_ = this.find_;
    this.lockerField = this.options.lockerField || '__lock__';
  }

  async end_() {
    if (this.client && this.client.isConnected()) {
      await this.client.close();
      this.log('verbose', `mongodb: successfully disconnected from "${this.getConnectionStringWithoutCredential()}".`);
    }

    delete this.client;
  }

  async connect_(options) {
    if (!this.client || !this.client.isConnected()) {
      let client = new MongoClient(this.connectionString, {
        useNewUrlParser: true
      });
      this.client = await client.connect();
      this.log('verbose', `mongodb: successfully connected to "${this.getConnectionStringWithoutCredential()}".`);
    }

    return this.client.db(this.database);
  }

  async disconnect_(conn) {}

  async ping_() {
    return this.execute_(db => {
      return db.listCollections(null, {
        nameOnly: true
      }).toArray();
    });
  }

  async execute_(dbExecutor) {
    let db;

    try {
      db = await this.connect_();
      return await dbExecutor(db);
    } catch (err) {
      throw err;
    } finally {
      db && (await this.disconnect_(db));
    }
  }

  async createGridFSBucket_(options) {
    let db = await this.connect_();
    return new GridFSBucket(db, options);
  }

  async insertOne_(model, data, options) {
    return this.onCollection_(model, coll => coll.insertOne(data, {
      bypassDocumentValidation: true,
      ...options
    }));
  }

  async insertMany_(model, data, options) {
    return this.onCollection_(model, coll => coll.insertMany(data, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async insertOneIfNotExist_(model, data, options) {
    try {
      return await this.insertOne_(model, data, options);
    } catch (error) {
      if (error.code === 11000) {
        return false;
      }

      throw error;
    }
  }

  async findOneAndReplace_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndReplace(condition, data, options));
  }

  async findOneAndUpdate_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndUpdate(condition, this._translateUpdate(data), options));
  }

  async findOneAndDelete_(model, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndDelete(condition, options));
  }

  async findOne_(model, condition, options) {
    return this.onCollection_(model, coll => coll.findOne(condition, options));
  }

  async updateOne_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.updateOne(condition, this._translateUpdate(data), options));
  }

  async updateOneAndReturn_(model, data, condition, options) {
    let ret = await this.findOneAndUpdate_(model, data, condition, { ...options,
      upsert: false,
      returnOriginal: false
    });
    return ret && ret.value;
  }

  async upsertOne_(model, data, condition, options) {
    let trans = this._translateUpdate(data);

    let {
      _id,
      ...others
    } = trans.$set;

    if (!_.isNil(_id)) {
      trans.$set = others;
      trans.$setOnInsert = {
        _id
      };
    }

    return this.onCollection_(model, coll => coll.updateOne(condition, trans, { ...options,
      upsert: true
    }));
  }

  async upsertMany_(model, data, uniqueKeys, options) {
    let ops = data.map(record => {
      let {
        _id,
        ...updateData
      } = record;
      let updateOp = {
        $set: updateData
      };

      if (_id) {
        updateOp.$setOnInsert = {
          _id
        };
      }

      return {
        updateOne: {
          filter: { ..._.pick(record, uniqueKeys)
          },
          update: updateOp,
          upsert: true
        }
      };
    });
    return this.onCollection_(model, coll => coll.bulkWrite(ops, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async updateManyAndReturn_(model, data, condition, options) {
    let lockerId = Generators.shortid();
    return this.onCollection_(model, async coll => {
      let ret = await coll.updateMany({ ...condition,
        [this.lockerField]: {
          $exists: false
        }
      }, {
        $set: { ...data,
          [this.lockerField]: lockerId
        }
      }, { ...options,
        upsert: false
      });

      try {
        return await coll.find({
          [this.lockerField]: lockerId
        }).toArray();
      } finally {
        if (ret.result.nModified > 0) {
          await coll.updateMany({
            [this.lockerField]: lockerId
          }, {
            $unset: {
              [this.lockerField]: ""
            }
          }, {
            upsert: false
          });
        }
      }
    });
  }

  async insertManyIfNotExist_(model, data, uniqueKeys, options) {
    let ops = data.map(record => ({
      updateOne: {
        filter: { ..._.pick(record, uniqueKeys)
        },
        update: {
          $setOnInsert: record
        },
        upsert: true
      }
    }));
    return this.onCollection_(model, coll => coll.bulkWrite(ops, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async updateMany_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.updateMany(condition, this._translateUpdate(data), options));
  }

  async replaceOne_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.replaceOne(condition, data, options));
  }

  async deleteOne_(model, condition, options) {
    return this.onCollection_(model, coll => coll.deleteOne(condition, options));
  }

  async deleteMany_(model, condition, options) {
    return this.onCollection_(model, coll => coll.deleteMany(condition, options));
  }

  async find_(model, condition, options) {
    return this.onCollection_(model, async coll => {
      let queryOptions = { ...options
      };
      let query = {};

      if (condition) {
        let {
          $projection,
          $orderBy,
          $offset,
          $limit,
          $query,
          ...others
        } = condition;

        if ($projection) {
          queryOptions.projection = $projection;
        }

        if ($orderBy) {
          queryOptions.sort = $orderBy;
        }

        if ($offset) {
          queryOptions.skip = $offset;
        }

        if ($limit) {
          queryOptions.limit = $limit;
        }

        Object.assign(query, _.pickBy(others, (v, k) => k[0] !== '$'));

        if ($query) {
          Object.assign(query, $query);
        }
      }

      let result = await coll.find(query, queryOptions).toArray();

      if (condition && condition.$totalCount) {
        let totalCount = await coll.find(query).count();
        return [result, totalCount];
      }

      return result;
    });
  }

  async aggregate_(model, pipeline, options) {
    return this.onCollection_(model, coll => coll.aggregate(pipeline, options));
  }

  async onCollection_(model, executor) {
    return this.execute_(db => executor(db.collection(model)));
  }

  _translateUpdate(update) {
    let ops = _.pick(update, UpdateOps);

    let others = _.omit(update, UpdateOps);

    if (ops.$set) {
      ops.$set = { ...ops.$set,
        ...others
      };
    } else if (!_.isEmpty(others)) {
      ops.$set = others;
    }

    return ops;
  }

}

MongodbConnector.driverLib = mongodb;
module.exports = MongodbConnector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kcml2ZXJzL21vbmdvZGIvQ29ubmVjdG9yLmpzIl0sIm5hbWVzIjpbIl8iLCJ3YWl0VW50aWxfIiwicmVxdWlyZSIsInRyeVJlcXVpcmUiLCJtb25nb2RiIiwiTW9uZ29DbGllbnQiLCJHcmlkRlNCdWNrZXQiLCJDb25uZWN0b3IiLCJHZW5lcmF0b3JzIiwiVXBkYXRlT3BzRmllbGQiLCJVcGRhdGVPcHNBcnJheSIsIlVwZGF0ZU9wcyIsImNvbmNhdCIsIk1vbmdvZGJDb25uZWN0b3IiLCJjb25zdHJ1Y3RvciIsImNvbm5lY3Rpb25TdHJpbmciLCJvcHRpb25zIiwiZmluZEFsbF8iLCJmaW5kXyIsImxvY2tlckZpZWxkIiwiZW5kXyIsImNsaWVudCIsImlzQ29ubmVjdGVkIiwiY2xvc2UiLCJsb2ciLCJnZXRDb25uZWN0aW9uU3RyaW5nV2l0aG91dENyZWRlbnRpYWwiLCJjb25uZWN0XyIsInVzZU5ld1VybFBhcnNlciIsImNvbm5lY3QiLCJkYiIsImRhdGFiYXNlIiwiZGlzY29ubmVjdF8iLCJjb25uIiwicGluZ18iLCJleGVjdXRlXyIsImxpc3RDb2xsZWN0aW9ucyIsIm5hbWVPbmx5IiwidG9BcnJheSIsImRiRXhlY3V0b3IiLCJlcnIiLCJjcmVhdGVHcmlkRlNCdWNrZXRfIiwiaW5zZXJ0T25lXyIsIm1vZGVsIiwiZGF0YSIsIm9uQ29sbGVjdGlvbl8iLCJjb2xsIiwiaW5zZXJ0T25lIiwiYnlwYXNzRG9jdW1lbnRWYWxpZGF0aW9uIiwiaW5zZXJ0TWFueV8iLCJpbnNlcnRNYW55Iiwib3JkZXJlZCIsImluc2VydE9uZUlmTm90RXhpc3RfIiwiZXJyb3IiLCJjb2RlIiwiZmluZE9uZUFuZFJlcGxhY2VfIiwiY29uZGl0aW9uIiwiZmluZE9uZUFuZFJlcGxhY2UiLCJmaW5kT25lQW5kVXBkYXRlXyIsImZpbmRPbmVBbmRVcGRhdGUiLCJfdHJhbnNsYXRlVXBkYXRlIiwiZmluZE9uZUFuZERlbGV0ZV8iLCJmaW5kT25lQW5kRGVsZXRlIiwiZmluZE9uZV8iLCJmaW5kT25lIiwidXBkYXRlT25lXyIsInVwZGF0ZU9uZSIsInVwZGF0ZU9uZUFuZFJldHVybl8iLCJyZXQiLCJ1cHNlcnQiLCJyZXR1cm5PcmlnaW5hbCIsInZhbHVlIiwidXBzZXJ0T25lXyIsInRyYW5zIiwiX2lkIiwib3RoZXJzIiwiJHNldCIsImlzTmlsIiwiJHNldE9uSW5zZXJ0IiwidXBzZXJ0TWFueV8iLCJ1bmlxdWVLZXlzIiwib3BzIiwibWFwIiwicmVjb3JkIiwidXBkYXRlRGF0YSIsInVwZGF0ZU9wIiwiZmlsdGVyIiwicGljayIsInVwZGF0ZSIsImJ1bGtXcml0ZSIsInVwZGF0ZU1hbnlBbmRSZXR1cm5fIiwibG9ja2VySWQiLCJzaG9ydGlkIiwidXBkYXRlTWFueSIsIiRleGlzdHMiLCJmaW5kIiwicmVzdWx0Iiwibk1vZGlmaWVkIiwiJHVuc2V0IiwiaW5zZXJ0TWFueUlmTm90RXhpc3RfIiwidXBkYXRlTWFueV8iLCJyZXBsYWNlT25lXyIsInJlcGxhY2VPbmUiLCJkZWxldGVPbmVfIiwiZGVsZXRlT25lIiwiZGVsZXRlTWFueV8iLCJkZWxldGVNYW55IiwicXVlcnlPcHRpb25zIiwicXVlcnkiLCIkcHJvamVjdGlvbiIsIiRvcmRlckJ5IiwiJG9mZnNldCIsIiRsaW1pdCIsIiRxdWVyeSIsInByb2plY3Rpb24iLCJzb3J0Iiwic2tpcCIsImxpbWl0IiwiT2JqZWN0IiwiYXNzaWduIiwicGlja0J5IiwidiIsImsiLCIkdG90YWxDb3VudCIsInRvdGFsQ291bnQiLCJjb3VudCIsImFnZ3JlZ2F0ZV8iLCJwaXBlbGluZSIsImFnZ3JlZ2F0ZSIsImV4ZWN1dG9yIiwiY29sbGVjdGlvbiIsIm9taXQiLCJpc0VtcHR5IiwiZHJpdmVyTGliIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU07QUFBRUEsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQTtBQUFMLElBQW9CQyxPQUFPLENBQUMsVUFBRCxDQUFqQzs7QUFDQSxNQUFNO0FB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QUEsZ0JBQWdCLENBQUM0QixNQUFELEVBQVM7QUFDckIsUUFBSVAsR0FBRyxHQUFHaEYsQ0FBQyxDQUFDc0YsSUFBRixDQUFPQyxNQUFQLEVBQWU1RSxTQUFmLENBQVY7O0FBQ0EsUUFBSStELE1BQU0sR0FBRzFFLENBQUMsQ0FBQ2tJLElBQUYsQ0FBTzNDLE1BQVAsRUFBZTVFLFNBQWYsQ0FBYjs7QUFFQSxRQUFJcUUsR0FBRyxDQUFDTCxJQUFSLEVBQWM7QUFDVkssTUFBQUEsR0FBRyxDQUFDTCxJQUFKLEdBQVcsRUFBRSxHQUFHSyxHQUFHLENBQUNMLElBQVQ7QUFBZSxXQUFHRDtBQUFsQixPQUFYO0FBQ0gsS0FGRCxNQUVPLElBQUksQ0FBQzFFLENBQUMsQ0FBQ21JLE9BQUYsQ0FBVXpELE1BQVYsQ0FBTCxFQUF3QjtBQUMzQk0sTUFBQUEsR0FBRyxDQUFDTCxJQUFKLEdBQVdELE1BQVg7QUFDSDs7QUFFRCxXQUFPTSxHQUFQO0FBQ0g7O0FBNVZvQzs7QUErVnpDbkUsZ0JBQWdCLENBQUN1SCxTQUFqQixHQUE2QmhJLE9BQTdCO0FBRUFpSSxNQUFNLENBQUNDLE9BQVAsR0FBaUJ6SCxnQkFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCB7IF8sIHdhaXRVbnRpbF8gfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IHRyeVJlcXVpcmUgfSA9IHJlcXVpcmUoJy4uLy4uL3V0aWxzL2xpYicpO1xuY29uc3QgbW9uZ29kYiA9IHRyeVJlcXVpcmUoJ21vbmdvZGInKTtcbmNvbnN0IHsgTW9uZ29DbGllbnQsIEdyaWRGU0J1Y2tldCB9ID0gbW9uZ29kYjtcbmNvbnN0IENvbm5lY3RvciA9IHJlcXVpcmUoJy4uLy4uL0Nvbm5lY3RvcicpO1xuY29uc3QgR2VuZXJhdG9ycyA9IHJlcXVpcmUoJy4uLy4uL0dlbmVyYXRvcnMnKTtcblxuY29uc3QgVXBkYXRlT3BzRmllbGQgPSBbICckY3VycmVudERhdGUnLCAnJGluYycsICckbWluJywgJyRtYXgnLCAnJG11bCcsICckcmVuYW1lJywgJyRzZXQnLCAnJHNldE9uSW5zZXJ0JywgJyR1bnNldCcgXTtcbmNvbnN0IFVwZGF0ZU9wc0FycmF5ID0gWyAnJGFkZFRvU2V0JywgJyRwb3AnLCAnJHB1bGwnLCAnJHB1c2gnLCAnJHB1bGxBbGwnIF07XG5jb25zdCBVcGRhdGVPcHMgPSBVcGRhdGVPcHNGaWVsZC5jb25jYXQoVXBkYXRlT3BzQXJyYXkpO1xuXG4vKipcbiAqIE1vbmdvZGIgZGF0YSBzdG9yYWdlIGNvbm5lY3Rvci5cbiAqIEBjbGFzc1xuICogQGV4dGVuZHMgQ29ubmVjdG9yXG4gKi9cbmNsYXNzIE1vbmdvZGJDb25uZWN0b3IgZXh0ZW5kcyBDb25uZWN0b3Ige1xuICAgIC8qKiAgICAgICAgICBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gb3B0aW9ucyBcbiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IFtvcHRpb25zLnVzZVByZXBhcmVkU3RhdGVtZW50XSAtIFxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKGNvbm5lY3Rpb25TdHJpbmcsIG9wdGlvbnMpIHsgICAgICAgIFxuICAgICAgICBzdXBlcignbW9uZ29kYicsIGNvbm5lY3Rpb25TdHJpbmcsIG9wdGlvbnMpOyAgICBcbiAgICAgICAgXG4gICAgICAgIHRoaXMubG9ja2VyRmllbGQgPSB0aGlzLm9wdGlvbnMubG9ja2VyRmllbGQgfHwgJ19fbG9ja19fJztcbiAgICB9XG5cbiAgICBmaW5kQWxsXyA9IHRoaXMuZmluZF87XG5cbiAgICAvKipcbiAgICAgKiBDbG9zZSBhbGwgY29ubmVjdGlvbiBpbml0aWF0ZWQgYnkgdGhpcyBjb25uZWN0b3IuXG4gICAgICovXG4gICAgYXN5bmMgZW5kXygpIHtcbiAgICAgICAgaWYgKHRoaXMuY2xpZW50ICYmIHRoaXMuY2xpZW50LmlzQ29ubmVjdGVkKCkpIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuY2xpZW50LmNsb3NlKCk7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGBtb25nb2RiOiBzdWNjZXNzZnVsbHkgZGlzY29ubmVjdGVkIGZyb20gXCIke3RoaXMuZ2V0Q29ubmVjdGlvblN0cmluZ1dpdGhvdXRDcmVkZW50aWFsKCl9XCIuYCk7ICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICB9XG5cbiAgICAgICAgZGVsZXRlIHRoaXMuY2xpZW50O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIGRhdGFiYXNlIGNvbm5lY3Rpb24gYmFzZWQgb24gdGhlIGRlZmF1bHQgY29ubmVjdGlvbiBzdHJpbmcgb2YgdGhlIGNvbm5lY3RvciBhbmQgZ2l2ZW4gb3B0aW9ucy4gICAgIFxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc10gLSBFeHRyYSBvcHRpb25zIGZvciB0aGUgY29ubmVjdGlvbiwgb3B0aW9uYWwuXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbb3B0aW9ucy5tdWx0aXBsZVN0YXRlbWVudHM9ZmFsc2VdIC0gQWxsb3cgcnVubmluZyBtdWx0aXBsZSBzdGF0ZW1lbnRzIGF0IGEgdGltZS5cbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtvcHRpb25zLmNyZWF0ZURhdGFiYXNlPWZhbHNlXSAtIEZsYWcgdG8gdXNlZCB3aGVuIGNyZWF0aW5nIGEgZGF0YWJhc2UuXG4gICAgICogQHJldHVybnMge1Byb21pc2UuPERiPn1cbiAgICAgKi9cbiAgICBhc3luYyBjb25uZWN0XyhvcHRpb25zKSB7XG4gICAgICAgIGlmICghdGhpcy5jbGllbnQgfHwgIXRoaXMuY2xpZW50LmlzQ29ubmVjdGVkKCkpIHtcbiAgICAgICAgICAgIGxldCBjbGllbnQgPSBuZXcgTW9uZ29DbGllbnQodGhpcy5jb25uZWN0aW9uU3RyaW5nLCB7dXNlTmV3VXJsUGFyc2VyOiB0cnVlfSk7XG4gICAgICAgICAgICB0aGlzLmNsaWVudCA9IGF3YWl0IGNsaWVudC5jb25uZWN0KCk7IFxuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBgbW9uZ29kYjogc3VjY2Vzc2Z1bGx5IGNvbm5lY3RlZCB0byBcIiR7dGhpcy5nZXRDb25uZWN0aW9uU3RyaW5nV2l0aG91dENyZWRlbnRpYWwoKX1cIi5gKTsgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgIH0gICAgICAgXG5cbiAgICAgICAgcmV0dXJuIHRoaXMuY2xpZW50LmRiKHRoaXMuZGF0YWJhc2UpO1xuICAgIH1cbiAgICBcbiAgICAvKipcbiAgICAgKiBDbG9zZSBhIGRhdGFiYXNlIGNvbm5lY3Rpb24uXG4gICAgICogQHBhcmFtIHtEYn0gY29ubiAtIE15U1FMIGNvbm5lY3Rpb24uXG4gICAgICovXG4gICAgYXN5bmMgZGlzY29ubmVjdF8oY29ubikge1xuICAgIH1cblxuICAgIGFzeW5jIHBpbmdfKCkgeyAgXG4gICAgICAgIHJldHVybiB0aGlzLmV4ZWN1dGVfKGRiID0+IHtcbiAgICAgICAgICAgIHJldHVybiBkYi5saXN0Q29sbGVjdGlvbnMobnVsbCwgeyBuYW1lT25seTogdHJ1ZSB9KS50b0FycmF5KCk7XG4gICAgICAgIH0pOyAgXG4gICAgfVxuXG4gICAgYXN5bmMgZXhlY3V0ZV8oZGJFeGVjdXRvcikge1xuICAgICAgICBsZXQgZGI7XG4gICAgXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBkYiA9IGF3YWl0IHRoaXMuY29ubmVjdF8oKTtcblxuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IGRiRXhlY3V0b3IoZGIpO1xuICAgICAgICB9IGNhdGNoKGVycikgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgICAgZGIgJiYgYXdhaXQgdGhpcy5kaXNjb25uZWN0XyhkYik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gW29wdGlvbnNdIC0gT3B0aW9uYWwgc2V0dGluZ3MuXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLmJ1Y2tldE5hbWU9J2ZzJ10gLSBUaGUgJ2ZpbGVzJyBhbmQgJ2NodW5rcycgY29sbGVjdGlvbnMgd2lsbCBiZSBwcmVmaXhlZCB3aXRoIHRoZSBidWNrZXQgbmFtZSBmb2xsb3dlZCBieSBhIGRvdC5cbiAgICAgKiBAcHJvcGVydHkge251bWJlcn0gW29wdGlvbnMuY2h1bmtTaXplQnl0ZXNdIC0gTnVtYmVyIG9mIGJ5dGVzIHN0b3JlZCBpbiBlYWNoIGNodW5rLiBEZWZhdWx0cyB0byAyNTVLQlxuICAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBbb3B0aW9ucy53cml0ZUNvbmNlcm5dXG4gICAgICogQHByb3BlcnR5IHtvYmplY3R9IFtvcHRpb25zLnJlYWRQcmVmZXJlbmNlXVxuICAgICAqL1xuICAgIGFzeW5jIGNyZWF0ZUdyaWRGU0J1Y2tldF8ob3B0aW9ucykge1xuICAgICAgICBsZXQgZGIgPSBhd2FpdCB0aGlzLmNvbm5lY3RfKCk7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBHcmlkRlNCdWNrZXQoZGIsIG9wdGlvbnMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIG5ldyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBpbnNlcnRPbmVfKG1vZGVsLCBkYXRhLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmluc2VydE9uZShkYXRhLCB7IGJ5cGFzc0RvY3VtZW50VmFsaWRhdGlvbjogdHJ1ZSwgLi4ub3B0aW9ucyB9KSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGFuIGFycmF5IG9mIG5ldyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7YXJyYXl9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGluc2VydE1hbnlfKG1vZGVsLCBkYXRhLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmluc2VydE1hbnkoZGF0YSwgeyBieXBhc3NEb2N1bWVudFZhbGlkYXRpb246IHRydWUsIG9yZGVyZWQ6IGZhbHNlLCAuLi5vcHRpb25zIH0pKTtcbiAgICB9XG5cbiAgICBhc3luYyBpbnNlcnRPbmVJZk5vdEV4aXN0Xyhtb2RlbCwgZGF0YSwgb3B0aW9ucykge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuaW5zZXJ0T25lXyhtb2RlbCwgZGF0YSwgb3B0aW9ucylcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGlmIChlcnJvci5jb2RlID09PSAxMTAwMCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXBsYWNlIChpbnNlcnQgb3IgdXBkYXRlIGZvciBleHNpc3RpbmcpIGFuIGVudGl0eSBhbmQgcmV0dXJuIG9yaWdpbmFsIHJlY29yZC5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGZpbmRPbmVBbmRSZXBsYWNlXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmZpbmRPbmVBbmRSZXBsYWNlKGNvbmRpdGlvbiwgZGF0YSwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEZpbmQgYSBkb2N1bWVudCBhbmQgdXBkYXRlIGl0IGluIG9uZSBhdG9taWMgb3BlcmF0aW9uLiBSZXF1aXJlcyBhIHdyaXRlIGxvY2sgZm9yIHRoZSBkdXJhdGlvbiBvZiB0aGUgb3BlcmF0aW9uLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgZmluZE9uZUFuZFVwZGF0ZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykgeyAgICAgXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmZpbmRPbmVBbmRVcGRhdGUoY29uZGl0aW9uLCB0aGlzLl90cmFuc2xhdGVVcGRhdGUoZGF0YSksIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICBhc3luYyBmaW5kT25lQW5kRGVsZXRlXyhtb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmZpbmRPbmVBbmREZWxldGUoY29uZGl0aW9uLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgZmluZE9uZV8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5maW5kT25lKGNvbmRpdGlvbiwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZSBhbiBleGlzdGluZyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyB1cGRhdGVPbmVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLnVwZGF0ZU9uZShjb25kaXRpb24sIHRoaXMuX3RyYW5zbGF0ZVVwZGF0ZShkYXRhKSwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIGFzeW5jIHVwZGF0ZU9uZUFuZFJldHVybl8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykgeyAgICAgXG4gICAgICAgIGxldCByZXQgPSBhd2FpdCB0aGlzLmZpbmRPbmVBbmRVcGRhdGVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIHsgLi4ub3B0aW9ucywgdXBzZXJ0OiBmYWxzZSwgcmV0dXJuT3JpZ2luYWw6IGZhbHNlIH0pO1xuICAgICAgICByZXR1cm4gcmV0ICYmIHJldC52YWx1ZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgYW4gZXhpc3RpbmcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgdXBzZXJ0T25lXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7IFxuICAgICAgICBsZXQgdHJhbnMgPSB0aGlzLl90cmFuc2xhdGVVcGRhdGUoZGF0YSk7XG4gICAgICAgIGxldCB7IF9pZCwgLi4ub3RoZXJzIH0gPSB0cmFucy4kc2V0OyBcbiAgICAgICAgaWYgKCFfLmlzTmlsKF9pZCkpIHtcbiAgICAgICAgICAgIHRyYW5zLiRzZXQgPSBvdGhlcnM7XG4gICAgICAgICAgICB0cmFucy4kc2V0T25JbnNlcnQgPSB7IF9pZCB9O1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwudXBkYXRlT25lKGNvbmRpdGlvbiwgdHJhbnMsIHsgLi4ub3B0aW9ucywgdXBzZXJ0OiB0cnVlIH0pKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgbWFueSBlbnRpdGllcy5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgLSBBcnJheSBvZiByZWNvcmQgd2l0aCBfaWRcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgdXBzZXJ0TWFueV8obW9kZWwsIGRhdGEsIHVuaXF1ZUtleXMsIG9wdGlvbnMpIHsgXG4gICAgICAgIGxldCBvcHMgPSBkYXRhLm1hcChyZWNvcmQgPT4ge1xuICAgICAgICAgICAgbGV0IHsgX2lkLCAuLi51cGRhdGVEYXRhIH0gPSByZWNvcmQ7XG5cbiAgICAgICAgICAgIGxldCB1cGRhdGVPcCA9IHtcbiAgICAgICAgICAgICAgICAkc2V0OiB1cGRhdGVEYXRhXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBpZiAoX2lkKSB7XG4gICAgICAgICAgICAgICAgdXBkYXRlT3AuJHNldE9uSW5zZXJ0ID0geyBfaWQgfTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICB1cGRhdGVPbmU6IHsgZmlsdGVyOiB7IC4uLl8ucGljayhyZWNvcmQsIHVuaXF1ZUtleXMpIH0sIHVwZGF0ZTogdXBkYXRlT3AsIHVwc2VydDogdHJ1ZSB9XG4gICAgICAgICAgICB9O1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5idWxrV3JpdGUob3BzLCB7IGJ5cGFzc0RvY3VtZW50VmFsaWRhdGlvbjogdHJ1ZSwgb3JkZXJlZDogZmFsc2UsIC4uLm9wdGlvbnMgfSkpO1xuICAgIH1cblxuICAgIGFzeW5jIHVwZGF0ZU1hbnlBbmRSZXR1cm5fKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgICAgICAgIFxuICAgICAgICBsZXQgbG9ja2VySWQgPSBHZW5lcmF0b3JzLnNob3J0aWQoKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCBhc3luYyAoY29sbCkgPT4ge1xuICAgICAgICAgICAgLy8xLnVwZGF0ZSBhbmQgc2V0IGxvY2tlclxuICAgICAgICAgICAgbGV0IHJldCA9IGF3YWl0IGNvbGwudXBkYXRlTWFueShcbiAgICAgICAgICAgICAgICB7IC4uLmNvbmRpdGlvbiwgW3RoaXMubG9ja2VyRmllbGRdOiB7ICRleGlzdHM6IGZhbHNlIH0gfSwgLy8gZm9yIGFsbCBub24tbG9ja2VkXG4gICAgICAgICAgICAgICAgeyAkc2V0OiB7IC4uLmRhdGEsIFt0aGlzLmxvY2tlckZpZWxkXTogbG9ja2VySWQgfSB9LCAvLyBsb2NrIGl0IFxuICAgICAgICAgICAgICAgIHsgLi4ub3B0aW9ucywgdXBzZXJ0OiBmYWxzZSB9ICk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgLy8yLnJldHVybiBhbGwgbG9ja2VkIHJlY29yZHNcbiAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgY29sbC5maW5kKHsgW3RoaXMubG9ja2VyRmllbGRdOiBsb2NrZXJJZCB9KS50b0FycmF5KCk7IC8vIHJldHVybiBhbGwgbG9ja2VkXG4gICAgICAgICAgICB9IGZpbmFsbHkgeyAgICBcbiAgICAgICAgICAgICAgICAvLzMucmVtb3ZlIGxvY2tlcnNcbiAgICAgICAgICAgICAgICBpZiAocmV0LnJlc3VsdC5uTW9kaWZpZWQgPiAwKSB7IC8vIHVubG9ja1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCBjb2xsLnVwZGF0ZU1hbnkoeyBbdGhpcy5sb2NrZXJGaWVsZF06IGxvY2tlcklkIH0sIHsgJHVuc2V0OiB7IFt0aGlzLmxvY2tlckZpZWxkXTogXCJcIiB9IH0sIHsgdXBzZXJ0OiBmYWxzZSB9KTsgICAgXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTsgICAgICAgICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBJbnNlcnQgbWFueSBlbnRpdGllcyBpZiBub3QgZXhpc3QuXG4gICAgICogQHBhcmFtIHsqfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0geyp9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSB1bmlxdWVLZXlzIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBpbnNlcnRNYW55SWZOb3RFeGlzdF8obW9kZWwsIGRhdGEsIHVuaXF1ZUtleXMsIG9wdGlvbnMpIHtcbiAgICAgICAgbGV0IG9wcyA9IGRhdGEubWFwKHJlY29yZCA9PiAoe1xuICAgICAgICAgICAgdXBkYXRlT25lOiB7IGZpbHRlcjogeyAuLi5fLnBpY2socmVjb3JkLCB1bmlxdWVLZXlzKSB9LCB1cGRhdGU6IHsgJHNldE9uSW5zZXJ0OiByZWNvcmQgfSwgdXBzZXJ0OiB0cnVlIH1cbiAgICAgICAgfSkpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmJ1bGtXcml0ZShvcHMsIHsgYnlwYXNzRG9jdW1lbnRWYWxpZGF0aW9uOiB0cnVlLCBvcmRlcmVkOiBmYWxzZSwgLi4ub3B0aW9ucyB9KSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIG11bHRpcGxlIGRvY3VtZW50cy5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyB1cGRhdGVNYW55Xyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7IFxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC51cGRhdGVNYW55KGNvbmRpdGlvbiwgdGhpcy5fdHJhbnNsYXRlVXBkYXRlKGRhdGEpLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVwbGFjZSBhbiBleGlzdGluZyBlbnRpdHkgb3IgY3JlYXRlIGEgbmV3IG9uZS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIHJlcGxhY2VPbmVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgIFxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5yZXBsYWNlT25lKGNvbmRpdGlvbiwgZGF0YSwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZSBhbiBleGlzdGluZyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBkZWxldGVPbmVfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZGVsZXRlT25lKGNvbmRpdGlvbiwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZSBhbiBleGlzdGluZyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBkZWxldGVNYW55Xyhtb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmRlbGV0ZU1hbnkoY29uZGl0aW9uLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUGVyZm9ybSBzZWxlY3Qgb3BlcmF0aW9uLlxuICAgICAqIEBwYXJhbSB7Kn0gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGZpbmRfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgYXN5bmMgY29sbCA9PiB7XG4gICAgICAgICAgICBsZXQgcXVlcnlPcHRpb25zID0gey4uLm9wdGlvbnN9O1xuICAgICAgICAgICAgbGV0IHF1ZXJ5ID0ge307XG5cbiAgICAgICAgICAgIGlmIChjb25kaXRpb24pIHtcbiAgICAgICAgICAgICAgICBsZXQgeyAkcHJvamVjdGlvbiwgJG9yZGVyQnksICRvZmZzZXQsICRsaW1pdCwgJHF1ZXJ5LCAuLi5vdGhlcnMgfSA9IGNvbmRpdGlvbjtcblxuICAgICAgICAgICAgICAgIGlmICgkcHJvamVjdGlvbikge1xuICAgICAgICAgICAgICAgICAgICBxdWVyeU9wdGlvbnMucHJvamVjdGlvbiA9ICRwcm9qZWN0aW9uOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoJG9yZGVyQnkpIHtcbiAgICAgICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLnNvcnQgPSAkb3JkZXJCeTsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKCRvZmZzZXQpIHtcbiAgICAgICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLnNraXAgPSAkb2Zmc2V0OyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoJGxpbWl0KSB7XG4gICAgICAgICAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucy5saW1pdCA9ICRsaW1pdDsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihxdWVyeSwgXy5waWNrQnkob3RoZXJzLCAodixrKSA9PiBrWzBdICE9PSAnJCcpKTtcblxuICAgICAgICAgICAgICAgIGlmICgkcXVlcnkpIHtcbiAgICAgICAgICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihxdWVyeSwgJHF1ZXJ5KTtcbiAgICAgICAgICAgICAgICB9IFxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgcmVzdWx0ID0gYXdhaXQgY29sbC5maW5kKHF1ZXJ5LCBxdWVyeU9wdGlvbnMpLnRvQXJyYXkoKTtcblxuICAgICAgICAgICAgaWYgKGNvbmRpdGlvbiAmJiBjb25kaXRpb24uJHRvdGFsQ291bnQpIHtcbiAgICAgICAgICAgICAgICBsZXQgdG90YWxDb3VudCA9IGF3YWl0IGNvbGwuZmluZChxdWVyeSkuY291bnQoKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gWyByZXN1bHQsIHRvdGFsQ291bnQgXTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgfSk7XG4gICAgfSAgIFxuXG4gICAgYXN5bmMgYWdncmVnYXRlXyhtb2RlbCwgcGlwZWxpbmUsIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuYWdncmVnYXRlKHBpcGVsaW5lLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgb25Db2xsZWN0aW9uXyhtb2RlbCwgZXhlY3V0b3IpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZXhlY3V0ZV8oZGIgPT4gZXhlY3V0b3IoZGIuY29sbGVjdGlvbihtb2RlbCkpKTtcbiAgICB9XG5cbiAgICBfdHJhbnNsYXRlVXBkYXRlKHVwZGF0ZSkge1xuICAgICAgICBsZXQgb3BzID0gXy5waWNrKHVwZGF0ZSwgVXBkYXRlT3BzKTtcbiAgICAgICAgbGV0IG90aGVycyA9IF8ub21pdCh1cGRhdGUsIFVwZGF0ZU9wcyk7XG5cbiAgICAgICAgaWYgKG9wcy4kc2V0KSB7XG4gICAgICAgICAgICBvcHMuJHNldCA9IHsgLi4ub3BzLiRzZXQsIC4uLm90aGVycyB9O1xuICAgICAgICB9IGVsc2UgaWYgKCFfLmlzRW1wdHkob3RoZXJzKSkge1xuICAgICAgICAgICAgb3BzLiRzZXQgPSBvdGhlcnM7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gb3BzO1xuICAgIH1cbn1cblxuTW9uZ29kYkNvbm5lY3Rvci5kcml2ZXJMaWIgPSBtb25nb2RiO1xuXG5tb2R1bGUuZXhwb3J0cyA9IE1vbmdvZGJDb25uZWN0b3I7Il19