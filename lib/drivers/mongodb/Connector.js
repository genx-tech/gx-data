"use strict";

require("source-map-support/register");

const {
  _,
  waitUntil_
} = require('rk-utils');

const {
  tryRequire
} = require('../../utils/lib');

const mongodb = tryRequire('mongodb');
const {
  MongoClient,
  GridFSBucket
} = mongodb;

const Connector = require('../../Connector');

const Generators = require('../../Generators');

const {
  InvalidArgument,
  DatabaseError
} = require('../../utils/Errors');

const UpdateOpsField = ['$currentDate', '$inc', '$min', '$max', '$mul', '$rename', '$set', '$setOnInsert', '$unset'];
const UpdateOpsArray = ['$addToSet', '$pop', '$pull', '$push', '$pullAll'];
const UpdateOps = UpdateOpsField.concat(UpdateOpsArray);

class MongodbConnector extends Connector {
  constructor(connectionString, options) {
    super('mongodb', connectionString, options);

    this.updatedCount = context => context.result.modifiedCount;

    this.deletedCount = context => context.result.deletedCount;

    this.findAll_ = this.find_;
    this.lockerField = this.options.lockerField || '__lock__';
  }

  ensureInsertOne(opReturn) {
    if (opReturn.result.ok !== 1 || opReturn.result.n !== 1) {
      throw new DatabaseError('Mongodb "insertOne" operation failed');
    }

    return opReturn.insertedId;
  }

  ensureUpdateOne(opReturn, enforceUpdated) {
    if (opReturn.result.ok !== 1 || enforceUpdated && opReturn.result.nModified !== 1) {
      throw new DatabaseError('Mongodb "updateOne" operation failed');
    }
  }

  async end_() {
    if (this.client && this.client.isConnected()) {
      await this.client.close();
      this.log('verbose', `mongodb: successfully disconnected from "${this.getConnectionStringWithoutCredential()}".`);
    }

    delete this.client;
  }

  async connect_(options) {
    if (!this.client || !this.client.isConnected()) {
      let client = new MongoClient(this.connectionString, {
        useNewUrlParser: true
      });
      this.client = await client.connect();
      this.log('verbose', `mongodb: successfully connected to "${this.getConnectionStringWithoutCredential()}".`);
    }

    return this.client.db(this.database);
  }

  async disconnect_(conn) {}

  async ping_() {
    return this.execute_(db => {
      return db.listCollections(null, {
        nameOnly: true
      }).toArray();
    });
  }

  async execute_(dbExecutor) {
    let db;

    try {
      db = await this.connect_();
      return await dbExecutor(db);
    } catch (err) {
      throw err;
    } finally {
      db && (await this.disconnect_(db));
    }
  }

  async createGridFSBucket_(options) {
    let db = await this.connect_();
    return new GridFSBucket(db, options);
  }

  async insertOne_(model, data, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'insertOne: ' + JSON.stringify({
        model,
        data,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.insertOne(data, options));
  }

  async insertMany_(model, data, options) {
    options = {
      ordered: false,
      ...options
    };

    if (this.options.logStatement) {
      this.log('verbose', 'insertMany: ' + JSON.stringify({
        model,
        count: data.length,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.insertMany(data, options));
  }

  async insertOneIfNotExist_(model, data, options) {
    try {
      return await this.insertOne_(model, data, options);
    } catch (error) {
      if (error.code === 11000) {
        return false;
      }

      throw error;
    }
  }

  async updateOne_(model, data, condition, options) {
    data = this._translateUpdate(data);

    if (this.options.logStatement) {
      this.log('verbose', 'updateOne: ' + JSON.stringify({
        model,
        data,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.updateOne(condition, data, options));
  }

  async updateOneAndReturn_(model, data, condition, options) {
    let ret = await this.findOneAndUpdate_(model, data, condition, { ...options,
      upsert: false,
      returnOriginal: false
    });
    return ret && ret.value;
  }

  async upsertOne_(model, data, condition, options, dataOnInsert) {
    let trans = this._translateUpdate(data);

    let {
      _id,
      ...others
    } = trans.$set || {};

    if (!_.isNil(_id)) {
      trans.$set = others;
      trans.$setOnInsert = {
        _id
      };
    }

    if (!_.isEmpty(dataOnInsert)) {
      trans.$setOnInsert = { ...trans.$setOnInsert,
        ...dataOnInsert
      };
    }

    options = { ...options,
      upsert: true
    };

    if (this.options.logStatement) {
      this.log('verbose', 'upsertOne: ' + JSON.stringify({
        model,
        data: trans,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.updateOne(condition, trans, options));
  }

  async upsertOneAndReturn_(model, data, condition, options, dataOnInsert) {
    let trans = this._translateUpdate(data);

    let {
      _id,
      ...others
    } = trans.$set || {};

    if (!_.isNil(_id)) {
      trans.$set = others;
      trans.$setOnInsert = {
        _id
      };
    }

    if (!_.isEmpty(dataOnInsert)) {
      trans.$setOnInsert = { ...trans.$setOnInsert,
        ...dataOnInsert
      };
    }

    options = { ...options,
      upsert: true,
      returnOriginal: false
    };

    if (this.options.logStatement) {
      this.log('verbose', 'upsertOne: ' + JSON.stringify({
        model,
        data: trans,
        condition,
        options
      }));
    }

    let ret = await this.onCollection_(model, coll => coll.findOneAndUpdate(condition, trans, options));
    return ret && ret.value;
  }

  async upsertMany_(model, data, uniqueKeys, options, dataOnInsert) {
    let ops = data.map(record => {
      let {
        _id,
        ...updateData
      } = record;

      let updateOp = this._translateUpdate(updateData);

      if (_id) {
        updateOp.$setOnInsert = {
          _id,
          ...dataOnInsert
        };
      } else if (!_.isEmpty(dataOnInsert)) {
        updateOp.$setOnInsert = dataOnInsert;
      }

      return {
        updateOne: {
          filter: { ..._.pick(record, uniqueKeys)
          },
          update: updateOp,
          upsert: true
        }
      };
    });
    options = {
      ordered: false,
      ...options
    };

    if (this.options.logStatement) {
      this.log('verbose', 'bulkWrite: ' + JSON.stringify({
        model,
        count: ops.length,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.bulkWrite(ops, options));
  }

  async updateManyAndReturn_(model, data, condition, options) {
    let lockerId = Generators.shortid();

    if (this.options.logStatement) {
      this.log('verbose', 'updateMany+find+updateMany: ' + JSON.stringify({
        model,
        count: data.length,
        condition,
        options
      }));
    }

    return this.onCollection_(model, async coll => {
      let ret = await coll.updateMany({ ...condition,
        [this.lockerField]: {
          $exists: false
        }
      }, {
        $set: { ...data,
          [this.lockerField]: lockerId
        }
      }, { ...options,
        upsert: false
      });

      try {
        return await coll.find({
          [this.lockerField]: lockerId
        }, {
          projection: {
            [this.lockerField]: 0
          }
        }).toArray();
      } finally {
        if (ret.result.nModified > 0) {
          await coll.updateMany({
            [this.lockerField]: lockerId
          }, {
            $unset: {
              [this.lockerField]: ""
            }
          }, {
            upsert: false
          });
        }
      }
    });
  }

  async insertManyIfNotExist_(model, data, uniqueKeys, options) {
    console.log('buggy: tofix');
    let ops = data.map(record => ({
      updateOne: {
        filter: { ..._.pick(record, uniqueKeys)
        },
        update: {
          $setOnInsert: record
        },
        upsert: true
      }
    }));
    return this.onCollection_(model, coll => coll.bulkWrite(ops, {
      ordered: false,
      ...options
    }));
  }

  async updateMany_(model, data, condition, options) {
    data = this._translateUpdate(data);

    if (this.options.logStatement) {
      this.log('verbose', 'updateMany: ' + JSON.stringify({
        model,
        count: data.length,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.updateMany(condition, data, options));
  }

  async replaceOne_(model, data, condition, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'replaceOne: ' + JSON.stringify({
        model,
        data,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.replaceOne(condition, data, options));
  }

  async deleteOne_(model, condition, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'deleteOne: ' + JSON.stringify({
        model,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.deleteOne(condition, options));
  }

  async deleteMany_(model, condition, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'deleteMany: ' + JSON.stringify({
        model,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.deleteMany(condition, options));
  }

  async findOneAndReplace_(model, data, condition, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'findOneAndReplace: ' + JSON.stringify({
        model,
        data,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.findOneAndReplace(condition, data, options));
  }

  async findOneAndUpdate_(model, data, condition, options) {
    data = this._translateUpdate(data);

    if (this.options.logStatement) {
      this.log('verbose', 'findOneAndUpdate: ' + JSON.stringify({
        model,
        data,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.findOneAndUpdate(condition, data, options));
  }

  async findOneAndDelete_(model, condition, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'findOneAndDelete: ' + JSON.stringify({
        model,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.findOneAndDelete(condition, options));
  }

  async findOne_(model, condition, options) {
    let queryOptions = { ...options
    };
    let query;

    if (!_.isEmpty(condition)) {
      let {
        $projection,
        $query,
        ...others
      } = condition;

      if ($projection) {
        queryOptions.projection = $projection;
      }

      query = { ...others,
        ...$query
      };
    } else {
      throw new InvalidArgument('findOne requires non-empty query condition.');
    }

    if (this.options.logStatement) {
      this.log('verbose', 'findOne: ' + JSON.stringify({
        model,
        condition: query,
        options: queryOptions
      }));
    }

    return this.onCollection_(model, coll => coll.findOne(query, queryOptions));
  }

  async find_(model, condition, options) {
    let queryOptions = { ...options
    };
    let query, requireTotalCount;

    if (!_.isEmpty(condition)) {
      let {
        $projection,
        $totalCount,
        $orderBy,
        $offset,
        $limit,
        $query,
        ...others
      } = condition;

      if ($projection) {
        queryOptions.projection = $projection;
      }

      if ($orderBy) {
        queryOptions.sort = $orderBy;
      }

      if ($offset) {
        queryOptions.skip = $offset;
      }

      if ($limit) {
        queryOptions.limit = $limit;
      }

      query = { ...others,
        ...$query
      };
      requireTotalCount = $totalCount;
    } else {
      query = {};
      requireTotalCount = false;
    }

    if (this.options.logStatement) {
      this.log('verbose', 'find: ' + JSON.stringify({
        model,
        condition: query,
        options: queryOptions
      }));
    }

    return this.onCollection_(model, async coll => {
      let result = await coll.find(query, queryOptions).toArray();

      if (requireTotalCount) {
        let totalCount = await coll.find(query).count();
        return [result, totalCount];
      }

      return result;
    });
  }

  async aggregate_(model, pipeline, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'aggregate: ' + JSON.stringify({
        model,
        pipeline,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.aggregate(pipeline, options).toArray());
  }

  async distinct_(model, field, query, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'distinct: ' + JSON.stringify({
        model,
        field,
        query,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.distinct(field, query, options));
  }

  async count_(model, query, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'count: ' + JSON.stringify({
        model,
        query,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.countDocuments(query, options));
  }

  async onCollection_(model, executor) {
    return this.execute_(db => executor(db.collection(model)));
  }

  _translateUpdate(update) {
    let ops = _.pick(update, UpdateOps);

    let others = _.omit(update, UpdateOps);

    if (ops.$set) {
      ops.$set = { ...ops.$set,
        ...others
      };
    } else if (!_.isEmpty(others)) {
      ops.$set = others;
    }

    return ops;
  }

}

MongodbConnector.driverLib = mongodb;
module.exports = MongodbConnector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kcml2ZXJzL21vbmdvZGIvQ29ubmVjdG9yLmpzIl0sIm5hbWVzIjpbIl8iLCJ3YWl0VW50aWxfIiwicmVxdWlyZSIsInRyeVJlcXVpcmUiLCJtb25nb2RiIiwiTW9uZ29DbGllbnQiLCJHcmlkRlNCdWNrZXQiLCJDb25uZWN0b3IiLCJHZW5lcmF0b3JzIiwiSW52YWxpZEFyZ3VtZW50IiwiRGF0YWJhc2VFcnJvciIsIlVwZGF0ZU9wc0ZpZWxkIiwiVXBkYXRlT3BzQXJyYXkiLCJVcGRhdGVPcHMiLCJjb25jYXQiLCJNb25nb2RiQ29ubmVjdG9yIiwiY29uc3RydWN0b3IiLCJjb25uZWN0aW9uU3RyaW5nIiwib3B0aW9ucyIsInVwZGF0ZWRDb3VudCIsImNvbnRleHQiLCJyZXN1bHQiLCJtb2RpZmllZENvdW50IiwiZGVsZXRlZENvdW50IiwiZmluZEFsbF8iLCJmaW5kXyIsImxvY2tlckZpZWxkIiwiZW5zdXJlSW5zZXJ0T25lIiwib3BSZXR1cm4iLCJvayIsIm4iLCJpbnNlcnRlZElkIiwiZW5zdXJlVXBkYXRlT25lIiwiZW5mb3JjZVVwZGF0ZWQiLCJuTW9kaWZpZWQiLCJlbmRfIiwiY2xpZW50IiwiaXNDb25uZWN0ZWQiLCJjbG9zZSIsImxvZyIsImdldENvbm5lY3Rpb25TdHJpbmdXaXRob3V0Q3JlZGVudGlhbCIsImNvbm5lY3RfIiwidXNlTmV3VXJsUGFyc2VyIiwiY29ubmVjdCIsImRiIiwiZGF0YWJhc2UiLCJkaXNjb25uZWN0XyIsImNvbm4iLCJwaW5nXyIsImV4ZWN1dGVfIiwibGlzdENvbGxlY3Rpb25zIiwibmFtZU9ubHkiLCJ0b0FycmF5IiwiZGJFeGVjdXRvciIsImVyciIsImNyZWF0ZUdyaWRGU0J1Y2tldF8iLCJpbnNlcnRPbmVfIiwibW9kZWwiLCJkYXRhIiwibG9nU3RhdGVtZW50IiwiSlNPTiIsInN0cmluZ2lmeSIsIm9uQ29sbGVjdGlvbl8iLCJjb2xsIiwiaW5zZXJ0T25lIiwiaW5zZXJ0TWFueV8iLCJvcmRlcmVkIiwiY291bnQiLCJsZW5ndGgiLCJpbnNlcnRNYW55IiwiaW5zZXJ0T25lSWZOb3RFeGlzdF8iLCJlcnJvciIsImNvZGUiLCJ1cGRhdGVPbmVfIiwiY29uZGl0aW9uIiwiX3RyYW5zbGF0ZVVwZGF0ZSIsInVwZGF0ZU9uZSIsInVwZGF0ZU9uZUFuZFJldHVybl8iLCJyZXQiLCJmaW5kT25lQW5kVXBkYXRlXyIsInVwc2VydCIsInJldHVybk9yaWdpbmFsIiwidmFsdWUiLCJ1cHNlcnRPbmVfIiwiZGF0YU9uSW5zZXJ0IiwidHJhbnMiLCJfaWQiLCJvdGhlcnMiLCIkc2V0IiwiaXNOaWwiLCIkc2V0T25JbnNlcnQiLCJpc0VtcHR5IiwidXBzZXJ0T25lQW5kUmV0dXJuXyIsImZpbmRPbmVBbmRVcGRhdGUiLCJ1cHNlcnRNYW55XyIsInVuaXF1ZUtleXMiLCJvcHMiLCJtYXAiLCJyZWNvcmQiLCJ1cGRhdGVEYXRhIiwidXBkYXRlT3AiLCJmaWx0ZXIiLCJwaWNrIiwidXBkYXRlIiwiYnVsa1dyaXRlIiwidXBkYXRlTWFueUFuZFJldHVybl8iLCJsb2NrZXJJZCIsInNob3J0aWQiLCJ1cGRhdGVNYW55IiwiJGV4aXN0cyIsImZpbmQiLCJwcm9qZWN0aW9uIiwiJHVuc2V0IiwiaW5zZXJ0TWFueUlmTm90RXhpc3RfIiwiY29uc29sZSIsInVwZGF0ZU1hbnlfIiwicmVwbGFjZU9uZV8iLCJyZXBsYWNlT25lIiwiZGVsZXRlT25lXyIsImRlbGV0ZU9uZSIsImRlbGV0ZU1hbnlfIiwiZGVsZXRlTWFueSIsImZpbmRPbmVBbmRSZXBsYWNlXyIsImZpbmRPbmVBbmRSZXBsYWNlIiwiZmluZE9uZUFuZERlbGV0ZV8iLCJmaW5kT25lQW5kRGVsZXRlIiwiZmluZE9uZV8iLCJxdWVyeU9wdGlvbnMiLCJxdWVyeSIsIiRwcm9qZWN0aW9uIiwiJHF1ZXJ5IiwiZmluZE9uZSIsInJlcXVpcmVUb3RhbENvdW50IiwiJHRvdGFsQ291bnQiLCIkb3JkZXJCeSIsIiRvZmZzZXQiLCIkbGltaXQiLCJzb3J0Iiwic2tpcCIsImxpbWl0IiwidG90YWxDb3VudCIsImFnZ3JlZ2F0ZV8iLCJwaXBlbGluZSIsImFnZ3JlZ2F0ZSIsImRpc3RpbmN0XyIsImZpZWxkIiwiZGlzdGluY3QiLCJjb3VudF8iLCJjb3VudERvY3VtZW50cyIsImV4ZWN1dG9yIiwiY29sbGVjdGlvbiIsIm9taXQiLCJkcml2ZXJMaWIiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTTtBQUFFQSxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBO0FBQUwsSUFBb0JDLE9BQU8sQ0FBQyxVQUFELENBQWpDOztBQUNBLE1BQU07QUFBRUMsRUFBQUE7QUFBRixJQUFpQkQsT0FBTyxDQUFDLGlCQUFELENBQTlCOztBQUNBLE1BQU1FLE9BQU8sR0FBR0QsVUFBVSxDQUFDLFNBQUQsQ0FBMUI7QUFDQSxNQUFNO0FBQUVFLEVBQUFBLFdBQUY7QUFBZUMsRUFBQUE7QUFBZixJQUFnQ0YsT0FBdEM7O0FBQ0EsTUFBTUcsU0FBUyxHQUFHTCxPQUFPLENBQUMsaUJBQUQsQ0FBekI7O0FBQ0EsTUFBTU0sVUFBVSxHQUFHTixPQUFPLENBQUMsa0JBQUQsQ0FBMUI7O0FBQ0EsTUFBTTtBQUFFTyxFQUFBQSxlQUFGO0FBQW1CQyxFQUFBQTtBQUFuQixJQUFxQ1IsT0FBTyxDQUFDLG9CQUFELENBQWxEOztBQUVBLE1BQU1TLGNBQWMsR0FBRyxDQUFFLGNBQUYsRUFBa0IsTUFBbEIsRUFBMEIsTUFBMUIsRUFBa0MsTUFBbEMsRUFBMEMsTUFBMUMsRUFBa0QsU0FBbEQsRUFBNkQsTUFBN0QsRUFBcUUsY0FBckUsRUFBcUYsUUFBckYsQ0FBdkI7QUFDQSxNQUFNQyxjQUFjLEdBQUcsQ0FBRSxXQUFGLEVBQWUsTUFBZixFQUF1QixPQUF2QixFQUFnQyxPQUFoQyxFQUF5QyxVQUF6QyxDQUF2QjtBQUNBLE1BQU1DLFNBQVMsR0FBR0YsY0FBYyxDQUFDRyxNQUFmLENBQXNCRixjQUF0QixDQUFsQjs7QUFPQSxNQUFNRyxnQkFBTixTQUErQlIsU0FBL0IsQ0FBeUM7QUFNckNTLEVBQUFBLFdBQVcsQ0FBQ0MsZ0JBQUQsRUFBbUJDLE9BQW5CLEVBQTRCO0FBQ25DLFVBQU0sU0FBTixFQUFpQkQsZ0JBQWpCLEVBQW1DQyxPQUFuQzs7QUFEbUMsU0FNdkNDLFlBTnVDLEdBTXZCQyxPQUFELElBQWFBLE9BQU8sQ0FBQ0MsTUFBUixDQUFlQyxhQU5KOztBQUFBLFNBT3ZDQyxZQVB1QyxHQU92QkgsT0FBRCxJQUFhQSxPQUFPLENBQUNDLE1BQVIsQ0FBZUUsWUFQSjs7QUFBQSxTQVN2Q0MsUUFUdUMsR0FTNUIsS0FBS0MsS0FUdUI7QUFHbkMsU0FBS0MsV0FBTCxHQUFtQixLQUFLUixPQUFMLENBQWFRLFdBQWIsSUFBNEIsVUFBL0M7QUFDSDs7QUFXREMsRUFBQUEsZUFBZSxDQUFDQyxRQUFELEVBQVc7QUFDdEIsUUFBSUEsUUFBUSxDQUFDUCxNQUFULENBQWdCUSxFQUFoQixLQUF1QixDQUF2QixJQUE0QkQsUUFBUSxDQUFDUCxNQUFULENBQWdCUyxDQUFoQixLQUFzQixDQUF0RCxFQUF5RDtBQUNyRCxZQUFNLElBQUlwQixhQUFKLENBQWtCLHNDQUFsQixDQUFOO0FBQ0g7O0FBRUQsV0FBT2tCLFFBQVEsQ0FBQ0csVUFBaEI7QUFDSDs7QUFNREMsRUFBQUEsZUFBZSxDQUFDSixRQUFELEVBQVdLLGNBQVgsRUFBMkI7QUFDdEMsUUFBSUwsUUFBUSxDQUFDUCxNQUFULENBQWdCUSxFQUFoQixLQUF1QixDQUF2QixJQUE2QkksY0FBYyxJQUFJTCxRQUFRLENBQUNQLE1BQVQsQ0FBZ0JhLFNBQWhCLEtBQThCLENBQWpGLEVBQXFGO0FBQ2pGLFlBQU0sSUFBSXhCLGFBQUosQ0FBa0Isc0NBQWxCLENBQU47QUFDSDtBQUNKOztBQUtELFFBQU15QixJQUFOLEdBQWE7QUFDVCxRQUFJLEtBQUtDLE1BQUwsSUFBZSxLQUFLQSxNQUFMLENBQVlDLFdBQVosRUFBbkIsRUFBOEM7QUFDMUMsWUFBTSxLQUFLRCxNQUFMLENBQVlFLEtBQVosRUFBTjtBQUNBLFdBQUtDLEdBQUwsQ0FBUyxTQUFULEVBQXFCLDRDQUEyQyxLQUFLQyxvQ0FBTCxFQUE0QyxJQUE1RztBQUNIOztBQUVELFdBQU8sS0FBS0osTUFBWjtBQUNIOztBQVNELFFBQU1LLFFBQU4sQ0FBZXZCLE9BQWYsRUFBd0I7QUFDcEIsUUFBSSxDQUFDLEtBQUtrQixNQUFOLElBQWdCLENBQUMsS0FBS0EsTUFBTCxDQUFZQyxXQUFaLEVBQXJCLEVBQWdEO0FBQzVDLFVBQUlELE1BQU0sR0FBRyxJQUFJL0IsV0FBSixDQUFnQixLQUFLWSxnQkFBckIsRUFBdUM7QUFBQ3lCLFFBQUFBLGVBQWUsRUFBRTtBQUFsQixPQUF2QyxDQUFiO0FBQ0EsV0FBS04sTUFBTCxHQUFjLE1BQU1BLE1BQU0sQ0FBQ08sT0FBUCxFQUFwQjtBQUNBLFdBQUtKLEdBQUwsQ0FBUyxTQUFULEVBQXFCLHVDQUFzQyxLQUFLQyxvQ0FBTCxFQUE0QyxJQUF2RztBQUNIOztBQUVELFdBQU8sS0FBS0osTUFBTCxDQUFZUSxFQUFaLENBQWUsS0FBS0MsUUFBcEIsQ0FBUDtBQUNIOztBQU1ELFFBQU1DLFdBQU4sQ0FBa0JDLElBQWxCLEVBQXdCLENBQ3ZCOztBQUVELFFBQU1DLEtBQU4sR0FBYztBQUNWLFdBQU8sS0FBS0MsUUFBTCxDQUFjTCxFQUFFLElBQUk7QUFDdkIsYUFBT0EsRUFBRSxDQUFDTSxlQUFILENBQW1CLElBQW5CLEVBQXlCO0FBQUVDLFFBQUFBLFFBQVEsRUFBRTtBQUFaLE9BQXpCLEVBQTZDQyxPQUE3QyxFQUFQO0FBQ0gsS0FGTSxDQUFQO0FBR0g7O0FBRUQsUUFBTUgsUUFBTixDQUFlSSxVQUFmLEVBQTJCO0FBQ3ZCLFFBQUlULEVBQUo7O0FBRUEsUUFBSTtBQUNBQSxNQUFBQSxFQUFFLEdBQUcsTUFBTSxLQUFLSCxRQUFMLEVBQVg7QUFFQSxhQUFPLE1BQU1ZLFVBQVUsQ0FBQ1QsRUFBRCxDQUF2QjtBQUNILEtBSkQsQ0FJRSxPQUFNVSxHQUFOLEVBQVc7QUFDVCxZQUFNQSxHQUFOO0FBQ0gsS0FORCxTQU1VO0FBQ05WLE1BQUFBLEVBQUUsS0FBSSxNQUFNLEtBQUtFLFdBQUwsQ0FBaUJGLEVBQWpCLENBQVYsQ0FBRjtBQUNIO0FBQ0o7O0FBU0QsUUFBTVcsbUJBQU4sQ0FBMEJyQyxPQUExQixFQUFtQztBQUMvQixRQUFJMEIsRUFBRSxHQUFHLE1BQU0sS0FBS0gsUUFBTCxFQUFmO0FBRUEsV0FBTyxJQUFJbkMsWUFBSixDQUFpQnNDLEVBQWpCLEVBQXFCMUIsT0FBckIsQ0FBUDtBQUNIOztBQVFELFFBQU1zQyxVQUFOLENBQWlCQyxLQUFqQixFQUF3QkMsSUFBeEIsRUFBOEJ4QyxPQUE5QixFQUF1QztBQUNuQyxRQUFJLEtBQUtBLE9BQUwsQ0FBYXlDLFlBQWpCLEVBQStCO0FBQzNCLFdBQUtwQixHQUFMLENBQVMsU0FBVCxFQUFvQixnQkFBZ0JxQixJQUFJLENBQUNDLFNBQUwsQ0FBZTtBQUFDSixRQUFBQSxLQUFEO0FBQVFDLFFBQUFBLElBQVI7QUFBY3hDLFFBQUFBO0FBQWQsT0FBZixDQUFwQztBQUNIOztBQUVELFdBQU8sS0FBSzRDLGFBQUwsQ0FBbUJMLEtBQW5CLEVBQTJCTSxJQUFELElBQVVBLElBQUksQ0FBQ0MsU0FBTCxDQUFlTixJQUFmLEVBQXFCeEMsT0FBckIsQ0FBcEMsQ0FBUDtBQUNIOztBQVFELFFBQU0rQyxXQUFOLENBQWtCUixLQUFsQixFQUF5QkMsSUFBekIsRUFBK0J4QyxPQUEvQixFQUF3QztBQUNwQ0EsSUFBQUEsT0FBTyxHQUFHO0FBQUVnRCxNQUFBQSxPQUFPLEVBQUUsS0FBWDtBQUFrQixTQUFHaEQ7QUFBckIsS0FBVjs7QUFDQSxRQUFJLEtBQUtBLE9BQUwsQ0FBYXlDLFlBQWpCLEVBQStCO0FBQzNCLFdBQUtwQixHQUFMLENBQVMsU0FBVCxFQUFvQixpQkFBaUJxQixJQUFJLENBQUNDLFNBQUwsQ0FBZTtBQUFDSixRQUFBQSxLQUFEO0FBQVFVLFFBQUFBLEtBQUssRUFBRVQsSUFBSSxDQUFDVSxNQUFwQjtBQUE0QmxELFFBQUFBO0FBQTVCLE9BQWYsQ0FBckM7QUFDSDs7QUFDRCxXQUFPLEtBQUs0QyxhQUFMLENBQW1CTCxLQUFuQixFQUEyQk0sSUFBRCxJQUFVQSxJQUFJLENBQUNNLFVBQUwsQ0FBZ0JYLElBQWhCLEVBQXNCeEMsT0FBdEIsQ0FBcEMsQ0FBUDtBQUNIOztBQVFELFFBQU1vRCxvQkFBTixDQUEyQmIsS0FBM0IsRUFBa0NDLElBQWxDLEVBQXdDeEMsT0FBeEMsRUFBaUQ7QUFDN0MsUUFBSTtBQUNBLGFBQU8sTUFBTSxLQUFLc0MsVUFBTCxDQUFnQkMsS0FBaEIsRUFBdUJDLElBQXZCLEVBQTZCeEMsT0FBN0IsQ0FBYjtBQUNILEtBRkQsQ0FFRSxPQUFPcUQsS0FBUCxFQUFjO0FBQ1osVUFBSUEsS0FBSyxDQUFDQyxJQUFOLEtBQWUsS0FBbkIsRUFBMEI7QUFDdEIsZUFBTyxLQUFQO0FBQ0g7O0FBRUQsWUFBTUQsS0FBTjtBQUNIO0FBQ0o7O0FBU0QsUUFBTUUsVUFBTixDQUFpQmhCLEtBQWpCLEVBQXdCQyxJQUF4QixFQUE4QmdCLFNBQTlCLEVBQXlDeEQsT0FBekMsRUFBa0Q7QUFDOUN3QyxJQUFBQSxJQUFJLEdBQUcsS0FBS2lCLGdCQUFMLENBQXNCakIsSUFBdEIsQ0FBUDs7QUFDQSxRQUFJLEtBQUt4QyxPQUFMLENBQWF5QyxZQUFqQixFQUErQjtBQUMzQixXQUFLcEIsR0FBTCxDQUFTLFNBQVQsRUFBb0IsZ0JBQWdCcUIsSUFBSSxDQUFDQyxTQUFMLENBQWU7QUFBQ0osUUFBQUEsS0FBRDtBQUFRQyxRQUFBQSxJQUFSO0FBQWNnQixRQUFBQSxTQUFkO0FBQXlCeEQsUUFBQUE7QUFBekIsT0FBZixDQUFwQztBQUNIOztBQUNELFdBQU8sS0FBSzRDLGFBQUwsQ0FBbUJMLEtBQW5CLEVBQTJCTSxJQUFELElBQVVBLElBQUksQ0FBQ2EsU0FBTCxDQUFlRixTQUFmLEVBQTBCaEIsSUFBMUIsRUFBZ0N4QyxPQUFoQyxDQUFwQyxDQUFQO0FBQ0g7O0FBU0QsUUFBTTJELG1CQUFOLENBQTBCcEIsS0FBMUIsRUFBaUNDLElBQWpDLEVBQXVDZ0IsU0FBdkMsRUFBa0R4RCxPQUFsRCxFQUEyRDtBQUN2RCxRQUFJNEQsR0FBRyxHQUFHLE1BQU0sS0FBS0MsaUJBQUwsQ0FBdUJ0QixLQUF2QixFQUE4QkMsSUFBOUIsRUFBb0NnQixTQUFwQyxFQUErQyxFQUFFLEdBQUd4RCxPQUFMO0FBQWM4RCxNQUFBQSxNQUFNLEVBQUUsS0FBdEI7QUFBNkJDLE1BQUFBLGNBQWMsRUFBRTtBQUE3QyxLQUEvQyxDQUFoQjtBQUNBLFdBQU9ILEdBQUcsSUFBSUEsR0FBRyxDQUFDSSxLQUFsQjtBQUNIOztBQVVELFFBQU1DLFVBQU4sQ0FBaUIxQixLQUFqQixFQUF3QkMsSUFBeEIsRUFBOEJnQixTQUE5QixFQUF5Q3hELE9BQXpDLEVBQWtEa0UsWUFBbEQsRUFBZ0U7QUFDNUQsUUFBSUMsS0FBSyxHQUFHLEtBQUtWLGdCQUFMLENBQXNCakIsSUFBdEIsQ0FBWjs7QUFDQSxRQUFJO0FBQUU0QixNQUFBQSxHQUFGO0FBQU8sU0FBR0M7QUFBVixRQUFxQkYsS0FBSyxDQUFDRyxJQUFOLElBQWMsRUFBdkM7O0FBQ0EsUUFBSSxDQUFDeEYsQ0FBQyxDQUFDeUYsS0FBRixDQUFRSCxHQUFSLENBQUwsRUFBbUI7QUFDZkQsTUFBQUEsS0FBSyxDQUFDRyxJQUFOLEdBQWFELE1BQWI7QUFDQUYsTUFBQUEsS0FBSyxDQUFDSyxZQUFOLEdBQXFCO0FBQUVKLFFBQUFBO0FBQUYsT0FBckI7QUFDSDs7QUFFRCxRQUFJLENBQUN0RixDQUFDLENBQUMyRixPQUFGLENBQVVQLFlBQVYsQ0FBTCxFQUE4QjtBQUMxQkMsTUFBQUEsS0FBSyxDQUFDSyxZQUFOLEdBQXFCLEVBQUUsR0FBR0wsS0FBSyxDQUFDSyxZQUFYO0FBQXlCLFdBQUdOO0FBQTVCLE9BQXJCO0FBQ0g7O0FBRURsRSxJQUFBQSxPQUFPLEdBQUcsRUFBRSxHQUFHQSxPQUFMO0FBQWM4RCxNQUFBQSxNQUFNLEVBQUU7QUFBdEIsS0FBVjs7QUFFQSxRQUFJLEtBQUs5RCxPQUFMLENBQWF5QyxZQUFqQixFQUErQjtBQUMzQixXQUFLcEIsR0FBTCxDQUFTLFNBQVQsRUFBb0IsZ0JBQWdCcUIsSUFBSSxDQUFDQyxTQUFMLENBQWU7QUFBQ0osUUFBQUEsS0FBRDtBQUFRQyxRQUFBQSxJQUFJLEVBQUUyQixLQUFkO0FBQXFCWCxRQUFBQSxTQUFyQjtBQUFnQ3hELFFBQUFBO0FBQWhDLE9BQWYsQ0FBcEM7QUFDSDs7QUFFRCxXQUFPLEtBQUs0QyxhQUFMLENBQW1CTCxLQUFuQixFQUEyQk0sSUFBRCxJQUFVQSxJQUFJLENBQUNhLFNBQUwsQ0FBZUYsU0FBZixFQUEwQlcsS0FBMUIsRUFBaUNuRSxPQUFqQyxDQUFwQyxDQUFQO0FBQ0g7O0FBVUQsUUFBTTBFLG1CQUFOLENBQTBCbkMsS0FBMUIsRUFBaUNDLElBQWpDLEVBQXVDZ0IsU0FBdkMsRUFBa0R4RCxPQUFsRCxFQUEyRGtFLFlBQTNELEVBQXlFO0FBQ3JFLFFBQUlDLEtBQUssR0FBRyxLQUFLVixnQkFBTCxDQUFzQmpCLElBQXRCLENBQVo7O0FBQ0EsUUFBSTtBQUFFNEIsTUFBQUEsR0FBRjtBQUFPLFNBQUdDO0FBQVYsUUFBcUJGLEtBQUssQ0FBQ0csSUFBTixJQUFjLEVBQXZDOztBQUNBLFFBQUksQ0FBQ3hGLENBQUMsQ0FBQ3lGLEtBQUYsQ0FBUUgsR0FBUixDQUFMLEVBQW1CO0FBQ2ZELE1BQUFBLEtBQUssQ0FBQ0csSUFBTixHQUFhRCxNQUFiO0FBQ0FGLE1BQUFBLEtBQUssQ0FBQ0ssWUFBTixHQUFxQjtBQUFFSixRQUFBQTtBQUFGLE9BQXJCO0FBQ0g7O0FBRUQsUUFBSSxDQUFDdEYsQ0FBQyxDQUFDMkYsT0FBRixDQUFVUCxZQUFWLENBQUwsRUFBOEI7QUFDMUJDLE1BQUFBLEtBQUssQ0FBQ0ssWUFBTixHQUFxQixFQUFFLEdBQUdMLEtBQUssQ0FBQ0ssWUFBWDtBQUF5QixXQUFHTjtBQUE1QixPQUFyQjtBQUNIOztBQUVEbEUsSUFBQUEsT0FBTyxHQUFHLEVBQUUsR0FBR0EsT0FBTDtBQUFjOEQsTUFBQUEsTUFBTSxFQUFFLElBQXRCO0FBQTRCQyxNQUFBQSxjQUFjLEVBQUU7QUFBNUMsS0FBVjs7QUFFQSxRQUFJLEtBQUsvRCxPQUFMLENBQWF5QyxZQUFqQixFQUErQjtBQUMzQixXQUFLcEIsR0FBTCxDQUFTLFNBQVQsRUFBb0IsZ0JBQWdCcUIsSUFBSSxDQUFDQyxTQUFMLENBQWU7QUFBQ0osUUFBQUEsS0FBRDtBQUFRQyxRQUFBQSxJQUFJLEVBQUUyQixLQUFkO0FBQXFCWCxRQUFBQSxTQUFyQjtBQUFnQ3hELFFBQUFBO0FBQWhDLE9BQWYsQ0FBcEM7QUFDSDs7QUFFRCxRQUFJNEQsR0FBRyxHQUFHLE1BQU0sS0FBS2hCLGFBQUwsQ0FBbUJMLEtBQW5CLEVBQTJCTSxJQUFELElBQVVBLElBQUksQ0FBQzhCLGdCQUFMLENBQXNCbkIsU0FBdEIsRUFBaUNXLEtBQWpDLEVBQXdDbkUsT0FBeEMsQ0FBcEMsQ0FBaEI7QUFDQSxXQUFPNEQsR0FBRyxJQUFJQSxHQUFHLENBQUNJLEtBQWxCO0FBQ0g7O0FBVUQsUUFBTVksV0FBTixDQUFrQnJDLEtBQWxCLEVBQXlCQyxJQUF6QixFQUErQnFDLFVBQS9CLEVBQTJDN0UsT0FBM0MsRUFBb0RrRSxZQUFwRCxFQUFrRTtBQUM5RCxRQUFJWSxHQUFHLEdBQUd0QyxJQUFJLENBQUN1QyxHQUFMLENBQVNDLE1BQU0sSUFBSTtBQUN6QixVQUFJO0FBQUVaLFFBQUFBLEdBQUY7QUFBTyxXQUFHYTtBQUFWLFVBQXlCRCxNQUE3Qjs7QUFFQSxVQUFJRSxRQUFRLEdBQUcsS0FBS3pCLGdCQUFMLENBQXNCd0IsVUFBdEIsQ0FBZjs7QUFFQSxVQUFJYixHQUFKLEVBQVM7QUFDTGMsUUFBQUEsUUFBUSxDQUFDVixZQUFULEdBQXdCO0FBQUVKLFVBQUFBLEdBQUY7QUFBTyxhQUFHRjtBQUFWLFNBQXhCO0FBQ0gsT0FGRCxNQUVPLElBQUksQ0FBQ3BGLENBQUMsQ0FBQzJGLE9BQUYsQ0FBVVAsWUFBVixDQUFMLEVBQThCO0FBQ2pDZ0IsUUFBQUEsUUFBUSxDQUFDVixZQUFULEdBQXdCTixZQUF4QjtBQUNIOztBQUVELGFBQU87QUFDSFIsUUFBQUEsU0FBUyxFQUFFO0FBQUV5QixVQUFBQSxNQUFNLEVBQUUsRUFBRSxHQUFHckcsQ0FBQyxDQUFDc0csSUFBRixDQUFPSixNQUFQLEVBQWVILFVBQWY7QUFBTCxXQUFWO0FBQTZDUSxVQUFBQSxNQUFNLEVBQUVILFFBQXJEO0FBQStEcEIsVUFBQUEsTUFBTSxFQUFFO0FBQXZFO0FBRFIsT0FBUDtBQUdILEtBZFMsQ0FBVjtBQWdCQTlELElBQUFBLE9BQU8sR0FBRztBQUFFZ0QsTUFBQUEsT0FBTyxFQUFFLEtBQVg7QUFBa0IsU0FBR2hEO0FBQXJCLEtBQVY7O0FBRUEsUUFBSSxLQUFLQSxPQUFMLENBQWF5QyxZQUFqQixFQUErQjtBQUMzQixXQUFLcEIsR0FBTCxDQUFTLFNBQVQsRUFBb0IsZ0JBQWdCcUIsSUFBSSxDQUFDQyxTQUFMLENBQWU7QUFBQ0osUUFBQUEsS0FBRDtBQUFRVSxRQUFBQSxLQUFLLEVBQUU2QixHQUFHLENBQUM1QixNQUFuQjtBQUEyQmxELFFBQUFBO0FBQTNCLE9BQWYsQ0FBcEM7QUFDSDs7QUFFRCxXQUFPLEtBQUs0QyxhQUFMLENBQW1CTCxLQUFuQixFQUEyQk0sSUFBRCxJQUFVQSxJQUFJLENBQUN5QyxTQUFMLENBQWVSLEdBQWYsRUFBb0I5RSxPQUFwQixDQUFwQyxDQUFQO0FBQ0g7O0FBU0QsUUFBTXVGLG9CQUFOLENBQTJCaEQsS0FBM0IsRUFBa0NDLElBQWxDLEVBQXdDZ0IsU0FBeEMsRUFBbUR4RCxPQUFuRCxFQUE0RDtBQUN4RCxRQUFJd0YsUUFBUSxHQUFHbEcsVUFBVSxDQUFDbUcsT0FBWCxFQUFmOztBQUVBLFFBQUksS0FBS3pGLE9BQUwsQ0FBYXlDLFlBQWpCLEVBQStCO0FBQzNCLFdBQUtwQixHQUFMLENBQVMsU0FBVCxFQUFvQixpQ0FBaUNxQixJQUFJLENBQUNDLFNBQUwsQ0FBZTtBQUFDSixRQUFBQSxLQUFEO0FBQVFVLFFBQUFBLEtBQUssRUFBRVQsSUFBSSxDQUFDVSxNQUFwQjtBQUE0Qk0sUUFBQUEsU0FBNUI7QUFBdUN4RCxRQUFBQTtBQUF2QyxPQUFmLENBQXJEO0FBQ0g7O0FBRUQsV0FBTyxLQUFLNEMsYUFBTCxDQUFtQkwsS0FBbkIsRUFBMEIsTUFBT00sSUFBUCxJQUFnQjtBQUU3QyxVQUFJZSxHQUFHLEdBQUcsTUFBTWYsSUFBSSxDQUFDNkMsVUFBTCxDQUNaLEVBQUUsR0FBR2xDLFNBQUw7QUFBZ0IsU0FBQyxLQUFLaEQsV0FBTixHQUFvQjtBQUFFbUYsVUFBQUEsT0FBTyxFQUFFO0FBQVg7QUFBcEMsT0FEWSxFQUVaO0FBQUVyQixRQUFBQSxJQUFJLEVBQUUsRUFBRSxHQUFHOUIsSUFBTDtBQUFXLFdBQUMsS0FBS2hDLFdBQU4sR0FBb0JnRjtBQUEvQjtBQUFSLE9BRlksRUFHWixFQUFFLEdBQUd4RixPQUFMO0FBQWM4RCxRQUFBQSxNQUFNLEVBQUU7QUFBdEIsT0FIWSxDQUFoQjs7QUFLQSxVQUFJO0FBRUEsZUFBTyxNQUFNakIsSUFBSSxDQUFDK0MsSUFBTCxDQUFVO0FBQUUsV0FBQyxLQUFLcEYsV0FBTixHQUFvQmdGO0FBQXRCLFNBQVYsRUFBNEM7QUFBRUssVUFBQUEsVUFBVSxFQUFFO0FBQUUsYUFBQyxLQUFLckYsV0FBTixHQUFvQjtBQUF0QjtBQUFkLFNBQTVDLEVBQXVGMEIsT0FBdkYsRUFBYjtBQUNILE9BSEQsU0FHVTtBQUVOLFlBQUkwQixHQUFHLENBQUN6RCxNQUFKLENBQVdhLFNBQVgsR0FBdUIsQ0FBM0IsRUFBOEI7QUFDMUIsZ0JBQU02QixJQUFJLENBQUM2QyxVQUFMLENBQWdCO0FBQUUsYUFBQyxLQUFLbEYsV0FBTixHQUFvQmdGO0FBQXRCLFdBQWhCLEVBQWtEO0FBQUVNLFlBQUFBLE1BQU0sRUFBRTtBQUFFLGVBQUMsS0FBS3RGLFdBQU4sR0FBb0I7QUFBdEI7QUFBVixXQUFsRCxFQUEwRjtBQUFFc0QsWUFBQUEsTUFBTSxFQUFFO0FBQVYsV0FBMUYsQ0FBTjtBQUNIO0FBQ0o7QUFDSixLQWhCTSxDQUFQO0FBaUJIOztBQVNELFFBQU1pQyxxQkFBTixDQUE0QnhELEtBQTVCLEVBQW1DQyxJQUFuQyxFQUF5Q3FDLFVBQXpDLEVBQXFEN0UsT0FBckQsRUFBOEQ7QUFDMURnRyxJQUFBQSxPQUFPLENBQUMzRSxHQUFSLENBQVksY0FBWjtBQUNBLFFBQUl5RCxHQUFHLEdBQUd0QyxJQUFJLENBQUN1QyxHQUFMLENBQVNDLE1BQU0sS0FBSztBQUMxQnRCLE1BQUFBLFNBQVMsRUFBRTtBQUFFeUIsUUFBQUEsTUFBTSxFQUFFLEVBQUUsR0FBR3JHLENBQUMsQ0FBQ3NHLElBQUYsQ0FBT0osTUFBUCxFQUFlSCxVQUFmO0FBQUwsU0FBVjtBQUE2Q1EsUUFBQUEsTUFBTSxFQUFFO0FBQUViLFVBQUFBLFlBQVksRUFBRVE7QUFBaEIsU0FBckQ7QUFBK0VsQixRQUFBQSxNQUFNLEVBQUU7QUFBdkY7QUFEZSxLQUFMLENBQWYsQ0FBVjtBQUlBLFdBQU8sS0FBS2xCLGFBQUwsQ0FBbUJMLEtBQW5CLEVBQTJCTSxJQUFELElBQVVBLElBQUksQ0FBQ3lDLFNBQUwsQ0FBZVIsR0FBZixFQUFvQjtBQUFFOUIsTUFBQUEsT0FBTyxFQUFFLEtBQVg7QUFBa0IsU0FBR2hEO0FBQXJCLEtBQXBCLENBQXBDLENBQVA7QUFDSDs7QUFTRCxRQUFNaUcsV0FBTixDQUFrQjFELEtBQWxCLEVBQXlCQyxJQUF6QixFQUErQmdCLFNBQS9CLEVBQTBDeEQsT0FBMUMsRUFBbUQ7QUFDL0N3QyxJQUFBQSxJQUFJLEdBQUcsS0FBS2lCLGdCQUFMLENBQXNCakIsSUFBdEIsQ0FBUDs7QUFDQSxRQUFJLEtBQUt4QyxPQUFMLENBQWF5QyxZQUFqQixFQUErQjtBQUMzQixXQUFLcEIsR0FBTCxDQUFTLFNBQVQsRUFBb0IsaUJBQWlCcUIsSUFBSSxDQUFDQyxTQUFMLENBQWU7QUFBQ0osUUFBQUEsS0FBRDtBQUFRVSxRQUFBQSxLQUFLLEVBQUVULElBQUksQ0FBQ1UsTUFBcEI7QUFBNEJNLFFBQUFBLFNBQTVCO0FBQXVDeEQsUUFBQUE7QUFBdkMsT0FBZixDQUFyQztBQUNIOztBQUVELFdBQU8sS0FBSzRDLGFBQUwsQ0FBbUJMLEtBQW5CLEVBQTJCTSxJQUFELElBQVVBLElBQUksQ0FBQzZDLFVBQUwsQ0FBZ0JsQyxTQUFoQixFQUEyQmhCLElBQTNCLEVBQWlDeEMsT0FBakMsQ0FBcEMsQ0FBUDtBQUNIOztBQVFELFFBQU1rRyxXQUFOLENBQWtCM0QsS0FBbEIsRUFBeUJDLElBQXpCLEVBQStCZ0IsU0FBL0IsRUFBMEN4RCxPQUExQyxFQUFtRDtBQUMvQyxRQUFJLEtBQUtBLE9BQUwsQ0FBYXlDLFlBQWpCLEVBQStCO0FBQzNCLFdBQUtwQixHQUFMLENBQVMsU0FBVCxFQUFvQixpQkFBaUJxQixJQUFJLENBQUNDLFNBQUwsQ0FBZTtBQUFDSixRQUFBQSxLQUFEO0FBQVFDLFFBQUFBLElBQVI7QUFBY2dCLFFBQUFBLFNBQWQ7QUFBeUJ4RCxRQUFBQTtBQUF6QixPQUFmLENBQXJDO0FBQ0g7O0FBRUQsV0FBTyxLQUFLNEMsYUFBTCxDQUFtQkwsS0FBbkIsRUFBMkJNLElBQUQsSUFBVUEsSUFBSSxDQUFDc0QsVUFBTCxDQUFnQjNDLFNBQWhCLEVBQTJCaEIsSUFBM0IsRUFBaUN4QyxPQUFqQyxDQUFwQyxDQUFQO0FBQ0g7O0FBUUQsUUFBTW9HLFVBQU4sQ0FBaUI3RCxLQUFqQixFQUF3QmlCLFNBQXhCLEVBQW1DeEQsT0FBbkMsRUFBNEM7QUFDeEMsUUFBSSxLQUFLQSxPQUFMLENBQWF5QyxZQUFqQixFQUErQjtBQUMzQixXQUFLcEIsR0FBTCxDQUFTLFNBQVQsRUFBb0IsZ0JBQWdCcUIsSUFBSSxDQUFDQyxTQUFMLENBQWU7QUFBQ0osUUFBQUEsS0FBRDtBQUFRaUIsUUFBQUEsU0FBUjtBQUFtQnhELFFBQUFBO0FBQW5CLE9BQWYsQ0FBcEM7QUFDSDs7QUFFRCxXQUFPLEtBQUs0QyxhQUFMLENBQW1CTCxLQUFuQixFQUEyQk0sSUFBRCxJQUFVQSxJQUFJLENBQUN3RCxTQUFMLENBQWU3QyxTQUFmLEVBQTBCeEQsT0FBMUIsQ0FBcEMsQ0FBUDtBQUNIOztBQVFELFFBQU1zRyxXQUFOLENBQWtCL0QsS0FBbEIsRUFBeUJpQixTQUF6QixFQUFvQ3hELE9BQXBDLEVBQTZDO0FBQ3pDLFFBQUksS0FBS0EsT0FBTCxDQUFheUMsWUFBakIsRUFBK0I7QUFDM0IsV0FBS3BCLEdBQUwsQ0FBUyxTQUFULEVBQW9CLGlCQUFpQnFCLElBQUksQ0FBQ0MsU0FBTCxDQUFlO0FBQUNKLFFBQUFBLEtBQUQ7QUFBUWlCLFFBQUFBLFNBQVI7QUFBbUJ4RCxRQUFBQTtBQUFuQixPQUFmLENBQXJDO0FBQ0g7O0FBQ0QsV0FBTyxLQUFLNEMsYUFBTCxDQUFtQkwsS0FBbkIsRUFBMkJNLElBQUQsSUFBVUEsSUFBSSxDQUFDMEQsVUFBTCxDQUFnQi9DLFNBQWhCLEVBQTJCeEQsT0FBM0IsQ0FBcEMsQ0FBUDtBQUNIOztBQVFELFFBQU13RyxrQkFBTixDQUF5QmpFLEtBQXpCLEVBQWdDQyxJQUFoQyxFQUFzQ2dCLFNBQXRDLEVBQWlEeEQsT0FBakQsRUFBMEQ7QUFDdEQsUUFBSSxLQUFLQSxPQUFMLENBQWF5QyxZQUFqQixFQUErQjtBQUMzQixXQUFLcEIsR0FBTCxDQUFTLFNBQVQsRUFBb0Isd0JBQXdCcUIsSUFBSSxDQUFDQyxTQUFMLENBQWU7QUFBQ0osUUFBQUEsS0FBRDtBQUFRQyxRQUFBQSxJQUFSO0FBQWN4QyxRQUFBQTtBQUFkLE9BQWYsQ0FBNUM7QUFDSDs7QUFDRCxXQUFPLEtBQUs0QyxhQUFMLENBQW1CTCxLQUFuQixFQUEyQk0sSUFBRCxJQUFVQSxJQUFJLENBQUM0RCxpQkFBTCxDQUF1QmpELFNBQXZCLEVBQWtDaEIsSUFBbEMsRUFBd0N4QyxPQUF4QyxDQUFwQyxDQUFQO0FBQ0g7O0FBUUQsUUFBTTZELGlCQUFOLENBQXdCdEIsS0FBeEIsRUFBK0JDLElBQS9CLEVBQXFDZ0IsU0FBckMsRUFBZ0R4RCxPQUFoRCxFQUF5RDtBQUNyRHdDLElBQUFBLElBQUksR0FBRyxLQUFLaUIsZ0JBQUwsQ0FBc0JqQixJQUF0QixDQUFQOztBQUNBLFFBQUksS0FBS3hDLE9BQUwsQ0FBYXlDLFlBQWpCLEVBQStCO0FBQzNCLFdBQUtwQixHQUFMLENBQVMsU0FBVCxFQUFvQix1QkFBdUJxQixJQUFJLENBQUNDLFNBQUwsQ0FBZTtBQUFDSixRQUFBQSxLQUFEO0FBQVFDLFFBQUFBLElBQVI7QUFBY2dCLFFBQUFBLFNBQWQ7QUFBeUJ4RCxRQUFBQTtBQUF6QixPQUFmLENBQTNDO0FBQ0g7O0FBQ0QsV0FBTyxLQUFLNEMsYUFBTCxDQUFtQkwsS0FBbkIsRUFBMkJNLElBQUQsSUFBVUEsSUFBSSxDQUFDOEIsZ0JBQUwsQ0FBc0JuQixTQUF0QixFQUFpQ2hCLElBQWpDLEVBQXVDeEMsT0FBdkMsQ0FBcEMsQ0FBUDtBQUNIOztBQUVELFFBQU0wRyxpQkFBTixDQUF3Qm5FLEtBQXhCLEVBQStCaUIsU0FBL0IsRUFBMEN4RCxPQUExQyxFQUFtRDtBQUMvQyxRQUFJLEtBQUtBLE9BQUwsQ0FBYXlDLFlBQWpCLEVBQStCO0FBQzNCLFdBQUtwQixHQUFMLENBQVMsU0FBVCxFQUFvQix1QkFBdUJxQixJQUFJLENBQUNDLFNBQUwsQ0FBZTtBQUFDSixRQUFBQSxLQUFEO0FBQVFpQixRQUFBQSxTQUFSO0FBQW1CeEQsUUFBQUE7QUFBbkIsT0FBZixDQUEzQztBQUNIOztBQUNELFdBQU8sS0FBSzRDLGFBQUwsQ0FBbUJMLEtBQW5CLEVBQTJCTSxJQUFELElBQVVBLElBQUksQ0FBQzhELGdCQUFMLENBQXNCbkQsU0FBdEIsRUFBaUN4RCxPQUFqQyxDQUFwQyxDQUFQO0FBQ0g7O0FBRUQsUUFBTTRHLFFBQU4sQ0FBZXJFLEtBQWYsRUFBc0JpQixTQUF0QixFQUFpQ3hELE9BQWpDLEVBQTBDO0FBQ3RDLFFBQUk2RyxZQUFZLEdBQUcsRUFBQyxHQUFHN0c7QUFBSixLQUFuQjtBQUNBLFFBQUk4RyxLQUFKOztBQUVBLFFBQUksQ0FBQ2hJLENBQUMsQ0FBQzJGLE9BQUYsQ0FBVWpCLFNBQVYsQ0FBTCxFQUEyQjtBQUN2QixVQUFJO0FBQUV1RCxRQUFBQSxXQUFGO0FBQWVDLFFBQUFBLE1BQWY7QUFBdUIsV0FBRzNDO0FBQTFCLFVBQXFDYixTQUF6Qzs7QUFFQSxVQUFJdUQsV0FBSixFQUFpQjtBQUNiRixRQUFBQSxZQUFZLENBQUNoQixVQUFiLEdBQTBCa0IsV0FBMUI7QUFDSDs7QUFFREQsTUFBQUEsS0FBSyxHQUFHLEVBQUUsR0FBR3pDLE1BQUw7QUFBYSxXQUFHMkM7QUFBaEIsT0FBUjtBQUNILEtBUkQsTUFRTztBQUNILFlBQU0sSUFBSXpILGVBQUosQ0FBb0IsNkNBQXBCLENBQU47QUFDSDs7QUFFRCxRQUFJLEtBQUtTLE9BQUwsQ0FBYXlDLFlBQWpCLEVBQStCO0FBQzNCLFdBQUtwQixHQUFMLENBQVMsU0FBVCxFQUFvQixjQUFjcUIsSUFBSSxDQUFDQyxTQUFMLENBQWU7QUFBQ0osUUFBQUEsS0FBRDtBQUFRaUIsUUFBQUEsU0FBUyxFQUFFc0QsS0FBbkI7QUFBMEI5RyxRQUFBQSxPQUFPLEVBQUU2RztBQUFuQyxPQUFmLENBQWxDO0FBQ0g7O0FBRUQsV0FBTyxLQUFLakUsYUFBTCxDQUFtQkwsS0FBbkIsRUFBMkJNLElBQUQsSUFBVUEsSUFBSSxDQUFDb0UsT0FBTCxDQUFhSCxLQUFiLEVBQW9CRCxZQUFwQixDQUFwQyxDQUFQO0FBQ0g7O0FBUUQsUUFBTXRHLEtBQU4sQ0FBWWdDLEtBQVosRUFBbUJpQixTQUFuQixFQUE4QnhELE9BQTlCLEVBQXVDO0FBQ25DLFFBQUk2RyxZQUFZLEdBQUcsRUFBQyxHQUFHN0c7QUFBSixLQUFuQjtBQUNBLFFBQUk4RyxLQUFKLEVBQVdJLGlCQUFYOztBQUVBLFFBQUksQ0FBQ3BJLENBQUMsQ0FBQzJGLE9BQUYsQ0FBVWpCLFNBQVYsQ0FBTCxFQUEyQjtBQUN2QixVQUFJO0FBQUV1RCxRQUFBQSxXQUFGO0FBQWVJLFFBQUFBLFdBQWY7QUFBNEJDLFFBQUFBLFFBQTVCO0FBQXNDQyxRQUFBQSxPQUF0QztBQUErQ0MsUUFBQUEsTUFBL0M7QUFBdUROLFFBQUFBLE1BQXZEO0FBQStELFdBQUczQztBQUFsRSxVQUE2RWIsU0FBakY7O0FBRUEsVUFBSXVELFdBQUosRUFBaUI7QUFDYkYsUUFBQUEsWUFBWSxDQUFDaEIsVUFBYixHQUEwQmtCLFdBQTFCO0FBQ0g7O0FBRUQsVUFBSUssUUFBSixFQUFjO0FBQ1ZQLFFBQUFBLFlBQVksQ0FBQ1UsSUFBYixHQUFvQkgsUUFBcEI7QUFDSDs7QUFFRCxVQUFJQyxPQUFKLEVBQWE7QUFDVFIsUUFBQUEsWUFBWSxDQUFDVyxJQUFiLEdBQW9CSCxPQUFwQjtBQUNIOztBQUVELFVBQUlDLE1BQUosRUFBWTtBQUNSVCxRQUFBQSxZQUFZLENBQUNZLEtBQWIsR0FBcUJILE1BQXJCO0FBQ0g7O0FBRURSLE1BQUFBLEtBQUssR0FBRyxFQUFFLEdBQUd6QyxNQUFMO0FBQWEsV0FBRzJDO0FBQWhCLE9BQVI7QUFDQUUsTUFBQUEsaUJBQWlCLEdBQUdDLFdBQXBCO0FBQ0gsS0FyQkQsTUFxQk87QUFDSEwsTUFBQUEsS0FBSyxHQUFHLEVBQVI7QUFDQUksTUFBQUEsaUJBQWlCLEdBQUcsS0FBcEI7QUFDSDs7QUFFRCxRQUFJLEtBQUtsSCxPQUFMLENBQWF5QyxZQUFqQixFQUErQjtBQUMzQixXQUFLcEIsR0FBTCxDQUFTLFNBQVQsRUFBb0IsV0FBV3FCLElBQUksQ0FBQ0MsU0FBTCxDQUFlO0FBQUNKLFFBQUFBLEtBQUQ7QUFBUWlCLFFBQUFBLFNBQVMsRUFBRXNELEtBQW5CO0FBQTBCOUcsUUFBQUEsT0FBTyxFQUFFNkc7QUFBbkMsT0FBZixDQUEvQjtBQUNIOztBQUVELFdBQU8sS0FBS2pFLGFBQUwsQ0FBbUJMLEtBQW5CLEVBQTBCLE1BQU1NLElBQU4sSUFBYztBQUMzQyxVQUFJMUMsTUFBTSxHQUFHLE1BQU0wQyxJQUFJLENBQUMrQyxJQUFMLENBQVVrQixLQUFWLEVBQWlCRCxZQUFqQixFQUErQjNFLE9BQS9CLEVBQW5COztBQUVBLFVBQUlnRixpQkFBSixFQUF1QjtBQUNuQixZQUFJUSxVQUFVLEdBQUcsTUFBTTdFLElBQUksQ0FBQytDLElBQUwsQ0FBVWtCLEtBQVYsRUFBaUI3RCxLQUFqQixFQUF2QjtBQUNBLGVBQU8sQ0FBRTlDLE1BQUYsRUFBVXVILFVBQVYsQ0FBUDtBQUNIOztBQUVELGFBQU92SCxNQUFQO0FBQ0gsS0FUTSxDQUFQO0FBVUg7O0FBRUQsUUFBTXdILFVBQU4sQ0FBaUJwRixLQUFqQixFQUF3QnFGLFFBQXhCLEVBQWtDNUgsT0FBbEMsRUFBMkM7QUFDdkMsUUFBSSxLQUFLQSxPQUFMLENBQWF5QyxZQUFqQixFQUErQjtBQUMzQixXQUFLcEIsR0FBTCxDQUFTLFNBQVQsRUFBb0IsZ0JBQWdCcUIsSUFBSSxDQUFDQyxTQUFMLENBQWU7QUFBQ0osUUFBQUEsS0FBRDtBQUFRcUYsUUFBQUEsUUFBUjtBQUFrQjVILFFBQUFBO0FBQWxCLE9BQWYsQ0FBcEM7QUFDSDs7QUFDRCxXQUFPLEtBQUs0QyxhQUFMLENBQW1CTCxLQUFuQixFQUEyQk0sSUFBRCxJQUFVQSxJQUFJLENBQUNnRixTQUFMLENBQWVELFFBQWYsRUFBeUI1SCxPQUF6QixFQUFrQ2tDLE9BQWxDLEVBQXBDLENBQVA7QUFDSDs7QUFFRCxRQUFNNEYsU0FBTixDQUFnQnZGLEtBQWhCLEVBQXVCd0YsS0FBdkIsRUFBOEJqQixLQUE5QixFQUFxQzlHLE9BQXJDLEVBQThDO0FBQzFDLFFBQUksS0FBS0EsT0FBTCxDQUFheUMsWUFBakIsRUFBK0I7QUFDM0IsV0FBS3BCLEdBQUwsQ0FBUyxTQUFULEVBQW9CLGVBQWVxQixJQUFJLENBQUNDLFNBQUwsQ0FBZTtBQUFDSixRQUFBQSxLQUFEO0FBQVF3RixRQUFBQSxLQUFSO0FBQWVqQixRQUFBQSxLQUFmO0FBQXNCOUcsUUFBQUE7QUFBdEIsT0FBZixDQUFuQztBQUNIOztBQUNELFdBQU8sS0FBSzRDLGFBQUwsQ0FBbUJMLEtBQW5CLEVBQTJCTSxJQUFELElBQVVBLElBQUksQ0FBQ21GLFFBQUwsQ0FBY0QsS0FBZCxFQUFxQmpCLEtBQXJCLEVBQTRCOUcsT0FBNUIsQ0FBcEMsQ0FBUDtBQUNIOztBQUVELFFBQU1pSSxNQUFOLENBQWExRixLQUFiLEVBQW9CdUUsS0FBcEIsRUFBMkI5RyxPQUEzQixFQUFvQztBQUNoQyxRQUFJLEtBQUtBLE9BQUwsQ0FBYXlDLFlBQWpCLEVBQStCO0FBQzNCLFdBQUtwQixHQUFMLENBQVMsU0FBVCxFQUFvQixZQUFZcUIsSUFBSSxDQUFDQyxTQUFMLENBQWU7QUFBQ0osUUFBQUEsS0FBRDtBQUFRdUUsUUFBQUEsS0FBUjtBQUFlOUcsUUFBQUE7QUFBZixPQUFmLENBQWhDO0FBQ0g7O0FBQ0QsV0FBTyxLQUFLNEMsYUFBTCxDQUFtQkwsS0FBbkIsRUFBMkJNLElBQUQsSUFBVUEsSUFBSSxDQUFDcUYsY0FBTCxDQUFvQnBCLEtBQXBCLEVBQTJCOUcsT0FBM0IsQ0FBcEMsQ0FBUDtBQUNIOztBQUVELFFBQU00QyxhQUFOLENBQW9CTCxLQUFwQixFQUEyQjRGLFFBQTNCLEVBQXFDO0FBQ2pDLFdBQU8sS0FBS3BHLFFBQUwsQ0FBY0wsRUFBRSxJQUFJeUcsUUFBUSxDQUFDekcsRUFBRSxDQUFDMEcsVUFBSCxDQUFjN0YsS0FBZCxDQUFELENBQTVCLENBQVA7QUFDSDs7QUFFRGtCLEVBQUFBLGdCQUFnQixDQUFDNEIsTUFBRCxFQUFTO0FBQ3JCLFFBQUlQLEdBQUcsR0FBR2hHLENBQUMsQ0FBQ3NHLElBQUYsQ0FBT0MsTUFBUCxFQUFlMUYsU0FBZixDQUFWOztBQUNBLFFBQUkwRSxNQUFNLEdBQUd2RixDQUFDLENBQUN1SixJQUFGLENBQU9oRCxNQUFQLEVBQWUxRixTQUFmLENBQWI7O0FBRUEsUUFBSW1GLEdBQUcsQ0FBQ1IsSUFBUixFQUFjO0FBQ1ZRLE1BQUFBLEdBQUcsQ0FBQ1IsSUFBSixHQUFXLEVBQUUsR0FBR1EsR0FBRyxDQUFDUixJQUFUO0FBQWUsV0FBR0Q7QUFBbEIsT0FBWDtBQUNILEtBRkQsTUFFTyxJQUFJLENBQUN2RixDQUFDLENBQUMyRixPQUFGLENBQVVKLE1BQVYsQ0FBTCxFQUF3QjtBQUMzQlMsTUFBQUEsR0FBRyxDQUFDUixJQUFKLEdBQVdELE1BQVg7QUFDSDs7QUFFRCxXQUFPUyxHQUFQO0FBQ0g7O0FBN2dCb0M7O0FBZ2hCekNqRixnQkFBZ0IsQ0FBQ3lJLFNBQWpCLEdBQTZCcEosT0FBN0I7QUFFQXFKLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjNJLGdCQUFqQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHsgXywgd2FpdFVudGlsXyB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgdHJ5UmVxdWlyZSB9ID0gcmVxdWlyZSgnLi4vLi4vdXRpbHMvbGliJyk7XG5jb25zdCBtb25nb2RiID0gdHJ5UmVxdWlyZSgnbW9uZ29kYicpO1xuY29uc3QgeyBNb25nb0NsaWVudCwgR3JpZEZTQnVja2V0IH0gPSBtb25nb2RiO1xuY29uc3QgQ29ubmVjdG9yID0gcmVxdWlyZSgnLi4vLi4vQ29ubmVjdG9yJyk7XG5jb25zdCBHZW5lcmF0b3JzID0gcmVxdWlyZSgnLi4vLi4vR2VuZXJhdG9ycycpO1xuY29uc3QgeyBJbnZhbGlkQXJndW1lbnQsIERhdGFiYXNlRXJyb3IgfSA9IHJlcXVpcmUoJy4uLy4uL3V0aWxzL0Vycm9ycycpO1xuXG5jb25zdCBVcGRhdGVPcHNGaWVsZCA9IFsgJyRjdXJyZW50RGF0ZScsICckaW5jJywgJyRtaW4nLCAnJG1heCcsICckbXVsJywgJyRyZW5hbWUnLCAnJHNldCcsICckc2V0T25JbnNlcnQnLCAnJHVuc2V0JyBdO1xuY29uc3QgVXBkYXRlT3BzQXJyYXkgPSBbICckYWRkVG9TZXQnLCAnJHBvcCcsICckcHVsbCcsICckcHVzaCcsICckcHVsbEFsbCcgXTtcbmNvbnN0IFVwZGF0ZU9wcyA9IFVwZGF0ZU9wc0ZpZWxkLmNvbmNhdChVcGRhdGVPcHNBcnJheSk7XG5cbi8qKlxuICogTW9uZ29kYiBkYXRhIHN0b3JhZ2UgY29ubmVjdG9yLlxuICogQGNsYXNzXG4gKiBAZXh0ZW5kcyBDb25uZWN0b3JcbiAqL1xuY2xhc3MgTW9uZ29kYkNvbm5lY3RvciBleHRlbmRzIENvbm5lY3RvciB7XG4gICAgLyoqICAgICAgICAgIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIFxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW29wdGlvbnMudXNlUHJlcGFyZWRTdGF0ZW1lbnRdIC0gXG4gICAgICovXG4gICAgY29uc3RydWN0b3IoY29ubmVjdGlvblN0cmluZywgb3B0aW9ucykgeyAgICAgICAgXG4gICAgICAgIHN1cGVyKCdtb25nb2RiJywgY29ubmVjdGlvblN0cmluZywgb3B0aW9ucyk7ICAgIFxuICAgICAgICBcbiAgICAgICAgdGhpcy5sb2NrZXJGaWVsZCA9IHRoaXMub3B0aW9ucy5sb2NrZXJGaWVsZCB8fCAnX19sb2NrX18nO1xuICAgIH1cblxuICAgIHVwZGF0ZWRDb3VudCA9IChjb250ZXh0KSA9PiBjb250ZXh0LnJlc3VsdC5tb2RpZmllZENvdW50O1xuICAgIGRlbGV0ZWRDb3VudCA9IChjb250ZXh0KSA9PiBjb250ZXh0LnJlc3VsdC5kZWxldGVkQ291bnQ7XG5cbiAgICBmaW5kQWxsXyA9IHRoaXMuZmluZF87XG5cbiAgICAvKipcbiAgICAgKiBUaHJvdyBkYiBlcnJvciBpZiBubyByZWNvcmQgaW5zZXJ0ZWRcbiAgICAgKiBAcGFyYW0ge2luc2VydE9uZVdyaXRlT3BSZXN1bHRPYmplY3R9IG9wUmV0dXJuIFxuICAgICAqL1xuICAgIGVuc3VyZUluc2VydE9uZShvcFJldHVybikge1xuICAgICAgICBpZiAob3BSZXR1cm4ucmVzdWx0Lm9rICE9PSAxIHx8IG9wUmV0dXJuLnJlc3VsdC5uICE9PSAxKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRGF0YWJhc2VFcnJvcignTW9uZ29kYiBcImluc2VydE9uZVwiIG9wZXJhdGlvbiBmYWlsZWQnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBvcFJldHVybi5pbnNlcnRlZElkO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRocm93IGRiIGVycm9yIGlmIG5vIHJlY29yZCB1cGRhdGVkXG4gICAgICogQHBhcmFtIHt1cGRhdGVXcml0ZU9wUmVzdWx0T2JqZWN0fSBvcFJldHVybiBcbiAgICAgKi9cbiAgICBlbnN1cmVVcGRhdGVPbmUob3BSZXR1cm4sIGVuZm9yY2VVcGRhdGVkKSB7XG4gICAgICAgIGlmIChvcFJldHVybi5yZXN1bHQub2sgIT09IDEgfHwgKGVuZm9yY2VVcGRhdGVkICYmIG9wUmV0dXJuLnJlc3VsdC5uTW9kaWZpZWQgIT09IDEpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRGF0YWJhc2VFcnJvcignTW9uZ29kYiBcInVwZGF0ZU9uZVwiIG9wZXJhdGlvbiBmYWlsZWQnKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENsb3NlIGFsbCBjb25uZWN0aW9uIGluaXRpYXRlZCBieSB0aGlzIGNvbm5lY3Rvci5cbiAgICAgKi9cbiAgICBhc3luYyBlbmRfKCkge1xuICAgICAgICBpZiAodGhpcy5jbGllbnQgJiYgdGhpcy5jbGllbnQuaXNDb25uZWN0ZWQoKSkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5jbGllbnQuY2xvc2UoKTtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYG1vbmdvZGI6IHN1Y2Nlc3NmdWxseSBkaXNjb25uZWN0ZWQgZnJvbSBcIiR7dGhpcy5nZXRDb25uZWN0aW9uU3RyaW5nV2l0aG91dENyZWRlbnRpYWwoKX1cIi5gKTsgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgIH1cblxuICAgICAgICBkZWxldGUgdGhpcy5jbGllbnQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgZGF0YWJhc2UgY29ubmVjdGlvbiBiYXNlZCBvbiB0aGUgZGVmYXVsdCBjb25uZWN0aW9uIHN0cmluZyBvZiB0aGUgY29ubmVjdG9yIGFuZCBnaXZlbiBvcHRpb25zLiAgICAgXG4gICAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXSAtIEV4dHJhIG9wdGlvbnMgZm9yIHRoZSBjb25uZWN0aW9uLCBvcHRpb25hbC5cbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtvcHRpb25zLm11bHRpcGxlU3RhdGVtZW50cz1mYWxzZV0gLSBBbGxvdyBydW5uaW5nIG11bHRpcGxlIHN0YXRlbWVudHMgYXQgYSB0aW1lLlxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbH0gW29wdGlvbnMuY3JlYXRlRGF0YWJhc2U9ZmFsc2VdIC0gRmxhZyB0byB1c2VkIHdoZW4gY3JlYXRpbmcgYSBkYXRhYmFzZS5cbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZS48RGI+fVxuICAgICAqL1xuICAgIGFzeW5jIGNvbm5lY3RfKG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKCF0aGlzLmNsaWVudCB8fCAhdGhpcy5jbGllbnQuaXNDb25uZWN0ZWQoKSkge1xuICAgICAgICAgICAgbGV0IGNsaWVudCA9IG5ldyBNb25nb0NsaWVudCh0aGlzLmNvbm5lY3Rpb25TdHJpbmcsIHt1c2VOZXdVcmxQYXJzZXI6IHRydWV9KTtcbiAgICAgICAgICAgIHRoaXMuY2xpZW50ID0gYXdhaXQgY2xpZW50LmNvbm5lY3QoKTsgXG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGBtb25nb2RiOiBzdWNjZXNzZnVsbHkgY29ubmVjdGVkIHRvIFwiJHt0aGlzLmdldENvbm5lY3Rpb25TdHJpbmdXaXRob3V0Q3JlZGVudGlhbCgpfVwiLmApOyAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgfSAgICAgICBcblxuICAgICAgICByZXR1cm4gdGhpcy5jbGllbnQuZGIodGhpcy5kYXRhYmFzZSk7XG4gICAgfVxuICAgIFxuICAgIC8qKlxuICAgICAqIENsb3NlIGEgZGF0YWJhc2UgY29ubmVjdGlvbi5cbiAgICAgKiBAcGFyYW0ge0RifSBjb25uIC0gTXlTUUwgY29ubmVjdGlvbi5cbiAgICAgKi9cbiAgICBhc3luYyBkaXNjb25uZWN0Xyhjb25uKSB7XG4gICAgfVxuXG4gICAgYXN5bmMgcGluZ18oKSB7ICBcbiAgICAgICAgcmV0dXJuIHRoaXMuZXhlY3V0ZV8oZGIgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGRiLmxpc3RDb2xsZWN0aW9ucyhudWxsLCB7IG5hbWVPbmx5OiB0cnVlIH0pLnRvQXJyYXkoKTtcbiAgICAgICAgfSk7ICBcbiAgICB9XG5cbiAgICBhc3luYyBleGVjdXRlXyhkYkV4ZWN1dG9yKSB7XG4gICAgICAgIGxldCBkYjtcbiAgICBcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGRiID0gYXdhaXQgdGhpcy5jb25uZWN0XygpO1xuXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgZGJFeGVjdXRvcihkYik7XG4gICAgICAgIH0gY2F0Y2goZXJyKSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICBkYiAmJiBhd2FpdCB0aGlzLmRpc2Nvbm5lY3RfKGRiKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbb3B0aW9uc10gLSBPcHRpb25hbCBzZXR0aW5ncy5cbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuYnVja2V0TmFtZT0nZnMnXSAtIFRoZSAnZmlsZXMnIGFuZCAnY2h1bmtzJyBjb2xsZWN0aW9ucyB3aWxsIGJlIHByZWZpeGVkIHdpdGggdGhlIGJ1Y2tldCBuYW1lIGZvbGxvd2VkIGJ5IGEgZG90LlxuICAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBbb3B0aW9ucy5jaHVua1NpemVCeXRlc10gLSBOdW1iZXIgb2YgYnl0ZXMgc3RvcmVkIGluIGVhY2ggY2h1bmsuIERlZmF1bHRzIHRvIDI1NUtCXG4gICAgICogQHByb3BlcnR5IHtvYmplY3R9IFtvcHRpb25zLndyaXRlQ29uY2Vybl1cbiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gW29wdGlvbnMucmVhZFByZWZlcmVuY2VdXG4gICAgICovXG4gICAgYXN5bmMgY3JlYXRlR3JpZEZTQnVja2V0XyhvcHRpb25zKSB7XG4gICAgICAgIGxldCBkYiA9IGF3YWl0IHRoaXMuY29ubmVjdF8oKTtcblxuICAgICAgICByZXR1cm4gbmV3IEdyaWRGU0J1Y2tldChkYiwgb3B0aW9ucyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgbmV3IGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGluc2VydE9uZV8obW9kZWwsIGRhdGEsIG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ2luc2VydE9uZTogJyArIEpTT04uc3RyaW5naWZ5KHttb2RlbCwgZGF0YSwgb3B0aW9uc30pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmluc2VydE9uZShkYXRhLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGFuIGFycmF5IG9mIG5ldyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7YXJyYXl9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGluc2VydE1hbnlfKG1vZGVsLCBkYXRhLCBvcHRpb25zKSB7XG4gICAgICAgIG9wdGlvbnMgPSB7IG9yZGVyZWQ6IGZhbHNlLCAuLi5vcHRpb25zIH07XG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdpbnNlcnRNYW55OiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBjb3VudDogZGF0YS5sZW5ndGgsIG9wdGlvbnN9KSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuaW5zZXJ0TWFueShkYXRhLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgbmV3IGVudGl0eSBpZiBub3QgZXhpc3QuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgaW5zZXJ0T25lSWZOb3RFeGlzdF8obW9kZWwsIGRhdGEsIG9wdGlvbnMpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCB0aGlzLmluc2VydE9uZV8obW9kZWwsIGRhdGEsIG9wdGlvbnMpXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBpZiAoZXJyb3IuY29kZSA9PT0gMTEwMDApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIGFuIGV4aXN0aW5nIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIHVwZGF0ZU9uZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykgeyBcbiAgICAgICAgZGF0YSA9IHRoaXMuX3RyYW5zbGF0ZVVwZGF0ZShkYXRhKTtcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ3VwZGF0ZU9uZTogJyArIEpTT04uc3RyaW5naWZ5KHttb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zfSkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLnVwZGF0ZU9uZShjb25kaXRpb24sIGRhdGEsIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgYW4gZXhpc3RpbmcgZW50aXR5IGFuZCByZXR1cm4gdGhlIHVwZGF0ZWQgcmVjb3JkLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0geyp9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIHVwZGF0ZU9uZUFuZFJldHVybl8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykgeyAgICAgICAgICAgIFxuICAgICAgICBsZXQgcmV0ID0gYXdhaXQgdGhpcy5maW5kT25lQW5kVXBkYXRlXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCB7IC4uLm9wdGlvbnMsIHVwc2VydDogZmFsc2UsIHJldHVybk9yaWdpbmFsOiBmYWxzZSB9KTtcbiAgICAgICAgcmV0dXJuIHJldCAmJiByZXQudmFsdWU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIGFuIGV4aXN0aW5nIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhT25JbnNlcnQgLSBTaGFyZWQgZGF0YSBvbiBpbnNlcnRcbiAgICAgKi9cbiAgICBhc3luYyB1cHNlcnRPbmVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMsIGRhdGFPbkluc2VydCkgeyBcbiAgICAgICAgbGV0IHRyYW5zID0gdGhpcy5fdHJhbnNsYXRlVXBkYXRlKGRhdGEpO1xuICAgICAgICBsZXQgeyBfaWQsIC4uLm90aGVycyB9ID0gdHJhbnMuJHNldCB8fCB7fTsgXG4gICAgICAgIGlmICghXy5pc05pbChfaWQpKSB7XG4gICAgICAgICAgICB0cmFucy4kc2V0ID0gb3RoZXJzO1xuICAgICAgICAgICAgdHJhbnMuJHNldE9uSW5zZXJ0ID0geyBfaWQgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghXy5pc0VtcHR5KGRhdGFPbkluc2VydCkpIHtcbiAgICAgICAgICAgIHRyYW5zLiRzZXRPbkluc2VydCA9IHsgLi4udHJhbnMuJHNldE9uSW5zZXJ0LCAuLi5kYXRhT25JbnNlcnQgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIG9wdGlvbnMgPSB7IC4uLm9wdGlvbnMsIHVwc2VydDogdHJ1ZSB9O1xuXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICd1cHNlcnRPbmU6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIGRhdGE6IHRyYW5zLCBjb25kaXRpb24sIG9wdGlvbnN9KSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC51cGRhdGVPbmUoY29uZGl0aW9uLCB0cmFucywgb3B0aW9ucykpOyAgICAgICAgXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBzZXJ0IGFuIGVudGl0eSBhbmQgcmV0dXJuIHVwZGF0ZWQuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YU9uSW5zZXJ0IC0gU2hhcmVkIGRhdGEgb24gaW5zZXJ0XG4gICAgICovXG4gICAgYXN5bmMgdXBzZXJ0T25lQW5kUmV0dXJuXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zLCBkYXRhT25JbnNlcnQpIHsgXG4gICAgICAgIGxldCB0cmFucyA9IHRoaXMuX3RyYW5zbGF0ZVVwZGF0ZShkYXRhKTtcbiAgICAgICAgbGV0IHsgX2lkLCAuLi5vdGhlcnMgfSA9IHRyYW5zLiRzZXQgfHwge307IFxuICAgICAgICBpZiAoIV8uaXNOaWwoX2lkKSkge1xuICAgICAgICAgICAgdHJhbnMuJHNldCA9IG90aGVycztcbiAgICAgICAgICAgIHRyYW5zLiRzZXRPbkluc2VydCA9IHsgX2lkIH07XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIV8uaXNFbXB0eShkYXRhT25JbnNlcnQpKSB7XG4gICAgICAgICAgICB0cmFucy4kc2V0T25JbnNlcnQgPSB7IC4uLnRyYW5zLiRzZXRPbkluc2VydCwgLi4uZGF0YU9uSW5zZXJ0IH07XG4gICAgICAgIH1cblxuICAgICAgICBvcHRpb25zID0geyAuLi5vcHRpb25zLCB1cHNlcnQ6IHRydWUsIHJldHVybk9yaWdpbmFsOiBmYWxzZSB9O1xuXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICd1cHNlcnRPbmU6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIGRhdGE6IHRyYW5zLCBjb25kaXRpb24sIG9wdGlvbnN9KSk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgcmV0ID0gYXdhaXQgdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5maW5kT25lQW5kVXBkYXRlKGNvbmRpdGlvbiwgdHJhbnMsIG9wdGlvbnMpKTtcbiAgICAgICAgcmV0dXJuIHJldCAmJiByZXQudmFsdWU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIG1hbnkgZW50aXRpZXMuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIC0gQXJyYXkgb2YgcmVjb3JkIHdpdGggX2lkXG4gICAgICogQHBhcmFtIHthcnJheX0gdW5pcXVlS2V5cyAtIFVuaXF1ZSBrZXlzIGluIHRoZSBkYXRhIHJlY29yZCB1c2VkIGFzIGZpbHRlclxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YU9uSW5zZXJ0IC0gU2hhcmVkIGRhdGEgb24gaW5zZXJ0XG4gICAgICovXG4gICAgYXN5bmMgdXBzZXJ0TWFueV8obW9kZWwsIGRhdGEsIHVuaXF1ZUtleXMsIG9wdGlvbnMsIGRhdGFPbkluc2VydCkgeyBcbiAgICAgICAgbGV0IG9wcyA9IGRhdGEubWFwKHJlY29yZCA9PiB7XG4gICAgICAgICAgICBsZXQgeyBfaWQsIC4uLnVwZGF0ZURhdGEgfSA9IHJlY29yZDtcblxuICAgICAgICAgICAgbGV0IHVwZGF0ZU9wID0gdGhpcy5fdHJhbnNsYXRlVXBkYXRlKHVwZGF0ZURhdGEpO1xuXG4gICAgICAgICAgICBpZiAoX2lkKSB7XG4gICAgICAgICAgICAgICAgdXBkYXRlT3AuJHNldE9uSW5zZXJ0ID0geyBfaWQsIC4uLmRhdGFPbkluc2VydCB9O1xuICAgICAgICAgICAgfSBlbHNlIGlmICghXy5pc0VtcHR5KGRhdGFPbkluc2VydCkpIHtcbiAgICAgICAgICAgICAgICB1cGRhdGVPcC4kc2V0T25JbnNlcnQgPSBkYXRhT25JbnNlcnQ7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgdXBkYXRlT25lOiB7IGZpbHRlcjogeyAuLi5fLnBpY2socmVjb3JkLCB1bmlxdWVLZXlzKSB9LCB1cGRhdGU6IHVwZGF0ZU9wLCB1cHNlcnQ6IHRydWUgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgb3B0aW9ucyA9IHsgb3JkZXJlZDogZmFsc2UsIC4uLm9wdGlvbnMgfTtcblxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ1N0YXRlbWVudCkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAnYnVsa1dyaXRlOiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBjb3VudDogb3BzLmxlbmd0aCwgb3B0aW9uc30pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmJ1bGtXcml0ZShvcHMsIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgbWFueSBlbnRpdGllcyBhbmQgcmV0dXJuIHVwZGF0ZWQuXG4gICAgICogQHBhcmFtIHsqfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0geyp9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIHVwZGF0ZU1hbnlBbmRSZXR1cm5fKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgICAgICAgIFxuICAgICAgICBsZXQgbG9ja2VySWQgPSBHZW5lcmF0b3JzLnNob3J0aWQoKTtcblxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ1N0YXRlbWVudCkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAndXBkYXRlTWFueStmaW5kK3VwZGF0ZU1hbnk6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIGNvdW50OiBkYXRhLmxlbmd0aCwgY29uZGl0aW9uLCBvcHRpb25zfSkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgYXN5bmMgKGNvbGwpID0+IHtcbiAgICAgICAgICAgIC8vMS51cGRhdGUgYW5kIHNldCBsb2NrZXJcbiAgICAgICAgICAgIGxldCByZXQgPSBhd2FpdCBjb2xsLnVwZGF0ZU1hbnkoXG4gICAgICAgICAgICAgICAgeyAuLi5jb25kaXRpb24sIFt0aGlzLmxvY2tlckZpZWxkXTogeyAkZXhpc3RzOiBmYWxzZSB9IH0sIC8vIGZvciBhbGwgbm9uLWxvY2tlZFxuICAgICAgICAgICAgICAgIHsgJHNldDogeyAuLi5kYXRhLCBbdGhpcy5sb2NrZXJGaWVsZF06IGxvY2tlcklkIH0gfSwgLy8gbG9jayBpdCBcbiAgICAgICAgICAgICAgICB7IC4uLm9wdGlvbnMsIHVwc2VydDogZmFsc2UgfSApO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIC8vMi5yZXR1cm4gYWxsIGxvY2tlZCByZWNvcmRzXG4gICAgICAgICAgICAgICAgcmV0dXJuIGF3YWl0IGNvbGwuZmluZCh7IFt0aGlzLmxvY2tlckZpZWxkXTogbG9ja2VySWQgfSwgeyBwcm9qZWN0aW9uOiB7IFt0aGlzLmxvY2tlckZpZWxkXTogMCB9IH0pLnRvQXJyYXkoKTsgLy8gcmV0dXJuIGFsbCBsb2NrZWRcbiAgICAgICAgICAgIH0gZmluYWxseSB7ICAgIFxuICAgICAgICAgICAgICAgIC8vMy5yZW1vdmUgbG9ja2Vyc1xuICAgICAgICAgICAgICAgIGlmIChyZXQucmVzdWx0Lm5Nb2RpZmllZCA+IDApIHsgLy8gdW5sb2NrXG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IGNvbGwudXBkYXRlTWFueSh7IFt0aGlzLmxvY2tlckZpZWxkXTogbG9ja2VySWQgfSwgeyAkdW5zZXQ6IHsgW3RoaXMubG9ja2VyRmllbGRdOiBcIlwiIH0gfSwgeyB1cHNlcnQ6IGZhbHNlIH0pOyAgICBcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pOyAgICAgICAgIFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEluc2VydCBtYW55IGVudGl0aWVzIGlmIG5vdCBleGlzdC5cbiAgICAgKiBAcGFyYW0geyp9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IHVuaXF1ZUtleXMgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGluc2VydE1hbnlJZk5vdEV4aXN0Xyhtb2RlbCwgZGF0YSwgdW5pcXVlS2V5cywgb3B0aW9ucykge1xuICAgICAgICBjb25zb2xlLmxvZygnYnVnZ3k6IHRvZml4Jyk7XG4gICAgICAgIGxldCBvcHMgPSBkYXRhLm1hcChyZWNvcmQgPT4gKHtcbiAgICAgICAgICAgIHVwZGF0ZU9uZTogeyBmaWx0ZXI6IHsgLi4uXy5waWNrKHJlY29yZCwgdW5pcXVlS2V5cykgfSwgdXBkYXRlOiB7ICRzZXRPbkluc2VydDogcmVjb3JkIH0sIHVwc2VydDogdHJ1ZSB9XG4gICAgICAgIH0pKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5idWxrV3JpdGUob3BzLCB7IG9yZGVyZWQ6IGZhbHNlLCAuLi5vcHRpb25zIH0pKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgbXVsdGlwbGUgZG9jdW1lbnRzLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0geyp9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIHVwZGF0ZU1hbnlfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgXG4gICAgICAgIGRhdGEgPSB0aGlzLl90cmFuc2xhdGVVcGRhdGUoZGF0YSk7XG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICd1cGRhdGVNYW55OiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBjb3VudDogZGF0YS5sZW5ndGgsIGNvbmRpdGlvbiwgb3B0aW9uc30pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLnVwZGF0ZU1hbnkoY29uZGl0aW9uLCBkYXRhLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVwbGFjZSBhbiBleGlzdGluZyBlbnRpdHkgb3IgY3JlYXRlIGEgbmV3IG9uZS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIHJlcGxhY2VPbmVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ3JlcGxhY2VPbmU6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9uc30pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLnJlcGxhY2VPbmUoY29uZGl0aW9uLCBkYXRhLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlIGFuIGV4aXN0aW5nIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGRlbGV0ZU9uZV8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ1N0YXRlbWVudCkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAnZGVsZXRlT25lOiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBjb25kaXRpb24sIG9wdGlvbnN9KSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5kZWxldGVPbmUoY29uZGl0aW9uLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlIGFuIGV4aXN0aW5nIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGRlbGV0ZU1hbnlfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ2RlbGV0ZU1hbnk6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9uc30pKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5kZWxldGVNYW55KGNvbmRpdGlvbiwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlcGxhY2UgKGluc2VydCBvciB1cGRhdGUgZm9yIGV4c2lzdGluZykgYW4gZW50aXR5IGFuZCByZXR1cm4gb3JpZ2luYWwgcmVjb3JkLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgZmluZE9uZUFuZFJlcGxhY2VfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ2ZpbmRPbmVBbmRSZXBsYWNlOiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBkYXRhLCBvcHRpb25zfSkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmZpbmRPbmVBbmRSZXBsYWNlKGNvbmRpdGlvbiwgZGF0YSwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEZpbmQgYSBkb2N1bWVudCBhbmQgdXBkYXRlIGl0IGluIG9uZSBhdG9taWMgb3BlcmF0aW9uLiBSZXF1aXJlcyBhIHdyaXRlIGxvY2sgZm9yIHRoZSBkdXJhdGlvbiBvZiB0aGUgb3BlcmF0aW9uLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgZmluZE9uZUFuZFVwZGF0ZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykgeyAgICAgXG4gICAgICAgIGRhdGEgPSB0aGlzLl90cmFuc2xhdGVVcGRhdGUoZGF0YSk7XG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdmaW5kT25lQW5kVXBkYXRlOiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnN9KSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZmluZE9uZUFuZFVwZGF0ZShjb25kaXRpb24sIGRhdGEsIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICBhc3luYyBmaW5kT25lQW5kRGVsZXRlXyhtb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdmaW5kT25lQW5kRGVsZXRlOiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBjb25kaXRpb24sIG9wdGlvbnN9KSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZmluZE9uZUFuZERlbGV0ZShjb25kaXRpb24sIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICBhc3luYyBmaW5kT25lXyhtb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIGxldCBxdWVyeU9wdGlvbnMgPSB7Li4ub3B0aW9uc307XG4gICAgICAgIGxldCBxdWVyeTtcblxuICAgICAgICBpZiAoIV8uaXNFbXB0eShjb25kaXRpb24pKSB7XG4gICAgICAgICAgICBsZXQgeyAkcHJvamVjdGlvbiwgJHF1ZXJ5LCAuLi5vdGhlcnMgfSA9IGNvbmRpdGlvbjtcblxuICAgICAgICAgICAgaWYgKCRwcm9qZWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLnByb2plY3Rpb24gPSAkcHJvamVjdGlvbjsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHF1ZXJ5ID0geyAuLi5vdGhlcnMsIC4uLiRxdWVyeSB9O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRBcmd1bWVudCgnZmluZE9uZSByZXF1aXJlcyBub24tZW1wdHkgcXVlcnkgY29uZGl0aW9uLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ2ZpbmRPbmU6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIGNvbmRpdGlvbjogcXVlcnksIG9wdGlvbnM6IHF1ZXJ5T3B0aW9uc30pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmZpbmRPbmUocXVlcnksIHF1ZXJ5T3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFBlcmZvcm0gc2VsZWN0IG9wZXJhdGlvbi5cbiAgICAgKiBAcGFyYW0geyp9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBmaW5kXyhtb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIGxldCBxdWVyeU9wdGlvbnMgPSB7Li4ub3B0aW9uc307XG4gICAgICAgIGxldCBxdWVyeSwgcmVxdWlyZVRvdGFsQ291bnQ7XG5cbiAgICAgICAgaWYgKCFfLmlzRW1wdHkoY29uZGl0aW9uKSkge1xuICAgICAgICAgICAgbGV0IHsgJHByb2plY3Rpb24sICR0b3RhbENvdW50LCAkb3JkZXJCeSwgJG9mZnNldCwgJGxpbWl0LCAkcXVlcnksIC4uLm90aGVycyB9ID0gY29uZGl0aW9uO1xuXG4gICAgICAgICAgICBpZiAoJHByb2plY3Rpb24pIHtcbiAgICAgICAgICAgICAgICBxdWVyeU9wdGlvbnMucHJvamVjdGlvbiA9ICRwcm9qZWN0aW9uOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCRvcmRlckJ5KSB7XG4gICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLnNvcnQgPSAkb3JkZXJCeTsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICgkb2Zmc2V0KSB7XG4gICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLnNraXAgPSAkb2Zmc2V0OyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCRsaW1pdCkge1xuICAgICAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucy5saW1pdCA9ICRsaW1pdDsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHF1ZXJ5ID0geyAuLi5vdGhlcnMsIC4uLiRxdWVyeSB9O1xuICAgICAgICAgICAgcmVxdWlyZVRvdGFsQ291bnQgPSAkdG90YWxDb3VudDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHF1ZXJ5ID0ge307XG4gICAgICAgICAgICByZXF1aXJlVG90YWxDb3VudCA9IGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ2ZpbmQ6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIGNvbmRpdGlvbjogcXVlcnksIG9wdGlvbnM6IHF1ZXJ5T3B0aW9uc30pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIGFzeW5jIGNvbGwgPT4geyAgICAgICAgICAgIFxuICAgICAgICAgICAgbGV0IHJlc3VsdCA9IGF3YWl0IGNvbGwuZmluZChxdWVyeSwgcXVlcnlPcHRpb25zKS50b0FycmF5KCk7XG5cbiAgICAgICAgICAgIGlmIChyZXF1aXJlVG90YWxDb3VudCkge1xuICAgICAgICAgICAgICAgIGxldCB0b3RhbENvdW50ID0gYXdhaXQgY29sbC5maW5kKHF1ZXJ5KS5jb3VudCgpO1xuICAgICAgICAgICAgICAgIHJldHVybiBbIHJlc3VsdCwgdG90YWxDb3VudCBdO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9KTtcbiAgICB9ICAgXG5cbiAgICBhc3luYyBhZ2dyZWdhdGVfKG1vZGVsLCBwaXBlbGluZSwgb3B0aW9ucykgeyAgICAgICAgXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdhZ2dyZWdhdGU6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIHBpcGVsaW5lLCBvcHRpb25zfSkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmFnZ3JlZ2F0ZShwaXBlbGluZSwgb3B0aW9ucykudG9BcnJheSgpKTtcbiAgICB9XG5cbiAgICBhc3luYyBkaXN0aW5jdF8obW9kZWwsIGZpZWxkLCBxdWVyeSwgb3B0aW9ucykgeyAgICAgICAgXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdkaXN0aW5jdDogJyArIEpTT04uc3RyaW5naWZ5KHttb2RlbCwgZmllbGQsIHF1ZXJ5LCBvcHRpb25zfSkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmRpc3RpbmN0KGZpZWxkLCBxdWVyeSwgb3B0aW9ucykpO1xuICAgIH0gICAgXG5cbiAgICBhc3luYyBjb3VudF8obW9kZWwsIHF1ZXJ5LCBvcHRpb25zKSB7XG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdjb3VudDogJyArIEpTT04uc3RyaW5naWZ5KHttb2RlbCwgcXVlcnksIG9wdGlvbnN9KSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuY291bnREb2N1bWVudHMocXVlcnksIG9wdGlvbnMpKTsgICAgICAgIFxuICAgIH1cblxuICAgIGFzeW5jIG9uQ29sbGVjdGlvbl8obW9kZWwsIGV4ZWN1dG9yKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmV4ZWN1dGVfKGRiID0+IGV4ZWN1dG9yKGRiLmNvbGxlY3Rpb24obW9kZWwpKSk7XG4gICAgfVxuXG4gICAgX3RyYW5zbGF0ZVVwZGF0ZSh1cGRhdGUpIHtcbiAgICAgICAgbGV0IG9wcyA9IF8ucGljayh1cGRhdGUsIFVwZGF0ZU9wcyk7XG4gICAgICAgIGxldCBvdGhlcnMgPSBfLm9taXQodXBkYXRlLCBVcGRhdGVPcHMpO1xuXG4gICAgICAgIGlmIChvcHMuJHNldCkge1xuICAgICAgICAgICAgb3BzLiRzZXQgPSB7IC4uLm9wcy4kc2V0LCAuLi5vdGhlcnMgfTtcbiAgICAgICAgfSBlbHNlIGlmICghXy5pc0VtcHR5KG90aGVycykpIHtcbiAgICAgICAgICAgIG9wcy4kc2V0ID0gb3RoZXJzO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG9wcztcbiAgICB9XG59XG5cbk1vbmdvZGJDb25uZWN0b3IuZHJpdmVyTGliID0gbW9uZ29kYjtcblxubW9kdWxlLmV4cG9ydHMgPSBNb25nb2RiQ29ubmVjdG9yOyJdfQ==