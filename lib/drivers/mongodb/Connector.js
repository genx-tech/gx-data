"use strict";

require("source-map-support/register");

const {
  _,
  waitUntil_
} = require('rk-utils');

const {
  tryRequire
} = require('../../utils/lib');

const mongodb = tryRequire('mongodb');
const {
  MongoClient,
  GridFSBucket
} = mongodb;

const Connector = require('../../Connector');

const Generators = require('../../Generators');

const {
  InvalidArgument,
  DatabaseError
} = require('../../utils/Errors');

const UpdateOpsField = ['$currentDate', '$inc', '$min', '$max', '$mul', '$rename', '$set', '$setOnInsert', '$unset'];
const UpdateOpsArray = ['$addToSet', '$pop', '$pull', '$push', '$pullAll'];
const UpdateOps = UpdateOpsField.concat(UpdateOpsArray);

class MongodbConnector extends Connector {
  constructor(connectionString, options) {
    super('mongodb', connectionString, options);
    this.findAll_ = this.find_;
    this.lockerField = this.options.lockerField || '__lock__';
  }

  ensureInsertOne(opReturn) {
    if (opReturn.result.ok !== 1 || opReturn.result.n !== 1) {
      throw new DatabaseError('Insert operation failed');
    }

    return opReturn.insertedId;
  }

  async end_() {
    if (this.client && this.client.isConnected()) {
      await this.client.close();
      this.log('verbose', `mongodb: successfully disconnected from "${this.getConnectionStringWithoutCredential()}".`);
    }

    delete this.client;
  }

  async connect_(options) {
    if (!this.client || !this.client.isConnected()) {
      let client = new MongoClient(this.connectionString, {
        useNewUrlParser: true
      });
      this.client = await client.connect();
      this.log('verbose', `mongodb: successfully connected to "${this.getConnectionStringWithoutCredential()}".`);
    }

    return this.client.db(this.database);
  }

  async disconnect_(conn) {}

  async ping_() {
    return this.execute_(db => {
      return db.listCollections(null, {
        nameOnly: true
      }).toArray();
    });
  }

  async execute_(dbExecutor) {
    let db;

    try {
      db = await this.connect_();
      return await dbExecutor(db);
    } catch (err) {
      throw err;
    } finally {
      db && (await this.disconnect_(db));
    }
  }

  async createGridFSBucket_(options) {
    let db = await this.connect_();
    return new GridFSBucket(db, options);
  }

  async insertOne_(model, data, options) {
    options = {
      bypassDocumentValidation: true,
      ...options
    };

    if (this.options.logStatement) {
      this.log('verbose', 'insertOne: ' + JSON.stringify({
        model,
        data,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.insertOne(data, options));
  }

  async insertMany_(model, data, options) {
    options = {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    };

    if (this.options.logStatement) {
      this.log('verbose', 'insertMany: ' + JSON.stringify({
        model,
        count: data.length,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.insertMany(data, options));
  }

  async insertOneIfNotExist_(model, data, options) {
    try {
      return await this.insertOne_(model, data, options);
    } catch (error) {
      if (error.code === 11000) {
        return false;
      }

      throw error;
    }
  }

  async updateOne_(model, data, condition, options) {
    data = this._translateUpdate(data);

    if (this.options.logStatement) {
      this.log('verbose', 'updateOne: ' + JSON.stringify({
        model,
        data,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.updateOne(condition, data, options));
  }

  async updateOneAndReturn_(model, data, condition, options) {
    let ret = await this.findOneAndUpdate_(model, data, condition, { ...options,
      upsert: false,
      returnOriginal: false
    });
    return ret && ret.value;
  }

  async upsertOne_(model, data, condition, options, dataOnInsert) {
    let trans = this._translateUpdate(data);

    let {
      _id,
      ...others
    } = trans.$set || {};

    if (!_.isNil(_id)) {
      trans.$set = others;
      trans.$setOnInsert = {
        _id
      };
    }

    if (!_.isEmpty(dataOnInsert)) {
      trans.$setOnInsert = { ...trans.$setOnInsert,
        ...dataOnInsert
      };
    }

    options = { ...options,
      upsert: true
    };

    if (this.options.logStatement) {
      this.log('verbose', 'upsertOne: ' + JSON.stringify({
        model,
        data: trans,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.updateOne(condition, trans, options));
  }

  async upsertOneAndReturn_(model, data, condition, options, dataOnInsert) {
    let trans = this._translateUpdate(data);

    let {
      _id,
      ...others
    } = trans.$set || {};

    if (!_.isNil(_id)) {
      trans.$set = others;
      trans.$setOnInsert = {
        _id
      };
    }

    if (!_.isEmpty(dataOnInsert)) {
      trans.$setOnInsert = { ...trans.$setOnInsert,
        ...dataOnInsert
      };
    }

    options = { ...options,
      upsert: true,
      returnOriginal: false
    };

    if (this.options.logStatement) {
      this.log('verbose', 'upsertOne: ' + JSON.stringify({
        model,
        data: trans,
        condition,
        options
      }));
    }

    let ret = await this.onCollection_(model, coll => coll.findOneAndUpdate(condition, trans, options));
    return ret && ret.value;
  }

  async upsertMany_(model, data, uniqueKeys, options, dataOnInsert) {
    let ops = data.map(record => {
      let {
        _id,
        ...updateData
      } = record;

      let updateOp = this._translateUpdate(updateData);

      if (_id) {
        updateOp.$setOnInsert = {
          _id,
          ...dataOnInsert
        };
      } else if (!_.isEmpty(dataOnInsert)) {
        updateOp.$setOnInsert = dataOnInsert;
      }

      return {
        updateOne: {
          filter: { ..._.pick(record, uniqueKeys)
          },
          update: updateOp,
          upsert: true
        }
      };
    });
    options = {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    };

    if (this.options.logStatement) {
      this.log('verbose', 'bulkWrite: ' + JSON.stringify({
        model,
        count: ops.length,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.bulkWrite(ops, options));
  }

  async updateManyAndReturn_(model, data, condition, options) {
    let lockerId = Generators.shortid();

    if (this.options.logStatement) {
      this.log('verbose', 'updateMany+find+updateMany: ' + JSON.stringify({
        model,
        count: data.length,
        condition,
        options
      }));
    }

    return this.onCollection_(model, async coll => {
      let ret = await coll.updateMany({ ...condition,
        [this.lockerField]: {
          $exists: false
        }
      }, {
        $set: { ...data,
          [this.lockerField]: lockerId
        }
      }, { ...options,
        upsert: false
      });

      try {
        return await coll.find({
          [this.lockerField]: lockerId
        }, {
          projection: {
            [this.lockerField]: 0
          }
        }).toArray();
      } finally {
        if (ret.result.nModified > 0) {
          await coll.updateMany({
            [this.lockerField]: lockerId
          }, {
            $unset: {
              [this.lockerField]: ""
            }
          }, {
            upsert: false
          });
        }
      }
    });
  }

  async insertManyIfNotExist_(model, data, uniqueKeys, options) {
    console.log('buggy: tofix');
    let ops = data.map(record => ({
      updateOne: {
        filter: { ..._.pick(record, uniqueKeys)
        },
        update: {
          $setOnInsert: record
        },
        upsert: true
      }
    }));
    return this.onCollection_(model, coll => coll.bulkWrite(ops, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async updateMany_(model, data, condition, options) {
    data = this._translateUpdate(data);

    if (this.options.logStatement) {
      this.log('verbose', 'updateMany: ' + JSON.stringify({
        model,
        count: data.length,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.updateMany(condition, data, options));
  }

  async replaceOne_(model, data, condition, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'replaceOne: ' + JSON.stringify({
        model,
        data,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.replaceOne(condition, data, options));
  }

  async deleteOne_(model, condition, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'deleteOne: ' + JSON.stringify({
        model,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.deleteOne(condition, options));
  }

  async deleteMany_(model, condition, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'deleteMany: ' + JSON.stringify({
        model,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.deleteMany(condition, options));
  }

  async findOneAndReplace_(model, data, condition, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'findOneAndReplace: ' + JSON.stringify({
        model,
        data,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.findOneAndReplace(condition, data, options));
  }

  async findOneAndUpdate_(model, data, condition, options) {
    data = this._translateUpdate(data);

    if (this.options.logStatement) {
      this.log('verbose', 'findOneAndUpdate: ' + JSON.stringify({
        model,
        data,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.findOneAndUpdate(condition, data, options));
  }

  async findOneAndDelete_(model, condition, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'findOneAndDelete: ' + JSON.stringify({
        model,
        condition,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.findOneAndDelete(condition, options));
  }

  async findOne_(model, condition, options) {
    let queryOptions = { ...options
    };
    let query;

    if (!_.isEmpty(condition)) {
      let {
        $projection,
        $query,
        ...others
      } = condition;

      if ($projection) {
        queryOptions.projection = $projection;
      }

      query = { ...others,
        ...$query
      };
    } else {
      throw new InvalidArgument('findOne requires non-empty query condition.');
    }

    if (this.options.logStatement) {
      this.log('verbose', 'findOne: ' + JSON.stringify({
        model,
        condition: query,
        options: queryOptions
      }));
    }

    return this.onCollection_(model, coll => coll.findOne(query, queryOptions));
  }

  async find_(model, condition, options) {
    let queryOptions = { ...options
    };
    let query, requireTotalCount;

    if (!_.isEmpty(condition)) {
      let {
        $projection,
        $totalCount,
        $orderBy,
        $offset,
        $limit,
        $query,
        ...others
      } = condition;

      if ($projection) {
        queryOptions.projection = $projection;
      }

      if ($orderBy) {
        queryOptions.sort = $orderBy;
      }

      if ($offset) {
        queryOptions.skip = $offset;
      }

      if ($limit) {
        queryOptions.limit = $limit;
      }

      query = { ...others,
        ...$query
      };
      requireTotalCount = $totalCount;
    } else {
      query = {};
      requireTotalCount = false;
    }

    if (this.options.logStatement) {
      this.log('verbose', 'find: ' + JSON.stringify({
        model,
        condition: query,
        options: queryOptions
      }));
    }

    return this.onCollection_(model, async coll => {
      let result = await coll.find(query, queryOptions).toArray();

      if (requireTotalCount) {
        let totalCount = await coll.find(query).count();
        return [result, totalCount];
      }

      return result;
    });
  }

  async aggregate_(model, pipeline, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'aggregate: ' + JSON.stringify({
        model,
        pipeline,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.aggregate(pipeline, options).toArray());
  }

  async distinct_(model, field, query, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'distinct: ' + JSON.stringify({
        model,
        field,
        query,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.distinct(field, query, options));
  }

  async count_(model, query, options) {
    if (this.options.logStatement) {
      this.log('verbose', 'count: ' + JSON.stringify({
        model,
        query,
        options
      }));
    }

    return this.onCollection_(model, coll => coll.countDocuments(query, options));
  }

  async onCollection_(model, executor) {
    return this.execute_(db => executor(db.collection(model)));
  }

  _translateUpdate(update) {
    let ops = _.pick(update, UpdateOps);

    let others = _.omit(update, UpdateOps);

    if (ops.$set) {
      ops.$set = { ...ops.$set,
        ...others
      };
    } else if (!_.isEmpty(others)) {
      ops.$set = others;
    }

    return ops;
  }

}

MongodbConnector.driverLib = mongodb;
module.exports = MongodbConnector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kcml2ZXJzL21vbmdvZGIvQ29ubmVjdG9yLmpzIl0sIm5hbWVzIjpbIl8iLCJ3YWl0VW50aWxfIiwicmVxdWlyZSIsInRyeVJlcXVpcmUiLCJtb25nb2RiIiwiTW9uZ29DbGllbnQiLCJHcmlkRlNCdWNrZXQiLCJDb25uZWN0b3IiLCJHZW5lcmF0b3JzIiwiSW52YWxpZEFyZ3VtZW50IiwiRGF0YWJhc2VFcnJvciIsIlVwZGF0ZU9wc0ZpZWxkIiwiVXBkYXRlT3BzQXJyYXkiLCJVcGRhdGVPcHMiLCJjb25jYXQiLCJNb25nb2RiQ29ubmVjdG9yIiwiY29uc3RydWN0b3IiLCJjb25uZWN0aW9uU3RyaW5nIiwib3B0aW9ucyIsImZpbmRBbGxfIiwiZmluZF8iLCJsb2NrZXJGaWVsZCIsImVuc3VyZUluc2VydE9uZSIsIm9wUmV0dXJuIiwicmVzdWx0Iiwib2siLCJuIiwiaW5zZXJ0ZWRJZCIsImVuZF8iLCJjbGllbnQiLCJpc0Nvbm5lY3RlZCIsImNsb3NlIiwibG9nIiwiZ2V0Q29ubmVjdGlvblN0cmluZ1dpdGhvdXRDcmVkZW50aWFsIiwiY29ubmVjdF8iLCJ1c2VOZXdVcmxQYXJzZXIiLCJjb25uZWN0IiwiZGIiLCJkYXRhYmFzZSIsImRpc2Nvbm5lY3RfIiwiY29ubiIsInBpbmdfIiwiZXhlY3V0ZV8iLCJsaXN0Q29sbGVjdGlvbnMiLCJuYW1lT25seSIsInRvQXJyYXkiLCJkYkV4ZWN1dG9yIiwiZXJyIiwiY3JlYXRlR3JpZEZTQnVja2V0XyIsImluc2VydE9uZV8iLCJtb2RlbCIsImRhdGEiLCJieXBhc3NEb2N1bWVudFZhbGlkYXRpb24iLCJsb2dTdGF0ZW1lbnQiLCJKU09OIiwic3RyaW5naWZ5Iiwib25Db2xsZWN0aW9uXyIsImNvbGwiLCJpbnNlcnRPbmUiLCJpbnNlcnRNYW55XyIsIm9yZGVyZWQiLCJjb3VudCIsImxlbmd0aCIsImluc2VydE1hbnkiLCJpbnNlcnRPbmVJZk5vdEV4aXN0XyIsImVycm9yIiwiY29kZSIsInVwZGF0ZU9uZV8iLCJjb25kaXRpb24iLCJfdHJhbnNsYXRlVXBkYXRlIiwidXBkYXRlT25lIiwidXBkYXRlT25lQW5kUmV0dXJuXyIsInJldCIsImZpbmRPbmVBbmRVcGRhdGVfIiwidXBzZXJ0IiwicmV0dXJuT3JpZ2luYWwiLCJ2YWx1ZSIsInVwc2VydE9uZV8iLCJkYXRhT25JbnNlcnQiLCJ0cmFucyIsIl9pZCIsIm90aGVycyIsIiRzZXQiLCJpc05pbCIsIiRzZXRPbkluc2VydCIsImlzRW1wdHkiLCJ1cHNlcnRPbmVBbmRSZXR1cm5fIiwiZmluZE9uZUFuZFVwZGF0ZSIsInVwc2VydE1hbnlfIiwidW5pcXVlS2V5cyIsIm9wcyIsIm1hcCIsInJlY29yZCIsInVwZGF0ZURhdGEiLCJ1cGRhdGVPcCIsImZpbHRlciIsInBpY2siLCJ1cGRhdGUiLCJidWxrV3JpdGUiLCJ1cGRhdGVNYW55QW5kUmV0dXJuXyIsImxvY2tlcklkIiwic2hvcnRpZCIsInVwZGF0ZU1hbnkiLCIkZXhpc3RzIiwiZmluZCIsInByb2plY3Rpb24iLCJuTW9kaWZpZWQiLCIkdW5zZXQiLCJpbnNlcnRNYW55SWZOb3RFeGlzdF8iLCJjb25zb2xlIiwidXBkYXRlTWFueV8iLCJyZXBsYWNlT25lXyIsInJlcGxhY2VPbmUiLCJkZWxldGVPbmVfIiwiZGVsZXRlT25lIiwiZGVsZXRlTWFueV8iLCJkZWxldGVNYW55IiwiZmluZE9uZUFuZFJlcGxhY2VfIiwiZmluZE9uZUFuZFJlcGxhY2UiLCJmaW5kT25lQW5kRGVsZXRlXyIsImZpbmRPbmVBbmREZWxldGUiLCJmaW5kT25lXyIsInF1ZXJ5T3B0aW9ucyIsInF1ZXJ5IiwiJHByb2plY3Rpb24iLCIkcXVlcnkiLCJmaW5kT25lIiwicmVxdWlyZVRvdGFsQ291bnQiLCIkdG90YWxDb3VudCIsIiRvcmRlckJ5IiwiJG9mZnNldCIsIiRsaW1pdCIsInNvcnQiLCJza2lwIiwibGltaXQiLCJ0b3RhbENvdW50IiwiYWdncmVnYXRlXyIsInBpcGVsaW5lIiwiYWdncmVnYXRlIiwiZGlzdGluY3RfIiwiZmllbGQiLCJkaXN0aW5jdCIsImNvdW50XyIsImNvdW50RG9jdW1lbnRzIiwiZXhlY3V0b3IiLCJjb2xsZWN0aW9uIiwib21pdCIsImRyaXZlckxpYiIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxNQUFNO0FBQUVBLEVBQUFBLENBQUY7QUFBS0MsRUFBQUE7QUFBTCxJQUFvQkMsT0FBTyxDQUFDLFVBQUQsQ0FBakM7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQTtBQUFGLElBQWlCRCxPQUFPLENBQUMsaUJBQUQsQ0FBOUI7O0FBQ0EsTUFBTUUsT0FBTyxHQUFHRCxVQUFVLENBQUMsU0FBRCxDQUExQjtBQUNBLE1BQU07QUFBRUUsRUFBQUEsV0FBRjtBQUFlQyxFQUFBQTtBQUFmLElBQWdDRixPQUF0Qzs7QUFDQSxNQUFNRyxTQUFTLEdBQUdMLE9BQU8sQ0FBQyxpQkFBRCxDQUF6Qjs7QUFDQSxNQUFNTSxVQUFVLEdBQUdOLE9BQU8sQ0FBQyxrQkFBRCxDQUExQjs7QUFDQSxNQUFNO0FBQUVPLEVBQUFBLGVBQUY7QUFBbUJDLEVBQUFBO0FBQW5CLElBQXFDUixPQUFPLENBQUMsb0JBQUQsQ0FBbEQ7O0FBRUEsTUFBTVMsY0FBYyxHQUFHLENBQUUsY0FBRixFQUFrQixNQUFsQixFQUEwQixNQUExQixFQUFrQyxNQUFsQyxFQUEwQyxNQUExQyxFQUFrRCxTQUFsRCxFQUE2RCxNQUE3RCxFQUFxRSxjQUFyRSxFQUFxRixRQUFyRixDQUF2QjtBQUNBLE1BQU1DLGNBQWMsR0FBRyxDQUFFLFdBQUYsRUFBZSxNQUFmLEVBQXVCLE9BQXZCLEVBQWdDLE9BQWhDLEVBQXlDLFVBQXpDLENBQXZCO0FBQ0EsTUFBTUMsU0FBUyxHQUFHRixjQUFjLENBQUNHLE1BQWYsQ0FBc0JGLGNBQXRCLENBQWxCOztBQU9BLE1BQU1HLGdCQUFOLFNBQStCUixTQUEvQixDQUF5QztBQU1yQ1MsRUFBQUEsV0FBVyxDQUFDQyxnQkFBRCxFQUFtQkMsT0FBbkIsRUFBNEI7QUFDbkMsVUFBTSxTQUFOLEVBQWlCRCxnQkFBakIsRUFBbUNDLE9BQW5DO0FBRG1DLFNBTXZDQyxRQU51QyxHQU01QixLQUFLQyxLQU51QjtBQUduQyxTQUFLQyxXQUFMLEdBQW1CLEtBQUtILE9BQUwsQ0FBYUcsV0FBYixJQUE0QixVQUEvQztBQUNIOztBQVFEQyxFQUFBQSxlQUFlLENBQUNDLFFBQUQsRUFBVztBQUN0QixRQUFJQSxRQUFRLENBQUNDLE1BQVQsQ0FBZ0JDLEVBQWhCLEtBQXVCLENBQXZCLElBQTRCRixRQUFRLENBQUNDLE1BQVQsQ0FBZ0JFLENBQWhCLEtBQXNCLENBQXRELEVBQXlEO0FBQ3JELFlBQU0sSUFBSWhCLGFBQUosQ0FBa0IseUJBQWxCLENBQU47QUFDSDs7QUFFRCxXQUFPYSxRQUFRLENBQUNJLFVBQWhCO0FBQ0g7O0FBS0QsUUFBTUMsSUFBTixHQUFhO0FBQ1QsUUFBSSxLQUFLQyxNQUFMLElBQWUsS0FBS0EsTUFBTCxDQUFZQyxXQUFaLEVBQW5CLEVBQThDO0FBQzFDLFlBQU0sS0FBS0QsTUFBTCxDQUFZRSxLQUFaLEVBQU47QUFDQSxXQUFLQyxHQUFMLENBQVMsU0FBVCxFQUFxQiw0Q0FBMkMsS0FBS0Msb0NBQUwsRUFBNEMsSUFBNUc7QUFDSDs7QUFFRCxXQUFPLEtBQUtKLE1BQVo7QUFDSDs7QUFTRCxRQUFNSyxRQUFOLENBQWVoQixPQUFmLEVBQXdCO0FBQ3BCLFFBQUksQ0FBQyxLQUFLVyxNQUFOLElBQWdCLENBQUMsS0FBS0EsTUFBTCxDQUFZQyxXQUFaLEVBQXJCLEVBQWdEO0FBQzVDLFVBQUlELE1BQU0sR0FBRyxJQUFJeEIsV0FBSixDQUFnQixLQUFLWSxnQkFBckIsRUFBdUM7QUFBQ2tCLFFBQUFBLGVBQWUsRUFBRTtBQUFsQixPQUF2QyxDQUFiO0FBQ0EsV0FBS04sTUFBTCxHQUFjLE1BQU1BLE1BQU0sQ0FBQ08sT0FBUCxFQUFwQjtBQUNBLFdBQUtKLEdBQUwsQ0FBUyxTQUFULEVBQXFCLHVDQUFzQyxLQUFLQyxvQ0FBTCxFQUE0QyxJQUF2RztBQUNIOztBQUVELFdBQU8sS0FBS0osTUFBTCxDQUFZUSxFQUFaLENBQWUsS0FBS0MsUUFBcEIsQ0FBUDtBQUNIOztBQU1ELFFBQU1DLFdBQU4sQ0FBa0JDLElBQWxCLEVBQXdCLENBQ3ZCOztBQUVELFFBQU1DLEtBQU4sR0FBYztBQUNWLFdBQU8sS0FBS0MsUUFBTCxDQUFjTCxFQUFFLElBQUk7QUFDdkIsYUFBT0EsRUFBRSxDQUFDTSxlQUFILENBQW1CLElBQW5CLEVBQXlCO0FBQUVDLFFBQUFBLFFBQVEsRUFBRTtBQUFaLE9BQXpCLEVBQTZDQyxPQUE3QyxFQUFQO0FBQ0gsS0FGTSxDQUFQO0FBR0g7O0FBRUQsUUFBTUgsUUFBTixDQUFlSSxVQUFmLEVBQTJCO0FBQ3ZCLFFBQUlULEVBQUo7O0FBRUEsUUFBSTtBQUNBQSxNQUFBQSxFQUFFLEdBQUcsTUFBTSxLQUFLSCxRQUFMLEVBQVg7QUFFQSxhQUFPLE1BQU1ZLFVBQVUsQ0FBQ1QsRUFBRCxDQUF2QjtBQUNILEtBSkQsQ0FJRSxPQUFNVSxHQUFOLEVBQVc7QUFDVCxZQUFNQSxHQUFOO0FBQ0gsS0FORCxTQU1VO0FBQ05WLE1BQUFBLEVBQUUsS0FBSSxNQUFNLEtBQUtFLFdBQUwsQ0FBaUJGLEVBQWpCLENBQVYsQ0FBRjtBQUNIO0FBQ0o7O0FBU0QsUUFBTVcsbUJBQU4sQ0FBMEI5QixPQUExQixFQUFtQztBQUMvQixRQUFJbUIsRUFBRSxHQUFHLE1BQU0sS0FBS0gsUUFBTCxFQUFmO0FBRUEsV0FBTyxJQUFJNUIsWUFBSixDQUFpQitCLEVBQWpCLEVBQXFCbkIsT0FBckIsQ0FBUDtBQUNIOztBQVFELFFBQU0rQixVQUFOLENBQWlCQyxLQUFqQixFQUF3QkMsSUFBeEIsRUFBOEJqQyxPQUE5QixFQUF1QztBQUNuQ0EsSUFBQUEsT0FBTyxHQUFHO0FBQUVrQyxNQUFBQSx3QkFBd0IsRUFBRSxJQUE1QjtBQUFrQyxTQUFHbEM7QUFBckMsS0FBVjs7QUFFQSxRQUFJLEtBQUtBLE9BQUwsQ0FBYW1DLFlBQWpCLEVBQStCO0FBQzNCLFdBQUtyQixHQUFMLENBQVMsU0FBVCxFQUFvQixnQkFBZ0JzQixJQUFJLENBQUNDLFNBQUwsQ0FBZTtBQUFDTCxRQUFBQSxLQUFEO0FBQVFDLFFBQUFBLElBQVI7QUFBY2pDLFFBQUFBO0FBQWQsT0FBZixDQUFwQztBQUNIOztBQUVELFdBQU8sS0FBS3NDLGFBQUwsQ0FBbUJOLEtBQW5CLEVBQTJCTyxJQUFELElBQVVBLElBQUksQ0FBQ0MsU0FBTCxDQUFlUCxJQUFmLEVBQXFCakMsT0FBckIsQ0FBcEMsQ0FBUDtBQUNIOztBQVFELFFBQU15QyxXQUFOLENBQWtCVCxLQUFsQixFQUF5QkMsSUFBekIsRUFBK0JqQyxPQUEvQixFQUF3QztBQUNwQ0EsSUFBQUEsT0FBTyxHQUFHO0FBQUVrQyxNQUFBQSx3QkFBd0IsRUFBRSxJQUE1QjtBQUFrQ1EsTUFBQUEsT0FBTyxFQUFFLEtBQTNDO0FBQWtELFNBQUcxQztBQUFyRCxLQUFWOztBQUNBLFFBQUksS0FBS0EsT0FBTCxDQUFhbUMsWUFBakIsRUFBK0I7QUFDM0IsV0FBS3JCLEdBQUwsQ0FBUyxTQUFULEVBQW9CLGlCQUFpQnNCLElBQUksQ0FBQ0MsU0FBTCxDQUFlO0FBQUNMLFFBQUFBLEtBQUQ7QUFBUVcsUUFBQUEsS0FBSyxFQUFFVixJQUFJLENBQUNXLE1BQXBCO0FBQTRCNUMsUUFBQUE7QUFBNUIsT0FBZixDQUFyQztBQUNIOztBQUNELFdBQU8sS0FBS3NDLGFBQUwsQ0FBbUJOLEtBQW5CLEVBQTJCTyxJQUFELElBQVVBLElBQUksQ0FBQ00sVUFBTCxDQUFnQlosSUFBaEIsRUFBc0JqQyxPQUF0QixDQUFwQyxDQUFQO0FBQ0g7O0FBUUQsUUFBTThDLG9CQUFOLENBQTJCZCxLQUEzQixFQUFrQ0MsSUFBbEMsRUFBd0NqQyxPQUF4QyxFQUFpRDtBQUM3QyxRQUFJO0FBQ0EsYUFBTyxNQUFNLEtBQUsrQixVQUFMLENBQWdCQyxLQUFoQixFQUF1QkMsSUFBdkIsRUFBNkJqQyxPQUE3QixDQUFiO0FBQ0gsS0FGRCxDQUVFLE9BQU8rQyxLQUFQLEVBQWM7QUFDWixVQUFJQSxLQUFLLENBQUNDLElBQU4sS0FBZSxLQUFuQixFQUEwQjtBQUN0QixlQUFPLEtBQVA7QUFDSDs7QUFFRCxZQUFNRCxLQUFOO0FBQ0g7QUFDSjs7QUFTRCxRQUFNRSxVQUFOLENBQWlCakIsS0FBakIsRUFBd0JDLElBQXhCLEVBQThCaUIsU0FBOUIsRUFBeUNsRCxPQUF6QyxFQUFrRDtBQUM5Q2lDLElBQUFBLElBQUksR0FBRyxLQUFLa0IsZ0JBQUwsQ0FBc0JsQixJQUF0QixDQUFQOztBQUNBLFFBQUksS0FBS2pDLE9BQUwsQ0FBYW1DLFlBQWpCLEVBQStCO0FBQzNCLFdBQUtyQixHQUFMLENBQVMsU0FBVCxFQUFvQixnQkFBZ0JzQixJQUFJLENBQUNDLFNBQUwsQ0FBZTtBQUFDTCxRQUFBQSxLQUFEO0FBQVFDLFFBQUFBLElBQVI7QUFBY2lCLFFBQUFBLFNBQWQ7QUFBeUJsRCxRQUFBQTtBQUF6QixPQUFmLENBQXBDO0FBQ0g7O0FBQ0QsV0FBTyxLQUFLc0MsYUFBTCxDQUFtQk4sS0FBbkIsRUFBMkJPLElBQUQsSUFBVUEsSUFBSSxDQUFDYSxTQUFMLENBQWVGLFNBQWYsRUFBMEJqQixJQUExQixFQUFnQ2pDLE9BQWhDLENBQXBDLENBQVA7QUFDSDs7QUFTRCxRQUFNcUQsbUJBQU4sQ0FBMEJyQixLQUExQixFQUFpQ0MsSUFBakMsRUFBdUNpQixTQUF2QyxFQUFrRGxELE9BQWxELEVBQTJEO0FBQ3ZELFFBQUlzRCxHQUFHLEdBQUcsTUFBTSxLQUFLQyxpQkFBTCxDQUF1QnZCLEtBQXZCLEVBQThCQyxJQUE5QixFQUFvQ2lCLFNBQXBDLEVBQStDLEVBQUUsR0FBR2xELE9BQUw7QUFBY3dELE1BQUFBLE1BQU0sRUFBRSxLQUF0QjtBQUE2QkMsTUFBQUEsY0FBYyxFQUFFO0FBQTdDLEtBQS9DLENBQWhCO0FBQ0EsV0FBT0gsR0FBRyxJQUFJQSxHQUFHLENBQUNJLEtBQWxCO0FBQ0g7O0FBVUQsUUFBTUMsVUFBTixDQUFpQjNCLEtBQWpCLEVBQXdCQyxJQUF4QixFQUE4QmlCLFNBQTlCLEVBQXlDbEQsT0FBekMsRUFBa0Q0RCxZQUFsRCxFQUFnRTtBQUM1RCxRQUFJQyxLQUFLLEdBQUcsS0FBS1YsZ0JBQUwsQ0FBc0JsQixJQUF0QixDQUFaOztBQUNBLFFBQUk7QUFBRTZCLE1BQUFBLEdBQUY7QUFBTyxTQUFHQztBQUFWLFFBQXFCRixLQUFLLENBQUNHLElBQU4sSUFBYyxFQUF2Qzs7QUFDQSxRQUFJLENBQUNsRixDQUFDLENBQUNtRixLQUFGLENBQVFILEdBQVIsQ0FBTCxFQUFtQjtBQUNmRCxNQUFBQSxLQUFLLENBQUNHLElBQU4sR0FBYUQsTUFBYjtBQUNBRixNQUFBQSxLQUFLLENBQUNLLFlBQU4sR0FBcUI7QUFBRUosUUFBQUE7QUFBRixPQUFyQjtBQUNIOztBQUVELFFBQUksQ0FBQ2hGLENBQUMsQ0FBQ3FGLE9BQUYsQ0FBVVAsWUFBVixDQUFMLEVBQThCO0FBQzFCQyxNQUFBQSxLQUFLLENBQUNLLFlBQU4sR0FBcUIsRUFBRSxHQUFHTCxLQUFLLENBQUNLLFlBQVg7QUFBeUIsV0FBR047QUFBNUIsT0FBckI7QUFDSDs7QUFFRDVELElBQUFBLE9BQU8sR0FBRyxFQUFFLEdBQUdBLE9BQUw7QUFBY3dELE1BQUFBLE1BQU0sRUFBRTtBQUF0QixLQUFWOztBQUVBLFFBQUksS0FBS3hELE9BQUwsQ0FBYW1DLFlBQWpCLEVBQStCO0FBQzNCLFdBQUtyQixHQUFMLENBQVMsU0FBVCxFQUFvQixnQkFBZ0JzQixJQUFJLENBQUNDLFNBQUwsQ0FBZTtBQUFDTCxRQUFBQSxLQUFEO0FBQVFDLFFBQUFBLElBQUksRUFBRTRCLEtBQWQ7QUFBcUJYLFFBQUFBLFNBQXJCO0FBQWdDbEQsUUFBQUE7QUFBaEMsT0FBZixDQUFwQztBQUNIOztBQUVELFdBQU8sS0FBS3NDLGFBQUwsQ0FBbUJOLEtBQW5CLEVBQTJCTyxJQUFELElBQVVBLElBQUksQ0FBQ2EsU0FBTCxDQUFlRixTQUFmLEVBQTBCVyxLQUExQixFQUFpQzdELE9BQWpDLENBQXBDLENBQVA7QUFDSDs7QUFVRCxRQUFNb0UsbUJBQU4sQ0FBMEJwQyxLQUExQixFQUFpQ0MsSUFBakMsRUFBdUNpQixTQUF2QyxFQUFrRGxELE9BQWxELEVBQTJENEQsWUFBM0QsRUFBeUU7QUFDckUsUUFBSUMsS0FBSyxHQUFHLEtBQUtWLGdCQUFMLENBQXNCbEIsSUFBdEIsQ0FBWjs7QUFDQSxRQUFJO0FBQUU2QixNQUFBQSxHQUFGO0FBQU8sU0FBR0M7QUFBVixRQUFxQkYsS0FBSyxDQUFDRyxJQUFOLElBQWMsRUFBdkM7O0FBQ0EsUUFBSSxDQUFDbEYsQ0FBQyxDQUFDbUYsS0FBRixDQUFRSCxHQUFSLENBQUwsRUFBbUI7QUFDZkQsTUFBQUEsS0FBSyxDQUFDRyxJQUFOLEdBQWFELE1BQWI7QUFDQUYsTUFBQUEsS0FBSyxDQUFDSyxZQUFOLEdBQXFCO0FBQUVKLFFBQUFBO0FBQUYsT0FBckI7QUFDSDs7QUFFRCxRQUFJLENBQUNoRixDQUFDLENBQUNxRixPQUFGLENBQVVQLFlBQVYsQ0FBTCxFQUE4QjtBQUMxQkMsTUFBQUEsS0FBSyxDQUFDSyxZQUFOLEdBQXFCLEVBQUUsR0FBR0wsS0FBSyxDQUFDSyxZQUFYO0FBQXlCLFdBQUdOO0FBQTVCLE9BQXJCO0FBQ0g7O0FBRUQ1RCxJQUFBQSxPQUFPLEdBQUcsRUFBRSxHQUFHQSxPQUFMO0FBQWN3RCxNQUFBQSxNQUFNLEVBQUUsSUFBdEI7QUFBNEJDLE1BQUFBLGNBQWMsRUFBRTtBQUE1QyxLQUFWOztBQUVBLFFBQUksS0FBS3pELE9BQUwsQ0FBYW1DLFlBQWpCLEVBQStCO0FBQzNCLFdBQUtyQixHQUFMLENBQVMsU0FBVCxFQUFvQixnQkFBZ0JzQixJQUFJLENBQUNDLFNBQUwsQ0FBZTtBQUFDTCxRQUFBQSxLQUFEO0FBQVFDLFFBQUFBLElBQUksRUFBRTRCLEtBQWQ7QUFBcUJYLFFBQUFBLFNBQXJCO0FBQWdDbEQsUUFBQUE7QUFBaEMsT0FBZixDQUFwQztBQUNIOztBQUVELFFBQUlzRCxHQUFHLEdBQUcsTUFBTSxLQUFLaEIsYUFBTCxDQUFtQk4sS0FBbkIsRUFBMkJPLElBQUQsSUFBVUEsSUFBSSxDQUFDOEIsZ0JBQUwsQ0FBc0JuQixTQUF0QixFQUFpQ1csS0FBakMsRUFBd0M3RCxPQUF4QyxDQUFwQyxDQUFoQjtBQUNBLFdBQU9zRCxHQUFHLElBQUlBLEdBQUcsQ0FBQ0ksS0FBbEI7QUFDSDs7QUFVRCxRQUFNWSxXQUFOLENBQWtCdEMsS0FBbEIsRUFBeUJDLElBQXpCLEVBQStCc0MsVUFBL0IsRUFBMkN2RSxPQUEzQyxFQUFvRDRELFlBQXBELEVBQWtFO0FBQzlELFFBQUlZLEdBQUcsR0FBR3ZDLElBQUksQ0FBQ3dDLEdBQUwsQ0FBU0MsTUFBTSxJQUFJO0FBQ3pCLFVBQUk7QUFBRVosUUFBQUEsR0FBRjtBQUFPLFdBQUdhO0FBQVYsVUFBeUJELE1BQTdCOztBQUVBLFVBQUlFLFFBQVEsR0FBRyxLQUFLekIsZ0JBQUwsQ0FBc0J3QixVQUF0QixDQUFmOztBQUVBLFVBQUliLEdBQUosRUFBUztBQUNMYyxRQUFBQSxRQUFRLENBQUNWLFlBQVQsR0FBd0I7QUFBRUosVUFBQUEsR0FBRjtBQUFPLGFBQUdGO0FBQVYsU0FBeEI7QUFDSCxPQUZELE1BRU8sSUFBSSxDQUFDOUUsQ0FBQyxDQUFDcUYsT0FBRixDQUFVUCxZQUFWLENBQUwsRUFBOEI7QUFDakNnQixRQUFBQSxRQUFRLENBQUNWLFlBQVQsR0FBd0JOLFlBQXhCO0FBQ0g7O0FBRUQsYUFBTztBQUNIUixRQUFBQSxTQUFTLEVBQUU7QUFBRXlCLFVBQUFBLE1BQU0sRUFBRSxFQUFFLEdBQUcvRixDQUFDLENBQUNnRyxJQUFGLENBQU9KLE1BQVAsRUFBZUgsVUFBZjtBQUFMLFdBQVY7QUFBNkNRLFVBQUFBLE1BQU0sRUFBRUgsUUFBckQ7QUFBK0RwQixVQUFBQSxNQUFNLEVBQUU7QUFBdkU7QUFEUixPQUFQO0FBR0gsS0FkUyxDQUFWO0FBZ0JBeEQsSUFBQUEsT0FBTyxHQUFHO0FBQUVrQyxNQUFBQSx3QkFBd0IsRUFBRSxJQUE1QjtBQUFrQ1EsTUFBQUEsT0FBTyxFQUFFLEtBQTNDO0FBQWtELFNBQUcxQztBQUFyRCxLQUFWOztBQUVBLFFBQUksS0FBS0EsT0FBTCxDQUFhbUMsWUFBakIsRUFBK0I7QUFDM0IsV0FBS3JCLEdBQUwsQ0FBUyxTQUFULEVBQW9CLGdCQUFnQnNCLElBQUksQ0FBQ0MsU0FBTCxDQUFlO0FBQUNMLFFBQUFBLEtBQUQ7QUFBUVcsUUFBQUEsS0FBSyxFQUFFNkIsR0FBRyxDQUFDNUIsTUFBbkI7QUFBMkI1QyxRQUFBQTtBQUEzQixPQUFmLENBQXBDO0FBQ0g7O0FBRUQsV0FBTyxLQUFLc0MsYUFBTCxDQUFtQk4sS0FBbkIsRUFBMkJPLElBQUQsSUFBVUEsSUFBSSxDQUFDeUMsU0FBTCxDQUFlUixHQUFmLEVBQW9CeEUsT0FBcEIsQ0FBcEMsQ0FBUDtBQUNIOztBQVNELFFBQU1pRixvQkFBTixDQUEyQmpELEtBQTNCLEVBQWtDQyxJQUFsQyxFQUF3Q2lCLFNBQXhDLEVBQW1EbEQsT0FBbkQsRUFBNEQ7QUFDeEQsUUFBSWtGLFFBQVEsR0FBRzVGLFVBQVUsQ0FBQzZGLE9BQVgsRUFBZjs7QUFFQSxRQUFJLEtBQUtuRixPQUFMLENBQWFtQyxZQUFqQixFQUErQjtBQUMzQixXQUFLckIsR0FBTCxDQUFTLFNBQVQsRUFBb0IsaUNBQWlDc0IsSUFBSSxDQUFDQyxTQUFMLENBQWU7QUFBQ0wsUUFBQUEsS0FBRDtBQUFRVyxRQUFBQSxLQUFLLEVBQUVWLElBQUksQ0FBQ1csTUFBcEI7QUFBNEJNLFFBQUFBLFNBQTVCO0FBQXVDbEQsUUFBQUE7QUFBdkMsT0FBZixDQUFyRDtBQUNIOztBQUVELFdBQU8sS0FBS3NDLGFBQUwsQ0FBbUJOLEtBQW5CLEVBQTBCLE1BQU9PLElBQVAsSUFBZ0I7QUFFN0MsVUFBSWUsR0FBRyxHQUFHLE1BQU1mLElBQUksQ0FBQzZDLFVBQUwsQ0FDWixFQUFFLEdBQUdsQyxTQUFMO0FBQWdCLFNBQUMsS0FBSy9DLFdBQU4sR0FBb0I7QUFBRWtGLFVBQUFBLE9BQU8sRUFBRTtBQUFYO0FBQXBDLE9BRFksRUFFWjtBQUFFckIsUUFBQUEsSUFBSSxFQUFFLEVBQUUsR0FBRy9CLElBQUw7QUFBVyxXQUFDLEtBQUs5QixXQUFOLEdBQW9CK0U7QUFBL0I7QUFBUixPQUZZLEVBR1osRUFBRSxHQUFHbEYsT0FBTDtBQUFjd0QsUUFBQUEsTUFBTSxFQUFFO0FBQXRCLE9BSFksQ0FBaEI7O0FBS0EsVUFBSTtBQUVBLGVBQU8sTUFBTWpCLElBQUksQ0FBQytDLElBQUwsQ0FBVTtBQUFFLFdBQUMsS0FBS25GLFdBQU4sR0FBb0IrRTtBQUF0QixTQUFWLEVBQTRDO0FBQUVLLFVBQUFBLFVBQVUsRUFBRTtBQUFFLGFBQUMsS0FBS3BGLFdBQU4sR0FBb0I7QUFBdEI7QUFBZCxTQUE1QyxFQUF1RndCLE9BQXZGLEVBQWI7QUFDSCxPQUhELFNBR1U7QUFFTixZQUFJMkIsR0FBRyxDQUFDaEQsTUFBSixDQUFXa0YsU0FBWCxHQUF1QixDQUEzQixFQUE4QjtBQUMxQixnQkFBTWpELElBQUksQ0FBQzZDLFVBQUwsQ0FBZ0I7QUFBRSxhQUFDLEtBQUtqRixXQUFOLEdBQW9CK0U7QUFBdEIsV0FBaEIsRUFBa0Q7QUFBRU8sWUFBQUEsTUFBTSxFQUFFO0FBQUUsZUFBQyxLQUFLdEYsV0FBTixHQUFvQjtBQUF0QjtBQUFWLFdBQWxELEVBQTBGO0FBQUVxRCxZQUFBQSxNQUFNLEVBQUU7QUFBVixXQUExRixDQUFOO0FBQ0g7QUFDSjtBQUNKLEtBaEJNLENBQVA7QUFpQkg7O0FBU0QsUUFBTWtDLHFCQUFOLENBQTRCMUQsS0FBNUIsRUFBbUNDLElBQW5DLEVBQXlDc0MsVUFBekMsRUFBcUR2RSxPQUFyRCxFQUE4RDtBQUMxRDJGLElBQUFBLE9BQU8sQ0FBQzdFLEdBQVIsQ0FBWSxjQUFaO0FBQ0EsUUFBSTBELEdBQUcsR0FBR3ZDLElBQUksQ0FBQ3dDLEdBQUwsQ0FBU0MsTUFBTSxLQUFLO0FBQzFCdEIsTUFBQUEsU0FBUyxFQUFFO0FBQUV5QixRQUFBQSxNQUFNLEVBQUUsRUFBRSxHQUFHL0YsQ0FBQyxDQUFDZ0csSUFBRixDQUFPSixNQUFQLEVBQWVILFVBQWY7QUFBTCxTQUFWO0FBQTZDUSxRQUFBQSxNQUFNLEVBQUU7QUFBRWIsVUFBQUEsWUFBWSxFQUFFUTtBQUFoQixTQUFyRDtBQUErRWxCLFFBQUFBLE1BQU0sRUFBRTtBQUF2RjtBQURlLEtBQUwsQ0FBZixDQUFWO0FBSUEsV0FBTyxLQUFLbEIsYUFBTCxDQUFtQk4sS0FBbkIsRUFBMkJPLElBQUQsSUFBVUEsSUFBSSxDQUFDeUMsU0FBTCxDQUFlUixHQUFmLEVBQW9CO0FBQUV0QyxNQUFBQSx3QkFBd0IsRUFBRSxJQUE1QjtBQUFrQ1EsTUFBQUEsT0FBTyxFQUFFLEtBQTNDO0FBQWtELFNBQUcxQztBQUFyRCxLQUFwQixDQUFwQyxDQUFQO0FBQ0g7O0FBU0QsUUFBTTRGLFdBQU4sQ0FBa0I1RCxLQUFsQixFQUF5QkMsSUFBekIsRUFBK0JpQixTQUEvQixFQUEwQ2xELE9BQTFDLEVBQW1EO0FBQy9DaUMsSUFBQUEsSUFBSSxHQUFHLEtBQUtrQixnQkFBTCxDQUFzQmxCLElBQXRCLENBQVA7O0FBQ0EsUUFBSSxLQUFLakMsT0FBTCxDQUFhbUMsWUFBakIsRUFBK0I7QUFDM0IsV0FBS3JCLEdBQUwsQ0FBUyxTQUFULEVBQW9CLGlCQUFpQnNCLElBQUksQ0FBQ0MsU0FBTCxDQUFlO0FBQUNMLFFBQUFBLEtBQUQ7QUFBUVcsUUFBQUEsS0FBSyxFQUFFVixJQUFJLENBQUNXLE1BQXBCO0FBQTRCTSxRQUFBQSxTQUE1QjtBQUF1Q2xELFFBQUFBO0FBQXZDLE9BQWYsQ0FBckM7QUFDSDs7QUFFRCxXQUFPLEtBQUtzQyxhQUFMLENBQW1CTixLQUFuQixFQUEyQk8sSUFBRCxJQUFVQSxJQUFJLENBQUM2QyxVQUFMLENBQWdCbEMsU0FBaEIsRUFBMkJqQixJQUEzQixFQUFpQ2pDLE9BQWpDLENBQXBDLENBQVA7QUFDSDs7QUFRRCxRQUFNNkYsV0FBTixDQUFrQjdELEtBQWxCLEVBQXlCQyxJQUF6QixFQUErQmlCLFNBQS9CLEVBQTBDbEQsT0FBMUMsRUFBbUQ7QUFDL0MsUUFBSSxLQUFLQSxPQUFMLENBQWFtQyxZQUFqQixFQUErQjtBQUMzQixXQUFLckIsR0FBTCxDQUFTLFNBQVQsRUFBb0IsaUJBQWlCc0IsSUFBSSxDQUFDQyxTQUFMLENBQWU7QUFBQ0wsUUFBQUEsS0FBRDtBQUFRQyxRQUFBQSxJQUFSO0FBQWNpQixRQUFBQSxTQUFkO0FBQXlCbEQsUUFBQUE7QUFBekIsT0FBZixDQUFyQztBQUNIOztBQUVELFdBQU8sS0FBS3NDLGFBQUwsQ0FBbUJOLEtBQW5CLEVBQTJCTyxJQUFELElBQVVBLElBQUksQ0FBQ3VELFVBQUwsQ0FBZ0I1QyxTQUFoQixFQUEyQmpCLElBQTNCLEVBQWlDakMsT0FBakMsQ0FBcEMsQ0FBUDtBQUNIOztBQVFELFFBQU0rRixVQUFOLENBQWlCL0QsS0FBakIsRUFBd0JrQixTQUF4QixFQUFtQ2xELE9BQW5DLEVBQTRDO0FBQ3hDLFFBQUksS0FBS0EsT0FBTCxDQUFhbUMsWUFBakIsRUFBK0I7QUFDM0IsV0FBS3JCLEdBQUwsQ0FBUyxTQUFULEVBQW9CLGdCQUFnQnNCLElBQUksQ0FBQ0MsU0FBTCxDQUFlO0FBQUNMLFFBQUFBLEtBQUQ7QUFBUWtCLFFBQUFBLFNBQVI7QUFBbUJsRCxRQUFBQTtBQUFuQixPQUFmLENBQXBDO0FBQ0g7O0FBRUQsV0FBTyxLQUFLc0MsYUFBTCxDQUFtQk4sS0FBbkIsRUFBMkJPLElBQUQsSUFBVUEsSUFBSSxDQUFDeUQsU0FBTCxDQUFlOUMsU0FBZixFQUEwQmxELE9BQTFCLENBQXBDLENBQVA7QUFDSDs7QUFRRCxRQUFNaUcsV0FBTixDQUFrQmpFLEtBQWxCLEVBQXlCa0IsU0FBekIsRUFBb0NsRCxPQUFwQyxFQUE2QztBQUN6QyxRQUFJLEtBQUtBLE9BQUwsQ0FBYW1DLFlBQWpCLEVBQStCO0FBQzNCLFdBQUtyQixHQUFMLENBQVMsU0FBVCxFQUFvQixpQkFBaUJzQixJQUFJLENBQUNDLFNBQUwsQ0FBZTtBQUFDTCxRQUFBQSxLQUFEO0FBQVFrQixRQUFBQSxTQUFSO0FBQW1CbEQsUUFBQUE7QUFBbkIsT0FBZixDQUFyQztBQUNIOztBQUNELFdBQU8sS0FBS3NDLGFBQUwsQ0FBbUJOLEtBQW5CLEVBQTJCTyxJQUFELElBQVVBLElBQUksQ0FBQzJELFVBQUwsQ0FBZ0JoRCxTQUFoQixFQUEyQmxELE9BQTNCLENBQXBDLENBQVA7QUFDSDs7QUFRRCxRQUFNbUcsa0JBQU4sQ0FBeUJuRSxLQUF6QixFQUFnQ0MsSUFBaEMsRUFBc0NpQixTQUF0QyxFQUFpRGxELE9BQWpELEVBQTBEO0FBQ3RELFFBQUksS0FBS0EsT0FBTCxDQUFhbUMsWUFBakIsRUFBK0I7QUFDM0IsV0FBS3JCLEdBQUwsQ0FBUyxTQUFULEVBQW9CLHdCQUF3QnNCLElBQUksQ0FBQ0MsU0FBTCxDQUFlO0FBQUNMLFFBQUFBLEtBQUQ7QUFBUUMsUUFBQUEsSUFBUjtBQUFjakMsUUFBQUE7QUFBZCxPQUFmLENBQTVDO0FBQ0g7O0FBQ0QsV0FBTyxLQUFLc0MsYUFBTCxDQUFtQk4sS0FBbkIsRUFBMkJPLElBQUQsSUFBVUEsSUFBSSxDQUFDNkQsaUJBQUwsQ0FBdUJsRCxTQUF2QixFQUFrQ2pCLElBQWxDLEVBQXdDakMsT0FBeEMsQ0FBcEMsQ0FBUDtBQUNIOztBQVFELFFBQU11RCxpQkFBTixDQUF3QnZCLEtBQXhCLEVBQStCQyxJQUEvQixFQUFxQ2lCLFNBQXJDLEVBQWdEbEQsT0FBaEQsRUFBeUQ7QUFDckRpQyxJQUFBQSxJQUFJLEdBQUcsS0FBS2tCLGdCQUFMLENBQXNCbEIsSUFBdEIsQ0FBUDs7QUFDQSxRQUFJLEtBQUtqQyxPQUFMLENBQWFtQyxZQUFqQixFQUErQjtBQUMzQixXQUFLckIsR0FBTCxDQUFTLFNBQVQsRUFBb0IsdUJBQXVCc0IsSUFBSSxDQUFDQyxTQUFMLENBQWU7QUFBQ0wsUUFBQUEsS0FBRDtBQUFRQyxRQUFBQSxJQUFSO0FBQWNpQixRQUFBQSxTQUFkO0FBQXlCbEQsUUFBQUE7QUFBekIsT0FBZixDQUEzQztBQUNIOztBQUNELFdBQU8sS0FBS3NDLGFBQUwsQ0FBbUJOLEtBQW5CLEVBQTJCTyxJQUFELElBQVVBLElBQUksQ0FBQzhCLGdCQUFMLENBQXNCbkIsU0FBdEIsRUFBaUNqQixJQUFqQyxFQUF1Q2pDLE9BQXZDLENBQXBDLENBQVA7QUFDSDs7QUFFRCxRQUFNcUcsaUJBQU4sQ0FBd0JyRSxLQUF4QixFQUErQmtCLFNBQS9CLEVBQTBDbEQsT0FBMUMsRUFBbUQ7QUFDL0MsUUFBSSxLQUFLQSxPQUFMLENBQWFtQyxZQUFqQixFQUErQjtBQUMzQixXQUFLckIsR0FBTCxDQUFTLFNBQVQsRUFBb0IsdUJBQXVCc0IsSUFBSSxDQUFDQyxTQUFMLENBQWU7QUFBQ0wsUUFBQUEsS0FBRDtBQUFRa0IsUUFBQUEsU0FBUjtBQUFtQmxELFFBQUFBO0FBQW5CLE9BQWYsQ0FBM0M7QUFDSDs7QUFDRCxXQUFPLEtBQUtzQyxhQUFMLENBQW1CTixLQUFuQixFQUEyQk8sSUFBRCxJQUFVQSxJQUFJLENBQUMrRCxnQkFBTCxDQUFzQnBELFNBQXRCLEVBQWlDbEQsT0FBakMsQ0FBcEMsQ0FBUDtBQUNIOztBQUVELFFBQU11RyxRQUFOLENBQWV2RSxLQUFmLEVBQXNCa0IsU0FBdEIsRUFBaUNsRCxPQUFqQyxFQUEwQztBQUN0QyxRQUFJd0csWUFBWSxHQUFHLEVBQUMsR0FBR3hHO0FBQUosS0FBbkI7QUFDQSxRQUFJeUcsS0FBSjs7QUFFQSxRQUFJLENBQUMzSCxDQUFDLENBQUNxRixPQUFGLENBQVVqQixTQUFWLENBQUwsRUFBMkI7QUFDdkIsVUFBSTtBQUFFd0QsUUFBQUEsV0FBRjtBQUFlQyxRQUFBQSxNQUFmO0FBQXVCLFdBQUc1QztBQUExQixVQUFxQ2IsU0FBekM7O0FBRUEsVUFBSXdELFdBQUosRUFBaUI7QUFDYkYsUUFBQUEsWUFBWSxDQUFDakIsVUFBYixHQUEwQm1CLFdBQTFCO0FBQ0g7O0FBRURELE1BQUFBLEtBQUssR0FBRyxFQUFFLEdBQUcxQyxNQUFMO0FBQWEsV0FBRzRDO0FBQWhCLE9BQVI7QUFDSCxLQVJELE1BUU87QUFDSCxZQUFNLElBQUlwSCxlQUFKLENBQW9CLDZDQUFwQixDQUFOO0FBQ0g7O0FBRUQsUUFBSSxLQUFLUyxPQUFMLENBQWFtQyxZQUFqQixFQUErQjtBQUMzQixXQUFLckIsR0FBTCxDQUFTLFNBQVQsRUFBb0IsY0FBY3NCLElBQUksQ0FBQ0MsU0FBTCxDQUFlO0FBQUNMLFFBQUFBLEtBQUQ7QUFBUWtCLFFBQUFBLFNBQVMsRUFBRXVELEtBQW5CO0FBQTBCekcsUUFBQUEsT0FBTyxFQUFFd0c7QUFBbkMsT0FBZixDQUFsQztBQUNIOztBQUVELFdBQU8sS0FBS2xFLGFBQUwsQ0FBbUJOLEtBQW5CLEVBQTJCTyxJQUFELElBQVVBLElBQUksQ0FBQ3FFLE9BQUwsQ0FBYUgsS0FBYixFQUFvQkQsWUFBcEIsQ0FBcEMsQ0FBUDtBQUNIOztBQVFELFFBQU10RyxLQUFOLENBQVk4QixLQUFaLEVBQW1Ca0IsU0FBbkIsRUFBOEJsRCxPQUE5QixFQUF1QztBQUNuQyxRQUFJd0csWUFBWSxHQUFHLEVBQUMsR0FBR3hHO0FBQUosS0FBbkI7QUFDQSxRQUFJeUcsS0FBSixFQUFXSSxpQkFBWDs7QUFFQSxRQUFJLENBQUMvSCxDQUFDLENBQUNxRixPQUFGLENBQVVqQixTQUFWLENBQUwsRUFBMkI7QUFDdkIsVUFBSTtBQUFFd0QsUUFBQUEsV0FBRjtBQUFlSSxRQUFBQSxXQUFmO0FBQTRCQyxRQUFBQSxRQUE1QjtBQUFzQ0MsUUFBQUEsT0FBdEM7QUFBK0NDLFFBQUFBLE1BQS9DO0FBQXVETixRQUFBQSxNQUF2RDtBQUErRCxXQUFHNUM7QUFBbEUsVUFBNkViLFNBQWpGOztBQUVBLFVBQUl3RCxXQUFKLEVBQWlCO0FBQ2JGLFFBQUFBLFlBQVksQ0FBQ2pCLFVBQWIsR0FBMEJtQixXQUExQjtBQUNIOztBQUVELFVBQUlLLFFBQUosRUFBYztBQUNWUCxRQUFBQSxZQUFZLENBQUNVLElBQWIsR0FBb0JILFFBQXBCO0FBQ0g7O0FBRUQsVUFBSUMsT0FBSixFQUFhO0FBQ1RSLFFBQUFBLFlBQVksQ0FBQ1csSUFBYixHQUFvQkgsT0FBcEI7QUFDSDs7QUFFRCxVQUFJQyxNQUFKLEVBQVk7QUFDUlQsUUFBQUEsWUFBWSxDQUFDWSxLQUFiLEdBQXFCSCxNQUFyQjtBQUNIOztBQUVEUixNQUFBQSxLQUFLLEdBQUcsRUFBRSxHQUFHMUMsTUFBTDtBQUFhLFdBQUc0QztBQUFoQixPQUFSO0FBQ0FFLE1BQUFBLGlCQUFpQixHQUFHQyxXQUFwQjtBQUNILEtBckJELE1BcUJPO0FBQ0hMLE1BQUFBLEtBQUssR0FBRyxFQUFSO0FBQ0FJLE1BQUFBLGlCQUFpQixHQUFHLEtBQXBCO0FBQ0g7O0FBRUQsUUFBSSxLQUFLN0csT0FBTCxDQUFhbUMsWUFBakIsRUFBK0I7QUFDM0IsV0FBS3JCLEdBQUwsQ0FBUyxTQUFULEVBQW9CLFdBQVdzQixJQUFJLENBQUNDLFNBQUwsQ0FBZTtBQUFDTCxRQUFBQSxLQUFEO0FBQVFrQixRQUFBQSxTQUFTLEVBQUV1RCxLQUFuQjtBQUEwQnpHLFFBQUFBLE9BQU8sRUFBRXdHO0FBQW5DLE9BQWYsQ0FBL0I7QUFDSDs7QUFFRCxXQUFPLEtBQUtsRSxhQUFMLENBQW1CTixLQUFuQixFQUEwQixNQUFNTyxJQUFOLElBQWM7QUFDM0MsVUFBSWpDLE1BQU0sR0FBRyxNQUFNaUMsSUFBSSxDQUFDK0MsSUFBTCxDQUFVbUIsS0FBVixFQUFpQkQsWUFBakIsRUFBK0I3RSxPQUEvQixFQUFuQjs7QUFFQSxVQUFJa0YsaUJBQUosRUFBdUI7QUFDbkIsWUFBSVEsVUFBVSxHQUFHLE1BQU05RSxJQUFJLENBQUMrQyxJQUFMLENBQVVtQixLQUFWLEVBQWlCOUQsS0FBakIsRUFBdkI7QUFDQSxlQUFPLENBQUVyQyxNQUFGLEVBQVUrRyxVQUFWLENBQVA7QUFDSDs7QUFFRCxhQUFPL0csTUFBUDtBQUNILEtBVE0sQ0FBUDtBQVVIOztBQUVELFFBQU1nSCxVQUFOLENBQWlCdEYsS0FBakIsRUFBd0J1RixRQUF4QixFQUFrQ3ZILE9BQWxDLEVBQTJDO0FBQ3ZDLFFBQUksS0FBS0EsT0FBTCxDQUFhbUMsWUFBakIsRUFBK0I7QUFDM0IsV0FBS3JCLEdBQUwsQ0FBUyxTQUFULEVBQW9CLGdCQUFnQnNCLElBQUksQ0FBQ0MsU0FBTCxDQUFlO0FBQUNMLFFBQUFBLEtBQUQ7QUFBUXVGLFFBQUFBLFFBQVI7QUFBa0J2SCxRQUFBQTtBQUFsQixPQUFmLENBQXBDO0FBQ0g7O0FBQ0QsV0FBTyxLQUFLc0MsYUFBTCxDQUFtQk4sS0FBbkIsRUFBMkJPLElBQUQsSUFBVUEsSUFBSSxDQUFDaUYsU0FBTCxDQUFlRCxRQUFmLEVBQXlCdkgsT0FBekIsRUFBa0MyQixPQUFsQyxFQUFwQyxDQUFQO0FBQ0g7O0FBRUQsUUFBTThGLFNBQU4sQ0FBZ0J6RixLQUFoQixFQUF1QjBGLEtBQXZCLEVBQThCakIsS0FBOUIsRUFBcUN6RyxPQUFyQyxFQUE4QztBQUMxQyxRQUFJLEtBQUtBLE9BQUwsQ0FBYW1DLFlBQWpCLEVBQStCO0FBQzNCLFdBQUtyQixHQUFMLENBQVMsU0FBVCxFQUFvQixlQUFlc0IsSUFBSSxDQUFDQyxTQUFMLENBQWU7QUFBQ0wsUUFBQUEsS0FBRDtBQUFRMEYsUUFBQUEsS0FBUjtBQUFlakIsUUFBQUEsS0FBZjtBQUFzQnpHLFFBQUFBO0FBQXRCLE9BQWYsQ0FBbkM7QUFDSDs7QUFDRCxXQUFPLEtBQUtzQyxhQUFMLENBQW1CTixLQUFuQixFQUEyQk8sSUFBRCxJQUFVQSxJQUFJLENBQUNvRixRQUFMLENBQWNELEtBQWQsRUFBcUJqQixLQUFyQixFQUE0QnpHLE9BQTVCLENBQXBDLENBQVA7QUFDSDs7QUFFRCxRQUFNNEgsTUFBTixDQUFhNUYsS0FBYixFQUFvQnlFLEtBQXBCLEVBQTJCekcsT0FBM0IsRUFBb0M7QUFDaEMsUUFBSSxLQUFLQSxPQUFMLENBQWFtQyxZQUFqQixFQUErQjtBQUMzQixXQUFLckIsR0FBTCxDQUFTLFNBQVQsRUFBb0IsWUFBWXNCLElBQUksQ0FBQ0MsU0FBTCxDQUFlO0FBQUNMLFFBQUFBLEtBQUQ7QUFBUXlFLFFBQUFBLEtBQVI7QUFBZXpHLFFBQUFBO0FBQWYsT0FBZixDQUFoQztBQUNIOztBQUNELFdBQU8sS0FBS3NDLGFBQUwsQ0FBbUJOLEtBQW5CLEVBQTJCTyxJQUFELElBQVVBLElBQUksQ0FBQ3NGLGNBQUwsQ0FBb0JwQixLQUFwQixFQUEyQnpHLE9BQTNCLENBQXBDLENBQVA7QUFDSDs7QUFFRCxRQUFNc0MsYUFBTixDQUFvQk4sS0FBcEIsRUFBMkI4RixRQUEzQixFQUFxQztBQUNqQyxXQUFPLEtBQUt0RyxRQUFMLENBQWNMLEVBQUUsSUFBSTJHLFFBQVEsQ0FBQzNHLEVBQUUsQ0FBQzRHLFVBQUgsQ0FBYy9GLEtBQWQsQ0FBRCxDQUE1QixDQUFQO0FBQ0g7O0FBRURtQixFQUFBQSxnQkFBZ0IsQ0FBQzRCLE1BQUQsRUFBUztBQUNyQixRQUFJUCxHQUFHLEdBQUcxRixDQUFDLENBQUNnRyxJQUFGLENBQU9DLE1BQVAsRUFBZXBGLFNBQWYsQ0FBVjs7QUFDQSxRQUFJb0UsTUFBTSxHQUFHakYsQ0FBQyxDQUFDa0osSUFBRixDQUFPakQsTUFBUCxFQUFlcEYsU0FBZixDQUFiOztBQUVBLFFBQUk2RSxHQUFHLENBQUNSLElBQVIsRUFBYztBQUNWUSxNQUFBQSxHQUFHLENBQUNSLElBQUosR0FBVyxFQUFFLEdBQUdRLEdBQUcsQ0FBQ1IsSUFBVDtBQUFlLFdBQUdEO0FBQWxCLE9BQVg7QUFDSCxLQUZELE1BRU8sSUFBSSxDQUFDakYsQ0FBQyxDQUFDcUYsT0FBRixDQUFVSixNQUFWLENBQUwsRUFBd0I7QUFDM0JTLE1BQUFBLEdBQUcsQ0FBQ1IsSUFBSixHQUFXRCxNQUFYO0FBQ0g7O0FBRUQsV0FBT1MsR0FBUDtBQUNIOztBQWxnQm9DOztBQXFnQnpDM0UsZ0JBQWdCLENBQUNvSSxTQUFqQixHQUE2Qi9JLE9BQTdCO0FBRUFnSixNQUFNLENBQUNDLE9BQVAsR0FBaUJ0SSxnQkFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCB7IF8sIHdhaXRVbnRpbF8gfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IHRyeVJlcXVpcmUgfSA9IHJlcXVpcmUoJy4uLy4uL3V0aWxzL2xpYicpO1xuY29uc3QgbW9uZ29kYiA9IHRyeVJlcXVpcmUoJ21vbmdvZGInKTtcbmNvbnN0IHsgTW9uZ29DbGllbnQsIEdyaWRGU0J1Y2tldCB9ID0gbW9uZ29kYjtcbmNvbnN0IENvbm5lY3RvciA9IHJlcXVpcmUoJy4uLy4uL0Nvbm5lY3RvcicpO1xuY29uc3QgR2VuZXJhdG9ycyA9IHJlcXVpcmUoJy4uLy4uL0dlbmVyYXRvcnMnKTtcbmNvbnN0IHsgSW52YWxpZEFyZ3VtZW50LCBEYXRhYmFzZUVycm9yIH0gPSByZXF1aXJlKCcuLi8uLi91dGlscy9FcnJvcnMnKTtcblxuY29uc3QgVXBkYXRlT3BzRmllbGQgPSBbICckY3VycmVudERhdGUnLCAnJGluYycsICckbWluJywgJyRtYXgnLCAnJG11bCcsICckcmVuYW1lJywgJyRzZXQnLCAnJHNldE9uSW5zZXJ0JywgJyR1bnNldCcgXTtcbmNvbnN0IFVwZGF0ZU9wc0FycmF5ID0gWyAnJGFkZFRvU2V0JywgJyRwb3AnLCAnJHB1bGwnLCAnJHB1c2gnLCAnJHB1bGxBbGwnIF07XG5jb25zdCBVcGRhdGVPcHMgPSBVcGRhdGVPcHNGaWVsZC5jb25jYXQoVXBkYXRlT3BzQXJyYXkpO1xuXG4vKipcbiAqIE1vbmdvZGIgZGF0YSBzdG9yYWdlIGNvbm5lY3Rvci5cbiAqIEBjbGFzc1xuICogQGV4dGVuZHMgQ29ubmVjdG9yXG4gKi9cbmNsYXNzIE1vbmdvZGJDb25uZWN0b3IgZXh0ZW5kcyBDb25uZWN0b3Ige1xuICAgIC8qKiAgICAgICAgICBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gb3B0aW9ucyBcbiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IFtvcHRpb25zLnVzZVByZXBhcmVkU3RhdGVtZW50XSAtIFxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKGNvbm5lY3Rpb25TdHJpbmcsIG9wdGlvbnMpIHsgICAgICAgIFxuICAgICAgICBzdXBlcignbW9uZ29kYicsIGNvbm5lY3Rpb25TdHJpbmcsIG9wdGlvbnMpOyAgICBcbiAgICAgICAgXG4gICAgICAgIHRoaXMubG9ja2VyRmllbGQgPSB0aGlzLm9wdGlvbnMubG9ja2VyRmllbGQgfHwgJ19fbG9ja19fJztcbiAgICB9XG5cbiAgICBmaW5kQWxsXyA9IHRoaXMuZmluZF87XG5cbiAgICAvKipcbiAgICAgKiBUaHJvdyBkYiBlcnJvciBpZiBubyByZWNvcmQgaW5zZXJ0ZWRcbiAgICAgKiBAcGFyYW0ge2luc2VydE9uZVdyaXRlT3BSZXN1bHRPYmplY3R9IG9wUmV0dXJuIFxuICAgICAqL1xuICAgIGVuc3VyZUluc2VydE9uZShvcFJldHVybikge1xuICAgICAgICBpZiAob3BSZXR1cm4ucmVzdWx0Lm9rICE9PSAxIHx8IG9wUmV0dXJuLnJlc3VsdC5uICE9PSAxKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRGF0YWJhc2VFcnJvcignSW5zZXJ0IG9wZXJhdGlvbiBmYWlsZWQnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBvcFJldHVybi5pbnNlcnRlZElkO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENsb3NlIGFsbCBjb25uZWN0aW9uIGluaXRpYXRlZCBieSB0aGlzIGNvbm5lY3Rvci5cbiAgICAgKi9cbiAgICBhc3luYyBlbmRfKCkge1xuICAgICAgICBpZiAodGhpcy5jbGllbnQgJiYgdGhpcy5jbGllbnQuaXNDb25uZWN0ZWQoKSkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5jbGllbnQuY2xvc2UoKTtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYG1vbmdvZGI6IHN1Y2Nlc3NmdWxseSBkaXNjb25uZWN0ZWQgZnJvbSBcIiR7dGhpcy5nZXRDb25uZWN0aW9uU3RyaW5nV2l0aG91dENyZWRlbnRpYWwoKX1cIi5gKTsgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgIH1cblxuICAgICAgICBkZWxldGUgdGhpcy5jbGllbnQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgZGF0YWJhc2UgY29ubmVjdGlvbiBiYXNlZCBvbiB0aGUgZGVmYXVsdCBjb25uZWN0aW9uIHN0cmluZyBvZiB0aGUgY29ubmVjdG9yIGFuZCBnaXZlbiBvcHRpb25zLiAgICAgXG4gICAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXSAtIEV4dHJhIG9wdGlvbnMgZm9yIHRoZSBjb25uZWN0aW9uLCBvcHRpb25hbC5cbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtvcHRpb25zLm11bHRpcGxlU3RhdGVtZW50cz1mYWxzZV0gLSBBbGxvdyBydW5uaW5nIG11bHRpcGxlIHN0YXRlbWVudHMgYXQgYSB0aW1lLlxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbH0gW29wdGlvbnMuY3JlYXRlRGF0YWJhc2U9ZmFsc2VdIC0gRmxhZyB0byB1c2VkIHdoZW4gY3JlYXRpbmcgYSBkYXRhYmFzZS5cbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZS48RGI+fVxuICAgICAqL1xuICAgIGFzeW5jIGNvbm5lY3RfKG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKCF0aGlzLmNsaWVudCB8fCAhdGhpcy5jbGllbnQuaXNDb25uZWN0ZWQoKSkge1xuICAgICAgICAgICAgbGV0IGNsaWVudCA9IG5ldyBNb25nb0NsaWVudCh0aGlzLmNvbm5lY3Rpb25TdHJpbmcsIHt1c2VOZXdVcmxQYXJzZXI6IHRydWV9KTtcbiAgICAgICAgICAgIHRoaXMuY2xpZW50ID0gYXdhaXQgY2xpZW50LmNvbm5lY3QoKTsgXG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGBtb25nb2RiOiBzdWNjZXNzZnVsbHkgY29ubmVjdGVkIHRvIFwiJHt0aGlzLmdldENvbm5lY3Rpb25TdHJpbmdXaXRob3V0Q3JlZGVudGlhbCgpfVwiLmApOyAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgfSAgICAgICBcblxuICAgICAgICByZXR1cm4gdGhpcy5jbGllbnQuZGIodGhpcy5kYXRhYmFzZSk7XG4gICAgfVxuICAgIFxuICAgIC8qKlxuICAgICAqIENsb3NlIGEgZGF0YWJhc2UgY29ubmVjdGlvbi5cbiAgICAgKiBAcGFyYW0ge0RifSBjb25uIC0gTXlTUUwgY29ubmVjdGlvbi5cbiAgICAgKi9cbiAgICBhc3luYyBkaXNjb25uZWN0Xyhjb25uKSB7XG4gICAgfVxuXG4gICAgYXN5bmMgcGluZ18oKSB7ICBcbiAgICAgICAgcmV0dXJuIHRoaXMuZXhlY3V0ZV8oZGIgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGRiLmxpc3RDb2xsZWN0aW9ucyhudWxsLCB7IG5hbWVPbmx5OiB0cnVlIH0pLnRvQXJyYXkoKTtcbiAgICAgICAgfSk7ICBcbiAgICB9XG5cbiAgICBhc3luYyBleGVjdXRlXyhkYkV4ZWN1dG9yKSB7XG4gICAgICAgIGxldCBkYjtcbiAgICBcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGRiID0gYXdhaXQgdGhpcy5jb25uZWN0XygpO1xuXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgZGJFeGVjdXRvcihkYik7XG4gICAgICAgIH0gY2F0Y2goZXJyKSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICBkYiAmJiBhd2FpdCB0aGlzLmRpc2Nvbm5lY3RfKGRiKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbb3B0aW9uc10gLSBPcHRpb25hbCBzZXR0aW5ncy5cbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuYnVja2V0TmFtZT0nZnMnXSAtIFRoZSAnZmlsZXMnIGFuZCAnY2h1bmtzJyBjb2xsZWN0aW9ucyB3aWxsIGJlIHByZWZpeGVkIHdpdGggdGhlIGJ1Y2tldCBuYW1lIGZvbGxvd2VkIGJ5IGEgZG90LlxuICAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBbb3B0aW9ucy5jaHVua1NpemVCeXRlc10gLSBOdW1iZXIgb2YgYnl0ZXMgc3RvcmVkIGluIGVhY2ggY2h1bmsuIERlZmF1bHRzIHRvIDI1NUtCXG4gICAgICogQHByb3BlcnR5IHtvYmplY3R9IFtvcHRpb25zLndyaXRlQ29uY2Vybl1cbiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gW29wdGlvbnMucmVhZFByZWZlcmVuY2VdXG4gICAgICovXG4gICAgYXN5bmMgY3JlYXRlR3JpZEZTQnVja2V0XyhvcHRpb25zKSB7XG4gICAgICAgIGxldCBkYiA9IGF3YWl0IHRoaXMuY29ubmVjdF8oKTtcblxuICAgICAgICByZXR1cm4gbmV3IEdyaWRGU0J1Y2tldChkYiwgb3B0aW9ucyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgbmV3IGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGluc2VydE9uZV8obW9kZWwsIGRhdGEsIG9wdGlvbnMpIHtcbiAgICAgICAgb3B0aW9ucyA9IHsgYnlwYXNzRG9jdW1lbnRWYWxpZGF0aW9uOiB0cnVlLCAuLi5vcHRpb25zIH07XG5cbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ2luc2VydE9uZTogJyArIEpTT04uc3RyaW5naWZ5KHttb2RlbCwgZGF0YSwgb3B0aW9uc30pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmluc2VydE9uZShkYXRhLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGFuIGFycmF5IG9mIG5ldyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7YXJyYXl9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGluc2VydE1hbnlfKG1vZGVsLCBkYXRhLCBvcHRpb25zKSB7XG4gICAgICAgIG9wdGlvbnMgPSB7IGJ5cGFzc0RvY3VtZW50VmFsaWRhdGlvbjogdHJ1ZSwgb3JkZXJlZDogZmFsc2UsIC4uLm9wdGlvbnMgfTtcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ2luc2VydE1hbnk6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIGNvdW50OiBkYXRhLmxlbmd0aCwgb3B0aW9uc30pKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5pbnNlcnRNYW55KGRhdGEsIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBuZXcgZW50aXR5IGlmIG5vdCBleGlzdC5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBpbnNlcnRPbmVJZk5vdEV4aXN0Xyhtb2RlbCwgZGF0YSwgb3B0aW9ucykge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuaW5zZXJ0T25lXyhtb2RlbCwgZGF0YSwgb3B0aW9ucylcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGlmIChlcnJvci5jb2RlID09PSAxMTAwMCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgYW4gZXhpc3RpbmcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgdXBkYXRlT25lXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7IFxuICAgICAgICBkYXRhID0gdGhpcy5fdHJhbnNsYXRlVXBkYXRlKGRhdGEpO1xuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ1N0YXRlbWVudCkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAndXBkYXRlT25lOiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnN9KSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwudXBkYXRlT25lKGNvbmRpdGlvbiwgZGF0YSwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZSBhbiBleGlzdGluZyBlbnRpdHkgYW5kIHJldHVybiB0aGUgdXBkYXRlZCByZWNvcmQuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgdXBkYXRlT25lQW5kUmV0dXJuXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7ICAgICAgICAgICAgXG4gICAgICAgIGxldCByZXQgPSBhd2FpdCB0aGlzLmZpbmRPbmVBbmRVcGRhdGVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIHsgLi4ub3B0aW9ucywgdXBzZXJ0OiBmYWxzZSwgcmV0dXJuT3JpZ2luYWw6IGZhbHNlIH0pO1xuICAgICAgICByZXR1cm4gcmV0ICYmIHJldC52YWx1ZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgYW4gZXhpc3RpbmcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGFPbkluc2VydCAtIFNoYXJlZCBkYXRhIG9uIGluc2VydFxuICAgICAqL1xuICAgIGFzeW5jIHVwc2VydE9uZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucywgZGF0YU9uSW5zZXJ0KSB7IFxuICAgICAgICBsZXQgdHJhbnMgPSB0aGlzLl90cmFuc2xhdGVVcGRhdGUoZGF0YSk7XG4gICAgICAgIGxldCB7IF9pZCwgLi4ub3RoZXJzIH0gPSB0cmFucy4kc2V0IHx8IHt9OyBcbiAgICAgICAgaWYgKCFfLmlzTmlsKF9pZCkpIHtcbiAgICAgICAgICAgIHRyYW5zLiRzZXQgPSBvdGhlcnM7XG4gICAgICAgICAgICB0cmFucy4kc2V0T25JbnNlcnQgPSB7IF9pZCB9O1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFfLmlzRW1wdHkoZGF0YU9uSW5zZXJ0KSkge1xuICAgICAgICAgICAgdHJhbnMuJHNldE9uSW5zZXJ0ID0geyAuLi50cmFucy4kc2V0T25JbnNlcnQsIC4uLmRhdGFPbkluc2VydCB9O1xuICAgICAgICB9XG5cbiAgICAgICAgb3B0aW9ucyA9IHsgLi4ub3B0aW9ucywgdXBzZXJ0OiB0cnVlIH07XG5cbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ3Vwc2VydE9uZTogJyArIEpTT04uc3RyaW5naWZ5KHttb2RlbCwgZGF0YTogdHJhbnMsIGNvbmRpdGlvbiwgb3B0aW9uc30pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLnVwZGF0ZU9uZShjb25kaXRpb24sIHRyYW5zLCBvcHRpb25zKSk7ICAgICAgICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcHNlcnQgYW4gZW50aXR5IGFuZCByZXR1cm4gdXBkYXRlZC5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhT25JbnNlcnQgLSBTaGFyZWQgZGF0YSBvbiBpbnNlcnRcbiAgICAgKi9cbiAgICBhc3luYyB1cHNlcnRPbmVBbmRSZXR1cm5fKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMsIGRhdGFPbkluc2VydCkgeyBcbiAgICAgICAgbGV0IHRyYW5zID0gdGhpcy5fdHJhbnNsYXRlVXBkYXRlKGRhdGEpO1xuICAgICAgICBsZXQgeyBfaWQsIC4uLm90aGVycyB9ID0gdHJhbnMuJHNldCB8fCB7fTsgXG4gICAgICAgIGlmICghXy5pc05pbChfaWQpKSB7XG4gICAgICAgICAgICB0cmFucy4kc2V0ID0gb3RoZXJzO1xuICAgICAgICAgICAgdHJhbnMuJHNldE9uSW5zZXJ0ID0geyBfaWQgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghXy5pc0VtcHR5KGRhdGFPbkluc2VydCkpIHtcbiAgICAgICAgICAgIHRyYW5zLiRzZXRPbkluc2VydCA9IHsgLi4udHJhbnMuJHNldE9uSW5zZXJ0LCAuLi5kYXRhT25JbnNlcnQgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIG9wdGlvbnMgPSB7IC4uLm9wdGlvbnMsIHVwc2VydDogdHJ1ZSwgcmV0dXJuT3JpZ2luYWw6IGZhbHNlIH07XG5cbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ3Vwc2VydE9uZTogJyArIEpTT04uc3RyaW5naWZ5KHttb2RlbCwgZGF0YTogdHJhbnMsIGNvbmRpdGlvbiwgb3B0aW9uc30pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCByZXQgPSBhd2FpdCB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmZpbmRPbmVBbmRVcGRhdGUoY29uZGl0aW9uLCB0cmFucywgb3B0aW9ucykpO1xuICAgICAgICByZXR1cm4gcmV0ICYmIHJldC52YWx1ZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgbWFueSBlbnRpdGllcy5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgLSBBcnJheSBvZiByZWNvcmQgd2l0aCBfaWRcbiAgICAgKiBAcGFyYW0ge2FycmF5fSB1bmlxdWVLZXlzIC0gVW5pcXVlIGtleXMgaW4gdGhlIGRhdGEgcmVjb3JkIHVzZWQgYXMgZmlsdGVyXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhT25JbnNlcnQgLSBTaGFyZWQgZGF0YSBvbiBpbnNlcnRcbiAgICAgKi9cbiAgICBhc3luYyB1cHNlcnRNYW55Xyhtb2RlbCwgZGF0YSwgdW5pcXVlS2V5cywgb3B0aW9ucywgZGF0YU9uSW5zZXJ0KSB7IFxuICAgICAgICBsZXQgb3BzID0gZGF0YS5tYXAocmVjb3JkID0+IHtcbiAgICAgICAgICAgIGxldCB7IF9pZCwgLi4udXBkYXRlRGF0YSB9ID0gcmVjb3JkO1xuXG4gICAgICAgICAgICBsZXQgdXBkYXRlT3AgPSB0aGlzLl90cmFuc2xhdGVVcGRhdGUodXBkYXRlRGF0YSk7XG5cbiAgICAgICAgICAgIGlmIChfaWQpIHtcbiAgICAgICAgICAgICAgICB1cGRhdGVPcC4kc2V0T25JbnNlcnQgPSB7IF9pZCwgLi4uZGF0YU9uSW5zZXJ0IH07XG4gICAgICAgICAgICB9IGVsc2UgaWYgKCFfLmlzRW1wdHkoZGF0YU9uSW5zZXJ0KSkge1xuICAgICAgICAgICAgICAgIHVwZGF0ZU9wLiRzZXRPbkluc2VydCA9IGRhdGFPbkluc2VydDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICB1cGRhdGVPbmU6IHsgZmlsdGVyOiB7IC4uLl8ucGljayhyZWNvcmQsIHVuaXF1ZUtleXMpIH0sIHVwZGF0ZTogdXBkYXRlT3AsIHVwc2VydDogdHJ1ZSB9XG4gICAgICAgICAgICB9O1xuICAgICAgICB9KTtcblxuICAgICAgICBvcHRpb25zID0geyBieXBhc3NEb2N1bWVudFZhbGlkYXRpb246IHRydWUsIG9yZGVyZWQ6IGZhbHNlLCAuLi5vcHRpb25zIH07XG5cbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ2J1bGtXcml0ZTogJyArIEpTT04uc3RyaW5naWZ5KHttb2RlbCwgY291bnQ6IG9wcy5sZW5ndGgsIG9wdGlvbnN9KSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5idWxrV3JpdGUob3BzLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIG1hbnkgZW50aXRpZXMgYW5kIHJldHVybiB1cGRhdGVkLlxuICAgICAqIEBwYXJhbSB7Kn0gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyB1cGRhdGVNYW55QW5kUmV0dXJuXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7ICAgICAgICBcbiAgICAgICAgbGV0IGxvY2tlcklkID0gR2VuZXJhdG9ycy5zaG9ydGlkKCk7XG5cbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ3VwZGF0ZU1hbnkrZmluZCt1cGRhdGVNYW55OiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBjb3VudDogZGF0YS5sZW5ndGgsIGNvbmRpdGlvbiwgb3B0aW9uc30pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIGFzeW5jIChjb2xsKSA9PiB7XG4gICAgICAgICAgICAvLzEudXBkYXRlIGFuZCBzZXQgbG9ja2VyXG4gICAgICAgICAgICBsZXQgcmV0ID0gYXdhaXQgY29sbC51cGRhdGVNYW55KFxuICAgICAgICAgICAgICAgIHsgLi4uY29uZGl0aW9uLCBbdGhpcy5sb2NrZXJGaWVsZF06IHsgJGV4aXN0czogZmFsc2UgfSB9LCAvLyBmb3IgYWxsIG5vbi1sb2NrZWRcbiAgICAgICAgICAgICAgICB7ICRzZXQ6IHsgLi4uZGF0YSwgW3RoaXMubG9ja2VyRmllbGRdOiBsb2NrZXJJZCB9IH0sIC8vIGxvY2sgaXQgXG4gICAgICAgICAgICAgICAgeyAuLi5vcHRpb25zLCB1cHNlcnQ6IGZhbHNlIH0gKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAvLzIucmV0dXJuIGFsbCBsb2NrZWQgcmVjb3Jkc1xuICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCBjb2xsLmZpbmQoeyBbdGhpcy5sb2NrZXJGaWVsZF06IGxvY2tlcklkIH0sIHsgcHJvamVjdGlvbjogeyBbdGhpcy5sb2NrZXJGaWVsZF06IDAgfSB9KS50b0FycmF5KCk7IC8vIHJldHVybiBhbGwgbG9ja2VkXG4gICAgICAgICAgICB9IGZpbmFsbHkgeyAgICBcbiAgICAgICAgICAgICAgICAvLzMucmVtb3ZlIGxvY2tlcnNcbiAgICAgICAgICAgICAgICBpZiAocmV0LnJlc3VsdC5uTW9kaWZpZWQgPiAwKSB7IC8vIHVubG9ja1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCBjb2xsLnVwZGF0ZU1hbnkoeyBbdGhpcy5sb2NrZXJGaWVsZF06IGxvY2tlcklkIH0sIHsgJHVuc2V0OiB7IFt0aGlzLmxvY2tlckZpZWxkXTogXCJcIiB9IH0sIHsgdXBzZXJ0OiBmYWxzZSB9KTsgICAgXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTsgICAgICAgICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBJbnNlcnQgbWFueSBlbnRpdGllcyBpZiBub3QgZXhpc3QuXG4gICAgICogQHBhcmFtIHsqfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0geyp9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSB1bmlxdWVLZXlzIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBpbnNlcnRNYW55SWZOb3RFeGlzdF8obW9kZWwsIGRhdGEsIHVuaXF1ZUtleXMsIG9wdGlvbnMpIHtcbiAgICAgICAgY29uc29sZS5sb2coJ2J1Z2d5OiB0b2ZpeCcpO1xuICAgICAgICBsZXQgb3BzID0gZGF0YS5tYXAocmVjb3JkID0+ICh7XG4gICAgICAgICAgICB1cGRhdGVPbmU6IHsgZmlsdGVyOiB7IC4uLl8ucGljayhyZWNvcmQsIHVuaXF1ZUtleXMpIH0sIHVwZGF0ZTogeyAkc2V0T25JbnNlcnQ6IHJlY29yZCB9LCB1cHNlcnQ6IHRydWUgfVxuICAgICAgICB9KSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuYnVsa1dyaXRlKG9wcywgeyBieXBhc3NEb2N1bWVudFZhbGlkYXRpb246IHRydWUsIG9yZGVyZWQ6IGZhbHNlLCAuLi5vcHRpb25zIH0pKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgbXVsdGlwbGUgZG9jdW1lbnRzLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0geyp9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIHVwZGF0ZU1hbnlfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgXG4gICAgICAgIGRhdGEgPSB0aGlzLl90cmFuc2xhdGVVcGRhdGUoZGF0YSk7XG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICd1cGRhdGVNYW55OiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBjb3VudDogZGF0YS5sZW5ndGgsIGNvbmRpdGlvbiwgb3B0aW9uc30pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLnVwZGF0ZU1hbnkoY29uZGl0aW9uLCBkYXRhLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVwbGFjZSBhbiBleGlzdGluZyBlbnRpdHkgb3IgY3JlYXRlIGEgbmV3IG9uZS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIHJlcGxhY2VPbmVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ3JlcGxhY2VPbmU6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9uc30pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLnJlcGxhY2VPbmUoY29uZGl0aW9uLCBkYXRhLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlIGFuIGV4aXN0aW5nIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGRlbGV0ZU9uZV8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ1N0YXRlbWVudCkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAnZGVsZXRlT25lOiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBjb25kaXRpb24sIG9wdGlvbnN9KSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5kZWxldGVPbmUoY29uZGl0aW9uLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlIGFuIGV4aXN0aW5nIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGRlbGV0ZU1hbnlfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ2RlbGV0ZU1hbnk6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9uc30pKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5kZWxldGVNYW55KGNvbmRpdGlvbiwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlcGxhY2UgKGluc2VydCBvciB1cGRhdGUgZm9yIGV4c2lzdGluZykgYW4gZW50aXR5IGFuZCByZXR1cm4gb3JpZ2luYWwgcmVjb3JkLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgZmluZE9uZUFuZFJlcGxhY2VfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ2ZpbmRPbmVBbmRSZXBsYWNlOiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBkYXRhLCBvcHRpb25zfSkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmZpbmRPbmVBbmRSZXBsYWNlKGNvbmRpdGlvbiwgZGF0YSwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEZpbmQgYSBkb2N1bWVudCBhbmQgdXBkYXRlIGl0IGluIG9uZSBhdG9taWMgb3BlcmF0aW9uLiBSZXF1aXJlcyBhIHdyaXRlIGxvY2sgZm9yIHRoZSBkdXJhdGlvbiBvZiB0aGUgb3BlcmF0aW9uLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgZmluZE9uZUFuZFVwZGF0ZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykgeyAgICAgXG4gICAgICAgIGRhdGEgPSB0aGlzLl90cmFuc2xhdGVVcGRhdGUoZGF0YSk7XG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdmaW5kT25lQW5kVXBkYXRlOiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnN9KSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZmluZE9uZUFuZFVwZGF0ZShjb25kaXRpb24sIGRhdGEsIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICBhc3luYyBmaW5kT25lQW5kRGVsZXRlXyhtb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdmaW5kT25lQW5kRGVsZXRlOiAnICsgSlNPTi5zdHJpbmdpZnkoe21vZGVsLCBjb25kaXRpb24sIG9wdGlvbnN9KSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZmluZE9uZUFuZERlbGV0ZShjb25kaXRpb24sIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICBhc3luYyBmaW5kT25lXyhtb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIGxldCBxdWVyeU9wdGlvbnMgPSB7Li4ub3B0aW9uc307XG4gICAgICAgIGxldCBxdWVyeTtcblxuICAgICAgICBpZiAoIV8uaXNFbXB0eShjb25kaXRpb24pKSB7XG4gICAgICAgICAgICBsZXQgeyAkcHJvamVjdGlvbiwgJHF1ZXJ5LCAuLi5vdGhlcnMgfSA9IGNvbmRpdGlvbjtcblxuICAgICAgICAgICAgaWYgKCRwcm9qZWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLnByb2plY3Rpb24gPSAkcHJvamVjdGlvbjsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHF1ZXJ5ID0geyAuLi5vdGhlcnMsIC4uLiRxdWVyeSB9O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRBcmd1bWVudCgnZmluZE9uZSByZXF1aXJlcyBub24tZW1wdHkgcXVlcnkgY29uZGl0aW9uLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ2ZpbmRPbmU6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIGNvbmRpdGlvbjogcXVlcnksIG9wdGlvbnM6IHF1ZXJ5T3B0aW9uc30pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmZpbmRPbmUocXVlcnksIHF1ZXJ5T3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFBlcmZvcm0gc2VsZWN0IG9wZXJhdGlvbi5cbiAgICAgKiBAcGFyYW0geyp9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBmaW5kXyhtb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIGxldCBxdWVyeU9wdGlvbnMgPSB7Li4ub3B0aW9uc307XG4gICAgICAgIGxldCBxdWVyeSwgcmVxdWlyZVRvdGFsQ291bnQ7XG5cbiAgICAgICAgaWYgKCFfLmlzRW1wdHkoY29uZGl0aW9uKSkge1xuICAgICAgICAgICAgbGV0IHsgJHByb2plY3Rpb24sICR0b3RhbENvdW50LCAkb3JkZXJCeSwgJG9mZnNldCwgJGxpbWl0LCAkcXVlcnksIC4uLm90aGVycyB9ID0gY29uZGl0aW9uO1xuXG4gICAgICAgICAgICBpZiAoJHByb2plY3Rpb24pIHtcbiAgICAgICAgICAgICAgICBxdWVyeU9wdGlvbnMucHJvamVjdGlvbiA9ICRwcm9qZWN0aW9uOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCRvcmRlckJ5KSB7XG4gICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLnNvcnQgPSAkb3JkZXJCeTsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICgkb2Zmc2V0KSB7XG4gICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLnNraXAgPSAkb2Zmc2V0OyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCRsaW1pdCkge1xuICAgICAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucy5saW1pdCA9ICRsaW1pdDsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHF1ZXJ5ID0geyAuLi5vdGhlcnMsIC4uLiRxdWVyeSB9O1xuICAgICAgICAgICAgcmVxdWlyZVRvdGFsQ291bnQgPSAkdG90YWxDb3VudDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHF1ZXJ5ID0ge307XG4gICAgICAgICAgICByZXF1aXJlVG90YWxDb3VudCA9IGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dTdGF0ZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ2ZpbmQ6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIGNvbmRpdGlvbjogcXVlcnksIG9wdGlvbnM6IHF1ZXJ5T3B0aW9uc30pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIGFzeW5jIGNvbGwgPT4geyAgICAgICAgICAgIFxuICAgICAgICAgICAgbGV0IHJlc3VsdCA9IGF3YWl0IGNvbGwuZmluZChxdWVyeSwgcXVlcnlPcHRpb25zKS50b0FycmF5KCk7XG5cbiAgICAgICAgICAgIGlmIChyZXF1aXJlVG90YWxDb3VudCkge1xuICAgICAgICAgICAgICAgIGxldCB0b3RhbENvdW50ID0gYXdhaXQgY29sbC5maW5kKHF1ZXJ5KS5jb3VudCgpO1xuICAgICAgICAgICAgICAgIHJldHVybiBbIHJlc3VsdCwgdG90YWxDb3VudCBdO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9KTtcbiAgICB9ICAgXG5cbiAgICBhc3luYyBhZ2dyZWdhdGVfKG1vZGVsLCBwaXBlbGluZSwgb3B0aW9ucykgeyAgICAgICAgXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdhZ2dyZWdhdGU6ICcgKyBKU09OLnN0cmluZ2lmeSh7bW9kZWwsIHBpcGVsaW5lLCBvcHRpb25zfSkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmFnZ3JlZ2F0ZShwaXBlbGluZSwgb3B0aW9ucykudG9BcnJheSgpKTtcbiAgICB9XG5cbiAgICBhc3luYyBkaXN0aW5jdF8obW9kZWwsIGZpZWxkLCBxdWVyeSwgb3B0aW9ucykgeyAgICAgICAgXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdkaXN0aW5jdDogJyArIEpTT04uc3RyaW5naWZ5KHttb2RlbCwgZmllbGQsIHF1ZXJ5LCBvcHRpb25zfSkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmRpc3RpbmN0KGZpZWxkLCBxdWVyeSwgb3B0aW9ucykpO1xuICAgIH0gICAgXG5cbiAgICBhc3luYyBjb3VudF8obW9kZWwsIHF1ZXJ5LCBvcHRpb25zKSB7XG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nU3RhdGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdjb3VudDogJyArIEpTT04uc3RyaW5naWZ5KHttb2RlbCwgcXVlcnksIG9wdGlvbnN9KSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuY291bnREb2N1bWVudHMocXVlcnksIG9wdGlvbnMpKTsgICAgICAgIFxuICAgIH1cblxuICAgIGFzeW5jIG9uQ29sbGVjdGlvbl8obW9kZWwsIGV4ZWN1dG9yKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmV4ZWN1dGVfKGRiID0+IGV4ZWN1dG9yKGRiLmNvbGxlY3Rpb24obW9kZWwpKSk7XG4gICAgfVxuXG4gICAgX3RyYW5zbGF0ZVVwZGF0ZSh1cGRhdGUpIHtcbiAgICAgICAgbGV0IG9wcyA9IF8ucGljayh1cGRhdGUsIFVwZGF0ZU9wcyk7XG4gICAgICAgIGxldCBvdGhlcnMgPSBfLm9taXQodXBkYXRlLCBVcGRhdGVPcHMpO1xuXG4gICAgICAgIGlmIChvcHMuJHNldCkge1xuICAgICAgICAgICAgb3BzLiRzZXQgPSB7IC4uLm9wcy4kc2V0LCAuLi5vdGhlcnMgfTtcbiAgICAgICAgfSBlbHNlIGlmICghXy5pc0VtcHR5KG90aGVycykpIHtcbiAgICAgICAgICAgIG9wcy4kc2V0ID0gb3RoZXJzO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG9wcztcbiAgICB9XG59XG5cbk1vbmdvZGJDb25uZWN0b3IuZHJpdmVyTGliID0gbW9uZ29kYjtcblxubW9kdWxlLmV4cG9ydHMgPSBNb25nb2RiQ29ubmVjdG9yOyJdfQ==