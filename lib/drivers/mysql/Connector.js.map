{"version":3,"sources":["../../../src/drivers/mysql/Connector.js"],"names":["_","require","tryRequire","mysql","Connector","ApplicationError","InvalidArgument","isQuoted","ntol","MySQLConnector","typeCast","value","t","isLuxonDateTime","toISO","includeOffset","constructor","connectionString","options","escape","escapeId","format","raw","queryCount","alias","fieldName","type","name","args","$call","$as","nullOrIs","$exists","$eq","updatedCount","context","result","affectedRows","deletedCount","insertOne_","create_","updateOne_","update_","relational","acitveConnections","Set","end_","size","conn","disconnect_","pool","log","currentConnectionString","end","connect_","csKey","connProps","createDatabase","database","pick","makeNewConnectionString","createPool","getConnection","add","delete","release","beginTransaction_","isolationLevel","find","IsolationLevels","key","query","ret","$$autocommit","commit_","rollback_","execute_","sql","params","_getConnection_","usePreparedStatement","logStatement","rowsAsArray","execute","rows1","rows2","err","info","truncate","length","_releaseConnection_","ping_","ping","model","data","isEmpty","insertIgnore","restOptions","push","upsertOne_","uniqueKeys","dataOnInsert","dataWithoutUK","omit","insertData","upsertMany_","fieldsOnInsert","dataArrayOnInsert","dataExprOnUpdate","Array","isArray","map","f","join","insertMany_","fields","queryOptions","connOptions","aliasMap","joinings","hasJoining","joiningParams","$relationships","_joinAssociations","forEach","p","$requireSplitColumns","_splitColumnsAsInput","whereClause","_joinCondition","replace_","delete_","deleteOptions","find_","condition","sqlInfo","buildQuery","totalCount","countSql","countResult","count","reverseAliasMap","reduce","nodePath","split","slice","concat","$skipOrm","$projection","$query","$groupBy","$orderBy","$offset","$limit","$totalCount","selectColomns","_buildColumns","_buildGroupBy","_buildOrderBy","countSubject","_escapeIdWithAlias","isInteger","getInsertedId","insertId","undefined","getNumOfAffectedRows","_generateAlias","index","anchor","verboseAlias","snakeCase","toUpperCase","associations","parentAliasKey","parentAlias","startId","each","assocInfo","joinType","on","output","entity","subAssocs","aliasKey","subJoinings","joinOperator","c","isPlainObject","startsWith","Error","oorType","left","_packValue","right","op","_wrapCondition","JSON","stringify","_replaceFieldNameWithAlias","mainEntity","parts","actualFieldName","pop","v","_packArray","array","inject","isNil","$in","hasOperator","Object","keys","k","indexOf","columns","castArray","col","_buildColumn","lastDotIndex","lastIndexOf","substr","fullPath","aliasPrefix","prefix","expr","groupBy","by","having","groupByClause","havingCluse","orderBy","asc","connection","freeze","RepeatableRead","ReadCommitted","ReadUncommitted","Rerializable","driverLib","module","exports"],"mappings":"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","sourcesContent":["const { _ } = require('@genx/july');\nconst { tryRequire } = require('@genx/sys');\nconst mysql = tryRequire('mysql2/promise');\nconst Connector = require('../../Connector');\nconst { ApplicationError, InvalidArgument } = require('../../utils/Errors');\nconst { isQuoted } = require('../../utils/lang');\nconst ntol = require('number-to-letter');\n\n/**\n * MySQL data storage connector.\n * @class\n * @extends Connector\n */\nclass MySQLConnector extends Connector {\n    /**\n     * Transaction isolation level\n     * {@link https://dev.mysql.com/doc/refman/8.0/en/innodb-transaction-isolation-levels.html}\n     * @member {object}\n     */\n    static IsolationLevels = Object.freeze({\n        RepeatableRead: 'REPEATABLE READ',\n        ReadCommitted: 'READ COMMITTED',\n        ReadUncommitted: 'READ UNCOMMITTED',\n        Rerializable: 'SERIALIZABLE',\n    });\n\n    escape = mysql.escape;\n    escapeId = mysql.escapeId;\n    format = mysql.format;\n    raw = mysql.raw;\n    queryCount = (alias, fieldName) => ({\n        type: 'function',\n        name: 'COUNT',\n        args: [fieldName || '*'],\n        alias: alias || 'count',\n    });\n\n    $call = (name, alias, args) => ({ type: 'function', name, alias, args });\n    $as = (name, alias) => ({ type: 'column', name, alias });\n\n    // in mysql, null value comparison will never return true, even null != 1\n    nullOrIs = (fieldName, value) => [\n        { [fieldName]: { $exists: false } },\n        { [fieldName]: { $eq: value } },\n    ];\n\n    updatedCount = (context) => context.result.affectedRows;\n    deletedCount = (context) => context.result.affectedRows;\n\n    typeCast(value) {\n        const t = typeof value;\n\n        if (t === 'boolean') return value ? 1 : 0;\n\n        if (t === 'object') {\n            if (value != null && value.isLuxonDateTime) {\n                return value.toISO({ includeOffset: false });\n            }\n        }\n\n        return value;\n    }\n\n    /**\n     * @param {string} name\n     * @param {object} options\n     * @property {boolean} [options.usePreparedStatement] - Flat to use prepared statement to improve query performance.\n     * @property {boolean} [options.logStatement] - Flag to log executed SQL statement.\n     */\n    constructor(connectionString, options) {\n        super('mysql', connectionString, options);\n\n        this.relational = true;\n        this.acitveConnections = new Set();\n    }\n\n    /**\n     * Close all connection initiated by this connector.\n     */\n    async end_() {\n        if (this.acitveConnections.size > 0) {\n            for (const conn of this.acitveConnections) {\n                await this.disconnect_(conn);\n            }\n        }\n\n        if (this.pool) {\n            this.log(\n                'debug',\n                `Close connection pool to ${this.currentConnectionString}`\n            );\n            await this.pool.end();\n            delete this.pool;\n        }\n    }\n\n    /**\n     * Create a database connection based on the default connection string of the connector and given options.\n     * @param {Object} [options] - Extra options for the connection, optional.\n     * @property {bool} [options.multipleStatements=false] - Allow running multiple statements at a time.\n     * @property {bool} [options.createDatabase=false] - Flag to used when creating a database.\n     * @returns {Promise.<MySQLConnection>}\n     */\n    async connect_(options) {\n        let csKey = this.connectionString;\n        if (!this.currentConnectionString) {\n            this.currentConnectionString = csKey;\n        }\n\n        if (options) {\n            const connProps = {};\n\n            if (options.createDatabase) {\n                // remove the database from connection\n                connProps.database = '';\n            }\n\n            connProps.options = _.pick(options, ['multipleStatements']);\n\n            csKey = this.makeNewConnectionString(connProps);\n        }\n\n        if (csKey !== this.currentConnectionString) {\n            await this.end_();\n            this.currentConnectionString = csKey;\n        }\n\n        if (!this.pool) {\n            this.log('debug', `Create connection pool to ${csKey}`);\n            this.pool = mysql.createPool(csKey);\n        }\n\n        const conn = await this.pool.getConnection();\n        this.acitveConnections.add(conn);\n\n        this.log('debug', `Connect to ${csKey}`);\n\n        return conn;\n    }\n\n    /**\n     * Close a database connection.\n     * @param {MySQLConnection} conn - MySQL connection.\n     */\n    async disconnect_(conn) {\n        this.log('debug', `Disconnect from ${this.currentConnectionString}`);\n        this.acitveConnections.delete(conn);\n        return conn.release();\n    }\n\n    /**\n     * Start a transaction.\n     * @param {object} options - Options\n     * @property {string} [options.isolationLevel]\n     */\n    async beginTransaction_(options) {\n        const conn = await this.connect_();\n\n        if (options && options.isolationLevel) {\n            // only allow valid option value to avoid injection attach\n            const isolationLevel = _.find(\n                MySQLConnector.IsolationLevels,\n                (value, key) =>\n                    options.isolationLevel === key ||\n                    options.isolationLevel === value\n            );\n            if (!isolationLevel) {\n                throw new ApplicationError(\n                    `Invalid isolation level: \"${isolationLevel}\"!\"`\n                );\n            }\n\n            await conn.query(\n                'SET SESSION TRANSACTION ISOLATION LEVEL ' + isolationLevel\n            );\n        }\n\n        const [ret] = await conn.query('SELECT @@autocommit;');\n        conn.$$autocommit = ret[0]['@@autocommit'];\n\n        await conn.query('SET SESSION autocommit=0;');\n        await conn.query('START TRANSACTION;');\n\n        this.log('verbose', 'Begins a new transaction.');\n        return conn;\n    }\n\n    /**\n     * Commit a transaction.\n     * @param {MySQLConnection} conn - MySQL connection.\n     */\n    async commit_(conn) {\n        await conn.query('COMMIT;');\n        this.log(\n            'verbose',\n            `Commits a transaction. Previous autocommit=${conn.$$autocommit}`\n        );\n        if (conn.$$autocommit) {\n            await conn.query('SET SESSION autocommit=1;');\n            delete conn.$$autocommit;\n        }\n\n        return this.disconnect_(conn);\n    }\n\n    /**\n     * Rollback a transaction.\n     * @param {MySQLConnection} conn - MySQL connection.\n     */\n    async rollback_(conn) {\n        await conn.query('ROLLBACK;');\n        this.log(\n            'verbose',\n            `Rollbacks a transaction. Previous autocommit=${conn.$$autocommit}`\n        );\n        if (conn.$$autocommit) {\n            await conn.query('SET SESSION autocommit=1;');\n            delete conn.$$autocommit;\n        }\n\n        return this.disconnect_(conn);\n    }\n\n    /**\n     * Execute the sql statement.\n     *\n     * @param {String} sql - The SQL statement to execute.\n     * @param {object} params - Parameters to be placed into the SQL statement.\n     * @param {object} [options] - Execution options.\n     * @property {boolean} [options.usePreparedStatement] - Whether to use prepared statement which is cached and re-used by connection.\n     * @property {boolean} [options.rowsAsArray] - To receive rows as array of columns instead of hash with column name as key.\n     * @property {MySQLConnection} [options.connection] - Existing connection.\n     */\n    async execute_(sql, params, options) {\n        let conn;\n\n        try {\n            conn = await this._getConnection_(options);\n\n            if (\n                this.options.usePreparedStatement ||\n                (options && options.usePreparedStatement)\n            ) {\n                if (this.options.logStatement) {\n                    this.log('verbose', conn.format(sql, params));\n                }\n\n                if (options && options.rowsAsArray) {\n                    return await conn.execute(\n                        { sql, rowsAsArray: true },\n                        params\n                    );\n                }\n\n                const [rows1] = await conn.execute(sql, params);\n\n                return rows1;\n            }\n\n            if (this.options.logStatement) {\n                this.log('verbose', conn.format(sql, params));\n            }\n\n            if (options && options.rowsAsArray) {\n                return await conn.query({ sql, rowsAsArray: true }, params);\n            }\n\n            const [rows2] = await conn.query(sql, params);\n\n            return rows2;\n        } catch (err) {\n            err.info || (err.info = {});\n            err.info.sql = _.truncate(sql, { length: 200 });\n            err.info.params = params;\n\n            throw err;\n        } finally {\n            conn && (await this._releaseConnection_(conn, options));\n        }\n    }\n\n    async ping_() {\n        const [ping] = await this.execute_('SELECT 1 AS result');\n        return ping && ping.result === 1;\n    }\n\n    /**\n     * Create a new entity.\n     * @param {string} model\n     * @param {object} data\n     * @param {*} options\n     */\n    async create_(model, data, options) {\n        if (!data || _.isEmpty(data)) {\n            throw new ApplicationError(`Creating with empty \"${model}\" data.`);\n        }\n\n        const { insertIgnore, ...restOptions } = options || {};\n\n        const sql = `INSERT ${insertIgnore ? 'IGNORE ' : ''}INTO ?? SET ?`;\n        const params = [model];\n        params.push(data);\n\n        return this.execute_(sql, params, restOptions);\n    }\n\n    /**\n     * Create a new entity or update the old one if duplicate key found.    \n     * @param {*} model \n     * @param {*} data \n     * @param {*} uniqueKeys \n     * @param {*} options \n     * @param {object} dataOnInsert - When no duplicate record exists, extra data for inserting\n     * @returns \n     */\n    async upsertOne_(model, data, uniqueKeys, options, dataOnInsert) {\n        if (!data || _.isEmpty(data)) {\n            throw new ApplicationError(`Creating with empty \"${model}\" data.`);\n        }\n\n        const dataWithoutUK = _.omit(data, uniqueKeys);\n        const insertData = { ...data, ...dataOnInsert };\n\n        if (_.isEmpty(dataWithoutUK)) {\n            // if dupliate, dont need to update\n            return this.create_(model, insertData, {\n                ...options,\n                insertIgnore: true,\n            });\n        }\n\n        const sql = `INSERT INTO ?? SET ? ON DUPLICATE KEY UPDATE ?`;\n        const params = [model];\n        params.push(insertData);\n        params.push(dataWithoutUK);\n\n        return this.execute_(sql, params, options);\n    }\n\n    /**\n     * Insert many records or update existings if duplicate key found.     \n     * @param {*} model \n     * @param {array} dataArrayOnInsert \n     * @param {*} uniqueKeys \n     * @param {*} options \n     * @param {object} dataExprOnUpdate - When duplicate record exists, the actual data used for updating\n     * @returns \n     */\n    async upsertMany_(model, fieldsOnInsert, dataArrayOnInsert, dataExprOnUpdate, options) {\n        if (!dataArrayOnInsert || _.isEmpty(dataArrayOnInsert)) {\n            throw new ApplicationError(`Upserting with empty \"${model}\" insert data.`);\n        }\n\n        if (!Array.isArray(dataArrayOnInsert)) {\n            throw new ApplicationError(\n                '\"data\" to bulk upsert should be an array of records.'\n            );\n        }\n\n        if (!dataExprOnUpdate || _.isEmpty(dataExprOnUpdate)) {\n            throw new ApplicationError(`Upserting with empty \"${model}\" update data.`);\n        }\n\n        if (!Array.isArray(fieldsOnInsert)) {\n            throw new ApplicationError(\n                '\"fields\" to bulk upsert should be an array of field names.'\n            );\n        }\n\n        const sql = `INSERT INTO ?? (${fieldsOnInsert\n            .map((f) => this.escapeId(f))\n            .join(', ')}) VALUES ? ON DUPLICATE KEY UPDATE ?`;\n        const params = [model];\n        params.push(dataArrayOnInsert);\n        params.push(dataExprOnUpdate);\n\n        return this.execute_(sql, params, options);\n    }\n\n    /**\n     * Insert many records in one SQL\n     * @param {*} model \n     * @param {*} fields \n     * @param {*} data \n     * @param {*} options \n     * @returns \n     */\n    async insertMany_(model, fields, data, options) {\n        if (!data || _.isEmpty(data)) {\n            throw new ApplicationError(`Creating with empty \"${model}\" data.`);\n        }\n\n        if (!Array.isArray(data)) {\n            throw new ApplicationError(\n                '\"data\" to bulk insert should be an array of records.'\n            );\n        }\n\n        if (!Array.isArray(fields)) {\n            throw new ApplicationError(\n                '\"fields\" to bulk insert should be an array of field names.'\n            );\n        }\n\n        const { insertIgnore, ...restOptions } = options || {};\n\n        const sql = `INSERT ${insertIgnore ? 'IGNORE ' : ''}INTO ?? (${fields\n            .map((f) => this.escapeId(f))\n            .join(', ')}) VALUES ?`;\n        const params = [model];\n        params.push(data);\n\n        return this.execute_(sql, params, restOptions);\n    }\n\n    insertOne_ = this.create_;\n\n    /**\n     * Update an existing entity.\n     * @param {string} model\n     * @param {object} data\n     * @param {*} query\n     * @param {*} queryOptions\n     * @param {*} connOptions\n     */\n    async update_(model, data, query, queryOptions, connOptions) {\n        if (_.isEmpty(data)) {\n            throw new InvalidArgument('Data record is empty.', {\n                model,\n                query,\n            });\n        }\n\n        const params = [];\n        const aliasMap = { [model]: 'A' };\n        let joinings;\n        let hasJoining = false;\n        const joiningParams = [];\n\n        if (queryOptions && queryOptions.$relationships) {\n            joinings = this._joinAssociations(\n                queryOptions.$relationships,\n                model,\n                'A',\n                aliasMap,\n                1,\n                joiningParams\n            );\n            hasJoining = model;\n        }\n\n        let sql = 'UPDATE ' + mysql.escapeId(model);\n\n        if (hasJoining) {\n            joiningParams.forEach((p) => params.push(p));\n            sql += ' A ' + joinings.join(' ');\n        }\n\n        if ((queryOptions && queryOptions.$requireSplitColumns) || hasJoining) {\n            sql +=\n                ' SET ' +\n                this._splitColumnsAsInput(\n                    data,\n                    params,\n                    hasJoining,\n                    aliasMap\n                ).join(',');\n        } else {\n            params.push(data);\n            sql += ' SET ?';\n        }\n\n        if (query) {\n            const whereClause = this._joinCondition(\n                query,\n                params,\n                null,\n                hasJoining,\n                aliasMap\n            );\n            if (whereClause) {\n                sql += ' WHERE ' + whereClause;\n            }\n        }\n\n        return this.execute_(sql, params, connOptions);\n    }\n\n    updateOne_ = this.update_;\n\n    /**\n     * Replace an existing entity or create a new one.\n     * @param {string} model\n     * @param {object} data\n     * @param {*} options\n     */\n    async replace_(model, data, options) {\n        const params = [model, data];\n\n        const sql = 'REPLACE ?? SET ?';\n\n        return this.execute_(sql, params, options);\n    }\n\n    /**\n     * Remove an existing entity.\n     * @param {string} model\n     * @param {*} query\n     * @param {*} deleteOptions\n     * @param {*} options\n     */\n    async delete_(model, query, deleteOptions, options) {\n        const params = [model];\n        const aliasMap = { [model]: 'A' };\n        let joinings;\n        let hasJoining = false;\n        const joiningParams = [];\n\n        if (deleteOptions && deleteOptions.$relationships) {\n            joinings = this._joinAssociations(\n                deleteOptions.$relationships,\n                model,\n                'A',\n                aliasMap,\n                1,\n                joiningParams\n            );\n            hasJoining = model;\n        }\n\n        let sql;\n\n        if (hasJoining) {\n            joiningParams.forEach((p) => params.push(p));\n            sql = 'DELETE A FROM ?? A ' + joinings.join(' ');\n        } else {\n            sql = 'DELETE FROM ??';\n        }\n\n        const whereClause = this._joinCondition(\n            query,\n            params,\n            null,\n            hasJoining,\n            aliasMap\n        );\n        if (whereClause) {\n            sql += ' WHERE ' + whereClause;\n        }\n\n        return this.execute_(sql, params, options);\n    }\n\n    /**\n     * Perform select operation.\n     * @param {*} model\n     * @param {*} condition\n     * @param {*} connOptions\n     */\n    async find_(model, condition, connOptions) {\n        const sqlInfo = this.buildQuery(model, condition);\n\n        let result, totalCount;\n\n        if (sqlInfo.countSql) {\n            const [countResult] = await this.execute_(\n                sqlInfo.countSql,\n                sqlInfo.params,\n                connOptions\n            );\n            totalCount = countResult.count;\n        }\n\n        if (sqlInfo.hasJoining) {\n            connOptions = { ...connOptions, rowsAsArray: true };\n            result = await this.execute_(\n                sqlInfo.sql,\n                sqlInfo.params,\n                connOptions\n            );\n\n            const reverseAliasMap = _.reduce(\n                sqlInfo.aliasMap,\n                (result, alias, nodePath) => {\n                    result[alias] = nodePath\n                        .split('.')\n                        .slice(\n                            1\n                        ) /* .map(n => ':' + n) changed to be padding by orm and can be customized with other key getter */;\n                    return result;\n                },\n                {}\n            );\n\n            if (sqlInfo.countSql) {\n                return result.concat(reverseAliasMap, totalCount);\n            }\n\n            return result.concat(reverseAliasMap);\n        } else if (condition.$skipOrm) {\n            connOptions = { ...connOptions, rowsAsArray: true };\n        }\n\n        result = await this.execute_(sqlInfo.sql, sqlInfo.params, connOptions);\n\n        if (sqlInfo.countSql) {\n            return [result, totalCount];\n        }\n\n        return result;\n    }\n\n    /**\n     * Build sql statement.\n     * @param {*} model\n     * @param {*} condition\n     */\n    buildQuery(\n        model,\n        {\n            $relationships,\n            $projection,\n            $query,\n            $groupBy,\n            $orderBy,\n            $offset,\n            $limit,\n            $totalCount,\n        }\n    ) {\n        const params = [];\n        const aliasMap = { [model]: 'A' };\n        let joinings;\n        let hasJoining = false;\n        const joiningParams = [];\n\n        // build alias map first\n        // cache params\n        if ($relationships) {\n            joinings = this._joinAssociations(\n                $relationships,\n                model,\n                'A',\n                aliasMap,\n                1,\n                joiningParams\n            );\n            hasJoining = model;\n        }\n\n        const selectColomns = $projection\n            ? this._buildColumns($projection, params, hasJoining, aliasMap)\n            : '*';\n\n        let sql = ' FROM ' + mysql.escapeId(model);\n\n        // move cached joining params into params\n        // should according to the place of clause in a sql\n\n        if (hasJoining) {\n            joiningParams.forEach((p) => params.push(p));\n            sql += ' A ' + joinings.join(' ');\n        }\n\n        if ($query) {\n            const whereClause = this._joinCondition(\n                $query,\n                params,\n                null,\n                hasJoining,\n                aliasMap\n            );\n            if (whereClause) {\n                sql += ' WHERE ' + whereClause;\n            }\n        }\n\n        if ($groupBy) {\n            sql +=\n                ' ' +\n                this._buildGroupBy($groupBy, params, hasJoining, aliasMap);\n        }\n\n        if ($orderBy) {\n            sql += ' ' + this._buildOrderBy($orderBy, hasJoining, aliasMap);\n        }\n\n        const result = { params, hasJoining, aliasMap };\n\n        if ($totalCount) {\n            let countSubject;\n\n            if (typeof $totalCount === 'string') {\n                countSubject =\n                    'DISTINCT(' +\n                    this._escapeIdWithAlias($totalCount, hasJoining, aliasMap) +\n                    ')';\n            } else {\n                countSubject = '*';\n            }\n\n            result.countSql = `SELECT COUNT(${countSubject}) AS count` + sql;\n        }\n\n        sql = 'SELECT ' + selectColomns + sql;\n\n        if (_.isInteger($limit) && $limit > 0) {\n            if (_.isInteger($offset) && $offset > 0) {\n                sql += ' LIMIT ?, ?';\n                params.push($offset);\n                params.push($limit);\n            } else {\n                sql += ' LIMIT ?';\n                params.push($limit);\n            }\n        } else if (_.isInteger($offset) && $offset > 0) {\n            sql += ' LIMIT ?, 1000';\n            params.push($offset);\n        }\n\n        result.sql = sql;\n\n        return result;\n    }\n\n    getInsertedId(result) {\n        return result && typeof result.insertId === 'number'\n            ? result.insertId\n            : undefined;\n    }\n\n    getNumOfAffectedRows(result) {\n        return result && typeof result.affectedRows === 'number'\n            ? result.affectedRows\n            : undefined;\n    }\n\n    _generateAlias(index, anchor) {\n        const alias = ntol(index);\n\n        if (this.options.verboseAlias) {\n            return _.snakeCase(anchor).toUpperCase() + '_' + alias;\n        }\n\n        return alias;\n    }\n\n    /**\n     * Extract associations into joining clauses.\n     *  {\n     *      entity: <remote entity>\n     *      joinType: 'LEFT JOIN|INNER JOIN|FULL OUTER JOIN'\n     *      anchor: 'local property to place the remote entity'\n     *      localField: <local field to join>\n     *      remoteField: <remote field to join>\n     *      subAssociations: { ... }\n     *  }\n     *\n     * @param {*} associations\n     * @param {*} parentAliasKey\n     * @param {*} parentAlias\n     * @param {*} aliasMap\n     * @param {*} params\n     */\n    _joinAssociations(\n        associations,\n        parentAliasKey,\n        parentAlias,\n        aliasMap,\n        startId,\n        params\n    ) {\n        let joinings = [];\n\n        _.each(associations, (assocInfo, anchor) => {\n            const alias =\n                assocInfo.alias || this._generateAlias(startId++, anchor);\n            let { joinType, on } = assocInfo;\n\n            joinType || (joinType = 'LEFT JOIN');\n\n            if (assocInfo.sql) {\n                if (assocInfo.output) {\n                    aliasMap[parentAliasKey + '.' + alias] = alias;\n                }\n\n                assocInfo.params.forEach((p) => params.push(p));\n                joinings.push(\n                    `${joinType} (${\n                        assocInfo.sql\n                    }) ${alias} ON ${this._joinCondition(\n                        on,\n                        params,\n                        null,\n                        parentAliasKey,\n                        aliasMap\n                    )}`\n                );\n\n                return;\n            }\n\n            const { entity, subAssocs } = assocInfo;\n            const aliasKey = parentAliasKey + '.' + anchor;\n            aliasMap[aliasKey] = alias;\n\n            if (subAssocs) {\n                const subJoinings = this._joinAssociations(\n                    subAssocs,\n                    aliasKey,\n                    alias,\n                    aliasMap,\n                    startId,\n                    params\n                );\n                startId += subJoinings.length;\n\n                joinings.push(\n                    `${joinType} ${mysql.escapeId(\n                        entity\n                    )} ${alias} ON ${this._joinCondition(\n                        on,\n                        params,\n                        null,\n                        parentAliasKey,\n                        aliasMap\n                    )}`\n                );\n                joinings = joinings.concat(subJoinings);\n            } else {\n                joinings.push(\n                    `${joinType} ${mysql.escapeId(\n                        entity\n                    )} ${alias} ON ${this._joinCondition(\n                        on,\n                        params,\n                        null,\n                        parentAliasKey,\n                        aliasMap\n                    )}`\n                );\n            }\n        });\n\n        return joinings;\n    }\n\n    /**\n     * SQL condition representation\n     *   Rules:\n     *     default:\n     *        array: OR\n     *        kv-pair: AND\n     *     $all:\n     *        array: AND\n     *     $any:\n     *        kv-pair: OR\n     *     $not:\n     *        array: not ( or )\n     *        kv-pair: not ( and )\n     * @param {object} condition\n     * @param {array} params\n     */\n    _joinCondition(condition, params, joinOperator, hasJoining, aliasMap) {\n        if (Array.isArray(condition)) {\n            if (!joinOperator) {\n                joinOperator = 'OR';\n            }\n            return condition\n                .map(\n                    (c) =>\n                        '(' +\n                        this._joinCondition(\n                            c,\n                            params,\n                            null,\n                            hasJoining,\n                            aliasMap\n                        ) +\n                        ')'\n                )\n                .join(` ${joinOperator} `);\n        }\n\n        if (_.isPlainObject(condition)) {\n            if (!joinOperator) {\n                joinOperator = 'AND';\n            }\n\n            return _.map(condition, (value, key) => {\n                if (\n                    key === '$all' ||\n                    key === '$and' ||\n                    key.startsWith('$and_')\n                ) {\n                    // for avoiding dupliate, $or_1, $or_2 is valid\n                    if (!Array.isArray(value) && !_.isPlainObject(value)) {\n                        throw new Error('\"$and\" operator value should be an array or plain object.');\n                    }\n\n                    return (\n                        '(' +\n                        this._joinCondition(\n                            value,\n                            params,\n                            'AND',\n                            hasJoining,\n                            aliasMap\n                        ) +\n                        ')'\n                    );\n                }\n\n                if (key === '$any' || key === '$or' || key.startsWith('$or_')) {\n                    // for avoiding dupliate, $or_1, $or_2 is valid\n                    if (!Array.isArray(value) && !_.isPlainObject(value)) {\n                        throw new Error(\n                            '\"$or\" operator value should be an array or plain object.'\n                        );\n                    }\n\n                    return (\n                        '(' +\n                        this._joinCondition(\n                            value,\n                            params,\n                            'OR',\n                            hasJoining,\n                            aliasMap\n                        ) +\n                        ')'\n                    );\n                }\n\n                if (key === '$not') {\n                    if (Array.isArray(value)) {\n                        if (value.length === 0) {\n                            throw new Error(\n                                '\"$not\" operator value should be non-empty.'\n                            );\n                        }\n\n                        return (\n                            'NOT (' +\n                            this._joinCondition(\n                                value,\n                                params,\n                                null,\n                                hasJoining,\n                                aliasMap\n                            ) +\n                            ')'\n                        );\n                    }\n\n                    if (_.isPlainObject(value)) {\n                        if (_.isEmpty(value)) {\n                            throw new Error(\n                                '\"$not\" operator value should be non-empty.'\n                            );\n                        }\n\n                        return (\n                            'NOT (' +\n                            this._joinCondition(\n                                value,\n                                params,\n                                null,\n                                hasJoining,\n                                aliasMap\n                            ) +\n                            ')'\n                        );\n                    }\n\n                    if (typeof value !== 'string') {\n                        throw new Error('Unsupported condition!');\n                    }\n\n                    return 'NOT (' + condition + ')';\n                }\n\n                if (\n                    (key === '$expr' || key.startsWith('$expr_')) &&\n                    value.oorType &&\n                    value.oorType === 'BinaryExpression'\n                ) {\n                    const left = this._packValue(\n                        value.left,\n                        params,\n                        hasJoining,\n                        aliasMap\n                    );\n                    const right = this._packValue(\n                        value.right,\n                        params,\n                        hasJoining,\n                        aliasMap\n                    );\n                    return left + ` ${value.op} ` + right;\n                }\n\n                return this._wrapCondition(\n                    key,\n                    value,\n                    params,\n                    hasJoining,\n                    aliasMap\n                );\n            }).join(` ${joinOperator} `);\n        }\n\n        if (typeof condition !== 'string') {\n            throw new Error(\n                'Unsupported condition!\\n Value: ' + JSON.stringify(condition)\n            );\n        }\n\n        return condition;\n    }\n\n    _replaceFieldNameWithAlias(fieldName, mainEntity, aliasMap) {\n        const parts = fieldName.split('.');\n        if (parts.length > 1) {\n            const actualFieldName = parts.pop();\n            const aliasKey = mainEntity + '.' + parts.join('.');\n            const alias = aliasMap[aliasKey];\n            if (!alias) {\n                throw new InvalidArgument(\n                    `Column reference \"${fieldName}\" not found in populated associations.`,\n                    {\n                        entity: mainEntity,\n                        alias: aliasKey,\n                        aliasMap,\n                    }\n                );\n            }\n\n            return (\n                alias +\n                '.' +\n                (actualFieldName === '*'\n                    ? '*'\n                    : mysql.escapeId(actualFieldName))\n            );\n        }\n\n        return (\n            aliasMap[mainEntity] +\n            '.' +\n            (fieldName === '*' ? '*' : mysql.escapeId(fieldName))\n        );\n    }\n\n    _escapeIdWithAlias(fieldName, mainEntity, aliasMap) {\n        if (mainEntity) {\n            return this._replaceFieldNameWithAlias(\n                fieldName,\n                mainEntity,\n                aliasMap\n            );\n        }\n\n        return fieldName === '*' ? fieldName : mysql.escapeId(fieldName);\n    }\n\n    _splitColumnsAsInput(data, params, hasJoining, aliasMap) {\n        return _.map(data, (v, fieldName) => {\n            return (\n                this._escapeIdWithAlias(fieldName, hasJoining, aliasMap) +\n                '=' +\n                this._packValue(v, params, hasJoining, aliasMap)\n            );\n        });\n    }\n\n    _packArray(array, params, hasJoining, aliasMap) {\n        return array\n            .map((value) =>\n                this._packValue(value, params, hasJoining, aliasMap)\n            )\n            .join(',');\n    }\n\n    _packValue(value, params, hasJoining, aliasMap) {\n        if (_.isPlainObject(value)) {\n            if (value.oorType) {\n                switch (value.oorType) {\n                    case 'ColumnReference':\n                        return this._escapeIdWithAlias(\n                            value.name,\n                            hasJoining,\n                            aliasMap\n                        );\n\n                    case 'Function':\n                        return (\n                            value.name +\n                            '(' +\n                            (value.args\n                                ? this._packArray(\n                                      value.args,\n                                      params,\n                                      hasJoining,\n                                      aliasMap\n                                  )\n                                : '') +\n                            ')'\n                        );\n\n                    case 'BinaryExpression': {\n                        const left = this._packValue(\n                            value.left,\n                            params,\n                            hasJoining,\n                            aliasMap\n                        );\n                        const right = this._packValue(\n                            value.right,\n                            params,\n                            hasJoining,\n                            aliasMap\n                        );\n                        return left + ` ${value.op} ` + right;\n                    }\n\n                    default:\n                        throw new Error(`Unknown oor type: ${value.oorType}`);\n                }\n            }\n\n            value = JSON.stringify(value);\n        }\n\n        params.push(value);\n        return '?';\n    }\n\n    /**\n     * Wrap a condition clause\n     *\n     * Value can be a literal or a plain condition object.\n     *   1. fieldName, <literal>\n     *   2. fieldName, { normal object }\n     *\n     * @param {string} fieldName\n     * @param {*} value\n     * @param {array} params\n     */\n    _wrapCondition(fieldName, value, params, hasJoining, aliasMap, inject) {\n        if (_.isNil(value)) {\n            return (\n                this._escapeIdWithAlias(fieldName, hasJoining, aliasMap) +\n                ' IS NULL'\n            );\n        }\n\n        if (Array.isArray(value)) {\n            return this._wrapCondition(\n                fieldName,\n                { $in: value },\n                params,\n                hasJoining,\n                aliasMap,\n                inject\n            );\n        }\n\n        if (_.isPlainObject(value)) {\n            if (value.oorType) {\n                return (\n                    this._escapeIdWithAlias(fieldName, hasJoining, aliasMap) +\n                    ' = ' +\n                    this._packValue(value, params, hasJoining, aliasMap)\n                );\n            }\n\n            const hasOperator = _.find(\n                Object.keys(value),\n                (k) => k && k[0] === '$'\n            );\n\n            if (hasOperator) {\n                return _.map(value, (v, k) => {\n                    if (k && k[0] === '$') {\n                        // operator\n                        switch (k) {\n                            case '$exist':\n                            case '$exists':\n                                return (\n                                    this._escapeIdWithAlias(\n                                        fieldName,\n                                        hasJoining,\n                                        aliasMap\n                                    ) + (v ? ' IS NOT NULL' : 'IS NULL')\n                                );\n\n                            case '$eq':\n                            case '$equal':\n                                return this._wrapCondition(\n                                    fieldName,\n                                    v,\n                                    params,\n                                    hasJoining,\n                                    aliasMap,\n                                    inject\n                                );\n\n                            case '$ne':\n                            case '$neq':\n                            case '$notEqual':\n                                if (_.isNil(v)) {\n                                    return (\n                                        this._escapeIdWithAlias(\n                                            fieldName,\n                                            hasJoining,\n                                            aliasMap\n                                        ) + ' IS NOT NULL'\n                                    );\n                                }\n\n                                v = this.typeCast(v);\n\n                                if (inject) {\n                                    return (\n                                        this._escapeIdWithAlias(\n                                            fieldName,\n                                            hasJoining,\n                                            aliasMap\n                                        ) +\n                                        ' <> ' +\n                                        v\n                                    );\n                                }\n\n                                return (\n                                    this._escapeIdWithAlias(\n                                        fieldName,\n                                        hasJoining,\n                                        aliasMap\n                                    ) +\n                                    ` <> ${this._packValue(\n                                        v,\n                                        params,\n                                        hasJoining,\n                                        aliasMap\n                                    )}`\n                                );\n\n                            case '$>':\n                            case '$gt':\n                            case '$greaterThan':\n                                v = this.typeCast(v);\n\n                                if (inject) {\n                                    return (\n                                        this._escapeIdWithAlias(\n                                            fieldName,\n                                            hasJoining,\n                                            aliasMap\n                                        ) +\n                                        ' > ' +\n                                        v\n                                    );\n                                }\n\n                                return (\n                                    this._escapeIdWithAlias(\n                                        fieldName,\n                                        hasJoining,\n                                        aliasMap\n                                    ) +\n                                    ` > ${this._packValue(\n                                        v,\n                                        params,\n                                        hasJoining,\n                                        aliasMap\n                                    )}`\n                                );\n\n                            case '$>=':\n                            case '$gte':\n                            case '$greaterThanOrEqual':\n                                v = this.typeCast(v);\n\n                                if (inject) {\n                                    return (\n                                        this._escapeIdWithAlias(\n                                            fieldName,\n                                            hasJoining,\n                                            aliasMap\n                                        ) +\n                                        ' >= ' +\n                                        v\n                                    );\n                                }\n\n                                return (\n                                    this._escapeIdWithAlias(\n                                        fieldName,\n                                        hasJoining,\n                                        aliasMap\n                                    ) +\n                                    ` >= ${this._packValue(\n                                        v,\n                                        params,\n                                        hasJoining,\n                                        aliasMap\n                                    )}`\n                                );\n\n                            case '$<':\n                            case '$lt':\n                            case '$lessThan':\n                                v = this.typeCast(v);\n\n                                if (inject) {\n                                    return (\n                                        this._escapeIdWithAlias(\n                                            fieldName,\n                                            hasJoining,\n                                            aliasMap\n                                        ) +\n                                        ' < ' +\n                                        v\n                                    );\n                                }\n\n                                return (\n                                    this._escapeIdWithAlias(\n                                        fieldName,\n                                        hasJoining,\n                                        aliasMap\n                                    ) +\n                                    ` < ${this._packValue(\n                                        v,\n                                        params,\n                                        hasJoining,\n                                        aliasMap\n                                    )}`\n                                );\n\n                            case '$<=':\n                            case '$lte':\n                            case '$lessThanOrEqual':\n                                v = this.typeCast(v);\n\n                                if (inject) {\n                                    return (\n                                        this._escapeIdWithAlias(\n                                            fieldName,\n                                            hasJoining,\n                                            aliasMap\n                                        ) +\n                                        ' <= ' +\n                                        v\n                                    );\n                                }\n\n                                return (\n                                    this._escapeIdWithAlias(\n                                        fieldName,\n                                        hasJoining,\n                                        aliasMap\n                                    ) +\n                                    ` <= ${this._packValue(\n                                        v,\n                                        params,\n                                        hasJoining,\n                                        aliasMap\n                                    )}`\n                                );\n\n                            case '$in':\n                                if (\n                                    _.isPlainObject(v) &&\n                                    v.oorType === 'DataSet'\n                                ) {\n                                    const sqlInfo = this.buildQuery(\n                                        v.model,\n                                        v.query\n                                    );\n                                    sqlInfo.params &&\n                                        sqlInfo.params.forEach((p) =>\n                                            params.push(p)\n                                        );\n\n                                    return (\n                                        this._escapeIdWithAlias(\n                                            fieldName,\n                                            hasJoining,\n                                            aliasMap\n                                        ) + ` IN (${sqlInfo.sql})`\n                                    );\n                                } else {\n                                    if (!Array.isArray(v)) {\n                                        throw new Error(\n                                            'The value should be an array when using \"$in\" operator.'\n                                        );\n                                    }\n\n                                    if (inject) {\n                                        return (\n                                            this._escapeIdWithAlias(\n                                                fieldName,\n                                                hasJoining,\n                                                aliasMap\n                                            ) + ` IN (${v})`\n                                        );\n                                    }\n\n                                    params.push(v);\n                                    return (\n                                        this._escapeIdWithAlias(\n                                            fieldName,\n                                            hasJoining,\n                                            aliasMap\n                                        ) + ' IN (?)'\n                                    );\n                                }\n\n                            case '$nin':\n                            case '$notIn':\n                                if (\n                                    _.isPlainObject(v) &&\n                                    v.oorType === 'DataSet'\n                                ) {\n                                    const sqlInfo = this.buildQuery(\n                                        v.model,\n                                        v.query\n                                    );\n                                    sqlInfo.params &&\n                                        sqlInfo.params.forEach((p) =>\n                                            params.push(p)\n                                        );\n\n                                    return (\n                                        this._escapeIdWithAlias(\n                                            fieldName,\n                                            hasJoining,\n                                            aliasMap\n                                        ) + ` NOT IN (${sqlInfo.sql})`\n                                    );\n                                } else {\n                                    if (!Array.isArray(v)) {\n                                        throw new Error(\n                                            'The value should be an array when using \"$in\" operator.'\n                                        );\n                                    }\n\n                                    if (inject) {\n                                        return (\n                                            this._escapeIdWithAlias(\n                                                fieldName,\n                                                hasJoining,\n                                                aliasMap\n                                            ) + ` NOT IN (${v})`\n                                        );\n                                    }\n\n                                    params.push(v);\n                                    return (\n                                        this._escapeIdWithAlias(\n                                            fieldName,\n                                            hasJoining,\n                                            aliasMap\n                                        ) + ' NOT IN (?)'\n                                    );\n                                }\n\n                            case '$startWith':\n                            case '$startsWith':\n                                if (typeof v !== 'string') {\n                                    throw new Error(\n                                        'The value should be a string when using \"$startWith\" operator.'\n                                    );\n                                }\n\n                                params.push(`${v}%`);\n                                return (\n                                    this._escapeIdWithAlias(\n                                        fieldName,\n                                        hasJoining,\n                                        aliasMap\n                                    ) + ' LIKE ?'\n                                );\n\n                            case '$endWith':\n                            case '$endsWith':\n                                if (typeof v !== 'string') {\n                                    throw new Error(\n                                        'The value should be a string when using \"$endWith\" operator.'\n                                    );\n                                }\n\n                                params.push(`%${v}`);\n                                return (\n                                    this._escapeIdWithAlias(\n                                        fieldName,\n                                        hasJoining,\n                                        aliasMap\n                                    ) + ' LIKE ?'\n                                );\n\n                            case '$like':\n                            case '$likes':\n                                if (typeof v !== 'string') {\n                                    throw new Error(\n                                        'The value should be a string when using \"$like\" operator.'\n                                    );\n                                }\n\n                                params.push(`%${v}%`);\n                                return (\n                                    this._escapeIdWithAlias(\n                                        fieldName,\n                                        hasJoining,\n                                        aliasMap\n                                    ) + ' LIKE ?'\n                                );\n\n                            case '$has':\n                                if (\n                                    typeof v !== 'string' ||\n                                    v.indexOf(',') >= 0\n                                ) {\n                                    throw new Error(\n                                        'The value should be a string without \",\" when using \"$has\" operator.'\n                                    );\n                                }\n\n                                params.push(v);\n                                return `FIND_IN_SET(?, ${this._escapeIdWithAlias(\n                                    fieldName,\n                                    hasJoining,\n                                    aliasMap\n                                )}) > 0`;\n\n                            default:\n                                throw new Error(\n                                    `Unsupported condition operator: \"${k}\"!`\n                                );\n                        }\n                    } else {\n                        throw new Error(\n                            'Operator should not be mixed with condition value.'\n                        );\n                    }\n                }).join(' AND ');\n            }\n\n            params.push(JSON.stringify(value));\n            return (\n                this._escapeIdWithAlias(fieldName, hasJoining, aliasMap) +\n                ' = ?'\n            );\n        }\n\n        value = this.typeCast(value);\n\n        if (inject) {\n            return (\n                this._escapeIdWithAlias(fieldName, hasJoining, aliasMap) +\n                ' = ' +\n                value\n            );\n        }\n\n        params.push(value);\n        return (\n            this._escapeIdWithAlias(fieldName, hasJoining, aliasMap) + ' = ?'\n        );\n    }\n\n    _buildColumns(columns, params, hasJoining, aliasMap) {\n        return _.map(_.castArray(columns), (col) =>\n            this._buildColumn(col, params, hasJoining, aliasMap)\n        ).join(', ');\n    }\n\n    _buildColumn(col, params, hasJoining, aliasMap) {\n        if (typeof col === 'string') {\n            // it's a string if it's quoted when passed in\n            return isQuoted(col)\n                ? col\n                : this._escapeIdWithAlias(col, hasJoining, aliasMap);\n        }\n\n        if (typeof col === 'number') {\n            return col;\n        }\n\n        if (_.isPlainObject(col)) {\n            if (col.alias) {\n                const lastDotIndex = col.alias.lastIndexOf('.');\n                let alias =\n                    lastDotIndex > 0\n                        ? col.alias.substr(lastDotIndex + 1)\n                        : col.alias;\n\n                if (lastDotIndex > 0) {\n                    if (!hasJoining) {\n                        throw new InvalidArgument(\n                            'Cascade alias is not allowed when the query has no associated entity populated.',\n                            {\n                                alias: col.alias,\n                            }\n                        );\n                    }\n\n                    const fullPath =\n                        hasJoining + '.' + col.alias.substr(0, lastDotIndex);\n                    const aliasPrefix = aliasMap[fullPath];\n                    if (!aliasPrefix) {\n                        throw new InvalidArgument(\n                            `Invalid cascade alias. \"${fullPath}\" not found in associations.`,\n                            {\n                                alias: col.alias,\n                            }\n                        );\n                    }\n\n                    alias = aliasPrefix + '$' + alias;\n                }\n\n                return (\n                    this._buildColumn(\n                        _.omit(col, ['alias']),\n                        params,\n                        hasJoining,\n                        aliasMap\n                    ) +\n                    ' AS ' +\n                    mysql.escapeId(alias)\n                );\n            }\n\n            if (col.type === 'function') {\n                const name = col.name.toUpperCase();\n                if (\n                    name === 'COUNT' &&\n                    col.args.length === 1 &&\n                    col.args[0] === '*'\n                ) {\n                    return 'COUNT(*)';\n                }\n\n                return (\n                    name +\n                    '(' +\n                    (col.prefix ? `${col.prefix.toUpperCase()} ` : '') +\n                    (col.args\n                        ? this._buildColumns(\n                              col.args,\n                              params,\n                              hasJoining,\n                              aliasMap\n                          )\n                        : '') +\n                    ')'\n                );\n            }\n\n            if (col.type === 'expression') {\n                return this._joinCondition(\n                    col.expr,\n                    params,\n                    null,\n                    hasJoining,\n                    aliasMap\n                );\n            }\n\n            if (col.type === 'column') {\n                return this._escapeIdWithAlias(col.name, hasJoining, aliasMap);\n            }\n        }\n\n        throw new ApplicationError(\n            `Unknow column syntax: ${JSON.stringify(col)}`\n        );\n    }\n\n    _buildGroupBy(groupBy, params, hasJoining, aliasMap) {\n        if (typeof groupBy === 'string')\n            return (\n                'GROUP BY ' +\n                this._escapeIdWithAlias(groupBy, hasJoining, aliasMap)\n            );\n\n        if (Array.isArray(groupBy))\n            return (\n                'GROUP BY ' +\n                groupBy\n                    .map((by) =>\n                        this._escapeIdWithAlias(by, hasJoining, aliasMap)\n                    )\n                    .join(', ')\n            );\n\n        if (_.isPlainObject(groupBy)) {\n            const { columns, having } = groupBy;\n\n            if (!columns || !Array.isArray(columns)) {\n                throw new ApplicationError(\n                    `Invalid group by syntax: ${JSON.stringify(groupBy)}`\n                );\n            }\n\n            let groupByClause = this._buildGroupBy(columns);\n            const havingCluse =\n                having &&\n                this._joinCondition(having, params, null, hasJoining, aliasMap);\n            if (havingCluse) {\n                groupByClause += ' HAVING ' + havingCluse;\n            }\n\n            return groupByClause;\n        }\n\n        throw new ApplicationError(\n            `Unknown group by syntax: ${JSON.stringify(groupBy)}`\n        );\n    }\n\n    _buildOrderBy(orderBy, hasJoining, aliasMap) {\n        if (typeof orderBy === 'string')\n            return (\n                'ORDER BY ' +\n                this._escapeIdWithAlias(orderBy, hasJoining, aliasMap)\n            );\n\n        if (Array.isArray(orderBy))\n            return (\n                'ORDER BY ' +\n                orderBy\n                    .map((by) =>\n                        this._escapeIdWithAlias(by, hasJoining, aliasMap)\n                    )\n                    .join(', ')\n            );\n\n        if (_.isPlainObject(orderBy)) {\n            return (\n                'ORDER BY ' +\n                _.map(\n                    orderBy,\n                    (asc, col) =>\n                        this._escapeIdWithAlias(col, hasJoining, aliasMap) +\n                        (asc === false || asc === '-1' ? ' DESC' : '')\n                ).join(', ')\n            );\n        }\n\n        throw new ApplicationError(\n            `Unknown order by syntax: ${JSON.stringify(orderBy)}`\n        );\n    }\n\n    async _getConnection_(options) {\n        return options && options.connection\n            ? options.connection\n            : this.connect_(options);\n    }\n\n    async _releaseConnection_(conn, options) {\n        if (!options || !options.connection) {\n            return this.disconnect_(conn);\n        }\n    }\n}\n\nMySQLConnector.driverLib = mysql;\n\nmodule.exports = MySQLConnector;\n"],"file":"Connector.js"}