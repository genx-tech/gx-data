{"version":3,"file":"Connector.js","names":["_","require","tryRequire","AmqpNode","Connector","MessageContentType","RabbitmqConnector","constructor","connectionString","options","end_","acitveConnections","conn","close","connect_","connect","log","getConnectionStringWithoutCredential","on","err","logger","reason","opts","direction","chKey","exchange","queue","ch","createChannel","disconnect_","omit","ping_","sendToWorkers_","obj","assertQueue","durable","ret","sendToQueue","Buffer","from","JSON","stringify","persistent","content_type","logMsg","logMessage","msg","workerConsume_","consumerMethod","prefetch","consume","content","toString","noAck","publish_","routeKey","assertExchange","publish","subscribe_","subscriberMethod","q","exclusive","bindQueue","driverLib","module","exports"],"sources":["../../../src/drivers/rabbitmq/Connector.js"],"sourcesContent":["const { _ } = require('@genx/july');\nconst { tryRequire } = require('@genx/sys');\nconst AmqpNode = tryRequire('amqplib');\nconst Connector = require('../../Connector');\n\n/**\n * A callback function to be called to handle a dequeued message.\n * @callback workerFunction\n * @param {Channel} ch - MQ Channel object\n * @param {Message} msg - Message object\n */\n\nconst MessageContentType = 'application/json';\n\n/**\n * Rabbitmq data storage connector.\n * @class\n * @extends Connector\n */\nclass RabbitmqConnector extends Connector {\n    /**\n     * @param {string} name\n     * @param {object} options\n     * @property {boolean} [options.logMessage] - Flag to log queued message\n     */\n    constructor(connectionString, options) {\n        super('rabbitmq', connectionString, options);\n    }\n\n    /**\n     * Close all connection initiated by this connector.\n     */\n    async end_() {\n        delete this.acitveConnections;\n\n        if (this.conn) {\n            await this.conn.close();\n        }\n\n        delete this.conn;\n    }\n\n    /**\n     * Create a database connection based on the default connection string of the connector and given options.\n     * @param {Object} [options] - Extra options for the connection, optional.\n     * @property {string} [options.queue] - Connection for queue, default ''\n     * @property {string} [options.exchange] - Connection for queue, default ''\n     * @property {string} [options.direction] - Connection for queue, default ''\n     * @returns {Promise.<Db>}\n     */\n    async connect_(options) {\n        if (!this.conn) {\n            this.conn = await AmqpNode.connect(this.connectionString);\n            this.log(\n                'verbose',\n                `rabbitmq: successfully connected to \"${this.getConnectionStringWithoutCredential()}\".`\n            );\n\n            this.conn.on('error', async (err) => {\n                this.log('error', `rabbitmq: connection error: ${err}}`);\n            });\n\n            if (this.options.logger) {\n                this.conn.on('blocked', (reason) => {\n                    this.log(\n                        'warn',\n                        `rabbitmq: connection is blocked. ${reason}`\n                    );\n                });\n\n                this.conn.on('unblocked', () => {\n                    this.log('info', 'rabbitmq: connection is unblocked.');\n                });\n            }\n        }\n\n        const opts = {\n            direction: 'out',\n            ...options,\n        };\n\n        const chKey = opts.exchange\n            ? `[X]${opts.exchange}|${opts.direction}`\n            : `[Q]${opts.queue}|${opts.direction}`;\n\n        this.acitveConnections || (this.acitveConnections = {});\n        let ch = this.acitveConnections[chKey];\n\n        if (!ch) {\n            ch = await this.conn.createChannel();\n\n            ch.on('error', async (err) => {\n                this.log('error', `rabbitmq: channel error. ${err}`);\n            });\n\n            this.acitveConnections[chKey] = ch;\n\n            this.log(\n                'verbose',\n                `rabbitmq: new channel created for queue \"${chKey}\".`\n            );\n        }\n\n        return ch;\n    }\n\n    /**\n     * Close a database connection.\n     * @param {Db} conn - MySQL connection.\n     */\n    async disconnect_(ch) {\n        this.log('verbose', 'rabbitmq: channel closed.');\n\n        if (this.acitveConnections) {\n            this.acitveConnections = _.omit(\n                this.acitveConnections,\n                (conn) => conn === ch\n            );\n        }\n    }\n\n    async ping_() {\n        return true;\n    }\n\n    /**\n     * Send a message to worker queue.\n     * @see https://www.rabbitmq.com/tutorials/tutorial-two-javascript.html\n     * @param {*} queue\n     * @param {*} obj\n     */\n    async sendToWorkers_(queue, obj) {\n        const ch = await this.connect_({ queue, direction: 'out' });\n\n        await ch.assertQueue(queue, {\n            durable: true,\n        });\n\n        const ret = await ch.sendToQueue(\n            queue,\n            Buffer.from(JSON.stringify(obj)),\n            {\n                persistent: true,\n                content_type: MessageContentType,\n            }\n        );\n\n        const logMsg = `rabbitmq: new message enqueued to [${queue}].`;\n\n        if (this.options.logMessage) {\n            this.log('verbose', logMsg, { msg: obj });\n        } else {\n            this.log('verbose', logMsg);\n        }\n\n        return ret;\n    }\n\n    /**\n     * Waiting for message from a queue by a worker.\n     * @see https://www.rabbitmq.com/tutorials/tutorial-two-javascript.html\n     * @param {*} queue\n     * @param {workerFunction} consumerMethod\n     */\n    async workerConsume_(queue, consumerMethod) {\n        const ch = await this.connect_({ queue, direction: 'in' });\n\n        await ch.assertQueue(queue, {\n            durable: true,\n        });\n\n        await ch.prefetch(1);\n\n        const logMsg = `rabbitmq: new message dequeued from [${queue}].`;\n\n        return ch.consume(\n            queue,\n            (msg) => {\n                if (this.options.logMessage) {\n                    this.log('verbose', logMsg, {\n                        msg: msg.content.toString(),\n                    });\n                } else {\n                    this.log('verbose', logMsg);\n                }\n\n                return consumerMethod(ch, msg);\n            },\n            {\n                // manual acknowledgment mode\n                // need send a proper acknowledgment from the worker, once done with a task.\n                noAck: false,\n            }\n        );\n    }\n\n    /**\n     * Publish a message to all subscribers.\n     * @param {*} exchange\n     * @param {*} obj\n     * @param {*} routeKey\n     */\n    async publish_(exchange, obj, routeKey) {\n        const ch = await this.connect_({ exchange, direction: 'out' });\n\n        await ch.assertExchange(exchange, 'fanout', {\n            durable: false,\n        });\n\n        const ret = await ch.publish(\n            exchange,\n            routeKey || '',\n            Buffer.from(JSON.stringify(obj)),\n            {\n                content_type: MessageContentType,\n            }\n        );\n\n        const logMsg = `rabbitmq: new message published to exchange [${exchange}].`;\n\n        if (this.options.logMessage) {\n            this.log('verbose', logMsg, { msg: obj });\n        } else {\n            this.log('verbose', logMsg);\n        }\n\n        return ret;\n    }\n\n    /**\n     * Subscribe to a message exchange.\n     * @param {*} exchange\n     * @param {workerFunction} subscriberMethod\n     * @param {*} routeKey\n     */\n    async subscribe_(exchange, subscriberMethod, routeKey) {\n        const ch = await this.connect_({ exchange, direction: 'in' });\n\n        await ch.assertExchange(exchange, 'fanout', {\n            durable: false,\n        });\n\n        const q = await ch.assertQueue('', {\n            exclusive: true,\n        });\n\n        await ch.bindQueue(q.queue, exchange, routeKey || '');\n\n        const logMsg = `rabbitmq: new message received from exchange [${exchange}].`;\n\n        return ch.consume(\n            q.queue,\n            (msg) => {\n                if (this.options.logMessage) {\n                    this.log('verbose', logMsg, {\n                        msg: msg.content.toString(),\n                    });\n                } else {\n                    this.log('verbose', logMsg);\n                }\n\n                return subscriberMethod(ch, msg);\n            },\n            {\n                // auto acknowledgment mode\n                noAck: true,\n            }\n        );\n    }\n}\n\nRabbitmqConnector.driverLib = AmqpNode;\n\nmodule.exports = RabbitmqConnector;\n"],"mappings":"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"}