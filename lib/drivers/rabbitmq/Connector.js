"use strict";

require("source-map-support/register");

const {
  Promise,
  _
} = require('rk-utils');

const {
  tryRequire
} = require('../../utils/lib');

const AmqpNode = tryRequire('amqplib');

const Connector = require('../../Connector');

const MessageContentType = 'application/json';

class RabbitmqConnector extends Connector {
  constructor(connectionString, options) {
    super('rabbitmq', connectionString, options);
  }

  async end_() {
    delete this.acitveConnections;

    if (this.conn) {
      await this.conn.close();
    }

    delete this.conn;
  }

  async connect_(options) {
    if (!this.conn) {
      this.conn = await AmqpNode.connect(this.connectionString);
      this.log('verbose', `rabbitmq: successfully connected to "${this.getConnectionStringWithoutCredential()}".`);
      this.conn.on('error', async err => {
        this.log('error', `rabbitmq: connection error: ${err}}`);
      });

      if (this.options.logger) {
        this.conn.on('blocked', reason => {
          this.log('warn', `rabbitmq: connection is blocked. ${reason}`);
        });
        this.conn.on('unblocked', () => {
          this.log('info', 'rabbitmq: connection is unblocked.');
        });
      }
    }

    let opts = {
      direction: 'out',
      ...options
    };
    let chKey = opts.exchange ? `[X]${opts.exchange}|${opts.direction}` : `[Q]${opts.queue}|${opts.direction}`;
    this.acitveConnections || (this.acitveConnections = {});
    let ch = this.acitveConnections[chKey];

    if (!ch) {
      ch = await this.conn.createChannel();
      ch.on('error', async err => {
        this.log('error', `rabbitmq: channel error. ${err}`);
      });
      this.acitveConnections[chKey] = ch;
      this.log('verbose', `rabbitmq: new channel created for queue "${chKey}".`);
    }

    return ch;
  }

  async disconnect_(ch) {
    this.log('verbose', 'rabbitmq: channel closed.');

    if (this.acitveConnections) {
      this.acitveConnections = _.omit(this.acitveConnections, conn => conn === ch);
    }
  }

  async ping_() {
    return true;
  }

  async sendToWorkers_(queue, obj) {
    let ch = await this.connect_({
      queue,
      direction: 'out'
    });
    await ch.assertQueue(queue, {
      durable: true
    });
    let ret = await ch.sendToQueue(queue, Buffer.from(JSON.stringify(obj)), {
      persistent: true,
      content_type: MessageContentType
    });
    let logMsg = `rabbitmq: new message enqueued to [${queue}].`;

    if (this.options.logMessage) {
      this.log('verbose', logMsg, {
        msg: obj
      });
    } else {
      this.log('verbose', logMsg);
    }

    return ret;
  }

  async workerConsume_(queue, consumerMethod) {
    let ch = await this.connect_({
      queue,
      direction: 'in'
    });
    await ch.assertQueue(queue, {
      durable: true
    });
    await ch.prefetch(1);
    let logMsg = `rabbitmq: new message dequeued from [${queue}].`;
    return ch.consume(queue, msg => {
      if (this.options.logMessage) {
        this.log('verbose', logMsg, {
          msg: msg.content.toString()
        });
      } else {
        this.log('verbose', logMsg);
      }

      return consumerMethod(ch, msg);
    }, {
      noAck: false
    });
  }

  async publish_(exchange, obj, routeKey) {
    let ch = await this.connect_({
      exchange,
      direction: 'out'
    });
    await ch.assertExchange(exchange, 'fanout', {
      durable: false
    });
    let ret = await ch.publish(exchange, routeKey || '', Buffer.from(JSON.stringify(obj)), {
      content_type: MessageContentType
    });
    let logMsg = `rabbitmq: new message published to exchange [${exchange}].`;

    if (this.options.logMessage) {
      this.log('verbose', logMsg, {
        msg: obj
      });
    } else {
      this.log('verbose', logMsg);
    }

    return ret;
  }

  async subscribe_(exchange, subscriberMethod, routeKey) {
    let ch = await this.connect_({
      exchange,
      direction: 'in'
    });
    await ch.assertExchange(exchange, 'fanout', {
      durable: false
    });
    let q = await ch.assertQueue('', {
      exclusive: true
    });
    await ch.bindQueue(q.queue, exchange, routeKey || '');
    let logMsg = `rabbitmq: new message dequeued from [${queueName}].`;
    return ch.consume(q.queue, msg => {
      if (this.options.logMessage) {
        this.log('verbose', logMsg, {
          msg: msg.content.toString()
        });
      } else {
        this.log('verbose', logMsg);
      }

      return subscriberMethod(ch, msg);
    }, {
      noAck: true
    });
  }

}

RabbitmqConnector.driverLib = AmqpNode;
module.exports = RabbitmqConnector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kcml2ZXJzL3JhYmJpdG1xL0Nvbm5lY3Rvci5qcyJdLCJuYW1lcyI6WyJQcm9taXNlIiwiXyIsInJlcXVpcmUiLCJ0cnlSZXF1aXJlIiwiQW1xcE5vZGUiLCJDb25uZWN0b3IiLCJNZXNzYWdlQ29udGVudFR5cGUiLCJSYWJiaXRtcUNvbm5lY3RvciIsImNvbnN0cnVjdG9yIiwiY29ubmVjdGlvblN0cmluZyIsIm9wdGlvbnMiLCJlbmRfIiwiYWNpdHZlQ29ubmVjdGlvbnMiLCJjb25uIiwiY2xvc2UiLCJjb25uZWN0XyIsImNvbm5lY3QiLCJsb2ciLCJnZXRDb25uZWN0aW9uU3RyaW5nV2l0aG91dENyZWRlbnRpYWwiLCJvbiIsImVyciIsImxvZ2dlciIsInJlYXNvbiIsIm9wdHMiLCJkaXJlY3Rpb24iLCJjaEtleSIsImV4Y2hhbmdlIiwicXVldWUiLCJjaCIsImNyZWF0ZUNoYW5uZWwiLCJkaXNjb25uZWN0XyIsIm9taXQiLCJwaW5nXyIsInNlbmRUb1dvcmtlcnNfIiwib2JqIiwiYXNzZXJ0UXVldWUiLCJkdXJhYmxlIiwicmV0Iiwic2VuZFRvUXVldWUiLCJCdWZmZXIiLCJmcm9tIiwiSlNPTiIsInN0cmluZ2lmeSIsInBlcnNpc3RlbnQiLCJjb250ZW50X3R5cGUiLCJsb2dNc2ciLCJsb2dNZXNzYWdlIiwibXNnIiwid29ya2VyQ29uc3VtZV8iLCJjb25zdW1lck1ldGhvZCIsInByZWZldGNoIiwiY29uc3VtZSIsImNvbnRlbnQiLCJ0b1N0cmluZyIsIm5vQWNrIiwicHVibGlzaF8iLCJyb3V0ZUtleSIsImFzc2VydEV4Y2hhbmdlIiwicHVibGlzaCIsInN1YnNjcmliZV8iLCJzdWJzY3JpYmVyTWV0aG9kIiwicSIsImV4Y2x1c2l2ZSIsImJpbmRRdWV1ZSIsInF1ZXVlTmFtZSIsImRyaXZlckxpYiIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxNQUFNO0FBQUVBLEVBQUFBLE9BQUY7QUFBV0Ms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SSxFQUE1QyxDQUFOO0FBRUEsUUFBSVgsTUFBTSxHQUFJLHdDQUF1Q21CLFNBQVUsSUFBL0Q7QUFFQSxXQUFPcEMsRUFBRSxDQUFDdUIsT0FBSCxDQUFXVSxDQUFDLENBQUNsQyxLQUFiLEVBQXFCb0IsR0FBRCxJQUFTO0FBQ2hDLFVBQUksS0FBS3JDLE9BQUwsQ0FBYW9DLFVBQWpCLEVBQTZCO0FBQ3pCLGFBQUs3QixHQUFMLENBQVMsU0FBVCxFQUFvQjRCLE1BQXBCLEVBQTRCO0FBQUVFLFVBQUFBLEdBQUcsRUFBRUEsR0FBRyxDQUFDSyxPQUFKLENBQVlDLFFBQVo7QUFBUCxTQUE1QjtBQUNILE9BRkQsTUFFTztBQUNILGFBQUtwQyxHQUFMLENBQVMsU0FBVCxFQUFvQjRCLE1BQXBCO0FBQ0g7O0FBRUQsYUFBT2UsZ0JBQWdCLENBQUNoQyxFQUFELEVBQUttQixHQUFMLENBQXZCO0FBQ0gsS0FSTSxFQVFKO0FBRUNPLE1BQUFBLEtBQUssRUFBRTtBQUZSLEtBUkksQ0FBUDtBQVlIOztBQXROcUM7O0FBeU4xQy9DLGlCQUFpQixDQUFDMEQsU0FBbEIsR0FBOEI3RCxRQUE5QjtBQUVBOEQsTUFBTSxDQUFDQyxPQUFQLEdBQWlCNUQsaUJBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgeyBQcm9taXNlLCBfIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyB0cnlSZXF1aXJlIH0gPSByZXF1aXJlKCcuLi8uLi91dGlscy9saWInKTtcbmNvbnN0IEFtcXBOb2RlID0gdHJ5UmVxdWlyZSgnYW1xcGxpYicpO1xuY29uc3QgQ29ubmVjdG9yID0gcmVxdWlyZSgnLi4vLi4vQ29ubmVjdG9yJyk7XG5cbi8qKlxuICogQSBjYWxsYmFjayBmdW5jdGlvbiB0byBiZSBjYWxsZWQgdG8gaGFuZGxlIGEgZGVxdWV1ZWQgbWVzc2FnZS5cbiAqIEBjYWxsYmFjayB3b3JrZXJGdW5jdGlvblxuICogQHBhcmFtIHtDaGFubmVsfSBjaCAtIE1RIENoYW5uZWwgb2JqZWN0XG4gKiBAcGFyYW0ge01lc3NhZ2V9IG1zZyAtIE1lc3NhZ2Ugb2JqZWN0XG4gKi9cblxuY29uc3QgTWVzc2FnZUNvbnRlbnRUeXBlID0gJ2FwcGxpY2F0aW9uL2pzb24nO1xuXG4vKipcbiAqIFJhYmJpdG1xIGRhdGEgc3RvcmFnZSBjb25uZWN0b3IuXG4gKiBAY2xhc3NcbiAqIEBleHRlbmRzIENvbm5lY3RvclxuICovXG5jbGFzcyBSYWJiaXRtcUNvbm5lY3RvciBleHRlbmRzIENvbm5lY3RvciB7XG4gICAgLyoqICAgICAgICAgIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zICAgICAgXG4gICAgICogQHByb3BlcnR5IHtib29sZWFufSBbb3B0aW9ucy5sb2dNZXNzYWdlXSAtIEZsYWcgdG8gbG9nIHF1ZXVlZCBtZXNzYWdlXG4gICAgICovXG4gICAgY29uc3RydWN0b3IoY29ubmVjdGlvblN0cmluZywgb3B0aW9ucykgeyAgICAgICAgXG4gICAgICAgIHN1cGVyKCdyYWJiaXRtcScsIGNvbm5lY3Rpb25TdHJpbmcsIG9wdGlvbnMpOyAgXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2xvc2UgYWxsIGNvbm5lY3Rpb24gaW5pdGlhdGVkIGJ5IHRoaXMgY29ubmVjdG9yLlxuICAgICAqL1xuICAgIGFzeW5jIGVuZF8oKSB7ICAgICAgICBcbiAgICAgICAgZGVsZXRlIHRoaXMuYWNpdHZlQ29ubmVjdGlvbnM7XG5cbiAgICAgICAgaWYgKHRoaXMuY29ubikge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5jb25uLmNsb3NlKCk7XG4gICAgICAgIH1cblxuICAgICAgICBkZWxldGUgdGhpcy5jb25uO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIGRhdGFiYXNlIGNvbm5lY3Rpb24gYmFzZWQgb24gdGhlIGRlZmF1bHQgY29ubmVjdGlvbiBzdHJpbmcgb2YgdGhlIGNvbm5lY3RvciBhbmQgZ2l2ZW4gb3B0aW9ucy4gICAgIFxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc10gLSBFeHRyYSBvcHRpb25zIGZvciB0aGUgY29ubmVjdGlvbiwgb3B0aW9uYWwuXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLnF1ZXVlXSAtIENvbm5lY3Rpb24gZm9yIHF1ZXVlLCBkZWZhdWx0ICcnXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLmV4Y2hhbmdlXSAtIENvbm5lY3Rpb24gZm9yIHF1ZXVlLCBkZWZhdWx0ICcnXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLmRpcmVjdGlvbl0gLSBDb25uZWN0aW9uIGZvciBxdWV1ZSwgZGVmYXVsdCAnJ1xuICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjxEYj59XG4gICAgICovXG4gICAgYXN5bmMgY29ubmVjdF8ob3B0aW9ucykge1xuICAgICAgICBpZiAoIXRoaXMuY29ubikge1xuICAgICAgICAgICAgdGhpcy5jb25uID0gYXdhaXQgQW1xcE5vZGUuY29ubmVjdCh0aGlzLmNvbm5lY3Rpb25TdHJpbmcpO1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBgcmFiYml0bXE6IHN1Y2Nlc3NmdWxseSBjb25uZWN0ZWQgdG8gXCIke3RoaXMuZ2V0Q29ubmVjdGlvblN0cmluZ1dpdGhvdXRDcmVkZW50aWFsKCl9XCIuYCk7ICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIHRoaXMuY29ubi5vbignZXJyb3InLCBhc3luYyBlcnIgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMubG9nKCdlcnJvcicsIGByYWJiaXRtcTogY29ubmVjdGlvbiBlcnJvcjogJHtlcnJ9fWApO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nZ2VyKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jb25uLm9uKCdibG9ja2VkJywgcmVhc29uID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2coJ3dhcm4nLCBgcmFiYml0bXE6IGNvbm5lY3Rpb24gaXMgYmxvY2tlZC4gJHtyZWFzb259YCk7XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICB0aGlzLmNvbm4ub24oJ3VuYmxvY2tlZCcsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2coJ2luZm8nLCAncmFiYml0bXE6IGNvbm5lY3Rpb24gaXMgdW5ibG9ja2VkLicpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9ICAgICBcbiAgICAgICAgXG4gICAgICAgIGxldCBvcHRzID0geyAgICAgICAgICAgIFxuICAgICAgICAgICAgZGlyZWN0aW9uOiAnb3V0JyxcbiAgICAgICAgICAgIC4uLm9wdGlvbnNcbiAgICAgICAgfTtcblxuICAgICAgICBsZXQgY2hLZXkgPSBvcHRzLmV4Y2hhbmdlID8gKGBbWF0ke29wdHMuZXhjaGFuZ2V9fCR7b3B0cy5kaXJlY3Rpb259YCkgOiAoYFtRXSR7b3B0cy5xdWV1ZX18JHtvcHRzLmRpcmVjdGlvbn1gKTtcblxuICAgICAgICB0aGlzLmFjaXR2ZUNvbm5lY3Rpb25zIHx8ICh0aGlzLmFjaXR2ZUNvbm5lY3Rpb25zID0ge30pO1xuICAgICAgICBsZXQgY2ggPSB0aGlzLmFjaXR2ZUNvbm5lY3Rpb25zW2NoS2V5XTtcblxuICAgICAgICBpZiAoIWNoKSB7XG4gICAgICAgICAgICBjaCA9IGF3YWl0IHRoaXMuY29ubi5jcmVhdGVDaGFubmVsKCk7XG5cbiAgICAgICAgICAgIGNoLm9uKCdlcnJvcicsIGFzeW5jIGVyciA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2coJ2Vycm9yJywgYHJhYmJpdG1xOiBjaGFubmVsIGVycm9yLiAke2Vycn1gKTtcbiAgICAgICAgICAgIH0pOyAgICAgICAgICAgIFxuXG4gICAgICAgICAgICB0aGlzLmFjaXR2ZUNvbm5lY3Rpb25zW2NoS2V5XSA9IGNoO1xuXG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGByYWJiaXRtcTogbmV3IGNoYW5uZWwgY3JlYXRlZCBmb3IgcXVldWUgXCIke2NoS2V5fVwiLmApOyAgICAgICAgICAgIFxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGNoO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENsb3NlIGEgZGF0YWJhc2UgY29ubmVjdGlvbi5cbiAgICAgKiBAcGFyYW0ge0RifSBjb25uIC0gTXlTUUwgY29ubmVjdGlvbi5cbiAgICAgKi9cbiAgICBhc3luYyBkaXNjb25uZWN0XyhjaCkge1xuICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdyYWJiaXRtcTogY2hhbm5lbCBjbG9zZWQuJyk7XG5cbiAgICAgICAgaWYgKHRoaXMuYWNpdHZlQ29ubmVjdGlvbnMpIHtcbiAgICAgICAgICAgIHRoaXMuYWNpdHZlQ29ubmVjdGlvbnMgPSBfLm9taXQodGhpcy5hY2l0dmVDb25uZWN0aW9ucywgY29ubiA9PiBjb25uID09PSBjaCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBwaW5nXygpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICBcbiAgICAvKipcbiAgICAgKiBTZW5kIGEgbWVzc2FnZSB0byB3b3JrZXIgcXVldWUuXG4gICAgICogQHNlZSBodHRwczovL3d3dy5yYWJiaXRtcS5jb20vdHV0b3JpYWxzL3R1dG9yaWFsLXR3by1qYXZhc2NyaXB0Lmh0bWxcbiAgICAgKiBAcGFyYW0geyp9IHF1ZXVlIFxuICAgICAqIEBwYXJhbSB7Kn0gb2JqIFxuICAgICAqL1xuICAgIGFzeW5jIHNlbmRUb1dvcmtlcnNfKHF1ZXVlLCBvYmopIHtcbiAgICAgICAgbGV0IGNoID0gYXdhaXQgdGhpcy5jb25uZWN0Xyh7IHF1ZXVlLCBkaXJlY3Rpb246ICdvdXQnIH0pOyAgXG5cbiAgICAgICAgYXdhaXQgY2guYXNzZXJ0UXVldWUocXVldWUsIHtcbiAgICAgICAgICAgIGR1cmFibGU6IHRydWVcbiAgICAgICAgfSk7XG5cbiAgICAgICAgbGV0IHJldCA9IGF3YWl0IGNoLnNlbmRUb1F1ZXVlKHF1ZXVlLCBCdWZmZXIuZnJvbShKU09OLnN0cmluZ2lmeShvYmopKSwge1xuICAgICAgICAgICAgcGVyc2lzdGVudDogdHJ1ZSxcbiAgICAgICAgICAgIGNvbnRlbnRfdHlwZTogTWVzc2FnZUNvbnRlbnRUeXBlXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGxldCBsb2dNc2cgPSBgcmFiYml0bXE6IG5ldyBtZXNzYWdlIGVucXVldWVkIHRvIFske3F1ZXVlfV0uYDtcblxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ01lc3NhZ2UpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgbG9nTXNnLCB7IG1zZzogb2JqIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBsb2dNc2cpO1xuICAgICAgICB9ICAgICAgIFxuXG4gICAgICAgIHJldHVybiByZXQ7XG4gICAgfSAgIFxuXG4gICAgLyoqXG4gICAgICogV2FpdGluZyBmb3IgbWVzc2FnZSBmcm9tIGEgcXVldWUgYnkgYSB3b3JrZXIuXG4gICAgICogQHNlZSBodHRwczovL3d3dy5yYWJiaXRtcS5jb20vdHV0b3JpYWxzL3R1dG9yaWFsLXR3by1qYXZhc2NyaXB0Lmh0bWxcbiAgICAgKiBAcGFyYW0geyp9IHF1ZXVlIFxuICAgICAqIEBwYXJhbSB7d29ya2VyRnVuY3Rpb259IGNvbnN1bWVyTWV0aG9kIFxuICAgICAqL1xuICAgIGFzeW5jIHdvcmtlckNvbnN1bWVfKHF1ZXVlLCBjb25zdW1lck1ldGhvZCkgeyAgICAgICAgXG4gICAgICAgIGxldCBjaCA9IGF3YWl0IHRoaXMuY29ubmVjdF8oeyBxdWV1ZSwgZGlyZWN0aW9uOiAnaW4nIH0pO1xuXG4gICAgICAgIGF3YWl0IGNoLmFzc2VydFF1ZXVlKHF1ZXVlLCB7XG4gICAgICAgICAgICBkdXJhYmxlOiB0cnVlXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGF3YWl0IGNoLnByZWZldGNoKDEpO1xuXG4gICAgICAgIGxldCBsb2dNc2cgPSBgcmFiYml0bXE6IG5ldyBtZXNzYWdlIGRlcXVldWVkIGZyb20gWyR7cXVldWV9XS5gO1xuXG4gICAgICAgIHJldHVybiBjaC5jb25zdW1lKHF1ZXVlLCAobXNnKSA9PiB7IFxuICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dNZXNzYWdlKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBsb2dNc2csIHsgbXNnOiBtc2cuY29udGVudC50b1N0cmluZygpIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGxvZ01zZyk7XG4gICAgICAgICAgICB9ICAgICAgIFxuXG4gICAgICAgICAgICByZXR1cm4gY29uc3VtZXJNZXRob2QoY2gsIG1zZyk7IFxuICAgICAgICB9LCB7XG4gICAgICAgICAgICAvLyBtYW51YWwgYWNrbm93bGVkZ21lbnQgbW9kZVxuICAgICAgICAgICAgLy8gbmVlZCBzZW5kIGEgcHJvcGVyIGFja25vd2xlZGdtZW50IGZyb20gdGhlIHdvcmtlciwgb25jZSBkb25lIHdpdGggYSB0YXNrLlxuICAgICAgICAgICAgbm9BY2s6IGZhbHNlXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFB1Ymxpc2ggYSBtZXNzYWdlIHRvIGFsbCBzdWJzY3JpYmVycy5cbiAgICAgKiBAcGFyYW0geyp9IGV4Y2hhbmdlIFxuICAgICAqIEBwYXJhbSB7Kn0gb2JqIFxuICAgICAqIEBwYXJhbSB7Kn0gcm91dGVLZXkgXG4gICAgICovXG4gICAgYXN5bmMgcHVibGlzaF8oZXhjaGFuZ2UsIG9iaiwgcm91dGVLZXkpIHtcbiAgICAgICAgbGV0IGNoID0gYXdhaXQgdGhpcy5jb25uZWN0Xyh7IGV4Y2hhbmdlLCBkaXJlY3Rpb246ICdvdXQnIH0pOyAgIFxuXG4gICAgICAgIGF3YWl0IGNoLmFzc2VydEV4Y2hhbmdlKGV4Y2hhbmdlLCAnZmFub3V0Jywge1xuICAgICAgICAgICAgZHVyYWJsZTogZmFsc2VcbiAgICAgICAgfSk7XG5cbiAgICAgICAgbGV0IHJldCA9IGF3YWl0IGNoLnB1Ymxpc2goZXhjaGFuZ2UsIHJvdXRlS2V5IHx8ICcnLCBCdWZmZXIuZnJvbShKU09OLnN0cmluZ2lmeShvYmopKSwge1xuICAgICAgICAgICAgY29udGVudF90eXBlOiBNZXNzYWdlQ29udGVudFR5cGVcbiAgICAgICAgfSk7XG5cbiAgICAgICAgbGV0IGxvZ01zZyA9IGByYWJiaXRtcTogbmV3IG1lc3NhZ2UgcHVibGlzaGVkIHRvIGV4Y2hhbmdlIFske2V4Y2hhbmdlfV0uYDtcblxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ01lc3NhZ2UpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgbG9nTXNnLCB7IG1zZzogb2JqIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBsb2dNc2cpO1xuICAgICAgICB9ICAgICAgIFxuXG4gICAgICAgIHJldHVybiByZXQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3Vic2NyaWJlIHRvIGEgbWVzc2FnZSBleGNoYW5nZS5cbiAgICAgKiBAcGFyYW0geyp9IGV4Y2hhbmdlIFxuICAgICAqIEBwYXJhbSB7d29ya2VyRnVuY3Rpb259IHN1YnNjcmliZXJNZXRob2QgXG4gICAgICogQHBhcmFtIHsqfSByb3V0ZUtleSBcbiAgICAgKi9cbiAgICBhc3luYyBzdWJzY3JpYmVfKGV4Y2hhbmdlLCBzdWJzY3JpYmVyTWV0aG9kLCByb3V0ZUtleSkge1xuICAgICAgICBsZXQgY2ggPSBhd2FpdCB0aGlzLmNvbm5lY3RfKHsgZXhjaGFuZ2UsIGRpcmVjdGlvbjogJ2luJyB9KTtcblxuICAgICAgICBhd2FpdCBjaC5hc3NlcnRFeGNoYW5nZShleGNoYW5nZSwgJ2Zhbm91dCcsIHtcbiAgICAgICAgICAgIGR1cmFibGU6IGZhbHNlXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGxldCBxID0gYXdhaXQgY2guYXNzZXJ0UXVldWUoJycsIHtcbiAgICAgICAgICAgIGV4Y2x1c2l2ZTogdHJ1ZVxuICAgICAgICB9KTtcblxuICAgICAgICBhd2FpdCBjaC5iaW5kUXVldWUocS5xdWV1ZSwgZXhjaGFuZ2UsIHJvdXRlS2V5IHx8ICcnKTtcblxuICAgICAgICBsZXQgbG9nTXNnID0gYHJhYmJpdG1xOiBuZXcgbWVzc2FnZSBkZXF1ZXVlZCBmcm9tIFske3F1ZXVlTmFtZX1dLmA7XG5cbiAgICAgICAgcmV0dXJuIGNoLmNvbnN1bWUocS5xdWV1ZSwgKG1zZykgPT4geyBcbiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nTWVzc2FnZSkge1xuICAgICAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgbG9nTXNnLCB7IG1zZzogbXNnLmNvbnRlbnQudG9TdHJpbmcoKSB9KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBsb2dNc2cpO1xuICAgICAgICAgICAgfSAgICAgICBcblxuICAgICAgICAgICAgcmV0dXJuIHN1YnNjcmliZXJNZXRob2QoY2gsIG1zZyk7IFxuICAgICAgICB9LCB7XG4gICAgICAgICAgICAvLyBhdXRvIGFja25vd2xlZGdtZW50IG1vZGVcbiAgICAgICAgICAgIG5vQWNrOiB0cnVlXG4gICAgICAgIH0pO1xuICAgIH1cbn1cblxuUmFiYml0bXFDb25uZWN0b3IuZHJpdmVyTGliID0gQW1xcE5vZGU7XG5cbm1vZHVsZS5leHBvcnRzID0gUmFiYml0bXFDb25uZWN0b3I7Il19