"use strict";

require("source-map-support/register");

const {
  _
} = require('@genx/july');

const {
  tryRequire
} = require('@genx/sys');

const AmqpNode = tryRequire('amqplib', __dirname);

const Connector = require('../../Connector');

const MessageContentType = 'application/json';

class RabbitmqConnector extends Connector {
  constructor(connectionString, options) {
    super('rabbitmq', connectionString, options);
  }

  async end_() {
    delete this.acitveConnections;

    if (this.conn) {
      await this.conn.close();
    }

    delete this.conn;
  }

  async connect_(options) {
    if (!this.conn) {
      this.conn = await AmqpNode.connect(this.connectionString);
      this.log('verbose', `rabbitmq: successfully connected to "${this.getConnectionStringWithoutCredential()}".`);
      this.conn.on('error', async err => {
        this.log('error', `rabbitmq: connection error: ${err}}`);
      });

      if (this.options.logger) {
        this.conn.on('blocked', reason => {
          this.log('warn', `rabbitmq: connection is blocked. ${reason}`);
        });
        this.conn.on('unblocked', () => {
          this.log('info', 'rabbitmq: connection is unblocked.');
        });
      }
    }

    let opts = {
      direction: 'out',
      ...options
    };
    let chKey = opts.exchange ? `[X]${opts.exchange}|${opts.direction}` : `[Q]${opts.queue}|${opts.direction}`;
    this.acitveConnections || (this.acitveConnections = {});
    let ch = this.acitveConnections[chKey];

    if (!ch) {
      ch = await this.conn.createChannel();
      ch.on('error', async err => {
        this.log('error', `rabbitmq: channel error. ${err}`);
      });
      this.acitveConnections[chKey] = ch;
      this.log('verbose', `rabbitmq: new channel created for queue "${chKey}".`);
    }

    return ch;
  }

  async disconnect_(ch) {
    this.log('verbose', 'rabbitmq: channel closed.');

    if (this.acitveConnections) {
      this.acitveConnections = _.omit(this.acitveConnections, conn => conn === ch);
    }
  }

  async ping_() {
    return true;
  }

  async sendToWorkers_(queue, obj) {
    let ch = await this.connect_({
      queue,
      direction: 'out'
    });
    await ch.assertQueue(queue, {
      durable: true
    });
    let ret = await ch.sendToQueue(queue, Buffer.from(JSON.stringify(obj)), {
      persistent: true,
      content_type: MessageContentType
    });
    let logMsg = `rabbitmq: new message enqueued to [${queue}].`;

    if (this.options.logMessage) {
      this.log('verbose', logMsg, {
        msg: obj
      });
    } else {
      this.log('verbose', logMsg);
    }

    return ret;
  }

  async workerConsume_(queue, consumerMethod) {
    let ch = await this.connect_({
      queue,
      direction: 'in'
    });
    await ch.assertQueue(queue, {
      durable: true
    });
    await ch.prefetch(1);
    let logMsg = `rabbitmq: new message dequeued from [${queue}].`;
    return ch.consume(queue, msg => {
      if (this.options.logMessage) {
        this.log('verbose', logMsg, {
          msg: msg.content.toString()
        });
      } else {
        this.log('verbose', logMsg);
      }

      return consumerMethod(ch, msg);
    }, {
      noAck: false
    });
  }

  async publish_(exchange, obj, routeKey) {
    let ch = await this.connect_({
      exchange,
      direction: 'out'
    });
    await ch.assertExchange(exchange, 'fanout', {
      durable: false
    });
    let ret = await ch.publish(exchange, routeKey || '', Buffer.from(JSON.stringify(obj)), {
      content_type: MessageContentType
    });
    let logMsg = `rabbitmq: new message published to exchange [${exchange}].`;

    if (this.options.logMessage) {
      this.log('verbose', logMsg, {
        msg: obj
      });
    } else {
      this.log('verbose', logMsg);
    }

    return ret;
  }

  async subscribe_(exchange, subscriberMethod, routeKey) {
    let ch = await this.connect_({
      exchange,
      direction: 'in'
    });
    await ch.assertExchange(exchange, 'fanout', {
      durable: false
    });
    let q = await ch.assertQueue('', {
      exclusive: true
    });
    await ch.bindQueue(q.queue, exchange, routeKey || '');
    let logMsg = `rabbitmq: new message dequeued from [${queueName}].`;
    return ch.consume(q.queue, msg => {
      if (this.options.logMessage) {
        this.log('verbose', logMsg, {
          msg: msg.content.toString()
        });
      } else {
        this.log('verbose', logMsg);
      }

      return subscriberMethod(ch, msg);
    }, {
      noAck: true
    });
  }

}

RabbitmqConnector.driverLib = AmqpNode;
module.exports = RabbitmqConnector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kcml2ZXJzL3JhYmJpdG1xL0Nvbm5lY3Rvci5qcyJdLCJuYW1lcyI6WyJfIiwicmVxdWlyZSIsInRyeVJlcXVpcmUiLCJBbXFwTm9kZSIsIl9fZGlybmFtZSIsIkNvbm5lY3RvciIsIk1lc3NhZ2VDb250ZW50VHlwZSIsIlJhYmJpdG1xQ29ubmVjdG9yIiwiY29uc3RydWN0b3IiLCJjb25uZWN0aW9uU3RyaW5nIiwib3B0aW9ucyIsImVuZF8iLCJhY2l0dmVDb25uZWN0aW9ucyIsImNvbm4iLCJjbG9zZSIsImNvbm5lY3RfIiwiY29ubmVjdCIsImxvZyIsImdldENvbm5lY3Rpb25TdHJpbmdXaXRob3V0Q3JlZGVudGlhbCIsIm9uIiwiZXJyIiwibG9nZ2VyIiwicmVhc29uIiwib3B0cyIsImRpcmVjdGlvbiIsImNoS2V5IiwiZXhjaGFuZ2UiLCJxdWV1ZSIsImNoIiwiY3JlYXRlQ2hhbm5lbCIsImRpc2Nvbm5lY3RfIiwib21pdCIsInBpbmdfIiwic2VuZFRvV29ya2Vyc18iLCJvYmoiLCJhc3NlcnRRdWV1ZSIsImR1cmFibGUiLCJyZXQiLCJzZW5kVG9RdWV1ZSIsIkJ1ZmZlciIsImZyb20iLCJKU09OIiwic3RyaW5naWZ5IiwicGVyc2lzdGVudCIsImNvbnRlbnRfdHlwZSIsImxvZ01zZyIsImxvZ01lc3NhZ2UiLCJtc2ciLCJ3b3JrZXJDb25zdW1lXyIsImNvbnN1bWVyTWV0aG9kIiwicHJlZmV0Y2giLCJjb25zdW1lIiwiY29udGVudCIsInRvU3RyaW5nIiwibm9BY2siLCJwdWJsaXNoXyIsInJvdXRlS2V5IiwiYXNzZXJ0RXhjaGFuZ2UiLCJwdWJsaXNoIiwic3Vic2NyaWJlXyIsInN1YnNjcmliZXJNZXRob2QiLCJxIiwiZXhjbHVzaXZlIiwiYmluZFF1ZXVlIiwicXVldWVOYW1lIiwiZHJpdmVyTGliIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU07QUFBRUEsRUFBQUE7QUFBRixJQUFR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QyxDQUFOO0FBRUEsUUFBSVgsTUFBTSxHQUFJLHdDQUF1Q21CLFNBQVUsSUFBL0Q7QUFFQSxXQUFPcEMsRUFBRSxDQUFDdUIsT0FBSCxDQUFXVSxDQUFDLENBQUNsQyxLQUFiLEVBQXFCb0IsR0FBRCxJQUFTO0FBQ2hDLFVBQUksS0FBS3JDLE9BQUwsQ0FBYW9DLFVBQWpCLEVBQTZCO0FBQ3pCLGFBQUs3QixHQUFMLENBQVMsU0FBVCxFQUFvQjRCLE1BQXBCLEVBQTRCO0FBQUVFLFVBQUFBLEdBQUcsRUFBRUEsR0FBRyxDQUFDSyxPQUFKLENBQVlDLFFBQVo7QUFBUCxTQUE1QjtBQUNILE9BRkQsTUFFTztBQUNILGFBQUtwQyxHQUFMLENBQVMsU0FBVCxFQUFvQjRCLE1BQXBCO0FBQ0g7O0FBRUQsYUFBT2UsZ0JBQWdCLENBQUNoQyxFQUFELEVBQUttQixHQUFMLENBQXZCO0FBQ0gsS0FSTSxFQVFKO0FBRUNPLE1BQUFBLEtBQUssRUFBRTtBQUZSLEtBUkksQ0FBUDtBQVlIOztBQXROcUM7O0FBeU4xQy9DLGlCQUFpQixDQUFDMEQsU0FBbEIsR0FBOEI5RCxRQUE5QjtBQUVBK0QsTUFBTSxDQUFDQyxPQUFQLEdBQWlCNUQsaUJBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgeyBfIH0gPSByZXF1aXJlKCdAZ2VueC9qdWx5Jyk7XG5jb25zdCB7IHRyeVJlcXVpcmUgfSA9IHJlcXVpcmUoJ0BnZW54L3N5cycpO1xuY29uc3QgQW1xcE5vZGUgPSB0cnlSZXF1aXJlKCdhbXFwbGliJywgX19kaXJuYW1lKTtcbmNvbnN0IENvbm5lY3RvciA9IHJlcXVpcmUoJy4uLy4uL0Nvbm5lY3RvcicpO1xuXG4vKipcbiAqIEEgY2FsbGJhY2sgZnVuY3Rpb24gdG8gYmUgY2FsbGVkIHRvIGhhbmRsZSBhIGRlcXVldWVkIG1lc3NhZ2UuXG4gKiBAY2FsbGJhY2sgd29ya2VyRnVuY3Rpb25cbiAqIEBwYXJhbSB7Q2hhbm5lbH0gY2ggLSBNUSBDaGFubmVsIG9iamVjdFxuICogQHBhcmFtIHtNZXNzYWdlfSBtc2cgLSBNZXNzYWdlIG9iamVjdFxuICovXG5cbmNvbnN0IE1lc3NhZ2VDb250ZW50VHlwZSA9ICdhcHBsaWNhdGlvbi9qc29uJztcblxuLyoqXG4gKiBSYWJiaXRtcSBkYXRhIHN0b3JhZ2UgY29ubmVjdG9yLlxuICogQGNsYXNzXG4gKiBAZXh0ZW5kcyBDb25uZWN0b3JcbiAqL1xuY2xhc3MgUmFiYml0bXFDb25uZWN0b3IgZXh0ZW5kcyBDb25uZWN0b3Ige1xuICAgIC8qKiAgICAgICAgICBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gb3B0aW9ucyAgICAgIFxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW29wdGlvbnMubG9nTWVzc2FnZV0gLSBGbGFnIHRvIGxvZyBxdWV1ZWQgbWVzc2FnZVxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKGNvbm5lY3Rpb25TdHJpbmcsIG9wdGlvbnMpIHsgICAgICAgIFxuICAgICAgICBzdXBlcigncmFiYml0bXEnLCBjb25uZWN0aW9uU3RyaW5nLCBvcHRpb25zKTsgIFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENsb3NlIGFsbCBjb25uZWN0aW9uIGluaXRpYXRlZCBieSB0aGlzIGNvbm5lY3Rvci5cbiAgICAgKi9cbiAgICBhc3luYyBlbmRfKCkgeyAgICAgICAgXG4gICAgICAgIGRlbGV0ZSB0aGlzLmFjaXR2ZUNvbm5lY3Rpb25zO1xuXG4gICAgICAgIGlmICh0aGlzLmNvbm4pIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuY29ubi5jbG9zZSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgZGVsZXRlIHRoaXMuY29ubjtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBkYXRhYmFzZSBjb25uZWN0aW9uIGJhc2VkIG9uIHRoZSBkZWZhdWx0IGNvbm5lY3Rpb24gc3RyaW5nIG9mIHRoZSBjb25uZWN0b3IgYW5kIGdpdmVuIG9wdGlvbnMuICAgICBcbiAgICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdIC0gRXh0cmEgb3B0aW9ucyBmb3IgdGhlIGNvbm5lY3Rpb24sIG9wdGlvbmFsLlxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5xdWV1ZV0gLSBDb25uZWN0aW9uIGZvciBxdWV1ZSwgZGVmYXVsdCAnJ1xuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5leGNoYW5nZV0gLSBDb25uZWN0aW9uIGZvciBxdWV1ZSwgZGVmYXVsdCAnJ1xuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5kaXJlY3Rpb25dIC0gQ29ubmVjdGlvbiBmb3IgcXVldWUsIGRlZmF1bHQgJydcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZS48RGI+fVxuICAgICAqL1xuICAgIGFzeW5jIGNvbm5lY3RfKG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKCF0aGlzLmNvbm4pIHtcbiAgICAgICAgICAgIHRoaXMuY29ubiA9IGF3YWl0IEFtcXBOb2RlLmNvbm5lY3QodGhpcy5jb25uZWN0aW9uU3RyaW5nKTtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYHJhYmJpdG1xOiBzdWNjZXNzZnVsbHkgY29ubmVjdGVkIHRvIFwiJHt0aGlzLmdldENvbm5lY3Rpb25TdHJpbmdXaXRob3V0Q3JlZGVudGlhbCgpfVwiLmApOyAgICAgICAgICAgIFxuXG4gICAgICAgICAgICB0aGlzLmNvbm4ub24oJ2Vycm9yJywgYXN5bmMgZXJyID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZygnZXJyb3InLCBgcmFiYml0bXE6IGNvbm5lY3Rpb24gZXJyb3I6ICR7ZXJyfX1gKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ2dlcikge1xuICAgICAgICAgICAgICAgIHRoaXMuY29ubi5vbignYmxvY2tlZCcsIHJlYXNvbiA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9nKCd3YXJuJywgYHJhYmJpdG1xOiBjb25uZWN0aW9uIGlzIGJsb2NrZWQuICR7cmVhc29ufWApO1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5jb25uLm9uKCd1bmJsb2NrZWQnLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9nKCdpbmZvJywgJ3JhYmJpdG1xOiBjb25uZWN0aW9uIGlzIHVuYmxvY2tlZC4nKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSAgICAgXG4gICAgICAgIFxuICAgICAgICBsZXQgb3B0cyA9IHsgICAgICAgICAgICBcbiAgICAgICAgICAgIGRpcmVjdGlvbjogJ291dCcsXG4gICAgICAgICAgICAuLi5vcHRpb25zXG4gICAgICAgIH07XG5cbiAgICAgICAgbGV0IGNoS2V5ID0gb3B0cy5leGNoYW5nZSA/IChgW1hdJHtvcHRzLmV4Y2hhbmdlfXwke29wdHMuZGlyZWN0aW9ufWApIDogKGBbUV0ke29wdHMucXVldWV9fCR7b3B0cy5kaXJlY3Rpb259YCk7XG5cbiAgICAgICAgdGhpcy5hY2l0dmVDb25uZWN0aW9ucyB8fCAodGhpcy5hY2l0dmVDb25uZWN0aW9ucyA9IHt9KTtcbiAgICAgICAgbGV0IGNoID0gdGhpcy5hY2l0dmVDb25uZWN0aW9uc1tjaEtleV07XG5cbiAgICAgICAgaWYgKCFjaCkge1xuICAgICAgICAgICAgY2ggPSBhd2FpdCB0aGlzLmNvbm4uY3JlYXRlQ2hhbm5lbCgpO1xuXG4gICAgICAgICAgICBjaC5vbignZXJyb3InLCBhc3luYyBlcnIgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMubG9nKCdlcnJvcicsIGByYWJiaXRtcTogY2hhbm5lbCBlcnJvci4gJHtlcnJ9YCk7XG4gICAgICAgICAgICB9KTsgICAgICAgICAgICBcblxuICAgICAgICAgICAgdGhpcy5hY2l0dmVDb25uZWN0aW9uc1tjaEtleV0gPSBjaDtcblxuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBgcmFiYml0bXE6IG5ldyBjaGFubmVsIGNyZWF0ZWQgZm9yIHF1ZXVlIFwiJHtjaEtleX1cIi5gKTsgICAgICAgICAgICBcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBjaDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDbG9zZSBhIGRhdGFiYXNlIGNvbm5lY3Rpb24uXG4gICAgICogQHBhcmFtIHtEYn0gY29ubiAtIE15U1FMIGNvbm5lY3Rpb24uXG4gICAgICovXG4gICAgYXN5bmMgZGlzY29ubmVjdF8oY2gpIHtcbiAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAncmFiYml0bXE6IGNoYW5uZWwgY2xvc2VkLicpO1xuXG4gICAgICAgIGlmICh0aGlzLmFjaXR2ZUNvbm5lY3Rpb25zKSB7XG4gICAgICAgICAgICB0aGlzLmFjaXR2ZUNvbm5lY3Rpb25zID0gXy5vbWl0KHRoaXMuYWNpdHZlQ29ubmVjdGlvbnMsIGNvbm4gPT4gY29ubiA9PT0gY2gpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgcGluZ18oKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgXG4gICAgLyoqXG4gICAgICogU2VuZCBhIG1lc3NhZ2UgdG8gd29ya2VyIHF1ZXVlLlxuICAgICAqIEBzZWUgaHR0cHM6Ly93d3cucmFiYml0bXEuY29tL3R1dG9yaWFscy90dXRvcmlhbC10d28tamF2YXNjcmlwdC5odG1sXG4gICAgICogQHBhcmFtIHsqfSBxdWV1ZSBcbiAgICAgKiBAcGFyYW0geyp9IG9iaiBcbiAgICAgKi9cbiAgICBhc3luYyBzZW5kVG9Xb3JrZXJzXyhxdWV1ZSwgb2JqKSB7XG4gICAgICAgIGxldCBjaCA9IGF3YWl0IHRoaXMuY29ubmVjdF8oeyBxdWV1ZSwgZGlyZWN0aW9uOiAnb3V0JyB9KTsgIFxuXG4gICAgICAgIGF3YWl0IGNoLmFzc2VydFF1ZXVlKHF1ZXVlLCB7XG4gICAgICAgICAgICBkdXJhYmxlOiB0cnVlXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGxldCByZXQgPSBhd2FpdCBjaC5zZW5kVG9RdWV1ZShxdWV1ZSwgQnVmZmVyLmZyb20oSlNPTi5zdHJpbmdpZnkob2JqKSksIHtcbiAgICAgICAgICAgIHBlcnNpc3RlbnQ6IHRydWUsXG4gICAgICAgICAgICBjb250ZW50X3R5cGU6IE1lc3NhZ2VDb250ZW50VHlwZVxuICAgICAgICB9KTtcblxuICAgICAgICBsZXQgbG9nTXNnID0gYHJhYmJpdG1xOiBuZXcgbWVzc2FnZSBlbnF1ZXVlZCB0byBbJHtxdWV1ZX1dLmA7XG5cbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dNZXNzYWdlKSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGxvZ01zZywgeyBtc2c6IG9iaiB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgbG9nTXNnKTtcbiAgICAgICAgfSAgICAgICBcblxuICAgICAgICByZXR1cm4gcmV0O1xuICAgIH0gICBcblxuICAgIC8qKlxuICAgICAqIFdhaXRpbmcgZm9yIG1lc3NhZ2UgZnJvbSBhIHF1ZXVlIGJ5IGEgd29ya2VyLlxuICAgICAqIEBzZWUgaHR0cHM6Ly93d3cucmFiYml0bXEuY29tL3R1dG9yaWFscy90dXRvcmlhbC10d28tamF2YXNjcmlwdC5odG1sXG4gICAgICogQHBhcmFtIHsqfSBxdWV1ZSBcbiAgICAgKiBAcGFyYW0ge3dvcmtlckZ1bmN0aW9ufSBjb25zdW1lck1ldGhvZCBcbiAgICAgKi9cbiAgICBhc3luYyB3b3JrZXJDb25zdW1lXyhxdWV1ZSwgY29uc3VtZXJNZXRob2QpIHsgICAgICAgIFxuICAgICAgICBsZXQgY2ggPSBhd2FpdCB0aGlzLmNvbm5lY3RfKHsgcXVldWUsIGRpcmVjdGlvbjogJ2luJyB9KTtcblxuICAgICAgICBhd2FpdCBjaC5hc3NlcnRRdWV1ZShxdWV1ZSwge1xuICAgICAgICAgICAgZHVyYWJsZTogdHJ1ZVxuICAgICAgICB9KTtcblxuICAgICAgICBhd2FpdCBjaC5wcmVmZXRjaCgxKTtcblxuICAgICAgICBsZXQgbG9nTXNnID0gYHJhYmJpdG1xOiBuZXcgbWVzc2FnZSBkZXF1ZXVlZCBmcm9tIFske3F1ZXVlfV0uYDtcblxuICAgICAgICByZXR1cm4gY2guY29uc3VtZShxdWV1ZSwgKG1zZykgPT4geyBcbiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nTWVzc2FnZSkge1xuICAgICAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgbG9nTXNnLCB7IG1zZzogbXNnLmNvbnRlbnQudG9TdHJpbmcoKSB9KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBsb2dNc2cpO1xuICAgICAgICAgICAgfSAgICAgICBcblxuICAgICAgICAgICAgcmV0dXJuIGNvbnN1bWVyTWV0aG9kKGNoLCBtc2cpOyBcbiAgICAgICAgfSwge1xuICAgICAgICAgICAgLy8gbWFudWFsIGFja25vd2xlZGdtZW50IG1vZGVcbiAgICAgICAgICAgIC8vIG5lZWQgc2VuZCBhIHByb3BlciBhY2tub3dsZWRnbWVudCBmcm9tIHRoZSB3b3JrZXIsIG9uY2UgZG9uZSB3aXRoIGEgdGFzay5cbiAgICAgICAgICAgIG5vQWNrOiBmYWxzZVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBQdWJsaXNoIGEgbWVzc2FnZSB0byBhbGwgc3Vic2NyaWJlcnMuXG4gICAgICogQHBhcmFtIHsqfSBleGNoYW5nZSBcbiAgICAgKiBAcGFyYW0geyp9IG9iaiBcbiAgICAgKiBAcGFyYW0geyp9IHJvdXRlS2V5IFxuICAgICAqL1xuICAgIGFzeW5jIHB1Ymxpc2hfKGV4Y2hhbmdlLCBvYmosIHJvdXRlS2V5KSB7XG4gICAgICAgIGxldCBjaCA9IGF3YWl0IHRoaXMuY29ubmVjdF8oeyBleGNoYW5nZSwgZGlyZWN0aW9uOiAnb3V0JyB9KTsgICBcblxuICAgICAgICBhd2FpdCBjaC5hc3NlcnRFeGNoYW5nZShleGNoYW5nZSwgJ2Zhbm91dCcsIHtcbiAgICAgICAgICAgIGR1cmFibGU6IGZhbHNlXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGxldCByZXQgPSBhd2FpdCBjaC5wdWJsaXNoKGV4Y2hhbmdlLCByb3V0ZUtleSB8fCAnJywgQnVmZmVyLmZyb20oSlNPTi5zdHJpbmdpZnkob2JqKSksIHtcbiAgICAgICAgICAgIGNvbnRlbnRfdHlwZTogTWVzc2FnZUNvbnRlbnRUeXBlXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGxldCBsb2dNc2cgPSBgcmFiYml0bXE6IG5ldyBtZXNzYWdlIHB1Ymxpc2hlZCB0byBleGNoYW5nZSBbJHtleGNoYW5nZX1dLmA7XG5cbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dNZXNzYWdlKSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGxvZ01zZywgeyBtc2c6IG9iaiB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgbG9nTXNnKTtcbiAgICAgICAgfSAgICAgICBcblxuICAgICAgICByZXR1cm4gcmV0O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN1YnNjcmliZSB0byBhIG1lc3NhZ2UgZXhjaGFuZ2UuXG4gICAgICogQHBhcmFtIHsqfSBleGNoYW5nZSBcbiAgICAgKiBAcGFyYW0ge3dvcmtlckZ1bmN0aW9ufSBzdWJzY3JpYmVyTWV0aG9kIFxuICAgICAqIEBwYXJhbSB7Kn0gcm91dGVLZXkgXG4gICAgICovXG4gICAgYXN5bmMgc3Vic2NyaWJlXyhleGNoYW5nZSwgc3Vic2NyaWJlck1ldGhvZCwgcm91dGVLZXkpIHtcbiAgICAgICAgbGV0IGNoID0gYXdhaXQgdGhpcy5jb25uZWN0Xyh7IGV4Y2hhbmdlLCBkaXJlY3Rpb246ICdpbicgfSk7XG5cbiAgICAgICAgYXdhaXQgY2guYXNzZXJ0RXhjaGFuZ2UoZXhjaGFuZ2UsICdmYW5vdXQnLCB7XG4gICAgICAgICAgICBkdXJhYmxlOiBmYWxzZVxuICAgICAgICB9KTtcblxuICAgICAgICBsZXQgcSA9IGF3YWl0IGNoLmFzc2VydFF1ZXVlKCcnLCB7XG4gICAgICAgICAgICBleGNsdXNpdmU6IHRydWVcbiAgICAgICAgfSk7XG5cbiAgICAgICAgYXdhaXQgY2guYmluZFF1ZXVlKHEucXVldWUsIGV4Y2hhbmdlLCByb3V0ZUtleSB8fCAnJyk7XG5cbiAgICAgICAgbGV0IGxvZ01zZyA9IGByYWJiaXRtcTogbmV3IG1lc3NhZ2UgZGVxdWV1ZWQgZnJvbSBbJHtxdWV1ZU5hbWV9XS5gO1xuXG4gICAgICAgIHJldHVybiBjaC5jb25zdW1lKHEucXVldWUsIChtc2cpID0+IHsgXG4gICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ01lc3NhZ2UpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGxvZ01zZywgeyBtc2c6IG1zZy5jb250ZW50LnRvU3RyaW5nKCkgfSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgbG9nTXNnKTtcbiAgICAgICAgICAgIH0gICAgICAgXG5cbiAgICAgICAgICAgIHJldHVybiBzdWJzY3JpYmVyTWV0aG9kKGNoLCBtc2cpOyBcbiAgICAgICAgfSwge1xuICAgICAgICAgICAgLy8gYXV0byBhY2tub3dsZWRnbWVudCBtb2RlXG4gICAgICAgICAgICBub0FjazogdHJ1ZVxuICAgICAgICB9KTtcbiAgICB9XG59XG5cblJhYmJpdG1xQ29ubmVjdG9yLmRyaXZlckxpYiA9IEFtcXBOb2RlO1xuXG5tb2R1bGUuZXhwb3J0cyA9IFJhYmJpdG1xQ29ubmVjdG9yOyJdfQ==