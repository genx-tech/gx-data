"use strict";

require("source-map-support/register");

const {
  Promise,
  _
} = require('rk-utils');

const {
  tryRequire
} = require('../../utils/lib');

const AmqpNode = tryRequire('amqplib');

const Connector = require('../../Connector');

const MessageContentType = 'application/json';

class RabbitmqConnector extends Connector {
  constructor(connectionString, options) {
    super('rabbitmq', connectionString, options);
  }

  async end_() {
    delete this.acitveConnections;

    if (this.conn) {
      await this.conn.close();
    }

    delete this.conn;
  }

  async connect_(options) {
    if (!this.conn) {
      this.conn = await AmqpNode.connect(this.connectionString);
      this.log('verbose', `rabbitmq: successfully connected to "${this.getConnectionStringWithoutCredential()}".`);
      this.conn.on('error', async err => {
        this.log('error', `rabbitmq: connection error: ${err}}`);
      });

      if (this.options.logger) {
        this.conn.on('blocked', reason => {
          this.log('warn', `rabbitmq: connection is blocked. ${reason}`);
        });
        this.conn.on('unblocked', () => {
          this.log('info', 'rabbitmq: connection is unblocked.');
        });
      }
    }

    let opts = {
      direction: 'out',
      ...options
    };
    let chKey = opts.exchange ? `[X]${opts.exchange}|${opts.direction}` : `[Q]${opts.queue}|${opts.direction}`;
    this.acitveConnections || (this.acitveConnections = {});
    let ch = this.acitveConnections[chKey];

    if (!ch) {
      ch = await this.conn.createChannel();
      ch.on('error', async err => {
        this.log('error', `rabbitmq: channel error. ${err}`);
      });
      this.acitveConnections[chKey] = ch;
      this.log('verbose', `rabbitmq: new channel created for queue "${chKey}".`);
    }

    return ch;
  }

  async disconnect_(ch) {
    this.log('verbose', 'rabbitmq: channel closed.');

    if (this.acitveConnections) {
      this.acitveConnections = _.omit(this.acitveConnections, conn => conn === ch);
    }
  }

  async ping_() {
    return true;
  }

  async sendToWorkers_(queue, obj) {
    let ch = await this.connect_({
      queue,
      direction: 'out'
    });
    await ch.assertQueue(queue, {
      durable: true
    });
    let ret = await ch.sendToQueue(queue, Buffer.from(JSON.stringify(obj)), {
      persistent: true,
      content_type: MessageContentType
    });
    let logMsg = `rabbitmq: new message enqueued to [${queue}].`;

    if (this.options.logMessage) {
      this.log('verbose', logMsg, {
        msg: obj
      });
    } else {
      this.log('verbose', logMsg);
    }

    return ret;
  }

  async workerConsume_(queue, consumerMethod) {
    let ch = await this.connect_({
      queue,
      direction: 'in'
    });
    await ch.assertQueue(queue, {
      durable: true
    });
    await ch.prefetch(1);
    let logMsg = `rabbitmq: new message dequeued from [${queue}].`;
    return ch.consume(queue, msg => {
      if (this.options.logMessage) {
        this.log('verbose', logMsg, {
          msg: msg.content.toString()
        });
      } else {
        this.log('verbose', logMsg);
      }

      return consumerMethod(ch, msg);
    }, {
      noAck: false
    });
  }

  async publish_(exchange, obj, routeKey) {
    let ch = await this.connect_({
      exchange,
      direction: 'out'
    });
    await ch.assertExchange(exchange, 'fanout', {
      durable: false
    });
    let ret = await ch.publish(exchange, routeKey || '', Buffer.from(JSON.stringify(obj)), {
      content_type: MessageContentType
    });
    let logMsg = `rabbitmq: new message published to exchange [${exchange}].`;

    if (this.options.logMessage) {
      this.log('verbose', logMsg, {
        msg: obj
      });
    } else {
      this.log('verbose', logMsg);
    }

    return ret;
  }

  async subscribe_(exchange, subscriberMethod, routeKey) {
    let ch = await this.connect_({
      exchange,
      direction: 'in'
    });
    await ch.assertExchange(exchange, 'fanout', {
      durable: false
    });
    let q = await ch.assertQueue('', {
      exclusive: true
    });
    await ch.bindQueue(q.queue, exchange, routeKey || '');
    let logMsg = `rabbitmq: new message dequeued from [${queueName}].`;
    return ch.consume(q.queue, msg => {
      if (this.options.logMessage) {
        this.log('verbose', logMsg, {
          msg: msg.content.toString()
        });
      } else {
        this.log('verbose', logMsg);
      }

      return subscriberMethod(ch, msg);
    }, {
      noAck: true
    });
  }

}

RabbitmqConnector.driverLib = AmqpNode;
module.exports = RabbitmqConnector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kcml2ZXJzL3JhYmJpdG1xL0Nvbm5lY3Rvci5qcyJdLCJuYW1lcyI6WyJQcm9taXNlIiwiXyIsInJlcXVpcmUiLCJ0cnlSZXF1aXJlIiwiQW1xcE5vZGUiLCJDb25uZWN0b3IiLCJNZXNzYWdlQ29udGVudFR5cGUiLCJSYWJiaXRtcUNvbm5lY3RvciIsImNvbnN0cnVjdG9yIiwiY29ubmVjdGlvblN0cmluZyIsIm9wdGlvbnMiLCJlbmRfIiwiYWNpdHZlQ29ubmVjdGlvbnMiLCJjb25uIiwiY2xvc2UiLCJjb25uZWN0XyIsImNvbm5lY3QiLCJsb2ciLCJnZXRDb25uZWN0aW9uU3RyaW5nV2l0aG91dENyZWRlbnRpYWwiLCJvbiIsImVyciIsImxvZ2dlciIsInJlYXNvbiIsIm9wdHMiLCJkaXJlY3Rpb24iLCJjaEtleSIsImV4Y2hhbmdlIiwicXVldWUiLCJjaCIsImNyZWF0ZUNoYW5uZWwiLCJkaXNjb25uZWN0XyIsIm9taXQiLCJwaW5nXyIsInNlbmRUb1dvcmtlcnNfIiwib2JqIiwiYXNzZXJ0UXVldWUiLCJkdXJhYmxlIiwicmV0Iiwic2VuZFRvUXVldWUiLCJCdWZmZXIiLCJmcm9tIiwiSlNPTiIsInN0cmluZ2lmeSIsInBlcnNpc3RlbnQiLCJjb250ZW50X3R5cGUiLCJsb2dNc2ciLCJsb2dNZXNzYWdlIiwibXNnIiwid29ya2VyQ29uc3VtZV8iLCJjb25zdW1lck1ldGhvZCIsInByZWZldGNoIiwiY29uc3VtZSIsImNvbnRlbnQiLCJ0b1N0cmluZyIsIm5vQWNrIiwicHVibGlzaF8iLCJyb3V0ZUtleSIsImFzc2VydEV4Y2hhbmdlIiwicHVibGlzaCIsInN1YnNjcmliZV8iLCJzdWJzY3JpYmVyTWV0aG9kIiwicSIsImV4Y2x1c2l2ZSIsImJpbmRRdWV1ZSIsInF1ZXVlTmFtZSIsImRyaXZlckxpYiIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxNQUFNO0FBQUVBLEVBQUFBLE9BQUY7QUFBV0Ms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QSxRQUFJWCxNQUFNLEdBQUksd0NBQXVDbUIsU0FBVSxJQUEvRDtBQUVBLFdBQU9wQyxFQUFFLENBQUN1QixPQUFILENBQVdVLENBQUMsQ0FBQ2xDLEtBQWIsRUFBcUJvQixHQUFELElBQVM7QUFDaEMsVUFBSSxLQUFLckMsT0FBTCxDQUFhb0MsVUFBakIsRUFBNkI7QUFDekIsYUFBSzdCLEdBQUwsQ0FBUyxTQUFULEVBQW9CNEIsTUFBcEIsRUFBNEI7QUFBRUUsVUFBQUEsR0FBRyxFQUFFQSxHQUFHLENBQUNLLE9BQUosQ0FBWUMsUUFBWjtBQUFQLFNBQTVCO0FBQ0gsT0FGRCxNQUVPO0FBQ0gsYUFBS3BDLEdBQUwsQ0FBUyxTQUFULEVBQW9CNEIsTUFBcEI7QUFDSDs7QUFFRCxhQUFPZSxnQkFBZ0IsQ0FBQ2hDLEVBQUQsRUFBS21CLEdBQUwsQ0FBdkI7QUFDSCxLQVJNLEVBUUo7QUFFQ08sTUFBQUEsS0FBSyxFQUFFO0FBRlIsS0FSSSxDQUFQO0FBWUg7O0FBdE5xQzs7QUF5TjFDL0MsaUJBQWlCLENBQUMwRCxTQUFsQixHQUE4QjdELFFBQTlCO0FBRUE4RCxNQUFNLENBQUNDLE9BQVAsR0FBaUI1RCxpQkFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCB7IFByb21pc2UsIF8gfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IHRyeVJlcXVpcmUgfSA9IHJlcXVpcmUoJy4uLy4uL3V0aWxzL2xpYicpO1xuY29uc3QgQW1xcE5vZGUgPSB0cnlSZXF1aXJlKCdhbXFwbGliJyk7XG5jb25zdCBDb25uZWN0b3IgPSByZXF1aXJlKCcuLi8uLi9Db25uZWN0b3InKTtcblxuLyoqXG4gKiBBIGNhbGxiYWNrIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCB0byBoYW5kbGUgYSBkZXF1ZXVlZCBtZXNzYWdlLlxuICogQGNhbGxiYWNrIHdvcmtlckZ1bmN0aW9uXG4gKiBAcGFyYW0ge0NoYW5uZWx9IGNoIC0gTVEgQ2hhbm5lbCBvYmplY3RcbiAqIEBwYXJhbSB7TWVzc2FnZX0gbXNnIC0gTWVzc2FnZSBvYmplY3RcbiAqL1xuXG5jb25zdCBNZXNzYWdlQ29udGVudFR5cGUgPSAnYXBwbGljYXRpb24vanNvbic7XG5cbi8qKlxuICogUmFiYml0bXEgZGF0YSBzdG9yYWdlIGNvbm5lY3Rvci5cbiAqIEBjbGFzc1xuICogQGV4dGVuZHMgQ29ubmVjdG9yXG4gKi9cbmNsYXNzIFJhYmJpdG1xQ29ubmVjdG9yIGV4dGVuZHMgQ29ubmVjdG9yIHtcbiAgICAvKiogICAgICAgICAgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgICAgICBcbiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IFtvcHRpb25zLmxvZ01lc3NhZ2VdIC0gRmxhZyB0byBsb2cgcXVldWVkIG1lc3NhZ2VcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3Rvcihjb25uZWN0aW9uU3RyaW5nLCBvcHRpb25zKSB7ICAgICAgICBcbiAgICAgICAgc3VwZXIoJ3JhYmJpdG1xJywgY29ubmVjdGlvblN0cmluZywgb3B0aW9ucyk7ICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDbG9zZSBhbGwgY29ubmVjdGlvbiBpbml0aWF0ZWQgYnkgdGhpcyBjb25uZWN0b3IuXG4gICAgICovXG4gICAgYXN5bmMgZW5kXygpIHsgICAgICAgIFxuICAgICAgICBkZWxldGUgdGhpcy5hY2l0dmVDb25uZWN0aW9ucztcblxuICAgICAgICBpZiAodGhpcy5jb25uKSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmNvbm4uY2xvc2UoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGRlbGV0ZSB0aGlzLmNvbm47XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgZGF0YWJhc2UgY29ubmVjdGlvbiBiYXNlZCBvbiB0aGUgZGVmYXVsdCBjb25uZWN0aW9uIHN0cmluZyBvZiB0aGUgY29ubmVjdG9yIGFuZCBnaXZlbiBvcHRpb25zLiAgICAgXG4gICAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXSAtIEV4dHJhIG9wdGlvbnMgZm9yIHRoZSBjb25uZWN0aW9uLCBvcHRpb25hbC5cbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMucXVldWVdIC0gQ29ubmVjdGlvbiBmb3IgcXVldWUsIGRlZmF1bHQgJydcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuZXhjaGFuZ2VdIC0gQ29ubmVjdGlvbiBmb3IgcXVldWUsIGRlZmF1bHQgJydcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuZGlyZWN0aW9uXSAtIENvbm5lY3Rpb24gZm9yIHF1ZXVlLCBkZWZhdWx0ICcnXG4gICAgICogQHJldHVybnMge1Byb21pc2UuPERiPn1cbiAgICAgKi9cbiAgICBhc3luYyBjb25uZWN0XyhvcHRpb25zKSB7XG4gICAgICAgIGlmICghdGhpcy5jb25uKSB7XG4gICAgICAgICAgICB0aGlzLmNvbm4gPSBhd2FpdCBBbXFwTm9kZS5jb25uZWN0KHRoaXMuY29ubmVjdGlvblN0cmluZyk7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGByYWJiaXRtcTogc3VjY2Vzc2Z1bGx5IGNvbm5lY3RlZCB0byBcIiR7dGhpcy5nZXRDb25uZWN0aW9uU3RyaW5nV2l0aG91dENyZWRlbnRpYWwoKX1cIi5gKTsgICAgICAgICAgICBcblxuICAgICAgICAgICAgdGhpcy5jb25uLm9uKCdlcnJvcicsIGFzeW5jIGVyciA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2coJ2Vycm9yJywgYHJhYmJpdG1xOiBjb25uZWN0aW9uIGVycm9yOiAke2Vycn19YCk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dnZXIpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbm4ub24oJ2Jsb2NrZWQnLCByZWFzb24gPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmxvZygnd2FybicsIGByYWJiaXRtcTogY29ubmVjdGlvbiBpcyBibG9ja2VkLiAke3JlYXNvbn1gKTtcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIHRoaXMuY29ubi5vbigndW5ibG9ja2VkJywgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmxvZygnaW5mbycsICdyYWJiaXRtcTogY29ubmVjdGlvbiBpcyB1bmJsb2NrZWQuJyk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gICAgIFxuICAgICAgICBcbiAgICAgICAgbGV0IG9wdHMgPSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBkaXJlY3Rpb246ICdvdXQnLFxuICAgICAgICAgICAgLi4ub3B0aW9uc1xuICAgICAgICB9O1xuXG4gICAgICAgIGxldCBjaEtleSA9IG9wdHMuZXhjaGFuZ2UgPyAoYFtYXSR7b3B0cy5leGNoYW5nZX18JHtvcHRzLmRpcmVjdGlvbn1gKSA6IChgW1FdJHtvcHRzLnF1ZXVlfXwke29wdHMuZGlyZWN0aW9ufWApO1xuXG4gICAgICAgIHRoaXMuYWNpdHZlQ29ubmVjdGlvbnMgfHwgKHRoaXMuYWNpdHZlQ29ubmVjdGlvbnMgPSB7fSk7XG4gICAgICAgIGxldCBjaCA9IHRoaXMuYWNpdHZlQ29ubmVjdGlvbnNbY2hLZXldO1xuXG4gICAgICAgIGlmICghY2gpIHtcbiAgICAgICAgICAgIGNoID0gYXdhaXQgdGhpcy5jb25uLmNyZWF0ZUNoYW5uZWwoKTtcblxuICAgICAgICAgICAgY2gub24oJ2Vycm9yJywgYXN5bmMgZXJyID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZygnZXJyb3InLCBgcmFiYml0bXE6IGNoYW5uZWwgZXJyb3IuICR7ZXJyfWApO1xuICAgICAgICAgICAgfSk7ICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIHRoaXMuYWNpdHZlQ29ubmVjdGlvbnNbY2hLZXldID0gY2g7XG5cbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYHJhYmJpdG1xOiBuZXcgY2hhbm5lbCBjcmVhdGVkIGZvciBxdWV1ZSBcIiR7Y2hLZXl9XCIuYCk7ICAgICAgICAgICAgXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gY2g7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2xvc2UgYSBkYXRhYmFzZSBjb25uZWN0aW9uLlxuICAgICAqIEBwYXJhbSB7RGJ9IGNvbm4gLSBNeVNRTCBjb25uZWN0aW9uLlxuICAgICAqL1xuICAgIGFzeW5jIGRpc2Nvbm5lY3RfKGNoKSB7XG4gICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ3JhYmJpdG1xOiBjaGFubmVsIGNsb3NlZC4nKTtcblxuICAgICAgICBpZiAodGhpcy5hY2l0dmVDb25uZWN0aW9ucykge1xuICAgICAgICAgICAgdGhpcy5hY2l0dmVDb25uZWN0aW9ucyA9IF8ub21pdCh0aGlzLmFjaXR2ZUNvbm5lY3Rpb25zLCBjb25uID0+IGNvbm4gPT09IGNoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIHBpbmdfKCkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIFxuICAgIC8qKlxuICAgICAqIFNlbmQgYSBtZXNzYWdlIHRvIHdvcmtlciBxdWV1ZS5cbiAgICAgKiBAc2VlIGh0dHBzOi8vd3d3LnJhYmJpdG1xLmNvbS90dXRvcmlhbHMvdHV0b3JpYWwtdHdvLWphdmFzY3JpcHQuaHRtbFxuICAgICAqIEBwYXJhbSB7Kn0gcXVldWUgXG4gICAgICogQHBhcmFtIHsqfSBvYmogXG4gICAgICovXG4gICAgYXN5bmMgc2VuZFRvV29ya2Vyc18ocXVldWUsIG9iaikge1xuICAgICAgICBsZXQgY2ggPSBhd2FpdCB0aGlzLmNvbm5lY3RfKHsgcXVldWUsIGRpcmVjdGlvbjogJ291dCcgfSk7ICBcblxuICAgICAgICBhd2FpdCBjaC5hc3NlcnRRdWV1ZShxdWV1ZSwge1xuICAgICAgICAgICAgZHVyYWJsZTogdHJ1ZVxuICAgICAgICB9KTtcblxuICAgICAgICBsZXQgcmV0ID0gYXdhaXQgY2guc2VuZFRvUXVldWUocXVldWUsIEJ1ZmZlci5mcm9tKEpTT04uc3RyaW5naWZ5KG9iaikpLCB7XG4gICAgICAgICAgICBwZXJzaXN0ZW50OiB0cnVlLFxuICAgICAgICAgICAgY29udGVudF90eXBlOiBNZXNzYWdlQ29udGVudFR5cGVcbiAgICAgICAgfSk7XG5cbiAgICAgICAgbGV0IGxvZ01zZyA9IGByYWJiaXRtcTogbmV3IG1lc3NhZ2UgZW5xdWV1ZWQgdG8gWyR7cXVldWV9XS5gO1xuXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nTWVzc2FnZSkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBsb2dNc2csIHsgbXNnOiBvYmogfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGxvZ01zZyk7XG4gICAgICAgIH0gICAgICAgXG5cbiAgICAgICAgcmV0dXJuIHJldDtcbiAgICB9ICAgXG5cbiAgICAvKipcbiAgICAgKiBXYWl0aW5nIGZvciBtZXNzYWdlIGZyb20gYSBxdWV1ZSBieSBhIHdvcmtlci5cbiAgICAgKiBAc2VlIGh0dHBzOi8vd3d3LnJhYmJpdG1xLmNvbS90dXRvcmlhbHMvdHV0b3JpYWwtdHdvLWphdmFzY3JpcHQuaHRtbFxuICAgICAqIEBwYXJhbSB7Kn0gcXVldWUgXG4gICAgICogQHBhcmFtIHt3b3JrZXJGdW5jdGlvbn0gY29uc3VtZXJNZXRob2QgXG4gICAgICovXG4gICAgYXN5bmMgd29ya2VyQ29uc3VtZV8ocXVldWUsIGNvbnN1bWVyTWV0aG9kKSB7ICAgICAgICBcbiAgICAgICAgbGV0IGNoID0gYXdhaXQgdGhpcy5jb25uZWN0Xyh7IHF1ZXVlLCBkaXJlY3Rpb246ICdpbicgfSk7XG5cbiAgICAgICAgYXdhaXQgY2guYXNzZXJ0UXVldWUocXVldWUsIHtcbiAgICAgICAgICAgIGR1cmFibGU6IHRydWVcbiAgICAgICAgfSk7XG5cbiAgICAgICAgYXdhaXQgY2gucHJlZmV0Y2goMSk7XG5cbiAgICAgICAgbGV0IGxvZ01zZyA9IGByYWJiaXRtcTogbmV3IG1lc3NhZ2UgZGVxdWV1ZWQgZnJvbSBbJHtxdWV1ZX1dLmA7XG5cbiAgICAgICAgcmV0dXJuIGNoLmNvbnN1bWUocXVldWUsIChtc2cpID0+IHsgXG4gICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ01lc3NhZ2UpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGxvZ01zZywgeyBtc2c6IG1zZy5jb250ZW50LnRvU3RyaW5nKCkgfSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgbG9nTXNnKTtcbiAgICAgICAgICAgIH0gICAgICAgXG5cbiAgICAgICAgICAgIHJldHVybiBjb25zdW1lck1ldGhvZChjaCwgbXNnKTsgXG4gICAgICAgIH0sIHtcbiAgICAgICAgICAgIC8vIG1hbnVhbCBhY2tub3dsZWRnbWVudCBtb2RlXG4gICAgICAgICAgICAvLyBuZWVkIHNlbmQgYSBwcm9wZXIgYWNrbm93bGVkZ21lbnQgZnJvbSB0aGUgd29ya2VyLCBvbmNlIGRvbmUgd2l0aCBhIHRhc2suXG4gICAgICAgICAgICBub0FjazogZmFsc2VcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUHVibGlzaCBhIG1lc3NhZ2UgdG8gYWxsIHN1YnNjcmliZXJzLlxuICAgICAqIEBwYXJhbSB7Kn0gZXhjaGFuZ2UgXG4gICAgICogQHBhcmFtIHsqfSBvYmogXG4gICAgICogQHBhcmFtIHsqfSByb3V0ZUtleSBcbiAgICAgKi9cbiAgICBhc3luYyBwdWJsaXNoXyhleGNoYW5nZSwgb2JqLCByb3V0ZUtleSkge1xuICAgICAgICBsZXQgY2ggPSBhd2FpdCB0aGlzLmNvbm5lY3RfKHsgZXhjaGFuZ2UsIGRpcmVjdGlvbjogJ291dCcgfSk7ICAgXG5cbiAgICAgICAgYXdhaXQgY2guYXNzZXJ0RXhjaGFuZ2UoZXhjaGFuZ2UsICdmYW5vdXQnLCB7XG4gICAgICAgICAgICBkdXJhYmxlOiBmYWxzZVxuICAgICAgICB9KTtcblxuICAgICAgICBsZXQgcmV0ID0gYXdhaXQgY2gucHVibGlzaChleGNoYW5nZSwgcm91dGVLZXkgfHwgJycsIEJ1ZmZlci5mcm9tKEpTT04uc3RyaW5naWZ5KG9iaikpLCB7XG4gICAgICAgICAgICBjb250ZW50X3R5cGU6IE1lc3NhZ2VDb250ZW50VHlwZVxuICAgICAgICB9KTtcblxuICAgICAgICBsZXQgbG9nTXNnID0gYHJhYmJpdG1xOiBuZXcgbWVzc2FnZSBwdWJsaXNoZWQgdG8gZXhjaGFuZ2UgWyR7ZXhjaGFuZ2V9XS5gO1xuXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nTWVzc2FnZSkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBsb2dNc2csIHsgbXNnOiBvYmogfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGxvZ01zZyk7XG4gICAgICAgIH0gICAgICAgXG5cbiAgICAgICAgcmV0dXJuIHJldDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdWJzY3JpYmUgdG8gYSBtZXNzYWdlIGV4Y2hhbmdlLlxuICAgICAqIEBwYXJhbSB7Kn0gZXhjaGFuZ2UgXG4gICAgICogQHBhcmFtIHt3b3JrZXJGdW5jdGlvbn0gc3Vic2NyaWJlck1ldGhvZCBcbiAgICAgKiBAcGFyYW0geyp9IHJvdXRlS2V5IFxuICAgICAqL1xuICAgIGFzeW5jIHN1YnNjcmliZV8oZXhjaGFuZ2UsIHN1YnNjcmliZXJNZXRob2QsIHJvdXRlS2V5KSB7XG4gICAgICAgIGxldCBjaCA9IGF3YWl0IHRoaXMuY29ubmVjdF8oeyBleGNoYW5nZSwgZGlyZWN0aW9uOiAnaW4nIH0pO1xuXG4gICAgICAgIGF3YWl0IGNoLmFzc2VydEV4Y2hhbmdlKGV4Y2hhbmdlLCAnZmFub3V0Jywge1xuICAgICAgICAgICAgZHVyYWJsZTogZmFsc2VcbiAgICAgICAgfSk7XG5cbiAgICAgICAgbGV0IHEgPSBhd2FpdCBjaC5hc3NlcnRRdWV1ZSgnJywge1xuICAgICAgICAgICAgZXhjbHVzaXZlOiB0cnVlXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGF3YWl0IGNoLmJpbmRRdWV1ZShxLnF1ZXVlLCBleGNoYW5nZSwgcm91dGVLZXkgfHwgJycpO1xuXG4gICAgICAgIGxldCBsb2dNc2cgPSBgcmFiYml0bXE6IG5ldyBtZXNzYWdlIGRlcXVldWVkIGZyb20gWyR7cXVldWVOYW1lfV0uYDtcblxuICAgICAgICByZXR1cm4gY2guY29uc3VtZShxLnF1ZXVlLCAobXNnKSA9PiB7IFxuICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dNZXNzYWdlKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBsb2dNc2csIHsgbXNnOiBtc2cuY29udGVudC50b1N0cmluZygpIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGxvZ01zZyk7XG4gICAgICAgICAgICB9ICAgICAgIFxuXG4gICAgICAgICAgICByZXR1cm4gc3Vic2NyaWJlck1ldGhvZChjaCwgbXNnKTsgXG4gICAgICAgIH0sIHtcbiAgICAgICAgICAgIC8vIGF1dG8gYWNrbm93bGVkZ21lbnQgbW9kZVxuICAgICAgICAgICAgbm9BY2s6IHRydWVcbiAgICAgICAgfSk7XG4gICAgfVxufVxuXG5SYWJiaXRtcUNvbm5lY3Rvci5kcml2ZXJMaWIgPSBBbXFwTm9kZTtcblxubW9kdWxlLmV4cG9ydHMgPSBSYWJiaXRtcUNvbm5lY3RvcjsiXX0=