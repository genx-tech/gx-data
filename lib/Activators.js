"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const {
  ApplicationError,
  RequestError
} = require('./utils/Errors');

module.exports = {
  datetimeAdd: function (model, context, startTime, duration) {
    return startTime.plus(duration);
  },
  isEqual: function (model, context, value1, value2) {
    return value1 === value2;
  },
  triggerUpdate: function (model, context, value, condition) {
    return condition ? value : null;
  },
  sum: (model, context, ...args) => args.reduce((sum, v) => sum += v, 0),
  multiply: (model, context, multiplier, multiplicand) => multiplier * multiplicand,
  populate: async (model, context, assoc, options) => {
    let parts = assoc.split('.');

    if (!(parts.length > 1)) {
      throw new Error("Assertion failed: parts.length > 1");
    }

    let selectedField = parts.pop();
    let remoteAssoc = parts.join('.');
    let localAssoc = parts.shift();
    let interAssoc;

    if (parts.length > 0) {
      interAssoc = parts.join('.');
    }

    if (!context.latest.hasOwnProperty(localAssoc)) {
      return undefined;
    }

    let assocValue = context.latest[localAssoc];

    if (_.isNil(assocValue)) {
      throw new ApplicationError(`The value of referenced association "${localAssoc}" of entity "${model.meta.name}" should not be null.`);
    }

    let assocMeta = model.meta.associations[localAssoc];

    if (!assocMeta) {
      throw new ApplicationError(`"${localAssoc}" is not an association field of entity "${model.meta.name}".`);
    }

    if (assocMeta.list) {
      throw new ApplicationError(`"${localAssoc}" entity "${model.meta.name}" is a list-style association which is not supported by the built-in populate Activators.`);
    }

    let remoteEntity = context.populated && context.populated[remoteAssoc];

    if (!remoteEntity) {
      if (options && options.useCache) {
        remoteEntity = (await model.db.model(assocMeta.entity).cached_(assocMeta.key, interAssoc ? [interAssoc] : null, context.connOptions))[assocValue];
      } else {
        let findOptions = {
          $query: {
            [assocMeta.key]: assocValue
          }
        };

        if (interAssoc) {
          findOptions.$associations = [interAssoc];
        }

        await model.ensureTransaction_(context);
        remoteEntity = await model.db.model(assocMeta.entity).findOne_(findOptions, context.connOptions);
      }

      if (!remoteEntity) {
        throw new RequestError(`Unable to find the "${assocMeta.entity}" with [${assocMeta.key}=${assocValue}].`);
      }

      context.populated || (context.populated = {});
      context.populated[localAssoc] = remoteEntity;
      let currentAssoc = localAssoc;

      while (parts.length > 0) {
        let nextAssoc = parts.shift();
        remoteEntity = remoteEntity[':' + nextAssoc];

        if (!!Array.isArray(remoteEntity)) {
          throw new Error("Assertion failed: !Array.isArray(remoteEntity)");
        }

        currentAssoc = currentAssoc + '.' + nextAssoc;
        context.populated[currentAssoc] = remoteEntity;
      }
    }

    if (!remoteEntity.hasOwnProperty(selectedField)) {
      throw new ApplicationError(`"${selectedField}" is not a field of remote association "${remoteAssoc}" of entity "${model.meta.name}".`);
    }

    return remoteEntity[selectedField];
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9BY3RpdmF0b3JzLmpzIl0sIm5hbWVzIjpbIl8iLCJyZXF1aXJlIiwiQXBwbGljYXRpb25FcnJvciIsIlJlcXVlc3RFcnJvciIsIm1vZHVsZSIsImV4cG9ydHMiLCJkYXRldGltZUFkZCIsIm1vZGVsIiwiY29udGV4dCIsInN0YXJ0VGltZSIsImR1cmF0aW9uIiwicGx1cyIsImlzRXF1YWwiLCJ2YWx1ZTEiLCJ2YWx1ZTIiLCJ0cmlnZ2VyVXBkYXRlIiwidmFsdWUiLCJjb25kaXRpb24iLCJzdW0iLCJhcmdzIiwicmVkdWNlIiwidiIsIm11bHRpcGx5IiwibXVsdGlwbGllciIsIm11bHRpcGxpY2FuZCIsInBvcHVsYXRlIiwiYXNzb2MiLCJvcHRpb25zIiwicGFydHMiLCJzcGxpdCIsImxlbmd0aCIsInNlbGVjdGVkRmllbGQiLCJwb3AiLCJyZW1vdGVBc3NvYyIsImpvaW4iLCJsb2NhbEFzc29jIiwic2hpZnQiLCJpbnRlckFzc29jIiwibGF0ZXN0IiwiaGFzT3duUHJvcGVydHkiLCJ1bmRlZmluZWQiLCJhc3NvY1ZhbHVlIiwiaXNOaWwiLCJtZXRhIiwibmFtZSIsImFzc29jTWV0YSIsImFzc29jaWF0aW9ucyIsImxpc3QiLCJyZW1vdGVFbnRpdHkiLCJwb3B1bGF0ZWQiLCJ1c2VDYWNoZSIsImRiIiwiZW50aXR5IiwiY2FjaGVkXyIsImtleSIsImNvbm5PcHRpb25zIiwiZmluZE9wdGlvbnMiLCIkcXVlcnkiLCIkYXNzb2NpYXRpb25zIiwiZW5zdXJlVHJhbnNhY3Rpb25fIiwiZmluZE9uZV8iLCJjdXJyZW50QXNzb2MiLCJuZXh0QXNzb2MiLCJBcnJheSIsImlzQXJyYXkiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTTtBQUFFQSxFQUFBQTtBQUFGLElBQVFDLE9BQU8sQ0FBQyxVQUFELENBQXJCOztBQUNBLE1BQU07QUFBRUMsRUFBQUEsZ0JBQUY7QUFBb0JDLEVBQUFBO0FBQXBCLElBQXFDRixPQUFPLENBQUMsZ0JBQUQsQ0FB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QSxPQUFPLENBQUN5QyxTQUFSLENBQWtCZCxVQUFsQixJQUFnQ2EsWUFBaEM7QUFFQSxVQUFJYSxZQUFZLEdBQUcxQixVQUFuQjs7QUFDQSxhQUFPUCxLQUFLLENBQUNFLE1BQU4sR0FBZSxDQUF0QixFQUF5QjtBQUNyQixZQUFJZ0MsU0FBUyxHQUFHbEMsS0FBSyxDQUFDUSxLQUFOLEVBQWhCO0FBQ0FZLFFBQUFBLFlBQVksR0FBR0EsWUFBWSxDQUFDLE1BQUljLFNBQUwsQ0FBM0I7O0FBRnFCLGFBR2IsQ0FBQ0MsS0FBSyxDQUFDQyxPQUFOLENBQWNoQixZQUFkLENBSFk7QUFBQTtBQUFBOztBQUtyQmEsUUFBQUEsWUFBWSxHQUFHQSxZQUFZLEdBQUMsR0FBYixHQUFpQkMsU0FBaEM7QUFDQXRELFFBQUFBLE9BQU8sQ0FBQ3lDLFNBQVIsQ0FBa0JZLFlBQWxCLElBQWtDYixZQUFsQztBQUNIO0FBQ0o7O0FBRUQsUUFBSSxDQUFDQSxZQUFZLENBQUNULGNBQWIsQ0FBNEJSLGFBQTVCLENBQUwsRUFBaUQ7QUFDN0MsWUFBTSxJQUFJN0IsZ0JBQUosQ0FBc0IsSUFBRzZCLGFBQWMsMkNBQTBDRSxXQUFZLGdCQUFlMUIsS0FBSyxDQUFDb0MsSUFBTixDQUFXQyxJQUFLLElBQTVILENBQU47QUFDSDs7QUFFRCxXQUFPSSxZQUFZLENBQUNqQixhQUFELENBQW5CO0FBQ0g7QUF4RlksQ0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgeyBfIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyBBcHBsaWNhdGlvbkVycm9yLCBSZXF1ZXN0RXJyb3IgfSA9IHJlcXVpcmUoJy4vdXRpbHMvRXJyb3JzJyk7XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICAgIGRhdGV0aW1lQWRkOiBmdW5jdGlvbiAobW9kZWwsIGNvbnRleHQsIHN0YXJ0VGltZSwgZHVyYXRpb24pIHtcbiAgICAgICAgcmV0dXJuIHN0YXJ0VGltZS5wbHVzKGR1cmF0aW9uKTtcbiAgICB9LFxuXG4gICAgaXNFcXVhbDogZnVuY3Rpb24gKG1vZGVsLCBjb250ZXh0LCB2YWx1ZTEsIHZhbHVlMikge1xuICAgICAgICByZXR1cm4gdmFsdWUxID09PSB2YWx1ZTI7XG4gICAgfSxcblxuICAgIHRyaWdnZXJVcGRhdGU6IGZ1bmN0aW9uIChtb2RlbCwgY29udGV4dCwgdmFsdWUsIGNvbmRpdGlvbikge1xuICAgICAgICByZXR1cm4gY29uZGl0aW9uID8gdmFsdWUgOiBudWxsO1xuICAgIH0sXG5cbiAgICBzdW06IChtb2RlbCwgY29udGV4dCwgLi4uYXJncykgPT4gYXJncy5yZWR1Y2UoKHN1bSwgdikgPT4gc3VtICs9IHYsIDApLFxuXG4gICAgbXVsdGlwbHk6IChtb2RlbCwgY29udGV4dCwgbXVsdGlwbGllciwgbXVsdGlwbGljYW5kKSA9PiBtdWx0aXBsaWVyKm11bHRpcGxpY2FuZCxcblxuICAgIHBvcHVsYXRlOiBhc3luYyAobW9kZWwsIGNvbnRleHQsIGFzc29jLCBvcHRpb25zKSA9PiB7XG4gICAgICAgIGxldCBwYXJ0cyA9IGFzc29jLnNwbGl0KCcuJyk7XG4gICAgICAgIGFzc2VydDogcGFydHMubGVuZ3RoID4gMTtcblxuICAgICAgICBsZXQgc2VsZWN0ZWRGaWVsZCA9IHBhcnRzLnBvcCgpO1xuICAgICAgICBsZXQgcmVtb3RlQXNzb2MgPSBwYXJ0cy5qb2luKCcuJyk7XG4gICAgICAgIGxldCBsb2NhbEFzc29jID0gcGFydHMuc2hpZnQoKTtcbiAgICAgICAgbGV0IGludGVyQXNzb2M7XG4gICAgICAgIFxuICAgICAgICBpZiAocGFydHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgaW50ZXJBc3NvYyA9IHBhcnRzLmpvaW4oJy4nKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgaWYgKCFjb250ZXh0LmxhdGVzdC5oYXNPd25Qcm9wZXJ0eShsb2NhbEFzc29jKSkge1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBhc3NvY1ZhbHVlID0gY29udGV4dC5sYXRlc3RbbG9jYWxBc3NvY107XG4gICAgICAgIGlmIChfLmlzTmlsKGFzc29jVmFsdWUpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQXBwbGljYXRpb25FcnJvcihgVGhlIHZhbHVlIG9mIHJlZmVyZW5jZWQgYXNzb2NpYXRpb24gXCIke2xvY2FsQXNzb2N9XCIgb2YgZW50aXR5IFwiJHttb2RlbC5tZXRhLm5hbWV9XCIgc2hvdWxkIG5vdCBiZSBudWxsLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGFzc29jTWV0YSA9IG1vZGVsLm1ldGEuYXNzb2NpYXRpb25zW2xvY2FsQXNzb2NdO1xuICAgICAgICBpZiAoIWFzc29jTWV0YSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEFwcGxpY2F0aW9uRXJyb3IoYFwiJHtsb2NhbEFzc29jfVwiIGlzIG5vdCBhbiBhc3NvY2lhdGlvbiBmaWVsZCBvZiBlbnRpdHkgXCIke21vZGVsLm1ldGEubmFtZX1cIi5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChhc3NvY01ldGEubGlzdCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEFwcGxpY2F0aW9uRXJyb3IoYFwiJHtsb2NhbEFzc29jfVwiIGVudGl0eSBcIiR7bW9kZWwubWV0YS5uYW1lfVwiIGlzIGEgbGlzdC1zdHlsZSBhc3NvY2lhdGlvbiB3aGljaCBpcyBub3Qgc3VwcG9ydGVkIGJ5IHRoZSBidWlsdC1pbiBwb3B1bGF0ZSBBY3RpdmF0b3JzLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgLy9sb2NhbCBjYWNoZSBpbiBjb250ZXh0LCBzaGFyZWQgYnkgb3RoZXIgZmllbGRzIGlmIGFueSBcbiAgICAgICAgbGV0IHJlbW90ZUVudGl0eSA9IGNvbnRleHQucG9wdWxhdGVkICYmIGNvbnRleHQucG9wdWxhdGVkW3JlbW90ZUFzc29jXTtcbiAgICAgICAgaWYgKCFyZW1vdGVFbnRpdHkpIHtcbiAgICAgICAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMudXNlQ2FjaGUpIHtcbiAgICAgICAgICAgICAgICByZW1vdGVFbnRpdHkgPSAoYXdhaXQgbW9kZWwuZGIubW9kZWwoYXNzb2NNZXRhLmVudGl0eSkuY2FjaGVkXyhhc3NvY01ldGEua2V5LCBpbnRlckFzc29jID8gWyBpbnRlckFzc29jIF0gOiBudWxsLCBjb250ZXh0LmNvbm5PcHRpb25zKSlbYXNzb2NWYWx1ZV07ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBsZXQgZmluZE9wdGlvbnMgPSB7ICRxdWVyeTogeyBbYXNzb2NNZXRhLmtleV06IGFzc29jVmFsdWUgfSB9O1xuXG4gICAgICAgICAgICAgICAgaWYgKGludGVyQXNzb2MpIHtcbiAgICAgICAgICAgICAgICAgICAgZmluZE9wdGlvbnMuJGFzc29jaWF0aW9ucyA9IFsgaW50ZXJBc3NvYyBdO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGF3YWl0IG1vZGVsLmVuc3VyZVRyYW5zYWN0aW9uXyhjb250ZXh0KTtcblxuICAgICAgICAgICAgICAgIHJlbW90ZUVudGl0eSA9IGF3YWl0IG1vZGVsLmRiLm1vZGVsKGFzc29jTWV0YS5lbnRpdHkpLmZpbmRPbmVfKGZpbmRPcHRpb25zLCBjb250ZXh0LmNvbm5PcHRpb25zKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFyZW1vdGVFbnRpdHkpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgUmVxdWVzdEVycm9yKGBVbmFibGUgdG8gZmluZCB0aGUgXCIke2Fzc29jTWV0YS5lbnRpdHl9XCIgd2l0aCBbJHthc3NvY01ldGEua2V5fT0ke2Fzc29jVmFsdWV9XS5gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29udGV4dC5wb3B1bGF0ZWQgfHwgKGNvbnRleHQucG9wdWxhdGVkID0ge30pO1xuICAgICAgICAgICAgY29udGV4dC5wb3B1bGF0ZWRbbG9jYWxBc3NvY10gPSByZW1vdGVFbnRpdHk7XG5cbiAgICAgICAgICAgIGxldCBjdXJyZW50QXNzb2MgPSBsb2NhbEFzc29jO1xuICAgICAgICAgICAgd2hpbGUgKHBhcnRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBsZXQgbmV4dEFzc29jID0gcGFydHMuc2hpZnQoKTtcbiAgICAgICAgICAgICAgICByZW1vdGVFbnRpdHkgPSByZW1vdGVFbnRpdHlbJzonK25leHRBc3NvY107XG4gICAgICAgICAgICAgICAgYXNzZXJ0OiAhQXJyYXkuaXNBcnJheShyZW1vdGVFbnRpdHkpO1xuXG4gICAgICAgICAgICAgICAgY3VycmVudEFzc29jID0gY3VycmVudEFzc29jKycuJytuZXh0QXNzb2M7XG4gICAgICAgICAgICAgICAgY29udGV4dC5wb3B1bGF0ZWRbY3VycmVudEFzc29jXSA9IHJlbW90ZUVudGl0eTsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXJlbW90ZUVudGl0eS5oYXNPd25Qcm9wZXJ0eShzZWxlY3RlZEZpZWxkKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEFwcGxpY2F0aW9uRXJyb3IoYFwiJHtzZWxlY3RlZEZpZWxkfVwiIGlzIG5vdCBhIGZpZWxkIG9mIHJlbW90ZSBhc3NvY2lhdGlvbiBcIiR7cmVtb3RlQXNzb2N9XCIgb2YgZW50aXR5IFwiJHttb2RlbC5tZXRhLm5hbWV9XCIuYCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVtb3RlRW50aXR5W3NlbGVjdGVkRmllbGRdO1xuICAgIH1cbn07Il19