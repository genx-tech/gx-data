"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const {
  ApplicationError,
  InvalidArgument
} = require('./utils/Errors');

const Generators = require('./Generators');

module.exports = {
  datetimeAdd: function (model, context, startTime, duration) {
    return startTime.plus(duration);
  },
  isEqual: function (model, context, value1, value2) {
    return value1 === value2;
  },
  triggerUpdate: function (model, context, value, condition) {
    return condition ? value : null;
  },
  defaultAs: function (model, context, value) {
    return value;
  },
  generator: function (model, context, name, ...infoI18nOpts) {
    return Generators[name](...infoI18nOpts);
  },
  concat: (model, context, sep = '', ...strs) => strs.join(sep),
  sum: (model, context, ...args) => args.reduce((sum, v) => sum += v, 0),
  multiply: (model, context, multiplier, multiplicand) => multiplier * multiplicand,
  populate: async (model, context, assoc, options) => {
    let parts = assoc.split('.');

    if (!(parts.length > 1)) {
      throw new Error("Assertion failed: parts.length > 1");
    }

    let selectedField = parts.pop();
    let remoteAssoc = parts.join('.');
    let localAssoc = parts.shift();
    let interAssoc;

    if (parts.length > 0) {
      interAssoc = parts.join('.');
    }

    if (!context.latest.hasOwnProperty(localAssoc)) {
      return undefined;
    }

    let assocValue = context.latest[localAssoc];

    if (_.isNil(assocValue)) {
      throw new ApplicationError(`The value of referenced association "${localAssoc}" of entity "${model.meta.name}" should not be null.`);
    }

    let assocMeta = model.meta.associations[localAssoc];

    if (!assocMeta) {
      throw new ApplicationError(`"${localAssoc}" is not an association field of entity "${model.meta.name}".`);
    }

    if (assocMeta.list) {
      throw new ApplicationError(`"${localAssoc}" entity "${model.meta.name}" is a list-style association which is not supported by the built-in populate Activators.`);
    }

    let remoteEntity = context.populated && context.populated[remoteAssoc];

    if (!remoteEntity) {
      if (options && options.useCache) {
        remoteEntity = (await model.db.model(assocMeta.entity).cached_(assocMeta.key, interAssoc ? [interAssoc] : null, context.connOptions))[assocValue];
      } else {
        let findOptions = {
          $query: {
            [assocMeta.key]: assocValue
          }
        };

        if (interAssoc) {
          findOptions.$associations = [interAssoc];
        }

        await model.ensureTransaction_(context);
        remoteEntity = await model.db.model(assocMeta.entity).findOne_(findOptions, context.connOptions);
      }

      if (!remoteEntity) {
        throw new ApplicationError(`Unable to find the "${assocMeta.entity}" with [${assocMeta.key}=${assocValue}]. Entity: ${model.meta.name}`);
      }

      context.populated || (context.populated = {});
      context.populated[localAssoc] = remoteEntity;
      let currentAssoc = localAssoc;

      while (parts.length > 0) {
        let nextAssoc = parts.shift();
        remoteEntity = remoteEntity[':' + nextAssoc];

        if (!!Array.isArray(remoteEntity)) {
          throw new Error("Assertion failed: !Array.isArray(remoteEntity)");
        }

        currentAssoc = currentAssoc + '.' + nextAssoc;
        context.populated[currentAssoc] = remoteEntity;
      }
    }

    if (!remoteEntity.hasOwnProperty(selectedField)) {
      throw new ApplicationError(`"${selectedField}" is not a field of remote association "${remoteAssoc}" of entity "${model.meta.name}".`);
    }

    return remoteEntity[selectedField];
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9BY3RpdmF0b3JzLmpzIl0sIm5hbWVzIjpbIl8iLCJyZXF1aXJlIiwiQXBwbGljYXRpb25FcnJvciIsIkludmFsaWRBcmd1bWVudCIsIkdlbmVyYXRvcnMiLCJtb2R1bGUiLCJleHBvcnRzIiwiZGF0ZXRpbWVBZGQiLCJtb2RlbCIsImNvbnRleHQiLCJzdGFydFRpbWUiLCJkdXJhdGlvbiIsInBsdXMiLCJpc0VxdWFsIiwidmFsdWUxIiwidmFsdWUyIiwidHJpZ2dlclVwZGF0ZSIsInZhbHVlIiwiY29uZGl0aW9uIiwiZGVmYXVsdEFzIiwiZ2VuZXJhdG9yIiwibmFtZSIsImluZm9JMThuT3B0cyIsImNvbmNhdCIsInNlcCIsInN0cnMiLCJqb2luIiwic3VtIiwiYXJncyIsInJlZHVjZSIsInYiLCJtdWx0aXBseSIsIm11bHRpcGxpZXIiLCJtdWx0aXBsaWNhbmQiLCJwb3B1bGF0ZSIsImFzc29jIiwib3B0aW9ucyIsInBhcnRzIiwic3BsaXQiLCJsZW5ndGgiLCJzZWxlY3RlZEZpZWxkIiwicG9wIiwicmVtb3RlQXNzb2MiLCJsb2NhbEFzc29jIiwic2hpZnQiLCJpbnRlckFzc29jIiwibGF0ZXN0IiwiaGFzT3duUHJvcGVydHkiLCJ1bmRlZmluZWQiLCJhc3NvY1ZhbHVlIiwiaXNOaWwiLCJtZXRhIiwiYXNzb2NNZXRhIiwiYXNzb2NpYXRpb25zIiwibGlzdCIsInJlbW90ZUVudGl0eSIsInBvcHVsYXRlZCIsInVzZUNhY2hlIiwiZGIiLCJlbnRpdHkiLCJjYWNoZWRfIiwia2V5IiwiY29ubk9wdGlvbnMiLCJmaW5kT3B0aW9ucyIsIiRxdWVyeSIsIiRhc3NvY2lhdGlvbnMiLCJlbnN1cmVUcmFuc2FjdGlvbl8iLCJmaW5kT25lXyIsImN1cnJlbnRBc3NvYyIsIm5leHRBc3NvYyIsIkFycmF5IiwiaXNBcnJheSJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNO0FBQUVBLEVBQUFBO0FBQUYsSUFBUUMsT0FBTyxDQUFDLFVBQUQsQ0FBckI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQSxnQkFBRjtBQUFvQkMsRUFBQUE7QUFBcEIsSUFBd0NGLE9BQU8sQ0FBQyxnQkFBRCxDQUFyRDs7QUFDQSxNQUFNRyxVQUFVLEdBQUdILE9BQU8sQ0FBQyxjQUFELENBQTFCOztBQUVBSSxNQUFNLENBQUNDLE9BQVAsR0FBaUI7QUFDYkMsRUFBQUEsV0FBVyxFQUFFLFVBQVVDLEtBQVYsRUFBaUJDLE9BQWpCLEVBQTBCQyxTQUExQixFQUFxQ0MsUUFBckMsRUFBK0M7QUFDeEQsV0FBT0QsU0FBUyxDQUFDRSxJQUFWLENBQWVELFFBQWYsQ0FBUDtBQUNILEdBSFk7QUFLYkUsRUFBQUEsT0FBTyxFQUFFLFVBQVVMLEtBQVYsRUFBaUJDLE9BQWpCLEVBQTBCSyxNQUExQixFQUFrQ0MsTUFBbEMsRUFBMEM7QUFDL0MsV0FBT0QsTUFBTSxLQUFLQyxNQUFsQjtBQUNILEdBUFk7QUFTYkMsRUFBQUEsYUFBYSxFQUFFLFVBQVVSLEtBQVYsRUFBaUJDLE9BQWpCLEVBQTBCUSxLQUExQixFQUFpQ0MsU0FBakMsRUFBNEM7QUFDdkQsV0FBT0EsU0FBUyxHQUFHRCxLQUFILEdBQVcsSUFBM0I7QUFDSCxHQVhZO0FBYWJFLEVBQUFBLFNBQVMsRUFBRSxVQUFVWCxLQUFWLEVBQWlCQyxPQUFqQixFQUEwQlEsS0FBMUIsRUFBaUM7QUFDeEMsV0FBT0EsS0FBUDtBQUNILEdBZlk7QUFpQmJHLEVBQUFBLFNBQVMsRUFBRSxVQUFVWixLQUFWLEVBQWlCQyxPQUFqQixFQUEwQlksSUFBMUIsRUFBZ0MsR0FBR0MsWUFBbkMsRUFBaUQ7QUFDeEQsV0FBT2xCLFVBQVUsQ0FBQ2lCLElBQUQsQ0FBVixDQUFpQixHQUFHQyxZQUFwQixDQUFQO0FBQ0gsR0FuQlk7QUFxQmJDLEVBQUFBLE1BQU0sRUFBRSxDQUFDZixLQUFELEVBQVFDLE9BQVIsRUFBaUJlLEdBQUcsR0FBRyxFQUF2QixFQUEyQixHQUFHQyxJQUE5QixLQUF1Q0EsSUFBSSxDQUFDQyxJQUFMLENBQVVGLEdBQVYsQ0FyQmxDO0FBdUJiRyxFQUFBQSxHQUFHLEVBQUUsQ0FBQ25CLEtBQUQsRUFBUUMsT0FBUixFQUFpQixHQUFHbUIsSUFBcEIsS0FBNkJBLElBQUksQ0FBQ0MsTUFBTCxDQUFZLENBQUNGLEdBQUQsRUFBTUcsQ0FBTixLQUFZSCxHQUFHLElBQUlHLENBQS9CLEVBQWtDLENBQWxDLENBdkJyQjtBQXlCYkMsRUFBQUEsUUFBUSxFQUFFLENBQUN2QixLQUFELEVBQVFDLE9BQVIsRUFBaUJ1QixVQUFqQixFQUE2QkMsWUFBN0IsS0FBOENELFVBQVUsR0FBQ0MsWUF6QnREO0FBMkJiQyxFQUFBQSxRQUFRLEVBQUUsT0FBTzFCLEtBQVAsRUFBY0MsT0FBZCxFQUF1QjBCLEtBQXZCLEVBQThCQyxPQUE5QixLQUEwQztBQUNoRCxRQUFJQyxLQUFLLEdBQUdGLEtBQUssQ0FBQ0csS0FBTixDQUFZLEdBQVosQ0FBWjs7QUFEZ0QsVUFFeENELEtBQUssQ0FBQ0UsTUFBTixHQUFlLENBRnlCO0FBQUE7QUFBQTs7QUFJaEQsUUFBSUMsYUFBYSxHQUFHSCxLQUFLLENBQUNJLEdBQU4sRUFBcEI7QUFDQSxRQUFJQyxXQUFXLEdBQUdMLEtBQUssQ0FBQ1gsSUFBTixDQUFXLEdBQVgsQ0FBbEI7QUFDQSxRQUFJaUIsVUFBVSxHQUFHTixLQUFLLENBQUNPLEtBQU4sRUFBakI7QUFDQSxRQUFJQyxVQUFKOztBQUVBLFFBQUlSLEtBQUssQ0FBQ0UsTUFBTixHQUFlLENBQW5CLEVBQXNCO0FBQ2xCTSxNQUFBQSxVQUFVLEdBQUdSLEtBQUssQ0FBQ1gsSUFBTixDQUFXLEdBQVgsQ0FBYjtBQUNIOztBQUVELFFBQUksQ0FBQ2pCLE9BQU8sQ0FBQ3FDLE1BQVIsQ0FBZUMsY0FBZixDQUE4QkosVUFBOUIsQ0FBTCxFQUFnRDtBQUM1QyxhQUFPSyxTQUFQO0FBQ0g7O0FBRUQsUUFBSUMsVUFBVSxHQUFHeEMsT0FBTyxDQUFDcUMsTUFBUixDQUFlSCxVQUFmLENBQWpCOztBQUNBLFFBQUkzQyxDQUFDLENBQUNrRCxLQUFGLENBQVFELFVBQVIsQ0FBSixFQUF5QjtBQUNyQixZQUFNLElBQUkvQyxnQkFBSixDQUFzQix3Q0FBdUN5QyxVQUFXLGdCQUFlbkMsS0FBSyxDQUFDMkMsSUFBTixDQUFXOUIsSUFBSyx1QkFBdkcsQ0FBTjtBQUNIOztBQUVELFFBQUkrQixTQUFTLEdBQUc1QyxLQUFLLENBQUMyQyxJQUFOLENBQVdFLFlBQVgsQ0FBd0JWLFVBQXhCLENBQWhCOztBQUNBLFFBQUksQ0FBQ1MsU0FBTCxFQUFnQjtBQUNaLFlBQU0sSUFBSWxELGdCQUFKLENBQXNCLElBQUd5QyxVQUFXLDRDQUEyQ25DLEtBQUssQ0FBQzJDLElBQU4sQ0FBVzlCLElBQUssSUFBL0YsQ0FBTjtBQUNIOztBQUVELFFBQUkrQixTQUFTLENBQUNFLElBQWQsRUFBb0I7QUFDaEIsWUFBTSxJQUFJcEQsZ0JBQUosQ0FBc0IsSUFBR3lDLFVBQVcsYUFBWW5DLEtBQUssQ0FBQzJDLElBQU4sQ0FBVzlCLElBQUssMkZBQWhFLENBQU47QUFDSDs7QUFHRCxRQUFJa0MsWUFBWSxHQUFHOUMsT0FBTyxDQUFDK0MsU0FBUixJQUFxQi9DLE9BQU8sQ0FBQytDLFNBQVIsQ0FBa0JkLFdBQWxCLENBQXhDOztBQUNBLFFBQUksQ0FBQ2EsWUFBTCxFQUFtQjtBQUNmLFVBQUluQixPQUFPLElBQUlBLE9BQU8sQ0FBQ3FCLFFBQXZCLEVBQWlDO0FBQzdCRixRQUFBQSxZQUFZLEdBQUcsQ0FBQyxNQUFNL0MsS0FBSyxDQUFDa0QsRUFBTixDQUFTbEQsS0FBVCxDQUFlNEMsU0FBUyxDQUFDTyxNQUF6QixFQUFpQ0MsT0FBakMsQ0FBeUNSLFNBQVMsQ0FBQ1MsR0FBbkQsRUFBd0RoQixVQUFVLEdBQUcsQ0FBRUEsVUFBRixDQUFILEdBQW9CLElBQXRGLEVBQTRGcEMsT0FBTyxDQUFDcUQsV0FBcEcsQ0FBUCxFQUF5SGIsVUFBekgsQ0FBZjtBQUNILE9BRkQsTUFFTztBQUNILFlBQUljLFdBQVcsR0FBRztBQUFFQyxVQUFBQSxNQUFNLEVBQUU7QUFBRSxhQUFDWixTQUFTLENBQUNTLEdBQVgsR0FBaUJaO0FBQW5CO0FBQVYsU0FBbEI7O0FBRUEsWUFBSUosVUFBSixFQUFnQjtBQUNaa0IsVUFBQUEsV0FBVyxDQUFDRSxhQUFaLEdBQTRCLENBQUVwQixVQUFGLENBQTVCO0FBQ0g7O0FBRUQsY0FBTXJDLEtBQUssQ0FBQzBELGtCQUFOLENBQXlCekQsT0FBekIsQ0FBTjtBQUVBOEMsUUFBQUEsWUFBWSxHQUFHLE1BQU0vQyxLQUFLLENBQUNrRCxFQUFOLENBQVNsRCxLQUFULENBQWU0QyxTQUFTLENBQUNPLE1BQXpCLEVBQWlDUSxRQUFqQyxDQUEwQ0osV0FBMUMsRUFBdUR0RCxPQUFPLENBQUNxRCxXQUEvRCxDQUFyQjtBQUNIOztBQUVELFVBQUksQ0FBQ1AsWUFBTCxFQUFtQjtBQUNmLGNBQU0sSUFBSXJELGdCQUFKLENBQXNCLHVCQUFzQmtELFNBQVMsQ0FBQ08sTUFBTyxXQUFVUCxTQUFTLENBQUNTLEdBQUksSUFBR1osVUFBVyxjQUFhekMsS0FBSyxDQUFDMkMsSUFBTixDQUFXOUIsSUFBSyxFQUFoSSxDQUFOO0FBQ0g7O0FBRURaLE1BQUFBLE9BQU8sQ0FBQytDLFNBQVIsS0FBc0IvQyxPQUFPLENBQUMrQyxTQUFSLEdBQW9CLEVBQTFDO0FBQ0EvQyxNQUFBQSxPQUFPLENBQUMrQyxTQUFSLENBQWtCYixVQUFsQixJQUFnQ1ksWUFBaEM7QUFFQSxVQUFJYSxZQUFZLEdBQUd6QixVQUFuQjs7QUFDQSxhQUFPTixLQUFLLENBQUNFLE1BQU4sR0FBZSxDQUF0QixFQUF5QjtBQUNyQixZQUFJOEIsU0FBUyxHQUFHaEMsS0FBSyxDQUFDTyxLQUFOLEVBQWhCO0FBQ0FXLFFBQUFBLFlBQVksR0FBR0EsWUFBWSxDQUFDLE1BQUljLFNBQUwsQ0FBM0I7O0FBRnFCLGFBR2IsQ0FBQ0MsS0FBSyxDQUFDQyxPQUFOLENBQWNoQixZQUFkLENBSFk7QUFBQTtBQUFBOztBQUtyQmEsUUFBQUEsWUFBWSxHQUFHQSxZQUFZLEdBQUMsR0FBYixHQUFpQkMsU0FBaEM7QUFDQTVELFFBQUFBLE9BQU8sQ0FBQytDLFNBQVIsQ0FBa0JZLFlBQWxCLElBQWtDYixZQUFsQztBQUNIO0FBQ0o7O0FBRUQsUUFBSSxDQUFDQSxZQUFZLENBQUNSLGNBQWIsQ0FBNEJQLGFBQTVCLENBQUwsRUFBaUQ7QUFDN0MsWUFBTSxJQUFJdEMsZ0JBQUosQ0FBc0IsSUFBR3NDLGFBQWMsMkNBQTBDRSxXQUFZLGdCQUFlbEMsS0FBSyxDQUFDMkMsSUFBTixDQUFXOUIsSUFBSyxJQUE1SCxDQUFOO0FBQ0g7O0FBRUQsV0FBT2tDLFlBQVksQ0FBQ2YsYUFBRCxDQUFuQjtBQUNIO0FBbEdZLENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IHsgXyB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgQXBwbGljYXRpb25FcnJvciwgSW52YWxpZEFyZ3VtZW50IH0gPSByZXF1aXJlKCcuL3V0aWxzL0Vycm9ycycpO1xuY29uc3QgR2VuZXJhdG9ycyA9IHJlcXVpcmUoJy4vR2VuZXJhdG9ycycpO1xuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgICBkYXRldGltZUFkZDogZnVuY3Rpb24gKG1vZGVsLCBjb250ZXh0LCBzdGFydFRpbWUsIGR1cmF0aW9uKSB7XG4gICAgICAgIHJldHVybiBzdGFydFRpbWUucGx1cyhkdXJhdGlvbik7XG4gICAgfSxcblxuICAgIGlzRXF1YWw6IGZ1bmN0aW9uIChtb2RlbCwgY29udGV4dCwgdmFsdWUxLCB2YWx1ZTIpIHtcbiAgICAgICAgcmV0dXJuIHZhbHVlMSA9PT0gdmFsdWUyO1xuICAgIH0sXG5cbiAgICB0cmlnZ2VyVXBkYXRlOiBmdW5jdGlvbiAobW9kZWwsIGNvbnRleHQsIHZhbHVlLCBjb25kaXRpb24pIHtcbiAgICAgICAgcmV0dXJuIGNvbmRpdGlvbiA/IHZhbHVlIDogbnVsbDtcbiAgICB9LFxuXG4gICAgZGVmYXVsdEFzOiBmdW5jdGlvbiAobW9kZWwsIGNvbnRleHQsIHZhbHVlKSB7XG4gICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9LFxuXG4gICAgZ2VuZXJhdG9yOiBmdW5jdGlvbiAobW9kZWwsIGNvbnRleHQsIG5hbWUsIC4uLmluZm9JMThuT3B0cykge1xuICAgICAgICByZXR1cm4gR2VuZXJhdG9yc1tuYW1lXSguLi5pbmZvSTE4bk9wdHMpO1xuICAgIH0sXG5cbiAgICBjb25jYXQ6IChtb2RlbCwgY29udGV4dCwgc2VwID0gJycsIC4uLnN0cnMpID0+IHN0cnMuam9pbihzZXApLFxuXG4gICAgc3VtOiAobW9kZWwsIGNvbnRleHQsIC4uLmFyZ3MpID0+IGFyZ3MucmVkdWNlKChzdW0sIHYpID0+IHN1bSArPSB2LCAwKSxcblxuICAgIG11bHRpcGx5OiAobW9kZWwsIGNvbnRleHQsIG11bHRpcGxpZXIsIG11bHRpcGxpY2FuZCkgPT4gbXVsdGlwbGllciptdWx0aXBsaWNhbmQsXG5cbiAgICBwb3B1bGF0ZTogYXN5bmMgKG1vZGVsLCBjb250ZXh0LCBhc3NvYywgb3B0aW9ucykgPT4ge1xuICAgICAgICBsZXQgcGFydHMgPSBhc3NvYy5zcGxpdCgnLicpO1xuICAgICAgICBhc3NlcnQ6IHBhcnRzLmxlbmd0aCA+IDE7XG5cbiAgICAgICAgbGV0IHNlbGVjdGVkRmllbGQgPSBwYXJ0cy5wb3AoKTtcbiAgICAgICAgbGV0IHJlbW90ZUFzc29jID0gcGFydHMuam9pbignLicpO1xuICAgICAgICBsZXQgbG9jYWxBc3NvYyA9IHBhcnRzLnNoaWZ0KCk7XG4gICAgICAgIGxldCBpbnRlckFzc29jO1xuICAgICAgICBcbiAgICAgICAgaWYgKHBhcnRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGludGVyQXNzb2MgPSBwYXJ0cy5qb2luKCcuJyk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGlmICghY29udGV4dC5sYXRlc3QuaGFzT3duUHJvcGVydHkobG9jYWxBc3NvYykpIHtcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgYXNzb2NWYWx1ZSA9IGNvbnRleHQubGF0ZXN0W2xvY2FsQXNzb2NdO1xuICAgICAgICBpZiAoXy5pc05pbChhc3NvY1ZhbHVlKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEFwcGxpY2F0aW9uRXJyb3IoYFRoZSB2YWx1ZSBvZiByZWZlcmVuY2VkIGFzc29jaWF0aW9uIFwiJHtsb2NhbEFzc29jfVwiIG9mIGVudGl0eSBcIiR7bW9kZWwubWV0YS5uYW1lfVwiIHNob3VsZCBub3QgYmUgbnVsbC5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBhc3NvY01ldGEgPSBtb2RlbC5tZXRhLmFzc29jaWF0aW9uc1tsb2NhbEFzc29jXTtcbiAgICAgICAgaWYgKCFhc3NvY01ldGEpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBBcHBsaWNhdGlvbkVycm9yKGBcIiR7bG9jYWxBc3NvY31cIiBpcyBub3QgYW4gYXNzb2NpYXRpb24gZmllbGQgb2YgZW50aXR5IFwiJHttb2RlbC5tZXRhLm5hbWV9XCIuYCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYXNzb2NNZXRhLmxpc3QpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBBcHBsaWNhdGlvbkVycm9yKGBcIiR7bG9jYWxBc3NvY31cIiBlbnRpdHkgXCIke21vZGVsLm1ldGEubmFtZX1cIiBpcyBhIGxpc3Qtc3R5bGUgYXNzb2NpYXRpb24gd2hpY2ggaXMgbm90IHN1cHBvcnRlZCBieSB0aGUgYnVpbHQtaW4gcG9wdWxhdGUgQWN0aXZhdG9ycy5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vbG9jYWwgY2FjaGUgaW4gY29udGV4dCwgc2hhcmVkIGJ5IG90aGVyIGZpZWxkcyBpZiBhbnkgXG4gICAgICAgIGxldCByZW1vdGVFbnRpdHkgPSBjb250ZXh0LnBvcHVsYXRlZCAmJiBjb250ZXh0LnBvcHVsYXRlZFtyZW1vdGVBc3NvY107XG4gICAgICAgIGlmICghcmVtb3RlRW50aXR5KSB7XG4gICAgICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnVzZUNhY2hlKSB7XG4gICAgICAgICAgICAgICAgcmVtb3RlRW50aXR5ID0gKGF3YWl0IG1vZGVsLmRiLm1vZGVsKGFzc29jTWV0YS5lbnRpdHkpLmNhY2hlZF8oYXNzb2NNZXRhLmtleSwgaW50ZXJBc3NvYyA/IFsgaW50ZXJBc3NvYyBdIDogbnVsbCwgY29udGV4dC5jb25uT3B0aW9ucykpW2Fzc29jVmFsdWVdOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgbGV0IGZpbmRPcHRpb25zID0geyAkcXVlcnk6IHsgW2Fzc29jTWV0YS5rZXldOiBhc3NvY1ZhbHVlIH0gfTtcblxuICAgICAgICAgICAgICAgIGlmIChpbnRlckFzc29jKSB7XG4gICAgICAgICAgICAgICAgICAgIGZpbmRPcHRpb25zLiRhc3NvY2lhdGlvbnMgPSBbIGludGVyQXNzb2MgXTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBhd2FpdCBtb2RlbC5lbnN1cmVUcmFuc2FjdGlvbl8oY29udGV4dCk7XG5cbiAgICAgICAgICAgICAgICByZW1vdGVFbnRpdHkgPSBhd2FpdCBtb2RlbC5kYi5tb2RlbChhc3NvY01ldGEuZW50aXR5KS5maW5kT25lXyhmaW5kT3B0aW9ucywgY29udGV4dC5jb25uT3B0aW9ucyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghcmVtb3RlRW50aXR5KSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEFwcGxpY2F0aW9uRXJyb3IoYFVuYWJsZSB0byBmaW5kIHRoZSBcIiR7YXNzb2NNZXRhLmVudGl0eX1cIiB3aXRoIFske2Fzc29jTWV0YS5rZXl9PSR7YXNzb2NWYWx1ZX1dLiBFbnRpdHk6ICR7bW9kZWwubWV0YS5uYW1lfWApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb250ZXh0LnBvcHVsYXRlZCB8fCAoY29udGV4dC5wb3B1bGF0ZWQgPSB7fSk7XG4gICAgICAgICAgICBjb250ZXh0LnBvcHVsYXRlZFtsb2NhbEFzc29jXSA9IHJlbW90ZUVudGl0eTtcblxuICAgICAgICAgICAgbGV0IGN1cnJlbnRBc3NvYyA9IGxvY2FsQXNzb2M7XG4gICAgICAgICAgICB3aGlsZSAocGFydHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIGxldCBuZXh0QXNzb2MgPSBwYXJ0cy5zaGlmdCgpO1xuICAgICAgICAgICAgICAgIHJlbW90ZUVudGl0eSA9IHJlbW90ZUVudGl0eVsnOicrbmV4dEFzc29jXTtcbiAgICAgICAgICAgICAgICBhc3NlcnQ6ICFBcnJheS5pc0FycmF5KHJlbW90ZUVudGl0eSk7XG5cbiAgICAgICAgICAgICAgICBjdXJyZW50QXNzb2MgPSBjdXJyZW50QXNzb2MrJy4nK25leHRBc3NvYztcbiAgICAgICAgICAgICAgICBjb250ZXh0LnBvcHVsYXRlZFtjdXJyZW50QXNzb2NdID0gcmVtb3RlRW50aXR5OyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghcmVtb3RlRW50aXR5Lmhhc093blByb3BlcnR5KHNlbGVjdGVkRmllbGQpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQXBwbGljYXRpb25FcnJvcihgXCIke3NlbGVjdGVkRmllbGR9XCIgaXMgbm90IGEgZmllbGQgb2YgcmVtb3RlIGFzc29jaWF0aW9uIFwiJHtyZW1vdGVBc3NvY31cIiBvZiBlbnRpdHkgXCIke21vZGVsLm1ldGEubmFtZX1cIi5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZW1vdGVFbnRpdHlbc2VsZWN0ZWRGaWVsZF07XG4gICAgfVxufTsiXX0=