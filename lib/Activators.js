"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const {
  ApplicationError,
  InvalidArgument
} = require('./utils/Errors');

module.exports = {
  datetimeAdd: function (model, context, startTime, duration) {
    return startTime.plus(duration);
  },
  isEqual: function (model, context, value1, value2) {
    return value1 === value2;
  },
  triggerUpdate: function (model, context, value, condition) {
    return condition ? value : null;
  },
  defaultAs: function (model, context, value) {
    return value;
  },
  concat: (model, context, sep = '', ...strs) => strs.join(sep),
  sum: (model, context, ...args) => args.reduce((sum, v) => sum += v, 0),
  multiply: (model, context, multiplier, multiplicand) => multiplier * multiplicand,
  populate: async (model, context, assoc, options) => {
    let parts = assoc.split('.');

    if (!(parts.length > 1)) {
      throw new Error("Assertion failed: parts.length > 1");
    }

    let selectedField = parts.pop();
    let remoteAssoc = parts.join('.');
    let localAssoc = parts.shift();
    let interAssoc;

    if (parts.length > 0) {
      interAssoc = parts.join('.');
    }

    if (!context.latest.hasOwnProperty(localAssoc)) {
      return undefined;
    }

    let assocValue = context.latest[localAssoc];

    if (_.isNil(assocValue)) {
      throw new ApplicationError(`The value of referenced association "${localAssoc}" of entity "${model.meta.name}" should not be null.`);
    }

    let assocMeta = model.meta.associations[localAssoc];

    if (!assocMeta) {
      throw new ApplicationError(`"${localAssoc}" is not an association field of entity "${model.meta.name}".`);
    }

    if (assocMeta.list) {
      throw new ApplicationError(`"${localAssoc}" entity "${model.meta.name}" is a list-style association which is not supported by the built-in populate Activators.`);
    }

    let remoteEntity = context.populated && context.populated[remoteAssoc];

    if (!remoteEntity) {
      if (options && options.useCache) {
        remoteEntity = (await model.db.model(assocMeta.entity).cached_(assocMeta.key, interAssoc ? [interAssoc] : null, context.connOptions))[assocValue];
      } else {
        let findOptions = {
          $query: {
            [assocMeta.key]: assocValue
          }
        };

        if (interAssoc) {
          findOptions.$associations = [interAssoc];
        }

        await model.ensureTransaction_(context);
        remoteEntity = await model.db.model(assocMeta.entity).findOne_(findOptions, context.connOptions);
      }

      if (!remoteEntity) {
        throw new ApplicationError(`Unable to find the "${assocMeta.entity}" with [${assocMeta.key}=${assocValue}]. Entity: ${model.meta.name}`);
      }

      context.populated || (context.populated = {});
      context.populated[localAssoc] = remoteEntity;
      let currentAssoc = localAssoc;

      while (parts.length > 0) {
        let nextAssoc = parts.shift();
        remoteEntity = remoteEntity[':' + nextAssoc];

        if (!!Array.isArray(remoteEntity)) {
          throw new Error("Assertion failed: !Array.isArray(remoteEntity)");
        }

        currentAssoc = currentAssoc + '.' + nextAssoc;
        context.populated[currentAssoc] = remoteEntity;
      }
    }

    if (!remoteEntity.hasOwnProperty(selectedField)) {
      throw new ApplicationError(`"${selectedField}" is not a field of remote association "${remoteAssoc}" of entity "${model.meta.name}".`);
    }

    return remoteEntity[selectedField];
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9BY3RpdmF0b3JzLmpzIl0sIm5hbWVzIjpbIl8iLCJyZXF1aXJlIiwiQXBwbGljYXRpb25FcnJvciIsIkludmFsaWRBcmd1bWVudCIsIm1vZHVsZSIsImV4cG9ydHMiLCJkYXRldGltZUFkZCIsIm1vZGVsIiwiY29udGV4dCIsInN0YXJ0VGltZSIsImR1cmF0aW9uIiwicGx1cyIsImlzRXF1YWwiLCJ2YWx1ZTEiLCJ2YWx1ZTIiLCJ0cmlnZ2VyVXBkYXRlIiwidmFsdWUiLCJjb25kaXRpb24iLCJkZWZhdWx0QXMiLCJjb25jYXQiLCJzZXAiLCJzdHJzIiwiam9pbiIsInN1bSIsImFyZ3MiLCJyZWR1Y2UiLCJ2IiwibXVsdGlwbHkiLCJtdWx0aXBsaWVyIiwibXVsdGlwbGljYW5kIiwicG9wdWxhdGUiLCJhc3NvYyIsIm9wdGlvbnMiLCJwYXJ0cyIsInNwbGl0IiwibGVuZ3RoIiwic2VsZWN0ZWRGaWVsZCIsInBvcCIsInJlbW90ZUFzc29jIiwibG9jYWxBc3NvYyIsInNoaWZ0IiwiaW50ZXJBc3NvYyIsImxhdGVzdCIsImhhc093blByb3BlcnR5IiwidW5kZWZpbmVkIiwiYXNzb2NWYWx1ZSIsImlzTmlsIiwibWV0YSIsIm5hbWUiLCJhc3NvY01ldGEiLCJhc3NvY2lhdGlvbnMiLCJsaXN0IiwicmVtb3RlRW50aXR5IiwicG9wdWxhdGVkIiwidXNlQ2FjaGUiLCJkYiIsImVudGl0eSIsImNhY2hlZF8iLCJrZXkiLCJjb25uT3B0aW9ucyIsImZpbmRPcHRpb25zIiwiJHF1ZXJ5IiwiJGFzc29jaWF0aW9ucyIsImVuc3VyZVRyYW5zYWN0aW9uXyIsImZpbmRPbmVfIiwiY3VycmVudEFzc29jIiwibmV4dEFzc29jIiwiQXJyYXkiLCJpc0FycmF5Il0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU07QUFBRUEsRUFBQUE7QUFBRixJQUFRQyxPQUFPLENBQUMsVUFBRCxDQUFyQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBLGdCQUFGO0FBQW9CQyxFQUFBQTtBQUFwQixJQUF3Q0YsT0FBTyxDQUFDLGdCQUFELENBQXJEOztBQUVBRyxNQUFNLENBQUNDLE9BQVAsR0FBaUI7QUFDYkMsRUFBQUEsV0FBVyxFQUFFLFVBQVVDLEtBQVYsRUFBaUJDLE9BQWpCLEVBQTBCQyxTQUExQixFQUFxQ0MsUUFBckMsRUFBK0M7QUFDeEQsV0FBT0QsU0FBUyxDQUFDRSxJQUFWLENBQWVELFFBQWYsQ0FBUDtBQUNILEdBSFk7QUFLYkUsRUFBQUEsT0FBTyxFQUFFLFVBQVVMLEtBQVYsRUFBaUJDLE9BQWpCLEVBQTBCSyxNQUExQixFQUFrQ0MsTUFBbEMsRUFBMEM7QUFDL0MsV0FBT0QsTUFBTSxLQUFLQyxNQUFsQjtBQUNILEdBUFk7QUFTYkMsRUFBQUEsYUFBYSxFQUFFLFVBQVVSLEtBQVYsRUFBaUJDLE9BQWpCLEVBQTBCUSxLQUExQixFQUFpQ0MsU0FBakMsRUFBNEM7QUFDdkQsV0FBT0EsU0FBUyxHQUFHRCxLQUFILEdBQVcsSUFBM0I7QUFDSCxHQVhZO0FBYWJFLEVBQUFBLFNBQVMsRUFBRSxVQUFVWCxLQUFWLEVBQWlCQyxPQUFqQixFQUEwQlEsS0FBMUIsRUFBaUM7QUFDeEMsV0FBT0EsS0FBUDtBQUNILEdBZlk7QUFpQmJHLEVBQUFBLE1BQU0sRUFBRSxDQUFDWixLQUFELEVBQVFDLE9BQVIsRUFBaUJZLEdBQUcsR0FBRyxFQUF2QixFQUEyQixHQUFHQyxJQUE5QixLQUF1Q0EsSUFBSSxDQUFDQyxJQUFMLENBQVVGLEdBQVYsQ0FqQmxDO0FBbUJiRyxFQUFBQSxHQUFHLEVBQUUsQ0FBQ2hCLEtBQUQsRUFBUUMsT0FBUixFQUFpQixHQUFHZ0IsSUFBcEIsS0FBNkJBLElBQUksQ0FBQ0MsTUFBTCxDQUFZLENBQUNGLEdBQUQsRUFBTUcsQ0FBTixLQUFZSCxHQUFHLElBQUlHLENBQS9CLEVBQWtDLENBQWxDLENBbkJyQjtBQXFCYkMsRUFBQUEsUUFBUSxFQUFFLENBQUNwQixLQUFELEVBQVFDLE9BQVIsRUFBaUJvQixVQUFqQixFQUE2QkMsWUFBN0IsS0FBOENELFVBQVUsR0FBQ0MsWUFyQnREO0FBdUJiQyxFQUFBQSxRQUFRLEVBQUUsT0FBT3ZCLEtBQVAsRUFBY0MsT0FBZCxFQUF1QnVCLEtBQXZCLEVBQThCQyxPQUE5QixLQUEwQztBQUNoRCxRQUFJQyxLQUFLLEdBQUdGLEtBQUssQ0FBQ0csS0FBTixDQUFZLEdBQVosQ0FBWjs7QUFEZ0QsVUFFeENELEtBQUssQ0FBQ0UsTUFBTixHQUFlLENBRnlCO0FBQUE7QUFBQTs7QUFJaEQsUUFBSUMsYUFBYSxHQUFHSCxLQUFLLENBQUNJLEdBQU4sRUFBcEI7QUFDQSxRQUFJQyxXQUFXLEdBQUdMLEtBQUssQ0FBQ1gsSUFBTixDQUFXLEdBQVgsQ0FBbEI7QUFDQSxRQUFJaUIsVUFBVSxHQUFHTixLQUFLLENBQUNPLEtBQU4sRUFBakI7QUFDQSxRQUFJQyxVQUFKOztBQUVBLFFBQUlSLEtBQUssQ0FBQ0UsTUFBTixHQUFlLENBQW5CLEVBQXNCO0FBQ2xCTSxNQUFBQSxVQUFVLEdBQUdSLEtBQUssQ0FBQ1gsSUFBTixDQUFXLEdBQVgsQ0FBYjtBQUNIOztBQUVELFFBQUksQ0FBQ2QsT0FBTyxDQUFDa0MsTUFBUixDQUFlQyxjQUFmLENBQThCSixVQUE5QixDQUFMLEVBQWdEO0FBQzVDLGFBQU9LLFNBQVA7QUFDSDs7QUFFRCxRQUFJQyxVQUFVLEdBQUdyQyxPQUFPLENBQUNrQyxNQUFSLENBQWVILFVBQWYsQ0FBakI7O0FBQ0EsUUFBSXZDLENBQUMsQ0FBQzhDLEtBQUYsQ0FBUUQsVUFBUixDQUFKLEVBQXlCO0FBQ3JCLFlBQU0sSUFBSTNDLGdCQUFKLENBQXNCLHdDQUF1Q3FDLFVBQVcsZ0JBQWVoQyxLQUFLLENBQUN3QyxJQUFOLENBQVdDLElBQUssdUJBQXZHLENBQU47QUFDSDs7QUFFRCxRQUFJQyxTQUFTLEdBQUcxQyxLQUFLLENBQUN3QyxJQUFOLENBQVdHLFlBQVgsQ0FBd0JYLFVBQXhCLENBQWhCOztBQUNBLFFBQUksQ0FBQ1UsU0FBTCxFQUFnQjtBQUNaLFlBQU0sSUFBSS9DLGdCQUFKLENBQXNCLElBQUdxQyxVQUFXLDRDQUEyQ2hDLEtBQUssQ0FBQ3dDLElBQU4sQ0FBV0MsSUFBSyxJQUEvRixDQUFOO0FBQ0g7O0FBRUQsUUFBSUMsU0FBUyxDQUFDRSxJQUFkLEVBQW9CO0FBQ2hCLFlBQU0sSUFBSWpELGdCQUFKLENBQXNCLElBQUdxQyxVQUFXLGFBQVloQyxLQUFLLENBQUN3QyxJQUFOLENBQVdDLElBQUssMkZBQWhFLENBQU47QUFDSDs7QUFHRCxRQUFJSSxZQUFZLEdBQUc1QyxPQUFPLENBQUM2QyxTQUFSLElBQXFCN0MsT0FBTyxDQUFDNkMsU0FBUixDQUFrQmYsV0FBbEIsQ0FBeEM7O0FBQ0EsUUFBSSxDQUFDYyxZQUFMLEVBQW1CO0FBQ2YsVUFBSXBCLE9BQU8sSUFBSUEsT0FBTyxDQUFDc0IsUUFBdkIsRUFBaUM7QUFDN0JGLFFBQUFBLFlBQVksR0FBRyxDQUFDLE1BQU03QyxLQUFLLENBQUNnRCxFQUFOLENBQVNoRCxLQUFULENBQWUwQyxTQUFTLENBQUNPLE1BQXpCLEVBQWlDQyxPQUFqQyxDQUF5Q1IsU0FBUyxDQUFDUyxHQUFuRCxFQUF3RGpCLFVBQVUsR0FBRyxDQUFFQSxVQUFGLENBQUgsR0FBb0IsSUFBdEYsRUFBNEZqQyxPQUFPLENBQUNtRCxXQUFwRyxDQUFQLEVBQXlIZCxVQUF6SCxDQUFmO0FBQ0gsT0FGRCxNQUVPO0FBQ0gsWUFBSWUsV0FBVyxHQUFHO0FBQUVDLFVBQUFBLE1BQU0sRUFBRTtBQUFFLGFBQUNaLFNBQVMsQ0FBQ1MsR0FBWCxHQUFpQmI7QUFBbkI7QUFBVixTQUFsQjs7QUFFQSxZQUFJSixVQUFKLEVBQWdCO0FBQ1ptQixVQUFBQSxXQUFXLENBQUNFLGFBQVosR0FBNEIsQ0FBRXJCLFVBQUYsQ0FBNUI7QUFDSDs7QUFFRCxjQUFNbEMsS0FBSyxDQUFDd0Qsa0JBQU4sQ0FBeUJ2RCxPQUF6QixDQUFOO0FBRUE0QyxRQUFBQSxZQUFZLEdBQUcsTUFBTTdDLEtBQUssQ0FBQ2dELEVBQU4sQ0FBU2hELEtBQVQsQ0FBZTBDLFNBQVMsQ0FBQ08sTUFBekIsRUFBaUNRLFFBQWpDLENBQTBDSixXQUExQyxFQUF1RHBELE9BQU8sQ0FBQ21ELFdBQS9ELENBQXJCO0FBQ0g7O0FBRUQsVUFBSSxDQUFDUCxZQUFMLEVBQW1CO0FBQ2YsY0FBTSxJQUFJbEQsZ0JBQUosQ0FBc0IsdUJBQXNCK0MsU0FBUyxDQUFDTyxNQUFPLFdBQVVQLFNBQVMsQ0FBQ1MsR0FBSSxJQUFHYixVQUFXLGNBQWF0QyxLQUFLLENBQUN3QyxJQUFOLENBQVdDLElBQUssRUFBaEksQ0FBTjtBQUNIOztBQUVEeEMsTUFBQUEsT0FBTyxDQUFDNkMsU0FBUixLQUFzQjdDLE9BQU8sQ0FBQzZDLFNBQVIsR0FBb0IsRUFBMUM7QUFDQTdDLE1BQUFBLE9BQU8sQ0FBQzZDLFNBQVIsQ0FBa0JkLFVBQWxCLElBQWdDYSxZQUFoQztBQUVBLFVBQUlhLFlBQVksR0FBRzFCLFVBQW5COztBQUNBLGFBQU9OLEtBQUssQ0FBQ0UsTUFBTixHQUFlLENBQXRCLEVBQXlCO0FBQ3JCLFlBQUkrQixTQUFTLEdBQUdqQyxLQUFLLENBQUNPLEtBQU4sRUFBaEI7QUFDQVksUUFBQUEsWUFBWSxHQUFHQSxZQUFZLENBQUMsTUFBSWMsU0FBTCxDQUEzQjs7QUFGcUIsYUFHYixDQUFDQyxLQUFLLENBQUNDLE9BQU4sQ0FBY2hCLFlBQWQsQ0FIWTtBQUFBO0FBQUE7O0FBS3JCYSxRQUFBQSxZQUFZLEdBQUdBLFlBQVksR0FBQyxHQUFiLEdBQWlCQyxTQUFoQztBQUNBMUQsUUFBQUEsT0FBTyxDQUFDNkMsU0FBUixDQUFrQlksWUFBbEIsSUFBa0NiLFlBQWxDO0FBQ0g7QUFDSjs7QUFFRCxRQUFJLENBQUNBLFlBQVksQ0FBQ1QsY0FBYixDQUE0QlAsYUFBNUIsQ0FBTCxFQUFpRDtBQUM3QyxZQUFNLElBQUlsQyxnQkFBSixDQUFzQixJQUFHa0MsYUFBYywyQ0FBMENFLFdBQVksZ0JBQWUvQixLQUFLLENBQUN3QyxJQUFOLENBQVdDLElBQUssSUFBNUgsQ0FBTjtBQUNIOztBQUVELFdBQU9JLFlBQVksQ0FBQ2hCLGFBQUQsQ0FBbkI7QUFDSDtBQTlGWSxDQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCB7IF8gfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IEFwcGxpY2F0aW9uRXJyb3IsIEludmFsaWRBcmd1bWVudCB9ID0gcmVxdWlyZSgnLi91dGlscy9FcnJvcnMnKTtcblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gICAgZGF0ZXRpbWVBZGQ6IGZ1bmN0aW9uIChtb2RlbCwgY29udGV4dCwgc3RhcnRUaW1lLCBkdXJhdGlvbikge1xuICAgICAgICByZXR1cm4gc3RhcnRUaW1lLnBsdXMoZHVyYXRpb24pO1xuICAgIH0sXG5cbiAgICBpc0VxdWFsOiBmdW5jdGlvbiAobW9kZWwsIGNvbnRleHQsIHZhbHVlMSwgdmFsdWUyKSB7XG4gICAgICAgIHJldHVybiB2YWx1ZTEgPT09IHZhbHVlMjtcbiAgICB9LFxuXG4gICAgdHJpZ2dlclVwZGF0ZTogZnVuY3Rpb24gKG1vZGVsLCBjb250ZXh0LCB2YWx1ZSwgY29uZGl0aW9uKSB7XG4gICAgICAgIHJldHVybiBjb25kaXRpb24gPyB2YWx1ZSA6IG51bGw7XG4gICAgfSxcblxuICAgIGRlZmF1bHRBczogZnVuY3Rpb24gKG1vZGVsLCBjb250ZXh0LCB2YWx1ZSkge1xuICAgICAgICByZXR1cm4gdmFsdWU7XG4gICAgfSxcblxuICAgIGNvbmNhdDogKG1vZGVsLCBjb250ZXh0LCBzZXAgPSAnJywgLi4uc3RycykgPT4gc3Rycy5qb2luKHNlcCksXG5cbiAgICBzdW06IChtb2RlbCwgY29udGV4dCwgLi4uYXJncykgPT4gYXJncy5yZWR1Y2UoKHN1bSwgdikgPT4gc3VtICs9IHYsIDApLFxuXG4gICAgbXVsdGlwbHk6IChtb2RlbCwgY29udGV4dCwgbXVsdGlwbGllciwgbXVsdGlwbGljYW5kKSA9PiBtdWx0aXBsaWVyKm11bHRpcGxpY2FuZCxcblxuICAgIHBvcHVsYXRlOiBhc3luYyAobW9kZWwsIGNvbnRleHQsIGFzc29jLCBvcHRpb25zKSA9PiB7XG4gICAgICAgIGxldCBwYXJ0cyA9IGFzc29jLnNwbGl0KCcuJyk7XG4gICAgICAgIGFzc2VydDogcGFydHMubGVuZ3RoID4gMTtcblxuICAgICAgICBsZXQgc2VsZWN0ZWRGaWVsZCA9IHBhcnRzLnBvcCgpO1xuICAgICAgICBsZXQgcmVtb3RlQXNzb2MgPSBwYXJ0cy5qb2luKCcuJyk7XG4gICAgICAgIGxldCBsb2NhbEFzc29jID0gcGFydHMuc2hpZnQoKTtcbiAgICAgICAgbGV0IGludGVyQXNzb2M7XG4gICAgICAgIFxuICAgICAgICBpZiAocGFydHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgaW50ZXJBc3NvYyA9IHBhcnRzLmpvaW4oJy4nKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgaWYgKCFjb250ZXh0LmxhdGVzdC5oYXNPd25Qcm9wZXJ0eShsb2NhbEFzc29jKSkge1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBhc3NvY1ZhbHVlID0gY29udGV4dC5sYXRlc3RbbG9jYWxBc3NvY107XG4gICAgICAgIGlmIChfLmlzTmlsKGFzc29jVmFsdWUpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQXBwbGljYXRpb25FcnJvcihgVGhlIHZhbHVlIG9mIHJlZmVyZW5jZWQgYXNzb2NpYXRpb24gXCIke2xvY2FsQXNzb2N9XCIgb2YgZW50aXR5IFwiJHttb2RlbC5tZXRhLm5hbWV9XCIgc2hvdWxkIG5vdCBiZSBudWxsLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGFzc29jTWV0YSA9IG1vZGVsLm1ldGEuYXNzb2NpYXRpb25zW2xvY2FsQXNzb2NdO1xuICAgICAgICBpZiAoIWFzc29jTWV0YSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEFwcGxpY2F0aW9uRXJyb3IoYFwiJHtsb2NhbEFzc29jfVwiIGlzIG5vdCBhbiBhc3NvY2lhdGlvbiBmaWVsZCBvZiBlbnRpdHkgXCIke21vZGVsLm1ldGEubmFtZX1cIi5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChhc3NvY01ldGEubGlzdCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEFwcGxpY2F0aW9uRXJyb3IoYFwiJHtsb2NhbEFzc29jfVwiIGVudGl0eSBcIiR7bW9kZWwubWV0YS5uYW1lfVwiIGlzIGEgbGlzdC1zdHlsZSBhc3NvY2lhdGlvbiB3aGljaCBpcyBub3Qgc3VwcG9ydGVkIGJ5IHRoZSBidWlsdC1pbiBwb3B1bGF0ZSBBY3RpdmF0b3JzLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgLy9sb2NhbCBjYWNoZSBpbiBjb250ZXh0LCBzaGFyZWQgYnkgb3RoZXIgZmllbGRzIGlmIGFueSBcbiAgICAgICAgbGV0IHJlbW90ZUVudGl0eSA9IGNvbnRleHQucG9wdWxhdGVkICYmIGNvbnRleHQucG9wdWxhdGVkW3JlbW90ZUFzc29jXTtcbiAgICAgICAgaWYgKCFyZW1vdGVFbnRpdHkpIHtcbiAgICAgICAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMudXNlQ2FjaGUpIHtcbiAgICAgICAgICAgICAgICByZW1vdGVFbnRpdHkgPSAoYXdhaXQgbW9kZWwuZGIubW9kZWwoYXNzb2NNZXRhLmVudGl0eSkuY2FjaGVkXyhhc3NvY01ldGEua2V5LCBpbnRlckFzc29jID8gWyBpbnRlckFzc29jIF0gOiBudWxsLCBjb250ZXh0LmNvbm5PcHRpb25zKSlbYXNzb2NWYWx1ZV07ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBsZXQgZmluZE9wdGlvbnMgPSB7ICRxdWVyeTogeyBbYXNzb2NNZXRhLmtleV06IGFzc29jVmFsdWUgfSB9O1xuXG4gICAgICAgICAgICAgICAgaWYgKGludGVyQXNzb2MpIHtcbiAgICAgICAgICAgICAgICAgICAgZmluZE9wdGlvbnMuJGFzc29jaWF0aW9ucyA9IFsgaW50ZXJBc3NvYyBdO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGF3YWl0IG1vZGVsLmVuc3VyZVRyYW5zYWN0aW9uXyhjb250ZXh0KTtcblxuICAgICAgICAgICAgICAgIHJlbW90ZUVudGl0eSA9IGF3YWl0IG1vZGVsLmRiLm1vZGVsKGFzc29jTWV0YS5lbnRpdHkpLmZpbmRPbmVfKGZpbmRPcHRpb25zLCBjb250ZXh0LmNvbm5PcHRpb25zKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFyZW1vdGVFbnRpdHkpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQXBwbGljYXRpb25FcnJvcihgVW5hYmxlIHRvIGZpbmQgdGhlIFwiJHthc3NvY01ldGEuZW50aXR5fVwiIHdpdGggWyR7YXNzb2NNZXRhLmtleX09JHthc3NvY1ZhbHVlfV0uIEVudGl0eTogJHttb2RlbC5tZXRhLm5hbWV9YCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnRleHQucG9wdWxhdGVkIHx8IChjb250ZXh0LnBvcHVsYXRlZCA9IHt9KTtcbiAgICAgICAgICAgIGNvbnRleHQucG9wdWxhdGVkW2xvY2FsQXNzb2NdID0gcmVtb3RlRW50aXR5O1xuXG4gICAgICAgICAgICBsZXQgY3VycmVudEFzc29jID0gbG9jYWxBc3NvYztcbiAgICAgICAgICAgIHdoaWxlIChwYXJ0cy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgbGV0IG5leHRBc3NvYyA9IHBhcnRzLnNoaWZ0KCk7XG4gICAgICAgICAgICAgICAgcmVtb3RlRW50aXR5ID0gcmVtb3RlRW50aXR5Wyc6JytuZXh0QXNzb2NdO1xuICAgICAgICAgICAgICAgIGFzc2VydDogIUFycmF5LmlzQXJyYXkocmVtb3RlRW50aXR5KTtcblxuICAgICAgICAgICAgICAgIGN1cnJlbnRBc3NvYyA9IGN1cnJlbnRBc3NvYysnLicrbmV4dEFzc29jO1xuICAgICAgICAgICAgICAgIGNvbnRleHQucG9wdWxhdGVkW2N1cnJlbnRBc3NvY10gPSByZW1vdGVFbnRpdHk7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFyZW1vdGVFbnRpdHkuaGFzT3duUHJvcGVydHkoc2VsZWN0ZWRGaWVsZCkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBBcHBsaWNhdGlvbkVycm9yKGBcIiR7c2VsZWN0ZWRGaWVsZH1cIiBpcyBub3QgYSBmaWVsZCBvZiByZW1vdGUgYXNzb2NpYXRpb24gXCIke3JlbW90ZUFzc29jfVwiIG9mIGVudGl0eSBcIiR7bW9kZWwubWV0YS5uYW1lfVwiLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlbW90ZUVudGl0eVtzZWxlY3RlZEZpZWxkXTtcbiAgICB9XG59OyJdfQ==