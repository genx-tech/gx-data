"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const {
  ApplicationError,
  InvalidArgument
} = require('./utils/Errors');

module.exports = {
  datetimeAdd: function (model, context, startTime, duration) {
    return startTime.plus(duration);
  },
  isEqual: function (model, context, value1, value2) {
    return value1 === value2;
  },
  triggerUpdate: function (model, context, value, condition) {
    return condition ? value : null;
  },
  concat: (model, context, sep = '', ...strs) => strs.join(sep),
  sum: (model, context, ...args) => args.reduce((sum, v) => sum += v, 0),
  multiply: (model, context, multiplier, multiplicand) => multiplier * multiplicand,
  populate: async (model, context, assoc, options) => {
    let parts = assoc.split('.');

    if (!(parts.length > 1)) {
      throw new Error("Assertion failed: parts.length > 1");
    }

    let selectedField = parts.pop();
    let remoteAssoc = parts.join('.');
    let localAssoc = parts.shift();
    let interAssoc;

    if (parts.length > 0) {
      interAssoc = parts.join('.');
    }

    if (!context.latest.hasOwnProperty(localAssoc)) {
      return undefined;
    }

    let assocValue = context.latest[localAssoc];

    if (_.isNil(assocValue)) {
      throw new ApplicationError(`The value of referenced association "${localAssoc}" of entity "${model.meta.name}" should not be null.`);
    }

    let assocMeta = model.meta.associations[localAssoc];

    if (!assocMeta) {
      throw new ApplicationError(`"${localAssoc}" is not an association field of entity "${model.meta.name}".`);
    }

    if (assocMeta.list) {
      throw new ApplicationError(`"${localAssoc}" entity "${model.meta.name}" is a list-style association which is not supported by the built-in populate Activators.`);
    }

    let remoteEntity = context.populated && context.populated[remoteAssoc];

    if (!remoteEntity) {
      if (options && options.useCache) {
        remoteEntity = (await model.db.model(assocMeta.entity).cached_(assocMeta.key, interAssoc ? [interAssoc] : null, context.connOptions))[assocValue];
      } else {
        let findOptions = {
          $query: {
            [assocMeta.key]: assocValue
          }
        };

        if (interAssoc) {
          findOptions.$associations = [interAssoc];
        }

        await model.ensureTransaction_(context);
        remoteEntity = await model.db.model(assocMeta.entity).findOne_(findOptions, context.connOptions);
      }

      if (!remoteEntity) {
        throw new ApplicationError(`Unable to find the "${assocMeta.entity}" with [${assocMeta.key}=${assocValue}].`);
      }

      context.populated || (context.populated = {});
      context.populated[localAssoc] = remoteEntity;
      let currentAssoc = localAssoc;

      while (parts.length > 0) {
        let nextAssoc = parts.shift();
        remoteEntity = remoteEntity[':' + nextAssoc];

        if (!!Array.isArray(remoteEntity)) {
          throw new Error("Assertion failed: !Array.isArray(remoteEntity)");
        }

        currentAssoc = currentAssoc + '.' + nextAssoc;
        context.populated[currentAssoc] = remoteEntity;
      }
    }

    if (!remoteEntity.hasOwnProperty(selectedField)) {
      throw new ApplicationError(`"${selectedField}" is not a field of remote association "${remoteAssoc}" of entity "${model.meta.name}".`);
    }

    return remoteEntity[selectedField];
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9BY3RpdmF0b3JzLmpzIl0sIm5hbWVzIjpbIl8iLCJyZXF1aXJlIiwiQXBwbGljYXRpb25FcnJvciIsIkludmFsaWRBcmd1bWVudCIsIm1vZHVsZSIsImV4cG9ydHMiLCJkYXRldGltZUFkZCIsIm1vZGVsIiwiY29udGV4dCIsInN0YXJ0VGltZSIsImR1cmF0aW9uIiwicGx1cyIsImlzRXF1YWwiLCJ2YWx1ZTEiLCJ2YWx1ZTIiLCJ0cmlnZ2VyVXBkYXRlIiwidmFsdWUiLCJjb25kaXRpb24iLCJjb25jYXQiLCJzZXAiLCJzdHJzIiwiam9pbiIsInN1bSIsImFyZ3MiLCJyZWR1Y2UiLCJ2IiwibXVsdGlwbHkiLCJtdWx0aXBsaWVyIiwibXVsdGlwbGljYW5kIiwicG9wdWxhdGUiLCJhc3NvYyIsIm9wdGlvbnMiLCJwYXJ0cyIsInNwbGl0IiwibGVuZ3RoIiwic2VsZWN0ZWRGaWVsZCIsInBvcCIsInJlbW90ZUFzc29jIiwibG9jYWxBc3NvYyIsInNoaWZ0IiwiaW50ZXJBc3NvYyIsImxhdGVzdCIsImhhc093blByb3BlcnR5IiwidW5kZWZpbmVkIiwiYXNzb2NWYWx1ZSIsImlzTmlsIiwibWV0YSIsIm5hbWUiLCJhc3NvY01ldGEiLCJhc3NvY2lhdGlvbnMiLCJsaXN0IiwicmVtb3RlRW50aXR5IiwicG9wdWxhdGVkIiwidXNlQ2FjaGUiLCJkYiIsImVudGl0eSIsImNhY2hlZF8iLCJrZXkiLCJjb25uT3B0aW9ucyIsImZpbmRPcHRpb25zIiwiJHF1ZXJ5IiwiJGFzc29jaWF0aW9ucyIsImVuc3VyZVRyYW5zYWN0aW9uXyIsImZpbmRPbmVfIiwiY3VycmVudEFzc29jIiwibmV4dEFzc29jIiwiQXJyYXkiLCJpc0FycmF5Il0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU07QUFBRUEsRUFBQUE7QUFBRixJQUFRQyxPQUFPLENBQUMsVUFBRCxDQUFyQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBLGdCQUFGO0FBQW9CQyxFQUFBQTtBQUFwQixJ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LHVCQUFzQjhDLFNBQVMsQ0FBQ08sTUFBTyxXQUFVUCxTQUFTLENBQUNTLEdBQUksSUFBR2IsVUFBVyxJQUFuRyxDQUFOO0FBQ0g7O0FBRURwQyxNQUFBQSxPQUFPLENBQUM0QyxTQUFSLEtBQXNCNUMsT0FBTyxDQUFDNEMsU0FBUixHQUFvQixFQUExQztBQUNBNUMsTUFBQUEsT0FBTyxDQUFDNEMsU0FBUixDQUFrQmQsVUFBbEIsSUFBZ0NhLFlBQWhDO0FBRUEsVUFBSWEsWUFBWSxHQUFHMUIsVUFBbkI7O0FBQ0EsYUFBT04sS0FBSyxDQUFDRSxNQUFOLEdBQWUsQ0FBdEIsRUFBeUI7QUFDckIsWUFBSStCLFNBQVMsR0FBR2pDLEtBQUssQ0FBQ08sS0FBTixFQUFoQjtBQUNBWSxRQUFBQSxZQUFZLEdBQUdBLFlBQVksQ0FBQyxNQUFJYyxTQUFMLENBQTNCOztBQUZxQixhQUdiLENBQUNDLEtBQUssQ0FBQ0MsT0FBTixDQUFjaEIsWUFBZCxDQUhZO0FBQUE7QUFBQTs7QUFLckJhLFFBQUFBLFlBQVksR0FBR0EsWUFBWSxHQUFDLEdBQWIsR0FBaUJDLFNBQWhDO0FBQ0F6RCxRQUFBQSxPQUFPLENBQUM0QyxTQUFSLENBQWtCWSxZQUFsQixJQUFrQ2IsWUFBbEM7QUFDSDtBQUNKOztBQUVELFFBQUksQ0FBQ0EsWUFBWSxDQUFDVCxjQUFiLENBQTRCUCxhQUE1QixDQUFMLEVBQWlEO0FBQzdDLFlBQU0sSUFBSWpDLGdCQUFKLENBQXNCLElBQUdpQyxhQUFjLDJDQUEwQ0UsV0FBWSxnQkFBZTlCLEtBQUssQ0FBQ3VDLElBQU4sQ0FBV0MsSUFBSyxJQUE1SCxDQUFOO0FBQ0g7O0FBRUQsV0FBT0ksWUFBWSxDQUFDaEIsYUFBRCxDQUFuQjtBQUNIO0FBMUZZLENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IHsgXyB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgQXBwbGljYXRpb25FcnJvciwgSW52YWxpZEFyZ3VtZW50IH0gPSByZXF1aXJlKCcuL3V0aWxzL0Vycm9ycycpO1xuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgICBkYXRldGltZUFkZDogZnVuY3Rpb24gKG1vZGVsLCBjb250ZXh0LCBzdGFydFRpbWUsIGR1cmF0aW9uKSB7XG4gICAgICAgIHJldHVybiBzdGFydFRpbWUucGx1cyhkdXJhdGlvbik7XG4gICAgfSxcblxuICAgIGlzRXF1YWw6IGZ1bmN0aW9uIChtb2RlbCwgY29udGV4dCwgdmFsdWUxLCB2YWx1ZTIpIHtcbiAgICAgICAgcmV0dXJuIHZhbHVlMSA9PT0gdmFsdWUyO1xuICAgIH0sXG5cbiAgICB0cmlnZ2VyVXBkYXRlOiBmdW5jdGlvbiAobW9kZWwsIGNvbnRleHQsIHZhbHVlLCBjb25kaXRpb24pIHtcbiAgICAgICAgcmV0dXJuIGNvbmRpdGlvbiA/IHZhbHVlIDogbnVsbDtcbiAgICB9LFxuXG4gICAgY29uY2F0OiAobW9kZWwsIGNvbnRleHQsIHNlcCA9ICcnLCAuLi5zdHJzKSA9PiBzdHJzLmpvaW4oc2VwKSxcblxuICAgIHN1bTogKG1vZGVsLCBjb250ZXh0LCAuLi5hcmdzKSA9PiBhcmdzLnJlZHVjZSgoc3VtLCB2KSA9PiBzdW0gKz0gdiwgMCksXG5cbiAgICBtdWx0aXBseTogKG1vZGVsLCBjb250ZXh0LCBtdWx0aXBsaWVyLCBtdWx0aXBsaWNhbmQpID0+IG11bHRpcGxpZXIqbXVsdGlwbGljYW5kLFxuXG4gICAgcG9wdWxhdGU6IGFzeW5jIChtb2RlbCwgY29udGV4dCwgYXNzb2MsIG9wdGlvbnMpID0+IHtcbiAgICAgICAgbGV0IHBhcnRzID0gYXNzb2Muc3BsaXQoJy4nKTtcbiAgICAgICAgYXNzZXJ0OiBwYXJ0cy5sZW5ndGggPiAxO1xuXG4gICAgICAgIGxldCBzZWxlY3RlZEZpZWxkID0gcGFydHMucG9wKCk7XG4gICAgICAgIGxldCByZW1vdGVBc3NvYyA9IHBhcnRzLmpvaW4oJy4nKTtcbiAgICAgICAgbGV0IGxvY2FsQXNzb2MgPSBwYXJ0cy5zaGlmdCgpO1xuICAgICAgICBsZXQgaW50ZXJBc3NvYztcbiAgICAgICAgXG4gICAgICAgIGlmIChwYXJ0cy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBpbnRlckFzc29jID0gcGFydHMuam9pbignLicpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBpZiAoIWNvbnRleHQubGF0ZXN0Lmhhc093blByb3BlcnR5KGxvY2FsQXNzb2MpKSB7XG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGFzc29jVmFsdWUgPSBjb250ZXh0LmxhdGVzdFtsb2NhbEFzc29jXTtcbiAgICAgICAgaWYgKF8uaXNOaWwoYXNzb2NWYWx1ZSkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBBcHBsaWNhdGlvbkVycm9yKGBUaGUgdmFsdWUgb2YgcmVmZXJlbmNlZCBhc3NvY2lhdGlvbiBcIiR7bG9jYWxBc3NvY31cIiBvZiBlbnRpdHkgXCIke21vZGVsLm1ldGEubmFtZX1cIiBzaG91bGQgbm90IGJlIG51bGwuYCk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgYXNzb2NNZXRhID0gbW9kZWwubWV0YS5hc3NvY2lhdGlvbnNbbG9jYWxBc3NvY107XG4gICAgICAgIGlmICghYXNzb2NNZXRhKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQXBwbGljYXRpb25FcnJvcihgXCIke2xvY2FsQXNzb2N9XCIgaXMgbm90IGFuIGFzc29jaWF0aW9uIGZpZWxkIG9mIGVudGl0eSBcIiR7bW9kZWwubWV0YS5uYW1lfVwiLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGFzc29jTWV0YS5saXN0KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQXBwbGljYXRpb25FcnJvcihgXCIke2xvY2FsQXNzb2N9XCIgZW50aXR5IFwiJHttb2RlbC5tZXRhLm5hbWV9XCIgaXMgYSBsaXN0LXN0eWxlIGFzc29jaWF0aW9uIHdoaWNoIGlzIG5vdCBzdXBwb3J0ZWQgYnkgdGhlIGJ1aWx0LWluIHBvcHVsYXRlIEFjdGl2YXRvcnMuYCk7XG4gICAgICAgIH1cblxuICAgICAgICAvL2xvY2FsIGNhY2hlIGluIGNvbnRleHQsIHNoYXJlZCBieSBvdGhlciBmaWVsZHMgaWYgYW55IFxuICAgICAgICBsZXQgcmVtb3RlRW50aXR5ID0gY29udGV4dC5wb3B1bGF0ZWQgJiYgY29udGV4dC5wb3B1bGF0ZWRbcmVtb3RlQXNzb2NdO1xuICAgICAgICBpZiAoIXJlbW90ZUVudGl0eSkge1xuICAgICAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy51c2VDYWNoZSkge1xuICAgICAgICAgICAgICAgIHJlbW90ZUVudGl0eSA9IChhd2FpdCBtb2RlbC5kYi5tb2RlbChhc3NvY01ldGEuZW50aXR5KS5jYWNoZWRfKGFzc29jTWV0YS5rZXksIGludGVyQXNzb2MgPyBbIGludGVyQXNzb2MgXSA6IG51bGwsIGNvbnRleHQuY29ubk9wdGlvbnMpKVthc3NvY1ZhbHVlXTsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGxldCBmaW5kT3B0aW9ucyA9IHsgJHF1ZXJ5OiB7IFthc3NvY01ldGEua2V5XTogYXNzb2NWYWx1ZSB9IH07XG5cbiAgICAgICAgICAgICAgICBpZiAoaW50ZXJBc3NvYykge1xuICAgICAgICAgICAgICAgICAgICBmaW5kT3B0aW9ucy4kYXNzb2NpYXRpb25zID0gWyBpbnRlckFzc29jIF07XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgYXdhaXQgbW9kZWwuZW5zdXJlVHJhbnNhY3Rpb25fKGNvbnRleHQpO1xuXG4gICAgICAgICAgICAgICAgcmVtb3RlRW50aXR5ID0gYXdhaXQgbW9kZWwuZGIubW9kZWwoYXNzb2NNZXRhLmVudGl0eSkuZmluZE9uZV8oZmluZE9wdGlvbnMsIGNvbnRleHQuY29ubk9wdGlvbnMpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIXJlbW90ZUVudGl0eSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBBcHBsaWNhdGlvbkVycm9yKGBVbmFibGUgdG8gZmluZCB0aGUgXCIke2Fzc29jTWV0YS5lbnRpdHl9XCIgd2l0aCBbJHthc3NvY01ldGEua2V5fT0ke2Fzc29jVmFsdWV9XS5gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29udGV4dC5wb3B1bGF0ZWQgfHwgKGNvbnRleHQucG9wdWxhdGVkID0ge30pO1xuICAgICAgICAgICAgY29udGV4dC5wb3B1bGF0ZWRbbG9jYWxBc3NvY10gPSByZW1vdGVFbnRpdHk7XG5cbiAgICAgICAgICAgIGxldCBjdXJyZW50QXNzb2MgPSBsb2NhbEFzc29jO1xuICAgICAgICAgICAgd2hpbGUgKHBhcnRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBsZXQgbmV4dEFzc29jID0gcGFydHMuc2hpZnQoKTtcbiAgICAgICAgICAgICAgICByZW1vdGVFbnRpdHkgPSByZW1vdGVFbnRpdHlbJzonK25leHRBc3NvY107XG4gICAgICAgICAgICAgICAgYXNzZXJ0OiAhQXJyYXkuaXNBcnJheShyZW1vdGVFbnRpdHkpO1xuXG4gICAgICAgICAgICAgICAgY3VycmVudEFzc29jID0gY3VycmVudEFzc29jKycuJytuZXh0QXNzb2M7XG4gICAgICAgICAgICAgICAgY29udGV4dC5wb3B1bGF0ZWRbY3VycmVudEFzc29jXSA9IHJlbW90ZUVudGl0eTsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXJlbW90ZUVudGl0eS5oYXNPd25Qcm9wZXJ0eShzZWxlY3RlZEZpZWxkKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEFwcGxpY2F0aW9uRXJyb3IoYFwiJHtzZWxlY3RlZEZpZWxkfVwiIGlzIG5vdCBhIGZpZWxkIG9mIHJlbW90ZSBhc3NvY2lhdGlvbiBcIiR7cmVtb3RlQXNzb2N9XCIgb2YgZW50aXR5IFwiJHttb2RlbC5tZXRhLm5hbWV9XCIuYCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVtb3RlRW50aXR5W3NlbGVjdGVkRmllbGRdO1xuICAgIH1cbn07Il19