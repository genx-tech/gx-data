"use strict";

require("source-map-support/register");

const path = require('path');

const Util = require('rk-utils');

const {
  _,
  fs
} = Util;

const OolCodeGen = require('../../../lang/OolCodeGen');

const OolUtils = require('../../../lang/OolUtils');

class MySQLReverseEngineering {
  constructor(context, connector) {
    this.logger = context.logger;
    this.connector = connector;
    this.reverseRules = this.connector.options.reverseRules || {};
    this.saveDatabaseMeta = this.connector.options.saveDatabaseMeta || false;
  }

  async reverse_(outputDir) {
    this.logger.log('verbose', `Reverse engineering against ${this.connector.driver} database "${this.connector.database}" ...`);
    fs.ensureDirSync(outputDir);
    let tables = await this.connector.execute_("select * from information_schema.tables where table_schema = ?", [this.connector.database]);

    if (this.saveDatabaseMeta) {
      fs.writeFileSync(path.join(outputDir, this.connector.database + '.meta.json'), JSON.stringify(tables, null, 2));
    }

    let entities = [],
        mapOfEntities = {};
    let entitiesOolPath = path.join(outputDir, 'entities');
    fs.ensureDirSync(entitiesOolPath);
    await Util.eachAsync_(tables, async table => {
      let entityName = this._entityNaming(table.TABLE_NAME);

      entities.push({
        entity: entityName
      });
      mapOfEntities[entityName] = await this.extractTable_(entityName, table, entitiesOolPath);
    });

    this._refineEntityRelationships(mapOfEntities);

    _.forOwn(mapOfEntities, ({
      types,
      entityInfo
    }, entityName) => {
      let entity = {
        type: types,
        entity: {
          [entityName]: entityInfo
        }
      };
      let entityContent = OolCodeGen.transform(entity);
      let entityFile = path.join(entitiesOolPath, entityName + '.ool');
      fs.writeFileSync(entityFile + '.json', JSON.stringify(entity, null, 2));
      fs.writeFileSync(entityFile, entityContent);
      this.logger.log('info', `Extracted entity definition file "${entityFile}".`);
    });

    let schemaName = this._schemaNaming(this.connector.database);

    let json = {
      "namespace": ["entities/**"],
      "schema": {
        [schemaName]: {
          "entities": entities
        }
      }
    };
    let schemaContent = OolCodeGen.transform(json);
    let schemaFile = path.join(outputDir, schemaName + '.ool');
    fs.writeFileSync(schemaFile + '.json', JSON.stringify(json, null, 2));
    fs.writeFileSync(schemaFile, schemaContent);
    this.logger.log('info', `Extracted schema entry file "${schemaFile}".`);
  }

  async extractTable_(entityName, table, extractedOolPath) {
    let columns = await this.connector.execute_("select * from information_schema.columns where table_schema = ? and table_name = ?", [this.connector.database, table.TABLE_NAME]);

    if (this.saveDatabaseMeta) {
      fs.writeFileSync(path.join(extractedOolPath, table.TABLE_NAME + '.meta.json'), JSON.stringify(columns, null, 2));
    }

    let {
      features,
      fields,
      types
    } = this._processFields(table, columns);

    let indexInfo = await this.connector.execute_("SHOW INDEXES FROM ??", [table.TABLE_NAME]);

    if (this.saveDatabaseMeta && !_.isEmpty(indexInfo)) {
      fs.writeFileSync(path.join(extractedOolPath, table.TABLE_NAME + '.index.json'), JSON.stringify(indexInfo, null, 2));
    }

    let {
      pk,
      indexes,
      mapNameToIndex
    } = this._processIndexes(indexInfo);

    if (!(pk.length > 0)) {
      throw new Error("Assertion failed: pk.length > 0");
    }

    let referencesInfo = await this.connector.execute_("SELECT * FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE WHERE `REFERENCED_TABLE_SCHEMA` = ? AND `TABLE_NAME` = ? AND `REFERENCED_TABLE_NAME` IS NOT NULL", [this.connector.database, table.TABLE_NAME]);

    if (this.saveDatabaseMeta && !_.isEmpty(referencesInfo)) {
      fs.writeFileSync(path.join(extractedOolPath, table.TABLE_NAME + '.ref.json'), JSON.stringify(referencesInfo, null, 2));
    }

    let associations = await this._processReferences_(referencesInfo, mapNameToIndex, fields);
    let entityInfo = {
      comment: table.TABLE_COMMENT,
      features,
      fields,
      associations,
      key: pk.length > 1 ? pk : pk[0],
      indexes
    };

    if (entityName !== table.TABLE_NAME) {
      entityInfo.code = table.TABLE_NAME;
    }

    return {
      types,
      entityInfo
    };
  }

  async _processReferences_(referencesInfo, mapNameToIndex, fields) {
    let associations = [];
    let l = referencesInfo.length;

    for (let i = 0; i < l; i++) {
      let ref = referencesInfo[i];
      let [refTableKey] = await this.connector.execute_("SHOW INDEXES FROM ?? WHERE `Key_name` = 'PRIMARY'", [ref.REFERENCED_TABLE_NAME]);

      if (refTableKey.Column_name.toLowerCase() !== ref.REFERENCED_COLUMN_NAME.toLowerCase()) {
        throw new Error(`Foreign key "${ref.COLUMN_NAME}" not reference to the primary key.`);
      }

      let unique = false;
      let fkInfo = mapNameToIndex[ref.CONSTRAINT_NAME];

      if (fkInfo) {
        if (fkInfo.length > 1) {
          throw new Error(`Combination foreign key is not supported: "${ref.CONSTRAINT_NAME}"`);
        }

        unique = fkInfo[0].Non_unique === 0;
      }

      let fkColName = this._fieldNaming(ref.COLUMN_NAME);

      if (unique) {
        associations.push({
          type: 'belongsTo',
          srcField: fkColName,
          destEntity: this._entityNaming(ref.REFERENCED_TABLE_NAME)
        });
      } else {
        associations.push({
          type: 'hasMany',
          srcField: fkColName,
          destEntity: this._entityNaming(ref.REFERENCED_TABLE_NAME)
        });
      }

      delete fields[fkColName];
    }

    return associations;
  }

  _processIndexes(indexInfo) {
    let pk = [],
        indexes = [];
    let mapNameToIndex = {};
    indexInfo.forEach(i => {
      Util.putIntoBucket(mapNameToIndex, i.Key_name, i);
    });

    _.forOwn(mapNameToIndex, (fields, name) => {
      if (name === 'PRIMARY') {
        pk.push(fields.map(f => this._fieldNaming(f.Column_name)));
      } else {
        indexes.push({
          name: name,
          fields: fields.map(f => this._fieldNaming(f.Column_name)),
          unique: fields[0].Non_unique === 0,
          nullable: fields[0].Null === 'YES'
        });
      }
    });

    return {
      pk,
      indexes,
      mapNameToIndex
    };
  }

  _processFields(table, columns) {
    let features = [],
        fields = {},
        types = {};
    columns.forEach(col => {
      let fieldName = this._fieldNaming(col.COLUMN_NAME);

      if (col.EXTRA === 'auto_increment') {
        let featureInfo = {
          "name": "autoId",
          "options": table.AUTO_INCREMENT ? {
            "startFrom": table.AUTO_INCREMENT
          } : {}
        };

        if (fieldName !== 'id') {
          featureInfo.options.name = fieldName;
        }

        features.push(featureInfo);
        return;
      }

      if (col.COLUMN_DEFAULT === 'CURRENT_TIMESTAMP') {
        let featureInfo = {
          "name": "createTimestamp"
        };
        features.push(featureInfo);
        return;
      }

      if (col.EXTRA === 'on update CURRENT_TIMESTAMP') {
        let featureInfo = {
          "name": "updateTimestamp"
        };
        features.push(featureInfo);
        return;
      }

      if (fieldName === 'isDeleted' && col.COLUMN_TYPE === 'tinyint(1)') {
        let featureInfo = {
          "name": "logicalDeletion"
        };
        features.push(featureInfo);
        return;
      }

      let fieldInfo = this._mysqlTypeToOolType(table, col, fieldName, types);

      if (col.IS_NULLABLE === 'YES') {
        fieldInfo.optional = true;
      }

      if (col.COLUMN_DEFAULT) {
        fieldInfo.default = col.COLUMN_DEFAULT;
      }

      if (col.COLUMN_COMMENT) {
        fieldInfo.comment = col.COLUMN_COMMENT;
      }

      fields[fieldName] = fieldInfo;
    });
    return {
      features,
      fields,
      types
    };
  }

  _fieldNaming(name) {
    if (this.reverseRules.fieldNaming) {
      return this.reverseRules.fieldNamin(name);
    }

    return OolUtils.fieldNaming(name);
  }

  _entityNaming(name) {
    if (this.reverseRules.entityNaming) {
      return this.reverseRules.entityNaming(name);
    }

    return OolUtils.entityNaming(name);
  }

  _schemaNaming(name) {
    if (this.reverseRules.schemaNaming) {
      return this.reverseRules.schemaNaming(name);
    }

    return OolUtils.schemaNaming(name);
  }

  _mysqlTypeToOolType(table, col, fieldName, types) {
    let applicableRule = _.find(this.reverseRules.columnTypeConversion, rule => rule.test(table, col));

    if (applicableRule) {
      return applicableRule.apply(table, col);
    }

    let typeInfo = {};

    if (col.COLUMN_NAME !== fieldName) {
      typeInfo.code = col.COLUMN_NAME;
    }

    switch (col.DATA_TYPE) {
      case 'varchar':
        typeInfo.type = 'text';

        if (col.CHARACTER_MAXIMUM_LENGTH) {
          typeInfo.maxLength = col.CHARACTER_MAXIMUM_LENGTH;
        }

        break;

      case 'char':
        typeInfo.type = 'text';

        if (col.CHARACTER_MAXIMUM_LENGTH) {
          typeInfo.fixedLength = col.CHARACTER_MAXIMUM_LENGTH;
        }

        break;

      case 'bigint':
        typeInfo.type = 'integer';
        typeInfo.digits = col.NUMERIC_PRECISION || 18;
        typeInfo.bytes = 8;
        if (_.endsWith(col.COLUMN_TYPE, ' unsigned')) typeInfo.unsigned = true;
        break;

      case 'int':
        typeInfo.type = 'integer';
        typeInfo.digits = col.NUMERIC_PRECISION || 10;
        typeInfo.bytes = 4;
        if (_.endsWith(col.COLUMN_TYPE, ' unsigned')) typeInfo.unsigned = true;
        break;

      case 'mediumint':
        typeInfo.type = 'integer';
        typeInfo.digits = col.NUMERIC_PRECISION || 7;
        typeInfo.bytes = 3;
        if (_.endsWith(col.COLUMN_TYPE, ' unsigned')) typeInfo.unsigned = true;
        break;

      case 'smallint':
        typeInfo.type = 'integer';
        typeInfo.digits = col.NUMERIC_PRECISION || 4;
        typeInfo.bytes = 2;
        if (_.endsWith(col.COLUMN_TYPE, ' unsigned')) typeInfo.unsigned = true;
        break;

      case 'tinyint':
        if (_.startsWith(col.COLUMN_TYPE, 'tinyint(1)')) {
          typeInfo.type = 'boolean';
        } else {
          typeInfo.type = 'integer';
          typeInfo.digits = col.NUMERIC_PRECISION || 2;
          typeInfo.bytes = 1;
          if (_.endsWith(col.COLUMN_TYPE, ' unsigned')) typeInfo.unsigned = true;
        }

        break;

      case 'enum':
        let left = col.COLUMN_TYPE.indexOf('(');
        let right = col.COLUMN_TYPE.lastIndexOf(')');

        let typeName = table.TABLE_NAME + _.upperFirst(col.COLUMN_NAME);

        types[typeName] = {
          type: 'enum',
          values: col.COLUMN_TYPE.substring(left + 1, right).split(',').map(v => v.substr(1, v.length - 2))
        };
        typeInfo.type = typeName;
        break;

      case 'text':
        typeInfo.type = 'text';
        typeInfo.maxLength = col.CHARACTER_MAXIMUM_LENGTH;
        break;

      case 'datetime':
      case 'timestamp':
        typeInfo.type = 'datetime';
        break;

      case 'decimal':
        typeInfo.type = 'number';
        typeInfo.totalDigits = col.NUMERIC_PRECISION;
        typeInfo.decimalDigits = col.NUMERIC_SCALE;
        typeInfo.exact = true;
        break;

      case 'float':
        typeInfo.type = 'number';
        typeInfo.totalDigits = col.NUMERIC_PRECISION;
        typeInfo.decimalDigits = col.NUMERIC_SCALE;
        break;

      default:
        console.log(col);
        throw new Error('To be implemented.');
    }

    return typeInfo;
  }

  _refineEntityRelationships(mapOfEntities) {
    let entityAssoc = {};

    _.forOwn(mapOfEntities, ({
      entityInfo
    }, name) => {
      if (_.isEmpty(entityInfo.associations)) return;
      entityInfo.associations.forEach(({
        type,
        srcField,
        destEntity
      }) => {
        let refedEntity = mapOfEntities[destEntity];

        let backRef = _.find(refedEntity.associations, assoc => assoc.destEntity === name);

        if (type === 'hasMany') {
          if (!backRef) {
            Util.putIntoBucket(entityAssoc, name, {
              type: 'refersTo',
              srcField,
              destEntity
            });
            return;
          }

          console.log(entityInfo);
          throw new Error(`Back reference: ${backRef.entity} ${backRef.type} ${name}`);
        } else if (type === 'belongsTo') {
          Util.putIntoBucket(entityAssoc, name, {
            type,
            srcField,
            destEntity
          });

          if (!backRef) {
            Util.putIntoBucket(entityAssoc, entity, {
              type: 'hasMany',
              destEntity: name
            });
            return;
          }
        } else {
          throw new Error('Unexpected association type: ' + type);
        }
      });
    });

    _.forOwn(entityAssoc, (associations, name) => {
      let {
        entityInfo
      } = mapOfEntities[name];
      let keyAssocs;

      if (Array.isArray(entityInfo.key) && entityInfo.key.length === 2) {
        keyAssocs = _.filter(associations, assoc => entityInfo.key.indexOf(assoc.srcField) !== -1);

        if (keyAssocs.length === 2) {
          this._makeEntityManyToMany(keyAssocs[0].destEntity, keyAssocs[1].destEntity, entityAssoc);
        }
      }

      entityInfo.indexes.forEach(({
        fields
      }) => {
        if (fields.length === 2) {
          keyAssocs = _.filter(associations, assoc => fields.indexOf(assoc.srcField) !== -1);

          if (keyAssocs.length === 2) {
            this._makeEntityManyToMany(keyAssocs[0].destEntity, keyAssocs[1].destEntity, entityAssoc);
          }
        }
      });
    });

    _.forOwn(mapOfEntities, ({
      entityInfo
    }, name) => {
      entityInfo.associations = entityAssoc[name];
    });
  }

  _makeEntityManyToMany(entityName1, entityName2, entityAssoc) {
    Util.putIntoBucket(entityAssoc, entityName1, {
      type: 'hasMany',
      destEntity: entityName2
    });
    Util.putIntoBucket(entityAssoc, entityName2, {
      type: 'hasMany',
      destEntity: entityName1
    });
  }

}

module.exports = MySQLReverseEngineering;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9tb2RlbGVyL2RhdGFiYXNlL215c3FsL1JldmVyc2VFbmdpbmVlcmluZy5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIlV0aWwiLCJfIiwiZnMiLCJPb2xDb2RlR2VuIiwiT29sVXRpbHMiLCJNeVNRTFJldmVyc2VFbmdpbmVlcmluZyIsImNvbnN0cnVjdG9yIiwiY29udGV4dCIsImNvbm5lY3RvciIsImxvZ2dlciIsInJldmVyc2VSdWxlcyIsIm9wdGlvbnMiLCJzYXZlRGF0YWJhc2VNZXRhIiwicmV2ZXJzZV8iLCJvdXRwdXREaXIiLCJsb2ciLCJkcml2ZXIiLCJkYXRhYmFzZSIsImVuc3VyZURpclN5bmMiLCJ0YWJsZXMiLCJleGVjdXRlXyIsIndyaXRlRmlsZVN5bmMiLCJqb2luIiwiSlNPTiIsInN0cmluZ2lmeSIsImVudGl0aWVzIiwibWFwT2ZFbnRpdGllcyIsImVudGl0aWVzT29sUGF0aCIsImVhY2hBc3luY18iLCJ0YWJsZSIsImVudGl0eU5hbWUiLCJfZW50aXR5TmFtaW5nIiwiVEFCTEVfTkFNRSIsInB1c2giLCJlbnRpdHkiLCJleHRyYWN0VGFibGVfIiwiX3JlZmluZUVudGl0eVJlbGF0aW9uc2hpcHMiLCJmb3JPd24iLCJ0eXBlcyIsImVudGl0eUluZm8iLCJ0eXBlIiwiZW50aXR5Q29udGVudCIsInRyYW5zZm9ybSIsImVudGl0eUZpbGUiLCJzY2hlbWFOYW1lIiwiX3NjaGVtYU5hbWluZyIsImpzb24iLCJzY2hlbWFDb250ZW50Iiwic2NoZW1hRmlsZSIsImV4dHJhY3RlZE9vbFBhdGgiLCJjb2x1bW5zIiwiZmVhdHVyZXMiLCJmaWVsZHMiLCJfcHJvY2Vzc0ZpZWxkcyIsImluZGV4SW5mbyIsImlzRW1wdHkiLCJwayIsImluZGV4ZXMiLCJtYXBOYW1lVG9JbmRleCIsIl9wcm9jZXNzSW5kZXhlcyIsImxlbmd0aCIsInJlZmVyZW5jZXNJbmZvIiwiYXNzb2NpYXRpb25zIiwiX3Byb2Nlc3NSZWZlcmVuY2VzXyIsImNvbW1lbnQiLCJUQUJMRV9DT01NRU5UIiwia2V5IiwiY29kZSIsImwiLCJpIiwicmVmIiwicmVmVGFibGVLZXkiLCJSRUZFUkVOQ0VEX1RBQkxFX05BTUUiLCJDb2x1bW5fbmFtZSIsInRvTG93ZXJDYXNlIiwiUkVGRVJFTkNFRF9DT0xVTU5fTkFNRSIsIkVycm9yIiwiQ09MVU1OX05BTUUiLCJ1bmlxdWUiLCJma0luZm8iLCJDT05TVFJBSU5UX05BTUUiLCJOb25fdW5pcXVlIiwiZmtDb2xOYW1lIiwiX2ZpZWxkTmFtaW5nIiwic3JjRmllbGQiLCJkZXN0RW50aXR5IiwiZm9yRWFjaCIsInB1dEludG9CdWNrZXQiLCJLZXlfbmFtZSIsIm5hbWUiLCJtYXAiLCJmIiwibnVsbGFibGUiLCJOdWxsIiwiY29sIiwiZmllbGROYW1lIiwiRVhUUkEiLCJmZWF0dXJlSW5mbyIsIkFVVE9fSU5DUkVNRU5UIiwiQ09MVU1OX0RFRkFVTFQiLCJDT0xVTU5fVFlQRSIsImZpZWxkSW5mbyIsIl9teXNxbFR5cGVUb09vbFR5cGUiLCJJU19OVUxMQUJMRSIsIm9wdGlvbmFsIiwiZGVmYXVsdCIsIkNPTFVNTl9DT01NRU5UIiwiZmllbGROYW1pbmciLCJmaWVsZE5hbWluIiwiZW50aXR5TmFtaW5nIiwic2NoZW1hTmFtaW5nIiwiYXBwbGljYWJsZVJ1bGUiLCJmaW5kIiwiY29sdW1uVHlwZUNvbnZlcnNpb24iLCJydWxlIiwidGVzdCIsImFwcGx5IiwidHlwZUluZm8iLCJEQVRBX1RZUEUiLCJDSEFSQUNURVJfTUFYSU1VTV9MRU5HVEgiLCJtYXhMZW5ndGgiLCJmaXhlZExlbmd0aCIsImRpZ2l0cyIsIk5VTUVSSUNfUFJFQ0lTSU9OIiwiYnl0ZXMiLCJlbmRzV2l0aCIsInVuc2lnbmVkIiwic3RhcnRzV2l0aCIsImxlZnQiLCJpbmRleE9mIiwicmlnaHQiLCJsYXN0SW5kZXhPZiIsInR5cGVOYW1lIiwidXBwZXJGaXJzdCIsInZhbHVlcyIsInN1YnN0cmluZyIsInNwbGl0IiwidiIsInN1YnN0ciIsInRvdGFsRGlnaXRzIiwiZGVjaW1hbERpZ2l0cyIsIk5VTUVSSUNfU0NBTEUiLCJleGFjdCIsImNvbnNvbGUiLCJlbnRpdHlBc3NvYyIsInJlZmVkRW50aXR5IiwiYmFja1JlZiIsImFzc29jIiwia2V5QXNzb2NzIiwiQXJyYXkiLCJpc0FycmF5IiwiZmlsdGVyIiwiX21ha2VFbnRpdHlNYW55VG9NYW55IiwiZW50aXR5TmFtZTEiLCJlbnRpdHlOYW1lMiIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU1DLElBQUksR0FBR0QsT0FBTyxDQUFDLFVBQUQsQ0FBcEI7O0FBQ0EsTUFBTTtBQUFFRSxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBO0FBQUwsSUFBWUYsSUFBbEI7O0FBQ0EsTUFBTUcsVUFBVSxHQUFHSixPQUFPLENBQUMsMEJBQUQsQ0FBMUI7O0FBQ0EsTUFBTUssUUFBUSxHQUFHTCxPQUFPLENBQUMsd0JBQUQsQ0FBeEI7O0FBRUEsTUFBTU0sdUJBQU4sQ0FBOEI7QUFDMUJDLEVBQUFBLFdBQVcsQ0FBQ0MsT0FBRCxFQUFVQyxTQUFWLEVBQXFCO0FBQzVCLFNBQUtDLE1BQUwsR0FBY0YsT0FBTyxDQUFDRSxNQUF0QjtBQUNBLFNBQUtELFNBQUwsR0FBaUJBLFNBQWpCO0FBRUEsU0FBS0UsWUFBTCxHQUFvQixLQUFLRixTQUFMLENBQWVHLE9BQWYsQ0FBdUJELFlBQXZCLElBQXVDLEVBQTNEO0FBQ0EsU0FBS0UsZ0JBQUwsR0FBd0IsS0FBS0osU0FBTCxDQUFlRyxPQUFmLENBQXVCQyxnQkFBdkIsSUFBMkMsS0FBbkU7QUFDSDs7QUFFRCxRQUFNQyxRQUFOLENBQWVDLFNBQWYsRUFBMEI7QUFDdEIsU0FBS0wsTUFBTCxDQUFZTSxHQUFaLENBQWdCLFNBQWhCLEVBQTRCLCtCQUE4QixLQUFLUCxTQUFMLENBQWVRLE1BQU8sY0FBYSxLQUFLUixTQUFMLENBQWVTLFFBQVMsT0FBckg7QUFF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QUVEK0QsRUFBQUEscUJBQXFCLENBQUNDLFdBQUQsRUFBY0MsV0FBZCxFQUEyQlYsV0FBM0IsRUFBd0M7QUFDekRoSixJQUFBQSxJQUFJLENBQUN1RixhQUFMLENBQW1CeUQsV0FBbkIsRUFBZ0NTLFdBQWhDLEVBQTZDO0FBQUVqSCxNQUFBQSxJQUFJLEVBQUUsU0FBUjtBQUFtQjZDLE1BQUFBLFVBQVUsRUFBRXFFO0FBQS9CLEtBQTdDO0FBQ0ExSixJQUFBQSxJQUFJLENBQUN1RixhQUFMLENBQW1CeUQsV0FBbkIsRUFBZ0NVLFdBQWhDLEVBQTZDO0FBQUVsSCxNQUFBQSxJQUFJLEVBQUUsU0FBUjtBQUFtQjZDLE1BQUFBLFVBQVUsRUFBRW9FO0FBQS9CLEtBQTdDO0FBQ0g7O0FBamN5Qjs7QUFvYzlCRSxNQUFNLENBQUNDLE9BQVAsR0FBaUJ2Six1QkFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgVXRpbCA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IF8sIGZzIH0gPSBVdGlsO1xuY29uc3QgT29sQ29kZUdlbiA9IHJlcXVpcmUoJy4uLy4uLy4uL2xhbmcvT29sQ29kZUdlbicpO1xuY29uc3QgT29sVXRpbHMgPSByZXF1aXJlKCcuLi8uLi8uLi9sYW5nL09vbFV0aWxzJyk7XG5cbmNsYXNzIE15U1FMUmV2ZXJzZUVuZ2luZWVyaW5nIHtcbiAgICBjb25zdHJ1Y3Rvcihjb250ZXh0LCBjb25uZWN0b3IpIHtcbiAgICAgICAgdGhpcy5sb2dnZXIgPSBjb250ZXh0LmxvZ2dlcjtcbiAgICAgICAgdGhpcy5jb25uZWN0b3IgPSBjb25uZWN0b3I7ICAgICAgICBcblxuICAgICAgICB0aGlzLnJldmVyc2VSdWxlcyA9IHRoaXMuY29ubmVjdG9yLm9wdGlvbnMucmV2ZXJzZVJ1bGVzIHx8IHt9OyAgICAgICBcbiAgICAgICAgdGhpcy5zYXZlRGF0YWJhc2VNZXRhID0gdGhpcy5jb25uZWN0b3Iub3B0aW9ucy5zYXZlRGF0YWJhc2VNZXRhIHx8IGZhbHNlO1xuICAgIH1cblxuICAgIGFzeW5jIHJldmVyc2VfKG91dHB1dERpcikge1xuICAgICAgICB0aGlzLmxvZ2dlci5sb2coJ3ZlcmJvc2UnLCBgUmV2ZXJzZSBlbmdpbmVlcmluZyBhZ2FpbnN0ICR7dGhpcy5jb25uZWN0b3IuZHJpdmVyfSBkYXRhYmFzZSBcIiR7dGhpcy5jb25uZWN0b3IuZGF0YWJhc2V9XCIgLi4uYCk7XG5cbiAgICAgICAgZnMuZW5zdXJlRGlyU3luYyhvdXRwdXREaXIpO1xuXG4gICAgICAgIGxldCB0YWJsZXMgPSBhd2FpdCB0aGlzLmNvbm5lY3Rvci5leGVjdXRlXyhcInNlbGVjdCAqIGZyb20gaW5mb3JtYXRpb25fc2NoZW1hLnRhYmxlcyB3aGVyZSB0YWJsZV9zY2hlbWEgPSA/XCIsIFsgdGhpcy5jb25uZWN0b3IuZGF0YWJhc2UgXSk7ICAgICAgICBcblxuICAgICAgICBpZiAodGhpcy5zYXZlRGF0YWJhc2VNZXRhKSB7XG4gICAgICAgICAgICBmcy53cml0ZUZpbGVTeW5jKHBhdGguam9pbihvdXRwdXREaXIsIHRoaXMuY29ubmVjdG9yLmRhdGFiYXNlICsgJy5tZXRhLmpzb24nKSwgSlNPTi5zdHJpbmdpZnkodGFibGVzLCBudWxsLCAyKSk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgZW50aXRpZXMgPSBbXSwgbWFwT2ZFbnRpdGllcyA9IHt9O1xuICAgICAgICBcbiAgICAgICAgbGV0IGVudGl0aWVzT29sUGF0aCA9IHBhdGguam9pbihvdXRwdXREaXIsICdlbnRpdGllcycpO1xuICAgICAgICBmcy5lbnN1cmVEaXJTeW5jKGVudGl0aWVzT29sUGF0aCk7XG5cbiAgICAgICAgYXdhaXQgVXRpbC5lYWNoQXN5bmNfKHRhYmxlcywgYXN5bmMgdGFibGUgPT4ge1xuICAgICAgICAgICAgbGV0IGVudGl0eU5hbWUgPSB0aGlzLl9lbnRpdHlOYW1pbmcodGFibGUuVEFCTEVfTkFNRSk7XG5cbiAgICAgICAgICAgIGVudGl0aWVzLnB1c2goeyBlbnRpdHk6IGVudGl0eU5hbWUgfSk7ICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIG1hcE9mRW50aXRpZXNbZW50aXR5TmFtZV0gPSBhd2FpdCB0aGlzLmV4dHJhY3RUYWJsZV8oZW50aXR5TmFtZSwgdGFibGUsIGVudGl0aWVzT29sUGF0aCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuX3JlZmluZUVudGl0eVJlbGF0aW9uc2hpcHMobWFwT2ZFbnRpdGllcyk7XG5cbiAgICAgICAgXy5mb3JPd24obWFwT2ZFbnRpdGllcywgKHsgdHlwZXMsIGVudGl0eUluZm8gfSwgZW50aXR5TmFtZSkgPT4ge1xuICAgICAgICAgICAgbGV0IGVudGl0eSA9IHtcbiAgICAgICAgICAgICAgICB0eXBlOiB0eXBlcyxcbiAgICAgICAgICAgICAgICBlbnRpdHk6IHtcbiAgICAgICAgICAgICAgICAgICAgW2VudGl0eU5hbWVdOiBlbnRpdHlJbmZvXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICBcbiAgICAgICAgICAgIGxldCBlbnRpdHlDb250ZW50ID0gT29sQ29kZUdlbi50cmFuc2Zvcm0oZW50aXR5KTtcbiAgICAgICAgICAgIGxldCBlbnRpdHlGaWxlID0gcGF0aC5qb2luKGVudGl0aWVzT29sUGF0aCwgZW50aXR5TmFtZSArICcub29sJyk7XG4gICAgICAgICAgICBmcy53cml0ZUZpbGVTeW5jKGVudGl0eUZpbGUgKyAnLmpzb24nLCBKU09OLnN0cmluZ2lmeShlbnRpdHksIG51bGwsIDIpKTtcbiAgICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMoZW50aXR5RmlsZSwgZW50aXR5Q29udGVudCk7XG4gICAgICAgICAgICB0aGlzLmxvZ2dlci5sb2coJ2luZm8nLCBgRXh0cmFjdGVkIGVudGl0eSBkZWZpbml0aW9uIGZpbGUgXCIke2VudGl0eUZpbGV9XCIuYCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGxldCBzY2hlbWFOYW1lID0gdGhpcy5fc2NoZW1hTmFtaW5nKHRoaXMuY29ubmVjdG9yLmRhdGFiYXNlKTtcblxuICAgICAgICBsZXQganNvbiA9IHtcbiAgICAgICAgICAgIFwibmFtZXNwYWNlXCI6IFtcbiAgICAgICAgICAgICAgICBcImVudGl0aWVzLyoqXCJcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgICBcInNjaGVtYVwiOiB7XG4gICAgICAgICAgICAgICAgW3NjaGVtYU5hbWVdOiB7XG4gICAgICAgICAgICAgICAgICAgIFwiZW50aXRpZXNcIjogZW50aXRpZXMgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgbGV0IHNjaGVtYUNvbnRlbnQgPSBPb2xDb2RlR2VuLnRyYW5zZm9ybShqc29uKTtcbiAgICAgICAgbGV0IHNjaGVtYUZpbGUgPSBwYXRoLmpvaW4ob3V0cHV0RGlyLCBzY2hlbWFOYW1lICsgJy5vb2wnKTtcbiAgICAgICAgZnMud3JpdGVGaWxlU3luYyhzY2hlbWFGaWxlICsgJy5qc29uJywgSlNPTi5zdHJpbmdpZnkoanNvbiwgbnVsbCwgMikpO1xuICAgICAgICBmcy53cml0ZUZpbGVTeW5jKHNjaGVtYUZpbGUsIHNjaGVtYUNvbnRlbnQpO1xuICAgICAgICB0aGlzLmxvZ2dlci5sb2coJ2luZm8nLCBgRXh0cmFjdGVkIHNjaGVtYSBlbnRyeSBmaWxlIFwiJHtzY2hlbWFGaWxlfVwiLmApO1xuICAgIH1cblxuICAgIGFzeW5jIGV4dHJhY3RUYWJsZV8oZW50aXR5TmFtZSwgdGFibGUsIGV4dHJhY3RlZE9vbFBhdGgpIHtcbiAgICAgICAgbGV0IGNvbHVtbnMgPSBhd2FpdCB0aGlzLmNvbm5lY3Rvci5leGVjdXRlXyhcInNlbGVjdCAqIGZyb20gaW5mb3JtYXRpb25fc2NoZW1hLmNvbHVtbnMgd2hlcmUgdGFibGVfc2NoZW1hID0gPyBhbmQgdGFibGVfbmFtZSA9ID9cIixcbiAgICAgICAgICAgIFt0aGlzLmNvbm5lY3Rvci5kYXRhYmFzZSwgdGFibGUuVEFCTEVfTkFNRV0pO1xuXG4gICAgICAgIGlmICh0aGlzLnNhdmVEYXRhYmFzZU1ldGEpIHtcbiAgICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMocGF0aC5qb2luKGV4dHJhY3RlZE9vbFBhdGgsIHRhYmxlLlRBQkxFX05BTUUgKyAnLm1ldGEuanNvbicpLCBKU09OLnN0cmluZ2lmeShjb2x1bW5zLCBudWxsLCAyKSk7XG4gICAgICAgIH0gICAgICAgICAgICAgICAgICAgIFxuXG4gICAgICAgIGxldCB7IGZlYXR1cmVzLCBmaWVsZHMsIHR5cGVzIH0gPSB0aGlzLl9wcm9jZXNzRmllbGRzKHRhYmxlLCBjb2x1bW5zKTtcblxuICAgICAgICBsZXQgaW5kZXhJbmZvID0gYXdhaXQgdGhpcy5jb25uZWN0b3IuZXhlY3V0ZV8oXCJTSE9XIElOREVYRVMgRlJPTSA/P1wiLCBbIHRhYmxlLlRBQkxFX05BTUUgXSk7XG5cbiAgICAgICAgaWYgKHRoaXMuc2F2ZURhdGFiYXNlTWV0YSAmJiAhXy5pc0VtcHR5KGluZGV4SW5mbykpIHtcbiAgICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMocGF0aC5qb2luKGV4dHJhY3RlZE9vbFBhdGgsIHRhYmxlLlRBQkxFX05BTUUgKyAnLmluZGV4Lmpzb24nKSwgSlNPTi5zdHJpbmdpZnkoaW5kZXhJbmZvLCBudWxsLCAyKSk7XG4gICAgICAgIH0gICAgICAgXG5cbiAgICAgICAgbGV0IHsgcGssIGluZGV4ZXMsIG1hcE5hbWVUb0luZGV4IH0gPSB0aGlzLl9wcm9jZXNzSW5kZXhlcyhpbmRleEluZm8pO1xuXG4gICAgICAgIGFzc2VydDogcGsubGVuZ3RoID4gMDsgICAgICAgIFxuXG4gICAgICAgIGxldCByZWZlcmVuY2VzSW5mbyA9IGF3YWl0IHRoaXMuY29ubmVjdG9yLmV4ZWN1dGVfKFwiU0VMRUNUICogRlJPTSBJTkZPUk1BVElPTl9TQ0hFTUEuS0VZX0NPTFVNTl9VU0FHRSBXSEVSRSBgUkVGRVJFTkNFRF9UQUJMRV9TQ0hFTUFgID0gPyBBTkQgYFRBQkxFX05BTUVgID0gPyBBTkQgYFJFRkVSRU5DRURfVEFCTEVfTkFNRWAgSVMgTk9UIE5VTExcIixcbiAgICAgICAgICAgIFsgdGhpcy5jb25uZWN0b3IuZGF0YWJhc2UsIHRhYmxlLlRBQkxFX05BTUUgXSk7XG5cbiAgICAgICAgaWYgKHRoaXMuc2F2ZURhdGFiYXNlTWV0YSAmJiAhXy5pc0VtcHR5KHJlZmVyZW5jZXNJbmZvKSkge1xuICAgICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhwYXRoLmpvaW4oZXh0cmFjdGVkT29sUGF0aCwgdGFibGUuVEFCTEVfTkFNRSArICcucmVmLmpzb24nKSwgSlNPTi5zdHJpbmdpZnkocmVmZXJlbmNlc0luZm8sIG51bGwsIDIpKTtcbiAgICAgICAgfSAgICAgICBcblxuICAgICAgICBsZXQgYXNzb2NpYXRpb25zID0gYXdhaXQgdGhpcy5fcHJvY2Vzc1JlZmVyZW5jZXNfKHJlZmVyZW5jZXNJbmZvLCBtYXBOYW1lVG9JbmRleCwgZmllbGRzKTtcblxuICAgICAgICBsZXQgZW50aXR5SW5mbyA9IHsgICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbW1lbnQ6IHRhYmxlLlRBQkxFX0NPTU1FTlQsXG4gICAgICAgICAgICBmZWF0dXJlcyxcbiAgICAgICAgICAgIGZpZWxkcyxcbiAgICAgICAgICAgIGFzc29jaWF0aW9ucyxcbiAgICAgICAgICAgIGtleSA6IHBrLmxlbmd0aCA+IDEgPyBwayA6IHBrWzBdLFxuICAgICAgICAgICAgaW5kZXhlc1xuICAgICAgICB9O1xuXG4gICAgICAgIGlmIChlbnRpdHlOYW1lICE9PSB0YWJsZS5UQUJMRV9OQU1FKSB7XG4gICAgICAgICAgICBlbnRpdHlJbmZvLmNvZGUgPSB0YWJsZS5UQUJMRV9OQU1FO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHsgdHlwZXMsIGVudGl0eUluZm8gfTtcbiAgICB9XG5cbiAgICBhc3luYyBfcHJvY2Vzc1JlZmVyZW5jZXNfKHJlZmVyZW5jZXNJbmZvLCBtYXBOYW1lVG9JbmRleCwgZmllbGRzKSB7XG4gICAgICAgIGxldCBhc3NvY2lhdGlvbnMgPSBbXTtcblxuICAgICAgICBsZXQgbCA9IHJlZmVyZW5jZXNJbmZvLmxlbmd0aDtcblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGw7IGkrKykge1xuICAgICAgICAgICAgbGV0IHJlZiA9IHJlZmVyZW5jZXNJbmZvW2ldO1xuXG4gICAgICAgICAgICBsZXQgW3JlZlRhYmxlS2V5XSA9IGF3YWl0IHRoaXMuY29ubmVjdG9yLmV4ZWN1dGVfKFwiU0hPVyBJTkRFWEVTIEZST00gPz8gV0hFUkUgYEtleV9uYW1lYCA9ICdQUklNQVJZJ1wiLCBbcmVmLlJFRkVSRU5DRURfVEFCTEVfTkFNRV0pO1xuXG4gICAgICAgICAgICBpZiAocmVmVGFibGVLZXkuQ29sdW1uX25hbWUudG9Mb3dlckNhc2UoKSAhPT0gcmVmLlJFRkVSRU5DRURfQ09MVU1OX05BTUUudG9Mb3dlckNhc2UoKSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRm9yZWlnbiBrZXkgXCIke3JlZi5DT0xVTU5fTkFNRX1cIiBub3QgcmVmZXJlbmNlIHRvIHRoZSBwcmltYXJ5IGtleS5gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IHVuaXF1ZSA9IGZhbHNlO1xuXG4gICAgICAgICAgICBsZXQgZmtJbmZvID0gbWFwTmFtZVRvSW5kZXhbcmVmLkNPTlNUUkFJTlRfTkFNRV07IFxuICAgICAgICAgICAgaWYgKGZrSW5mbykge1xuICAgICAgICAgICAgICAgIGlmIChma0luZm8ubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENvbWJpbmF0aW9uIGZvcmVpZ24ga2V5IGlzIG5vdCBzdXBwb3J0ZWQ6IFwiJHtyZWYuQ09OU1RSQUlOVF9OQU1FfVwiYCk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgdW5pcXVlID0gZmtJbmZvWzBdLk5vbl91bmlxdWUgPT09IDA7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBma0NvbE5hbWUgPSB0aGlzLl9maWVsZE5hbWluZyhyZWYuQ09MVU1OX05BTUUpO1xuXG4gICAgICAgICAgICBpZiAodW5pcXVlKSB7XG4gICAgICAgICAgICAgICAgYXNzb2NpYXRpb25zLnB1c2goeyB0eXBlOiAnYmVsb25nc1RvJywgc3JjRmllbGQ6IGZrQ29sTmFtZSwgZGVzdEVudGl0eTogdGhpcy5fZW50aXR5TmFtaW5nKHJlZi5SRUZFUkVOQ0VEX1RBQkxFX05BTUUpIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBhc3NvY2lhdGlvbnMucHVzaCh7IHR5cGU6ICdoYXNNYW55Jywgc3JjRmllbGQ6IGZrQ29sTmFtZSwgIGRlc3RFbnRpdHk6IHRoaXMuX2VudGl0eU5hbWluZyhyZWYuUkVGRVJFTkNFRF9UQUJMRV9OQU1FKSB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZGVsZXRlIGZpZWxkc1tma0NvbE5hbWVdOy8vID0geyB0eXBlOiAnJGFzc29jaWF0aW9uJywgY29kZTogZmllbGRzW2ZrQ29sTmFtZV0uY29kZSB9O1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGFzc29jaWF0aW9ucztcbiAgICB9XG5cbiAgICBfcHJvY2Vzc0luZGV4ZXMoaW5kZXhJbmZvKSB7XG4gICAgICAgIGxldCBwayA9IFtdLCBpbmRleGVzID0gW107XG5cbiAgICAgICAgbGV0IG1hcE5hbWVUb0luZGV4ID0ge307XG5cbiAgICAgICAgaW5kZXhJbmZvLmZvckVhY2goaSA9PiB7XG4gICAgICAgICAgICBVdGlsLnB1dEludG9CdWNrZXQobWFwTmFtZVRvSW5kZXgsIGkuS2V5X25hbWUsIGkpO1xuICAgICAgICB9KTtcblxuICAgICAgICBfLmZvck93bihtYXBOYW1lVG9JbmRleCwgKGZpZWxkcywgbmFtZSkgPT4ge1xuICAgICAgICAgICAgaWYgKG5hbWUgPT09ICdQUklNQVJZJykge1xuICAgICAgICAgICAgICAgIHBrLnB1c2goZmllbGRzLm1hcChmID0+IHRoaXMuX2ZpZWxkTmFtaW5nKGYuQ29sdW1uX25hbWUpKSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGluZGV4ZXMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IG5hbWUsXG4gICAgICAgICAgICAgICAgICAgIGZpZWxkczogZmllbGRzLm1hcChmID0+IHRoaXMuX2ZpZWxkTmFtaW5nKGYuQ29sdW1uX25hbWUpKSxcbiAgICAgICAgICAgICAgICAgICAgdW5pcXVlOiBmaWVsZHNbMF0uTm9uX3VuaXF1ZSA9PT0gMCxcbiAgICAgICAgICAgICAgICAgICAgbnVsbGFibGU6IGZpZWxkc1swXS5OdWxsID09PSAnWUVTJ1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4geyBwaywgaW5kZXhlcywgbWFwTmFtZVRvSW5kZXggfTtcbiAgICB9XG5cbiAgICBfcHJvY2Vzc0ZpZWxkcyh0YWJsZSwgY29sdW1ucykge1xuICAgICAgICBsZXQgZmVhdHVyZXMgPSBbXSwgZmllbGRzID0ge30sIHR5cGVzID0ge307XG5cbiAgICAgICAgY29sdW1ucy5mb3JFYWNoKGNvbCA9PiB7XG4gICAgICAgICAgICBsZXQgZmllbGROYW1lID0gdGhpcy5fZmllbGROYW1pbmcoY29sLkNPTFVNTl9OQU1FKTtcbiAgICAgICAgICAgIGlmIChjb2wuRVhUUkEgPT09ICdhdXRvX2luY3JlbWVudCcpIHtcbiAgICAgICAgICAgICAgICBsZXQgZmVhdHVyZUluZm8gPSB7XG4gICAgICAgICAgICAgICAgICAgIFwibmFtZVwiOiBcImF1dG9JZFwiLFxuICAgICAgICAgICAgICAgICAgICBcIm9wdGlvbnNcIjogdGFibGUuQVVUT19JTkNSRU1FTlQgPyB7ICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICBcInN0YXJ0RnJvbVwiOiB0YWJsZS5BVVRPX0lOQ1JFTUVOVFxuICAgICAgICAgICAgICAgICAgICB9IDoge31cbiAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgaWYgKGZpZWxkTmFtZSAhPT0gJ2lkJykge1xuICAgICAgICAgICAgICAgICAgICBmZWF0dXJlSW5mby5vcHRpb25zLm5hbWUgPSBmaWVsZE5hbWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGZlYXR1cmVzLnB1c2goZmVhdHVyZUluZm8pO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGNvbC5DT0xVTU5fREVGQVVMVCA9PT0gJ0NVUlJFTlRfVElNRVNUQU1QJykge1xuICAgICAgICAgICAgICAgIGxldCBmZWF0dXJlSW5mbyA9IHtcbiAgICAgICAgICAgICAgICAgICAgXCJuYW1lXCI6IFwiY3JlYXRlVGltZXN0YW1wXCJcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIGZlYXR1cmVzLnB1c2goZmVhdHVyZUluZm8pO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGNvbC5FWFRSQSA9PT0gJ29uIHVwZGF0ZSBDVVJSRU5UX1RJTUVTVEFNUCcpIHtcbiAgICAgICAgICAgICAgICBsZXQgZmVhdHVyZUluZm8gPSB7XG4gICAgICAgICAgICAgICAgICAgIFwibmFtZVwiOiBcInVwZGF0ZVRpbWVzdGFtcFwiXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICBmZWF0dXJlcy5wdXNoKGZlYXR1cmVJbmZvKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChmaWVsZE5hbWUgPT09ICdpc0RlbGV0ZWQnICYmIGNvbC5DT0xVTU5fVFlQRSA9PT0gJ3RpbnlpbnQoMSknKSB7XG4gICAgICAgICAgICAgICAgbGV0IGZlYXR1cmVJbmZvID0ge1xuICAgICAgICAgICAgICAgICAgICBcIm5hbWVcIjogXCJsb2dpY2FsRGVsZXRpb25cIlxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgZmVhdHVyZXMucHVzaChmZWF0dXJlSW5mbyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgZmllbGRJbmZvID0gdGhpcy5fbXlzcWxUeXBlVG9Pb2xUeXBlKHRhYmxlLCBjb2wsIGZpZWxkTmFtZSwgdHlwZXMpO1xuXG4gICAgICAgICAgICBpZiAoY29sLklTX05VTExBQkxFID09PSAnWUVTJykge1xuICAgICAgICAgICAgICAgIGZpZWxkSW5mby5vcHRpb25hbCA9IHRydWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChjb2wuQ09MVU1OX0RFRkFVTFQpIHtcbiAgICAgICAgICAgICAgICBmaWVsZEluZm8uZGVmYXVsdCA9IGNvbC5DT0xVTU5fREVGQVVMVDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGNvbC5DT0xVTU5fQ09NTUVOVCkge1xuICAgICAgICAgICAgICAgIGZpZWxkSW5mby5jb21tZW50ID0gY29sLkNPTFVNTl9DT01NRU5UO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBmaWVsZHNbZmllbGROYW1lXSA9IGZpZWxkSW5mbztcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHsgZmVhdHVyZXMsIGZpZWxkcywgdHlwZXMgfTtcbiAgICB9XG5cbiAgICBfZmllbGROYW1pbmcobmFtZSkge1xuICAgICAgICBpZiAodGhpcy5yZXZlcnNlUnVsZXMuZmllbGROYW1pbmcpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnJldmVyc2VSdWxlcy5maWVsZE5hbWluKG5hbWUpO1xuICAgICAgICB9IFxuICAgICAgICBcbiAgICAgICAgcmV0dXJuIE9vbFV0aWxzLmZpZWxkTmFtaW5nKG5hbWUpO1xuICAgIH1cblxuICAgIF9lbnRpdHlOYW1pbmcobmFtZSkge1xuICAgICAgICBpZiAodGhpcy5yZXZlcnNlUnVsZXMuZW50aXR5TmFtaW5nKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5yZXZlcnNlUnVsZXMuZW50aXR5TmFtaW5nKG5hbWUpO1xuICAgICAgICB9IFxuICAgICAgICBcbiAgICAgICAgcmV0dXJuIE9vbFV0aWxzLmVudGl0eU5hbWluZyhuYW1lKTtcbiAgICB9XG5cbiAgICBfc2NoZW1hTmFtaW5nKG5hbWUpIHtcbiAgICAgICAgaWYgKHRoaXMucmV2ZXJzZVJ1bGVzLnNjaGVtYU5hbWluZykge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMucmV2ZXJzZVJ1bGVzLnNjaGVtYU5hbWluZyhuYW1lKTtcbiAgICAgICAgfSBcbiAgICAgICAgXG4gICAgICAgIHJldHVybiBPb2xVdGlscy5zY2hlbWFOYW1pbmcobmFtZSk7XG4gICAgfVxuXG4gICAgX215c3FsVHlwZVRvT29sVHlwZSh0YWJsZSwgY29sLCBmaWVsZE5hbWUsIHR5cGVzKSB7XG4gICAgICAgIGxldCBhcHBsaWNhYmxlUnVsZSA9IF8uZmluZCh0aGlzLnJldmVyc2VSdWxlcy5jb2x1bW5UeXBlQ29udmVyc2lvbiwgcnVsZSA9PiBydWxlLnRlc3QodGFibGUsIGNvbCkpO1xuICAgICAgICBpZiAoYXBwbGljYWJsZVJ1bGUpIHtcbiAgICAgICAgICAgIHJldHVybiBhcHBsaWNhYmxlUnVsZS5hcHBseSh0YWJsZSwgY29sKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgbGV0IHR5cGVJbmZvID0ge307ICAgICAgICBcbiAgICAgICAgaWYgKGNvbC5DT0xVTU5fTkFNRSAhPT0gZmllbGROYW1lKSB7XG4gICAgICAgICAgICB0eXBlSW5mby5jb2RlID0gY29sLkNPTFVNTl9OQU1FO1xuICAgICAgICB9XG5cbiAgICAgICAgc3dpdGNoIChjb2wuREFUQV9UWVBFKSB7XG4gICAgICAgICAgICBjYXNlICd2YXJjaGFyJzpcbiAgICAgICAgICAgICAgICB0eXBlSW5mby50eXBlID0gJ3RleHQnO1xuICAgICAgICAgICAgICAgIGlmIChjb2wuQ0hBUkFDVEVSX01BWElNVU1fTEVOR1RIKSB7XG4gICAgICAgICAgICAgICAgICAgIHR5cGVJbmZvLm1heExlbmd0aCA9IGNvbC5DSEFSQUNURVJfTUFYSU1VTV9MRU5HVEg7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICBjYXNlICdjaGFyJzpcbiAgICAgICAgICAgICAgICB0eXBlSW5mby50eXBlID0gJ3RleHQnO1xuICAgICAgICAgICAgICAgIGlmIChjb2wuQ0hBUkFDVEVSX01BWElNVU1fTEVOR1RIKSB7XG4gICAgICAgICAgICAgICAgICAgIHR5cGVJbmZvLmZpeGVkTGVuZ3RoID0gY29sLkNIQVJBQ1RFUl9NQVhJTVVNX0xFTkdUSDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGNhc2UgJ2JpZ2ludCc6XG4gICAgICAgICAgICAgICAgdHlwZUluZm8udHlwZSA9ICdpbnRlZ2VyJztcbiAgICAgICAgICAgICAgICB0eXBlSW5mby5kaWdpdHMgPSBjb2wuTlVNRVJJQ19QUkVDSVNJT04gfHwgMTg7XG4gICAgICAgICAgICAgICAgdHlwZUluZm8uYnl0ZXMgPSA4O1xuICAgICAgICAgICAgICAgIGlmIChfLmVuZHNXaXRoKGNvbC5DT0xVTU5fVFlQRSwgJyB1bnNpZ25lZCcpKSB0eXBlSW5mby51bnNpZ25lZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGNhc2UgJ2ludCc6XG4gICAgICAgICAgICAgICAgdHlwZUluZm8udHlwZSA9ICdpbnRlZ2VyJztcbiAgICAgICAgICAgICAgICB0eXBlSW5mby5kaWdpdHMgPSBjb2wuTlVNRVJJQ19QUkVDSVNJT04gfHwgMTA7XG4gICAgICAgICAgICAgICAgdHlwZUluZm8uYnl0ZXMgPSA0O1xuICAgICAgICAgICAgICAgIGlmIChfLmVuZHNXaXRoKGNvbC5DT0xVTU5fVFlQRSwgJyB1bnNpZ25lZCcpKSB0eXBlSW5mby51bnNpZ25lZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGNhc2UgJ21lZGl1bWludCc6XG4gICAgICAgICAgICAgICAgdHlwZUluZm8udHlwZSA9ICdpbnRlZ2VyJztcbiAgICAgICAgICAgICAgICB0eXBlSW5mby5kaWdpdHMgPSBjb2wuTlVNRVJJQ19QUkVDSVNJT04gfHwgNztcbiAgICAgICAgICAgICAgICB0eXBlSW5mby5ieXRlcyA9IDM7XG4gICAgICAgICAgICAgICAgaWYgKF8uZW5kc1dpdGgoY29sLkNPTFVNTl9UWVBFLCAnIHVuc2lnbmVkJykpIHR5cGVJbmZvLnVuc2lnbmVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgY2FzZSAnc21hbGxpbnQnOlxuICAgICAgICAgICAgICAgIHR5cGVJbmZvLnR5cGUgPSAnaW50ZWdlcic7XG4gICAgICAgICAgICAgICAgdHlwZUluZm8uZGlnaXRzID0gY29sLk5VTUVSSUNfUFJFQ0lTSU9OIHx8IDQ7XG4gICAgICAgICAgICAgICAgdHlwZUluZm8uYnl0ZXMgPSAyO1xuICAgICAgICAgICAgICAgIGlmIChfLmVuZHNXaXRoKGNvbC5DT0xVTU5fVFlQRSwgJyB1bnNpZ25lZCcpKSB0eXBlSW5mby51bnNpZ25lZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGNhc2UgJ3RpbnlpbnQnOlxuICAgICAgICAgICAgICAgIGlmIChfLnN0YXJ0c1dpdGgoY29sLkNPTFVNTl9UWVBFLCAndGlueWludCgxKScpKSB7XG4gICAgICAgICAgICAgICAgICAgIHR5cGVJbmZvLnR5cGUgPSAnYm9vbGVhbic7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZUluZm8udHlwZSA9ICdpbnRlZ2VyJztcbiAgICAgICAgICAgICAgICAgICAgdHlwZUluZm8uZGlnaXRzID0gY29sLk5VTUVSSUNfUFJFQ0lTSU9OIHx8IDI7XG4gICAgICAgICAgICAgICAgICAgIHR5cGVJbmZvLmJ5dGVzID0gMTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKF8uZW5kc1dpdGgoY29sLkNPTFVNTl9UWVBFLCAnIHVuc2lnbmVkJykpIHR5cGVJbmZvLnVuc2lnbmVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGNhc2UgJ2VudW0nOlxuICAgICAgICAgICAgICAgIGxldCBsZWZ0ID0gY29sLkNPTFVNTl9UWVBFLmluZGV4T2YoJygnKTtcbiAgICAgICAgICAgICAgICBsZXQgcmlnaHQgPSBjb2wuQ09MVU1OX1RZUEUubGFzdEluZGV4T2YoJyknKTtcblxuICAgICAgICAgICAgICAgIGxldCB0eXBlTmFtZSA9IHRhYmxlLlRBQkxFX05BTUUgKyBfLnVwcGVyRmlyc3QoY29sLkNPTFVNTl9OQU1FKTtcblxuICAgICAgICAgICAgICAgIHR5cGVzW3R5cGVOYW1lXSA9IHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2VudW0nLFxuICAgICAgICAgICAgICAgICAgICB2YWx1ZXM6IGNvbC5DT0xVTU5fVFlQRS5zdWJzdHJpbmcobGVmdCArIDEsIHJpZ2h0KS5zcGxpdCgnLCcpLm1hcCh2ID0+IHYuc3Vic3RyKDEsIHYubGVuZ3RoIC0gMikpXG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIHR5cGVJbmZvLnR5cGUgPSB0eXBlTmFtZTtcblxuICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICBjYXNlICd0ZXh0JzpcbiAgICAgICAgICAgICAgICB0eXBlSW5mby50eXBlID0gJ3RleHQnO1xuICAgICAgICAgICAgICAgIHR5cGVJbmZvLm1heExlbmd0aCA9IGNvbC5DSEFSQUNURVJfTUFYSU1VTV9MRU5HVEg7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGNhc2UgJ2RhdGV0aW1lJzpcbiAgICAgICAgICAgIGNhc2UgJ3RpbWVzdGFtcCc6XG4gICAgICAgICAgICAgICAgdHlwZUluZm8udHlwZSA9ICdkYXRldGltZSc7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGNhc2UgJ2RlY2ltYWwnOlxuICAgICAgICAgICAgICAgIHR5cGVJbmZvLnR5cGUgPSAnbnVtYmVyJztcbiAgICAgICAgICAgICAgICB0eXBlSW5mby50b3RhbERpZ2l0cyA9IGNvbC5OVU1FUklDX1BSRUNJU0lPTjtcbiAgICAgICAgICAgICAgICB0eXBlSW5mby5kZWNpbWFsRGlnaXRzID0gY29sLk5VTUVSSUNfU0NBTEU7XG4gICAgICAgICAgICAgICAgdHlwZUluZm8uZXhhY3QgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICBjYXNlICdmbG9hdCc6XG4gICAgICAgICAgICAgICAgdHlwZUluZm8udHlwZSA9ICdudW1iZXInO1xuICAgICAgICAgICAgICAgIHR5cGVJbmZvLnRvdGFsRGlnaXRzID0gY29sLk5VTUVSSUNfUFJFQ0lTSU9OO1xuICAgICAgICAgICAgICAgIHR5cGVJbmZvLmRlY2ltYWxEaWdpdHMgPSBjb2wuTlVNRVJJQ19TQ0FMRTtcbiAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhjb2wpO1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVG8gYmUgaW1wbGVtZW50ZWQuJyk7XG4gICAgICAgIH1cblxuICAgICAgICAvL18uZmluZCh0aGlzLnJldmVyc2VSdWxlcy5jb2x1bW5UeXBlT3B0aW1pemF0aW9uLCBydWxlID0+IHJ1bGUudGVzdCh0YWJsZSwgY29sKSk7XG5cbiAgICAgICAgcmV0dXJuIHR5cGVJbmZvO1xuICAgIH1cblxuICAgIF9yZWZpbmVFbnRpdHlSZWxhdGlvbnNoaXBzKG1hcE9mRW50aXRpZXMpIHtcbiAgICAgICAgbGV0IGVudGl0eUFzc29jID0ge307XG5cbiAgICAgICAgLy8xc3Qgcm91bmRcbiAgICAgICAgXy5mb3JPd24obWFwT2ZFbnRpdGllcywgKHsgZW50aXR5SW5mbyB9LCBuYW1lKSA9PiB7XG4gICAgICAgICAgICBpZiAoXy5pc0VtcHR5KGVudGl0eUluZm8uYXNzb2NpYXRpb25zKSkgcmV0dXJuOyAgICAgICAgICAgIFxuXG4gICAgICAgICAgICBlbnRpdHlJbmZvLmFzc29jaWF0aW9ucy5mb3JFYWNoKCh7IHR5cGUsIHNyY0ZpZWxkLCBkZXN0RW50aXR5IH0pID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgcmVmZWRFbnRpdHkgPSBtYXBPZkVudGl0aWVzW2Rlc3RFbnRpdHldO1xuICAgICAgICAgICAgICAgIGxldCBiYWNrUmVmID0gXy5maW5kKHJlZmVkRW50aXR5LmFzc29jaWF0aW9ucywgYXNzb2MgPT4gYXNzb2MuZGVzdEVudGl0eSA9PT0gbmFtZSk7XG5cbiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ2hhc01hbnknKSB7ICAgXG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKCFiYWNrUmVmKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvL29uZS1zaWRlIHJlbGF0aW9uXG4gICAgICAgICAgICAgICAgICAgICAgICBVdGlsLnB1dEludG9CdWNrZXQoZW50aXR5QXNzb2MsIG5hbWUsIHsgdHlwZTogJ3JlZmVyc1RvJywgc3JjRmllbGQsIGRlc3RFbnRpdHkgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAvL3RvZG86XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVudGl0eUluZm8pO1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEJhY2sgcmVmZXJlbmNlOiAke2JhY2tSZWYuZW50aXR5fSAke2JhY2tSZWYudHlwZX0gJHtuYW1lfWApOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnYmVsb25nc1RvJykge1xuXG4gICAgICAgICAgICAgICAgICAgIFV0aWwucHV0SW50b0J1Y2tldChlbnRpdHlBc3NvYywgbmFtZSwgeyB0eXBlLCBzcmNGaWVsZCwgZGVzdEVudGl0eSB9KTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoIWJhY2tSZWYpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vb25lLXNpZGUgcmVsYXRpb24gICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIFV0aWwucHV0SW50b0J1Y2tldChlbnRpdHlBc3NvYywgZW50aXR5LCB7IHR5cGU6ICdoYXNNYW55JywgZGVzdEVudGl0eTogbmFtZSB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VuZXhwZWN0ZWQgYXNzb2NpYXRpb24gdHlwZTogJyArIHR5cGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pOyAgICAgICAgICAgIFxuICAgICAgICB9KTsgICAgICAgIFxuXG4gICAgICAgIC8vMm5kIHJvdW5kXG4gICAgICAgIF8uZm9yT3duKGVudGl0eUFzc29jLCAoYXNzb2NpYXRpb25zLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICBsZXQgeyBlbnRpdHlJbmZvIH0gPSBtYXBPZkVudGl0aWVzW25hbWVdO1xuXG4gICAgICAgICAgICBsZXQga2V5QXNzb2NzO1xuXG4gICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShlbnRpdHlJbmZvLmtleSkgJiYgZW50aXR5SW5mby5rZXkubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgICAgICAga2V5QXNzb2NzID0gXy5maWx0ZXIoYXNzb2NpYXRpb25zLCBhc3NvYyA9PiBlbnRpdHlJbmZvLmtleS5pbmRleE9mKGFzc29jLnNyY0ZpZWxkKSAhPT0gLTEpO1xuICAgICAgICAgICAgICAgIGlmIChrZXlBc3NvY3MubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX21ha2VFbnRpdHlNYW55VG9NYW55KGtleUFzc29jc1swXS5kZXN0RW50aXR5LCBrZXlBc3NvY3NbMV0uZGVzdEVudGl0eSwgZW50aXR5QXNzb2MpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZW50aXR5SW5mby5pbmRleGVzLmZvckVhY2goKHsgZmllbGRzIH0pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZmllbGRzLmxlbmd0aCA9PT0gMikge1xuICAgICAgICAgICAgICAgICAgICBrZXlBc3NvY3MgPSBfLmZpbHRlcihhc3NvY2lhdGlvbnMsIGFzc29jID0+IGZpZWxkcy5pbmRleE9mKGFzc29jLnNyY0ZpZWxkKSAhPT0gLTEpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoa2V5QXNzb2NzLmxlbmd0aCA9PT0gMikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fbWFrZUVudGl0eU1hbnlUb01hbnkoa2V5QXNzb2NzWzBdLmRlc3RFbnRpdHksIGtleUFzc29jc1sxXS5kZXN0RW50aXR5LCBlbnRpdHlBc3NvYyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgXy5mb3JPd24obWFwT2ZFbnRpdGllcywgKHsgZW50aXR5SW5mbyB9LCBuYW1lKSA9PiB7XG4gICAgICAgICAgICBlbnRpdHlJbmZvLmFzc29jaWF0aW9ucyA9IGVudGl0eUFzc29jW25hbWVdO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBfbWFrZUVudGl0eU1hbnlUb01hbnkoZW50aXR5TmFtZTEsIGVudGl0eU5hbWUyLCBlbnRpdHlBc3NvYykge1xuICAgICAgICBVdGlsLnB1dEludG9CdWNrZXQoZW50aXR5QXNzb2MsIGVudGl0eU5hbWUxLCB7IHR5cGU6ICdoYXNNYW55JywgZGVzdEVudGl0eTogZW50aXR5TmFtZTIgfSk7XG4gICAgICAgIFV0aWwucHV0SW50b0J1Y2tldChlbnRpdHlBc3NvYywgZW50aXR5TmFtZTIsIHsgdHlwZTogJ2hhc01hbnknLCBkZXN0RW50aXR5OiBlbnRpdHlOYW1lMSB9KTtcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gTXlTUUxSZXZlcnNlRW5naW5lZXJpbmc7Il19