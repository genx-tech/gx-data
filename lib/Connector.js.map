{"version":3,"file":"Connector.js","names":["URL","require","_","SupportedDrivers","Connector","createConnector","driver","connectionString","options","indexOf","Error","ConnectorClass","constructor","relational","makeNewConnectionString","components","url","username","password","pathname","database","forOwn","value","key","searchParams","set","href","getConnectionStringWithoutCredential","connStr","_database","substring","driverLib","log","args","logger","module","exports"],"sources":["../src/Connector.js"],"sourcesContent":["const { URL } = require('url');\nconst { _ } = require('@genx/july');\nconst { SupportedDrivers } = require('./utils/lang');\n\n/**\n * A database storage connector object.\n * @class\n */\nclass Connector {\n    /**\n     * Create a connector.\n     * @param {*} driver\n     * @param {*} connectionString\n     * @param {*} options\n     */\n    static createConnector(driver, connectionString, options) {\n        if (SupportedDrivers.indexOf(driver) === -1) {\n            throw new Error(`Unsupported connector driver: \"${driver}\"!`);\n        }\n\n        if (!connectionString) {\n            throw new Error(`Missing required connection string`);\n        }\n\n        const ConnectorClass = require(`./drivers/${driver}/Connector`);\n\n        return new ConnectorClass(connectionString, options);\n    }\n\n    /**\n     * @param {string} driver - Data storage type\n     * @param {string} connectionString - The connection string\n     * @param {object} [options] - Connector options\n     * @property {boolean} [options.logger] - Logger instance\n     */\n    constructor(driver, connectionString, options) {\n        /**\n         * The database storage type, e.g. mysql, mongodb\n         * @member {string}\n         */\n        this.driver = driver;\n\n        /**\n         * The default URL style connection string, e.g. mysql://username:password@host:port/dbname\n         * @member {string}\n         */\n        this.connectionString = connectionString;\n\n        /**\n         * Connector options\n         * @member {object}\n         */\n        this.options = options || {};\n\n        /**\n         * Is the database a relational database\n         * @member {boolean}\n         */\n        this.relational = false;\n    }\n\n    /**\n     * Make a new connection components from current connection string and given components.\n     * @param {object} components\n     * @property {string} [components.username]\n     * @property {string} [components.password]\n     * @property {string} [components.database]\n     * @property {object} [components.options]\n     */\n    makeNewConnectionString(components) {\n        const url = new URL(this.connectionString);\n\n        if ('username' in components) {\n            url.username = components.username;\n        }\n\n        if ('password' in components) {\n            url.password = components.password;\n        }\n\n        if ('database' in components) {\n            url.pathname = '/' + components.database;\n        }\n\n        if ('options' in components) {\n            const options = components.options;\n\n            _.forOwn(options, (value, key) => {\n                url.searchParams.set(\n                    key,\n                    typeof value === 'boolean' ? (value ? 1 : 0) : value\n                );\n            });\n        }\n\n        return url.href;\n    }\n\n    /**\n     * Get the connection without credential information, usually used for displaying.\n     * @returns {string}\n     */\n    getConnectionStringWithoutCredential(connStr) {\n        const url = new URL(connStr || this.connectionString);\n\n        url.username = '';\n        url.password = '';\n\n        return url.href;\n    }\n\n    /**\n     * Database name.\n     * @member {string}\n     */\n    get database() {\n        if (!this._database) {\n            this._database = new URL(this.connectionString).pathname.substring(1);\n        }\n\n        return this._database;\n    }\n\n    /**\n     * Client library.\n     * @member {object}\n     */\n    get driverLib() {\n        return this.constructor.driverLib;\n    }\n\n    /**\n     * Write log.\n     * @param  {...any} args\n     */\n    log(...args) {\n        if (this.options.logger) {\n            this.options.logger.log(...args);\n        }\n    }\n\n    /**\n     * Log query.\n     */\n\n    /*\n    async connect_() {}\n\n    async disconnect_() {}\n\n    async ping_() {}\n\n    async execute_() {}\n\n    async end_() {}\n    */\n}\n\nmodule.exports = Connector;\n"],"mappings":";;;;AAAA,MAAM;EAAEA;AAAF,IAAUC,OAAO,CAAC,KAAD,CAAvB;;AACA,MAAM;EAAEC;AAAF,IAAQD,OAAO,CAAC,YAAD,CAArB;;AACA,MAAM;EAAEE;AAAF,IAAuBF,OAAO,CAAC,cAAD,CAApC;;AAMA,MAAMG,SAAN,CAAgB;EAOU,OAAfC,eAAe,CAACC,MAAD,EAASC,gBAAT,EAA2BC,OAA3B,EAAoC;IACtD,IAAIL,gBAAgB,CAACM,OAAjB,CAAyBH,MAAzB,MAAqC,CAAC,CAA1C,EAA6C;MACzC,MAAM,IAAII,KAAJ,CAAW,kCAAiCJ,MAAO,IAAnD,CAAN;IACH;;IAED,IAAI,CAACC,gBAAL,EAAuB;MACnB,MAAM,IAAIG,KAAJ,CAAW,oCAAX,CAAN;IACH;;IAED,MAAMC,cAAc,GAAGV,OAAO,CAAE,aAAYK,MAAO,YAArB,CAA9B;;IAEA,OAAO,IAAIK,cAAJ,CAAmBJ,gBAAnB,EAAqCC,OAArC,CAAP;EACH;;EAQDI,WAAW,CAACN,MAAD,EAASC,gBAAT,EAA2BC,OAA3B,EAAoC;IAK3C,KAAKF,MAAL,GAAcA,MAAd;IAMA,KAAKC,gBAAL,GAAwBA,gBAAxB;IAMA,KAAKC,OAAL,GAAeA,OAAO,IAAI,EAA1B;IAMA,KAAKK,UAAL,GAAkB,KAAlB;EACH;;EAUDC,uBAAuB,CAACC,UAAD,EAAa;IAChC,MAAMC,GAAG,GAAG,IAAIhB,GAAJ,CAAQ,KAAKO,gBAAb,CAAZ;;IAEA,IAAI,cAAcQ,UAAlB,EAA8B;MAC1BC,GAAG,CAACC,QAAJ,GAAeF,UAAU,CAACE,QAA1B;IACH;;IAED,IAAI,cAAcF,UAAlB,EAA8B;MAC1BC,GAAG,CAACE,QAAJ,GAAeH,UAAU,CAACG,QAA1B;IACH;;IAED,IAAI,cAAcH,UAAlB,EAA8B;MAC1BC,GAAG,CAACG,QAAJ,GAAe,MAAMJ,UAAU,CAACK,QAAhC;IACH;;IAED,IAAI,aAAaL,UAAjB,EAA6B;MACzB,MAAMP,OAAO,GAAGO,UAAU,CAACP,OAA3B;;MAEAN,CAAC,CAACmB,MAAF,CAASb,OAAT,EAAkB,CAACc,KAAD,EAAQC,GAAR,KAAgB;QAC9BP,GAAG,CAACQ,YAAJ,CAAiBC,GAAjB,CACIF,GADJ,EAEI,OAAOD,KAAP,KAAiB,SAAjB,GAA8BA,KAAK,GAAG,CAAH,GAAO,CAA1C,GAA+CA,KAFnD;MAIH,CALD;IAMH;;IAED,OAAON,GAAG,CAACU,IAAX;EACH;;EAMDC,oCAAoC,CAACC,OAAD,EAAU;IAC1C,MAAMZ,GAAG,GAAG,IAAIhB,GAAJ,CAAQ4B,OAAO,IAAI,KAAKrB,gBAAxB,CAAZ;IAEAS,GAAG,CAACC,QAAJ,GAAe,EAAf;IACAD,GAAG,CAACE,QAAJ,GAAe,EAAf;IAEA,OAAOF,GAAG,CAACU,IAAX;EACH;;EAMW,IAARN,QAAQ,GAAG;IACX,IAAI,CAAC,KAAKS,SAAV,EAAqB;MACjB,KAAKA,SAAL,GAAiB,IAAI7B,GAAJ,CAAQ,KAAKO,gBAAb,EAA+BY,QAA/B,CAAwCW,SAAxC,CAAkD,CAAlD,CAAjB;IACH;;IAED,OAAO,KAAKD,SAAZ;EACH;;EAMY,IAATE,SAAS,GAAG;IACZ,OAAO,KAAKnB,WAAL,CAAiBmB,SAAxB;EACH;;EAMDC,GAAG,CAAC,GAAGC,IAAJ,EAAU;IACT,IAAI,KAAKzB,OAAL,CAAa0B,MAAjB,EAAyB;MACrB,KAAK1B,OAAL,CAAa0B,MAAb,CAAoBF,GAApB,CAAwB,GAAGC,IAA3B;IACH;EACJ;;AAnIW;;AAsJhBE,MAAM,CAACC,OAAP,GAAiBhC,SAAjB"}