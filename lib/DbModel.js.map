{"version":3,"sources":["../src/DbModel.js"],"names":["_","naming","sleep_","require","fs","InvalidArgument","retryFailed","error","retryOK","result","directReturn","a","DbModel","constructor","app","connector","i18n","_modelCache","driver","model","entityName","modelClassName","pascalCase","entityCustomClassFactory","loadCustomModel","entityClassFactory","loadModel","modelClass","meta","packagePath","entityClassFromPackage","loadPackageModel","db","__init","customModelPath","toAbsolutePath","process","env","NODE_RT","existsSync","entitiesOfType","baseEntityName","filter","entities","Model","baseClasses","indexOf","retry_","transactionName","action_","connOptions","maxRetry","interval","onRetry_","connection","i","finished","logException","safeRetry_","ok","failed","doTransaction_","connOpts","close_","module","exports"],"mappings":"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","sourcesContent":["const { _, naming, sleep_ } = require('@genx/july');\nconst { fs } = require('@genx/sys');\nconst { InvalidArgument } = require('@genx/error');\n\nconst retryFailed = (error) => [false, error];\nconst retryOK = (result) => [true, result];\n\nconst directReturn = (a) => a;\n\nclass DbModel {\n    constructor(app, connector, i18n) {\n        this.app = app;\n        this.connector = connector;\n        this.i18n = i18n;\n\n        this._modelCache = {};\n    }\n\n    get driver() {\n        return this.connector.driver;\n    }\n\n    /**\n     * Get entity model class by entity name.\n     * @param {*} entityName\n     */\n    model(entityName) {\n        if (!entityName) {\n            throw new InvalidArgument('Entity name is required.')\n        }\n\n        if (this._modelCache[entityName]) return this._modelCache[entityName];\n\n        const modelClassName = naming.pascalCase(entityName);\n        if (this._modelCache[modelClassName])\n            return this._modelCache[modelClassName];\n\n        const entityCustomClassFactory = this.loadCustomModel(modelClassName);\n        const entityClassFactory = this.loadModel(modelClassName);\n\n        let modelClass = require(`./drivers/${this.driver}/EntityModel`);\n        modelClass = entityClassFactory(modelClass);\n\n        if (modelClass.meta.packagePath) {\n            const entityClassFromPackage = this.loadPackageModel(modelClass.meta.packagePath, modelClassName);\n            if (entityClassFromPackage) {\n                modelClass = entityClassFromPackage(modelClass);\n            }\n        }\n\n        if (entityCustomClassFactory) {\n            modelClass = entityCustomClassFactory(modelClass);\n        }\n\n        modelClass.db = this;\n\n        if (modelClass.__init) {\n            modelClass.__init();\n        }\n\n        this._modelCache[entityName] = modelClass;\n        if (modelClassName !== entityName) {\n            this._modelCache[modelClassName] = modelClass;\n        }\n\n        return modelClass;\n    }\n\n    loadPackageModel(packagePath, modelClassName) { \n        const customModelPath = this.app.toAbsolutePath(packagePath,  (process.env.NODE_RT && process.env.NODE_RT === 'babel') ? 'src' : 'lib', 'models', `${modelClassName}.js`);           \n        return fs.existsSync(customModelPath) && require(customModelPath);\n    }\n\n    entitiesOfType(baseEntityName) {\n        return _.filter(this.entities, (entityName) => {\n            const Model = this.model(entityName);\n            return (\n                Model.baseClasses &&\n                Model.baseClasses.indexOf(baseEntityName) > -1\n            );\n        });\n    }\n\n    /**\n     * Run an action and automatically retry when failed.\n     * @param {*} transactionName\n     * @param {*} action_\n     * @param {*} connOptions\n     * @param {*} maxRetry\n     * @param {*} interval\n     * @param {*} onRetry_\n     */\n    async retry_(\n        transactionName,\n        action_,\n        connOptions,\n        maxRetry,\n        interval,\n        onRetry_\n    ) {\n        // retry will be ignored, if the transaction is a part of another transaction\n        if (connOptions && connOptions.connection) {\n            return action_(directReturn, directReturn);\n        }\n\n        let i = 0;\n        if (maxRetry == null) maxRetry = 2;\n\n        while (i++ < maxRetry) {\n            const [finished, result] = await action_(retryOK, retryFailed);\n\n            if (finished) {\n                return result;\n            }\n\n            if (i === maxRetry) {\n                throw result;\n            }\n\n            this.app.logException(\n                'warn',\n                result,\n                `Unable to complete \"${transactionName}\" and will try ${\n                    maxRetry - i\n                } more times after ${interval || 0} ms.`\n            );\n\n            if (interval != null) {\n                await sleep_(interval);\n            }\n\n            if (onRetry_) {\n                await onRetry_();\n            }\n        }\n    }\n\n    /**\n     * Run an action as transaction and automatically retry when failed.\n     * @param {*} transactionName\n     * @param {*} action_\n     * @param {*} connOptions\n     * @param {*} maxRetry\n     * @param {*} interval\n     * @param {*} onRetry_\n     */\n    async safeRetry_(\n        transactionName,\n        action_,\n        connOptions,\n        maxRetry,\n        interval,\n        onRetry_\n    ) {\n        return this.retry_(\n            transactionName,\n            (ok, failed) =>\n                this.doTransaction_(\n                    async (connOpts) => ok(await action_(connOpts)),\n                    failed,\n                    connOptions\n                ),\n            connOptions,\n            maxRetry,\n            interval,\n            onRetry_\n        );\n    }\n\n    async close_() {\n        delete this._modelCache;\n        delete this.connector;\n        delete this.app;\n    }\n}\n\nmodule.exports = DbModel;\n"],"file":"DbModel.js"}