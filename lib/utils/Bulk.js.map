{"version":3,"sources":["../../src/utils/Bulk.js"],"names":["waitUntil_","require","Bulk","constructor","limit","bulkAction","total","itemsTotal","itemsPending","itemsDone","itemsError","_buffer","batch","flush","length","bulkItems","concat","l","Promise","resolve","then","onProgress","catch","error","onError","add","item","push","waitToEnd_","interval","maxRounds","module","exports"],"mappings":";;;;AAAA,MAAM;AAAEA,EAAAA;AAAF,IAAiBC,OAAO,CAAC,YAAD,CAA9B;;AAEA,MAAMC,IAAN,CAAW;AACPC,EAAAA,WAAW,CAACC,KAAD,EAAQC,UAAR,EAAoBC,KAApB,EAA2B;AAClC,SAAKF,KAAL,GAAaA,KAAb;AACA,SAAKG,UAAL,GAAkBD,KAAlB;AACA,SAAKD,UAAL,GAAkBA,UAAlB;AAEA,SAAKG,YAAL,GAAoB,CAApB;AACA,SAAKC,SAAL,GAAiB,CAAjB;AACA,SAAKC,UAAL,GAAkB,CAAlB;AACA,SAAKC,OAAL,GAAe,EAAf;AACA,SAAKC,KAAL,GAAa,CAAb;AACH;;AAEDC,EAAAA,KAAK,GAAG;AACJ,QAAI,KAAKF,OAAL,CAAaG,MAAb,GAAsB,CAA1B,EAA6B;AACzB,UAAIC,SAAS,GAAG,KAAKJ,OAAL,CAAaK,MAAb,EAAhB;;AACA,WAAKL,OAAL,GAAe,EAAf;AAEA,UAAIM,CAAC,GAAGF,SAAS,CAACD,MAAlB;AACA,WAAKN,YAAL,IAAqBS,CAArB;AAEAC,MAAAA,OAAO,CAACC,OAAR,CAAgB,KAAKd,UAAL,CAAgBU,SAAhB,EAA2B,KAAKH,KAAL,EAA3B,CAAhB,EACKQ,IADL,CACU,YAAY;AACd,aAAKX,SAAL,IAAkBQ,CAAlB;;AAEA,YAAI,KAAKI,UAAT,EAAqB;AACjB,eAAKA,UAAL,CACI,KAAKb,YADT,EAEI,KAAKC,SAFT,EAGI,KAAKF,UAHT;AAKH;AACJ,OAXL,EAYKe,KAZL,CAYYC,KAAD,IAAW;AACd,aAAKd,SAAL,IAAkBQ,CAAlB;AACA,aAAKP,UAAL,IAAmBO,CAAnB;;AAEA,YAAI,KAAKO,OAAT,EAAkB;AACd,eAAKA,OAAL,CAAaD,KAAb,EAAoB,KAAKb,UAAzB;AACH;AACJ,OAnBL;AAoBH;AACJ;;AAEDe,EAAAA,GAAG,CAACC,IAAD,EAAO;AACN,SAAKf,OAAL,CAAagB,IAAb,CAAkBD,IAAlB;;AAEA,QAAI,KAAKf,OAAL,CAAaG,MAAb,IAAuB,KAAKV,KAAhC,EAAuC;AACnC,WAAKS,KAAL;AACH;AACJ;;AAEe,QAAVe,UAAU,CAACC,QAAD,EAAWC,SAAX,EAAsB;AAClC,SAAKjB,KAAL;AACA,WAAOb,UAAU,CACb,MAAM,KAAKS,SAAL,IAAkB,KAAKD,YADhB,EAEbqB,QAFa,EAGbC,SAHa,CAAjB;AAKH;;AA3DM;;AA8DXC,MAAM,CAACC,OAAP,GAAiB9B,IAAjB","sourcesContent":["const { waitUntil_ } = require('@genx/july');\n\nclass Bulk {\n    constructor(limit, bulkAction, total) {\n        this.limit = limit;\n        this.itemsTotal = total;\n        this.bulkAction = bulkAction;\n\n        this.itemsPending = 0;\n        this.itemsDone = 0;\n        this.itemsError = 0;\n        this._buffer = [];\n        this.batch = 0;\n    }\n\n    flush() {\n        if (this._buffer.length > 0) {\n            let bulkItems = this._buffer.concat();\n            this._buffer = [];\n\n            let l = bulkItems.length;\n            this.itemsPending += l;\n\n            Promise.resolve(this.bulkAction(bulkItems, this.batch++))\n                .then(async () => {\n                    this.itemsDone += l;\n\n                    if (this.onProgress) {\n                        this.onProgress(\n                            this.itemsPending,\n                            this.itemsDone,\n                            this.itemsTotal\n                        );\n                    }\n                })\n                .catch((error) => {\n                    this.itemsDone += l;\n                    this.itemsError += l;\n\n                    if (this.onError) {\n                        this.onError(error, this.itemsError);\n                    }\n                });\n        }\n    }\n\n    add(item) {\n        this._buffer.push(item);\n\n        if (this._buffer.length >= this.limit) {\n            this.flush();\n        }\n    }\n\n    async waitToEnd_(interval, maxRounds) {\n        this.flush();\n        return waitUntil_(\n            () => this.itemsDone >= this.itemsPending,\n            interval,\n            maxRounds\n        );\n    }\n}\n\nmodule.exports = Bulk;\n"],"file":"Bulk.js"}