"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const OP_EQUAL = ['$eq', '$eql', '$equal'];
const OP_NOT_EQUAL = ['$ne', '$neq', '$notEqual'];
const OP_GREATER_THAN = ['$gt', '$>', '$greaterThan'];
const OP_GREATER_THAN_OR_EQUAL = ['$gte', '$<=', '$greaterThanOrEqual'];
const OP_LESS_THAN = ['$lt', '$<', '$lessThan'];
const OP_LESS_THAN_OR_EQUAL = ['$lte', '$<=', '$lessThanOrEqual'];
const OP_IN = ['$in'];
const OP_NOT_IN = ['$nin', '$notIn'];
const OP_EXISTS = ['$exist', '$exists'];
const OP_HAS = ['$has'];
const OP_TYPE = ['$type'];
const MapOfOps = new Map();

const addOpToMap = (tokens, tag) => tokens.forEach(token => MapOfOps.set(token, tag));

addOpToMap(OP_EQUAL, 'OP_EQUAL');
addOpToMap(OP_NOT_EQUAL, 'OP_NOT_EQUAL');
addOpToMap(OP_GREATER_THAN, 'OP_GREATER_THAN');
addOpToMap(OP_GREATER_THAN_OR_EQUAL, 'OP_GREATER_THAN_OR_EQUAL');
addOpToMap(OP_LESS_THAN, 'OP_LESS_THAN');
addOpToMap(OP_LESS_THAN_OR_EQUAL, 'OP_LESS_THAN_OR_EQUAL');
addOpToMap(OP_IN, 'OP_IN');
addOpToMap(OP_NOT_IN, 'OP_NOT_IN');
addOpToMap(OP_EXISTS, 'OP_EXISTS');
addOpToMap(OP_HAS, 'OP_HAS');
addOpToMap(OP_TYPE, 'OP_TYPE');
const OP_ELEMENT_ALL = ['$all'];
const OP_ELEMENT_ANY = ['$any'];
const defaultJesHandlers = {
  OP_EQUAL: (left, right) => _.isEqual(left, right),
  OP_NOT_EQUAL: (left, right) => !_.isEqual(left, right),
  OP_GREATER_THAN: (left, right) => left > right,
  OP_GREATER_THAN_OR_EQUAL: (left, right) => left >= right,
  OP_LESS_THAN: (left, right) => left < right,
  OP_LESS_THAN_OR_EQUAL: (left, right) => left <= right,
  OP_IN: (left, right) => {
    if (right == null) return false;

    if (!Array.isArray(right)) {
      throw new Error('The right operand of JES operator "OP_IN" should be an array.');
    }

    return right.find(element => defaultJesHandlers.OP_EQUAL(left, element));
  },
  OP_NOT_IN: (left, right) => {
    if (right == null) return true;

    if (!Array.isArray(right)) {
      throw new Error('The right operand of JES operator "OP_NOT_IN" should be an array.');
    }

    return _.every(right, element => defaultJesHandlers.OP_NOT_EQUAL(left, element));
  },
  OP_EXISTS: (left, right) => {
    if (typeof right !== 'boolean') {
      throw new Error('The right operand of JES operator "OP_EXISTS" should be a boolean value.');
    }

    console.log(left, right);
    return right ? left != null : left == null;
  },
  OP_TYPE: (left, right) => {
    if (typeof right !== 'string') {
      throw new Error('The right operand of JES operator "OP_TYPE" should be a string.');
    }

    return typeof left === right;
  }
};

const formatName = name => name ? `"${name}"` : 'The value';

const defaultJesExplanations = {
  OP_EQUAL: (name, right) => `${formatName(name)} should be ${JSON.stringify(right)}.`,
  OP_NOT_EQUAL: (name, right) => `${formatName(name)} should not be ${JSON.stringify(right)}.`,
  OP_GREATER_THAN: (name, right) => `${formatName(name)} should be greater than ${right}.`,
  OP_GREATER_THAN_OR_EQUAL: (name, right) => `${formatName(name)} should be greater than or equal to ${right}.`,
  OP_LESS_THAN: (name, right) => `${formatName(name)} should be less than ${right}.`,
  OP_LESS_THAN_OR_EQUAL: (name, right) => `${formatName(name)} should be less than or equal to ${right}.`,
  OP_IN: (name, right) => `${formatName(name)} should be one of ${JSON.stringify(right)}.`,
  OP_NOT_IN: (name, right) => `${formatName(name)} should not be any one of ${JSON.stringify(right)}.`,
  OP_EXISTS: (name, right) => `${formatName(name)} should${right ? ' not ' : ' '}be NULL.`,
  OP_TYPE: (name, right) => `The type of ${formatName(name)} should be "${right}".`
};

function test(value, op, opValue, jes = defaultCustomizer) {
  const handler = jes.operatorHandlers[op];

  if (!handler) {
    throw new Error(`JES operator "${op}" handler not found.`);
  }

  return handler(value, opValue);
}

const defaultCustomizer = {
  operatorHandlers: defaultJesHandlers,
  operatorEplanations: defaultJesExplanations,
  has: has
};

function has(actual, expected, prefix, jes = defaultCustomizer) {
  let passObjectCheck = false;

  for (let fieldName in expected) {
    let expectedFieldValue = expected[fieldName];

    if (fieldName.length > 1 && fieldName[0] === '$') {
      const op = MapOfOps.get(fieldName);

      if (!op) {
        throw new Error(`Invalid JES operator token "${fieldName}".`);
      }

      if (!test(actual, op, expectedFieldValue, jes)) {
        return [false, jes.operatorEplanations[op](prefix, expectedFieldValue)];
      }

      continue;
    }

    if (!passObjectCheck) {
      if (actual == null) return [false, jes.operatorEplanations.OP_EXISTS(prefix, true)];
      if (typeof actual !== 'object') return [false, jes.operatorEplanations.OP_TYPE(prefix, 'object')];
    }

    passObjectCheck = true;
    let actualFieldValue = actual[fieldName];

    if (expectedFieldValue != null && typeof expectedFieldValue === 'object') {
      const [ok, reason] = has(actualFieldValue, expectedFieldValue, prefix ? prefix + '.' + fieldName : fieldName, jes);

      if (!ok) {
        return [false, reason];
      }
    } else {
      if (!test(actualFieldValue, 'OP_EQUAL', expectedFieldValue, jes)) {
        return [false, jes.operatorEplanations.OP_EQUAL(prefix ? prefix + '.' + fieldName : fieldName, expectedFieldValue)];
      }
    }
  }

  return [true];
}

exports.test = test;
exports.has = has;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9leHByZXNzaW9uLmpzIl0sIm5hbWVzIjpbIl8iLCJyZXF1aXJlIiwiT1BfRVFVQUwiLCJPUF9OT1RfRVFVQUwiLCJPUF9HUkVBVEVSX1RIQU4iLCJPUF9HUkVBVEVSX1RIQU5fT1JfRVFVQUwiLCJPUF9MRVNTX1RIQU4iLCJPUF9MRVNTX1RIQU5fT1JfRVFVQUwiLCJPUF9JTiIsIk9QX05PVF9JTiIsIk9QX0VYSVNUUyIsIk9QX0hBUyIsIk9QX1RZUEUiLCJNYXBPZk9wcyIsIk1hcCIsImFkZE9wVG9NYXAiLCJ0b2tlbnMiLCJ0YWciLCJmb3JFYWNoIiwidG9rZW4iLCJzZXQiLCJPUF9FTEVNRU5UX0FMTCIsIk9QX0VMRU1FTlRfQU5ZIiwiZGVmYXVsdEplc0hhbmRsZXJzIiwibGVmdCIsInJpZ2h0IiwiaXNFcXVhbCIsIkFycmF5IiwiaXNBcnJheSIsIkVycm9yIiwiZmluZCIsImVsZW1lbnQiLCJldmVyeSIsImNvbnNvbGUiLCJsb2ciLCJmb3JtYXROYW1lIiwibmFtZSIsImRlZmF1bHRKZXNFeHBsYW5hdGlvbnMiLCJKU09OIiwic3RyaW5naWZ5IiwidGVzdCIsInZhbHVlIiwib3AiLCJvcFZhbHVlIiwiamVzIiwiZGVmYXVsdEN1c3RvbWl6ZXIiLCJoYW5kbGVyIiwib3BlcmF0b3JIYW5kbGVycyIsIm9wZXJhdG9yRXBsYW5hdGlvbnMiLCJoYXMiLCJhY3R1YWwiLCJleHBlY3RlZCIsInByZWZpeCIsInBhc3NPYmplY3RDaGVjayIsImZpZWxkTmFtZSIsImV4cGVjdGVkRmllbGRWYWx1ZSIsImxlbmd0aCIsImdldCIsImFjdHVhbEZpZWxkVmFsdWUiLCJvayIsInJlYXNvbiIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7QUFDQSxNQUFNO0FBQUVBLEVBQUFBO0FBQUYsSUFBUUMsT0FBTyxDQUFDLFVBQUQsQ0FBckI7O0FBR0EsTUFBTUMsUUFBUSxHQUFHLENBQUUsS0FBRixFQUFTLE1BQVQsRUFBaUIsUUFBakIsQ0FB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dEIsSUFBOEIsT0FBT0Esa0JBQVAsS0FBOEIsUUFBaEUsRUFBMEU7QUFDdEUsWUFBTSxDQUFFSSxFQUFGLEVBQU1DLE1BQU4sSUFBaUJYLEdBQUcsQ0FBQ1MsZ0JBQUQsRUFBbUJILGtCQUFuQixFQUF1Q0gsTUFBTSxHQUFJQSxNQUFNLEdBQUcsR0FBVCxHQUFlRSxTQUFuQixHQUFnQ0EsU0FBN0UsRUFBd0ZWLEdBQXhGLENBQTFCOztBQUNBLFVBQUksQ0FBQ2UsRUFBTCxFQUFTO0FBQ0wsZUFBTyxDQUFFLEtBQUYsRUFBU0MsTUFBVCxDQUFQO0FBQ0g7QUFDSixLQUxELE1BS087QUFDSCxVQUFJLENBQUNwQixJQUFJLENBQUNrQixnQkFBRCxFQUFtQixVQUFuQixFQUErQkgsa0JBQS9CLEVBQW1EWCxHQUFuRCxDQUFULEVBQWtFO0FBQzlELGVBQU8sQ0FDSCxLQURHLEVBRUhBLEdBQUcsQ0FBQ0ksbUJBQUosQ0FBd0I5QyxRQUF4QixDQUFpQ2tELE1BQU0sR0FBSUEsTUFBTSxHQUFHLEdBQVQsR0FBZUUsU0FBbkIsR0FBZ0NBLFNBQXZFLEVBQWtGQyxrQkFBbEYsQ0FGRyxDQUFQO0FBSUg7QUFDSjtBQUNKOztBQUVELFNBQU8sQ0FBQyxJQUFELENBQVA7QUFDSDs7QUFFRE0sT0FBTyxDQUFDckIsSUFBUixHQUFlQSxJQUFmO0FBQ0FxQixPQUFPLENBQUNaLEdBQVIsR0FBY0EsR0FBZCIsInNvdXJjZXNDb250ZW50IjpbIi8vIEpTT04gRXhwcmVzc2lvbiBTeW50YXggKEpFUylcbmNvbnN0IHsgXyB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcblxuLy9Db25kaXRpb24gb3BlcmF0b3JcbmNvbnN0IE9QX0VRVUFMID0gWyAnJGVxJywgJyRlcWwnLCAnJGVxdWFsJyBdO1xuY29uc3QgT1BfTk9UX0VRVUFMID0gWyAnJG5lJywgJyRuZXEnLCAnJG5vdEVxdWFsJyBdO1xuXG5jb25zdCBPUF9HUkVBVEVSX1RIQU4gPSBbICckZ3QnLCAnJD4nLCAnJGdyZWF0ZXJUaGFuJyBdO1xuY29uc3QgT1BfR1JFQVRFUl9USEFOX09SX0VRVUFMID0gWyAnJGd0ZScsICckPD0nLCAnJGdyZWF0ZXJUaGFuT3JFcXVhbCcgXTtcblxuY29uc3QgT1BfTEVTU19USEFOID0gWyAnJGx0JywgJyQ8JywgJyRsZXNzVGhhbicgXTtcbmNvbnN0IE9QX0xFU1NfVEhBTl9PUl9FUVVBTCA9IFsgJyRsdGUnLCAnJDw9JywgJyRsZXNzVGhhbk9yRXF1YWwnIF07XG5cbmNvbnN0IE9QX0lOID0gWyAnJGluJyBdO1xuY29uc3QgT1BfTk9UX0lOID0gWyAnJG5pbicsICckbm90SW4nIF07XG5cbmNvbnN0IE9QX0VYSVNUUyA9IFsgJyRleGlzdCcsICckZXhpc3RzJyBdO1xuXG5jb25zdCBPUF9IQVMgPSBbICckaGFzJyBdO1xuXG5jb25zdCBPUF9UWVBFID0gWyAnJHR5cGUnIF07XG5cbmNvbnN0IE1hcE9mT3BzID0gbmV3IE1hcCgpO1xuY29uc3QgYWRkT3BUb01hcCA9ICh0b2tlbnMsIHRhZykgPT4gdG9rZW5zLmZvckVhY2godG9rZW4gPT4gTWFwT2ZPcHMuc2V0KHRva2VuLCB0YWcpKTtcbmFkZE9wVG9NYXAoT1BfRVFVQUwsICdPUF9FUVVBTCcpO1xuYWRkT3BUb01hcChPUF9OT1RfRVFVQUwsICdPUF9OT1RfRVFVQUwnKTtcbmFkZE9wVG9NYXAoT1BfR1JFQVRFUl9USEFOLCAnT1BfR1JFQVRFUl9USEFOJyk7XG5hZGRPcFRvTWFwKE9QX0dSRUFURVJfVEhBTl9PUl9FUVVBTCwgJ09QX0dSRUFURVJfVEhBTl9PUl9FUVVBTCcpO1xuYWRkT3BUb01hcChPUF9MRVNTX1RIQU4sICdPUF9MRVNTX1RIQU4nKTtcbmFkZE9wVG9NYXAoT1BfTEVTU19USEFOX09SX0VRVUFMLCAnT1BfTEVTU19USEFOX09SX0VRVUFMJyk7XG5hZGRPcFRvTWFwKE9QX0lOLCAnT1BfSU4nKTtcbmFkZE9wVG9NYXAoT1BfTk9UX0lOLCAnT1BfTk9UX0lOJyk7XG5hZGRPcFRvTWFwKE9QX0VYSVNUUywgJ09QX0VYSVNUUycpO1xuYWRkT3BUb01hcChPUF9IQVMsICdPUF9IQVMnKTtcbmFkZE9wVG9NYXAoT1BfVFlQRSwgJ09QX1RZUEUnKTtcblxuLy9BcnJheSBjb25kaXRpb24gb3BlcmF0b3JcbmNvbnN0IE9QX0VMRU1FTlRfQUxMID0gWyAnJGFsbCcgXTtcbmNvbnN0IE9QX0VMRU1FTlRfQU5ZID0gWyAnJGFueScgXTtcblxuY29uc3QgZGVmYXVsdEplc0hhbmRsZXJzID0ge1xuICAgIE9QX0VRVUFMOiAobGVmdCwgcmlnaHQpID0+IF8uaXNFcXVhbChsZWZ0LCByaWdodCksXG4gICAgT1BfTk9UX0VRVUFMOiAobGVmdCwgcmlnaHQpID0+ICFfLmlzRXF1YWwobGVmdCwgcmlnaHQpLFxuICAgIE9QX0dSRUFURVJfVEhBTjogKGxlZnQsIHJpZ2h0KSA9PiBsZWZ0ID4gcmlnaHQsXG4gICAgT1BfR1JFQVRFUl9USEFOX09SX0VRVUFMOiAobGVmdCwgcmlnaHQpID0+IGxlZnQgPj0gcmlnaHQsXG4gICAgT1BfTEVTU19USEFOOiAobGVmdCwgcmlnaHQpID0+IGxlZnQgPCByaWdodCxcbiAgICBPUF9MRVNTX1RIQU5fT1JfRVFVQUw6IChsZWZ0LCByaWdodCkgPT4gbGVmdCA8PSByaWdodCxcbiAgICBPUF9JTjogKGxlZnQsIHJpZ2h0KSA9PiB7XG4gICAgICAgIGlmIChyaWdodCA9PSBudWxsKSByZXR1cm4gZmFsc2U7XG4gICAgICAgIGlmICghQXJyYXkuaXNBcnJheShyaWdodCkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVGhlIHJpZ2h0IG9wZXJhbmQgb2YgSkVTIG9wZXJhdG9yIFwiT1BfSU5cIiBzaG91bGQgYmUgYW4gYXJyYXkuJyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJpZ2h0LmZpbmQoZWxlbWVudCA9PiBkZWZhdWx0SmVzSGFuZGxlcnMuT1BfRVFVQUwobGVmdCwgZWxlbWVudCkpO1xuICAgIH0sXG4gICAgT1BfTk9UX0lOOiAobGVmdCwgcmlnaHQpID0+IHtcbiAgICAgICAgaWYgKHJpZ2h0ID09IG51bGwpIHJldHVybiB0cnVlO1xuICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkocmlnaHQpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RoZSByaWdodCBvcGVyYW5kIG9mIEpFUyBvcGVyYXRvciBcIk9QX05PVF9JTlwiIHNob3VsZCBiZSBhbiBhcnJheS4nKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gXy5ldmVyeShyaWdodCwgZWxlbWVudCA9PiBkZWZhdWx0SmVzSGFuZGxlcnMuT1BfTk9UX0VRVUFMKGxlZnQsIGVsZW1lbnQpKTtcbiAgICB9LFxuICAgIE9QX0VYSVNUUzogKGxlZnQsIHJpZ2h0KSA9PiB7XG4gICAgICAgIGlmICh0eXBlb2YgcmlnaHQgIT09ICdib29sZWFuJykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUaGUgcmlnaHQgb3BlcmFuZCBvZiBKRVMgb3BlcmF0b3IgXCJPUF9FWElTVFNcIiBzaG91bGQgYmUgYSBib29sZWFuIHZhbHVlLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc29sZS5sb2cobGVmdCwgcmlnaHQpO1xuXG4gICAgICAgIHJldHVybiByaWdodCA/IGxlZnQgIT0gbnVsbCA6IGxlZnQgPT0gbnVsbDtcbiAgICB9LFxuICAgIE9QX1RZUEU6IChsZWZ0LCByaWdodCkgPT4ge1xuICAgICAgICBpZiAodHlwZW9mIHJpZ2h0ICE9PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUaGUgcmlnaHQgb3BlcmFuZCBvZiBKRVMgb3BlcmF0b3IgXCJPUF9UWVBFXCIgc2hvdWxkIGJlIGEgc3RyaW5nLicpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0eXBlb2YgbGVmdCA9PT0gcmlnaHQ7XG4gICAgfVxufTtcblxuY29uc3QgZm9ybWF0TmFtZSA9IChuYW1lKSA9PiBuYW1lID8gYFwiJHtuYW1lfVwiYCA6ICdUaGUgdmFsdWUnO1xuXG5jb25zdCBkZWZhdWx0SmVzRXhwbGFuYXRpb25zID0ge1xuICAgIE9QX0VRVUFMOiAobmFtZSwgcmlnaHQpID0+IGAke2Zvcm1hdE5hbWUobmFtZSl9IHNob3VsZCBiZSAke0pTT04uc3RyaW5naWZ5KHJpZ2h0KX0uYCxcbiAgICBPUF9OT1RfRVFVQUw6IChuYW1lLCByaWdodCkgPT4gYCR7Zm9ybWF0TmFtZShuYW1lKX0gc2hvdWxkIG5vdCBiZSAke0pTT04uc3RyaW5naWZ5KHJpZ2h0KX0uYCxcbiAgICBPUF9HUkVBVEVSX1RIQU46IChuYW1lLCByaWdodCkgPT4gYCR7Zm9ybWF0TmFtZShuYW1lKX0gc2hvdWxkIGJlIGdyZWF0ZXIgdGhhbiAke3JpZ2h0fS5gLFxuICAgIE9QX0dSRUFURVJfVEhBTl9PUl9FUVVBTDogKG5hbWUsIHJpZ2h0KSA9PiBgJHtmb3JtYXROYW1lKG5hbWUpfSBzaG91bGQgYmUgZ3JlYXRlciB0aGFuIG9yIGVxdWFsIHRvICR7cmlnaHR9LmAsXG4gICAgT1BfTEVTU19USEFOOiAobmFtZSwgcmlnaHQpID0+IGAke2Zvcm1hdE5hbWUobmFtZSl9IHNob3VsZCBiZSBsZXNzIHRoYW4gJHtyaWdodH0uYCxcbiAgICBPUF9MRVNTX1RIQU5fT1JfRVFVQUw6IChuYW1lLCByaWdodCkgPT4gYCR7Zm9ybWF0TmFtZShuYW1lKX0gc2hvdWxkIGJlIGxlc3MgdGhhbiBvciBlcXVhbCB0byAke3JpZ2h0fS5gLFxuICAgIE9QX0lOOiAobmFtZSwgcmlnaHQpID0+IGAke2Zvcm1hdE5hbWUobmFtZSl9IHNob3VsZCBiZSBvbmUgb2YgJHtKU09OLnN0cmluZ2lmeShyaWdodCl9LmAsXG4gICAgT1BfTk9UX0lOOiAobmFtZSwgcmlnaHQpID0+IGAke2Zvcm1hdE5hbWUobmFtZSl9IHNob3VsZCBub3QgYmUgYW55IG9uZSBvZiAke0pTT04uc3RyaW5naWZ5KHJpZ2h0KX0uYCxcbiAgICBPUF9FWElTVFM6IChuYW1lLCByaWdodCkgPT4gYCR7Zm9ybWF0TmFtZShuYW1lKX0gc2hvdWxkJHtyaWdodCA/ICcgbm90ICc6ICcgJ31iZSBOVUxMLmAsICAgIFxuICAgIE9QX1RZUEU6IChuYW1lLCByaWdodCkgPT4gYFRoZSB0eXBlIG9mICR7Zm9ybWF0TmFtZShuYW1lKX0gc2hvdWxkIGJlIFwiJHtyaWdodH1cIi5gLFxufTtcblxuZnVuY3Rpb24gdGVzdCAodmFsdWUsIG9wLCBvcFZhbHVlLCBqZXMgPSBkZWZhdWx0Q3VzdG9taXplcikgeyAgIFxuICAgIGNvbnN0IGhhbmRsZXIgPSBqZXMub3BlcmF0b3JIYW5kbGVyc1tvcF07XG5cbiAgICBpZiAoIWhhbmRsZXIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBKRVMgb3BlcmF0b3IgXCIke29wfVwiIGhhbmRsZXIgbm90IGZvdW5kLmApO1xuICAgIH1cblxuICAgIHJldHVybiBoYW5kbGVyKHZhbHVlLCBvcFZhbHVlKTtcbn1cblxuY29uc3QgZGVmYXVsdEN1c3RvbWl6ZXIgPSB7XG4gICAgb3BlcmF0b3JIYW5kbGVyczogZGVmYXVsdEplc0hhbmRsZXJzLFxuICAgIG9wZXJhdG9yRXBsYW5hdGlvbnM6IGRlZmF1bHRKZXNFeHBsYW5hdGlvbnMsXG4gICAgaGFzOiBoYXNcbn07XG5cbi8qKlxuICogXG4gKiBAcGFyYW0geyp9IGFjdHVhbCBcbiAqIEBwYXJhbSB7Kn0gZXhwZWN0ZWQgXG4gKiBAcGFyYW0geyp9IHByZWZpeCBcbiAqIEBwYXJhbSB7Kn0gamVzIFxuICogXG4gKiB7IGtleTogeyAkaGFzIH0gfVxuICovXG5mdW5jdGlvbiBoYXMoYWN0dWFsLCBleHBlY3RlZCwgcHJlZml4LCBqZXMgPSBkZWZhdWx0Q3VzdG9taXplcikge1xuICAgIGxldCBwYXNzT2JqZWN0Q2hlY2sgPSBmYWxzZTtcblxuICAgIGZvciAobGV0IGZpZWxkTmFtZSBpbiBleHBlY3RlZCkge1xuICAgICAgICBsZXQgZXhwZWN0ZWRGaWVsZFZhbHVlID0gZXhwZWN0ZWRbZmllbGROYW1lXTsgICAgICAgIFxuXG4gICAgICAgIGlmIChmaWVsZE5hbWUubGVuZ3RoID4gMSAmJiBmaWVsZE5hbWVbMF0gPT09ICckJykgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgY29uc3Qgb3AgPSBNYXBPZk9wcy5nZXQoZmllbGROYW1lKTtcbiAgICAgICAgICAgIGlmICghb3ApIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgSkVTIG9wZXJhdG9yIHRva2VuIFwiJHtmaWVsZE5hbWV9XCIuYCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghdGVzdChhY3R1YWwsIG9wLCBleHBlY3RlZEZpZWxkVmFsdWUsIGplcykpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gW1xuICAgICAgICAgICAgICAgICAgICBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgamVzLm9wZXJhdG9yRXBsYW5hdGlvbnNbb3BdKHByZWZpeCwgZXhwZWN0ZWRGaWVsZFZhbHVlKVxuICAgICAgICAgICAgICAgIF07XG4gICAgICAgICAgICB9IFxuXG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfSBcblxuICAgICAgICBpZiAoIXBhc3NPYmplY3RDaGVjaykge1xuICAgICAgICAgICAgaWYgKGFjdHVhbCA9PSBudWxsKSByZXR1cm4gW1xuICAgICAgICAgICAgICAgIGZhbHNlLFxuICAgICAgICAgICAgICAgIGplcy5vcGVyYXRvckVwbGFuYXRpb25zLk9QX0VYSVNUUyhwcmVmaXgsIHRydWUpXG4gICAgICAgICAgICBdOyBcbiAgICBcbiAgICAgICAgICAgIGlmICh0eXBlb2YgYWN0dWFsICE9PSAnb2JqZWN0JykgcmV0dXJuIFtcbiAgICAgICAgICAgICAgICBmYWxzZSxcbiAgICAgICAgICAgICAgICBqZXMub3BlcmF0b3JFcGxhbmF0aW9ucy5PUF9UWVBFKHByZWZpeCwgJ29iamVjdCcpXG4gICAgICAgICAgICBdOyAgICBcbiAgICAgICAgfSAgICAgICAgXG5cbiAgICAgICAgcGFzc09iamVjdENoZWNrID0gdHJ1ZTtcblxuICAgICAgICBsZXQgYWN0dWFsRmllbGRWYWx1ZSA9IGFjdHVhbFtmaWVsZE5hbWVdOyAgICAgXG4gICAgICAgIFxuICAgICAgICBpZiAoZXhwZWN0ZWRGaWVsZFZhbHVlICE9IG51bGwgJiYgdHlwZW9mIGV4cGVjdGVkRmllbGRWYWx1ZSA9PT0gJ29iamVjdCcpIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnN0IFsgb2ssIHJlYXNvbiBdID0gaGFzKGFjdHVhbEZpZWxkVmFsdWUsIGV4cGVjdGVkRmllbGRWYWx1ZSwgcHJlZml4ID8gKHByZWZpeCArICcuJyArIGZpZWxkTmFtZSkgOiBmaWVsZE5hbWUsIGplcyk7XG4gICAgICAgICAgICBpZiAoIW9rKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFsgZmFsc2UsIHJlYXNvbiBdO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKCF0ZXN0KGFjdHVhbEZpZWxkVmFsdWUsICdPUF9FUVVBTCcsIGV4cGVjdGVkRmllbGRWYWx1ZSwgamVzKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICAgICAgICAgIGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICBqZXMub3BlcmF0b3JFcGxhbmF0aW9ucy5PUF9FUVVBTChwcmVmaXggPyAocHJlZml4ICsgJy4nICsgZmllbGROYW1lKSA6IGZpZWxkTmFtZSwgZXhwZWN0ZWRGaWVsZFZhbHVlKVxuICAgICAgICAgICAgICAgIF07XG4gICAgICAgICAgICB9IFxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIFt0cnVlXTtcbn1cblxuZXhwb3J0cy50ZXN0ID0gdGVzdDtcbmV4cG9ydHMuaGFzID0gaGFzOyJdfQ==