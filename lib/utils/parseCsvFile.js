"use strict";

require("source-map-support/register");

const {
  fs,
  Promise
} = require('rk-utils');

const {
  tryRequire
} = require('./lib');

module.exports = async (csvFile, options, transformer) => {
  const parse = tryRequire('csv-parse');
  const output = [];
  const readStream = fs.createReadStream(csvFile);
  const parser = parse({
    columns: true,
    ...options
  });
  const read = transformer ? () => {
    let record;

    while (record = parser.read()) {
      let transformed = transformer(record);
      if (transformed) output.push(transformed);
    }
  } : () => {
    let record;

    while (record = parser.read()) {
      output.push(record);
    }
  };
  return new Promise((resolve, reject) => {
    parser.on('readable', read);
    parser.on('error', err => {
      reject(err);
    });
    parser.on('end', () => resolve(output));
    readStream.pipe(parser);
  });
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9wYXJzZUNzdkZpbGUuanMiXSwibmFtZXMiOlsiZnMiLCJQcm9taXNlIiwicmVxdWlyZSIsInRyeVJlcXVpcmUiLCJtb2R1bGUiLCJleHBvcnRzIiwiY3N2RmlsZSIsIm9wdGlvbnMiLCJ0cmFuc2Zvcm1lciIsInBhcnNlIiwib3V0cHV0IiwicmVhZFN0cmVhbSIsImNyZWF0ZVJlYWRTdHJlYW0iLCJwYXJzZXIiLCJjb2x1bW5zIiwicmVhZCIsInJlY29yZCIsInRyYW5zZm9ybWVkIiwicHVzaCIsInJlc29sdmUiLCJyZWplY3QiLCJvbiIsImVyciIsInBpcGUiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxNQUFNO0FBQUVBLEVBQUFBLEVBQUY7QUFBTUMsRUFBQUE7QUFBTixJQUFrQkMsT0FBTyxDQUFDLFVBQUQsQ0FBL0I7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQTtBQUFGLElBQWlCRCxPQUFPLENBQUMsT0FBRCxDQUE5Qjs7QUFFQUUsTUFBTSxDQUFDQyxPQUFQLEdBQWlCLE9BQU9DLE9BQVAsRUFBZ0JDLE9BQWhCLEVBQXlCQyxXQUF6QixLQUF5QztBQUN0RCxRQUFNQyxLQUFLLEdBQUdOLFVBQVUsQ0FBQyxXQUFELENBQXhCO0FBRUEsUUFBTU8sTUFBTSxHQUFHLEVBQWY7QUFFQSxRQUFNQyxVQUFVLEdBQUdYLEVBQUUsQ0FBQ1ksZ0JBQUgsQ0FBb0JOLE9BQXBCLENBQW5CO0FBQ0EsUUFBTU8sTUFBTSxHQUFHSixLQUFLLENBQUM7QUFDakJLLElBQUFBLE9BQU8sRUFBRSxJQURRO0FBRWpCLE9BQUdQO0FBRmMsR0FBRCxDQUFwQjtBQUtBLFFBQU1RLElBQUksR0FBR1AsV0FBVyxHQUFHLE1BQU07QUFDN0IsUUFBSVEsTUFBSjs7QUFDQSxXQUFPQSxNQUFNLEdBQUdILE1BQU0sQ0FBQ0UsSUFBUCxFQUFoQixFQUErQjtBQUMzQixVQUFJRSxXQUFXLEdBQUdULFdBQVcsQ0FBQ1EsTUFBRCxDQUE3QjtBQUNBLFVBQUlDLFdBQUosRUFBaUJQLE1BQU0sQ0FBQ1EsSUFBUCxDQUFZRCxXQUFaO0FBQ3BCO0FBQ0osR0FOdUIsR0FNcEIsTUFBTTtBQUNOLFFBQUlELE1BQUo7O0FBQ0EsV0FBT0EsTUFBTSxHQUFHSCxNQUFNLENBQUNFLElBQVAsRUFBaEIsRUFBK0I7QUFDM0JMLE1BQUFBLE1BQU0sQ0FBQ1EsSUFBUCxDQUFZRixNQUFaO0FBQ0g7QUFDSixHQVhEO0FBYUEsU0FBTyxJQUFJZixPQUFKLENBQVksQ0FBQ2tCLE9BQUQsRUFBVUMsTUFBVixLQUFxQjtBQUNwQ1AsSUFBQUEsTUFBTSxDQUFDUSxFQUFQLENBQVUsVUFBVixFQUFzQk4sSUFBdEI7QUFHQUYsSUFBQUEsTUFBTSxDQUFDUSxFQUFQLENBQVUsT0FBVixFQUFtQkMsR0FBRyxJQUFJO0FBQ3RCRixNQUFBQSxNQUFNLENBQUNFLEdBQUQsQ0FBTjtBQUNILEtBRkQ7QUFLQVQsSUFBQUEsTUFBTSxDQUFDUSxFQUFQLENBQVUsS0FBVixFQUFpQixNQUFNRixPQUFPLENBQUNULE1BQUQsQ0FBOUI7QUFFQUMsSUFBQUEsVUFBVSxDQUFDWSxJQUFYLENBQWdCVixNQUFoQjtBQUNILEdBWk0sQ0FBUDtBQWFILENBckNEIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgeyBmcywgUHJvbWlzZSB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgdHJ5UmVxdWlyZSB9ID0gcmVxdWlyZSgnLi9saWInKTtcblxubW9kdWxlLmV4cG9ydHMgPSBhc3luYyAoY3N2RmlsZSwgb3B0aW9ucywgdHJhbnNmb3JtZXIpID0+IHtcbiAgICBjb25zdCBwYXJzZSA9IHRyeVJlcXVpcmUoJ2Nzdi1wYXJzZScpO1xuXG4gICAgY29uc3Qgb3V0cHV0ID0gW11cblxuICAgIGNvbnN0IHJlYWRTdHJlYW0gPSBmcy5jcmVhdGVSZWFkU3RyZWFtKGNzdkZpbGUpO1xuICAgIGNvbnN0IHBhcnNlciA9IHBhcnNlKHtcbiAgICAgICAgY29sdW1uczogdHJ1ZSxcbiAgICAgICAgLi4ub3B0aW9uc1xuICAgIH0pO1xuXG4gICAgY29uc3QgcmVhZCA9IHRyYW5zZm9ybWVyID8gKCkgPT4ge1xuICAgICAgICBsZXQgcmVjb3JkO1xuICAgICAgICB3aGlsZSAocmVjb3JkID0gcGFyc2VyLnJlYWQoKSkge1xuICAgICAgICAgICAgbGV0IHRyYW5zZm9ybWVkID0gdHJhbnNmb3JtZXIocmVjb3JkKTtcbiAgICAgICAgICAgIGlmICh0cmFuc2Zvcm1lZCkgb3V0cHV0LnB1c2godHJhbnNmb3JtZWQpO1xuICAgICAgICB9XG4gICAgfSA6ICgpID0+IHtcbiAgICAgICAgbGV0IHJlY29yZDtcbiAgICAgICAgd2hpbGUgKHJlY29yZCA9IHBhcnNlci5yZWFkKCkpIHtcbiAgICAgICAgICAgIG91dHB1dC5wdXNoKHJlY29yZCk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgcGFyc2VyLm9uKCdyZWFkYWJsZScsIHJlYWQpO1xuXG4gICAgICAgIC8vIENhdGNoIGFueSBlcnJvclxuICAgICAgICBwYXJzZXIub24oJ2Vycm9yJywgZXJyID0+IHtcbiAgICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICB9KTtcblxuICAgICAgICAvLyBXaGVuIHdlIGFyZSBkb25lLCB0ZXN0IHRoYXQgdGhlIHBhcnNlZCBvdXRwdXQgbWF0Y2hlZCB3aGF0IGV4cGVjdGVkXG4gICAgICAgIHBhcnNlci5vbignZW5kJywgKCkgPT4gcmVzb2x2ZShvdXRwdXQpKTtcblxuICAgICAgICByZWFkU3RyZWFtLnBpcGUocGFyc2VyKTtcbiAgICB9KTsgICAgXG59O1xuICAgICJdfQ==